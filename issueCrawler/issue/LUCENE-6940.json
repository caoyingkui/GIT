{
    "id": "LUCENE-6940",
    "title": "Bulk scoring could speed up MUST_NOT clauses",
    "details": {
        "resolution": "Fixed",
        "affect_versions": "None",
        "components": [],
        "labels": "",
        "fix_versions": [
            "5.5",
            "6.0"
        ],
        "priority": "Minor",
        "status": "Closed",
        "type": "Improvement"
    },
    "description": "Today when you have MUST_NOT clauses, the ReqExclScorer is used and needs to check the excluded clauses on every iteration. I suspect we could speed things up by having a BulkScorer that would advance the excluded clause first and then tell the required clause to bulk score up to the next excluded document.",
    "attachments": {
        "LUCENE-6940.patch": "https://issues.apache.org/jira/secure/attachment/12778476/LUCENE-6940.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "id": "comment-15063825",
            "author": "Adrien Grand",
            "date": "2015-12-18T11:04:28+0000",
            "content": "Here is a quick patch (disclaimer: not commented and not tested) to demonstrate the idea. It makes the new bulk scorer used either:\n\n\twhen there is a single FILTER/MUST clause, no SHOULD clauses, and some MUST_NOT clauses\n\tor when there are some SHOULD clauses, no FILTER_MUST clauses and some MUST_NOT clauses\n\n\n\nI added some tasks to wikimedium.10M.nostopwords.tasks and ran it through luceneutil. As expected this seems to especially yield a speedup when the negative clauses match many less documents than the positive clauses.\n\n\ndiff --git a/tasks/wikimedium.10M.nostopwords.tasks b/tasks/wikimedium.10M.nostopwords.tasks\nindex 342070c..8991121 100644\n--- a/tasks/wikimedium.10M.nostopwords.tasks\n+++ b/tasks/wikimedium.10M.nostopwords.tasks\n@@ -13361,3 +13361,19 @@ OrNotHighLow: -do necessities # freq=511178 freq=1195\n OrHighNotLow: do -necessities # freq=511178 freq=1195\n OrNotHighLow: -had halfback # freq=1246743 freq=1205\n OrHighNotLow: had -halfback # freq=1246743 freq=1205\n+AllNotHigh: *:* -been # freq=1041183\n+AllNotHigh: *:* -states # freq=1034872\n+AllNotHigh: *:* -time # freq=1032071\n+AllNotHigh: *:* -when # freq=1027487\n+AllNotLow: *:* -factor # freq=37866\n+AllNotLow: *:* -migration # freq=37862\n+AllNotLow: *:* -maintained # freq=37840\n+AllNotLow: *:* -norwegian # freq=37836\n+OrHighHighNotLow: several following -factor # freq=436129 freq=416515 freq=37866\n+OrHighHighNotLow: publisher end -migration # freq=1289029 freq=526636 freq=37862\n+OrHighHighNotLow: 2009 film -maintaine # freq=887702 freq=432758 freq=37840\n+OrHighHighNotLow: http known -norwegian # freq=3493581 freq=607158 freq=37836\n+OrHighLowNotHigh: 2005 jorgensen -been # freq=835460 freq=837 freq=1041183\n+OrHighLowNotHigh: like undivided -states # freq=479390 freq=1512 freq=1034872\n+OrHighLowNotHigh: use coy -time # freq=597053 freq=1198 freq=1032071\n+OrHighLowNotHigh: been highperformanceengines -when # freq=1041183 freq=1155 freq=1027487\n\n\n\n\n                    TaskQPS baseline      StdDev   QPS patch      StdDev                Pct diff\n        OrHighLowNotHigh       19.54      (2.6%)       18.59      (4.2%)   -4.9% ( -11% -    1%)\n               OrHighMed       34.32      (3.5%)       33.03      (4.8%)   -3.7% ( -11% -    4%)\n              OrHighHigh       26.95      (3.7%)       25.97      (4.9%)   -3.6% ( -11% -    5%)\n                  Fuzzy2       82.74     (16.0%)       80.29     (16.4%)   -3.0% ( -30% -   35%)\n              AndHighLow      502.91      (5.7%)      496.63      (3.0%)   -1.2% (  -9% -    7%)\n              AndHighMed      236.44      (2.9%)      234.34      (2.6%)   -0.9% (  -6% -    4%)\n            OrNotHighMed      222.75      (2.9%)      220.87      (2.4%)   -0.8% (  -5% -    4%)\n                 Respell       60.25      (3.0%)       60.38      (2.7%)    0.2% (  -5% -    6%)\n         MedSloppyPhrase       21.73      (2.3%)       21.92      (2.5%)    0.8% (  -3% -    5%)\n                  Fuzzy1       57.18      (8.0%)       57.78      (5.8%)    1.1% ( -11% -   16%)\n         LowSloppyPhrase       25.96      (1.9%)       26.24      (2.1%)    1.1% (  -2% -    5%)\n        HighSloppyPhrase       29.99      (2.5%)       30.37      (2.7%)    1.3% (  -3% -    6%)\n               MedPhrase       60.11      (2.8%)       61.15      (3.1%)    1.7% (  -4% -    7%)\n             AndHighHigh       32.86      (3.0%)       33.56      (3.0%)    2.1% (  -3% -    8%)\n               LowPhrase       59.36      (2.7%)       60.69      (3.2%)    2.2% (  -3% -    8%)\n               OrHighLow       78.50      (3.6%)       80.33      (4.3%)    2.3% (  -5% -   10%)\n              HighPhrase       17.32      (2.1%)       17.73      (1.9%)    2.4% (  -1% -    6%)\n             LowSpanNear       34.90      (2.8%)       35.75      (2.4%)    2.4% (  -2% -    7%)\n             MedSpanNear       30.83      (2.9%)       31.59      (2.0%)    2.4% (  -2% -    7%)\n            OrNotHighLow      982.57      (4.2%)     1009.18      (2.8%)    2.7% (  -4% -   10%)\n            HighSpanNear       10.39      (3.8%)       10.76      (3.7%)    3.5% (  -3% -   11%)\n                Wildcard       64.30      (4.2%)       67.27      (5.2%)    4.6% (  -4% -   14%)\n                HighTerm      110.90      (5.2%)      117.51      (6.7%)    6.0% (  -5% -   18%)\n                 MedTerm      155.42      (5.3%)      165.05      (6.9%)    6.2% (  -5% -   19%)\n           OrNotHighHigh       40.19      (1.9%)       42.69      (3.2%)    6.2% (   1% -   11%)\n                 Prefix3       87.35      (6.2%)       93.98      (6.9%)    7.6% (  -5% -   22%)\n                 LowTerm      574.81      (9.0%)      625.04      (9.6%)    8.7% (  -9% -   30%)\n                  IntNRQ       11.95      (9.1%)       13.31     (11.8%)   11.4% (  -8% -   35%)\n           OrHighNotHigh       50.66      (2.0%)       56.55      (4.3%)   11.6% (   5% -   18%)\n        OrHighHighNotLow       27.15      (3.3%)       33.91      (4.9%)   24.9% (  16% -   34%)\n            OrHighNotMed       96.64      (2.7%)      130.20      (8.0%)   34.7% (  23% -   46%)\n            OrHighNotLow       42.44      (4.0%)       62.60     (10.7%)   47.5% (  31% -   64%)\n              AllNotHigh        6.51      (2.9%)       16.76     (26.8%)  157.4% ( 124% -  192%)\n               AllNotLow        7.18      (3.0%)       21.93     (49.2%)  205.3% ( 148% -  265%)\n\n "
        },
        {
            "id": "comment-15070228",
            "author": "Adrien Grand",
            "date": "2015-12-23T21:58:01+0000",
            "content": "Here is a new patch. This time it has tests and tries to organize the code a bit better. Tests pass and luceneutil still reports similar times (this time I only ran the default tasks for wikimedium10m):\n\n\n                    TaskQPS baseline      StdDev   QPS patch      StdDev                Pct diff\n           OrNotHighHigh       35.34      (2.2%)       32.99      (3.3%)   -6.7% ( -11% -   -1%)\n            OrNotHighMed      174.57      (2.3%)      170.17      (1.8%)   -2.5% (  -6% -    1%)\n               OrHighMed       73.34      (4.6%)       72.13      (5.0%)   -1.7% ( -10% -    8%)\n              OrHighHigh        9.17      (5.7%)        9.03      (5.2%)   -1.5% ( -11% -    9%)\n           OrHighNotHigh       78.91      (2.8%)       78.16      (3.6%)   -0.9% (  -7% -    5%)\n               OrHighLow       19.79      (2.7%)       19.73      (3.6%)   -0.3% (  -6% -    6%)\n         LowSloppyPhrase       70.26      (2.1%)       70.14      (2.3%)   -0.2% (  -4% -    4%)\n              AndHighMed      191.70      (1.7%)      191.59      (1.7%)   -0.1% (  -3% -    3%)\n             AndHighHigh       79.74      (1.0%)       79.79      (0.9%)    0.1% (  -1% -    1%)\n         MedSloppyPhrase       73.28      (2.5%)       73.37      (2.7%)    0.1% (  -5% -    5%)\n                 Respell       84.33      (2.4%)       84.60      (2.8%)    0.3% (  -4% -    5%)\n             LowSpanNear       12.79      (3.9%)       12.83      (3.0%)    0.4% (  -6% -    7%)\n               LowPhrase       48.59      (1.2%)       48.79      (1.2%)    0.4% (  -2% -    2%)\n               MedPhrase       33.55      (1.4%)       33.71      (1.3%)    0.5% (  -2% -    3%)\n            HighSpanNear       14.50      (3.2%)       14.60      (2.6%)    0.7% (  -4% -    6%)\n             MedSpanNear      151.02      (3.3%)      152.17      (1.7%)    0.8% (  -4% -    5%)\n        HighSloppyPhrase       15.76      (5.3%)       15.90      (5.2%)    0.9% (  -9% -   12%)\n              HighPhrase       32.51      (2.3%)       33.09      (1.4%)    1.8% (  -1% -    5%)\n                 Prefix3       90.59      (8.9%)       92.74      (7.5%)    2.4% ( -12% -   20%)\n                Wildcard      125.13      (8.2%)      128.21      (7.8%)    2.5% ( -12% -   20%)\n                 MedTerm      291.05      (6.8%)      300.34      (6.5%)    3.2% (  -9% -   17%)\n                  Fuzzy1       61.93      (8.8%)       64.08      (9.6%)    3.5% ( -13% -   23%)\n                HighTerm       79.63      (7.3%)       83.28      (6.9%)    4.6% (  -8% -   20%)\n                  IntNRQ       10.39     (13.8%)       10.94     (11.5%)    5.3% ( -17% -   35%)\n                 LowTerm      575.82     (12.7%)      607.32     (10.6%)    5.5% ( -15% -   33%)\n            OrNotHighLow      985.95      (4.4%)     1054.73      (3.0%)    7.0% (   0% -   15%)\n              AndHighLow      688.12      (8.2%)      736.65      (4.5%)    7.1% (  -5% -   21%)\n                  Fuzzy2       58.94     (14.4%)       63.15      (8.9%)    7.2% ( -14% -   35%)\n            OrHighNotMed       84.50      (3.4%)       95.46      (3.8%)   13.0% (   5% -   20%)\n            OrHighNotLow       64.23      (3.3%)       76.36      (4.7%)   18.9% (  10% -   27%)\n\n "
        },
        {
            "id": "comment-15075943",
            "author": "ASF subversion and git services",
            "date": "2015-12-31T13:41:20+0000",
            "content": "Commit 1722443 from Adrien Grand in branch 'dev/trunk'\n[ https://svn.apache.org/r1722443 ]\n\nLUCENE-6940: Speed up MUST_NOT clauses. "
        },
        {
            "id": "comment-15075964",
            "author": "ASF subversion and git services",
            "date": "2015-12-31T14:24:30+0000",
            "content": "Commit 1722445 from Adrien Grand in branch 'dev/branches/branch_5x'\n[ https://svn.apache.org/r1722445 ]\n\nLUCENE-6940: Speed up MUST_NOT clauses. "
        }
    ]
}