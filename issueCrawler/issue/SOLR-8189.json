{
    "id": "SOLR-8189",
    "title": "eTag calculation during http Cache Validation uses unsynchronized WeakHashMap",
    "details": {
        "components": [
            "search"
        ],
        "type": "Bug",
        "labels": "",
        "fix_versions": [
            "5.4",
            "6.0"
        ],
        "affect_versions": "4.10.4,                                            5.3",
        "status": "Closed",
        "resolution": "Fixed",
        "priority": "Major"
    },
    "description": "I found this while looking into a recent jenkins failure where TestDynamicLoading leaked 5 threads: http://jenkins.thetaphi.de/job/Lucene-Solr-trunk-Linux/14630/\n\n\nStack Trace:\ncom.carrotsearch.randomizedtesting.ThreadLeakError: 5 threads leaked from SUITE scope at org.apache.solr.core.TestDynamicLoading:\n   1) Thread[id=11582, name=qtp85907293-11582, state=RUNNABLE, group=TGRP-TestDynamicLoading]\n        at java.util.WeakHashMap.get(WeakHashMap.java:403)\n        at org.apache.solr.servlet.cache.HttpCacheHeaderUtil.calcEtag(HttpCacheHeaderUtil.java:102)\n        at org.apache.solr.servlet.cache.HttpCacheHeaderUtil.doCacheHeaderValidation(HttpCacheHeaderUtil.java:224)\n        at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:452)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:220)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:179)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\n        at org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:109)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\n        at org.eclipse.jetty.servlets.UserAgentFilter.doFilter(UserAgentFilter.java:83)\n        at org.eclipse.jetty.servlets.GzipFilter.doFilter(GzipFilter.java:364)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\n        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:585)\n        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:221)\n        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1127)\n        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:515)\n        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\n        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1061)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97)\n        at org.eclipse.jetty.server.Server.handle(Server.java:499)\n        at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:310)\n        at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:257)\n        at org.eclipse.jetty.io.AbstractConnection$2.run(AbstractConnection.java:540)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:635)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:555)\n        at java.lang.Thread.run(Thread.java:745)\n   2) Thread[id=11445, name=qtp85907293-11445, state=RUNNABLE, group=TGRP-TestDynamicLoading]\n        at java.util.WeakHashMap.get(WeakHashMap.java:403)\n        at org.apache.solr.servlet.cache.HttpCacheHeaderUtil.calcEtag(HttpCacheHeaderUtil.java:102)\n        at org.apache.solr.servlet.cache.HttpCacheHeaderUtil.doCacheHeaderValidation(HttpCacheHeaderUtil.java:224)\n        at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:452)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:220)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:179)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\n        at org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:109)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\n        at org.eclipse.jetty.servlets.UserAgentFilter.doFilter(UserAgentFilter.java:83)\n        at org.eclipse.jetty.servlets.GzipFilter.doFilter(GzipFilter.java:364)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\n        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:585)\n        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:221)\n        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1127)\n        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:515)\n        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\n        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1061)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97)\n        at org.eclipse.jetty.server.Server.handle(Server.java:499)\n        at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:310)\n        at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:257)\n        at org.eclipse.jetty.io.AbstractConnection$2.run(AbstractConnection.java:540)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:635)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:555)\n        at java.lang.Thread.run(Thread.java:745)\n   3) Thread[id=11610, name=qtp85907293-11610, state=RUNNABLE, group=TGRP-TestDynamicLoading]\n        at java.util.WeakHashMap.get(WeakHashMap.java:403)\n        at org.apache.solr.servlet.cache.HttpCacheHeaderUtil.calcEtag(HttpCacheHeaderUtil.java:102)\n        at org.apache.solr.servlet.cache.HttpCacheHeaderUtil.doCacheHeaderValidation(HttpCacheHeaderUtil.java:224)\n        at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:452)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:220)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:179)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\n        at org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:109)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\n        at org.eclipse.jetty.servlets.UserAgentFilter.doFilter(UserAgentFilter.java:83)\n        at org.eclipse.jetty.servlets.GzipFilter.doFilter(GzipFilter.java:364)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\n        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:585)\n        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:221)\n        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1127)\n        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:515)\n        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\n        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1061)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97)\n        at org.eclipse.jetty.server.Server.handle(Server.java:499)\n        at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:310)\n        at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:257)\n        at org.eclipse.jetty.io.AbstractConnection$2.run(AbstractConnection.java:540)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:635)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:555)\n        at java.lang.Thread.run(Thread.java:745)\n   4) Thread[id=11446, name=qtp85907293-11446, state=RUNNABLE, group=TGRP-TestDynamicLoading]\n        at java.util.WeakHashMap.get(WeakHashMap.java:403)\n        at org.apache.solr.servlet.cache.HttpCacheHeaderUtil.calcEtag(HttpCacheHeaderUtil.java:102)\n        at org.apache.solr.servlet.cache.HttpCacheHeaderUtil.doCacheHeaderValidation(HttpCacheHeaderUtil.java:224)\n        at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:452)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:220)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:179)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\n        at org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:109)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\n        at org.eclipse.jetty.servlets.UserAgentFilter.doFilter(UserAgentFilter.java:83)\n        at org.eclipse.jetty.servlets.GzipFilter.doFilter(GzipFilter.java:364)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\n        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:585)\n        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:221)\n        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1127)\n        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:515)\n        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\n        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1061)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97)\n        at org.eclipse.jetty.server.Server.handle(Server.java:499)\n        at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:310)\n        at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:257)\n        at org.eclipse.jetty.io.AbstractConnection$2.run(AbstractConnection.java:540)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:635)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:555)\n        at java.lang.Thread.run(Thread.java:745)\n   5) Thread[id=11566, name=searcherExecutor-5704-thread-1, state=WAITING, group=TGRP-TestDynamicLoading]\n        at sun.misc.Unsafe.park(Native Method)\n        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)\n        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)\n        at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)\n        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1067)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n        at __randomizedtesting.SeedInfo.seed([AEC7DA9BEB408E47]:0)\n\n\n\n4 of these are stuck (in runnable state) at WeakHashMap.get. This is a common problem when WeakHashMap is used without any synchronization and sure enough HttpCacheHeaderUtil uses a WeakHashMap for etagCoreCache without any synchronization.",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2015-10-23T14:03:50+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 1710218 from shalin@apache.org in branch 'dev/trunk'\n[ https://svn.apache.org/r1710218 ]\n\nSOLR-8189: eTag calculation during HTTP Cache Validation uses unsynchronized WeakHashMap causing threads to be stuck in runnable state ",
            "id": "comment-14971029"
        },
        {
            "date": "2015-10-23T14:04:53+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 1710219 from shalin@apache.org in branch 'dev/branches/branch_5x'\n[ https://svn.apache.org/r1710219 ]\n\nSOLR-8189: eTag calculation during HTTP Cache Validation uses unsynchronized WeakHashMap causing threads to be stuck in runnable state ",
            "id": "comment-14971032"
        },
        {
            "date": "2015-10-23T15:31:27+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 1710240 from shalin@apache.org in branch 'dev/branches/branch_5x'\n[ https://svn.apache.org/r1710240 ]\n\nSOLR-8189: Fixed java7 compile issue ",
            "id": "comment-14971165"
        },
        {
            "date": "2015-10-24T12:54:50+0000",
            "author": "Mark Miller",
            "content": "If this dupes SOLR-7423, we should also close that. ",
            "id": "comment-14972586"
        },
        {
            "date": "2015-10-24T16:31:33+0000",
            "author": "Shalin Shekhar Mangar",
            "content": "Thanks Mark, I had not seen SOLR-7423. I think Uwe's suggestion is better than my fix. I'll change it to a WeakIdentityMap backed by a ConcurrentHashMap. ",
            "id": "comment-14972681"
        },
        {
            "date": "2015-10-24T16:58:57+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 1710366 from shalin@apache.org in branch 'dev/trunk'\n[ https://svn.apache.org/r1710366 ]\n\nSOLR-8189: Use WeakIdentityMap.newConcurrentHashMap instead of a synchronized WeakHashMap for better concurrency ",
            "id": "comment-14972714"
        },
        {
            "date": "2015-10-24T17:03:45+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 1710367 from shalin@apache.org in branch 'dev/branches/branch_5x'\n[ https://svn.apache.org/r1710367 ]\n\nSOLR-8189: Use WeakIdentityMap.newConcurrentHashMap instead of a synchronized WeakHashMap for better concurrency ",
            "id": "comment-14972719"
        }
    ]
}