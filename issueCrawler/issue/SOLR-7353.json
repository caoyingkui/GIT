{
    "id": "SOLR-7353",
    "title": "Duplicated child/grand-child docs in a block-join structure should be removed by the shard hosting the docs not by the query controller",
    "details": {
        "components": [],
        "type": "Improvement",
        "labels": "",
        "fix_versions": [],
        "affect_versions": "None",
        "status": "Open",
        "resolution": "Unresolved",
        "priority": "Minor"
    },
    "description": "I've indexed the following 8 docs into a 2-shard collection (Solr 4.8'ish - internal custom branch roughly based on 4.8) ... notice that the 3 grand-children of 2-1 have dup'd keys:\n\n\n[\n  {\n    \"id\":\"1\",\n    \"name\":\"parent\",\n    \"_childDocuments_\":[\n      {\n        \"id\":\"1-1\",\n        \"name\":\"child\"\n      },\n      {\n        \"id\":\"1-2\",\n        \"name\":\"child\"\n      }\n    ]\n  },\n  {\n    \"id\":\"2\",\n    \"name\":\"parent\",\n    \"_childDocuments_\":[\n      {\n        \"id\":\"2-1\",\n        \"name\":\"child\",\n        \"_childDocuments_\":[\n          {\n            \"id\":\"2-1-1\",\n            \"name\":\"grandchild\"\n          },\n          {\n            \"id\":\"2-1-1\",\n            \"name\":\"grandchild2\"\n          },\n          {\n            \"id\":\"2-1-1\",\n            \"name\":\"grandchild3\"\n          }\n        ]\n      }\n    ]\n  }\n]\n\n\nWhen I query this collection, using:\n\nhttp://localhost:8984/solr/blockjoin2_shard2_replica1/select?q=*%3A*&wt=json&indent=true&shards.info=true&rows=10\n\nI get:\n\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":9,\n    \"params\":{\n      \"indent\":\"true\",\n      \"q\":\"*:*\",\n      \"shards.info\":\"true\",\n      \"wt\":\"json\",\n      \"rows\":\"10\"}},\n  \"shards.info\":{\n    \"http://localhost:8984/solr/blockjoin2_shard1_replica1/|http://localhost:8985/solr/blockjoin2_shard1_replica2/\":{\n      \"numFound\":3,\n      \"maxScore\":1.0,\n      \"shardAddress\":\"http://localhost:8984/solr/blockjoin2_shard1_replica1\",\n      \"time\":4},\n    \"http://localhost:8984/solr/blockjoin2_shard2_replica1/|http://localhost:8985/solr/blockjoin2_shard2_replica2/\":{\n      \"numFound\":5,\n      \"maxScore\":1.0,\n      \"shardAddress\":\"http://localhost:8985/solr/blockjoin2_shard2_replica2\",\n      \"time\":4}},\n  \"response\":{\"numFound\":6,\"start\":0,\"maxScore\":1.0,\"docs\":[\n      {\n        \"id\":\"1-1\",\n        \"name\":\"child\"},\n      {\n        \"id\":\"1-2\",\n        \"name\":\"child\"},\n      {\n        \"id\":\"1\",\n        \"name\":\"parent\",\n        \"_version_\":1495272401329455104},\n      {\n        \"id\":\"2-1-1\",\n        \"name\":\"grandchild\"},\n      {\n        \"id\":\"2-1\",\n        \"name\":\"child\"},\n      {\n        \"id\":\"2\",\n        \"name\":\"parent\",\n        \"_version_\":1495272401361960960}]\n  }}\n\n\n\nSo Solr has de-duped the results.\n\nIf I execute this query against the shard that has the dupes (distrib=false):\n\nhttp://localhost:8984/solr/blockjoin2_shard2_replica1/select?q=*%3A*&wt=json&indent=true&shards.info=true&rows=10&distrib=false\n\nThen the dupes are returned:\n\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":0,\n    \"params\":{\n      \"indent\":\"true\",\n      \"q\":\"*:*\",\n      \"shards.info\":\"true\",\n      \"distrib\":\"false\",\n      \"wt\":\"json\",\n      \"rows\":\"10\"}},\n  \"response\":{\"numFound\":5,\"start\":0,\"docs\":[\n      {\n        \"id\":\"2-1-1\",\n        \"name\":\"grandchild\"},\n      {\n        \"id\":\"2-1-1\",\n        \"name\":\"grandchild2\"},\n      {\n        \"id\":\"2-1-1\",\n        \"name\":\"grandchild3\"},\n      {\n        \"id\":\"2-1\",\n        \"name\":\"child\"},\n      {\n        \"id\":\"2\",\n        \"name\":\"parent\",\n        \"_version_\":1495272401361960960}]\n  }}\n\n\nShouldn't the distrib and non-distrib (direct to shard) queries produce consistent results wrt this block?\n\nOf course we shouldn't index dupes, but I don't think it's the query controller's job to de-dupe and change numDocs, esp. based on the value of the rows parameter. Other users have reported this problem on the mailing list:\n\n>>>\nWe've seen this as well. Before we understood the cause, it seemed very\nbizarre that hitting different nodes would yield different numFound, as\nwell as using different rows=N (since the proxying node only de-dupe the\ndocuments that are returned in the response).\n\nI think \"consistency\" and \"correctness\" should be clearly delineated. Of\ncourse we'd rather have consistently correct result, but failing that, I'd\nrather have consistently incorrect result rather than inconsistent results\nbecause otherwise it's even hard to debug, as was the case here.\n\nI think either the node hosting the shard should also do the de-duping, or\nno one should. It's strange that the proxying node decides to do some\nsketchy limited result set de-dupe.\n<<<\n\nI'm opening this ticket to investigate how to address this issue.",
    "attachments": {},
    "issue_links": {},
    "comments": []
}