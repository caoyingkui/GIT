{
    "id": "LUCENE-8520",
    "title": "TestIndexWriterMaxDocs.testExactlyAtTrueLimit() failure",
    "details": {
        "components": [],
        "status": "Resolved",
        "resolution": "Fixed",
        "fix_versions": [
            "master (8.0)"
        ],
        "affect_versions": "None",
        "labels": "",
        "priority": "Trivial",
        "type": "Bug"
    },
    "description": "From my Jenkins http://jenkins.sarowe.net/job/Lucene-core-weekly-monster-master-HDD/365/, reproduces for me locally:\n\n\nChecking out Revision 964cc88cee7d62edf03a923e3217809d630af5d5 (refs/remotes/origin/master)\n[...]\n   [junit4] Suite: org.apache.lucene.index.TestIndexWriterMaxDocs\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestIndexWriterMaxDocs -Dtests.method=testExactlyAtTrueLimit -Dtests.seed=4544F11B4D9BB14C -Dtests.nightly=true -Dtests.slow=true -Dtests.monster=true -Dtests.locale=ko-KR -Dtests.timezone=Atlantic/Jan_Mayen -Dtests.asserts=true -Dtests.file.encoding=US-ASCII\n   [junit4] FAILURE 1597s J0 | TestIndexWriterMaxDocs.testExactlyAtTrueLimit <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError: expected:<2147483519> but was:<2165>\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([4544F11B4D9BB14C:AAE52DEAF347C094]:0)\n   [junit4]    > \tat org.apache.lucene.index.TestIndexWriterMaxDocs.testExactlyAtTrueLimit(TestIndexWriterMaxDocs.java:71)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:748)\n   [junit4]   2> NOTE: leaving temporary files on disk at: /slow/jenkins/HDD-workspaces/Lucene-core-weekly-monster-master-HDD/lucene/build/core/test/J0/temp/lucene.index.TestIndexWriterMaxDocs_4544F11B4D9BB14C-001\n   [junit4]   2> Sep 30, 2018 6:47:23 PM com.carrotsearch.randomizedtesting.ThreadLeakControl checkThreadLeaks\n   [junit4]   2> WARNING: Will linger awaiting termination of 1 leaked thread(s).\n   [junit4]   2> Sep 30, 2018 6:47:43 PM com.carrotsearch.randomizedtesting.ThreadLeakControl checkThreadLeaks\n   [junit4]   2> SEVERE: 1 thread leaked from SUITE scope at org.apache.lucene.index.TestIndexWriterMaxDocs: \n   [junit4]   2>    1) Thread[id=2505, name=Lucene Merge Thread #13, state=RUNNABLE, group=TGRP-TestIndexWriterMaxDocs]\n   [junit4]   2>         at org.apache.lucene.codecs.PushPostingsWriterBase.writeTerm(PushPostingsWriterBase.java:148)\n   [junit4]   2>         at org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter$TermsWriter.write(BlockTreeTermsWriter.java:865)\n   [junit4]   2>         at org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter.write(BlockTreeTermsWriter.java:344)\n   [junit4]   2>         at org.apache.lucene.codecs.FieldsConsumer.merge(FieldsConsumer.java:105)\n   [junit4]   2>         at org.apache.lucene.codecs.perfield.PerFieldPostingsFormat$FieldsWriter.merge(PerFieldPostingsFormat.java:165)\n   [junit4]   2>         at org.apache.lucene.index.SegmentMerger.mergeTerms(SegmentMerger.java:244)\n   [junit4]   2>         at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:139)\n   [junit4]   2>         at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4453)\n   [junit4]   2>         at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:4075)\n   [junit4]   2>         at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:625)\n   [junit4]   2>         at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:662)\n   [junit4]   2> Sep 30, 2018 6:47:43 PM com.carrotsearch.randomizedtesting.ThreadLeakControl tryToInterruptAll\n   [junit4]   2> INFO: Starting to interrupt leaked threads:\n   [junit4]   2>    1) Thread[id=2505, name=Lucene Merge Thread #13, state=RUNNABLE, group=TGRP-TestIndexWriterMaxDocs]\n   [junit4]   2> Sep 30, 2018 6:47:43 PM com.carrotsearch.randomizedtesting.ThreadLeakControl tryToInterruptAll\n   [junit4]   2> INFO: All leaked threads terminated.\n   [junit4]   2> NOTE: test params are: codec=Lucene80, sim=Asserting(org.apache.lucene.search.similarities.AssertingSimilarity@72a4d8a0), locale=ko-KR, timezone=Atlantic/Jan_Mayen\n   [junit4]   2> NOTE: Linux 4.1.0-custom2-amd64 amd64/Oracle Corporation 1.8.0_151 (64-bit)/cpus=16,threads=1,free=616857624,total=1299185664\n   [junit4]   2> NOTE: All tests run in this JVM: [TestBasicModelIn, TestSparseFixedBitDocIdSet, TestAutomaton, TestRegExp, TestReaderWrapperDVTypeCheck, TestMultiMMap, TestLucene50StoredFieldsFormatHighCompression, TestNoMergeScheduler, TestLazyProxSkipping, TestPayloads, Test4GBStoredFields, TestShardSearching, TestTwoPhaseCommitTool, TestTermVectorsReader, TestFloatRangeFieldQueries, TestLSBRadixSorter, TestSloppyPhraseQuery2, TestIndexManyDocuments, TestPrefixCodedTerms, TestSoftDeletesRetentionMergePolicy, TestIndexWriterDelete, TestFixedBitDocIdSet, TestConjunctions, TestBagOfPostings, TestMultiTermsEnum, TestIndexWriterThreadsToSegments, TestRAMDirectory, TestMatchNoDocsQuery, TestFutureArrays, TestLatLonDocValuesField, TestDateTools, TestBufferedIndexInput, TestAssertions, TestIndexWriterForceMerge, TestPhraseQuery, TestDeterminizeLexicon, TestDocValuesRewriteMethod, TestArrayUtil, TestDelegatingAnalyzerWrapper, TestCheckIndex, TestCodecUtil, TestDateSort, TestDirectoryReaderReopen, TestDocumentsWriterStallControl, TestDocsAndPositions, TestIndexWriterOnJRECrash, TestFilterMergePolicy, TestNeverDelete, TestBoolean2ScorerSupplier, TestTopFieldCollectorEarlyTermination, TestCharTermAttributeImpl, TestStressIndexing, TestIndexedDISI, TestSpanExplanations, TestOmitPositions, TestReqOptSumScorer, TestIntArrayDocIdSet, TestIndependenceStandardized, TestForUtil, TestQueryBuilder, TestMixedDocValuesUpdates, TestCustomTermFreq, TestBooleanQueryVisitSubscorers, TestMultiCollector, TestLucene70SegmentInfoFormat, TestPerFieldDocValuesFormat, TestPerFieldPostingsFormat2, TestBinaryDocument, TestField, TestFieldType, TestFloatRange, TestIntRange, TestLongDistanceFeatureQuery, TestPolygon, TestPolygon2D, Test2BBinaryDocValues, Test2BSortedDocValuesOrds, TestAllFilesHaveChecksumFooter, TestAllFilesHaveCodecHeader, TestCodecs, TestConcurrentMergeScheduler, TestConsistentFieldNumbers, TestCrash, TestDemoParallelLeafReader, TestDirectoryReader, TestDocInverterPerFieldErrorInfo, TestDocValues, TestExitableDirectoryReader, TestFieldInfos, TestFieldInvertState, TestFieldReuse, TestFieldsReader, TestFilterCodecReader, TestFlushByRamOrCountsPolicy, TestForTooMuchCloning, TestForceMergeForever, TestIndexCommit, TestIndexFileDeleter, TestIndexInput, TestIndexTooManyDocs, TestIndexWriter, TestIndexWriterCommit, TestIndexWriterConfig, TestIndexWriterExceptions, TestIndexWriterExceptions2, TestIndexWriterLockRelease, TestIndexWriterMaxDocs]\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestIndexWriterMaxDocs -Dtests.seed=4544F11B4D9BB14C -Dtests.nightly=true -Dtests.slow=true -Dtests.monster=true -Dtests.locale=ko-KR -Dtests.timezone=Atlantic/Jan_Mayen -Dtests.asserts=true -Dtests.file.encoding=US-ASCII\n   [junit4] ERROR   0.00s J0 | TestIndexWriterMaxDocs (suite) <<<\n   [junit4]    > Throwable #1: com.carrotsearch.randomizedtesting.ThreadLeakError: 1 thread leaked from SUITE scope at org.apache.lucene.index.TestIndexWriterMaxDocs: \n   [junit4]    >    1) Thread[id=2505, name=Lucene Merge Thread #13, state=RUNNABLE, group=TGRP-TestIndexWriterMaxDocs]\n   [junit4]    >         at org.apache.lucene.codecs.PushPostingsWriterBase.writeTerm(PushPostingsWriterBase.java:148)\n   [junit4]    >         at org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter$TermsWriter.write(BlockTreeTermsWriter.java:865)\n   [junit4]    >         at org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter.write(BlockTreeTermsWriter.java:344)\n   [junit4]    >         at org.apache.lucene.codecs.FieldsConsumer.merge(FieldsConsumer.java:105)\n   [junit4]    >         at org.apache.lucene.codecs.perfield.PerFieldPostingsFormat$FieldsWriter.merge(PerFieldPostingsFormat.java:165)\n   [junit4]    >         at org.apache.lucene.index.SegmentMerger.mergeTerms(SegmentMerger.java:244)\n   [junit4]    >         at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:139)\n   [junit4]    >         at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4453)\n   [junit4]    >         at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:4075)\n   [junit4]    >         at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:625)\n   [junit4]    >         at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:662)\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([4544F11B4D9BB14C]:0)\n   [junit4] Completed [321/510 (1!)] on J0 in 1634.90s, 21 tests, 1 failure, 1 error <<< FAILURES!",
    "attachments": {
        "LUCENE-8520.patch": "https://issues.apache.org/jira/secure/attachment/12942372/LUCENE-8520.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "id": "comment-16635296",
            "author": "Steve Rowe",
            "content": "CC Adrien Grand ",
            "date": "2018-10-02T11:03:34+0000"
        },
        {
            "id": "comment-16638070",
            "author": "Ignacio Vera",
            "content": "I have a look into this error and it looks like the test is incorrect now as we do not count total hits by default.\u00a0\n\nAttached is a patch that performs the query so that all hits are computed.\u00a0 ",
            "date": "2018-10-04T10:57:19+0000"
        },
        {
            "id": "comment-16638176",
            "author": "Jim Ferenczi",
            "content": "+1, good catch Ignacio Vera ! ",
            "date": "2018-10-04T12:41:14+0000"
        },
        {
            "id": "comment-16638563",
            "author": "Lucene/Solr QA",
            "content": "\n\n\n  +1 overall \n\n\n\n\n\n\n\n\n\n Vote \n Subsystem \n Runtime \n Comment \n\n\n\u00a0\n\u00a0\n\u00a0\n  Prechecks  \n\n\n +1 \n  test4tests  \n   0m  0s \n  The patch appears to include 1 new or modified test files.  \n\n\n\u00a0\n\u00a0\n\u00a0\n  master Compile Tests  \n\n\n +1 \n  compile  \n   3m 13s \n  master passed  \n\n\n\u00a0\n\u00a0\n\u00a0\n  Patch Compile Tests  \n\n\n +1 \n  compile  \n   4m  8s \n  the patch passed  \n\n\n +1 \n  javac  \n   4m  9s \n  the patch passed  \n\n\n +1 \n  Release audit (RAT)  \n   4m  8s \n  the patch passed  \n\n\n +1 \n  Check forbidden APIs  \n   4m  8s \n  the patch passed  \n\n\n +1 \n  Validate source patterns  \n   4m  8s \n  the patch passed  \n\n\n\u00a0\n\u00a0\n\u00a0\n  Other Tests  \n\n\n +1 \n  unit  \n  48m 34s \n  core in the patch passed.  \n\n\n  \n   \n  67m 20s \n   \n\n\n\n\n\n\n\n\n\n Subsystem \n Report/Notes \n\n\n JIRA Issue \n LUCENE-8520 \n\n\n JIRA Patch URL \n https://issues.apache.org/jira/secure/attachment/12942372/LUCENE-8520.patch \n\n\n Optional Tests \n  compile  javac  unit  ratsources  checkforbiddenapis  validatesourcepatterns  \n\n\n uname \n Linux lucene2-us-west.apache.org 4.4.0-112-generic #135-Ubuntu SMP Fri Jan 19 11:48:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux \n\n\n Build tool \n ant \n\n\n Personality \n /home/jenkins/jenkins-slave/workspace/PreCommit-LUCENE-Build/sourcedir/dev-tools/test-patch/lucene-solr-yetus-personality.sh \n\n\n git revision \n master / a0487b0 \n\n\n ant \n version: Apache Ant(TM) version 1.9.6 compiled on July 20 2018 \n\n\n Default Java \n 1.8.0_172 \n\n\n  Test Results \n https://builds.apache.org/job/PreCommit-LUCENE-Build/100/testReport/ \n\n\n modules \n C: lucene/core U: lucene/core \n\n\n Console output \n https://builds.apache.org/job/PreCommit-LUCENE-Build/100/console \n\n\n Powered by \n Apache Yetus 0.7.0   http://yetus.apache.org \n\n\n\n\n\n\nThis message was automatically generated.\n ",
            "date": "2018-10-04T17:19:01+0000"
        },
        {
            "id": "comment-16639353",
            "author": "ASF subversion and git services",
            "content": "Commit 98b057c93a79e11f60cc6e1feeb16743030a576b in lucene-solr's branch refs/heads/master from iverase\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=98b057c ]\n\nLUCENE-8520: Fix test by running  query so it count total hits ",
            "date": "2018-10-05T06:59:54+0000"
        }
    ]
}