{
    "id": "SOLR-9788",
    "title": "Use instrumented jetty classes",
    "details": {
        "components": [
            "metrics"
        ],
        "type": "Improvement",
        "labels": "",
        "fix_versions": [
            "6.4",
            "7.0"
        ],
        "affect_versions": "None",
        "status": "Resolved",
        "resolution": "Fixed",
        "priority": "Major"
    },
    "description": "Dropwizard metrics library integrated in SOLR-8785 provides a set of instrumented equivalents of Jetty classes. This allows us to collect statistics on  Jetty's connector, thread pool and handlers.",
    "attachments": {
        "SOLR_9788.patch": "https://issues.apache.org/jira/secure/attachment/12840110/SOLR_9788.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2016-11-22T20:50:26+0000",
            "author": "Shalin Shekhar Mangar",
            "content": "This patch:\n\n\tAdds metric-jetty9 as a dependency to the jetty server.\n\tUses InstrumentedQueuedThreadPool and InstrumentedHandler in jetty configurations with a MetricRegistry named \"solrjetty\" obtained from SharedMetricRegistries.\n\n\n\nThis is still work in progress. ",
            "id": "comment-15687851"
        },
        {
            "date": "2016-11-23T20:06:58+0000",
            "author": "Shalin Shekhar Mangar",
            "content": "Changes:\n\n\tThe metric registery is renamed to \"solr\" from \"solrjetty\"\n\tAdds the MetricsServlet to /admin/metrics path \u2013 this lists all the jetty metrics that we are tracking\n\tA new SolrMetricsServletContextListener that sets the \"solr\" MetricRegistry as a context attribute that is needed for MetricsServlet to work\n\tThe metrics library and its dependencies are now in the server module instead of core otherwise the metric registry looked up by SolrMetricsServletContextListener is different (due to them being loaded by different class loaders)\n\n\n\nNow that we have this in place, we can easily hook in the jvm metrics as well but I won't do that in this issue.\n\nAs long as all metrics are registered with the same metric registry, the /admin/metrics path can display all of our metrics. This will likely not play well with the changes in SOLR-4735 because that creates a MetricRegistry for each core. We might need to write our own version of MetricsServlet or write a wrapper. ",
            "id": "comment-15691250"
        },
        {
            "date": "2016-11-23T20:29:14+0000",
            "author": "Shalin Shekhar Mangar",
            "content": "Here's an example output from /admin/metrics:\n\n{\n  \"version\" : \"3.0.0\",\n  \"gauges\" : {\n    \"org.eclipse.jetty.server.handler.DefaultHandler.percent-4xx-15m\" : {\n      \"value\" : 0.0\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.percent-4xx-1m\" : {\n      \"value\" : 0.0\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.percent-4xx-5m\" : {\n      \"value\" : 0.0\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.percent-5xx-15m\" : {\n      \"value\" : 0.0\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.percent-5xx-1m\" : {\n      \"value\" : 0.0\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.percent-5xx-5m\" : {\n      \"value\" : 0.0\n    },\n    \"org.eclipse.jetty.util.thread.QueuedThreadPool.qtp707806938.jobs\" : {\n      \"value\" : 0\n    },\n    \"org.eclipse.jetty.util.thread.QueuedThreadPool.qtp707806938.size\" : {\n      \"value\" : 10\n    },\n    \"org.eclipse.jetty.util.thread.QueuedThreadPool.qtp707806938.utilization\" : {\n      \"value\" : 0.6\n    },\n    \"org.eclipse.jetty.util.thread.QueuedThreadPool.qtp707806938.utilization-max\" : {\n      \"value\" : 6.0E-4\n    }\n  },\n  \"counters\" : {\n    \"org.eclipse.jetty.server.handler.DefaultHandler.active-dispatches\" : {\n      \"count\" : 0\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.active-requests\" : {\n      \"count\" : 0\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.active-suspended\" : {\n      \"count\" : 0\n    }\n  },\n  \"histograms\" : { },\n  \"meters\" : {\n    \"org.eclipse.jetty.server.handler.DefaultHandler.1xx-responses\" : {\n      \"count\" : 0,\n      \"m15_rate\" : 0.0,\n      \"m1_rate\" : 0.0,\n      \"m5_rate\" : 0.0,\n      \"mean_rate\" : 0.0,\n      \"units\" : \"events/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.2xx-responses\" : {\n      \"count\" : 6,\n      \"m15_rate\" : 1.2,\n      \"m1_rate\" : 1.2,\n      \"m5_rate\" : 1.2,\n      \"mean_rate\" : 0.8643507760595339,\n      \"units\" : \"events/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.3xx-responses\" : {\n      \"count\" : 0,\n      \"m15_rate\" : 0.0,\n      \"m1_rate\" : 0.0,\n      \"m5_rate\" : 0.0,\n      \"mean_rate\" : 0.0,\n      \"units\" : \"events/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.4xx-responses\" : {\n      \"count\" : 0,\n      \"m15_rate\" : 0.0,\n      \"m1_rate\" : 0.0,\n      \"m5_rate\" : 0.0,\n      \"mean_rate\" : 0.0,\n      \"units\" : \"events/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.5xx-responses\" : {\n      \"count\" : 0,\n      \"m15_rate\" : 0.0,\n      \"m1_rate\" : 0.0,\n      \"m5_rate\" : 0.0,\n      \"mean_rate\" : 0.0,\n      \"units\" : \"events/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.async-dispatches\" : {\n      \"count\" : 0,\n      \"m15_rate\" : 0.0,\n      \"m1_rate\" : 0.0,\n      \"m5_rate\" : 0.0,\n      \"mean_rate\" : 0.0,\n      \"units\" : \"events/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.async-timeouts\" : {\n      \"count\" : 0,\n      \"m15_rate\" : 0.0,\n      \"m1_rate\" : 0.0,\n      \"m5_rate\" : 0.0,\n      \"mean_rate\" : 0.0,\n      \"units\" : \"events/second\"\n    }\n  },\n  \"timers\" : {\n    \"org.eclipse.jetty.server.handler.DefaultHandler.connect-requests\" : {\n      \"count\" : 0,\n      \"max\" : 0.0,\n      \"mean\" : 0.0,\n      \"min\" : 0.0,\n      \"p50\" : 0.0,\n      \"p75\" : 0.0,\n      \"p95\" : 0.0,\n      \"p98\" : 0.0,\n      \"p99\" : 0.0,\n      \"p999\" : 0.0,\n      \"stddev\" : 0.0,\n      \"m15_rate\" : 0.0,\n      \"m1_rate\" : 0.0,\n      \"m5_rate\" : 0.0,\n      \"mean_rate\" : 0.0,\n      \"duration_units\" : \"seconds\",\n      \"rate_units\" : \"calls/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.delete-requests\" : {\n      \"count\" : 0,\n      \"max\" : 0.0,\n      \"mean\" : 0.0,\n      \"min\" : 0.0,\n      \"p50\" : 0.0,\n      \"p75\" : 0.0,\n      \"p95\" : 0.0,\n      \"p98\" : 0.0,\n      \"p99\" : 0.0,\n      \"p999\" : 0.0,\n      \"stddev\" : 0.0,\n      \"m15_rate\" : 0.0,\n      \"m1_rate\" : 0.0,\n      \"m5_rate\" : 0.0,\n      \"mean_rate\" : 0.0,\n      \"duration_units\" : \"seconds\",\n      \"rate_units\" : \"calls/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.dispatches\" : {\n      \"count\" : 6,\n      \"max\" : 1.05,\n      \"mean\" : 0.1916620195600857,\n      \"min\" : 0.002,\n      \"p50\" : 0.01,\n      \"p75\" : 0.062000000000000006,\n      \"p95\" : 1.05,\n      \"p98\" : 1.05,\n      \"p99\" : 1.05,\n      \"p999\" : 1.05,\n      \"stddev\" : 0.3872921205929878,\n      \"m15_rate\" : 1.2,\n      \"m1_rate\" : 1.2,\n      \"m5_rate\" : 1.2,\n      \"mean_rate\" : 0.8639066608151542,\n      \"duration_units\" : \"seconds\",\n      \"rate_units\" : \"calls/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.get-requests\" : {\n      \"count\" : 6,\n      \"max\" : 1.05,\n      \"mean\" : 0.1916620195600857,\n      \"min\" : 0.002,\n      \"p50\" : 0.01,\n      \"p75\" : 0.062000000000000006,\n      \"p95\" : 1.05,\n      \"p98\" : 1.05,\n      \"p99\" : 1.05,\n      \"p999\" : 1.05,\n      \"stddev\" : 0.3872921205929878,\n      \"m15_rate\" : 1.2,\n      \"m1_rate\" : 1.2,\n      \"m5_rate\" : 1.2,\n      \"mean_rate\" : 0.8639236767111607,\n      \"duration_units\" : \"seconds\",\n      \"rate_units\" : \"calls/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.head-requests\" : {\n      \"count\" : 0,\n      \"max\" : 0.0,\n      \"mean\" : 0.0,\n      \"min\" : 0.0,\n      \"p50\" : 0.0,\n      \"p75\" : 0.0,\n      \"p95\" : 0.0,\n      \"p98\" : 0.0,\n      \"p99\" : 0.0,\n      \"p999\" : 0.0,\n      \"stddev\" : 0.0,\n      \"m15_rate\" : 0.0,\n      \"m1_rate\" : 0.0,\n      \"m5_rate\" : 0.0,\n      \"mean_rate\" : 0.0,\n      \"duration_units\" : \"seconds\",\n      \"rate_units\" : \"calls/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.move-requests\" : {\n      \"count\" : 0,\n      \"max\" : 0.0,\n      \"mean\" : 0.0,\n      \"min\" : 0.0,\n      \"p50\" : 0.0,\n      \"p75\" : 0.0,\n      \"p95\" : 0.0,\n      \"p98\" : 0.0,\n      \"p99\" : 0.0,\n      \"p999\" : 0.0,\n      \"stddev\" : 0.0,\n      \"m15_rate\" : 0.0,\n      \"m1_rate\" : 0.0,\n      \"m5_rate\" : 0.0,\n      \"mean_rate\" : 0.0,\n      \"duration_units\" : \"seconds\",\n      \"rate_units\" : \"calls/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.options-requests\" : {\n      \"count\" : 0,\n      \"max\" : 0.0,\n      \"mean\" : 0.0,\n      \"min\" : 0.0,\n      \"p50\" : 0.0,\n      \"p75\" : 0.0,\n      \"p95\" : 0.0,\n      \"p98\" : 0.0,\n      \"p99\" : 0.0,\n      \"p999\" : 0.0,\n      \"stddev\" : 0.0,\n      \"m15_rate\" : 0.0,\n      \"m1_rate\" : 0.0,\n      \"m5_rate\" : 0.0,\n      \"mean_rate\" : 0.0,\n      \"duration_units\" : \"seconds\",\n      \"rate_units\" : \"calls/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.other-requests\" : {\n      \"count\" : 0,\n      \"max\" : 0.0,\n      \"mean\" : 0.0,\n      \"min\" : 0.0,\n      \"p50\" : 0.0,\n      \"p75\" : 0.0,\n      \"p95\" : 0.0,\n      \"p98\" : 0.0,\n      \"p99\" : 0.0,\n      \"p999\" : 0.0,\n      \"stddev\" : 0.0,\n      \"m15_rate\" : 0.0,\n      \"m1_rate\" : 0.0,\n      \"m5_rate\" : 0.0,\n      \"mean_rate\" : 0.0,\n      \"duration_units\" : \"seconds\",\n      \"rate_units\" : \"calls/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.post-requests\" : {\n      \"count\" : 0,\n      \"max\" : 0.0,\n      \"mean\" : 0.0,\n      \"min\" : 0.0,\n      \"p50\" : 0.0,\n      \"p75\" : 0.0,\n      \"p95\" : 0.0,\n      \"p98\" : 0.0,\n      \"p99\" : 0.0,\n      \"p999\" : 0.0,\n      \"stddev\" : 0.0,\n      \"m15_rate\" : 0.0,\n      \"m1_rate\" : 0.0,\n      \"m5_rate\" : 0.0,\n      \"mean_rate\" : 0.0,\n      \"duration_units\" : \"seconds\",\n      \"rate_units\" : \"calls/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.put-requests\" : {\n      \"count\" : 0,\n      \"max\" : 0.0,\n      \"mean\" : 0.0,\n      \"min\" : 0.0,\n      \"p50\" : 0.0,\n      \"p75\" : 0.0,\n      \"p95\" : 0.0,\n      \"p98\" : 0.0,\n      \"p99\" : 0.0,\n      \"p999\" : 0.0,\n      \"stddev\" : 0.0,\n      \"m15_rate\" : 0.0,\n      \"m1_rate\" : 0.0,\n      \"m5_rate\" : 0.0,\n      \"mean_rate\" : 0.0,\n      \"duration_units\" : \"seconds\",\n      \"rate_units\" : \"calls/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.requests\" : {\n      \"count\" : 6,\n      \"max\" : 1.05,\n      \"mean\" : 0.1916620195600857,\n      \"min\" : 0.002,\n      \"p50\" : 0.01,\n      \"p75\" : 0.062000000000000006,\n      \"p95\" : 1.05,\n      \"p98\" : 1.05,\n      \"p99\" : 1.05,\n      \"p999\" : 1.05,\n      \"stddev\" : 0.3872921205929878,\n      \"m15_rate\" : 1.2,\n      \"m1_rate\" : 1.2,\n      \"m5_rate\" : 1.2,\n      \"mean_rate\" : 0.86372875919477,\n      \"duration_units\" : \"seconds\",\n      \"rate_units\" : \"calls/second\"\n    },\n    \"org.eclipse.jetty.server.handler.DefaultHandler.trace-requests\" : {\n      \"count\" : 0,\n      \"max\" : 0.0,\n      \"mean\" : 0.0,\n      \"min\" : 0.0,\n      \"p50\" : 0.0,\n      \"p75\" : 0.0,\n      \"p95\" : 0.0,\n      \"p98\" : 0.0,\n      \"p99\" : 0.0,\n      \"p999\" : 0.0,\n      \"stddev\" : 0.0,\n      \"m15_rate\" : 0.0,\n      \"m1_rate\" : 0.0,\n      \"m5_rate\" : 0.0,\n      \"mean_rate\" : 0.0,\n      \"duration_units\" : \"seconds\",\n      \"rate_units\" : \"calls/second\"\n    }\n  }\n}\n\n ",
            "id": "comment-15691300"
        },
        {
            "date": "2016-11-28T12:39:20+0000",
            "author": "Shalin Shekhar Mangar",
            "content": "Changed the metric registry name to \"/jetty\" as per suggestion in SOLR-4735\n\nI am going to create a branch called \"origin/feature/metrics\" so that we can keep SOLR-9788, SOLR-4735 and other metrics improvements in sync. ",
            "id": "comment-15701871"
        },
        {
            "date": "2016-11-28T12:42:04+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 497212e05451c11088fb4f04d1c8e6092915dc40 in lucene-solr's branch refs/heads/feature/metrics from Shalin Shekhar Mangar\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=497212e ]\n\nSOLR-9788: Use instrumented jetty classes provided by the dropwizard metric library. This also introduces a new /admin/metrics API endpoint to return all registered metrics in JSON format ",
            "id": "comment-15701876"
        },
        {
            "date": "2016-11-30T13:25:41+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 1e1ae1ffa9994b4ec05a8fdd590dd5a6973c71c0 in lucene-solr's branch refs/heads/feature/metrics from Shalin Shekhar Mangar\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=1e1ae1f ]\n\nSOLR-9788: Use \"solr.jetty\" as the metric registry name for jetty stats ",
            "id": "comment-15708594"
        },
        {
            "date": "2016-12-20T09:12:43+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 8bbdb6248c5de3f3bd61501ba42a50aeec29c78b in lucene-solr's branch refs/heads/master from Andrzej Bialecki \n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8bbdb62 ]\n\nSquashed commit of branch 'feature/metrics', containing:\n    SOLR-4735: Improve Solr metrics reporting\n    SOLR-9812: Implement /admin/metrics API\n    SOLR-9805: Use metrics-jvm library to instrument jvm internals\n    SOLR-9788: Use instrumented jetty classes ",
            "id": "comment-15763714"
        },
        {
            "date": "2016-12-27T15:30:16+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 9dde8a30303de4bce5da45189219dd6150252b29 in lucene-solr's branch refs/heads/branch_6x from Andrzej Bialecki \n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=9dde8a3 ]\n\nCumulative patch from master, originally developed on branch\n'feature/metrics', which brings the following issues:\n\n\tSOLR-4735: Improve Solr metrics reporting\n\tSOLR-9812: Implement /admin/metrics API\n\tSOLR-9805: Use metrics-jvm library to instrument jvm internals\n\tSOLR-9788: Use instrumented jetty classes\n\n ",
            "id": "comment-15780618"
        }
    ]
}