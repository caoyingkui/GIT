{
    "id": "SOLR-3793",
    "title": "duplicate (deleted) documents included in result set when using field faceting with fq",
    "details": {
        "affect_versions": "4.0-BETA",
        "status": "Closed",
        "fix_versions": [
            "4.0"
        ],
        "components": [],
        "type": "Bug",
        "priority": "Blocker",
        "labels": "",
        "resolution": "Fixed"
    },
    "description": "G\u00fcnter Hipler reported on the solr-user mailing list that he was seeing inconsistencies in facet counts compared to the numFound when drilling down onto those facets (using \"fq\") - in particular: when adding an \"fq\" such as `fq=\n{!term+f%3DnavNetwork}\nnebis`, the resulting numFound was higher then the number of docs reported by the facet constraint for nebis in the base request.\n\nI've been able to trivially reproduce this using the example data from Solr 4.0-BETA, trunk@r1381400, and branch_4x@r1381400 (details in comment to follow)\n\nImportant things to note from G\u00fcnter's email thread with his assessment of the problem...\n\nhttps://mail-archives.apache.org/mod_mbox/lucene-solr-user/201208.mbox/%3CCAM_U7jfDpNrGfmWmNtNACHCDCJw4YB-rLBBvRW_WP_jdOb_cgw@mail.gmail.com%3E\n\nThe behaviour is not consistent. Some of the facets provide the correct result, some not.  What I can't say for sure: The behaviour was correct (if I'm not wrong) once the whole index was newly created. After running some updates I got these results.\n\nI'm going to setup a new index with the Lucene 4.0 version from March (to be more exactly: it's version 4.0-2012-03-09_11-29-20) to see what are the results even in case of frequent updates ... the version deployed in march doesn't contain the error I now come across in Beta4.0",
    "attachments": {
        "SOLR-3793.patch": "https://issues.apache.org/jira/secure/attachment/12544031/SOLR-3793.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "author": "Hoss Man",
            "id": "comment-13449140",
            "date": "2012-09-05T21:13:26+0000",
            "content": "Steps to reproduce...\n\n\n\n1) Start with a clean install of 4.0-BETA, containing a completley empty example index, and run solr...\n\n\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example$ ls -a solr/collection1/data/\n.  ..\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example$ java -jar start.jar \n2012-09-05 12:59:56.596:INFO:oejs.Server:jetty-8.1.2.v20120308\n...\n\n\n\n2) In another window, index all sample documents...\n\n\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ java -jar post.jar *.xml\n...\n\n\n\n3) Observe the results of a simple query faceting on \"cat\", as well as the results of filtering on one of those cat values...\n\n\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":2},\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  },\n  \"facet_counts\":{\n    \"facet_queries\":{},\n    \"facet_fields\":{\n      \"cat\":[\n        \"electronics\",3,\n        \"connector\",2,\n        \"music\",1]},\n    \"facet_dates\":{},\n    \"facet_ranges\":{}}}\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true&fq=cat:electronics'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":8},\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  },\n  \"facet_counts\":{\n    \"facet_queries\":{},\n    \"facet_fields\":{\n      \"cat\":[\n        \"electronics\",3,\n        \"connector\",2,\n        \"music\",1]},\n    \"facet_dates\":{},\n    \"facet_ranges\":{}}}\n\n\n\n4) Re-index some of the sample documents, forcing a new segment to be created, as well as some deletions...\n\n\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ java -jar post.jar ipod_*S\n...\n\n\n\n5) observe that while the \"simple\" results are unchanged, the filtered request now includes duplicate (deleted?) documents in the result set...\n\n\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":2},\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  },\n  \"facet_counts\":{\n    \"facet_queries\":{},\n    \"facet_fields\":{\n      \"cat\":[\n        \"electronics\",3,\n        \"connector\",2,\n        \"music\",1]},\n    \"facet_dates\":{},\n    \"facet_ranges\":{}}}\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true&fq=cat:electronics'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":2},\n  \"response\":{\"numFound\":6,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  },\n  \"facet_counts\":{\n    \"facet_queries\":{},\n    \"facet_fields\":{\n      \"cat\":[\n        \"electronics\",3,\n        \"connector\",2,\n        \"music\",1]},\n    \"facet_dates\":{},\n    \"facet_ranges\":{}}}\n\n\n\n\n\nInteresting things to note...\n\n1) stoping & restarting jetty does not make the problem go away, which initially suggested to me that the problem is not related to any sort of stale-caching of filters/docsets \u2013 however if you stop & restart jetty, or even just issue a commit, and then re-issue the same two requests in reverse order, then no duplicates are included.  do another commit, send the requests in the (original) problematic order and the problem re-appears...\n\n\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true&fq=cat:electronics'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":6},\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  },\n  \"facet_counts\":{\n    \"facet_queries\":{},\n    \"facet_fields\":{\n      \"cat\":[\n        \"electronics\",3,\n        \"connector\",2,\n        \"music\",1]},\n    \"facet_dates\":{},\n    \"facet_ranges\":{}}}\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":2},\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  },\n  \"facet_counts\":{\n    \"facet_queries\":{},\n    \"facet_fields\":{\n      \"cat\":[\n        \"electronics\",3,\n        \"connector\",2,\n        \"music\",1]},\n    \"facet_dates\":{},\n    \"facet_ranges\":{}}}\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ java -Ddata=args -jar post.jar '<commit/>'SimplePostTool version 1.5\nPOSTing args to http://localhost:8983/solr/update..\nCOMMITting Solr index changes to http://localhost:8983/solr/update..\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":2},\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  },\n  \"facet_counts\":{\n    \"facet_queries\":{},\n    \"facet_fields\":{\n      \"cat\":[\n        \"electronics\",3,\n        \"connector\",2,\n        \"music\",1]},\n    \"facet_dates\":{},\n    \"facet_ranges\":{}}}\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&wt=json&indent=true&fq=cat:electronics'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":3},\n  \"response\":{\"numFound\":6,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  },\n  \"facet_counts\":{\n    \"facet_queries\":{},\n    \"facet_fields\":{\n      \"cat\":[\n        \"electronics\",6,\n        \"connector\",4,\n        \"music\",1]},\n    \"facet_dates\":{},\n    \"facet_ranges\":{}}}\n\n\n\n2) Optimizing seems to eliminate the problem completley, suggesting that the root cause is definitely related to multiple segments containing deletions.\n\n3) Bizarely, the problem seems to be specific to faceting: using the same steps, with the same simple queries & fq, but leaving out the facet params, the duplicate documents are not returned...\n\n\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ java -jar post.jar *.xml\n...\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&wt=json&indent=true'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":13},\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  }}\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&wt=json&indent=true&fq=cat:electronics'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":10},\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  }}\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ java -jar post.jar ipod_*\n...\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&wt=json&indent=true'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":2},\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  }}\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&wt=json&indent=true&fq=cat:electronics'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":3},\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  }}\n\n\n\n\n\n\n "
        },
        {
            "author": "Hoss Man",
            "id": "comment-13449163",
            "date": "2012-09-05T21:34:08+0000",
            "content": "The problem seems to be specific to using UnInvertedField via facet.method=fc for faceting, but only if you have not already used facet.method=enum (no idea how using UnInvertedField during the faceting could affect the total result set)...\n\n\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ java -Ddata=args -jar post.jar '<commit/>'\nSimplePostTool version 1.5\nPOSTing args to http://localhost:8983/solr/update..\nCOMMITting Solr index changes to http://localhost:8983/solr/update..\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&facet.method=enum&wt=json&indent=true'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":4},\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  },\n  \"facet_counts\":{\n    \"facet_queries\":{},\n    \"facet_fields\":{\n      \"cat\":[\n        \"electronics\",3,\n        \"connector\",2,\n        \"music\",1]},\n    \"facet_dates\":{},\n    \"facet_ranges\":{}}}\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&facet.method=enum&wt=json&indent=true&fq=cat:electronics'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":3},\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  },\n  \"facet_counts\":{\n    \"facet_queries\":{},\n    \"facet_fields\":{\n      \"cat\":[\n        \"electronics\",3,\n        \"connector\",2,\n        \"music\",1]},\n    \"facet_dates\":{},\n    \"facet_ranges\":{}}}\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&facet.method=fc&wt=json&indent=true'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":3},\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  },\n  \"facet_counts\":{\n    \"facet_queries\":{},\n    \"facet_fields\":{\n      \"cat\":[\n        \"electronics\",3,\n        \"connector\",2,\n        \"music\",1]},\n    \"facet_dates\":{},\n    \"facet_ranges\":{}}}\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&facet.method=fc&wt=json&indent=true&fq=cat:electronics'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":1},\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  },\n  \"facet_counts\":{\n    \"facet_queries\":{},\n    \"facet_fields\":{\n      \"cat\":[\n        \"electronics\",3,\n        \"connector\",2,\n        \"music\",1]},\n    \"facet_dates\":{},\n    \"facet_ranges\":{}}}\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ java -Ddata=args -jar post.jar '<commit/>'SimplePostTool version 1.5\nPOSTing args to http://localhost:8983/solr/update..\nCOMMITting Solr index changes to http://localhost:8983/solr/update..\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&facet.method=fc&wt=json&indent=true'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":5},\n  \"response\":{\"numFound\":3,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  },\n  \"facet_counts\":{\n    \"facet_queries\":{},\n    \"facet_fields\":{\n      \"cat\":[\n        \"electronics\",3,\n        \"connector\",2,\n        \"music\",1]},\n    \"facet_dates\":{},\n    \"facet_ranges\":{}}}\nhossman@frisbee:~/tmp/apache-solr-4.0.0-BETA/solr/example/exampledocs$ curl 'http://localhost:8983/solr/select?echoParams=none&q=ipod&rows=5&fl=id&facet=true&facet.field=cat&facet.mincount=1&facet.method=fc&wt=json&indent=true&fq=cat:electronics'\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":2},\n  \"response\":{\"numFound\":6,\"start\":0,\"docs\":[\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"IW-02\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"F8V7067-APL-KIT\"},\n      {\n        \"id\":\"MA147LL/A\"}]\n  },\n  \"facet_counts\":{\n    \"facet_queries\":{},\n    \"facet_fields\":{\n      \"cat\":[\n        \"electronics\",6,\n        \"connector\",4,\n        \"music\",1]},\n    \"facet_dates\":{},\n    \"facet_ranges\":{}}}\n\n "
        },
        {
            "author": "Hoss Man",
            "id": "comment-13449170",
            "date": "2012-09-05T21:43:46+0000",
            "content": "confirmed this affects trunk & branch_4x "
        },
        {
            "author": "Yonik Seeley",
            "id": "comment-13449581",
            "date": "2012-09-06T11:41:50+0000",
            "content": "Here's a patch to fix the problem.\n\nThe issue was when UnInvertedField faceting cached big terms as filters, it failed to set/use liveDocs.  Later, an \"fq\" was used that retrieved the filter from the cache and used that filter as liveDocs, bringing deleted docs back from the dead.  "
        },
        {
            "author": "Yonik Seeley",
            "id": "comment-13449598",
            "date": "2012-09-06T12:36:22+0000",
            "content": "Committed to trunk and 4x\nhttp://svn.apache.org/viewvc?rev=1381568&view=rev\nhttp://svn.apache.org/viewvc?rev=1381569&view=rev "
        },
        {
            "author": "Guenter Hipler",
            "id": "comment-13449609",
            "date": "2012-09-06T12:55:31+0000",
            "content": "Thanks Yonik,\nI'm going to test it with the upcoming nightly build\nG\u00fcnter "
        },
        {
            "author": "Commit Tag Bot",
            "id": "comment-13610907",
            "date": "2013-03-22T16:43:31+0000",
            "content": "[branch_4x commit] Yonik Seeley\nhttp://svn.apache.org/viewvc?view=revision&revision=1381569\n\nSOLR-3793: use livedocs when caching big terms "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13654022",
            "date": "2013-05-10T10:33:46+0000",
            "content": "Closed after release. "
        }
    ]
}