{
    "id": "LUCENE-7175",
    "title": "TestPointQueries.testRandomBinaryMedium() failure",
    "details": {
        "resolution": "Unresolved",
        "affect_versions": "None",
        "components": [],
        "labels": "",
        "fix_versions": [],
        "priority": "Minor",
        "status": "Open",
        "type": "Bug"
    },
    "description": "My Jenkins found a failure on branch_6_0 that does not reproduce for me:\n\n\nChecking out Revision 48c80f91b8e5cd9b3a9b48e6184bd53e7619e7e3 (refs/remotes/origin/branch_6_0)\n[...]\n   [junit4] Suite: org.apache.lucene.search.TestPointQueries\n   [junit4]   2> NOTE: download the large Jenkins line-docs file by running 'ant get-jenkins-line-docs' in the lucene directory.\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestPointQueries -Dtests.method=testRandomBinaryMedium -Dtests.seed=9C435B953E7FAA90 -Dtests.slow=true -Dtests.linedocsfile=/home/jenkins/lucene-data/enwiki.random.lines.txt -Dtests.locale=es-CU -Dtests.timezone=America/Coral_Harbour -Dtests.asserts=true -Dtests.file.encoding=ISO-8859-1\n   [junit4] FAILURE 0.22s J0 | TestPointQueries.testRandomBinaryMedium <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([9C435B953E7FAA90:EB6EDCD5EAD3DF47]:0)\n   [junit4]    > \tat org.apache.lucene.codecs.asserting.AssertingLiveDocsFormat.newLiveDocs(AssertingLiveDocsFormat.java:43)\n   [junit4]    > \tat org.apache.lucene.index.FreqProxTermsWriter.applyDeletes(FreqProxTermsWriter.java:66)\n   [junit4]    > \tat org.apache.lucene.index.FreqProxTermsWriter.flush(FreqProxTermsWriter.java:102)\n   [junit4]    > \tat org.apache.lucene.index.DefaultIndexingChain.flush(DefaultIndexingChain.java:134)\n   [junit4]    > \tat org.apache.lucene.index.DocumentsWriterPerThread.flush(DocumentsWriterPerThread.java:423)\n   [junit4]    > \tat org.apache.lucene.index.DocumentsWriter.doFlush(DocumentsWriter.java:502)\n   [junit4]    > \tat org.apache.lucene.index.DocumentsWriter.postUpdate(DocumentsWriter.java:376)\n   [junit4]    > \tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:466)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1492)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1271)\n   [junit4]    > \tat org.apache.lucene.index.RandomIndexWriter.addDocument(RandomIndexWriter.java:170)\n   [junit4]    > \tat org.apache.lucene.search.TestPointQueries.verifyBinary(TestPointQueries.java:700)\n   [junit4]    > \tat org.apache.lucene.search.TestPointQueries.doTestRandomBinary(TestPointQueries.java:645)\n   [junit4]    > \tat org.apache.lucene.search.TestPointQueries.testRandomBinaryMedium(TestPointQueries.java:605)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:745)\n   [junit4] IGNOR/A 0.00s J0 | TestPointQueries.testRandomLongsBig\n   [junit4]    > Assumption #1: 'nightly' test group is disabled (@Nightly())\n   [junit4] IGNOR/A 0.00s J0 | TestPointQueries.testRandomBinaryBig\n   [junit4]    > Assumption #1: 'nightly' test group is disabled (@Nightly())\n   [junit4]   2> NOTE: test params are: codec=Asserting(Lucene60): {id=PostingsFormat(name=Memory doPackFST= false)}, docValues:{id=DocValuesFormat(name=Lucene54), value=DocValuesFormat(name=Memory)}, maxPointsInLeafNode=509, maxMBSortInHeap=4.942919619081517, sim=ClassicSimilarity, locale=es-CU, timezone=America/Coral_Harbour\n   [junit4]   2> NOTE: Linux 4.1.0-custom2-amd64 amd64/Oracle Corporation 1.8.0_45 (64-bit)/cpus=16,threads=1,free=190701352,total=379060224\n   [junit4]   2> NOTE: All tests run in this JVM: [TestLegacyNumericUtils, TestRAMDirectory, TestRamUsageEstimator, TestMultiCollector, TestSpanSearchEquivalence, TestIndexWriterNRTIsCurrent, TestNRTCachingDirectory, TestIndexInput, TestIndexWriterReader, TestTopDocsMerge, TestSortRandom, TestSearchWithThreads, TestRateLimiter, TestSpanTermQuery, TestLockFactory, TestComplexExplanations, TestHighCompressionMode, TestMinShouldMatch2, TestTransactionRollback, TestIndexWriterCommit, TestIndexWriterOnJRECrash, TestPrefixRandom, TestFieldCacheRewriteMethod, TestOperations, TestPositionIncrement, TestIndexReaderClose, TestSloppyPhraseQuery, TestNRTReaderWithThreads, TestLucene53NormsFormat, TestSimpleExplanationsOfNonMatches, TestTimSorter, TestTermsEnum2, TestDocValuesRewriteMethod, TestDirectPacked, TestMatchAllDocsQuery, TestMergeSchedulerExternal, TestPrefixQuery, TestTimeLimitingCollector, TestSameTokenSamePosition, TestCharTermAttributeImpl, TestPriorityQueue, TestIOUtils, TestSearchAfter, TestSortRescorer, TestIndexWriterDeleteByQuery, TestStressNRT, TestOmitPositions, TestMaxPosition, TestFlushByRamOrCountsPolicy, TestExceedMaxTermLength, TestForTooMuchCloning, TestIndexCommit, TestDocIdSetBuilder, TestNamedSPILoader, TestRecyclingIntBlockAllocator, TestNumericRangeQuery32, TestQueryCachingPolicy, TestLucene50FieldInfoFormat, TestIndexWriterDelete, TestTermVectorsReader, TestMultiPhraseQuery, TestStringHelper, TestDocValuesIndexing, TestTermVectorsWriter, TestBasics, TestRegexpRandom2, TestCodecUtil, TestField, TestSloppyPhraseQuery2, TestSpanNotQuery, TestTermVectors, TestRegexpRandom, Test2BBKDPoints, TestCodecs, TestAtomicUpdate, TestSegmentInfos, TestSimpleFSDirectory, TestGrowableByteArrayDataOutput, TestMultiDocValues, TestFastDecompressionMode, TestRoaringDocIdSet, TestTermScorer, TestBlockPostingsFormat3, TestShardSearching, MultiCollectorTest, TestReqExclBulkScorer, TestBlendedTermQuery, TestPagedBytes, TestForUtil, TestMixedCodecs, TestUniqueTermCount, TestNoMergeScheduler, TestAttributeSource, TestSingleInstanceLockFactory, TestTermsEnum, TestDuelingCodecs, TestSimilarity, TestPerFieldPostingsFormat2, TestNeverDelete, TestFieldValueQuery, TestBinaryDocument, TestInfoStream, TestLongPostings, TestSimpleSearchEquivalence, TestPointValues, TestLucene50TermVectorsFormat, TestPointQueries]\n   [junit4] Completed [208/414 (1!)] on J0 in 3.38s, 45 tests, 1 failure, 2 skipped <<< FAILURES!",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "id": "comment-15226361",
            "author": "Michael McCandless",
            "date": "2016-04-05T14:32:36+0000",
            "content": "Hmmm that is a bit spooky.  That assert trip is saying \"I asked the current random codec to create a new live docs bitset, yet the codec failed to set all bits\", and the test is using Lucene60 wrapped in AssertingCodec.  It seems very unlikely that our default codec sometimes fails to set all live bits.\n\nHave you run a memory tester on your box recently?\n\nMaybe upgrade JVM  "
        },
        {
            "id": "comment-15229029",
            "author": "Steve Rowe",
            "date": "2016-04-06T20:26:31+0000",
            "content": "Have you run a memory tester on your box recently?\n\nI had not, but after you asked I ran two passes of the latest MemTest86 default suite - it took 24 hours! - with zero errors.\n\nMaybe upgrade JVM \n\nGood idea, I've upgraded to the latest. "
        },
        {
            "id": "comment-15253969",
            "author": "Steve Rowe",
            "date": "2016-04-22T13:56:32+0000",
            "content": "Looks like a different kind of failure (it's reproducible), but I'll put it here anyway since it's the same test - found by my Jenkins on branch_6x but repros for me on latest master:\n\n\nChecking out Revision 58852beb8fa87bbfd334e466950154d87ae69913 (refs/remotes/origin/branch_6x)\n[...]\n   [junit4] Suite: org.apache.lucene.search.TestPointQueries\n   [junit4]   2> NOTE: download the large Jenkins line-docs file by running 'ant get-jenkins-line-docs' in the lucene directory.\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestPointQueries -Dtests.method=testRandomBinaryMedium -Dtests.seed=D63A0E9EFDF8E506 -Dtests.slow=true -Dtests.linedocsfile=/home/jenkins/lucene-data/enwiki.random.lines.txt -Dtests.locale=ru -Dtests.timezone=Asia/Macau -Dtests.asserts=true -Dtests.file.encoding=US-ASCII\n   [junit4] ERROR   0.08s J0 | TestPointQueries.testRandomBinaryMedium <<<\n   [junit4]    > Throwable #1: java.lang.IllegalArgumentException: maxMBSortInHeap=4.154991536139355 only allows for maxPointsSortInHeap=1945, but this is less than maxPointsInLeafNode=1947; either increase maxMBSortInHeap or decrease maxPointsInLeafNode\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([D63A0E9EFDF8E506:A11789DE295490D1]:0)\n   [junit4]    > \tat org.apache.lucene.util.bkd.BKDWriter.<init>(BKDWriter.java:209)\n   [junit4]    > \tat org.apache.lucene.index.RandomCodec$RandomlySplittingBKDWriter.<init>(RandomCodec.java:280)\n   [junit4]    > \tat org.apache.lucene.index.RandomCodec$1$1.writeField(RandomCodec.java:124)\n   [junit4]    > \tat org.apache.lucene.codecs.asserting.AssertingPointsFormat$AssertingPointsWriter.writeField(AssertingPointsFormat.java:257)\n   [junit4]    > \tat org.apache.lucene.index.PointValuesWriter.flush(PointValuesWriter.java:71)\n   [junit4]    > \tat org.apache.lucene.index.DefaultIndexingChain.writePoints(DefaultIndexingChain.java:172)\n   [junit4]    > \tat org.apache.lucene.index.DefaultIndexingChain.flush(DefaultIndexingChain.java:107)\n   [junit4]    > \tat org.apache.lucene.index.DocumentsWriterPerThread.flush(DocumentsWriterPerThread.java:423)\n   [junit4]    > \tat org.apache.lucene.index.DocumentsWriter.doFlush(DocumentsWriter.java:502)\n   [junit4]    > \tat org.apache.lucene.index.DocumentsWriter.postUpdate(DocumentsWriter.java:376)\n   [junit4]    > \tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:466)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1492)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1271)\n   [junit4]    > \tat org.apache.lucene.index.RandomIndexWriter.addDocument(RandomIndexWriter.java:170)\n   [junit4]    > \tat org.apache.lucene.search.TestPointQueries.verifyBinary(TestPointQueries.java:700)\n   [junit4]    > \tat org.apache.lucene.search.TestPointQueries.doTestRandomBinary(TestPointQueries.java:645)\n   [junit4]    > \tat org.apache.lucene.search.TestPointQueries.testRandomBinaryMedium(TestPointQueries.java:605)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:745)\n   [junit4] IGNOR/A 0.04s J0 | TestPointQueries.testRandomBinaryBig\n   [junit4]    > Assumption #1: 'nightly' test group is disabled (@Nightly())\n   [junit4] IGNOR/A 0.00s J0 | TestPointQueries.testRandomLongsBig\n   [junit4]    > Assumption #1: 'nightly' test group is disabled (@Nightly())\n   [junit4]   2> NOTE: leaving temporary files on disk at: /var/lib/jenkins/jobs/Lucene-Solr-tests-6.x/workspace/lucene/build/core/test/J0/temp/lucene.search.TestPointQueries_D63A0E9EFDF8E506-001\n   [junit4]   2> NOTE: test params are: codec=Asserting(Lucene60): {id=PostingsFormat(name=Direct)}, docValues:{id=DocValuesFormat(name=Memory), value=DocValuesFormat(name=Lucene54)}, maxPointsInLeafNode=1947, maxMBSortInHeap=4.154991536139355, sim=RandomSimilarity(queryNorm=false,coord=crazy): {}, locale=ru, timezone=Asia/Macau\n   [junit4]   2> NOTE: Linux 4.1.0-custom2-amd64 amd64/Oracle Corporation 1.8.0_77 (64-bit)/cpus=16,threads=1,free=208978928,total=327680000\n   [junit4]   2> NOTE: All tests run in this JVM: [TestPhrasePrefixQuery, TestSumDocFreq, TestIndexSearcher, TestForceMergeForever, TestNumericUtils, TestPackedInts, TestGeoUtils, TestDuelingCodecs, TestCodecUtil, TestSpanExplanations, TestAtomicUpdate, TestTermsEnum2, TestNot, TestUsageTrackingFilterCachingPolicy, TestIntBlockPool, TestExceedMaxTermLength, TestSimpleFSLockFactory, TestNumericRangeQuery64, TestStressIndexing, TestPayloads, TestAllFilesHaveCodecHeader, TestBinaryTerms, TestSpanMultiTermQueryWrapper, TestHugeRamFile, TestFixedLengthBytesRefArray, TestOrdinalMap, TestConjunctions, TestMultiTermQueryRewrites, TestCrashCausesCorruptIndex, TestCachingTokenFilter, TestManyFields, TestCustomNorms, TestPointQueries]\n   [junit4] Completed [80/418 (1!)] on J0 in 12.68s, 45 tests, 1 error, 2 skipped <<< FAILURES!\n\n "
        },
        {
            "id": "comment-15255544",
            "author": "ASF subversion and git services",
            "date": "2016-04-24T09:55:50+0000",
            "content": "Commit 7acf8babae2401300a5844ebd10da2219c99dd40 in lucene-solr's branch refs/heads/master from Mike McCandless\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7acf8ba ]\n\nLUCENE-7175: give enough heap for large dim count, bytes per dim, when writing points "
        },
        {
            "id": "comment-15255545",
            "author": "ASF subversion and git services",
            "date": "2016-04-24T09:57:04+0000",
            "content": "Commit e84231197b84b7e65fffa6a1d10eb810cf5d9c89 in lucene-solr's branch refs/heads/branch_6x from Mike McCandless\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=e842311 ]\n\nLUCENE-7175: give enough heap for large dim count, bytes per dim, when writing points "
        },
        {
            "id": "comment-15255546",
            "author": "ASF subversion and git services",
            "date": "2016-04-24T09:57:35+0000",
            "content": "Commit d1a4cca955d7fc790fa089770f63c24c39062eb6 in lucene-solr's branch refs/heads/branch_6_0 from Mike McCandless\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d1a4cca ]\n\nLUCENE-7175: give enough heap for large dim count, bytes per dim, when writing points "
        },
        {
            "id": "comment-15255547",
            "author": "Michael McCandless",
            "date": "2016-04-24T09:57:59+0000",
            "content": "I pushed a fix for that last silly failure ... test was picking high dim count, high bytes per dim, and low allowed MB for in-heap sorting. "
        }
    ]
}