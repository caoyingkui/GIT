{
    "id": "SOLR-7198",
    "title": "Deleting a collection during leader election results in left over znodes in ZK",
    "details": {
        "components": [
            "SolrCloud"
        ],
        "type": "Bug",
        "labels": "",
        "fix_versions": [],
        "affect_versions": "4.10.3",
        "status": "Open",
        "resolution": "Unresolved",
        "priority": "Major"
    },
    "description": "I am seeing this issue while trying to run a collection delete operation in the middle of leader election process.\n\nContents of ZK (after issuing collection delete and waiting for some time)\n\n  /\n    /aliases.json\n    /clusterstate.json\n    /collections\n      SolrUpgrade_collection\n        leaders\n           shard2_1\n    /configs\n    /live_nodes\n    /overseer\n    /overseer_elect\n    /solr\n    /solr.xml\n\nContents of znode shard2_1:\n\nversion0\naversion0\nchildren_count0\nctimeThu Mar 05 22:05:28 PST 2015 (1425621928169)\ncversion0\nczxid22815\nephemeralOwner93427899815755800\nmtimeThu Mar 05 22:05:28 PST 2015 (1425621928169)\nmzxid22815\npzxid22815\ndataLength194\n{\n  \"core\":\"SolrUpgrade_collection_shard2_1_replica2\",\n  \"node_name\":\"search-testing-c5-ha-1.vpc.cloudera.com:8983_solr\",\n  \"base_url\":\"http://search-testing-c5-ha-1.vpc.cloudera.com:8983/solr\"\n}\n\n\n\nClusterstate.json before running a delete collection\n\n{\n  \"shards\":{\n    \"shard1\":{\n      \"range\":\"80000000-ffffffff\",\n      \"state\":\"active\",\n      \"replicas\":{\n        \"core_node1\":{\n          \"state\":\"active\",\n          \"core\":\"SolrUpgrade_collection_shard1_replica2\",\n          \"node_name\":\"search-testing-c5-ha-4.vpc.cloudera.com:8983_solr\",\n          \"base_url\":\"http://search-testing-c5-ha-4.vpc.cloudera.com:8983/solr\",\n          \"leader\":\"true\"},\n        \"core_node2\":{\n          \"state\":\"active\",\n          \"core\":\"SolrUpgrade_collection_shard1_replica1\",\n          \"node_name\":\"search-testing-c5-ha-2.vpc.cloudera.com:8983_solr\",\n          \"base_url\":\"http://search-testing-c5-ha-2.vpc.cloudera.com:8983/solr\"}}},\n    \"shard2_0\":{\n      \"range\":\"0-3fffffff\",\n      \"state\":\"active\",\n      \"replicas\":{\n        \"core_node5\":{\n          \"state\":\"active\",\n          \"core\":\"SolrUpgrade_collection_shard2_0_replica1\",\n          \"node_name\":\"search-testing-c5-ha-3.vpc.cloudera.com:8983_solr\",\n          \"base_url\":\"http://search-testing-c5-ha-3.vpc.cloudera.com:8983/solr\",\n          \"leader\":\"true\"},\n        \"core_node7\":{\n          \"state\":\"active\",\n          \"core\":\"SolrUpgrade_collection_shard2_0_replica2\",\n          \"node_name\":\"search-testing-c5-ha-4.vpc.cloudera.com:8983_solr\",\n          \"base_url\":\"http://search-testing-c5-ha-4.vpc.cloudera.com:8983/solr\"}}},\n    \"shard2_1\":{\n      \"range\":\"40000000-7fffffff\",\n      \"state\":\"active\",\n      \"replicas\":{\n        \"core_node8\":{\n          \"state\":\"active\",\n          \"core\":\"SolrUpgrade_collection_shard2_1_replica2\",\n          \"node_name\":\"search-testing-c5-ha-1.vpc.cloudera.com:8983_solr\",\n          \"base_url\":\"http://search-testing-c5-ha-1.vpc.cloudera.com:8983/solr\"},\n        \"core_node9\":{\n          \"state\":\"active\",\n          \"core\":\"SolrUpgrade_collection_shard2_1_replica3\",\n          \"node_name\":\"search-testing-c5-ha-1.vpc.cloudera.com:8983_solr\",\n          \"base_url\":\"http://search-testing-c5-ha-1.vpc.cloudera.com:8983/solr\"}}}},\n  \"maxShardsPerNode\":\"10\",\n  \"router\":\"compositeId\",\n  \"replicationFactor\":\"2\",\n  \"autoAddReplicas\":\"false\",\n  \"routerSpec\":{\"name\":\"compositeId\"}}}\n\n\n\nAs we can notice, shard (shard2_1) doesn't have any leader and i can see from the logs that the replicas of the shard just started the leader election process. And here are the Solr logs from one of the above replicas which eventually becomes the leader and registers in ZK even though the collection was deleted.\n\n2015-03-05 22:05:25,383 INFO org.apache.solr.cloud.ShardLeaderElectionContext: Running the leader process for shard shard2_1\n2015-03-05 22:05:25,387 INFO org.apache.solr.cloud.ShardLeaderElectionContext: Checking if I (core=SolrUpgrade_collection_shard2_1_replica2,coreNodeName=core_node8) should try and be the leader.\n2015-03-05 22:05:25,387 INFO org.apache.solr.cloud.ShardLeaderElectionContext: My last published State was Active, it's okay to be the leader.\n2015-03-05 22:05:25,387 INFO org.apache.solr.cloud.ShardLeaderElectionContext: I may be the new leader - try and sync\n2015-03-05 22:05:25,506 INFO org.apache.solr.common.cloud.ZkStateReader: A cluster state change: WatchedEvent state:SyncConnected type:NodeDataChanged path:/clusterstate.json, has occurred - updating... (live nodes size: 4)\n2015-03-05 22:05:25,620 INFO org.apache.solr.core.SolrCore.Request: [SolrUpgrade_collection_shard2_1_replica2] webapp=/solr path=/select params={q=*:*&distrib=false&wt=javabin&version=2} hits=118 status=0 QTime=1 \n2015-03-05 22:05:25,623 INFO org.apache.solr.core.SolrCore.Request: [SolrUpgrade_collection_shard2_1_replica3] webapp=/solr path=/select params={q=*:*&distrib=false&wt=javabin&version=2} hits=118 status=0 QTime=0 \n2015-03-05 22:05:27,392 INFO org.apache.solr.cloud.ElectionContext: canceling election /collections/SolrUpgrade_collection/leader_elect/shard2_1/election/93427899815755803-core_node8-n_0000000001\n2015-03-05 22:05:27,393 INFO org.apache.solr.core.SolrCore: [SolrUpgrade_collection_shard2_1_replica3]  CLOSING SolrCore org.apache.solr.core.SolrCore@559b52d3\n2015-03-05 22:05:27,393 INFO org.apache.solr.update.UpdateHandler: closing DirectUpdateHandler2{commits=0,autocommit maxTime=60000ms,autocommits=0,soft autocommit maxTime=1000ms,soft autocommits=0,optimizes=0,rollbacks=0,expungeDeletes=0,docsPending=0,adds=0,deletesById=0,deletesByQuery=0,errors=0,cumulative_adds=0,cumulative_deletesById=0,cumulative_deletesByQuery=0,cumulative_errors=0,transaction_logs_total_size=0,transaction_logs_total_number=0}\n2015-03-05 22:05:27,394 INFO org.apache.solr.update.SolrCoreState: Closing SolrCoreState\n2015-03-05 22:05:27,394 INFO org.apache.solr.update.DefaultSolrCoreState: SolrCoreState ref count has reached 0 - closing IndexWriter\n2015-03-05 22:05:27,394 INFO org.apache.solr.update.DefaultSolrCoreState: closing IndexWriter with IndexWriterCloser\n2015-03-05 22:05:27,397 INFO org.apache.solr.servlet.SolrDispatchFilter: [admin] webapp=null path=/admin/cores params={deleteInstanceDir=true&action=UNLOAD&core=SolrUpgrade_collection_shard2_1_replica2&wt=javabin&qt=/admin/cores&deleteDataDir=true&version=2} status=0 QTime=5 \n2015-03-05 22:05:27,399 INFO org.apache.solr.cloud.ShardLeaderElectionContext: Running the leader process for shard shard2_1\n2015-03-05 22:05:27,399 INFO org.apache.solr.cloud.ElectionContext: canceling election /collections/SolrUpgrade_collection/leader_elect/shard2_1/election/93427899815755803-core_node9-n_0000000002\n2015-03-05 22:05:27,400 WARN org.apache.solr.cloud.LeaderElector: \norg.apache.solr.common.SolrException: SolrCore not found:SolrUpgrade_collection_shard2_1_replica3 in []\n\tat org.apache.solr.cloud.ShardLeaderElectionContext.runLeaderProcess(ElectionContext.java:211)\n\tat org.apache.solr.cloud.LeaderElector.runIamLeaderProcess(LeaderElector.java:163)\n\tat org.apache.solr.cloud.LeaderElector.checkIfIamLeader(LeaderElector.java:125)\n\tat org.apache.solr.cloud.LeaderElector.access$200(LeaderElector.java:55)\n\tat org.apache.solr.cloud.LeaderElector$ElectionWatcher.process(LeaderElector.java:358)\n\tat org.apache.solr.common.cloud.SolrZkClient$3$1.run(SolrZkClient.java:273)\n\tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:262)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:745)\n2015-03-05 22:05:27,415 INFO org.apache.solr.core.SolrCore: [SolrUpgrade_collection_shard2_1_replica3] Closing main searcher on request.\n2015-03-05 22:05:27,438 INFO org.apache.solr.common.cloud.ZkStateReader: A cluster state change: WatchedEvent state:SyncConnected type:NodeDataChanged path:/clusterstate.json, has occurred - updating... (live nodes size: 4)\n2015-03-05 22:05:27,456 INFO org.apache.solr.core.CachingDirectoryFactory: Closing HdfsDirectoryFactory - 2 directories currently being tracked\n2015-03-05 22:05:27,457 INFO org.apache.solr.core.CachingDirectoryFactory: looking to close hdfs://ns1/solr/SolrUpgrade_collection/core_node9/data/index [CachedDir<<refCount=0;path=hdfs://ns1/solr/SolrUpgrade_collection/core_node9/data/index;done=false>>]\n2015-03-05 22:05:27,457 INFO org.apache.solr.core.CachingDirectoryFactory: Closing directory: hdfs://ns1/solr/SolrUpgrade_collection/core_node9/data/index\n2015-03-05 22:05:27,470 INFO org.apache.solr.store.hdfs.HdfsDirectory: Closing hdfs directory hdfs://ns1/solr/SolrUpgrade_collection/core_node9/data/index\n2015-03-05 22:05:27,470 INFO org.apache.solr.core.CachingDirectoryFactory: looking to close hdfs://ns1/solr/SolrUpgrade_collection/core_node9/data [CachedDir<<refCount=0;path=hdfs://ns1/solr/SolrUpgrade_collection/core_node9/data;done=false>>]\n2015-03-05 22:05:27,470 INFO org.apache.solr.core.CachingDirectoryFactory: Closing directory: hdfs://ns1/solr/SolrUpgrade_collection/core_node9/data\n2015-03-05 22:05:27,470 INFO org.apache.solr.store.hdfs.HdfsDirectory: Closing hdfs directory hdfs://ns1/solr/SolrUpgrade_collection/core_node9/data\n2015-03-05 22:05:27,471 INFO org.apache.solr.core.CachingDirectoryFactory: Removing directory after core close: hdfs://ns1/solr/SolrUpgrade_collection/core_node9/data\n2015-03-05 22:05:27,490 INFO org.apache.solr.cloud.ElectionContext: canceling election /collections/SolrUpgrade_collection/leader_elect/shard2_1/election/93427899815755803-core_node9-n_0000000002\n2015-03-05 22:05:27,491 WARN org.apache.solr.cloud.ElectionContext: cancelElection did not find election node to remove /collections/SolrUpgrade_collection/leader_elect/shard2_1/election/93427899815755803-core_node9-n_0000000002\n2015-03-05 22:05:27,493 INFO org.apache.solr.servlet.SolrDispatchFilter: [admin] webapp=null path=/admin/cores params={deleteInstanceDir=true&action=UNLOAD&core=SolrUpgrade_collection_shard2_1_replica3&wt=javabin&qt=/admin/cores&deleteDataDir=true&version=2} status=0 QTime=100 \n2015-03-05 22:05:27,741 INFO org.apache.solr.common.cloud.ZkStateReader: A cluster state change: WatchedEvent state:SyncConnected type:NodeDataChanged path:/clusterstate.json, has occurred - updating... (live nodes size: 4)\n2015-03-05 22:05:27,888 INFO org.apache.solr.cloud.SyncStrategy: Sync replicas to http://search-testing-c5-ha-1.vpc.cloudera.com:8983/solr/SolrUpgrade_collection_shard2_1_replica2/\n2015-03-05 22:05:27,888 ERROR org.apache.solr.cloud.SyncStrategy: Sync Failed:org.apache.solr.common.cloud.ZooKeeperException: Could not find collection in zk: SolrUpgrade_collection []\n\tat org.apache.solr.common.cloud.ZkStateReader.getReplicaProps(ZkStateReader.java:600)\n\tat org.apache.solr.common.cloud.ZkStateReader.getReplicaProps(ZkStateReader.java:588)\n\tat org.apache.solr.common.cloud.ZkStateReader.getReplicaProps(ZkStateReader.java:583)\n\tat org.apache.solr.cloud.SyncStrategy.syncWithReplicas(SyncStrategy.java:152)\n\tat org.apache.solr.cloud.SyncStrategy.syncReplicas(SyncStrategy.java:122)\n\tat org.apache.solr.cloud.SyncStrategy.sync(SyncStrategy.java:101)\n\tat org.apache.solr.cloud.ShardLeaderElectionContext.runLeaderProcess(ElectionContext.java:267)\n\tat org.apache.solr.cloud.LeaderElector.runIamLeaderProcess(LeaderElector.java:163)\n\tat org.apache.solr.cloud.LeaderElector.checkIfIamLeader(LeaderElector.java:125)\n\tat org.apache.solr.cloud.LeaderElector.access$200(LeaderElector.java:55)\n\tat org.apache.solr.cloud.LeaderElector$ElectionWatcher.process(LeaderElector.java:358)\n\tat org.apache.solr.common.cloud.SolrZkClient$3$1.run(SolrZkClient.java:273)\n\tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:262)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:745)\n\n2015-03-05 22:05:27,888 INFO org.apache.solr.cloud.SyncStrategy: Leader's attempt to sync with shard failed, moving to the next candidate\n2015-03-05 22:05:27,888 INFO org.apache.solr.cloud.ShardLeaderElectionContext: We failed sync, but we have no versions - we can't sync in that case - we were active before, so become leader anyway\n2015-03-05 22:05:27,888 INFO org.apache.solr.cloud.ShardLeaderElectionContext: I am the new leader: http://search-testing-c5-ha-1.vpc.cloudera.com:8983/solr/SolrUpgrade_collection_shard2_1_replica2/ shard2_1\n2015-03-05 22:05:27,888 INFO org.apache.solr.core.SolrCore: [SolrUpgrade_collection_shard2_1_replica2]  CLOSING SolrCore org.apache.solr.core.SolrCore@595167\n2015-03-05 22:05:27,889 INFO org.apache.solr.update.UpdateHandler: closing DirectUpdateHandler2{commits=1,autocommit maxTime=60000ms,autocommits=0,soft autocommit maxTime=1000ms,soft autocommits=0,optimizes=0,rollbacks=0,expungeDeletes=0,docsPending=0,adds=0,deletesById=0,deletesByQuery=0,errors=0,cumulative_adds=0,cumulative_deletesById=0,cumulative_deletesByQuery=0,cumulative_errors=0,transaction_logs_total_size=0,transaction_logs_total_number=0}\n2015-03-05 22:05:27,890 INFO org.apache.solr.update.SolrCoreState: Closing SolrCoreState\n2015-03-05 22:05:27,890 INFO org.apache.solr.update.DefaultSolrCoreState: SolrCoreState ref count has reached 0 - closing IndexWriter\n2015-03-05 22:05:27,890 INFO org.apache.solr.update.DefaultSolrCoreState: closing IndexWriter with IndexWriterCloser\n2015-03-05 22:05:27,905 INFO org.apache.solr.core.SolrCore: [SolrUpgrade_collection_shard2_1_replica2] Closing main searcher on request.\n2015-03-05 22:05:27,911 INFO org.apache.solr.core.CachingDirectoryFactory: Closing HdfsDirectoryFactory - 2 directories currently being tracked\n2015-03-05 22:05:27,912 INFO org.apache.solr.core.CachingDirectoryFactory: looking to close hdfs://ns1/solr/SolrUpgrade_collection/core_node8/data/index [CachedDir<<refCount=0;path=hdfs://ns1/solr/SolrUpgrade_collection/core_node8/data/index;done=false>>]\n2015-03-05 22:05:27,912 INFO org.apache.solr.core.CachingDirectoryFactory: Closing directory: hdfs://ns1/solr/SolrUpgrade_collection/core_node8/data/index\n2015-03-05 22:05:27,924 INFO org.apache.solr.store.hdfs.HdfsDirectory: Closing hdfs directory hdfs://ns1/solr/SolrUpgrade_collection/core_node8/data/index\n2015-03-05 22:05:27,924 INFO org.apache.solr.core.CachingDirectoryFactory: looking to close hdfs://ns1/solr/SolrUpgrade_collection/core_node8/data [CachedDir<<refCount=0;path=hdfs://ns1/solr/SolrUpgrade_collection/core_node8/data;done=false>>]\n2015-03-05 22:05:27,924 INFO org.apache.solr.core.CachingDirectoryFactory: Closing directory: hdfs://ns1/solr/SolrUpgrade_collection/core_node8/data\n2015-03-05 22:05:27,925 INFO org.apache.solr.store.hdfs.HdfsDirectory: Closing hdfs directory hdfs://ns1/solr/SolrUpgrade_collection/core_node8/data\n2015-03-05 22:05:28,026 INFO org.apache.solr.core.CachingDirectoryFactory: Removing directory after core close: hdfs://ns1/solr/SolrUpgrade_collection/core_node8/data\n2015-03-05 22:05:28,155 INFO org.apache.solr.common.cloud.SolrZkClient: makePath: /collections/SolrUpgrade_collection/leaders/shard2_1\n2015-03-05 22:05:28,287 INFO org.apache.solr.common.cloud.ZkStateReader: A cluster state change: WatchedEvent state:SyncConnected type:NodeDataChanged path:/clusterstate.json, has occurred - updating... (live nodes size: 4)\n\n\n\n\nThis might be because of a missing check at line\n https://github.com/apache/lucene-solr/blob/372e8448021d00d3466b45da8a6e57736354eee8/solr/core/src/java/org/apache/solr/cloud/ElectionContext.java#L138\nAs the makePath creates all the missing directories recursively.\n\nMay be we can check whether the collection znode exists before we create the leader znode? Thoughts?",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2015-03-06T19:00:38+0000",
            "author": "Gregory Chanan",
            "content": "https://github.com/apache/lucene-solr/blob/lucene_solr_4_10/solr/core/src/java/org/apache/solr/cloud/ElectionContext.java#L138\n\nVamsee Yarlagadda a quick tip: when you are on a page like this, press \"y\" to bring up the actual revision, i.e. https://github.com/apache/lucene-solr/blob/372e8448021d00d3466b45da8a6e57736354eee8/solr/core/src/java/org/apache/solr/cloud/ElectionContext.java#L138\n\nthat way the page will be static and won't change from under you. ",
            "id": "comment-14350722"
        },
        {
            "date": "2015-03-06T19:04:53+0000",
            "author": "Vamsee Yarlagadda",
            "content": "Thanks for highlighting this. I will update the description to reflect this. ",
            "id": "comment-14350730"
        },
        {
            "date": "2015-11-17T00:58:00+0000",
            "author": "Gregory Chanan",
            "content": "I was able to reproduce this by adding some timeouts in various places.  It looks like in 4.10.3 this prevents a collection with that name from being created; on trunk you can still create a collection, although this isn't great because it leaves extra unnecessary data in ZK. ",
            "id": "comment-15007731"
        },
        {
            "date": "2015-11-18T21:30:01+0000",
            "author": "Mark Miller",
            "content": "May be we can check whether the collection znode exists before we create the leader znode? Thoughts?\n\nYeah, perhaps we can use a zk multi call and only create if the main collection node exists. ",
            "id": "comment-15012022"
        }
    ]
}