{
    "id": "LUCENE-4111",
    "title": "More spinning/endless loop problems with random regex in org.apache.lucene.analysis.pattern.TestPatternReplaceCharFilter.testRandomStrings",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [
            "modules/analysis"
        ],
        "type": "Bug",
        "fix_versions": [
            "4.0-ALPHA",
            "6.0"
        ],
        "affect_versions": "4.0-ALPHA",
        "resolution": "Fixed",
        "status": "Closed"
    },
    "description": "The Linux Jenkins server (and also the windows one while I was on vacation) were hanging almost infinite:\n\nStack trace (including seeks):\n\nFull thread dump Java HotSpot(TM) 64-Bit Server VM (20.7-b02 mixed mode):\n\n\"TEST-TestScope-org.apache.lucene.analysis.pattern.TestPatternReplaceCharFilter.testRandomStrings-seed#[A1E6315575F637C6]\" prio=6 ti\nd=0x0000000006cda000 nid=0x1e34 runnable [0x0000000006bab000]\n   java.lang.Thread.State: RUNNABLE\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$CharProperty.match(Pattern.java:3345)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$CharProperty.match(Pattern.java:3345)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$Curly.match0(Pattern.java:3789)\n        at java.util.regex.Pattern$Curly.match(Pattern.java:3744)\n        at java.util.regex.Pattern$Ques.match(Pattern.java:3691)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$CharProperty.match(Pattern.java:3345)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$CharProperty.match(Pattern.java:3345)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$Curly.match0(Pattern.java:3789)\n        at java.util.regex.Pattern$Curly.match(Pattern.java:3744)\n        at java.util.regex.Pattern$Ques.match(Pattern.java:3691)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$CharProperty.match(Pattern.java:3345)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$CharProperty.match(Pattern.java:3345)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$Curly.match0(Pattern.java:3789)\n        at java.util.regex.Pattern$Curly.match(Pattern.java:3744)\n        at java.util.regex.Pattern$Ques.match(Pattern.java:3691)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$Curly.match0(Pattern.java:3789)\n        at java.util.regex.Pattern$Curly.match(Pattern.java:3744)\n        at java.util.regex.Pattern$Ques.match(Pattern.java:3691)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$Curly.match0(Pattern.java:3789)\n        at java.util.regex.Pattern$Curly.match(Pattern.java:3744)\n        at java.util.regex.Pattern$Ques.match(Pattern.java:3691)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$Curly.match0(Pattern.java:3789)\n        at java.util.regex.Pattern$Curly.match(Pattern.java:3744)\n        at java.util.regex.Pattern$Ques.match(Pattern.java:3691)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$Curly.match0(Pattern.java:3789)\n        at java.util.regex.Pattern$Curly.match(Pattern.java:3744)\n        at java.util.regex.Pattern$Ques.match(Pattern.java:3691)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$Curly.match0(Pattern.java:3789)\n        at java.util.regex.Pattern$Curly.match(Pattern.java:3744)\n        at java.util.regex.Pattern$Ques.match(Pattern.java:3691)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$Curly.match0(Pattern.java:3789)\n        at java.util.regex.Pattern$Curly.match(Pattern.java:3744)\n        at java.util.regex.Pattern$Ques.match(Pattern.java:3691)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$Curly.match0(Pattern.java:3789)\n        at java.util.regex.Pattern$Curly.match(Pattern.java:3744)\n        at java.util.regex.Pattern$Ques.match(Pattern.java:3691)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$CharProperty.match(Pattern.java:3345)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$CharProperty.match(Pattern.java:3345)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$CharProperty.match(Pattern.java:3345)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$Curly.match0(Pattern.java:3789)\n        at java.util.regex.Pattern$Curly.match(Pattern.java:3744)\n        at java.util.regex.Pattern$Ques.match(Pattern.java:3691)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.match(Pattern.java:4357)\n        at java.util.regex.Pattern$GroupTail.match(Pattern.java:4227)\n        at java.util.regex.Pattern$BranchConn.match(Pattern.java:4078)\n        at java.util.regex.Pattern$CharProperty.match(Pattern.java:3345)\n        at java.util.regex.Pattern$Branch.match(Pattern.java:4114)\n        at java.util.regex.Pattern$GroupHead.match(Pattern.java:4168)\n        at java.util.regex.Pattern$LazyLoop.matchInit(Pattern.java:4378)\n        at java.util.regex.Pattern$Prolog.match(Pattern.java:4251)\n        at java.util.regex.Pattern$Start.match(Pattern.java:3055)\n        at java.util.regex.Matcher.search(Matcher.java:1105)\n        at java.util.regex.Matcher.find(Matcher.java:535)\n        at org.apache.lucene.analysis.pattern.PatternReplaceCharFilter.processPattern(PatternReplaceCharFilter.java:92)\n        at org.apache.lucene.analysis.pattern.PatternReplaceCharFilter.read(PatternReplaceCharFilter.java:72)\n        at java.io.Reader.read(Reader.java:104)\n        at org.apache.lucene.analysis.MockTokenizer.readCodePoint(MockTokenizer.java:142)\n        at org.apache.lucene.analysis.MockTokenizer.incrementToken(MockTokenizer.java:109)\n        at org.apache.lucene.analysis.BaseTokenStreamTestCase.checkAnalysisConsistency(BaseTokenStreamTestCase.java:558)\n        at org.apache.lucene.analysis.BaseTokenStreamTestCase.checkRandomData(BaseTokenStreamTestCase.java:488)\n        at org.apache.lucene.analysis.BaseTokenStreamTestCase.checkRandomData(BaseTokenStreamTestCase.java:430)\n        at org.apache.lucene.analysis.BaseTokenStreamTestCase.checkRandomData(BaseTokenStreamTestCase.java:424)\n        at org.apache.lucene.analysis.pattern.TestPatternReplaceCharFilter.testRandomStrings(TestPatternReplaceCharFilter.java:322)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1969)\n        at com.carrotsearch.randomizedtesting.RandomizedRunner.access$1100(RandomizedRunner.java:132)\n        at com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:814)\n        at com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:875)\n        at com.carrotsearch.randomizedtesting.RandomizedRunner$8.evaluate(RandomizedRunner.java:889)\n        at org.apache.lucene.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:50)\n        at org.apache.lucene.util.TestRuleFieldCacheSanity$1.evaluate(TestRuleFieldCacheSanity.java:32)\n        at org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n        at com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n        at org.apache.lucene.util.TestRuleReportUncaughtExceptions$1.evaluate(TestRuleReportUncaughtExceptions.java:68)\n        at org.apache.lucene.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:48)\n        at org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n        at com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:821)\n        at com.carrotsearch.randomizedtesting.RandomizedRunner.access$700(RandomizedRunner.java:132)\n        at com.carrotsearch.randomizedtesting.RandomizedRunner$3$1.run(RandomizedRunner.java:669)\n        at com.carrotsearch.randomizedtesting.RandomizedRunner$3.evaluate(RandomizedRunner.java:695)\n        at com.carrotsearch.randomizedtesting.RandomizedRunner$4.evaluate(RandomizedRunner.java:734)\n        at com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:745)\n        at org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n        at org.apache.lucene.util.TestRuleReportUncaughtExceptions$1.evaluate(TestRuleReportUncaughtExceptions.java:68)\n        at org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:38)\n        at org.apache.lucene.util.TestRuleIcuHack$1.evaluate(TestRuleIcuHack.java:51)\n        at com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n        at org.apache.lucene.util.TestRuleNoInstanceHooksOverrides$1.evaluate(TestRuleNoInstanceHooksOverrides.java:53)\n        at org.apache.lucene.util.TestRuleNoStaticHooksShadowing$1.evaluate(TestRuleNoStaticHooksShadowing.java:52)\n        at org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:36)\n        at org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n        at org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:56)\n        at com.carrotsearch.randomizedtesting.RandomizedRunner.runSuite(RandomizedRunner.java:605)\n        at com.carrotsearch.randomizedtesting.RandomizedRunner.access$400(RandomizedRunner.java:132)\n        at com.carrotsearch.randomizedtesting.RandomizedRunner$2.run(RandomizedRunner.java:551)",
    "attachments": {
        "LUCENE-4111.patch": "https://issues.apache.org/jira/secure/attachment/12531027/LUCENE-4111.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2012-06-05T10:35:07+0000",
            "content": "Another seed, that hung on Windows, Java 7: CD6C0ED0996D1439 ",
            "author": "Uwe Schindler",
            "id": "comment-13289321"
        },
        {
            "date": "2012-06-05T11:27:48+0000",
            "content": "I will check what this is even though it's Robert's evil pattern generator!  ",
            "author": "Dawid Weiss",
            "id": "comment-13289340"
        },
        {
            "date": "2012-06-05T12:47:56+0000",
            "content": "This seed: CD6C0ED0996D1439 corresponds to this pattern/input type:\n\n    Pattern p = Pattern.compile(\"(.|.)+x\");\n    String s = \"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\";\n\n\n\nMaybe we should resign from alternatives? Or constraint *+ operators and use \n{0,n}\n or \n{1,n}\n instead? ",
            "author": "Dawid Weiss",
            "id": "comment-13289375"
        },
        {
            "date": "2012-06-05T12:52:45+0000",
            "content": "Oh, forgot to say \u2013 limiting the size of the input won't help much here because of random patterns that match this:\n\n\n(.|.)+x\n(.|.|.)+x\n(.|.|.|.)+x\n(.|.|.|.|.)+x\n\n\n\nThis doubles search time for constant input so even for super-small inputs you can have very long processing time.\n ",
            "author": "Dawid Weiss",
            "id": "comment-13289381"
        },
        {
            "date": "2012-06-05T13:48:30+0000",
            "content": "this is fucking nuts. I think we should drop the jdk regex support and do our own. I mean this is so broken!  ",
            "author": "Simon Willnauer",
            "id": "comment-13289410"
        },
        {
            "date": "2012-06-05T20:07:28+0000",
            "content": "It isn't broken, these patterns will send any backtracking regexp implementation into (nearly endless) recursion. Russ Cox has a nice article about this here:\n\nhttp://swtch.com/~rsc/regexp/regexp1.html\n\nA super-cool task (for a SoC student?) would be to port re2 library to Java:\nhttp://code.google.com/p/re2/\n\nI don't think there is any alternative implementation in Java that is not backtracking-based and at the same time common feature-complete (the one in brics is simplistic). ",
            "author": "Dawid Weiss",
            "id": "comment-13289676"
        },
        {
            "date": "2012-06-05T22:07:42+0000",
            "content": "Suggested patch to cut on the recursion/backtracking depth. It is still possible that some patterns will be slow, but they shouldn't be infinite-slow (there should be observable progress...). ",
            "author": "Dawid Weiss",
            "id": "comment-13289773"
        },
        {
            "date": "2012-06-05T22:09:28+0000",
            "content": "I take the liberty to commit this one in. If anybody has better suggestions, reiterate on this patch (applied to the trunk/ 4.0). I'll leave the issue open for a while. ",
            "author": "Dawid Weiss",
            "id": "comment-13289774"
        },
        {
            "date": "2012-06-07T12:39:06+0000",
            "content": "Closing. I think it'll be good (for a while). ",
            "author": "Dawid Weiss",
            "id": "comment-13290970"
        },
        {
            "date": "2012-06-07T12:48:17+0000",
            "content": "Thanks! ",
            "author": "Uwe Schindler",
            "id": "comment-13290976"
        },
        {
            "date": "2012-06-07T12:52:07+0000",
            "content": "Don't thank me just yet  Keep grinding those test on your test-and-failure generator machine, it's really useful and appreciated. ",
            "author": "Dawid Weiss",
            "id": "comment-13290981"
        }
    ]
}