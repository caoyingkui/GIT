{
    "id": "SOLR-12814",
    "title": "Metrics history causing \"HttpParser URI is too large >8192\" when many collections",
    "details": {
        "type": "Bug",
        "status": "Resolved",
        "labels": "",
        "fix_versions": [
            "7.5.1",
            "7.6",
            "master (8.0)"
        ],
        "components": [
            "metrics",
            "SolrCloud"
        ],
        "priority": "Major",
        "resolution": "Fixed",
        "affect_versions": "7.5"
    },
    "description": "If you have a lot of collections, like 50 or more, the new metrics page in version 7.5 can't run its queries\u00a0because the default\u00a0solr.jetty.request.header.size and\u00a0solr.jetty.response.header.size values are too small.\n\nIf I up the header values from\u00a08192 to\u00a065536 the commands will work.\n\ncommand to change the defaults:\n\nsed -i 's/\\\"solr.jetty.request.header.size\\\" default=\\\"8192\\\"/\\\"solr.jetty.request.header.size\\\" default=\\\"65536\\\"/g' /opt/solr/server/etc/jetty.xml \nsed -i 's/\\\"solr.jetty.response.header.size\\\" default=\\\"8192\\\"/\\\"solr.jetty.response.header.size\\\" default=\\\"65536\\\"/g' /opt/solr/server/etc/jetty.xml\n\n\nbefore changing the header size log:\u00a0\n\n2018-09-27 13:06:45.434 INFO (qtp534906248-14) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={wt=javabin&version=2&key=solr.jvm:os.processCpuLoad&key=solr.node:CONTAINER.fs.coreRoot.usableSpace&key=solr.jvm:os.systemLoadAverage&key=solr.jvm:memory.heap.used} status=0 QTime=0\n2018-09-27 13:07:45.527 WARN (qtp534906248-17) [ ] o.e.j.h.HttpParser URI is too large >8192\n2018-09-27 13:07:45.530 INFO (qtp534906248-16) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={wt=javabin&version=2&key=solr.jvm:os.processCpuLoad&key=solr.node:CONTAINER.fs.coreRoot.usableSpace&key=solr.jvm:os.systemLoadAverage&key=solr.jvm:memory.heap.used} status=0 QTime=0\n2018-09-27 13:08:45.621 WARN (qtp534906248-20) [ ] o.e.j.h.HttpParser URI is too large >8192\n2018-09-27 13:08:45.625 INFO (qtp534906248-15) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={wt=javabin&version=2&key=solr.jvm:os.processCpuLoad&key=solr.node:CONTAINER.fs.coreRoot.usableSpace&key=solr.jvm:os.systemLoadAverage&key=solr.jvm:memory.heap.used} status=0 QTime=0\n2018-09-27 13:09:45.725 WARN (qtp534906248-20) [ ] o.e.j.h.HttpParser URI is too large >8192\n\n\nAfter changing the header size log:\n\nattached as a file because its very long and ugly\n\nIs it possible to break up this command into batches so that it can run without modifying the header sizes?\u00a0\n\nThanks!\n -Matt",
    "attachments": {
        "longmetricsquery.txt": "https://issues.apache.org/jira/secure/attachment/12941537/longmetricsquery.txt",
        "screencapture-cloud-graph.png": "https://issues.apache.org/jira/secure/attachment/12941587/screencapture-cloud-graph.png",
        "screenshot-debug.png": "https://issues.apache.org/jira/secure/attachment/12941593/screenshot-debug.png",
        "screencapture-nodes-actual-IP.png": "https://issues.apache.org/jira/secure/attachment/12941586/screencapture-nodes-actual-IP.png"
    },
    "issue_links": {},
    "comments": [
        {
            "id": "comment-16630482",
            "content": "...the new metrics page in version 7.5 can't run its queries...\nPlease be more specific on which metrics page your are referring to, and provide steps to reproduce. Is it the \"Cloud->Nodes\" page? ",
            "author": "Jan H\u00f8ydahl",
            "date": "2018-09-27T14:09:04+0000"
        },
        {
            "id": "comment-16630499",
            "content": "Looks like you are talking about the metrics HTTP API. Have you tried to simply POST your request instead of GET? That is a common way to allow huge requests. See e.g. https://superuser.com/questions/149329/what-is-the-curl-command-line-syntax-to-do-a-post-request\u00a0 ",
            "author": "Jan H\u00f8ydahl",
            "date": "2018-09-27T14:13:00+0000"
        },
        {
            "id": "comment-16630552",
            "content": "I started a 7.5.0 cloud example, created 50 collections, and tried two things:\n\n1) /solr/admin/metrics\n2) the \"Cloud->Nodes\" tab in the UI.\n\nThe metrics page worked just fine \u2013 the URL was very short, and that didn't result in additional requests with a long URL.  The Nodes tab did not work, and caused an error in the log about the URI being too large.\n\nI would think that it should be possible for the UI to use POST for the requests on the \"nodes\" tab instead of GET.  This is not within user control, it would have to be done in the code. ",
            "author": "Shawn Heisey",
            "date": "2018-09-27T14:52:17+0000"
        },
        {
            "id": "comment-16630621",
            "content": "I wonder if this is the MetricsHistoryHandler that issues that request? If you simply sit waiting for a minute without invoking the Cloud->Nodes tab at all, you'll get things like this in the log:\n\n2018-09-27 15:32:40.180 DEBUG (MetricsHistoryHandler-12-thread-1) [ \u00a0 ] o.a.h.headers http-outgoing-46 >> GET /solr/admin/metrics?key=solr.core.27.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.47.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.50.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.5.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.38.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.1.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.43.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.35.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.41.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.26.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.3.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.4.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.39.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.20.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.19.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.30.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.32.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.7.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.32.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.9.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.44.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.12.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.29.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.39.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.31.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.27.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.11.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.43.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.15.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.20.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.50.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.44.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.24.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.33.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.15.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.10.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.40.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.45.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.23.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.47.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.43.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.49.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.32.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.42.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.16.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.30.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.3.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.3.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.13.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.12.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.17.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.16.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.49.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.37.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.18.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.15.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.9.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.14.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.24.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.23.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.25.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.28.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.19.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.7.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.2.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.22.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.41.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.27.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.21.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.10.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.31.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.20.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.5.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.21.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.17.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.48.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.1.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.8.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.23.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.17.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.11.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.2.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.37.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.47.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.35.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.6.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.4.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.2.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.44.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.40.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.45.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.42.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.18.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.29.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.33.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.31.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.8.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.1.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.9.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.49.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.22.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.26.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.21.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.7.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.28.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.29.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.22.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.46.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.10.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.14.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.11.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.25.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.30.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.34.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.36.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.13.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.46.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.12.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.33.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.50.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.42.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.41.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.40.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.48.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.28.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.16.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.18.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.46.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.26.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.36.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.6.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.25.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.19.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.38.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.48.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.8.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.13.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.6.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.35.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.34.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.38.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.37.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.36.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.34.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.4.shard1.replica_n1%3AQUERY.%2Fselect.requests&key=solr.core.14.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.39.shard1.replica_n1%3AUPDATE.%2Fupdate.requests&key=solr.core.45.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.5.shard1.replica_n1%3AINDEX.sizeInBytes&key=solr.core.24.shard1.replica_n1%3AINDEX.sizeInBytes&wt=javabin&version=2 HTTP/1.1\n ",
            "author": "Jan H\u00f8ydahl",
            "date": "2018-09-27T15:34:49+0000"
        },
        {
            "id": "comment-16630626",
            "content": "yea, without doing anything i can run\u00a0\"tail -f /var/solr/logs/solr.log\" and just watch for the error to happen.\u00a0\n\nI should clarify that the metrics api works fine but the nodes page is not showing stats correctly just like Shawn Heisey\u00a0said ",
            "author": "matthew medway",
            "date": "2018-09-27T15:39:40+0000"
        },
        {
            "id": "comment-16630655",
            "content": "Hmm, can you detail what stats are wrong in nodes page? Screenshot? I did a quick test with one node and 50 empty collections and all looks normal. Perhaps in a distributed cluster things are different? ",
            "author": "Jan H\u00f8ydahl",
            "date": "2018-09-27T15:54:26+0000"
        },
        {
            "id": "comment-16630665",
            "content": "Hrmm. The nodes page is still working this time, maybe its because i had the bigger headers set earlier today.\u00a0 I am now getting the error about URI being too large again:\n\ncat /var/solr/logs/solr.log | grep -i WARN -B 10 -A 10\n\n--\n2018-09-27 15:58:49.887 INFO (qtp534906248-19) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/info/system params={wt=json&_=1538063896110} status=0 QTime=7\n2018-09-27 15:58:49.902 INFO (qtp534906248-19) [ ] o.a.s.h.a.CollectionsHandler Invoked Collection Action :list with params action=LIST&wt=json&_=1538063896110 and sendToOCPQueue=true\n2018-09-27 15:58:49.902 INFO (qtp534906248-19) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/collections params={action=LIST&wt=json&_=1538063896110} status=0 QTime=0\n2018-09-27 15:58:49.927 INFO (qtp534906248-16) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/collections params={action=CLUSTERSTATUS&wt=json&_=1538063896110} status=0 QTime=41\n2018-09-27 15:58:49.977 INFO (qtp534906248-21) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/info/system params={wt=javabin&version=2&_=1538063896110} status=0 QTime=31\n2018-09-27 15:58:49.978 INFO (qtp534906248-14) [ ] o.a.s.h.a.AdminHandlersProxy Fetched response from 3 nodes: [172.19.1.223:8983_solr, 172.19.7.118:8983_solr, 172.19.0.107:8983_solr]\n2018-09-27 15:58:49.978 INFO (qtp534906248-14) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/info/system params={nodes=172.19.0.107:8983_solr,172.19.1.223:8983_solr,172.19.7.118:8983_solr&wt=json&_=1538063896110} status=0 QTime=36\n2018-09-27 15:58:49.996 INFO (qtp534906248-18) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={prefix=CONTAINER.fs,org.eclipse.jetty.server.handler.DefaultHandler.get-requests,INDEX.sizeInBytes,SEARCHER.searcher.numDocs,SEARCHER.searcher.deletedDocs,SEARCHER.searcher.warmupTime&wt=javabin&version=2&_=1538063896206} status=0 QTime=38\n2018-09-27 15:58:49.998 INFO (qtp534906248-19) [ ] o.a.s.h.a.AdminHandlersProxy Fetched response from 3 nodes: [172.19.1.223:8983_solr, 172.19.7.118:8983_solr, 172.19.0.107:8983_solr]\n2018-09-27 15:58:49.998 INFO (qtp534906248-19) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={nodes=172.19.0.107:8983_solr,172.19.1.223:8983_solr,172.19.7.118:8983_solr&prefix=CONTAINER.fs,org.eclipse.jetty.server.handler.DefaultHandler.get-requests,INDEX.sizeInBytes,SEARCHER.searcher.numDocs,SEARCHER.searcher.deletedDocs,SEARCHER.searcher.warmupTime&wt=json&_=1538063896206} status=0 QTime=54\n2018-09-27 15:59:03.747 WARN (qtp534906248-12) [ ] o.e.j.h.HttpParser URI is too large >8192\n2018-09-27 15:59:03.753 INFO (qtp534906248-17) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={wt=javabin&version=2&key=solr.jvm:os.processCpuLoad&key=solr.node:CONTAINER.fs.coreRoot.usableSpace&key=solr.jvm:os.systemLoadAverage&key=solr.jvm:memory.heap.used} status=0 QTime=1\n2018-09-27 16:00:02.130 INFO (qtp534906248-12) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={} status=0 QTime=311\n2018-09-27 16:00:02.206 INFO (qtp534906248-21) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={} status=0 QTime=388\n2018-09-27 16:00:02.230 INFO (qtp534906248-19) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={} status=0 QTime=404\n2018-09-27 16:00:03.856 WARN (qtp534906248-12) [ ] o.e.j.h.HttpParser URI is too large >8192\n2018-09-27 16:00:03.859 INFO (qtp534906248-14) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={wt=javabin&version=2&key=solr.jvm:os.processCpuLoad&key=solr.node:CONTAINER.fs.coreRoot.usableSpace&key=solr.jvm:os.systemLoadAverage&key=solr.jvm:memory.heap.used} status=0 QTime=0\n2018-09-27 16:00:19.599 INFO (qtp534906248-12) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={indexInfo=false&wt=json&_=1538063985822} status=0 QTime=0\n2018-09-27 16:00:19.601 INFO (qtp534906248-17) [ ] o.a.s.h.a.CollectionsHandler Invoked Collection Action :clusterstatus with params action=CLUSTERSTATUS&wt=json&_=1538063985823 and sendToOCPQueue=true\n2018-09-27 16:00:19.612 INFO (qtp534906248-14) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/info/system params={wt=json&_=1538063985823} status=0 QTime=12\n2018-09-27 16:00:19.624 INFO (qtp534906248-18) [ ] o.a.s.h.a.CollectionsHandler Invoked Collection Action :list with params action=LIST&wt=json&_=1538063985823 and sendToOCPQueue=true\n2018-09-27 16:00:19.625 INFO (qtp534906248-18) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/collections params={action=LIST&wt=json&_=1538063985823} status=0 QTime=0\n2018-09-27 16:00:19.659 INFO (qtp534906248-17) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/collections params={action=CLUSTERSTATUS&wt=json&_=1538063985823} status=0 QTime=58\n2018-09-27 16:00:19.702 INFO (qtp534906248-16) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={prefix=CONTAINER.fs,org.eclipse.jetty.server.handler.DefaultHandler.get-requests,INDEX.sizeInBytes,SEARCHER.searcher.numDocs,SEARCHER.searcher.deletedDocs,SEARCHER.searcher.warmupTime&wt=javabin&version=2&_=1538063985922} status=0 QTime=29\n2018-09-27 16:00:19.703 INFO (qtp534906248-18) [ ] o.a.s.h.a.AdminHandlersProxy Fetched response from 3 nodes: [172.19.1.223:8983_solr, 172.19.7.118:8983_solr, 172.19.0.107:8983_solr]\n2018-09-27 16:00:19.703 INFO (qtp534906248-18) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={nodes=172.19.0.107:8983_solr,172.19.1.223:8983_solr,172.19.7.118:8983_solr&prefix=CONTAINER.fs,org.eclipse.jetty.server.handler.DefaultHandler.get-requests,INDEX.sizeInBytes,SEARCHER.searcher.numDocs,SEARCHER.searcher.deletedDocs,SEARCHER.searcher.warmupTime&wt=json&_=1538063985922} status=0 QTime=33\n--\n2018-09-27 16:01:02.752 INFO (qtp534906248-17) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/info/system params={wt=json&_=1538064028971} status=0 QTime=6\n2018-09-27 16:01:02.771 INFO (qtp534906248-17) [ ] o.a.s.h.a.CollectionsHandler Invoked Collection Action :list with params action=LIST&wt=json&_=1538064028971 and sendToOCPQueue=true\n2018-09-27 16:01:02.771 INFO (qtp534906248-17) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/collections params={action=LIST&wt=json&_=1538064028971} status=0 QTime=0\n2018-09-27 16:01:02.798 INFO (qtp534906248-19) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/collections params={action=CLUSTERSTATUS&wt=json&_=1538064028971} status=0 QTime=48\n2018-09-27 16:01:02.841 INFO (qtp534906248-21) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/info/system params={wt=javabin&version=2&_=1538064028971} status=0 QTime=30\n2018-09-27 16:01:02.842 INFO (qtp534906248-15) [ ] o.a.s.h.a.AdminHandlersProxy Fetched response from 3 nodes: [172.19.1.223:8983_solr, 172.19.7.118:8983_solr, 172.19.0.107:8983_solr]\n2018-09-27 16:01:02.842 INFO (qtp534906248-15) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/info/system params={nodes=172.19.0.107:8983_solr,172.19.1.223:8983_solr,172.19.7.118:8983_solr&wt=json&_=1538064028971} status=0 QTime=34\n2018-09-27 16:01:02.851 INFO (qtp534906248-16) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={prefix=CONTAINER.fs,org.eclipse.jetty.server.handler.DefaultHandler.get-requests,INDEX.sizeInBytes,SEARCHER.searcher.numDocs,SEARCHER.searcher.deletedDocs,SEARCHER.searcher.warmupTime&wt=javabin&version=2&_=1538064029069} status=0 QTime=38\n2018-09-27 16:01:02.852 INFO (qtp534906248-17) [ ] o.a.s.h.a.AdminHandlersProxy Fetched response from 3 nodes: [172.19.1.223:8983_solr, 172.19.7.118:8983_solr, 172.19.0.107:8983_solr]\n2018-09-27 16:01:02.852 INFO (qtp534906248-17) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={nodes=172.19.0.107:8983_solr,172.19.1.223:8983_solr,172.19.7.118:8983_solr&prefix=CONTAINER.fs,org.eclipse.jetty.server.handler.DefaultHandler.get-requests,INDEX.sizeInBytes,SEARCHER.searcher.numDocs,SEARCHER.searcher.deletedDocs,SEARCHER.searcher.warmupTime&wt=json&_=1538064029069} status=0 QTime=44\n2018-09-27 16:01:03.962 WARN (qtp534906248-20) [ ] o.e.j.h.HttpParser URI is too large >8192\n2018-09-27 16:01:03.966 INFO (qtp534906248-21) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={wt=javabin&version=2&key=solr.jvm:os.processCpuLoad&key=solr.node:CONTAINER.fs.coreRoot.usableSpace&key=solr.jvm:os.systemLoadAverage&key=solr.jvm:memory.heap.used} status=0 QTime=0\n2018-09-27 16:02:04.071 WARN (qtp534906248-14) [ ] o.e.j.h.HttpParser URI is too large >8192\n2018-09-27 16:02:04.077 INFO (qtp534906248-16) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={wt=javabin&version=2&key=solr.jvm:os.processCpuLoad&key=solr.node:CONTAINER.fs.coreRoot.usableSpace&key=solr.jvm:os.systemLoadAverage&key=solr.jvm:memory.heap.used} status=0 QTime=0\n2018-09-27 16:03:04.181 WARN (qtp534906248-21) [ ] o.e.j.h.HttpParser URI is too large >8192\n2018-09-27 16:03:04.185 INFO (qtp534906248-20) [ ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/metrics params={wt=javabin&version=2&key=solr.jvm:os.processCpuLoad&key=solr.node:CONTAINER.fs.coreRoot.usableSpace&key=solr.jvm:os.systemLoadAverage&key=solr.jvm:memory.heap.used} status=0 QTime=0\n\n\n ",
            "author": "matthew medway",
            "date": "2018-09-27T16:04:32+0000"
        },
        {
            "id": "comment-16630746",
            "content": "Definitely looks like requests from nodes page. Will have a look if we can explicitly do POST for these. The initial request only specifies prefix params but somehow they seem to be translated into a longer list of key params somewhere? ",
            "author": "Jan H\u00f8ydahl",
            "date": "2018-09-27T17:09:57+0000"
        },
        {
            "id": "comment-16630804",
            "content": "Amazing! looking forward to your next update thanks! ",
            "author": "matthew medway",
            "date": "2018-09-27T17:49:30+0000"
        },
        {
            "id": "comment-16630938",
            "content": "Now here's something interesting.\n\nAs I mentioned, I used the cloud example, so everything's on localhost.  Windows 10 Professional, 64-bit.\n\nIf I use \"localhost\" to access the UI, the Nodes tab doesn't work.  But if I use the IP address of my machine, then it DOES work!  That's really strange.\n\n \n\nHere's something showing the collections I created:\n\n   ",
            "author": "Shawn Heisey",
            "date": "2018-09-27T19:25:02+0000"
        },
        {
            "id": "comment-16630945",
            "content": "OK, now I'm REALLY confused.\n\nAfter accessing the URL with the IP address, I tried the localhost URL again, and it worked.  And then I added another 50 collections, and it's STILL working. ",
            "author": "Shawn Heisey",
            "date": "2018-09-27T19:33:30+0000"
        },
        {
            "id": "comment-16630953",
            "content": "The developer console is showing all the requests made to create the page as GET requests, none as POST.  I stopped and restarted the example ... and it is still working.  How's that for frustrating? ",
            "author": "Shawn Heisey",
            "date": "2018-09-27T19:38:22+0000"
        },
        {
            "id": "comment-16630978",
            "content": "Think I found the place where the huge GET request is created\n\nFirst MetricsHistoryHandler wants to collect global metrics:\n\ncollectGlobalMetrics:481, MetricsHistoryHandler ->\ngetReplicaInfo:169, SolrClientNodeStateProvider ->\nfetchReplicaMetrics:186, SolrClientNodeStateProvider ->\nfetchReplicaMetrics:195, SolrClientNodeStateProvider\n\n  params.add(\"key\", metricsKeyVsTag.keySet().toArray(new String[0])); <--- This keyset is huge and overruns the limit\n...\n  SimpleSolrResponse rsp = ctx.invoke(solrNode, CommonParams.METRICS_PATH, params); <--- Invoke the request\n...\n  GenericSolrRequest request = new GenericSolrRequest(SolrRequest.METHOD.GET, path, params); <--- Which uses get\n\nAndrzej Bialecki \u00a0and\u00a0Noble Paul\u00a0you may know this part of the code. Below is screenshot from debug session where you see SolrClientNodeStateProvider class trying to invoke a huge request with 150 metric keys:\n\n ",
            "author": "Jan H\u00f8ydahl",
            "date": "2018-09-27T20:11:47+0000"
        },
        {
            "id": "comment-16636093",
            "content": "Simple solution was to change from GET to POST, see\u00a0GitHub Pull Request #461\n\nTested same way I used to verify the bug, i.e. creating 50 collections locally. With the patch we see that all\u00a0the scheduled metrics history queries every minute succeed.\n\nI plan to commit this on Thursday. If you\u00a0believe this should be fixed in another way, then\u00a0shout out! ",
            "author": "Jan H\u00f8ydahl",
            "date": "2018-10-02T20:45:30+0000"
        },
        {
            "id": "comment-16636097",
            "content": "yay!! ",
            "author": "matthew medway",
            "date": "2018-10-02T20:49:56+0000"
        },
        {
            "id": "comment-16638494",
            "content": "Commit 5fb384c9898176d34fffe2b310a0a815d8aebecb in lucene-solr's branch refs/heads/master from Jan H\u00f8ydahl\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=5fb384c ]\n\nSOLR-12814: Metrics history causing \"HttpParser URI is too large >8192\" when many collections\nThis fixes #461 ",
            "author": "ASF subversion and git services",
            "date": "2018-10-04T16:38:06+0000"
        },
        {
            "id": "comment-16638497",
            "content": "Commit 46a530a04e8ac31265d3bbb2bde264360373c5aa in lucene-solr's branch refs/heads/branch_7x from Jan H\u00f8ydahl\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=46a530a ]\n\nSOLR-12814: Metrics history causing \"HttpParser URI is too large >8192\" when many collections\nThis fixes #461\n\n(cherry picked from commit 5fb384c9898176d34fffe2b310a0a815d8aebecb) ",
            "author": "ASF subversion and git services",
            "date": "2018-10-04T16:39:30+0000"
        },
        {
            "id": "comment-16638500",
            "content": "Commit 2f8cae6c285fc8a756a48a3dc5999775659ce4ae in lucene-solr's branch refs/heads/branch_7_5 from Jan H\u00f8ydahl\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=2f8cae6 ]\n\nSOLR-12814: Metrics history causing \"HttpParser URI is too large >8192\" when many collections\nThis fixes #461\n\n(cherry picked from commit 5fb384c9898176d34fffe2b310a0a815d8aebecb) ",
            "author": "ASF subversion and git services",
            "date": "2018-10-04T16:43:10+0000"
        }
    ]
}