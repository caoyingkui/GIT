{
    "id": "SOLR-6983",
    "title": "SocketExceptions no longer trigger retries when processing distributed updates",
    "details": {
        "components": [
            "SolrCloud"
        ],
        "type": "Bug",
        "labels": "",
        "fix_versions": [],
        "affect_versions": "4.7",
        "status": "Closed",
        "resolution": "Duplicate",
        "priority": "Major"
    },
    "description": "Our production Solr cluster is frequently placing replicas into leader-initiated recovery whenever a \"java.net.SocketException: Connection reset\" is thrown when processing distributed updates.\n\nThis problem surfaced after upgrading from Solr 4.6.1 to Solr 4.10.2. In the old version, a retry was attempted whenever a SocketException was encountered when a leader was updating a replica. After the upgrade to Solr 4.10.2, this retry mechanism no longer occurs.\n\nHere is an example stacktrace:\n\n2015-01-11 09:38:00.913 [updateExecutor-1-thread-35734] ERROR org.apache.solr.update.StreamingSolrServers  \u2013 error\njava.net.SocketException: Connection reset\n        at java.net.SocketInputStream.read(SocketInputStream.java:196)\n        at java.net.SocketInputStream.read(SocketInputStream.java:122)\n        at org.apache.http.impl.io.AbstractSessionInputBuffer.fillBuffer(AbstractSessionInputBuffer.java:160)\n        at org.apache.http.impl.io.SocketInputBuffer.fillBuffer(SocketInputBuffer.java:84)\n        at org.apache.http.impl.io.AbstractSessionInputBuffer.readLine(AbstractSessionInputBuffer.java:273)\n        at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:140)\n        at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:57)\n        at org.apache.http.impl.io.AbstractMessageParser.parse(AbstractMessageParser.java:260)\n        at org.apache.http.impl.AbstractHttpClientConnection.receiveResponseHeader(AbstractHttpClientConnection.java:283)\n        at org.apache.http.impl.conn.DefaultClientConnection.receiveResponseHeader(DefaultClientConnection.java:251)\n        at org.apache.http.impl.conn.ManagedClientConnectionImpl.receiveResponseHeader(ManagedClientConnectionImpl.java:197)\n        at org.apache.http.protocol.HttpRequestExecutor.doReceiveResponse(HttpRequestExecutor.java:271)\n        at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:123)\n        at org.apache.http.impl.client.DefaultRequestDirector.tryExecute(DefaultRequestDirector.java:682)\n        at org.apache.http.impl.client.DefaultRequestDirector.execute(DefaultRequestDirector.java:486)\n        at org.apache.http.impl.client.AbstractHttpClient.doExecute(AbstractHttpClient.java:863)\n        at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:82)\n        at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:106)\n        at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:57)\n        at org.apache.solr.client.solrj.impl.ConcurrentUpdateSolrServer$Runner.run(ConcurrentUpdateSolrServer.java:233)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\n2015-01-11 09:38:00.917 [qtp268575911-3616964] WARN  org.apache.solr.update.processor.DistributedUpdateProcessor  \u2013 Error sending update\njava.net.SocketException: Connection reset\n        at java.net.SocketInputStream.read(SocketInputStream.java:196)\n        at java.net.SocketInputStream.read(SocketInputStream.java:122)\n        at org.apache.http.impl.io.AbstractSessionInputBuffer.fillBuffer(AbstractSessionInputBuffer.java:160)\n        at org.apache.http.impl.io.SocketInputBuffer.fillBuffer(SocketInputBuffer.java:84)\n        at org.apache.http.impl.io.AbstractSessionInputBuffer.readLine(AbstractSessionInputBuffer.java:273)\n        at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:140)\n        at org.apache.http.impl.conn.DefaultHttpResponseParser.parseHead(DefaultHttpResponseParser.java:57)\n        at org.apache.http.impl.io.AbstractMessageParser.parse(AbstractMessageParser.java:260)\n        at org.apache.http.impl.AbstractHttpClientConnection.receiveResponseHeader(AbstractHttpClientConnection.java:283)\n        at org.apache.http.impl.conn.DefaultClientConnection.receiveResponseHeader(DefaultClientConnection.java:251)\n        at org.apache.http.impl.conn.ManagedClientConnectionImpl.receiveResponseHeader(ManagedClientConnectionImpl.java:197)\n        at org.apache.http.protocol.HttpRequestExecutor.doReceiveResponse(HttpRequestExecutor.java:271)\n        at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:123)\n        at org.apache.http.impl.client.DefaultRequestDirector.tryExecute(DefaultRequestDirector.java:682)\n        at org.apache.http.impl.client.DefaultRequestDirector.execute(DefaultRequestDirector.java:486)\n        at org.apache.http.impl.client.AbstractHttpClient.doExecute(AbstractHttpClient.java:863)\n        at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:82)\n        at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:106)\n        at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:57)\n        at org.apache.solr.client.solrj.impl.ConcurrentUpdateSolrServer$Runner.run(ConcurrentUpdateSolrServer.java:233)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\n2015-01-11 09:38:00.958 [qtp268575911-3616964] ERROR org.apache.solr.update.processor.DistributedUpdateProcessor  \u2013 Setting up to try to start recovery on replica http://solr26:8983/solr/listings/ after: java.net.SocketException: Connection reset\n\n\n\nThe underlying SocketException may be related to SOLR-6931 and the disabling of the HttpClient stale connection check.\n\nIt appears that the retry logic was removed from the SolrCommandDistributor starting with 4.7 to address SOLR-5509. See https://svn.apache.org/viewvc/lucene/dev/trunk/solr/core/src/java/org/apache/solr/update/SolrCmdDistributor.java?r1=1546672&r2=1546164&pathrev=1546672\n\nIs there any way the retry logic could be restored for Solr 4.10.x ?",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2015-01-14T23:52:16+0000",
            "author": "Mark Miller",
            "content": "SOLR-6931 is the issue to deal with \"java.net.SocketException: Connection reset\".\n\nWe cannot safely do the particular retries that were removed, which is why they had to be removed. ",
            "id": "comment-14277926"
        }
    ]
}