{
    "id": "SOLR-4851",
    "title": "Highlighter duplicates numeric token in snippet when term vectors/positions/offsets on",
    "details": {
        "affect_versions": "3.6.2",
        "status": "Open",
        "fix_versions": [],
        "components": [
            "highlighter"
        ],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Unresolved"
    },
    "description": "With original text Population 5.000 - 9.999 indexed with termVectors, termPositions and termOffsets, the Highlighter produces snippets like Population 5<em class=\"match\">5.000</em> - 9.999 for a query of 5000. Note the duplicated 5 before the <em; that's the bug.\n\nThis does not happen when useFastVectorHighlighter=true.\n\nIt also does not happen in a field without termVectors, termPositions and termOffsets.\n\nTo reproduce, field definitions:\n\n\n    <fieldType name=\"text\" class=\"solr.TextField\" positionIncrementGap=\"100\">\n      <analyzer type=\"index\">\n        <tokenizer class=\"solr.WhitespaceTokenizerFactory\"/>\n        <filter class=\"solr.SynonymFilterFactory\" synonyms=\"index_synonyms.txt\" ignoreCase=\"true\" expand=\"true\"/>\n        <filter class=\"solr.StopFilterFactory\" ignoreCase=\"true\" words=\"stopwords.txt\"/>\n        <filter class=\"solr.WordDelimiterFilterFactory\" generateWordParts=\"1\" generateNumberParts=\"1\" catenateWords=\"1\" catenateNumbers=\"1\" catenateAll=\"0\" splitOnCaseChange=\"1\" splitOnNumerics=\"0\"/>\n        <filter class=\"solr.LowerCaseFilterFactory\"/>\n        <filter class=\"solr.EnglishPorterFilterFactory\" protected=\"protwords.txt\"/>\n        <filter class=\"solr.RemoveDuplicatesTokenFilterFactory\"/>\n      </analyzer>\n      <analyzer type=\"query\">\n        <tokenizer class=\"solr.WhitespaceTokenizerFactory\"/>\n        <filter class=\"solr.SynonymFilterFactory\" synonyms=\"synonyms.txt\" ignoreCase=\"true\" expand=\"true\"/>\n        <filter class=\"solr.StopFilterFactory\" ignoreCase=\"true\" words=\"stopwords.txt\"/>\n        <filter class=\"solr.WordDelimiterFilterFactory\" generateWordParts=\"1\" generateNumberParts=\"1\" catenateWords=\"0\" catenateNumbers=\"0\" catenateAll=\"0\" splitOnCaseChange=\"1\" splitOnNumerics=\"0\"/>\n        <filter class=\"solr.LowerCaseFilterFactory\"/>\n        <filter class=\"solr.EnglishPorterFilterFactory\" protected=\"protwords.txt\"/>\n        <filter class=\"solr.RemoveDuplicatesTokenFilterFactory\"/>\n      </analyzer>\n    </fieldType>\n\n    ...\n\n    <field name=\"name\" type=\"text\" indexed=\"true\" stored=\"true\" />\n    <field name=\"descr\" type=\"text\" indexed=\"true\" stored=\"true\" termVectors=\"true\" termOffsets=\"true\" termPositions=\"true\" />\n\n\n\nAll configured and explicit parameters, from echoParams=all:\n\n\n{\n\"defType\": \"edismax\",\n\"echoParams\": \"all\",\n\"facet.mincount\": \"1\",\n\"fl\": \"id\",\n\"hl.fl\": \"id name tag cat descr dim dimvalue provider source_source text\",\n\"hl.fragsize\": \"200\",\n\"hl.mergeContiguous\": \"true\",\n\"hl.simple.post\": \"</em>\",\n\"hl.simple.pre\": \"<em class=\"match\">\",\n\"hl.snippets\": \"4\",\n\"hl.usePhraseHighlighter\": \"true\",\n\"hl\": \"true\",\n\"q.alt\": \"*:*\",\n\"q\": \"5000\",\n\"qf\": \" id_a^10.0 name^6 granularity_a^5 tag^4 cat^3 descr^3 dim^2 dimvalue^2 provider^2 source_source^2 text^2 \",\n\"qt\": \"dismax\",\n\"rows\": \"10\",\n\"sort\": \"score desc\"\n}\n\n\n\nand a document containing numbers with thousand separators, e.g.:\n\n\n{\n\"name\": \"Demographics and income: Income distribution: Number of HHs earning > US$5,000 p.a. (constant 2005 prices) by country\"\n\"descr\": \"Number of households with disposable income of more than US$5,000 per annum at constant 2005 prices\"\n}\n\n\n\nThe highlight snippets I get:\n\n\n{\nname: [\n  \"Demographics and income: Income distribution: Number of HHs earning &gt; US$<em class=\"match\">5,000</em> p.a. (constant 2005 prices) by country\"\n],\ndescr: [\n  \"Number of households with disposable income of more than US$5<em class=\"match\">5,000</em> per annum at constant 2005 prices\"\n]\n}\n\n\n\nNote that the 5 gets duplicated only in the descr field snippet, not in the name field snippet. The only difference between these fields is termVectors, termPositions and termOffsets, so those settings are presumably relevant.",
    "attachments": {},
    "issue_links": {},
    "comments": []
}