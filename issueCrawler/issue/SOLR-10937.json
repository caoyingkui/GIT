{
    "id": "SOLR-10937",
    "title": "No space left on device when building suggester index",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [
            "Suggester"
        ],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "6.6",
        "resolution": "Unresolved",
        "status": "Open"
    },
    "description": "On startup, I see the following error in my logs even though the disk has 600GB of free space available (and 3GB on the root filesystem):\n\n\n2017-06-22 08:53:01.862 ERROR (searcherExecutor-8-thread-1-processing-x:kc) [   x:kc] o.a.s.h.c.SuggestComponent Exception in building suggester index for: suggester\njava.io.IOException: No space left on device\n\tat sun.nio.ch.FileDispatcherImpl.write0(Native Method)\n\tat sun.nio.ch.FileDispatcherImpl.write(FileDispatcherImpl.java:60)\n\tat sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:93)\n\tat sun.nio.ch.IOUtil.write(IOUtil.java:65)\n\tat sun.nio.ch.FileChannelImpl.write(FileChannelImpl.java:211)\n\tat java.nio.channels.Channels.writeFullyImpl(Channels.java:78)\n\tat java.nio.channels.Channels.writeFully(Channels.java:101)\n\tat java.nio.channels.Channels.access$000(Channels.java:61)\n\tat java.nio.channels.Channels$1.write(Channels.java:174)\n\tat org.apache.lucene.store.FSDirectory$FSIndexOutput$1.write(FSDirectory.java:419)\n\tat java.util.zip.CheckedOutputStream.write(CheckedOutputStream.java:73)\n\tat java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)\n\tat java.io.BufferedOutputStream.write(BufferedOutputStream.java:126)\n\tat org.apache.lucene.store.OutputStreamIndexOutput.writeBytes(OutputStreamIndexOutput.java:53)\n\tat org.apache.lucene.util.OfflineSorter$ByteSequencesWriter.write(OfflineSorter.java:524)\n\tat org.apache.lucene.util.OfflineSorter$ByteSequencesWriter.write(OfflineSorter.java:499)\n\tat org.apache.lucene.util.OfflineSorter$SortPartitionTask.call(OfflineSorter.java:612)\n\tat org.apache.lucene.util.OfflineSorter$SortPartitionTask.call(OfflineSorter.java:588)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n\tat org.apache.lucene.util.SameThreadExecutorService.execute(SameThreadExecutorService.java:34)\n\tat java.util.concurrent.AbstractExecutorService.submit(AbstractExecutorService.java:134)\n\tat org.apache.lucene.util.OfflineSorter.sort(OfflineSorter.java:285)\n\tat org.apache.lucene.search.suggest.analyzing.AnalyzingSuggester.build(AnalyzingSuggester.java:489)\n\tat org.apache.lucene.search.suggest.Lookup.build(Lookup.java:190)\n\tat org.apache.solr.spelling.suggest.SolrSuggester.build(SolrSuggester.java:181)\n\tat org.apache.solr.handler.component.SuggestComponent$SuggesterListener.buildSuggesterIndex(SuggestComponent.java:524)\n\tat org.apache.solr.handler.component.SuggestComponent$SuggesterListener.newSearcher(SuggestComponent.java:506)\n\tat org.apache.solr.core.SolrCore.lambda$getSearcher$15(SolrCore.java:2249)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n\tat org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:229)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat java.lang.Thread.run(Thread.java:748)\n\tSuppressed: java.io.IOException: No space left on device\n\t\tat sun.nio.ch.FileDispatcherImpl.write0(Native Method)\n\t\tat sun.nio.ch.FileDispatcherImpl.write(FileDispatcherImpl.java:60)\n\t\tat sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:93)\n\t\tat sun.nio.ch.IOUtil.write(IOUtil.java:65)\n\t\tat sun.nio.ch.FileChannelImpl.write(FileChannelImpl.java:211)\n\t\tat java.nio.channels.Channels.writeFullyImpl(Channels.java:78)\n\t\tat java.nio.channels.Channels.writeFully(Channels.java:101)\n\t\tat java.nio.channels.Channels.access$000(Channels.java:61)\n\t\tat java.nio.channels.Channels$1.write(Channels.java:174)\n\t\tat org.apache.lucene.store.FSDirectory$FSIndexOutput$1.write(FSDirectory.java:419)\n\t\tat java.util.zip.CheckedOutputStream.write(CheckedOutputStream.java:73)\n\t\tat java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)\n\t\tat java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140)\n\t\tat org.apache.lucene.store.OutputStreamIndexOutput.close(OutputStreamIndexOutput.java:68)\n\t\tat org.apache.lucene.util.OfflineSorter$ByteSequencesWriter.close(OfflineSorter.java:532)\n\t\tat org.apache.lucene.util.OfflineSorter$SortPartitionTask.call(OfflineSorter.java:622)\n\t\t... 16 more\n\t\tSuppressed: java.io.IOException: No space left on device\n\t\t\tat sun.nio.ch.FileDispatcherImpl.write0(Native Method)\n\t\t\tat sun.nio.ch.FileDispatcherImpl.write(FileDispatcherImpl.java:60)\n\t\t\tat sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:93)\n\t\t\tat sun.nio.ch.IOUtil.write(IOUtil.java:65)\n\t\t\tat sun.nio.ch.FileChannelImpl.write(FileChannelImpl.java:211)\n\t\t\tat java.nio.channels.Channels.writeFullyImpl(Channels.java:78)\n\t\t\tat java.nio.channels.Channels.writeFully(Channels.java:101)\n\t\t\tat java.nio.channels.Channels.access$000(Channels.java:61)\n\t\t\tat java.nio.channels.Channels$1.write(Channels.java:174)\n\t\t\tat org.apache.lucene.store.FSDirectory$FSIndexOutput$1.write(FSDirectory.java:419)\n\t\t\tat java.util.zip.CheckedOutputStream.write(CheckedOutputStream.java:73)\n\t\t\tat java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)\n\t\t\tat java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140)\n\t\t\tat java.io.FilterOutputStream.close(FilterOutputStream.java:158)\n\t\t\tat org.apache.lucene.store.OutputStreamIndexOutput.close(OutputStreamIndexOutput.java:70)\n\t\t\t... 18 more\n\tSuppressed: java.nio.channels.ClosedChannelException\n\t\tat sun.nio.ch.FileChannelImpl.ensureOpen(FileChannelImpl.java:110)\n\t\tat sun.nio.ch.FileChannelImpl.write(FileChannelImpl.java:199)\n\t\tat java.nio.channels.Channels.writeFullyImpl(Channels.java:78)\n\t\tat java.nio.channels.Channels.writeFully(Channels.java:101)\n\t\tat java.nio.channels.Channels.access$000(Channels.java:61)\n\t\tat java.nio.channels.Channels$1.write(Channels.java:174)\n\t\tat org.apache.lucene.store.FSDirectory$FSIndexOutput$1.write(FSDirectory.java:419)\n\t\tat java.util.zip.CheckedOutputStream.write(CheckedOutputStream.java:73)\n\t\tat java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)\n\t\tat java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140)\n\t\tat java.io.FilterOutputStream.close(FilterOutputStream.java:158)\n\t\tat org.apache.lucene.store.OutputStreamIndexOutput.close(OutputStreamIndexOutput.java:70)\n\t\tat org.apache.lucene.util.OfflineSorter$SortPartitionTask.call(OfflineSorter.java:622)\n\t\t... 16 more",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2017-06-22T14:54:25+0000",
            "content": "Please raise this question on the user's list at solr-user@lucene.apache.org, see: (http://lucene.apache.org/solr/community.html#mailing-lists-irc) there are a lot more people watching that list who may be able to help. \n\nIf it's determined that this is a code issue in Solr and not a configuration/usage problem, we can raise a JIRA.\n\nSegment merging can cause your entire index to be copied, so you always need at least as much free space on your disk as your indexes occupy. When you post this on the user's list, please include how much total disk space your indexes that use that disk occupy. And whether this happens all the time or was a one-time problem. ",
            "author": "Erick Erickson",
            "id": "comment-16059496"
        },
        {
            "date": "2017-06-22T15:00:50+0000",
            "content": "Thank you for that suggestion. Before I post, perhaps you could let me know what you think based on the following:\n\n\n\tthe size of the index is 375 GB\n\tthere are 10,824,670 documents\n\tthere's 612 GB free on the Solr data partition\n\tthe index is fully optimised (segment count is 1)\n\n\n\nThe error happens every time the core is loaded. For example, when Solr is restarted or I press the Reload button in the Core Admin section on the Solr UI. ",
            "author": "Matthew Caruana Galizia",
            "id": "comment-16059502"
        },
        {
            "date": "2017-06-22T17:01:03+0000",
            "content": "Hi Matthew,\n\nThe AnalyzingSuggester uses a tmp dir to build the FST ( https://lucene.apache.org/core/6_6_0/suggest/org/apache/lucene/search/suggest/analyzing/AnalyzingSuggester.html ) and then deletes the tmp dir once it's built.\n\nSo this has nothing to do with your disk space on your normal drive but with the tmp dir that the JVM is using.\n\nThe suggester doesn't let you specify the tmp in the solrconfig file , but the dir path read by this System Property ( -Djava.io.tmpdir ) which defaults Java defaults to /tmp on linux I believe\n\nMaybe we could do two things here to help the user:\n\n\tMention the path which run out of disk space\n\tDocument that the AnalyzingSuggester/FuzzySuggester requires a tmp dir to build the suggester.\n\n\n\nWe could leave this Jira open to address those. Would you be interested in submitting a patch? ",
            "author": "Varun Thacker",
            "id": "comment-16059688"
        },
        {
            "date": "2017-06-22T18:04:20+0000",
            "content": "Thank you. That was indeed the issue. Setting\n\nSOLR_OPTS=\"$SOLR_OPTS -Djava.io.tmpdir=/path/to/other/tmp\"\n\nin solr.in.sh did the trick. Mentioning the path would definitely help. I'm too busy to work on a patch this week and the next, but perhaps after that. ",
            "author": "Matthew Caruana Galizia",
            "id": "comment-16059775"
        }
    ]
}