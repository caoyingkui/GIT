{
    "id": "SOLR-12128",
    "title": "Setting the same field to null multiple times in a row throws NullPointerException",
    "details": {
        "labels": "",
        "priority": "Critical",
        "components": [
            "update"
        ],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "6.6.2",
        "resolution": "Unresolved",
        "status": "Open"
    },
    "description": "I have a query that\u00a0tries to set the same field to null multiple times in a row. This results in a NullPointerException. Tested on 6.6.2.\n\nStack trace:\n\njava.lang.NullPointerException\nat org.apache.solr.handler.component.RealTimeGetComponent.toSolrInputDocument(RealTimeGetComponent.java:667)\nat org.apache.solr.handler.component.RealTimeGetComponent.getInputDocumentFromTlog(RealTimeGetComponent.java:539)\nat org.apache.solr.handler.component.RealTimeGetComponent.getInputDocument(RealTimeGetComponent.java:593)\nat org.apache.solr.update.processor.AtomicUpdateDocumentMerger.doInPlaceUpdateMerge(AtomicUpdateDocumentMerger.java:253)\nat org.apache.solr.update.processor.DistributedUpdateProcessor.getUpdatedDocument(DistributedUpdateProcessor.java:1352)\nat org.apache.solr.update.processor.DistributedUpdateProcessor.versionAdd(DistributedUpdateProcessor.java:1078)\nat org.apache.solr.update.processor.DistributedUpdateProcessor.processAdd(DistributedUpdateProcessor.java:748)\nat org.apache.solr.update.processor.LogUpdateProcessorFactory$LogUpdateProcessor.processAdd(LogUpdateProcessorFactory.java:103)\nat org.apache.solr.handler.loader.XMLLoader.processUpdate(XMLLoader.java:261)\nat org.apache.solr.handler.loader.XMLLoader.load(XMLLoader.java:188)\nat org.apache.solr.handler.UpdateRequestHandler$1.load(UpdateRequestHandler.java:97)\nat org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:68)\nat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:173)\nat org.apache.solr.core.SolrCore.execute(SolrCore.java:2477)\nat org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:723)\nat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:529)\nat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:361)\nat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:305)\nat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1691)\nat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:582)\nat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\nat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\nat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:226)\nat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1180)\nat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:512)\nat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\nat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1112)\nat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\nat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)\nat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:119)\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)\nat org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:335)\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)\nat org.eclipse.jetty.server.Server.handle(Server.java:534)\nat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:320)\nat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:251)\nat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:273)\nat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:95)\nat org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)\nat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.executeProduceConsume(ExecuteProduceConsume.java:303)\nat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceConsume(ExecuteProduceConsume.java:148)\nat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:136)\nat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:671)\nat org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:589)\nat java.lang.Thread.run(Thread.java:748)\n\nQuery example:\u00a0\n\n<update>\n    <add>\n        <doc>\n            <field name=\"id\">460341</field>\n            <field name=\"some_dynamic_field_124231_i_dv\" update=\"set\" null=\"true\"/>\n        </doc>\n    </add>\n    <add>\n        <doc>\n            <field name=\"id\">460341</field>\n            <field name=\"some_dynamic_field_124231_i_dv\" update=\"set\" null=\"true\"/>\n        </doc>\n    </add>\n    <add>\n        <doc>\n            <field name=\"id\">460341</field>\n            <field name=\"some_dynamic_field_124231_i_dv\" update=\"set\">1521472499</field>\n        </doc>\n    </add>\n</update>",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2018-09-06T16:28:54+0000",
            "content": "Faced the similar issue while re-producing SOLR-12127.\n\nThis line the problem here. getFieldValues(fname) could return null. Iterating over null produces NPE.\nIdeally, tlog would not contain null values for a field hence, there is no null check. Fixing SOLR-12127 will also fix this issue as this arise only when setting field value to null and field is non-stored, non-indexed and single-valued with docvalues enabled\n\nhttps://github.com/apache/lucene-solr/blob/master/solr/core/src/java/org/apache/solr/handler/component/RealTimeGetComponent.java#L693\n\n ",
            "author": "Munendra S N",
            "id": "comment-16606044"
        }
    ]
}