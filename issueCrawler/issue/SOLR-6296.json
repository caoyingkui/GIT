{
    "id": "SOLR-6296",
    "title": "add shutdownCoresCloseTimeoutSeconds support",
    "details": {
        "affect_versions": "None",
        "status": "Resolved",
        "fix_versions": [],
        "components": [],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Duplicate"
    },
    "description": "The problem we saw was that an error-in-final-commit during solr-shutdown (details below) led to a corrupted segments_.... file which prevented subsequent solr-start.\n\nThis change (subject to a timeout) delays solr-shutdown until all requests have stopped using all solr cores. It also prints any suppressed exceptions within the error-in-final-commit exception.",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "author": "ASF GitHub Bot",
            "id": "comment-14078053",
            "date": "2014-07-29T17:40:22+0000",
            "content": "GitHub user cpoerschke opened a pull request:\n\n    https://github.com/apache/lucene-solr/pull/75\n\n    SOLR-6296: add shutdownCoresCloseTimeoutSeconds support\n\n    https://issues.apache.org/jira/i#browse/SOLR-6296\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/bloomberg/lucene-solr trunk-shutdown-cores-close-timeout\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/lucene-solr/pull/75.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #75\n\n\ncommit e58264b22117c4d6f415bd607ea5e03c48c24219\nAuthor: Christine Poerschke <cpoerschke@bloomberg.net>\nDate:   2014-06-24T10:27:28Z\n\n    solr: add shutdownCoresCloseTimeoutSeconds support with corresponding TestCoreContainer test\n\n    The problem we saw was that an error-in-final-commit during solr-shutdown (details below) led to a corrupted segments_.... file which prevented subsequent solr-start.\n\n    This change (subject to a timeout) delays solr-shutdown until all requests have stopped using all solr cores. It also prints any suppressed exceptions within the error-in-final-commit exception.\n\n    error-in-final-commit details:\n\n    WARN [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:145] 1 threads could not be stopped\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:151] Couldn't stop Thread[qtp562266264-45169,5,main]\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at java.io.RandomAccessFile.$$YJP$$open(Native Method)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at java.io.RandomAccessFile.open(RandomAccessFile.java)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at java.io.RandomAccessFile.<init>(RandomAccessFile.java:233)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.apache.lucene.store.FSDirectory$FSIndexOutput.<init>(FSDirectory.java:394)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.apache.lucene.store.FSDirectory.createOutput(FSDirectory.java:282)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.apache.lucene.store.NRTCachingDirectory.unCache(NRTCachingDirectory.java:297)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.apache.lucene.store.NRTCachingDirectory.sync(NRTCachingDirectory.java:216)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.apache.lucene.index.IndexWriter.startCommit(IndexWriter.java:4475)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.apache.lucene.index.IndexWriter.prepareCommitInternal(IndexWriter.java:2989)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.apache.lucene.index.IndexWriter.commitInternal(IndexWriter.java:3096)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.apache.lucene.index.IndexWriter.commit(IndexWriter.java:3063)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.apache.solr.update.DirectUpdateHandler2.closeWriter(DirectUpdateHandler2.java:765)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.apache.solr.update.DefaultSolrCoreState.closeIndexWriter(DefaultSolrCoreState.java:68)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.apache.solr.update.DefaultSolrCoreState.close(DefaultSolrCoreState.java:359)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.apache.solr.update.SolrCoreState.decrefSolrCoreState(SolrCoreState.java:72)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.apache.solr.core.SolrCore.close(SolrCore.java:1058)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:453)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:207)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)\n    ERROR [qtp562266264-45169] o.a.s.u.UpdateHandler [DirectUpdateHandler2.java:772] Error in final commit\n    org.apache.lucene.util.ThreadInterruptedException: java.lang.InterruptedException: sleep interrupted\n    \tat org.apache.lucene.util.IOUtils.fsync(IOUtils.java:326)\n    \tat org.apache.lucene.store.FSDirectory.fsync(FSDirectory.java:449)\n    \tat org.apache.lucene.store.FSDirectory.sync(FSDirectory.java:306)\n    \tat org.apache.lucene.store.NRTCachingDirectory.sync(NRTCachingDirectory.java:218)\n    \tat org.apache.lucene.index.IndexWriter.startCommit(IndexWriter.java:4475)\n    \tat org.apache.lucene.index.IndexWriter.prepareCommitInternal(IndexWriter.java:2989)\n    \tat org.apache.lucene.index.IndexWriter.commitInternal(IndexWriter.java:3096)\n    \tat org.apache.lucene.index.IndexWriter.commit(IndexWriter.java:3063)\n    \tat org.apache.solr.update.DirectUpdateHandler2.closeWriter(DirectUpdateHandler2.java:765)\n    \tat org.apache.solr.update.DefaultSolrCoreState.closeIndexWriter(DefaultSolrCoreState.java:68)\n    \tat org.apache.solr.update.DefaultSolrCoreState.close(DefaultSolrCoreState.java:359)\n    \tat org.apache.solr.update.SolrCoreState.decrefSolrCoreState(SolrCoreState.java:72)\n    \tat org.apache.solr.core.SolrCore.close(SolrCore.java:1058)\n    \tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:453)\n    \tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:207)\n    \tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)\n    \tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:455)\n    \tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)\n    \tat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:557)\n    \tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231)\n    \tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1075)\n    \tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:384)\n    \tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)\n    \tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1009)\n    \tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)\n    \tat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:255)\n    \tat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:154)\n    \tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)\n    \tat org.eclipse.jetty.server.Server.handle(Server.java:368)\n    \tat org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:489)\n    \tat org.eclipse.jetty.server.BlockingHttpConnection.handleRequest(BlockingHttpConnection.java:53)\n    \tat org.eclipse.jetty.server.AbstractHttpConnection.content(AbstractHttpConnection.java:953)\n    \tat org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.content(AbstractHttpConnection.java:1014)\n    \tat org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:953)\n    \tat org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:240)\n    \tat org.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:72)\n    \tat org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:264)\n    \tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608)\n    \tat org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543)\n    \tat java.lang.Thread.run(Thread.java:722) [na:1.7.0_10]\n    Caused by: java.lang.InterruptedException: sleep interrupted\n    \tat java.lang.Thread.$$YJP$$sleep(Native Method) [na:1.7.0_10]\n    \tat java.lang.Thread.sleep(Thread.java) [na:1.7.0_10]\n    \tat org.apache.lucene.util.IOUtils.fsync(IOUtils.java:324)\n    \t... 39 common frames omitted\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:455)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:557)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1075)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:384)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1009)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:255)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:154)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.Server.handle(Server.java:368)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:489)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.BlockingHttpConnection.handleRequest(BlockingHttpConnection.java:53)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.AbstractHttpConnection.content(AbstractHttpConnection.java:953)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.content(AbstractHttpConnection.java:1014)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:953)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:240)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:72)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:264)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543)\n    INFO [ShutdownMonitor] o.e.j.u.t.QueuedThreadPool [QueuedThreadPool.java:154]  at java.lang.Thread.run(Thread.java:722)\n\n "
        },
        {
            "author": "Christine Poerschke",
            "id": "comment-14078067",
            "date": "2014-07-29T17:51:19+0000",
            "content": "SOLR-6296 concerns segments_... file corruption root cause, LUCENE-5857 concerns automatically recovering from such a file corruption. "
        },
        {
            "author": "Robert Muir",
            "id": "comment-14229175",
            "date": "2014-11-30T17:45:34+0000",
            "content": "commit is atomic as of LUCENE-5925, so the situation cannot happen. "
        },
        {
            "author": "ASF GitHub Bot",
            "id": "comment-15094552",
            "date": "2016-01-12T19:11:36+0000",
            "content": "Github user cpoerschke closed the pull request at:\n\n    https://github.com/apache/lucene-solr/pull/75 "
        }
    ]
}