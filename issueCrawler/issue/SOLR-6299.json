{
    "id": "SOLR-6299",
    "title": "Facet count on facet queries returns different results if #shards > 1",
    "details": {
        "affect_versions": "6.0",
        "status": "Resolved",
        "fix_versions": [],
        "components": [
            "SolrCloud"
        ],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Not A Problem"
    },
    "description": "I am trying to run some facet counts on facet queries and looks like i am getting different counts if i use >1 shards in the SolrCloud cluster.\n\nHere is the upstream unit test:\nhttps://github.com/apache/lucene-solr/blob/trunk/solr/core/src/test/org/apache/solr/request/SimpleFacetsTest.java#L173\n\nSetup:\n\n\tIngested 5 solr docs.\n\n{\n  \"responseHeader\": {\n    \"status\": 0,\n    \"QTime\": 22,\n    \"params\": {\n      \"indent\": \"true\",\n      \"q\": \"*:*\",\n      \"_\": \"1406346687337\",\n      \"wt\": \"json\"\n    }\n  },\n  \"response\": {\n    \"numFound\": 5,\n    \"start\": 0,\n    \"maxScore\": 1,\n    \"docs\": [\n      {\n        \"id\": 2004,\n        \"range_facet_l\": [\n          2004\n        ],\n        \"hotel_s1\": \"b\",\n        \"airport_s1\": \"ams\",\n        \"duration_i1\": 5,\n        \"_version_\": 1474661321774465000,\n        \"timestamp\": \"2014-07-26T03:50:27.975Z\",\n        \"multiDefault\": [\n          \"muLti-Default\"\n        ],\n        \"intDefault\": 42\n      },\n      {\n        \"id\": 2000,\n        \"range_facet_l\": [\n          2000\n        ],\n        \"hotel_s1\": \"a\",\n        \"airport_s1\": \"ams\",\n        \"duration_i1\": 5,\n        \"_version_\": 1474661323604230100,\n        \"timestamp\": \"2014-07-26T03:50:29.734Z\",\n        \"multiDefault\": [\n          \"muLti-Default\"\n        ],\n        \"intDefault\": 42\n      },\n      {\n        \"id\": 2003,\n        \"range_facet_l\": [\n          2003\n        ],\n        \"hotel_s1\": \"b\",\n        \"airport_s1\": \"ams\",\n        \"duration_i1\": 5,\n        \"_version_\": 1474661326312702000,\n        \"timestamp\": \"2014-07-26T03:50:32.317Z\",\n        \"multiDefault\": [\n          \"muLti-Default\"\n        ],\n        \"intDefault\": 42\n      },\n      {\n        \"id\": 2001,\n        \"range_facet_l\": [\n          2001\n        ],\n        \"hotel_s1\": \"a\",\n        \"airport_s1\": \"dus\",\n        \"duration_i1\": 10,\n        \"_version_\": 1474661326389248000,\n        \"timestamp\": \"2014-07-26T03:50:32.375Z\",\n        \"multiDefault\": [\n          \"muLti-Default\"\n        ],\n        \"intDefault\": 42\n      },\n      {\n        \"id\": 2002,\n        \"range_facet_l\": [\n          2002\n        ],\n        \"hotel_s1\": \"b\",\n        \"airport_s1\": \"ams\",\n        \"duration_i1\": 10,\n        \"_version_\": 1474661326464745500,\n        \"timestamp\": \"2014-07-26T03:50:32.446Z\",\n        \"multiDefault\": [\n          \"muLti-Default\"\n        ],\n        \"intDefault\": 42\n      }\n    ]\n  }\n}\n\n\n\n\n\nHere is the query being run:\n\nTest code:\n    assertQ(\n        req(\n            \"q\", \"*:*\",\n            \"fq\", \"id:[2000 TO 2004]\",\n            \"group\", \"true\",\n            \"group.facet\", \"true\",\n            \"group.field\", \"hotel_s1\",\n            \"facet\", \"true\",\n            \"facet.limit\", facetLimit,\n            \"facet.query\", \"airport_s1:ams\"\n        ),\n        \"//lst[@name='facet_queries']/int[@name='airport_s1:ams'][.='2']\"\n    );\n\n$ curl  \"http://localhost:8983/solr/collection1/select?facet=true&facet.query=airport_s1%3Aams&q=*%3A*&facet.limit=-100&group.field=hotel_s1&group=true&group.facet=true&fq=id%3A%5B2000+TO+2004%5D&indent=true&wt=xml\" \n\n\n\nNow, if i issue a query statement - On 1 shard system (Works as expected)\n\n$ curl  \"http://localhost:8983/solr/collection1/select?facet=true&facet.query=airport_s1%3Aams&q=*%3A*&facet.limit=-100&group.field=hotel_s1&group=true&group.facet=true&fq=id%3A%5B2000+TO+2004%5D&indent=true&wt=xml\" \n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<response>\n\n<lst name=\"responseHeader\">\n  <int name=\"status\">0</int>\n  <int name=\"QTime\">17</int>\n  <lst name=\"params\">\n    <str name=\"facet\">true</str>\n    <str name=\"indent\">true</str>\n    <str name=\"facet.query\">airport_s1:ams</str>\n    <str name=\"q\">*:*</str>\n    <str name=\"facet.limit\">-100</str>\n    <str name=\"group.field\">hotel_s1</str>\n    <str name=\"group\">true</str>\n    <str name=\"wt\">xml</str>\n    <str name=\"fq\">id:[2000 TO 2004]</str>\n    <str name=\"group.facet\">true</str>\n  </lst>\n</lst>\n<lst name=\"grouped\">\n  <lst name=\"hotel_s1\">\n    <int name=\"matches\">5</int>\n    <arr name=\"groups\">\n      <lst>\n        <str name=\"groupValue\">a</str>\n        <result name=\"doclist\" numFound=\"2\" start=\"0\">\n          <doc>\n            <int name=\"id\">2001</int>\n            <arr name=\"range_facet_l\">\n              <long>2001</long>\n            </arr>\n            <str name=\"hotel_s1\">a</str>\n            <str name=\"airport_s1\">dus</str>\n            <int name=\"duration_i1\">10</int>\n            <long name=\"_version_\">1474989437819551744</long>\n            <date name=\"timestamp\">2014-07-29T18:45:43.819Z</date>\n            <arr name=\"multiDefault\">\n              <str>muLti-Default</str>\n            </arr>\n            <int name=\"intDefault\">42</int></doc>\n        </result>\n      </lst>\n      <lst>\n        <str name=\"groupValue\">b</str>\n        <result name=\"doclist\" numFound=\"3\" start=\"0\">\n          <doc>\n            <int name=\"id\">2003</int>\n            <arr name=\"range_facet_l\">\n              <long>2003</long>\n            </arr>\n            <str name=\"hotel_s1\">b</str>\n            <str name=\"airport_s1\">ams</str>\n            <int name=\"duration_i1\">5</int>\n            <long name=\"_version_\">1474989439611568128</long>\n            <date name=\"timestamp\">2014-07-29T18:45:45.528Z</date>\n            <arr name=\"multiDefault\">\n              <str>muLti-Default</str>\n            </arr>\n            <int name=\"intDefault\">42</int></doc>\n        </result>\n      </lst>\n    </arr>\n  </lst>\n</lst>\n<lst name=\"facet_counts\">\n  <lst name=\"facet_queries\">\n    <int name=\"airport_s1:ams\">2</int>\n  </lst>\n  <lst name=\"facet_fields\"/>\n  <lst name=\"facet_dates\"/>\n  <lst name=\"facet_ranges\"/>\n</lst>\n</response>\n\n\n\nNow, if i run the same query on 2 shard system, i see facet count as 3 instead of 2.\n\nSolr result on 2 shard cluster:\n\n[systest@search-testing-c5-1 search]$ curl  \"http://localhost:8983/solr/collection1/select?facet=true&facet.query=airport_s1%3Aams&q=*%3A*&facet.limit=-100&group.field=hotel_s1&group=true&group.facet=true&fq=id%3A%5B2000+TO+2004%5D&indent=true&wt=xml\" \n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<response>\n\n<lst name=\"responseHeader\">\n  <int name=\"status\">0</int>\n  <int name=\"QTime\">69</int>\n  <lst name=\"params\">\n    <str name=\"facet\">true</str>\n    <str name=\"indent\">true</str>\n    <str name=\"facet.query\">airport_s1:ams</str>\n    <str name=\"q\">*:*</str>\n    <str name=\"facet.limit\">-100</str>\n    <str name=\"group.field\">hotel_s1</str>\n    <str name=\"group\">true</str>\n    <str name=\"wt\">xml</str>\n    <str name=\"fq\">id:[2000 TO 2004]</str>\n    <str name=\"group.facet\">true</str>\n  </lst>\n</lst>\n<lst name=\"grouped\">\n  <lst name=\"hotel_s1\">\n    <int name=\"matches\">5</int>\n    <arr name=\"groups\">\n      <lst>\n        <str name=\"groupValue\">b</str>\n        <result name=\"doclist\" numFound=\"3\" start=\"0\" maxScore=\"1.0\">\n          <doc>\n            <int name=\"id\">2002</int>\n            <arr name=\"range_facet_l\">\n              <long>2002</long>\n            </arr>\n            <str name=\"hotel_s1\">b</str>\n            <str name=\"airport_s1\">ams</str>\n            <int name=\"duration_i1\">10</int>\n            <long name=\"_version_\">1474661326464745472</long>\n            <date name=\"timestamp\">2014-07-26T03:50:32.446Z</date>\n            <arr name=\"multiDefault\">\n              <str>muLti-Default</str>\n            </arr>\n            <int name=\"intDefault\">42</int></doc>\n        </result>\n      </lst>\n      <lst>\n        <str name=\"groupValue\">a</str>\n        <result name=\"doclist\" numFound=\"2\" start=\"0\" maxScore=\"1.0\">\n          <doc>\n            <int name=\"id\">2001</int>\n            <arr name=\"range_facet_l\">\n              <long>2001</long>\n            </arr>\n            <str name=\"hotel_s1\">a</str>\n            <str name=\"airport_s1\">dus</str>\n            <int name=\"duration_i1\">10</int>\n            <long name=\"_version_\">1474661326389248000</long>\n            <date name=\"timestamp\">2014-07-26T03:50:32.375Z</date>\n            <arr name=\"multiDefault\">\n              <str>muLti-Default</str>\n            </arr>\n            <int name=\"intDefault\">42</int></doc>\n        </result>\n      </lst>\n    </arr>\n  </lst>\n</lst>\n<lst name=\"facet_counts\">\n  <lst name=\"facet_queries\">\n    <int name=\"airport_s1:ams\">3</int>\n  </lst>\n  <lst name=\"facet_fields\"/>\n  <lst name=\"facet_dates\"/>\n  <lst name=\"facet_ranges\"/>\n</lst>\n</response>\n\n \n\nIn order to replicate this, we can simply run the above test on >1 shard system and the solr response will be different.",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "author": "Tom\u00e1s Fern\u00e1ndez L\u00f6bbe",
            "id": "comment-14078396",
            "date": "2014-07-29T21:25:28+0000",
            "content": "I think the issue must be with the combination grouping+facet-query. Grouping already gives you bad group counts if you don't make sure that all docs of a group fall in the same shard.  "
        },
        {
            "author": "Vamsee Yarlagadda",
            "id": "comment-14083270",
            "date": "2014-08-02T01:13:34+0000",
            "content": "Thanks for the insight, Tom\u00e1s Fern\u00e1ndez L\u00f6bbe.\nLooks like we either have to do custom sharding to make sure all the docs which relevant to the query are in the same shard to run a grouping request or just have a single sharded system.\n\nResolving this Jira as not a bug.  "
        }
    ]
}