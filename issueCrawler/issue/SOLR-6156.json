{
    "id": "SOLR-6156",
    "title": "Exception while using group with timeAllowed on SolrCloud.",
    "details": {
        "affect_versions": "None",
        "status": "Open",
        "fix_versions": [],
        "components": [
            "search"
        ],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Unresolved"
    },
    "description": "Following exception is thrown when using grouping with timeAllowed. Solr version used is 4.8.0.\nSEVERE: null:org.apache.solr.client.solrj.impl.HttpSolrServer$RemoteSolrException: java.lang.NullPointerException\n        at org.apache.lucene.search.TimeLimitingCollector.setNextReader(TimeLimitingCollector.java:158)\n        at org.apache.lucene.search.MultiCollector.setNextReader(MultiCollector.java:113)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:612)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:297)\n        at org.apache.solr.search.grouping.CommandHandler.searchWithTimeLimiter(CommandHandler.java:219)\n        at org.apache.solr.search.grouping.CommandHandler.execute(CommandHandler.java:156)\n        at org.apache.solr.handler.component.QueryComponent.process(QueryComponent.java:338)\n        at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:218)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1952)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:774)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:418)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:207)",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "author": "Christine Poerschke",
            "id": "comment-14026280",
            "date": "2014-06-10T09:48:01+0000",
            "content": "Hi Modassar Ather - i have come across something similar with a test solr instance, the crucial combination there was \n\ngroup=true&timeAllowed=...&rows=0\n\n and non-zero rows values was fine. Does your request use rows=0 as well and/or could you share an example request that reproduces the exception? "
        },
        {
            "author": "Modassar Ather",
            "id": "comment-14026297",
            "date": "2014-06-10T10:26:10+0000",
            "content": "Hi Christine Poerschke\n\nWith timeAllowed following query is used without rows parameter which caused exception as in description of this ticket.\ngroup=true&group.field=<FIELD_NAME> "
        },
        {
            "author": "Modassar Ather",
            "id": "comment-14063390",
            "date": "2014-07-16T11:18:19+0000",
            "content": "While debugging found that the create() method under SearchGroupsFieldCommand class return an empty list of collectors if topNGroups < 0 and if includeGroupCount is false.\nAnd if the collectors list is empty CommandHandler class invokes searchWithTimeLimiter(query, filter, null);. null is passed as collectors.\n\nWith the null collector passed an instance of TimeLimitingCollector is created in searchWithTimeLimiter(...) method of CommandHandler class if queryCommand.getTimeAllowed() > 0.\n\nCode snippet from CommandHandler. Here in the code below the collector passed to TimeLimitingCollector is null.\nif (queryCommand.getTimeAllowed() > 0 ) \n{\n      collector = new TimeLimitingCollector(collector, TimeLimitingCollector.getGlobalCounter(), queryCommand.getTimeAllowed());\n    }\n\nThe NullPointerException occurrs when the TimeLimitingCollector instance created with null collector invokes setNextReader(...)\n\nNot sure if topNGroups should be greater than 0 or includeGroupCount should be true when using timeAllowed or it is an issue. Kindly provide inputs.\nAlso let me know if the collectors list is null and timeAllowed>0 which collector can be used to create the instance of TimeLimitingCollector.\n\nThanks,\nModassar "
        },
        {
            "author": "Forest Soup",
            "id": "comment-14506695",
            "date": "2015-04-22T09:19:05+0000",
            "content": "We have the same issue on solr 4.7, when we issue a request like this(I only paste the xml format header here with some replacement):\n<lst name=\"responseHeader\">\n<int name=\"status\">500</int>\n<int name=\"QTime\">11</int>\n<lst name=\"params\">\n<str name=\"route\">Q049Y2RsMi1tYWlsMDcvTz1zY24y12345678!</str>\n<str name=\"facet\">true</str>\n<str name=\"facet.mincount\">1</str>\n<str name=\"facet.limit\">13</str>\n<str name=\"facet.range\">date</str>\n<str name=\"facet.range.end\">NOW/DAY+1DAY</str>\n<str name=\"facet.range.gap\">+1DAY</str>\n<str name=\"wt\">xml</str>\n<str name=\"rows\">0</str>\n<str name=\"df\">body</str>\n<str name=\"start\">0</str>\n<str name=\"q\">\n((owner:12345678) AND (servername:\"mail07\")) AND (((funid:38D46BF5E8F08834852564B50129B2C)) (softdeletion:0))\n</str>\n<str name=\"facet.range.start\">NOW/DAY-31DAY</str>\n<str name=\"q.op\">AND</str>\n<str name=\"timeAllowed\">60000</str>\n<str name=\"group.field\">tua0</str>\n<str name=\"group.sort\">date desc</str>\n<str name=\"group\">true</str>\n<arr name=\"facet.field\">\n<str>strinetfrom</str>\n<str>funid</str>\n</arr>\n</lst>\n</lst>\n\nIf we remove the timeAllowed=60000, there is no that issue.\n\nWe have all cores active according to /clusterstates.json and /live_nodes  in both Admin UI and in ZooKeeper.\n\nWe have the response:\n{\n  \"error\": \n{\n    \"msg\": \"org.apache.solr.client.solrj.SolrServerException: No live SolrServers available to handle this request:[https://hij2-solr1.fen.def2.cn.abc.com:8443/solr/collection1_shard2_replica2, https://hij2-solr2.fen.def2.cn.abc.com:8443/solr/collection1_shard2_replica1]\",\n    \"trace\": \"org.apache.solr.common.SolrException: org.apache.solr.client.solrj.SolrServerException: No live SolrServers available to handle this request:[https://hij2-solr1.fen.def2.cn.abc.com:8443/solr/collection1_shard2_replica2, https://hij2-solr2.fen.def2.cn.abc.com:8443/solr/collection1_shard2_replica1]\\n\\tat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:308)\\n\\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)\\n\\tat org.apache.solr.core.SolrCore.execute(SolrCore.java:1916)\\n\\tat org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:780)\\n\\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:427)\\n\\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:217)\\n\\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\\n\\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\\n\\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:220)\\n\\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:122)\\n\\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)\\n\\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\\n\\tat org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:950)\\n\\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:116)\\n\\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)\\n\\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1040)\\n\\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:607)\\n\\tat org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:316)\\n\\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1156)\\n\\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:626)\\n\\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\\n\\tat java.lang.Thread.run(Thread.java:804)\\nCaused by: org.apache.solr.client.solrj.SolrServerException: No live SolrServers available to handle this request:[https://hij2-solr1.fen.def2.cn.abc.com:8443/solr/collection1_shard2_replica2, https://hij2-solr2.fen.def2.cn.abc.com:8443/solr/collection1_shard2_replica1]\\n\\tat org.apache.solr.client.solrj.impl.LBHttpSolrServer.request(LBHttpSolrServer.java:387)\\n\\tat org.apache.solr.handler.component.HttpShardHandlerFactory.makeLoadBalancedRequest(HttpShardHandlerFactory.java:205)\\n\\tat org.apache.solr.handler.component.HttpShardHandler$1.call(HttpShardHandler.java:161)\\n\\tat org.apache.solr.handler.component.HttpShardHandler$1.call(HttpShardHandler.java:118)\\n\\tat java.util.concurrent.FutureTask.run(FutureTask.java:273)\\n\\tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:482)\\n\\tat java.util.concurrent.FutureTask.run(FutureTask.java:273)\\n\\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1156)\\n\\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:626)\\n\\t... 1 more\\nCaused by: org.apache.solr.client.solrj.impl.HttpSolrServer$RemoteSolrException: Internal Server Error\\n\\nrequest: https://hij2-solr2.fen.def2.cn.abc.com:8443/solr/collection1_shard2_replica1/select\\n\\tat org.apache.solr.client.solrj.impl.HttpSolrServer.request(HttpSolrServer.java:495)\\n\\tat org.apache.solr.client.solrj.impl.HttpSolrServer.request(HttpSolrServer.java:199)\\n\\tat org.apache.solr.client.solrj.impl.LBHttpSolrServer.request(LBHttpSolrServer.java:302)\\n\\t... 9 more\\n\",\n    \"code\": 500\n  }\n\n\nThe error log is :\n2015/4/22 \u4e0b\u53485:00:16\nERROR\nSolrCore\njava.lang.NullPointerException\njava.lang.NullPointerException\n\tat org.apache.lucene.search.TimeLimitingCollector.setNextReader(TimeLimitingCollector.java:158)\n\tat org.apache.lucene.search.MultiCollector.setNextReader(MultiCollector.java:113)\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:612)\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:297)\n\tat org.apache.solr.search.grouping.CommandHandler.searchWithTimeLimiter(CommandHandler.java:219)\n\tat org.apache.solr.search.grouping.CommandHandler.execute(CommandHandler.java:156)\n\tat org.apache.solr.handler.component.QueryComponent.process(QueryComponent.java:336)\n\tat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:214)\n\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)\n\tat org.apache.solr.core.SolrCore.execute(SolrCore.java:1916)\n\tat org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:780)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:427)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:217)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:220)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:122)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n\tat org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:950)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:116)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1040)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:607)\n\tat org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:314)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1156)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:626)\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n\tat java.lang.Thread.run(Thread.java:804)\n2015/4/22 \u4e0b\u53485:00:16\nERROR\nSolrDispatchFilter\nnull:java.lang.NullPointerException\nnull:java.lang.NullPointerException\n\tat org.apache.lucene.search.TimeLimitingCollector.setNextReader(TimeLimitingCollector.java:158)\n\tat org.apache.lucene.search.MultiCollector.setNextReader(MultiCollector.java:113)\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:612)\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:297)\n\tat org.apache.solr.search.grouping.CommandHandler.searchWithTimeLimiter(CommandHandler.java:219)\n\tat org.apache.solr.search.grouping.CommandHandler.execute(CommandHandler.java:156)\n\tat org.apache.solr.handler.component.QueryComponent.process(QueryComponent.java:336)\n\tat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:214)\n\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)\n\tat org.apache.solr.core.SolrCore.execute(SolrCore.java:1916)\n\tat org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:780)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:427)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:217)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:220)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:122)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:171)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n\tat org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:950)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:116)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:408)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1040)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:607)\n\tat org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:314)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1156)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:626)\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n\tat java.lang.Thread.run(Thread.java:804)\n} "
        }
    ]
}