{
    "id": "SOLR-4285",
    "title": "Solr mangles distributed query parameters",
    "details": {
        "affect_versions": "6.0",
        "status": "Open",
        "fix_versions": [
            "6.0"
        ],
        "components": [
            "SolrCloud"
        ],
        "type": "Bug",
        "priority": "Critical",
        "labels": "",
        "resolution": "Unresolved"
    },
    "description": "Using Siege to load test a cluster via a load balancer we sometimes see the forwarded query strings being mangled and causing an error. The problem mainly manifests in a function query parameter and the host__terms parameter. It doesn't seem to be an issue of concurrency because it also happens when load testing with a single thread.\n\nfunction query parameter causing an error:\n\n2012-12-12 11:11:45,527 ERROR [solr.core.SolrCore] - [http-8080-exec-16] - : org.apache.solr.common.SolrException: org.apache.solr.search.SyntaxError: Expected ',' at position 55 in 'if(exists(date),max(recip(ms(NOW/DAY,date),3.17e-8,143\n.9),.8),.7)'\n        at org.apache.solr.handler.component.QueryComponent.prepare(QueryComponent.java:154)\n...\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n        at java.lang.Thread.run(Thread.java:662)\nCaused by: org.apache.solr.search.SyntaxError: Expected ',' at position 55 in 'if(exists(date),max(recip(ms(NOW/DAY,date),3.17e-8,143\n.9),.8),.7)'\n\n\n\nThe above error is somewhat older but for some reason the comma in the edismax boost parameter is replaced by a newline.\n\n\n\n\nhost__terms parameter causing an error:\n\n2013-01-08 12:09:08,902 ERROR [handler.component.FacetComponent] - [http-8080-exec-13] - : Unexpected term returned for facet refining. key=host term='dafenwout.domain.ext^daisybel.domain.ext'\n        request params=spellcheck=false&facet=true&sort=score+desc.....&facet.field=%7B%21terms%3D%24host__terms+ex%3Dhost%7Dhost&host__terms=....daanjobbe.domain.ext%2Cdaank.domain.ext%2Cdafenwout.domain.ext%2Cdaisybel.domain.ext%2Cdaniellehooijmans.domain.ext...koenleurs.domain.ext\n        toRefine=[Ljava.util.List;@5b48447f\n        response={....daanjobbe.domain.ext=0,daank.domain.ext=0,dafenwout.domain.ext^daisybel.domain.ext=0,daniellehooijmans.domain.ext=0...koenleurs.domain.ext=0}\n\n\n\nI've shortened the above error significantly, it was about 20kB. It's the carret symbol causing the issue. For some reason the logged request does not contain the carret symbol.\n\nBoth issues are very elusive and hard to reproduce but in our case will appear if we send queries long enough, 50k, 100k queries.\n\nOriginal thread:\nhttp://lucene.472066.n3.nabble.com/SolrCloud-breaks-distributed-query-strings-td4026314.html",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "author": "Markus Jelsma",
            "id": "comment-13546935",
            "date": "2013-01-08T15:13:18+0000",
            "content": "Finally, i got a messed up boost query parameter after half a million queries. It's the curious case of the carret symbol because here too it's that symbol that replaces a decent comma.\n\n\n2013-01-08 14:02:16,755 INFO [solr.core.SolrCore] - [http-8080-exec-3] - : [shard_d] webapp=/solr path=/select params={...&hl.alternateField=content_*&boost=if(exists(date),max(recip(ms(NOW/DAY,date),3.17e-8,3.543^.85),.6),1)....} status=500 QTime=4 \n2013-01-08 14:02:16,755 ERROR [solr.servlet.SolrDispatchFilter] - [http-8080-exec-3] - : null:java.lang.NumberFormatException: For input string: \"3.543^.85\"\n        at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1222)\n        at java.lang.Float.parseFloat(Float.java:422)\n        at org.apache.solr.search.FunctionQParser.parseFloat(FunctionQParser.java:131)\n        at org.apache.solr.search.ValueSourceParser$9.parse(ValueSourceParser.java:156)\n        at org.apache.solr.search.FunctionQParser.parseValueSource(FunctionQParser.java:352)\n        at org.apache.solr.search.FunctionQParser.parseValueSourceList(FunctionQParser.java:213)\n        at org.apache.solr.search.ValueSourceParser$49.parse(ValueSourceParser.java:531)\n        at org.apache.solr.search.FunctionQParser.parseValueSource(FunctionQParser.java:352)\n        at org.apache.solr.search.FunctionQParser.parseValueSource(FunctionQParser.java:223)\n        at org.apache.solr.search.ValueSourceParser$71.parse(ValueSourceParser.java:763)\n        at org.apache.solr.search.FunctionQParser.parseValueSource(FunctionQParser.java:352)\n        at org.apache.solr.search.FunctionQParser.parse(FunctionQParser.java:68)\n        at org.apache.solr.search.QParser.getQuery(QParser.java:142)\n        at org.apache.solr.search.ExtendedDismaxQParser.parse(ExtendedDismaxQParserPlugin.java:397)\n        at org.apache.solr.search.QParser.getQuery(QParser.java:142)\n        at org.apache.solr.handler.component.QueryComponent.prepare(QueryComponent.java:117)\n        at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:187)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1815)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:469)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:269)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:293)\n        at org.apache.coyote.http11.Http11NioProcessor.process(Http11NioProcessor.java:889)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:744)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:2274)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n        at java.lang.Thread.run(Thread.java:662)\n\n "
        },
        {
            "author": "Markus Jelsma",
            "id": "comment-13553605",
            "date": "2013-01-15T09:13:50+0000",
            "content": "I've found another curious case where function query is completely mangled:\n\n\n2013-01-09 22:46:26,426 ERROR [solr.core.SolrCore] - [http-8080-exec-15] - : java.lang.NumberFormatException: For input string: \"1000/1000\"\n        at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1222)\n        at java.lang.Float.parseFloat(Float.java:422)\n        at org.apache.solr.search.FunctionQParser.parseFloat(FunctionQParser.java:133)\n        at org.apache.solr.search.ValueSourceParser$9.parse(ValueSourceParser.java:156)\n        at org.apache.solr.search.FunctionQParser.parseValueSource(FunctionQParser.java:354)\n        at org.apache.solr.search.FunctionQParser.parse(FunctionQParser.java:70)\n        at org.apache.solr.search.QParser.getQuery(QParser.java:143)\n        at org.apache.solr.search.ExtendedDismaxQParser.parse(ExtendedDismaxQParserPlugin.java:415)\n        at org.apache.solr.search.QParser.getQuery(QParser.java:143)\n        at org.apache.solr.handler.component.QueryComponent.prepare(QueryComponent.java:118)\n        at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:185)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1750)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:455)\n        at io.openindex.solr.servlet.HttpResponseSolrDispatchFilter.doFilter(HttpResponseSolrDispatchFilter.java:220)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:293)\n        at org.apache.coyote.http11.Http11NioProcessor.process(Http11NioProcessor.java:889)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:744)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:2274)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n        at java.lang.Thread.run(Thread.java:662)\n\n2013-01-09 22:46:26,430 INFO [solr.core.SolrCore] - [http-8080-exec-15] - : [shard_b] webapp=/solr path=/select params={facet=false&tie=0.35&spellcheck.q=test&spellcheck.q=test&q.alt=*:*&facet.method=enum&ssi=5b4fc43933c03c4f&ssi=5b4fc43933c03c4f&fl=md_*+title+id+type+subcollection+host+cat+date+size+lang+image&bq=type:\"text/html\"^4.0&NOW=1357771586406&hl.simple.post=</em>&facet.field={!ex%3Dtype}type&facet.field={!ex%3Dhost}host&facet.field={!ex%3Dcat}cat&facet.field={!ex%3Dlang}lang&hl.fragsize=192&spellcheck.extendedResults=true&f.host.facet.method=fc&hl.fl=content&json.nl=map&spellcheck.collate=true&wt=javabin&rows=10&defType=edismax&pf=content&hl.snippets=1&hl.maxAlternateFieldLength=192&facet.sort=count&hl.alternateField=content&boost=recip(ms(NOW/DAY,date),3.16e-7,1000/1000)&spellcheck=false&spellcheck.maxCollationTries=2&facet.limit=8&hl.simple.pre=<em>&distrib=false&hl=true&shards.tolerant=true&version=2&omitHeader=true&shard.url=idx2:8080/solr/shard_b/|idx3:8080/solr/shard_b/&spellcheck.count=1&qs=30&mm=2<-1+5<-2+6<90%25&facet.mincount=1&uf=-*&ids=http://www....html&qf=content^1.6+title^6.4+url^1.8+h1^4.8+h2^2.3&hl.useFastVectorHighlighter=true&q=test&q=test&isShard=true&ps=50} status=500 QTime=5 \n2013-01-09 22:46:26,430 ERROR [solr.servlet.SolrDispatchFilter] - [http-8080-exec-15] - : null:java.lang.NumberFormatException: For input string: \"1000/1000\"\n        at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1222)\n        at java.lang.Float.parseFloat(Float.java:422)\n        at org.apache.solr.search.FunctionQParser.parseFloat(FunctionQParser.java:133)\n        at org.apache.solr.search.ValueSourceParser$9.parse(ValueSourceParser.java:156)\n        at org.apache.solr.search.FunctionQParser.parseValueSource(FunctionQParser.java:354)\n        at org.apache.solr.search.FunctionQParser.parse(FunctionQParser.java:70)\n        at org.apache.solr.search.QParser.getQuery(QParser.java:143)\n        at org.apache.solr.search.ExtendedDismaxQParser.parse(ExtendedDismaxQParserPlugin.java:415)\n        at org.apache.solr.search.QParser.getQuery(QParser.java:143)\n        at org.apache.solr.handler.component.QueryComponent.prepare(QueryComponent.java:118)\n        at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:185)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1750)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:455)\n        at io.openindex.solr.servlet.HttpResponseSolrDispatchFilter.doFilter(HttpResponseSolrDispatchFilter.java:220)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:293)\n        at org.apache.coyote.http11.Http11NioProcessor.process(Http11NioProcessor.java:889)\n        at org.apache.coyote.http11.Http11NioProtocol$Http11ConnectionHandler.process(Http11NioProtocol.java:744)\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:2274)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n        at java.lang.Thread.run(Thread.java:662)\n\n "
        },
        {
            "author": "Vishnu Mishra",
            "id": "comment-14613485",
            "date": "2015-07-03T22:25:28+0000",
            "content": "I am using solr 4.10.3 and facing the same issue with distributed search. "
        }
    ]
}