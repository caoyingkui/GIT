{
    "id": "SOLR-9871",
    "title": "Java-level deadlock on SolrCore.getSearcher",
    "details": {
        "components": [
            "SolrCloud"
        ],
        "type": "Bug",
        "labels": "",
        "fix_versions": [],
        "affect_versions": "6.2.1",
        "status": "Open",
        "resolution": "Unresolved",
        "priority": "Major"
    },
    "description": "I have a SolrCloud setup with 2 nodes, 4 shards, 2 replicas, ~200mln documents. Sometimes one of the nodes hangs, jstack tells about java-level deadlock:\n\n\nFound one Java-level deadlock:\n=============================\n\"qtp1543727556-8467\":\n  waiting to lock monitor 0x00007f5b6c9d8378 (object 0x000000050dc96730, a java.lang.Object),\n  which is held by \"searcherExecutor-8-thread-1-processing-n:172.19.123.3:18984_solr x:mail_shard1_replica2 s:shard1 c:mail r:core_node8\"\n\"searcherExecutor-8-thread-1-processing-n:172.19.123.3:18984_solr x:mail_shard1_replica2 s:shard1 c:mail r:core_node8\":\n  waiting to lock monitor 0x00007f5aac41cd38 (object 0x000000050ded63e8, a org.apache.solr.update.SolrIndexWriter),\n  which is held by \"commitScheduler-21-thread-1\"\n\"commitScheduler-21-thread-1\":\n  waiting to lock monitor 0x00007f5b6c9d8378 (object 0x000000050dc96730, a java.lang.Object),\n  which is held by \"searcherExecutor-8-thread-1-processing-n:172.19.123.3:18984_solr x:mail_shard1_replica2 s:shard1 c:mail r:core_node8\"\n\nJava stack information for the threads listed above:\n===================================================\n\"qtp1543727556-8467\":\n\tat org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:1749)\n\t- waiting to lock <0x000000050dc96730> (a java.lang.Object)\n\tat org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:1552)\n\tat org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:1487)\n\tat org.apache.solr.request.SolrQueryRequestBase.getSearcher(SolrQueryRequestBase.java:115)\n\tat org.apache.solr.handler.component.QueryComponent.process(QueryComponent.java:308)\n\tat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:295)\n\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:154)\n\tat org.apache.solr.core.SolrCore.execute(SolrCore.java:2089)\n\tat org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:652)\n\tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:459)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:257)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:208)\n\tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1668)\n\tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:581)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\n\tat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\n\tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:226)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1160)\n\tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:511)\n\tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1092)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n\tat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)\n\tat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:119)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)\n\tat org.eclipse.jetty.server.Server.handle(Server.java:518)\n\tat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:308)\n\tat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:244)\n\tat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:273)\n\tat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:95)\n\tat org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)\n\tat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceAndRun(ExecuteProduceConsume.java:246)\n\tat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:156)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:654)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:572)\n\tat java.lang.Thread.run(Thread.java:745)\n\"searcherExecutor-8-thread-1-processing-n:172.19.123.3:18984_solr x:mail_shard1_replica2 s:shard1 c:mail r:core_node8\":\n\tat org.apache.lucene.index.IndexWriter.decRefDeleter(IndexWriter.java:4974)\n\t- waiting to lock <0x000000050ded63e8> (a org.apache.solr.update.SolrIndexWriter)\n\tat org.apache.lucene.index.StandardDirectoryReader.doClose(StandardDirectoryReader.java:381)\n\tat org.apache.lucene.index.IndexReader.decRef(IndexReader.java:251)\n\tat org.apache.solr.search.SolrIndexSearcher.close(SolrIndexSearcher.java:461)\n\tat org.apache.solr.core.SolrCore$2.close(SolrCore.java:1982)\n\tat org.apache.solr.util.RefCounted.decref(RefCounted.java:56)\n\tat org.apache.solr.core.SolrCore.registerSearcher(SolrCore.java:2016)\n\t- locked <0x000000050dc96730> (a java.lang.Object)\n\tat org.apache.solr.core.SolrCore.lambda$getSearcher$5(SolrCore.java:1903)\n\tat org.apache.solr.core.SolrCore$$Lambda$84/1360460105.call(Unknown Source)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n\tat org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:229)\n\tat org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor$$Lambda$3/23599925.run(Unknown Source)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat java.lang.Thread.run(Thread.java:745)\n\"commitScheduler-21-thread-1\":\n\tat org.apache.solr.core.SolrCore.getIndexDir(SolrCore.java:302)\n\t- waiting to lock <0x000000050dc96730> (a java.lang.Object)\n\tat org.apache.solr.core.snapshots.SolrSnapshotMetaDataManager.isSnapshotted(SolrSnapshotMetaDataManager.java:232)\n\t- locked <0x00000004d38deaa0> (a org.apache.solr.core.snapshots.SolrSnapshotMetaDataManager)\n\tat org.apache.solr.core.IndexDeletionPolicyWrapper$IndexCommitWrapper.delete(IndexDeletionPolicyWrapper.java:195)\n\tat org.apache.solr.core.SolrDeletionPolicy.updateCommits(SolrDeletionPolicy.java:199)\n\t- locked <0x0000000519863980> (a org.apache.solr.core.SolrDeletionPolicy)\n\tat org.apache.solr.core.SolrDeletionPolicy.onCommit(SolrDeletionPolicy.java:101)\n\tat org.apache.solr.core.IndexDeletionPolicyWrapper.onCommit(IndexDeletionPolicyWrapper.java:161)\n\tat org.apache.lucene.index.IndexFileDeleter.checkpoint(IndexFileDeleter.java:526)\n\tat org.apache.lucene.index.IndexWriter.finishCommit(IndexWriter.java:3252)\n\t- locked <0x000000050ded63e8> (a org.apache.solr.update.SolrIndexWriter)\n\tat org.apache.lucene.index.IndexWriter.commitInternal(IndexWriter.java:3214)\n\t- locked <0x000000050deed630> (a java.lang.Object)\n\tat org.apache.lucene.index.IndexWriter.commit(IndexWriter.java:3171)\n\tat org.apache.solr.update.DirectUpdateHandler2.commit(DirectUpdateHandler2.java:607)\n\tat org.apache.solr.update.CommitTracker.run(CommitTracker.java:217)\n\tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)\n\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat java.lang.Thread.run(Thread.java:745)\n\nFound 1 deadlock.",
    "attachments": {},
    "issue_links": {},
    "comments": []
}