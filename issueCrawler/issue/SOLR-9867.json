{
    "id": "SOLR-9867",
    "title": "The Solr examples can not always be started after being stopped due to race with loading core.",
    "details": {
        "components": [],
        "type": "Bug",
        "labels": "",
        "fix_versions": [
            "6.6",
            "7.0"
        ],
        "affect_versions": "None",
        "status": "Closed",
        "resolution": "Fixed",
        "priority": "Critical"
    },
    "description": "I'm having trouble when I start up the schemaless example after shutting down.\n\nI first tracked this down to the fact that the run example tool is getting an error when it tries to create the SolrCore (again, it already exists) and so it deletes the cores instance dir which leads to tlog and index lock errors in Solr.\n\nThe reason it seems to be trying to create the core when it already exists is that the run example tool uses a core status call to check existence and because the core is loading, we don't consider it as existing. I added a check to look for core.properties.\n\nThat seemed to let me start up, but my first requests failed because the core was still loading. It appears CoreContainer#getCore  is supposed to be blocking so you don't have this problem, but there must be an issue, because it is not blocking.",
    "attachments": {
        "SOLR-9867-ignore-whitespace.patch": "https://issues.apache.org/jira/secure/attachment/12866188/SOLR-9867-ignore-whitespace.patch",
        "Lucene-Solr-master-MacOSX #3986 Console [Jenkins].htm": "https://issues.apache.org/jira/secure/attachment/12866363/Lucene-Solr-master-MacOSX%20%233986%20Console%20%5BJenkins%5D.htm",
        "SDF init and doFilter in parallel.png": "https://issues.apache.org/jira/secure/attachment/12865616/SDF%20init%20and%20doFilter%20in%20parallel.png",
        "stdout_90": "https://issues.apache.org/jira/secure/attachment/12866270/stdout_90",
        "SOLR-9867-createCoreContainer-fix.patch": "https://issues.apache.org/jira/secure/attachment/12866388/SOLR-9867-createCoreContainer-fix.patch",
        "6x failure 0 docs.txt": "https://issues.apache.org/jira/secure/attachment/12866499/6x%20failure%200%20docs.txt",
        "SOLR-9867-test.patch": "https://issues.apache.org/jira/secure/attachment/12865628/SOLR-9867-test.patch",
        "SOLR-9867.patch": "https://issues.apache.org/jira/secure/attachment/12846227/SOLR-9867.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2016-12-15T04:28:47+0000",
            "author": "Mark Miller",
            "content": "Probably a problem with other examples too, but I have not looked into it. ",
            "id": "comment-15750349"
        },
        {
            "date": "2016-12-16T01:59:49+0000",
            "author": "Alexandre Rafalovitch",
            "content": "Is this with trunk or a particular version? ",
            "id": "comment-15753154"
        },
        {
            "date": "2016-12-19T18:31:36+0000",
            "author": "Mark Miller",
            "content": "This is trunk so far, I have not tested on 6x. ",
            "id": "comment-15761924"
        },
        {
            "date": "2016-12-27T22:57:25+0000",
            "author": "Varun Thacker",
            "content": "Yeah this problem seems to be with other examples as well:\n\nSteps to reproduce:\n\n./bin/solr start -e techproducts\n./bin/solr stop\n./bin/solr start -e techproducts\n\n\n\nThe third step causes the problem:\nWhen we start since techproducts already exists , the start script fails to see that and tries to create the core again leaving Solr in a bad state.\n\nThis doesn't happen in Solr 6.2.1 but happens in Solr 6.3\nHere is the message I get when I run the third step in Solr 6.2.1\n\n\nsolr-6.2.1$ ./bin/solr start -e techproducts\nSolr home directory ~/solr-6.2.1/example/techproducts/solr already exists.\n\nStarting up Solr on port 8983 using command:\nbin/solr start -p 8983 -s \"example/techproducts/solr\"\n\nWaiting up to 30 seconds to see Solr running on port 8983 [|]  \nStarted Solr server on port 8983 (pid=16088). Happy searching!\n\n    \nWARNING: Core 'techproducts' already exists!\nChecked core existence using Core API command:\nhttp://localhost:8983/solr/admin/cores?action=STATUS&core=techproducts\n\n\nSolr techproducts example launched successfully. Direct your Web browser to http://localhost:8983/solr to visit the Solr Admin UI\n\n ",
            "id": "comment-15781464"
        },
        {
            "date": "2016-12-30T23:07:06+0000",
            "author": "Mark Miller",
            "content": "Thanks for looking into this Varun.\n\nI think this behavior was built into CoreContainer previously and must have been removed in a refactoring. Now I see no code that actually waits for a core to load, just the methods on CoreContainer for it.\n\nSo we can restore the expected behavior here and wait for the core to load rather than throw an exception:\n\n\n        if (core != null) {\n          path = path.substring(idx);\n        } else if (cores.isCoreLoading(corename)) { // extra mem barriers, so don't look at this before trying to get core\n          throw new SolrException(ErrorCode.SERVICE_UNAVAILABLE, \"SolrCore is loading\");\n        } else {\n          // the core may have just finished loading\n          core = cores.getCore(corename);\n          if (core != null) {\n            path = path.substring(idx);\n          } \n        }\n\n ",
            "id": "comment-15788522"
        },
        {
            "date": "2017-01-08T14:58:29+0000",
            "author": "Mark Miller",
            "content": "If someone has time to review this, we should get it in for release. ",
            "id": "comment-15809514"
        },
        {
            "date": "2017-01-09T04:14:17+0000",
            "author": "Varun Thacker",
            "content": "I tried out the patch against master and I get this error\n\n\n[master] ~/apache-work/lucene-solr/solr$ ./bin/solr start -e techproducts\n<snip>\n[master] ~/apache-work/lucene-solr/solr$ ./bin/solr stop\n[master] ~/apache-work/lucene-solr/solr$ ./bin/solr start -e techproducts\nSolr home directory /Users/varun/apache-work/lucene-solr/solr/example/techproducts/solr already exists.\n\nStarting up Solr on port 8983 using command:\nbin/solr start -p 8983 -s \"example/techproducts/solr\"\n\nArchiving 1 old GC log files to /Users/varun/apache-work/lucene-solr/solr/example/techproducts/solr/../logs/archived\nArchiving 1 console log files to /Users/varun/apache-work/lucene-solr/solr/example/techproducts/solr/../logs/archived\nRotating solr logs, keeping a max of 9 generations\nWaiting up to 180 seconds to see Solr running on port 8983 [\\]  \nStarted Solr server on port 8983 (pid=53397). Happy searching!\n\n    \nCreating new core 'techproducts' using command:\nhttp://localhost:8983/solr/admin/cores?action=CREATE&name=techproducts&instanceDir=techproducts\n\n\nERROR: Error CREATEing SolrCore 'techproducts': Could not create a new core in /Users/varun/apache-work/lucene-solr/solr/example/techproducts/solr/techproductsas another core is already defined there\n\n\nERROR: Failed to create techproducts using command: [-name, techproducts, -shards, 1, -replicationFactor, 1, -confname, techproducts, -confdir, sample_techproducts_configs, -configsetsDir, /Users/varun/apache-work/lucene-solr/solr/server/solr/configsets, -solrUrl, http://localhost:8983/solr]\n\n\n ",
            "id": "comment-15810626"
        },
        {
            "date": "2017-01-09T04:35:44+0000",
            "author": "Varun Thacker",
            "content": "The patch didn't work because SolrCli Line 2704 makes a call to admin/cores?action=STATUS&core=techproducts} to check if the core exists or not.\n\nIn {HttpSolrCall}} admin requests are handled differently\n\n\nif (handler != null) {\n      solrReq = SolrRequestParsers.DEFAULT.parse(null, path, req);\n      solrReq.getContext().put(CoreContainer.class.getName(), cores);\n      requestType = RequestType.ADMIN;\n      action = ADMIN;\n      return;\n    }\n\n ",
            "id": "comment-15810664"
        },
        {
            "date": "2017-01-20T14:24:19+0000",
            "author": "Jan H\u00f8ydahl",
            "content": "Tested (without patch) on 6.3 and master, and I get the same behavior as you got in 6.2.1 (WARNING: Core 'techproducts' already exists!) ",
            "id": "comment-15831811"
        },
        {
            "date": "2017-01-20T14:31:39+0000",
            "author": "Mark Miller",
            "content": "The bug is essentially a race so no surprise it could work for someone. Almost never does for\nme.  ",
            "id": "comment-15831817"
        },
        {
            "date": "2017-01-20T15:06:00+0000",
            "author": "Jan H\u00f8ydahl",
            "content": "So could a workaround for SOLR-2646 be to introduce a small delay between starting Solr and checking for collections? Or simply double check collection existence using another method in SolrCLI? ",
            "id": "comment-15831889"
        },
        {
            "date": "2017-01-20T15:10:25+0000",
            "author": "Mark Miller",
            "content": "I'm not sure if you can easily work around it outside of hacking the Solr start script/code to do that wait, but yeah, you can work around it with a hack.\n\nWe should fix this bug soon though - if I wasn't traveling I would have been sure to get it in 6.4. Solr has always accepted requests on startup without having to deal with getting a loading core exception. ",
            "id": "comment-15831901"
        },
        {
            "date": "2017-01-21T09:04:42+0000",
            "author": "Cao Manh Dat",
            "content": "I didn't look at the issue carefully, but this is how I normally start schemaless example and restart it\n\n\n./bin/solr start -e techproducts\n./bin/solr stop\n./bin/solr start -s example/techproducts/solr \n\n ",
            "id": "comment-15832895"
        },
        {
            "date": "2017-01-21T17:10:17+0000",
            "author": "Mark Miller",
            "content": "Yeah, and that may work for some, but now there is a race where it won't work in many cases, and it also means we have added a race to many scripting cases similar to our start script issue - if you start Solr and start trying to interact with a core in a script, it will depend on timing how successful you are without introducing retry code.\n\nAnyway, I'll fix this soon, I've just been busy. ",
            "id": "comment-15833063"
        },
        {
            "date": "2017-03-13T16:47:28+0000",
            "author": "Ishan Chattopadhyaya",
            "content": "Moving to 6.5, since 6.4 has already been released. ",
            "id": "comment-15907815"
        },
        {
            "date": "2017-04-27T20:53:36+0000",
            "author": "Mikhail Khludnev",
            "content": "I've added printing response on core status requests. Here is how race looks like\n\nSolr is running on 8983 in standalone mode with status:\n{\n  \"solr_home\":\"/Use..olr/example/techproducts/solr\",\n  \"version\":\"7.0.0-SNAPSHOT eb1671c8f9a472a6ba6ff2516c55110574a64a96 - khludnevm - 2017-04-27 18:02:58\",\n  \"startTime\":\"2017-04-27T15:09:24.404Z\",\n  \"uptime\":\"0 days, 0 hours, 0 minutes, 9 seconds\",\n  \"memory\":\"35.9 MB (%7.3) of 490.7 MB\",\n  \"baseUrl\":\"http://localhost:8983/solr\"}\n\n\nhere are status responses\n\nhttp://localhost:8983/solr/admin/cores?action=STATUS&core=techproducts\n{responseHeader={status=0, QTime=2}, initFailures={}, status={techproducts={}}}\nhttp://localhost:8983/solr/admin/cores?action=STATUS&core=techproducts\n{responseHeader={status=0, QTime=0}, initFailures={}, status={techproducts={}}}\n\nCreating new core 'techproducts' using command:\nhttp://localhost:8983/solr/admin/cores?action=CREATE&name=techproducts&instanceDir=techproducts\n\nERROR: Error CREATEing SolrCore 'techproducts': Unable to create core [techproducts] Caused by: Lock held by this virtual machine: /Users/khludnevm/lucene-solr/solr/example/techproducts/solr/techproducts/data/index/write.lock\n\n\nHere is how it looks like in logs, one core is loading, it responds on STATUS HttpSolrCall, and recieves core create request from SolrCLI. \n\nINFO  - 2017-04-27 15:09:33.021; [   x:techproducts] org.apache.solr.schema.IndexSchema; [techproducts] Schema name=example\nINFO  - 2017-04-27 15:09:34.059; [   ] org.apache.solr.servlet.HttpSolrCall; [admin] webapp=null path=/admin/info/system params={wt=json} status=0 QTime=103\nINFO  - 2017-04-27 15:09:34.132; [   ] org.apache.solr.core.TransientSolrCoreCacheDefault; Allocating transient cache for 2147483647 transient cores\nINFO  - 2017-04-27 15:09:34.133; [   ] org.apache.solr.servlet.HttpSolrCall; [admin] webapp=null path=/admin/cores params={core=techproducts&action=STATUS&wt=json} status=0 QTime=2\nINFO  - 2017-04-27 15:09:34.202; [   x:techproducts] org.apache.solr.rest.RestManager$Registry; Registered ManagedResource impl org.apache.solr.rest.schema.analysis.ManagedWordSetResource\nINFO  - 2017-04-27 15:09:34.202; [   ] org.apache.solr.servlet.HttpSolrCall; [admin] webapp=null path=/admin/info/system params={wt=json} status=0 QTime=61\nINFO  - 2017-04-27 15:09:34.203; [   x:techproducts] org.apache.solr.rest.RestManager$Registry; Registered ManagedResource impl org.apache.solr.rest.schema.analysis.ManagedSynonymFilterFa\nINFO  - 2017-04-27 15:09:34.215; [   x:techproducts] org.apache.solr.schema.IndexSchema; Loaded schema example/1.6 with uniqueid field id\nINFO  - 2017-04-27 15:09:34.216; [   x:techproducts] org.apache.solr.rest.RestManager$Registry; Added observer of type org.apache.solr.rest.schema.analysis.ManagedStopFilterFactory to exi\nINFO  - 2017-04-27 15:09:34.216; [   x:techproducts] org.apache.solr.rest.RestManager$Registry; Added observer of type org.apache.solr.rest.schema.analysis.ManagedSynonymFilterFactory to \nINFO  - 2017-04-27 15:09:34.270; [   ] org.apache.solr.servlet.HttpSolrCall; [admin] webapp=null path=/admin/info/system params={wt=json} status=0 QTime=57\nINFO  - 2017-04-27 15:09:34.282; [   ] org.apache.solr.servlet.HttpSolrCall; [admin] webapp=null path=/admin/cores params={core=techproducts&action=STATUS&wt=json} status=0 QTime=0\nINFO  - 2017-04-27 15:09:34.287; [   ] org.apache.solr.handler.admin.CoreAdminOperation; core create command name=techproducts&action=CREATE&instanceDir=techproducts&wt=json\nINFO  - 2017-04-27 15:09:34.294; [   x:techproducts] org.apache.solr.core.CoreContainer; Creating SolrCore 'techproducts' using configuration from instancedir /Users/khl\n\n  ",
            "id": "comment-15987650"
        },
        {
            "date": "2017-04-28T20:00:20+0000",
            "author": "Mikhail Khludnev",
            "content": "SOLR-9867-test.patch enabling existing test (Thank's to Timothy Potter, it's was an enormous effort, Tim!).\nOk. CoreAdminOperation.getCoreStatus(CoreContainer, String, boolean) is completely ignorant to CoreContainer.isCoreLoading(String), I can explain this. It's ok.  ",
            "id": "comment-15989383"
        },
        {
            "date": "2017-04-28T20:08:07+0000",
            "author": "Mikhail Khludnev",
            "content": "SDF init and doFilter in parallel.png here is what I can't explain. SolrDispatchFilter.init() and doFilter() is running in parallel. How is it possible? It's the same SolrDispatchFilter instance. Can it be caused just by JettyRunner usage in test?    ",
            "id": "comment-15989390"
        },
        {
            "date": "2017-04-28T22:25:59+0000",
            "author": "Mikhail Khludnev",
            "content": "\ndiff --git a/solr/core/src/java/org/apache/solr/servlet/SolrDispatchFilter.java b/solr/core/src/java/org/apache/solr/servlet/SolrDispatchFilter.java\nindex 39ccadc..ab46f19 100644\n--- a/solr/core/src/java/org/apache/solr/servlet/SolrDispatchFilter.java\n+++ b/solr/core/src/java/org/apache/solr/servlet/SolrDispatchFilter.java\n@@ -96,6 +96,8 @@\n   private Boolean testMode = null;\n   private boolean isV2Enabled = !\"true\".equals(System.getProperty(\"disable.v2.api\", \"false\"));\n \n+  private volatile boolean initIsDone;\n+\n   /**\n    * Enum to define action that needs to be processed.\n    * PASSTHROUGH: Pass through to Restlet via webapp.\n@@ -182,6 +184,7 @@\n     }\n \n     log.trace(\"SolrDispatchFilter.init() done\");\n+    initIsDone = true;\n   }\n \n   private void setupJvmMetrics()  {\n@@ -307,6 +310,7 @@\n   }\n   \n   public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain, boolean retry) throws IOException, ServletException {\n+    assert initIsDone:\"I swear\";\n     if (!(request instanceof HttpServletRequest)) return;\n     try {\n\n\n\n\n305  INFO  (Thread-1) [    ] o.a.s.s.SolrDispatchFilter  ___      _       Welcome to Apache Solr\u2122 version 7.0.0\n305  INFO  (Thread-1) [    ] o.a.s.s.SolrDispatchFilter / __| ___| |_ _   Starting in standalone mode on port 52215\n305  INFO  (Thread-1) [    ] o.a.s.s.SolrDispatchFilter \\__ \\/ _ \\ | '_|  Install dir: null\n321  INFO  (Thread-1) [    ] o.a.s.s.SolrDispatchFilter |___/\\___/_|_|    Start time: 2017-04-28T22:25:03.738Z\n335  INFO  (Thread-1) [    ] o.a.s.c.SolrResourceLoader solr home defaulted to 'solr/' (could not find system property or JNDI)\n341  INFO  (Thread-1) [    ] o.a.s.c.SolrXmlConfig Loading container configuration from /private/var/folders/rg/fr1t3mx9391f1_g0xs8wtq2d1xv078/T/solr.util.TestSolrCLIRunExample_E157FC17061E2B1D-001/tempDir-001/schemaless/solr/solr.xml\n465  WARN  (qtp151277770-21) [    ] o.e.j.s.ServletHandler Error for /solr/admin/info/system\njava.lang.AssertionError: I swear\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:313)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:309)\n\tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1699)\n\tat org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:139)\n\tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1699)\n\tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:582)\n\tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:224)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1180)\n\tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:512)\n\tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1112)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n\tat org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:462)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)\n\tat org.eclipse.jetty.server.Server.handle(Server.java:534)\n\n\nSo, what we gonna do, then...  ",
            "id": "comment-15989536"
        },
        {
            "date": "2017-04-29T22:03:02+0000",
            "author": "Mikhail Khludnev",
            "content": "SOLR-9867.patch is on 6x. It enables testTechproductsExample and makes beast happy about it. Therefore, there should be some work to fix tests, which are currently failing on ci.  \n\n\tthe patch makes core status aware of loading cores and latches SolrDispatchFilter.doFilter on init. Otherwise, status request might be handled before core starts load in background. I always though that a servlet container provides init/doFilter latching, so naive.\n\tperhaps, instead of latch we can assign cores strictly at the end of init. What do you think?\n\tpatch also blocks container closing, until core loading is stopped with failure.\n\tand also it makes run example tool spin until core is loaded before search.\n\n\n\nConcerns?  ",
            "id": "comment-15990057"
        },
        {
            "date": "2017-04-30T05:20:58+0000",
            "author": "Erick Erickson",
            "content": "Fixed some indentation issues, but otherwise identical.\n\nFWIW, I'm curious to see if this is related to SOLR-10562 and the recent SolrCloudExampleTest failures so I'm beasting this latter tonight. Sometime soon I'll uncrank the debugging I had in SOLR-10562.\n\nAll this has to do with reloading, so I figured I'd at least see. ",
            "id": "comment-15990128"
        },
        {
            "date": "2017-04-30T06:06:14+0000",
            "author": "Mike Drob",
            "content": "Great idea to add isLoading info.\n\nIs latch.await() on every request going to be a performance impact? I don't have a jdk source on this computer to check.\n\nperhaps, instead of latch we can assign cores strictly at the end of init. What do you think?\nDepends on if we want early requests to fail or to wait, no?\n\npatch also blocks container closing, until core loading is stopped with failure.\ncouldn't this take a while? How did you decide 10 seconds? ",
            "id": "comment-15990142"
        },
        {
            "date": "2017-04-30T16:17:36+0000",
            "author": "Erick Erickson",
            "content": "Well, it was a nice idea but apparently this JIRA doesn't fix the recent SolrCloudExampleTest failures. Pity. ",
            "id": "comment-15990278"
        },
        {
            "date": "2017-04-30T16:36:10+0000",
            "author": "Mikhail Khludnev",
            "content": "Right. Heads up SOLR-10588 ",
            "id": "comment-15990284"
        },
        {
            "date": "2017-05-03T14:32:42+0000",
            "author": "Mikhail Khludnev",
            "content": "also attaching SOLR-9867-ignore-whitespace.patch to make review easier since original SOLR-9867.patch has too many identations. \nKey stuff\n\n\tI've removed SDF.init() latch, and just assign volatile SDF.cores at the end of init() since SDF.doFilter() already has a precondition check SDF.cores!=null.\n\tthis change introduces new /admin/cores?action=STATUS& response:\n\n{ name:foo, isLoaded:false, isLoading:true }\n\n\n\tSolrCLI waits for a core to come up 1 min max with 1 sec poll interval.\n\n\n\nBTW\nWhat about committing it tomorrow? \nAlso\nAll TestSolrCLIRunExample tests runs just for 47 secs at my laptop. Should it still be marked as @Slow ",
            "id": "comment-15994981"
        },
        {
            "date": "2017-05-03T14:40:09+0000",
            "author": "Mikhail Khludnev",
            "content": "Mike Drob,\nperhaps, instead of latch we can assign cores strictly at the end of init. What do you think?\nIndeed! Thanks for the hint!\nDepends on if we want early requests to fail or to wait, no?\nI suppose it's fine since we already have this check.\ncouldn't this take a while? How did you decide 10 seconds?\nI hardly remember how exactly I get to it. Now I set it to 30 sec (almost no one experience it, since most of the users wait till Solr load cores before stop it), internally it makes 0.5 sec polls, so it doesn't really matter. But I'm happy to put any number there which makes tests pass.  ",
            "id": "comment-15994993"
        },
        {
            "date": "2017-05-03T15:19:52+0000",
            "author": "Erick Erickson",
            "content": "got the patch, I'm starting to give it a beast run. I notice that you also changed TestSolrCLIRunExample but I'm beasting SolrCloudExampleTest. Let me know if I should beast TestSolrCLIRunExample instead. ",
            "id": "comment-15995053"
        },
        {
            "date": "2017-05-03T15:30:52+0000",
            "author": "Mikhail Khludnev",
            "content": "Erick Erickson,\nHere we need to test/beast TestSolrCLIRunExample for sure. We've done with SolrCloudExampleTest at SOLR-10588 ",
            "id": "comment-15995077"
        },
        {
            "date": "2017-05-03T15:33:19+0000",
            "author": "Erick Erickson",
            "content": "Got it, running TestSolrCLIRunExample now. ",
            "id": "comment-15995083"
        },
        {
            "date": "2017-05-03T19:31:12+0000",
            "author": "Erick Erickson",
            "content": "Out of 1,000 runs I see only one problem, our old friend ObjectTracker:\n\nThrowable #1: java.lang.AssertionError: ObjectTracker found 5 object(s) that were not released!!! [NRTCachingDirectory, NRTCachingDirectory, NRTCachingDirectory, MDCAwareThreadPoolExecutor, TransactionLog]\n\nAll other 999 showed \"BUILD SUCCESSFUL\" ",
            "id": "comment-15995485"
        },
        {
            "date": "2017-05-03T19:41:12+0000",
            "author": "Mikhail Khludnev",
            "content": "It sounds like it can go off tomorrow.\nErick Erickson, can you share an output from our old friend by any chance?  ",
            "id": "comment-15995503"
        },
        {
            "date": "2017-05-03T20:59:53+0000",
            "author": "Erick Erickson",
            "content": "Here's the failing log. Thank heavens for Mark's beasting program.... ",
            "id": "comment-15995672"
        },
        {
            "date": "2017-05-03T21:35:43+0000",
            "author": "Mikhail Khludnev",
            "content": "\n   [junit4]   2> 35073 INFO  (qtp1031286021-158) [n:localhost:32820_solr    ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/collections params={replicationFactor=2&maxShardsPerNode=4&collection.configName=testCloudExamplePrompt&name=testCloudExamplePrompt&action=CREATE&numShards=2&wt=json} status=0 QTime=5117\n   [junit4]   2> 35108 INFO  (qtp1031286021-207) [n:localhost:32820_solr c:testCloudExamplePrompt s:shard2 r:core_node1 x:testCloudExamplePrompt_shard2_replica1] o.a.s.h.SolrConfigHandler Executed config commands successfully and persisted to ZK [{\"set-property\":{\"updateHandler.autoSoftCommit.maxTime\":\"3000\"}}]\n   [junit4]   2> 35111 INFO  (qtp1031286021-207) [n:localhost:32820_solr c:testCloudExamplePrompt s:shard2 r:core_node1 x:testCloudExamplePrompt_shard2_replica1] o.a.s.h.SolrConfigHandler Waiting up to 30 secs for 4 replicas to set the property overlay to be of version 0 for collection testCloudExamplePrompt\n   [junit4]   2> 35112 INFO  (Thread-81) [n:localhost:32820_solr    ] o.a.s.c.SolrCore config update listener called for core testCloudExamplePrompt_shard2_replica2\n   [junit4]   2> 35115 INFO  (solrHandlerExecutor-81-thread-1-processing-n:localhost:32820_solr x:testCloudExamplePrompt_shard2_replica1 s:shard2 c:testCloudExamplePrompt r:core_node1) [n:localhost:32820_solr c:testCloudExamplePrompt s:shard2 r:core_node1 x:testCloudExamplePrompt_shard2_replica1] o.a.s.h.SolrConfigHandler Time elapsed : 0 secs, maxWait 30\n   [junit4]   2> 35115 INFO  (Thread-81) [n:localhost:32820_solr    ] o.a.s.c.SolrCore core reload testCloudExamplePrompt_shard2_replica2\n\n\nCollection has been created, param update is sent, Zk listener (Thread-81) starts core reload \n\n   [junit4]   2> 39099 INFO  (qtp1031286021-155) [n:localhost:32820_solr    ] o.a.s.m.SolrMetricManager Closing metric reporters for registry=solr.core.testCloudExamplePrompt.shard2.replica2, tag=149464127\n   [junit4]   2> 39099 INFO  (qtp1031286021-155) [n:localhost:32820_solr    ] o.a.s.m.SolrMetricManager Closing metric reporters for registry=solr.collection.testCloudExamplePrompt.shard2.leader, tag=149464127\n   [junit4]   2> 39106 INFO  (zkCallback-16-thread-1-processing-n:localhost:32820_solr) [n:localhost:32820_solr    ] o.a.s.c.c.ZkStateReader A cluster state change: [WatchedEvent state:SyncConnected type:NodeDataChanged path:/collections/testCloudExamplePrompt/state.json] for collection [testCloudExamplePrompt] has occurred - updating... (live nodes size: [1])\n   [junit4]   2> 39106 INFO  (qtp1031286021-221) [n:localhost:32820_solr    ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={deleteInstanceDir=true&core=testCloudExamplePrompt_shard1_replica2&qt=/admin/cores&deleteDataDir=true&action=UNLOAD&wt=javabin&version=2} status=0 QTime=107\n   [junit4]   2> 39107 INFO  (Thread-81) [n:localhost:32820_solr c:testCloudExamplePrompt s:shard2 r:core_node3 x:testCloudExamplePrompt_shard2_replica2] o.a.s.m.r.SolrJmxReporter JMX monitoring for 'solr.core.testCloudExamplePrompt.shard1.replica2' (registry 'solr.core.testCloudExamplePrompt.shard1.replica2') enabled at server: com.sun.jmx.mbeanserver.JmxMBeanServer@167c2a09\n   [junit4]   2> 39108 INFO  (qtp1031286021-187) [n:localhost:32820_solr    ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={deleteInstanceDir=true&core=testCloudExamplePrompt_shard2_replica1&qt=/admin/cores&deleteDataDir=true&action=UNLOAD&wt=javabin&version=2} status=0 QTime=77\n   [junit4]   2> 39109 WARN  (zkCallback-16-thread-1-processing-n:localhost:32820_solr) [n:localhost:32820_solr    ] o.a.s.c.LeaderElector Our node is no longer in line to be leader\n   [junit4]   2> 39109 WARN  (zkCallback-16-thread-2-processing-n:localhost:32820_solr) [n:localhost:32820_solr    ] o.a.s.c.LeaderElector Our node is no longer in line to be leader\n   [junit4]   2> 39113 WARN  (Thread-81) [n:localhost:32820_solr c:testCloudExamplePrompt s:shard2 r:core_node3 x:testCloudExamplePrompt_shard2_replica2] o.a.s.c.ZkController listener throws error\n   [junit4]   2> org.apache.solr.common.SolrException: Unable to reload core [testCloudExamplePrompt_shard1_replica2]\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.reload(CoreContainer.java:1197)\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.lambda$getConfListener$18(SolrCore.java:2953)\n   [junit4]   2> \tat org.apache.solr.cloud.ZkController.lambda$fireEventListeners$4(ZkController.java:2350)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:748)\n   [junit4]   2> Caused by: java.lang.NullPointerException\n   [junit4]   2> \tat org.apache.solr.metrics.SolrMetricManager.loadShardReporters(SolrMetricManager.java:1032)\n   [junit4]   2> \tat org.apache.solr.metrics.SolrCoreMetricManager.loadReporters(SolrCoreMetricManager.java:89)\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.<init>(SolrCore.java:897)\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.reload(SolrCore.java:648)\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.reload(CoreContainer.java:1184)\n   [junit4]   2> \t... 3 more\n   [junit4]   2> 39114 INFO  (Thread-81) [n:localhost:32820_solr c:testCloudExamplePrompt s:shard2 r:core_node3 x:testCloudExamplePrompt_shard2_replica2] o.a.s.c.SolrCore config update listener called for core testCloudExamplePrompt_shard2_replica1\n   [junit4]   2> 39114 INFO  (Thread-81) [n:localhost:32820_solr c:testCloudExamplePrompt s:shard2 r:core_node3 x:testCloudExamplePrompt_shard2_replica2] o.a.s.c.SolrCore config update listener called for core testCloudExamplePrompt_shard1_replica1\n   [junit4]   2> 39122 INFO  (qtp1031286021-155) [n:localhost:32820_solr    ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={deleteInstanceDir=true&core=testCloudExamplePrompt_shard2_replica2&qt=/admin/cores&deleteDataDir=true&action=UNLOAD&wt=javabin&version=2} status=0 QTime=89\n   [junit4]   2> 39122 INFO  (qtp1031286021-208) [n:localhost:32820_solr    ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={deleteInstanceDir=true&core=testCloudExamplePrompt_shard1_replica1&qt=/admin/cores&deleteDataDir=true&action=UNLOAD&wt=javabin&version=2} status=0 QTime=116\n   [junit4]   2> 39840 INFO  (qtp1031286021-207) [n:localhost:32820_solr    ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/collections params={name=testCloudExamplePrompt&action=DELETE&wt=json} status=0 QTime=867\n\n\nCore unloading (qtp1031286021-155) closed Metrics's registry and right after that reloading core tries to register in it. This causes NPE, which leaks the \"old\" core, don't know why. \n\nI don't consider it as a blocker for commit. WDYT?   ",
            "id": "comment-15995734"
        },
        {
            "date": "2017-05-03T22:22:34+0000",
            "author": "Erick Erickson",
            "content": "It's nothing new I don't think. Possibly related to Shalin's comment on SOLR-10562?\n\nSo let's go ahead and commit and perhaps beast it again when something happens on 10562? ",
            "id": "comment-15995801"
        },
        {
            "date": "2017-05-04T06:20:43+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 32b7791fa8019aff2fca65c06deda48a6360da41 in lucene-solr's branch refs/heads/master from Mikhail Khludnev\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=32b7791 ]\n\nSOLR-9867: fixing TestSolrCLIRunExample.testTechproductsExample\n\n\n\tSolrDispatchFilter.doFilter rejects invocation until init() is completed.\n\tintroducing isLoaded=false, isLoading=true core status\n\tblocking shutdown until core loading stops\n\tlooping run example tool while core is loading 1 min max.\n\n ",
            "id": "comment-15996238"
        },
        {
            "date": "2017-05-04T06:33:25+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 62b0458166dda2a83aee3e348ae76ea75542f6b4 in lucene-solr's branch refs/heads/branch_6x from Mikhail Khludnev\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=62b0458 ]\n\nSOLR-9867: fixing TestSolrCLIRunExample.testTechproductsExample\n\n\n\tSolrDispatchFilter.doFilter rejects invocation until init() is completed.\n\tintroducing isLoaded=false, isLoading=true core status\n\tblocking shutdown until core loading stops\n\tlooping run example tool while core is loading 1 min max.\n\n ",
            "id": "comment-15996251"
        },
        {
            "date": "2017-05-04T07:43:03+0000",
            "author": "Mikhail Khludnev",
            "content": "Erick Erickson I spin off SOLR-10605 since SOLR-9867 is about TestSolrCLIRunExample.testTechproductsExample().\nPlease comment on it.   ",
            "id": "comment-15996302"
        },
        {
            "date": "2017-05-04T08:22:19+0000",
            "author": "Mikhail Khludnev",
            "content": "Test passed.\nhttps://builds.apache.org/job/Lucene-Solr-Tests-6.x/861/testReport/org.apache.solr.util/TestSolrCLIRunExample/testTechproductsExample/ ",
            "id": "comment-15996337"
        },
        {
            "date": "2017-05-04T09:22:37+0000",
            "author": "Mikhail Khludnev",
            "content": "failure \nhttps://jenkins.thetaphi.de/job/Lucene-Solr-master-MacOSX/3986/testReport/org.apache.solr.util/TestSolrCLIRunExample/testTechproductsExample/\n[^Lucene-Solr-master-MacOSX #3986 Console \\[Jenkins\\].htm]\n\njava.lang.AssertionError: expected 32 docs in the techproducts example but found 0\n\n ",
            "id": "comment-15996426"
        },
        {
            "date": "2017-05-04T10:26:06+0000",
            "author": "Andrey Kudryavtsev",
            "content": "\nI've removed SDF.init() latch, and just assign volatile SDF.cores at the end of init() since SDF.doFilter() already has a precondition check SDF.cores!=null.\n\nNot sure whether it helped - there is an assignment for cores in createCoreContainer() ",
            "id": "comment-15996505"
        },
        {
            "date": "2017-05-04T12:40:54+0000",
            "author": "Mikhail Khludnev",
            "content": "Thanks, Andrey Kudryavtsev. \nI suppose I can commit this SOLR-9867-createCoreContainer-fix.patch fix now since it's what I expected from the code.  ",
            "id": "comment-15996649"
        },
        {
            "date": "2017-05-04T12:46:16+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 30f1422ba955a38c37b1ec97244ebb7ede9ee7be in lucene-solr's branch refs/heads/master from Mikhail Khludnev\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=30f1422 ]\n\nSOLR-9867: make sure cores are assigned in the end of SolrDispatchFilter.createCoreContainer() only ",
            "id": "comment-15996661"
        },
        {
            "date": "2017-05-04T12:48:16+0000",
            "author": "ASF subversion and git services",
            "content": "Commit b4f936c7367dfaff6edc75fdce20ea383d0c1dd1 in lucene-solr's branch refs/heads/branch_6x from Mikhail Khludnev\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b4f936c ]\n\nSOLR-9867: make sure cores are assigned in the end of SolrDispatchFilter.createCoreContainer() only ",
            "id": "comment-15996664"
        },
        {
            "date": "2017-05-04T13:11:36+0000",
            "author": "Mikhail Khludnev",
            "content": "it seems like it wasn't a great idea.  ",
            "id": "comment-15996703"
        },
        {
            "date": "2017-05-04T13:19:47+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 1534b6219fa99f7a64f372778e727382e256b423 in lucene-solr's branch refs/heads/master from Mikhail Khludnev\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=1534b62 ]\n\nSOLR-9867: rollback SDF.createCoreContainer(). disable testTechproductsExample ",
            "id": "comment-15996711"
        },
        {
            "date": "2017-05-04T13:21:09+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 72e76138ce7d9ec21d3178eb6ee65908792d0614 in lucene-solr's branch refs/heads/branch_6x from Mikhail Khludnev\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=72e7613 ]\n\nSOLR-9867: rollback SDF.createCoreContainer(). disable testTechproductsExample ",
            "id": "comment-15996712"
        },
        {
            "date": "2017-05-04T13:23:28+0000",
            "author": "Mikhail Khludnev",
            "content": "rolled back SDF.createCoreContainer(), disabled testTechproductsExample\nSince it seems like it breaks JvmMetricsTest.testSetupJvmMetrics at least.  ",
            "id": "comment-15996716"
        },
        {
            "date": "2017-05-04T13:55:36+0000",
            "author": "Andrey Kudryavtsev",
            "content": "But what if we, you know....\n\n\n-  private void setupJvmMetrics()  {\n+  private void setupJvmMetrics(CoreContainer cores)  {\n     SolrMetricManager metricManager = cores.getMetricManager();\n     final Set<String> hiddenSysProps = cores.getConfig().getHiddenSysProps();\n     try {\n@@ -247,7 +247,7 @@ public class SolrDispatchFilter extends BaseSolrFilter {\n    */\n   protected CoreContainer createCoreContainer(Path solrHome, Properties extraProperties) {\n     NodeConfig nodeConfig = loadNodeConfig(solrHome, extraProperties);\n-    cores = new CoreContainer(nodeConfig, extraProperties, true);\n+    CoreContainer cores = new CoreContainer(nodeConfig, extraProperties, true);\n     cores.load();\n     return cores;\n   }\n\n ",
            "id": "comment-15996760"
        },
        {
            "date": "2017-05-04T14:09:58+0000",
            "author": "Mikhail Khludnev",
            "content": "Andrey Kudryavtsev, where have you been an hour ago?   ",
            "id": "comment-15996780"
        },
        {
            "date": "2017-05-04T14:26:41+0000",
            "author": "Mikhail Khludnev",
            "content": "Ok. SOLR-9867.patch let's make cores assigned once, again.  ",
            "id": "comment-15996804"
        },
        {
            "date": "2017-05-04T15:05:32+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 5eb4a8d71b491ca7f389b4dc7414dbc1a2620ae2 in lucene-solr's branch refs/heads/master from Mikhail Khludnev\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=5eb4a8d ]\n\nSOLR-9867: fixing JvmMetricsTest broken earlier, bring back testTechproductsExample()\nand single SDF.cores assignment. ",
            "id": "comment-15996883"
        },
        {
            "date": "2017-05-04T15:30:30+0000",
            "author": "ASF subversion and git services",
            "content": "Commit b59f816e6204e59dbb9bfde464032cabb8ba0d50 in lucene-solr's branch refs/heads/branch_6x from Mikhail Khludnev\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b59f816 ]\n\nSOLR-9867: fixing JvmMetricsTest broken earlier, bring back testTechproductsExample()\nand single SDF.cores assignment. ",
            "id": "comment-15996932"
        },
        {
            "date": "2017-05-04T21:53:26+0000",
            "author": "Mikhail Khludnev",
            "content": "6x failure 0 docs.txt\nhttps://jenkins.thetaphi.de/job/Lucene-Solr-6.x-Linux/3438/consoleFull\n\n   [junit4]   2> 2187212 INFO  (qtp33229559-24974) [    ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={name=techproducts&action=CREATE&instanceDir=techproducts&wt=json} status=0 QTime=822\n   [junit4]   1> SimplePostTool version 5.0.0\n   [junit4]   1> Posting files to [base] url http://localhost:36619/solr/techproducts/update using content-type application/xml...\n...\n   [junit4]   1> 14 files indexed.\n   [junit4]   1> COMMITting Solr index changes to http://localhost:36619/solr/techproducts/update...\n   [junit4]   1> Time spent: 0:00:00.017\n   [junit4]   2> 2187234 INFO  (qtp33229559-24974) [    ] o.a.s.c.S.Request [techproducts]  webapp=/solr path=/select params={q=*:*&wt=javabin&version=2} hits=0 status=0 QTime=0\n   [junit4]   2> 2187234 WARN  (TEST-TestSolrCLIRunExample.testTechproductsExample-seed#[6C573D0F56B69777]) [    ] o.a.s.u.TestSolrCLIRunExample Going to wait for 1 second before re-trying query for techproduct example docs ...\n   [junit4]   2> 2188237 INFO  (qtp33229559-24972) [    ] o.a.s.c.S.Request [techproducts]  webapp=/solr path=/select params={q=*:*&wt=javabin&version=2} hits=0 status=0 QTime=0\n   [junit4]   2> 2188237 INFO  (TEST-TestSolrCLIRunExample.testTechproductsExample-seed#[6C573D0F56B69777]) [    ] o.a.s.SolrTestCaseJ4 ###Ending testTechproductsExample\n\nThrowable #1: java.lang.AssertionError: expected 32 docs in the techproducts example but found 0,\n\n\nUpdates come in 17 ms and left no update activity log. What is it?  ",
            "id": "comment-15997496"
        },
        {
            "date": "2017-05-04T22:33:49+0000",
            "author": "Mikhail Khludnev",
            "content": "the same is here\nposttool throw xmls to nowhere in 2 ms, and .. nothing.\n\n  [junit4]   2> 2054068 INFO  (qtp132288369-20302) [    x:techproducts] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={name=techproducts&action=CREATE&instanceDir=techproducts&wt=json} status=0 QTime=454\n   [junit4]   1> SimplePostTool version 5.0.0\n   [junit4]   1> Posting files to [base] url http://localhost:43383/solr/techproducts/update using content-type application/xml...\n   [junit4]   1> POSTing file money.xml to [base]\n....\n   [junit4]   1> POSTing file ipod_other.xml to [base]\n   [junit4]   1> 14 files indexed.\n   [junit4]   1> COMMITting Solr index changes to http://localhost:43383/solr/techproducts/update...\n   [junit4]   1> Time spent: 0:00:00.002\n   [junit4]   2> 2054075 INFO  (qtp132288369-20305) [    x:techproducts] o.a.s.c.S.Request [techproducts]  webapp=/solr path=/select params={q=*:*&wt=javabin&version=2} hits=0 status=0 QTime=0\n   [junit4]   2> 2054075 WARN  (TEST-TestSolrCLIRunExample.testTechproductsExample-seed#[51307655FACE2661]) [    ] o.a.s.u.TestSolrCLIRunExample Going to wait for 1 second before re-trying query for techproduct example docs ...\n   [junit4]   2> 2055078 INFO  (qtp132288369-20305) [    x:techproducts] o.a.s.c.S.Request [techproducts]  webapp=/solr path=/select params={q=*:*&wt=javabin&version=2} hits=0 status=0 QTime=1\n   [junit4]   2> 2055079 INFO  (TEST-TestSolrCLIRunExample.testTechproductsExample-seed#[51307655FACE2661]) [    ] o.a.s.SolrTestCaseJ4 ###Ending testTechproductsExample\n\n  \nIs it super asynchronous?  ",
            "id": "comment-15997544"
        },
        {
            "date": "2017-05-04T23:17:53+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 56851d6e6b781516f06b7203d60f6ad117ea5091 in lucene-solr's branch refs/heads/branch_6x from Mikhail Khludnev\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=56851d6 ]\n\nSOLR-9867: @Ignore TestSolrCLIRunExample.testTechproductsExample() ",
            "id": "comment-15997574"
        },
        {
            "date": "2017-05-04T23:20:48+0000",
            "author": "ASF subversion and git services",
            "content": "Commit c6ebee6a49e82f53090adf95836996ffecf0bb1c in lucene-solr's branch refs/heads/master from Mikhail Khludnev\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c6ebee6 ]\n\nSOLR-9867: @Ignore TestSolrCLIRunExample.testTechproductsExample() ",
            "id": "comment-15997580"
        },
        {
            "date": "2017-05-05T18:29:11+0000",
            "author": "Andrey Kudryavtsev",
            "content": "\n   [junit4]   1> POSTing file money.xml to [base]\n....\n   [junit4]   1> POSTing file ipod_other.xml to [base]\n   [junit4]   1> 14 files indexed.\n   [junit4]   1> COMMITting Solr index changes to http://localhost:43383/solr/techproducts/update...\n   [junit4]   1> Time spent: 0:00:00.002\n\n\n\n\n if everything works as expected there should be Solr's logs among client's logs. All that\n\n17062 INFO  (qtp638502344-15) [    x:techproducts] o.a.s.u.p.LogUpdateProcessorFactory [techproducts]  webapp=/solr path=/update params={}{add=[EN7800GTX/2DHTV/256M (1566581601311129600), 100-435805 (1566581601326858240)]} 0 20\n\n\n\n\nand etc.\n\nI feel like it might be a test issue, because if one sets SimplePostTool.mockMode to true, issue will reproduce.  ",
            "id": "comment-15998732"
        },
        {
            "date": "2017-05-05T20:14:58+0000",
            "author": "Mikhail Khludnev",
            "content": "Thanks, Andrey Kudryavtsev the finding is priceless, let's tackle it SOLR-10614 later. \nNow, urging by SOLR-10611 we need to bring the latch back again under SOLR-10615.  ",
            "id": "comment-15998895"
        }
    ]
}