{
    "id": "SOLR-7559",
    "title": "Cannot use Faceting Feature while using/mlt handler",
    "details": {
        "components": [
            "MoreLikeThis"
        ],
        "type": "Bug",
        "labels": "",
        "fix_versions": [],
        "affect_versions": "5.1",
        "status": "Open",
        "resolution": "Unresolved",
        "priority": "Major"
    },
    "description": "When sending a query using the /mlt handler with faceting enabled, Solr returns an NPE.  The exception is as follows:\n\n\nat\norg.apache.solr.request.SimpleFacets.getHeatmapCounts(SimpleFacets.java:1555)\nat\norg.apache.solr.request.SimpleFacets.getFacetCounts(SimpleFacets.java:284)\nat\norg.apache.solr.handler.MoreLikeThisHandler.handleRequestBody(MoreLikeThisHandler.java:233)\nat\norg.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:143)\nat org.apache.solr.core.SolrCore.execute(SolrCore.java:1984)\nat\norg.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:829)\nat\norg.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:446)\nat\norg.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:220)\nat\norg.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)\nat\norg.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:455)\nat\norg.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)\nat\norg.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:557)\nat\norg.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231)\nat\norg.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1075)\nat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:384)\nat\norg.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)\nat\norg.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1009)\nat\norg.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)\nat\norg.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:255)\nat\norg.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:154)\nat\norg.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)\nat org.eclipse.jetty.server.Server.handle(Server.java:368)\nat\norg.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:489)\nat\norg.eclipse.jetty.server.BlockingHttpConnection.handleRequest(BlockingHttpConnection.java:53)\nat\norg.eclipse.jetty.server.AbstractHttpConnection.headerComplete(AbstractHttpConnection.java:942)\nat\norg.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete(AbstractHttpConnection.java:1004)\nat org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:640)\nat org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235)\nat\norg.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:72)\nat\norg.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:264)\nat\norg.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608)\nat\norg.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543)\nat java.lang.Thread.run(Thread.java:745)\n\nThe issue appears to start in the MoreLikeThisHandler.java class, line 233:\n\n\n  228 if (params.getBool(FacetParams.FACET, false)) {\n  229           if (mltDocs.docSet == null) \nUnknown macro: {  230             rsp.add(\"facet_counts\", null);  231           } \n else \nUnknown macro: {  232             SimpleFacets f = new SimpleFacets(req, mltDocs.docSet, params);  233             rsp.add(\"facet_counts\", f.getFacetCounts());  234           } \n  235         }\n\nWhen the above constructor is used in the SimpleFacets class it sets the ResponseBuilder object in that class to null, which is what causes the NPE to be thrown when getHeatMapFacets() is called from getFacetCounts()\n\n\n  129   public SimpleFacets(SolrQueryRequest req,\n  130                       DocSet docs,\n  131                       SolrParams params) \nUnknown macro: {  132     this(req,docs,params,null);  133   } \n  134 \n  135   public SimpleFacets(SolrQueryRequest req,\n  136                       DocSet docs,\n  137                       SolrParams params,\n  138                       ResponseBuilder rb) \nUnknown macro: {  139     this.req = req;  140     this.searcher = req.getSearcher();  141     this.docs = this.docsOrig = docs;  142     this.params = orig = params;  143     this.required = new RequiredSolrParams(params);  144     this.rb = rb;  145   } \n  146 \n\n\n  129   public SimpleFacets(SolrQueryRequest req,\n  130                       DocSet docs,\n  131                       SolrParams params) \nUnknown macro: {  132     this(req,docs,params,null);  133   } \n  134 \n  135   public SimpleFacets(SolrQueryRequest req,\n  136                       DocSet docs,\n  137                       SolrParams params,\n  138                       ResponseBuilder rb) \nUnknown macro: {  139     this.req = req;  140     this.searcher = req.getSearcher();  141     this.docs = this.docsOrig = docs;  142     this.params = orig = params;  143     this.required = new RequiredSolrParams(params);  144     this.rb = rb;  145   } \n  146",
    "attachments": {
        "SOLR-7559.patch": "https://issues.apache.org/jira/secure/attachment/12735397/SOLR-7559.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2015-05-26T20:01:46+0000",
            "author": "Jeroen Steggink",
            "content": "Incorrect parameters where chosen ",
            "id": "comment-14559746"
        }
    ]
}