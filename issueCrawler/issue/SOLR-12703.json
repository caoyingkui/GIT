{
    "id": "SOLR-12703",
    "title": "Better validation of bad atomic updates",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "None",
        "resolution": "Unresolved",
        "status": "Open"
    },
    "description": "I spent the majority of the day fighting a user issue. Here's the stack trace the user was running into:\n\nERROR - 2018-08-27 21:57:48.045; [c:gettingstarted s:shard1 r:core_node5 x:gettingstarted_shard1_replica_n2] org.apache.solr.handler.RequestHandlerBase; org.apache.solr.common.SolrException: RunUpdateProcessor has received an AddUpdateCommand containing a document that appears to still contain Atomic document update operations, most likely because DistributedUpdateProcessorFactory was explicitly disabled from this updateRequestProcessorChain\n\nat org.apache.solr.update.processor.RunUpdateProcessor.processAdd(RunUpdateProcessorFactory.java:62)\n\nat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\nat org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalAdd(DistributedUpdateProcessor.java:950)\n\nat org.apache.solr.update.processor.DistributedUpdateProcessor.versionAdd(DistributedUpdateProcessor.java:1168)\n\nat org.apache.solr.update.processor.DistributedUpdateProcessor.processAdd(DistributedUpdateProcessor.java:633)\n\nat org.apache.solr.update.processor.LogUpdateProcessorFactory$LogUpdateProcessor.processAdd(LogUpdateProcessorFactory.java:103)\n\nat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\nat org.apache.solr.update.processor.AddSchemaFieldsUpdateProcessorFactory$AddSchemaFieldsUpdateProcessor.processAdd(AddSchemaFieldsUpdateProcessorFactory.java:475)\n\nat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\nat org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:118)\n\nat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\nat org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:118)\n\nat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\nat org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:118)\n\nat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\nat org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:118)\n\nat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\nat org.apache.solr.update.processor.FieldNameMutatingUpdateProcessorFactory$1.processAdd(FieldNameMutatingUpdateProcessorFactory.java:75)\n\nat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\nat org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:118)\n\nat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\nat org.apache.solr.update.processor.AbstractDefaultValueUpdateProcessorFactory$DefaultValueUpdateProcessor.processAdd(AbstractDefaultValueUpdateProcessorFactory.java:92)\n\nat org.apache.solr.handler.loader.JavabinLoader$1.update(JavabinLoader.java:98)\n\nat org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec$1.readOuterMostDocIterator(JavaBinUpdateRequestCodec.java:188)\n\nat org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec$1.readIterator(JavaBinUpdateRequestCodec.java:144)\n\nThis is with the default solrconfig which means\u00a0DistributedUpdateProcessor was present before\u00a0\n\nRunUpdateProcessorFactory. From what I could tell\u00a0\u00a0DistributedUpdateProcessor#getUpdatedDocument should have resolved the atomic update and RunRunUpdateProcessorFactory should never receive an atomic update.\n\n\u00a0\n\nTurned out it was an indexing client bug which was causing a certain fraction of the updates to fail with this error. Here's a sample SolrJ code which would trigger this stack trace always\n\npublic void test() throws IOException, SolrServerException {\n  CloudSolrClient client = new CloudSolrClient.Builder(Collections.singletonList(\"localhost:9983\"), Optional.empty()).build();\n  client.connect();\n  client.setDefaultCollection(\"gettingstarted\");\n\n\n  //Works\n  SolrInputDocument document = new SolrInputDocument();\n  document.addField(\"id\", \"1\");\n  document.addField(\"string_s\" , ImmutableMap.of(\"set\", \"bbb\"));\n  client.add(document);\n\n\n  //Does not work and throws a very confusing error\n  document = new SolrInputDocument();\n  document.addField(\"id\", \"1\");\n  document.addField(\"string_s\" , ImmutableMap.of(\"set\", ImmutableMap.of(\"set\", \"bbb\")));\n  client.add(document);\n}",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2018-08-27T22:48:20+0000",
            "content": "I was not able to reproduce the same issue with the following JSON and using curl\u00a0\n\n[\n{\"id\": \"1\" , \"price_i\": {\"set\": {\"set\":99}}}\n]\n\n\u00a0For this payload the JSON validation would fail with the following error\n\nERROR - 2018-08-27 21:51:24.234; [c:gettingstarted s:shard1 r:core_node5 x:gettingstarted_shard1_replica_n2] org.apache.solr.handler.RequestHandlerBase; org.apache.solr.common.SolrException: Error parsing JSON field value. Unexpected OBJECT_START at [42], field=price_i\n\nat org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.parseSingleFieldValue(JsonLoader.java:653)\n\nat org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.parseNormalFieldValue(JsonLoader.java:628)\n\nat org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.parseExtendedFieldValue(JsonLoader.java:599)\n\nat org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.parseFieldValue(JsonLoader.java:557)\n\nat org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.parseDoc(JsonLoader.java:543)\n\nat org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.handleAdds(JsonLoader.java:500)\n\nat org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.processUpdate(JsonLoader.java:145)\n\nat org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.load(JsonLoader.java:121)\n ",
            "author": "Varun Thacker",
            "id": "comment-16594310"
        }
    ]
}