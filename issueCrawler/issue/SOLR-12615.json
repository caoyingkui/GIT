{
    "id": "SOLR-12615",
    "title": "HashQParserPlugin will throw an NPE for string hash key and documents have empty value",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [],
        "type": "Bug",
        "fix_versions": [
            "7.5",
            "master (8.0)"
        ],
        "affect_versions": "None",
        "resolution": "Fixed",
        "status": "Closed"
    },
    "description": "If I index documents where the\u00a0partitionKeys keys field is missing from a few docs then the stream expression throws an NPE\n\ndocs:\n\n[\n{\"id\" : \"1\", \"search_term_s\" : \"query1\"},\n{\"id\" : \"2\", \"search_term_s\" : \"query1\"},\n{\"id\" : \"3\"},\n{\"id\" : \"4\"}\n]\n\n\u00a0\n\nquery\n\nsearch(test_empty, q=\"*:*\", fl=\"search_term_s,id\" , sort=\"search_term_s desc\", qt=\"/export\", partitionKeys=\"search_term_s\")\n\n\u00a0\n\nlogs\n\nINFO - 2018-08-03 01:44:36.156; [c:test_empty s:shard1 r:core_node2 x:test_empty_shard1_replica_n1] org.apache.solr.core.SolrCore.Request; [test_empty_shard1_replica_n1] webapp=/solr path=/stream params={expr=search(test_empty,+q%3D\"*:*\",+fl%3D\"search_term_s,id\"+,+sort%3D\"search_term_s+desc\",+qt%3D\"/export\",+partitionKeys%3D\"search_term_s\")&_=1533260573672} status=0 QTime=11\nINFO - 2018-08-03 01:44:36.160; [ ] org.apache.solr.common.cloud.ConnectionManager; zkClient has connected\nINFO - 2018-08-03 01:44:36.162; [c:test_empty s:shard1 r:core_node2 x:test_empty_shard1_replica_n1] org.apache.solr.common.cloud.ZkStateReader; Updated live nodes from ZooKeeper... (0) -> (1)\nINFO - 2018-08-03 01:44:36.164; [c:test_empty s:shard1 r:core_node2 x:test_empty_shard1_replica_n1] org.apache.solr.client.solrj.impl.ZkClientClusterStateProvider; Cluster at localhost:9888 ready\nINFO - 2018-08-03 01:44:36.207; [c:test_empty s:shard1 r:core_node2 x:test_empty_shard1_replica_n1] org.apache.solr.core.SolrCore.Request; [test_empty_shard1_replica_n1] webapp=/solr path=/export params={q=*:*&distrib=false&indent=off&fl=search_term_s,id&sort=search_term_s+desc&partitionKeys=search_term_s&fq={!hash+workers%3D1+worker%3D0}&wt=json&version=2.2} status=500 QTime=36\nERROR - 2018-08-03 01:44:36.209; [c:test_empty s:shard1 r:core_node2 x:test_empty_shard1_replica_n1] org.apache.solr.servlet.HttpSolrCall; null:java.io.IOException: java.lang.RuntimeException: java.lang.NullPointerException\nat org.apache.solr.search.HashQParserPlugin$HashQuery.createWeight(HashQParserPlugin.java:130)\nat org.apache.lucene.search.IndexSearcher.createWeight(IndexSearcher.java:743)\nat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:463)\nat org.apache.solr.search.DocSetUtil.createDocSetGeneric(DocSetUtil.java:151)\nat org.apache.solr.search.DocSetUtil.createDocSet(DocSetUtil.java:140)\nat org.apache.solr.search.SolrIndexSearcher.getDocSetNC(SolrIndexSearcher.java:1196)\nat org.apache.solr.search.SolrIndexSearcher.getPositiveDocSet(SolrIndexSearcher.java:836)\nat org.apache.solr.search.SolrIndexSearcher.getProcessedFilter(SolrIndexSearcher.java:1044)\nat org.apache.solr.search.SolrIndexSearcher.getDocListNC(SolrIndexSearcher.java:1563)\nat org.apache.solr.search.SolrIndexSearcher.getDocListC(SolrIndexSearcher.java:1439)\nat org.apache.solr.search.SolrIndexSearcher.search(SolrIndexSearcher.java:586)\nat org.apache.solr.handler.component.QueryComponent.doProcessUngroupedSearch(QueryComponent.java:1435)\nat org.apache.solr.handler.component.QueryComponent.process(QueryComponent.java:375)\nat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:298)\nat org.apache.solr.handler.ExportHandler.handleRequestBody(ExportHandler.java:37)\nat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:199)\nat org.apache.solr.core.SolrCore.execute(SolrCore.java:2539)\nat org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:709)\nat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:515)\nat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:377)\nat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:323)\nat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1634)\nat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:533)\nat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)\nat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\nat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)\nat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1595)\nat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:255)\nat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1253)\nat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)\nat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:473)\nat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1564)\nat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)\nat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1155)\nat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)\nat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:219)\nat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\nat org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:335)\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\nat org.eclipse.jetty.server.Server.handle(Server.java:531)\nat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:352)\nat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)\nat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:281)\nat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:102)\nat org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)\nat org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)\nat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:760)\nat org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:678)\nat java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.RuntimeException: java.lang.NullPointerException\nat org.apache.solr.search.HashQParserPlugin$HashQuery$SegmentPartitioner.run(HashQParserPlugin.java:215)\nat org.apache.solr.search.HashQParserPlugin$HashQuery.createWeight(HashQParserPlugin.java:127)\n... 54 more\nCaused by: java.lang.NullPointerException\nat org.apache.lucene.util.CharsRefBuilder.copyUTF8Bytes(CharsRefBuilder.java:122)\nat org.apache.solr.schema.FieldType.indexedToReadable(FieldType.java:378)\nat org.apache.solr.search.HashQParserPlugin$BytesHash.hashCode(HashQParserPlugin.java:300)\nat org.apache.solr.search.HashQParserPlugin$HashQuery$SegmentPartitioner.run(HashQParserPlugin.java:210)\n... 55 more\n\nERROR - 2018-08-03 01:44:36.213; [c:test_empty s:shard1 r:core_node2 x:test_empty_shard1_replica_n1] org.apache.solr.client.solrj.io.stream.ExceptionStream; java.io.IOException: java.util.concurrent.ExecutionException: java.io.IOException: --> http://192.168.0.4:8888/solr/test_empty_shard1_replica_n1/:java.lang.RuntimeException: java.lang.NullPointerException\nat org.apache.solr.client.solrj.io.stream.CloudSolrStream.openStreams(CloudSolrStream.java:400)\nat org.apache.solr.client.solrj.io.stream.CloudSolrStream.open(CloudSolrStream.java:275)\nat org.apache.solr.client.solrj.io.stream.ExceptionStream.open(ExceptionStream.java:54)\nat org.apache.solr.handler.StreamHandler$TimerStream.open(StreamHandler.java:397)\nat org.apache.solr.client.solrj.io.stream.TupleStream.writeMap(TupleStream.java:83)\nat org.apache.solr.response.JSONWriter.writeMap(JSONResponseWriter.java:539)\nat org.apache.solr.response.TextResponseWriter.writeVal(TextResponseWriter.java:181)\nat org.apache.solr.response.JSONWriter.writeNamedListAsMapWithDups(JSONResponseWriter.java:209)\nat org.apache.solr.response.JSONWriter.writeNamedList(JSONResponseWriter.java:325)\nat org.apache.solr.response.JSONWriter.writeResponse(JSONResponseWriter.java:120)\nat org.apache.solr.response.JSONResponseWriter.write(JSONResponseWriter.java:71)\nat org.apache.solr.response.QueryResponseWriterUtil.writeQueryResponse(QueryResponseWriterUtil.java:65)\nat org.apache.solr.servlet.HttpSolrCall.writeResponse(HttpSolrCall.java:787)\nat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:524)\nat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:377)\nat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:323)\nat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1634)\nat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:533)\nat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)\nat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\nat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)\nat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1595)\nat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:255)\nat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1253)\nat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)\nat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:473)\nat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1564)\nat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)\nat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1155)\nat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)\nat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:219)\nat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\nat org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:335)\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\nat org.eclipse.jetty.server.Server.handle(Server.java:531)\nat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:352)\nat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)\nat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:281)\nat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:102)\nat org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)\nat org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)\nat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:760)\nat org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:678)\nat java.lang.Thread.run(Thread.java:745)\nCaused by: java.util.concurrent.ExecutionException: java.io.IOException: --> http://192.168.0.4:8888/solr/test_empty_shard1_replica_n1/:java.lang.RuntimeException: java.lang.NullPointerException\nat java.util.concurrent.FutureTask.report(FutureTask.java:122)\nat java.util.concurrent.FutureTask.get(FutureTask.java:192)\nat org.apache.solr.client.solrj.io.stream.CloudSolrStream.openStreams(CloudSolrStream.java:394)\n... 49 more\nCaused by: java.io.IOException: --> http://192.168.0.4:8888/solr/test_empty_shard1_replica_n1/:java.lang.RuntimeException: java.lang.NullPointerException\nat org.apache.solr.client.solrj.io.stream.SolrStream.read(SolrStream.java:222)\nat org.apache.solr.client.solrj.io.stream.CloudSolrStream$TupleWrapper.next(CloudSolrStream.java:484)\nat org.apache.solr.client.solrj.io.stream.CloudSolrStream$StreamOpener.call(CloudSolrStream.java:507)\nat org.apache.solr.client.solrj.io.stream.CloudSolrStream$StreamOpener.call(CloudSolrStream.java:494)\nat java.util.concurrent.FutureTask.run(FutureTask.java:266)\nat org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:209)\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n... 1 more\n\nThe problem lies with\u00a0HashQParserPlugin where we try to partition the data and if a document doesn't have a value for the partition field it throws an NPE",
    "attachments": {
        "SOLR-12615.patch": "https://issues.apache.org/jira/secure/attachment/12934338/SOLR-12615.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2018-08-03T22:16:12+0000",
            "content": "Patch demonstrating the problem and a solution for it.\n\nStill a couple of nocommits which need to be addressed.\n\nThe problem would only manifest if the\u00a0partitionKeys is a string field . Numeric values would doesn't have this issue. ",
            "author": "Varun Thacker",
            "id": "comment-16568849"
        },
        {
            "date": "2018-08-03T22:56:07+0000",
            "content": "Created SOLR-12624 for this nocommit in the patch\n\nint workers = localParams.getInt(\"workers\", 0);\nint worker = localParams.getInt(\"worker\", 0);\n//nocommit : if workers and worker both are 0 it will give an java.lang.ArithmeticException: / by zero\n//nocommit : if workers and worker both are 0 it will give an java.lang.ArithmeticException: / by zero\n\nJoel Bernstein does the patch looks good to you otherwise ?\u00a0 ",
            "author": "Varun Thacker",
            "id": "comment-16568889"
        },
        {
            "date": "2018-08-04T17:37:02+0000",
            "content": "Updated patch. All tests pass. I plan on committing this later today ",
            "author": "Varun Thacker",
            "id": "comment-16569255"
        },
        {
            "date": "2018-08-04T22:18:00+0000",
            "content": "Commit 592899a419c2a15e75f73e906fa61b7e922c9830 in lucene-solr's branch refs/heads/master from Varun Thacker\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=592899a ]\n\nSOLR-12615: HashQParserPlugin won't throw an NPE for string hash key and documents with empty value ",
            "author": "ASF subversion and git services",
            "id": "comment-16569304"
        },
        {
            "date": "2018-08-05T18:28:11+0000",
            "content": "Commit a862e432ec68a22a2b784d8d1226a6ee36918c22 in lucene-solr's branch refs/heads/branch_7x from Varun Thacker\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a862e43 ]\n\nSOLR-12615: HashQParserPlugin won't throw an NPE for string hash key and documents with empty value\n\n(cherry picked from commit 592899a) ",
            "author": "ASF subversion and git services",
            "id": "comment-16569541"
        },
        {
            "date": "2018-08-06T04:15:45+0000",
            "content": "Commit 592899a419c2a15e75f73e906fa61b7e922c9830 in lucene-solr's branch refs/heads/jira/http2 from Varun Thacker\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=592899a ]\n\nSOLR-12615: HashQParserPlugin won't throw an NPE for string hash key and documents with empty value ",
            "author": "ASF subversion and git services",
            "id": "comment-16569718"
        }
    ]
}