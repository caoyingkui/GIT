{
    "id": "SOLR-11010",
    "title": "OutOfMemoryError in tests when using HDFS BlockCache",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [
            "hdfs"
        ],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "7.0,                                            master (8.0)",
        "resolution": "Unresolved",
        "status": "Open"
    },
    "description": "Spin-off from SOLR-10878: the newly added MoveReplicaHDFSTest fails on jenkins (but rarely locally) with the following stacktrace:\n\n   [junit4]   2> 13619 ERROR (qtp1885193567-48) [n:127.0.0.1:50324_solr c:movereplicatest_coll s:shard2 r:core_node4 x:movereplicatest_coll_shard2_replica_n2] o.a.s.h.RequestHandlerBase org.apache.solr.common.SolrException: Error CREATEing SolrCore 'movereplicatest_coll_shard2_replica_n2': Unable to create core [movereplicatest_coll_shard2_replica_n2] Caused by: Direct buffer memory\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.create(CoreContainer.java:938)\n   [junit4]   2> \tat org.apache.solr.handler.admin.CoreAdminOperation.lambda$static$164(CoreAdminOperation.java:91)\n   [junit4]   2> \tat org.apache.solr.handler.admin.CoreAdminOperation.execute(CoreAdminOperation.java:384)\n   [junit4]   2> \tat org.apache.solr.handler.admin.CoreAdminHandler$CallInfo.call(CoreAdminHandler.java:389)\n   [junit4]   2> \tat org.apache.solr.handler.admin.CoreAdminHandler.handleRequestBody(CoreAdminHandler.java:174)\n   [junit4]   2> \tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:177)\n   [junit4]   2> \tat org.apache.solr.servlet.HttpSolrCall.handleAdmin(HttpSolrCall.java:745)\n   [junit4]   2> \tat org.apache.solr.servlet.HttpSolrCall.handleAdminRequest(HttpSolrCall.java:726)\n   [junit4]   2> \tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:507)\n   [junit4]   2> \tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:378)\n   [junit4]   2> \tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:322)\n   [junit4]   2> \tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1699)\n   [junit4]   2> \tat org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:139)\n   [junit4]   2> \tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1699)\n   [junit4]   2> \tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:582)\n   [junit4]   2> \tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:224)\n   [junit4]   2> \tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1180)\n   [junit4]   2> \tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:512)\n   [junit4]   2> \tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\n   [junit4]   2> \tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1112)\n   [junit4]   2> \tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n   [junit4]   2> \tat org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:395)\n   [junit4]   2> \tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)\n   [junit4]   2> \tat org.eclipse.jetty.server.Server.handle(Server.java:534)\n   [junit4]   2> \tat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:320)\n   [junit4]   2> \tat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:251)\n   [junit4]   2> \tat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:273)\n   [junit4]   2> \tat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:95)\n   [junit4]   2> \tat org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)\n   [junit4]   2> \tat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.executeProduceConsume(ExecuteProduceConsume.java:303)\n   [junit4]   2> \tat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceConsume(ExecuteProduceConsume.java:148)\n   [junit4]   2> \tat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:136)\n   [junit4]   2> \tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:671)\n   [junit4]   2> \tat org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:589)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:745)\n   [junit4]   2> Caused by: org.apache.solr.common.SolrException: Unable to create core [movereplicatest_coll_shard2_replica_n2]\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.create(CoreContainer.java:985)\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.create(CoreContainer.java:904)\n   [junit4]   2> \t... 34 more\n   [junit4]   2> Caused by: org.apache.solr.common.SolrException: The max direct memory is likely too low.  Either increase it (by adding -XX:MaxDirectMemorySize=<size>g -XX:+UseLargePages to your containers startup args) or disable direct allocation using solr.hdfs.blockcache.direct.memory.allocation=false in solrconfig.xml. If you are putting the block cache on the heap, your java heap size might not be large enough. Failed allocating ~134.217728 MB.\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.<init>(SolrCore.java:988)\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.<init>(SolrCore.java:843)\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.create(CoreContainer.java:969)\n   [junit4]   2> \t... 35 more\n   [junit4]   2> Caused by: java.lang.RuntimeException: The max direct memory is likely too low.  Either increase it (by adding -XX:MaxDirectMemorySize=<size>g -XX:+UseLargePages to your containers startup args) or disable direct allocation using solr.hdfs.blockcache.direct.memory.allocation=false in solrconfig.xml. If you are putting the block cache on the heap, your java heap size might not be large enough. Failed allocating ~134.217728 MB.\n   [junit4]   2> \tat org.apache.solr.core.HdfsDirectoryFactory.createBlockCache(HdfsDirectoryFactory.java:311)\n   [junit4]   2> \tat org.apache.solr.core.HdfsDirectoryFactory.getBlockDirectoryCache(HdfsDirectoryFactory.java:287)\n   [junit4]   2> \tat org.apache.solr.core.HdfsDirectoryFactory.create(HdfsDirectoryFactory.java:227)\n   [junit4]   2> \tat org.apache.solr.core.CachingDirectoryFactory.get(CachingDirectoryFactory.java:347)\n   [junit4]   2> \tat org.apache.solr.update.SolrIndexWriter.create(SolrIndexWriter.java:92)\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.initIndex(SolrCore.java:741)\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.<init>(SolrCore.java:934)\n   [junit4]   2> \t... 37 more\n   [junit4]   2> Caused by: java.lang.OutOfMemoryError: Direct buffer memory\n   [junit4]   2> \tat java.nio.Bits.reserveMemory(Bits.java:658)\n   [junit4]   2> \tat java.nio.DirectByteBuffer.<init>(DirectByteBuffer.java:123)\n   [junit4]   2> \tat java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:311)\n   [junit4]   2> \tat org.apache.solr.store.blockcache.BlockCache.<init>(BlockCache.java:71)\n   [junit4]   2> \tat org.apache.solr.core.HdfsDirectoryFactory.createBlockCache(HdfsDirectoryFactory.java:309)\n   [junit4]   2> \t... 43 more",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2017-07-05T09:30:20+0000",
            "content": "Commit 48b4960e0c093b480b8328f324992a7006054f17 in lucene-solr's branch refs/heads/master from Andrzej Bialecki \n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=48b4960 ]\n\nSOLR-11010 Tentative fix for jenkins test failures. ",
            "author": "ASF subversion and git services",
            "id": "comment-16074488"
        },
        {
            "date": "2017-07-05T12:36:52+0000",
            "content": "Commit a915e9b74fa170844994f06c91dc3bc46359e9be in lucene-solr's branch refs/heads/branch_7x from Andrzej Bialecki \n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a915e9b ]\n\nSOLR-11010 Tentative fix for jenkins test failures. ",
            "author": "ASF subversion and git services",
            "id": "comment-16074684"
        },
        {
            "date": "2017-07-05T12:37:14+0000",
            "content": "Commit 819670b4f1abb246569390ae224ea751fed19f9a in lucene-solr's branch refs/heads/branch_7_0 from Andrzej Bialecki \n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=819670b ]\n\nSOLR-11010 Tentative fix for jenkins test failures. ",
            "author": "ASF subversion and git services",
            "id": "comment-16074686"
        }
    ]
}