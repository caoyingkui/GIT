{
    "id": "SOLR-11795",
    "title": "Add Solr metrics exporter for Prometheus",
    "details": {
        "labels": "",
        "priority": "Minor",
        "components": [
            "metrics"
        ],
        "type": "Improvement",
        "fix_versions": [
            "7.3",
            "master (8.0)"
        ],
        "affect_versions": "7.2",
        "resolution": "Fixed",
        "status": "Closed"
    },
    "description": "I 'd like to monitor Solr using Prometheus and Grafana.\nI've already created Solr metrics exporter for Prometheus. I'd like to contribute to contrib directory if you don't mind.",
    "attachments": {
        "SOLR-11795-11.patch": "https://issues.apache.org/jira/secure/attachment/12912693/SOLR-11795-11.patch",
        "solr-exporter-diagram.png": "https://issues.apache.org/jira/secure/attachment/12903746/solr-exporter-diagram.png",
        "SOLR-11795-6.patch": "https://issues.apache.org/jira/secure/attachment/12911109/SOLR-11795-6.patch",
        "SOLR-11795-5.patch": "https://issues.apache.org/jira/secure/attachment/12910869/SOLR-11795-5.patch",
        "SOLR-11795-9.patch": "https://issues.apache.org/jira/secure/attachment/12911499/SOLR-11795-9.patch",
        "SOLR-11795-dev-tools.patch": "https://issues.apache.org/jira/secure/attachment/12911650/SOLR-11795-dev-tools.patch",
        "SOLR-11795-2.patch": "https://issues.apache.org/jira/secure/attachment/12905603/SOLR-11795-2.patch",
        "solr-dashboard.png": "https://issues.apache.org/jira/secure/attachment/12903747/solr-dashboard.png",
        "SOLR-11795-10.patch": "https://issues.apache.org/jira/secure/attachment/12912605/SOLR-11795-10.patch",
        "SOLR-11795-8.patch": "https://issues.apache.org/jira/secure/attachment/12911244/SOLR-11795-8.patch",
        "SOLR-11795-3.patch": "https://issues.apache.org/jira/secure/attachment/12905618/SOLR-11795-3.patch",
        "SOLR-11795.patch": "https://issues.apache.org/jira/secure/attachment/12903752/SOLR-11795.patch",
        "SOLR-11795-7.patch": "https://issues.apache.org/jira/secure/attachment/12911177/SOLR-11795-7.patch",
        "SOLR-11795-ref-guide.patch": "https://issues.apache.org/jira/secure/attachment/12913166/SOLR-11795-ref-guide.patch",
        "SOLR-11795-4.patch": "https://issues.apache.org/jira/secure/attachment/12906381/SOLR-11795-4.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2017-12-27T01:53:50+0000",
            "content": "+1 looks nice! ",
            "author": "Koji Sekiguchi",
            "id": "comment-16304127"
        },
        {
            "date": "2017-12-27T02:57:02+0000",
            "content": "Attach a patch file. ",
            "author": "Minoru Osuka",
            "id": "comment-16304161"
        },
        {
            "date": "2017-12-27T05:14:10+0000",
            "content": "solr-exporter can expose search results, Metrics API response, and Solr API responses  as metrics. The following example exposes facets results as metrics:\n\n\nqueries:\n  - query:\n      collection: collection1\n      path: /select\n      params:\n        - q: \"*:*\"\n        - start: 0\n        - rows: 0\n        - json.facet: |-\n            {\n              category: {\n                type: terms,\n                field: cat\n              }\n            }\n    jsonQueries:\n      # solr_facets_category\n      - |-\n        .facets.category.buckets[] as $object |\n        $object.val as $term |\n        $object.count as $value |\n        {\n          name         : \"solr_facets_category\",\n          type         : \"GAUGE\",\n          help         : \"Category facets\",\n          label_names  : [\"collection\", \"term\"],\n          label_values : [\"collection1\", $term],\n          value        : $value\n        }\n\n\n\nFor other metrics settings, please see config.yml. ",
            "author": "Minoru Osuka",
            "id": "comment-16304229"
        },
        {
            "date": "2018-01-11T04:12:13+0000",
            "content": "Attach new patch file. ",
            "author": "Minoru Osuka",
            "id": "comment-16321671"
        },
        {
            "date": "2018-01-11T06:41:40+0000",
            "content": "Attach new patch file. ",
            "author": "Minoru Osuka",
            "id": "comment-16321763"
        },
        {
            "date": "2018-02-16T12:05:36+0000",
            "content": "Today I had a meeting with Minoru, the contributor of this patch. We discussed in detail about this contribution and I found this is very nice!\n\nThere is a similar ticket\u00a0SOLR-10654, which implements\u00a0ResponseWriter for\u00a0Prometheus and is called thru wt parameter, but I prefer Minoru's way.\u00a0\u00a0Why I prefer this is because:\n\n\n\tThis is highly independent from Solr main unit. He just makes contrib/prometheus-exporter directory and provides everything under it, including SolrExporter for Prometheus in this patch. This patch doesn't change Solr main source.\n\tImplementing an exporter looks mainstream in Prometheus field, such as MySQL, Memcached, Mesos, etc. See https://prometheus.io/docs/instrumenting/exporters/\n\tSolrj is used to implement SolrExporter in this patch. It can be used on SolrCloud environment.\n\tIt allows users to monitor not only Solr metrics which come from /admin/metrics but also facet counts which come from /select (see config.yml in the patch).\n\n\n\nI requested him to update the patch in terms of providing Ref Guide (he already wrote README.md so just move its contents to Ref Guide) and adding more tests so that we can know the change of the response format of /admin/metrics if it happens.\n\nI'll wait for his next patch. Once I got it and nobody objects, I'd like to commit this in the next week. ",
            "author": "Koji Sekiguchi",
            "id": "comment-16366903"
        },
        {
            "date": "2018-02-19T13:21:15+0000",
            "content": "Hi Koji Sekiguchi,\n\nI attached the latest patch (SOLR-11795-6.patch).\n I added Ref Guide content and images, also it includes test code that checking scrape error.\n Please check this patch file.\n\n$ git apply /path/to/SOLR-11795-6.patch\n\n\nThanks, ",
            "author": "Minoru Osuka",
            "id": "comment-16369114"
        },
        {
            "date": "2018-02-20T02:10:50+0000",
            "content": "Thank you for updating the patch. I can see hard coded luceneMatchVersion in the patch:\n\n\n<luceneMatchVersion>7.1.0</luceneMatchVersion>\n\n\n\nYou can rephrase it like this:\n\n\n<luceneMatchVersion>${tests.luceneMatchVersion:LATEST}</luceneMatchVersion>\n\n\n\nAnd I think your solrconfig.xml for test is still fat... Please consult solr/contrib/langid for making test config more compact. ",
            "author": "Koji Sekiguchi",
            "id": "comment-16369645"
        },
        {
            "date": "2018-02-20T03:29:30+0000",
            "content": "I replaced luceneMatchVersion to \"${tests.luceneMatchVersion:LATEST}\".\n And made solrconfig.xml compact.\n Please see\u00a0SOLR-11795-7.patch. ",
            "author": "Minoru Osuka",
            "id": "comment-16369681"
        },
        {
            "date": "2018-02-20T04:00:11+0000",
            "content": "I can still see several UpdateRequestProcessors in solrconfig.xml for test. Are they necessary? And I'm sorry if I'm wrong but do you need test-files/exampledocs/*.xml files?\n\nAs for schema settings, existing all Solr contribs use schema.xml, not managed-schema. Why don't you follow them? ",
            "author": "Koji Sekiguchi",
            "id": "comment-16369692"
        },
        {
            "date": "2018-02-20T05:15:26+0000",
            "content": "Hi,\n Thank you for quick reply.\n\nWhy test code uses these configs is following:\n\n\tThe test indexes exampledocs data to test if facet count can be exporsed as metrics. Any data can be used, but I used exampledocs.\n(https://issues.apache.org/jira/browse/SOLR-11795?focusedCommentId=16304229&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-16304229)\n\tThe test uses managed_schema because indexing without worrying about the data format.\n\tSince the test code is using managed_schema, there are several updateProcessors for add unknown fields to the schema. (UpdateRequestProcessors means updateProcessor?)\n\n\n\nDoes that answer your question? ",
            "author": "Minoru Osuka",
            "id": "comment-16369726"
        },
        {
            "date": "2018-02-20T16:25:01+0000",
            "content": "I'm sorry, my patch file has mistakes.\n\n\n\tavoid invalid logging pattern.\n\tadd jar checksum file to solr/licenses.\n\tfix duplicate section name for Ref Guide.\n\n\n\nI attached new patch (SOLR-11795-8.patch) that fix it.\n\nI apologize for causing you a trouble. ",
            "author": "Minoru Osuka",
            "id": "comment-16370228"
        },
        {
            "date": "2018-02-21T01:02:40+0000",
            "content": "Reopening this. We're still working on this. ",
            "author": "Koji Sekiguchi",
            "id": "comment-16370806"
        },
        {
            "date": "2018-02-22T02:17:37+0000",
            "content": "I attached new patch file (SOLR-11795-9.patch) that passed `ant validate` task. It includes to fix following:\n\n\n\tadded SHA1 checksum, LICENSE and NOTICE files into solr/licenses directory.\n\tfixed invalid source code. (use DefaultSolrThreadFactory and InputStreamReader.)\n\tadded JAR version into lucene/ivy-versions.properties.\n\tfixed duplicate section name for Ref Guide.\n\n ",
            "author": "Minoru Osuka",
            "id": "comment-16372333"
        },
        {
            "date": "2018-02-22T18:07:15+0000",
            "content": "Hi,\nthere is another problem: The pom.xml templates are missing for this contrib module. Because of this artifact building for maven is broken, see Jenkins:\n\n\n-dist-maven:\n[artifact:install-provider] Installing provider: org.apache.maven.wagon:wagon-ssh:jar:1.0-beta-7:runtime\n[artifact:pom] An error has occurred while processing the Maven artifact tasks.\n[artifact:pom]  Diagnosis:\n[artifact:pom] \n[artifact:pom] Unable to initialize POM pom.xml: Could not find the model file '/x1/jenkins/jenkins-slave/workspace/Lucene-Solr-SmokeRelease-master/lucene/build/poms/solr/contrib/prometheus-exporter/pom.xml'. for project unknown\n[artifact:pom] /x1/jenkins/jenkins-slave/workspace/Lucene-Solr-SmokeRelease-master/lucene/build/poms/solr/contrib/prometheus-exporter/pom.xml (No such file or directory)\n\n\n\nhttps://builds.apache.org/job/Lucene-Solr-SmokeRelease-master/960/\nhttps://builds.apache.org/job/Lucene-Solr-Maven-master/2189/\nhttps://builds.apache.org/job/Lucene-Solr-Maven-7.x/136/\n\nAnd many more that build Artifacts. ",
            "author": "Uwe Schindler",
            "id": "comment-16373198"
        },
        {
            "date": "2018-02-22T22:36:36+0000",
            "content": "Thanks for letting us know it. Yes, we discussed about the problem last night as we were paying careful attention to Jenkins. I think we can fix it soon. ",
            "author": "Koji Sekiguchi",
            "id": "comment-16373596"
        },
        {
            "date": "2018-02-23T01:26:35+0000",
            "content": "I attached new patch file (SOLR-11795-dev-tools.patch) for dev-tools. It includes following:\n\n\n\tAdd idea settings.\n\tAdd maven pom.template.\n\n\n\nI apologize for causing you a trouble. ",
            "author": "Minoru Osuka",
            "id": "comment-16373784"
        },
        {
            "date": "2018-02-23T01:50:22+0000",
            "content": "Commit df0f141907b0701d7b1f1fc297ae33ef901844a0 in lucene-solr's branch refs/heads/master from koji\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=df0f141 ]\n\nSOLR-11795: add more stuff under dev-tools for prometheus-exporter ",
            "author": "ASF subversion and git services",
            "id": "comment-16373805"
        },
        {
            "date": "2018-02-23T02:04:47+0000",
            "content": "Commit bdd9cdd8198be84cebca93f1db63a99dfc580264 in lucene-solr's branch refs/heads/branch_7x from koji\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=bdd9cdd ]\n\nSOLR-11795: add more stuff under dev-tools for prometheus-exporter ",
            "author": "ASF subversion and git services",
            "id": "comment-16373818"
        },
        {
            "date": "2018-02-23T04:07:34+0000",
            "content": "Thanks Minoru and everyone!  ",
            "author": "Koji Sekiguchi",
            "id": "comment-16373893"
        },
        {
            "date": "2018-02-23T13:27:54+0000",
            "content": "There are still test failures on Jenkins related to this issue.\n\n\nFAILED:  org.apache.solr.prometheus.collector.SolrCollectorTest.testCollect\n\nError Message:\nCannot create property=ping for JavaBean=org.apache.solr.prometheus.collector.config.SolrCollectorConfig@41274bef  in 'reader', line 18, column 1:     ping:     ^ Unable to make boolean java.beans.FeatureDescriptor.isTransient() accessible: module java.desktop does not \"opens java.beans\" to unnamed module @8eec2a3  in 'reader', line 19, column 3:       query:       ^\n\nStack Trace:\nCannot create property=ping for JavaBean=org.apache.solr.prometheus.collector.config.SolrCollectorConfig@41274bef\n in 'reader', line 18, column 1:\n    ping:\n    ^\nUnable to make boolean java.beans.FeatureDescriptor.isTransient() accessible: module java.desktop does not \"opens java.beans\" to unnamed module @8eec2a3\n in 'reader', line 19, column 3:\n      query:\n      ^\n\n        at __randomizedtesting.SeedInfo.seed([13F9AF21ED3AE1E3:DEB5CA3C8EBBBDD7]:0)\n        at org.yaml.snakeyaml.constructor.Constructor$ConstructMapping.constructJavaBean2ndStep(Constructor.java:268)\n        at org.yaml.snakeyaml.constructor.Constructor$ConstructMapping.construct(Constructor.java:149)\n        at org.yaml.snakeyaml.constructor.Constructor$ConstructYamlObject.construct(Constructor.java:308)\n        at org.yaml.snakeyaml.constructor.BaseConstructor.constructObjectNoCheck(BaseConstructor.java:207)\n        at org.yaml.snakeyaml.constructor.BaseConstructor.constructObject(BaseConstructor.java:196)\n        at org.yaml.snakeyaml.constructor.BaseConstructor.constructDocument(BaseConstructor.java:161)\n        at org.yaml.snakeyaml.constructor.BaseConstructor.getSingleData(BaseConstructor.java:147)\n        at org.yaml.snakeyaml.Yaml.loadFromReader(Yaml.java:524)\n        at org.yaml.snakeyaml.Yaml.loadAs(Yaml.java:484)\n        at org.apache.solr.prometheus.collector.SolrCollectorTest.testCollect(SolrCollectorTest.java:71)\n\n\n\nSee https://jenkins.thetaphi.de/job/Lucene-Solr-master-Linux/21518/ ",
            "author": "Shalin Shekhar Mangar",
            "id": "comment-16374338"
        },
        {
            "date": "2018-02-23T16:45:28+0000",
            "content": "This is Java 9. The SnakeYAML stuff uses reflection in illegal ways. It's good that Java 9 found this, because this type of code needs to be banned. Never ever reflect on classes inside the Java runtime!!! This is also a securizty risk and therefor it's forbidden in Java 9. ",
            "author": "Uwe Schindler",
            "id": "comment-16374616"
        },
        {
            "date": "2018-02-23T16:51:07+0000",
            "content": "See: https://bitbucket.org/asomov/snakeyaml/issues/393/warning-an-illegal-reflective-access\n\nThe project looks partly unmaintained, last commit on Github was 3 years ago. So it's better to look for something else. => Correction, it's maintained on bitbucket, so we can send a pull request. ",
            "author": "Uwe Schindler",
            "id": "comment-16374623"
        },
        {
            "date": "2018-02-23T17:06:51+0000",
            "content": "Just a complaint: Why are tests written like this:\n\n\nString configFile = getFile(\"conf/config.yml\").getAbsolutePath();\nSolrCollectorConfig collectorConfig = new Yaml().loadAs(new BufferedReader(new InputStreamReader(new FileInputStream(configFile),\"UTF-8\")), SolrCollectorConfig.class);\n\n\n\n\n\tWhy does it not use StandardCharsets.UTF_8??\n\tWhy does it use a java.io.File and stuff like java.io.FileInputStream. Thos classes are forbidden in Lucene and we should get rid of them in Solr, too. Most new code uses java.nio.file.*, but for this test it's not even needed to use a File path, just open it as resource and open the InputStream using TestUtils!\n\tThis leaks files, which causes tests to possibly fail on Windows, as files are not closed. Please add try-with-resources.\n\n ",
            "author": "Uwe Schindler",
            "id": "comment-16374647"
        },
        {
            "date": "2018-02-23T17:17:34+0000",
            "content": "Why does the Solr specific collector config uses YAML (80 kilobytes!!!!)? Yet another config file format? Now we have XML, JSON, properties files and now YAML. Why not use one that's already used by other places in Solr?\n\nThis would make it easier to understand, I have no idea what this config file config.yml, thats splattered in identical copies in various subdirectories, does! Is this some fixed config (if yes then put it into the jar) or should the user be able to modify it? Without any comments/docs in it this is impossible. ",
            "author": "Uwe Schindler",
            "id": "comment-16374664"
        },
        {
            "date": "2018-02-23T17:20:38+0000",
            "content": "Why does it have log4j config files and slf4j.jar in the contrib's lib/ sub directory as duplicate? It should already be on classpath. ",
            "author": "Uwe Schindler",
            "id": "comment-16374680"
        },
        {
            "date": "2018-02-23T17:30:15+0000",
            "content": "Also note that (as of this moment) it seems that most/all of the tests methods in the \"prometheus\" package have failed 30% (10/34) of the jenkins builds that have run them...\n\n\n$ curl -sS http://fucit.org/solr-jenkins-reports/reports/24hours-failure-rates.csv  | grep prometheus\norg.apache.solr.prometheus.collector.config.SolrCollectorConfigTest,testSetCollectionsConfig,0.294117647058824,10,34\norg.apache.solr.prometheus.collector.SolrCollectorTest,testCollect,0.294117647058824,10,34\norg.apache.solr.prometheus.collector.config.SolrCollectorConfigTest,testGetQueryConfigs,0.294117647058824,10,34\norg.apache.solr.prometheus.scraper.config.SolrScraperConfigTest,testScraperConfig,0.294117647058824,10,34\norg.apache.solr.prometheus.collector.config.SolrCollectorConfigTest,testSetMetricsConfig,0.294117647058824,10,34\norg.apache.solr.prometheus.collector.config.SolrCollectorConfigTest,testSetQueryConfigs,0.294117647058824,10,34\norg.apache.solr.prometheus.exporter.SolrExporterTest,testExecute,0.294117647058824,10,34\norg.apache.solr.prometheus.collector.SolrCollectorTest,testSolrCollector,0.294117647058824,10,34\norg.apache.solr.prometheus.collector.config.SolrCollectorConfigTest,testGetCollectionsConfig,0.294117647058824,10,34\norg.apache.solr.prometheus.scraper.config.SolrScraperConfigTest,testGetQueryConfig,0.294117647058824,10,34\norg.apache.solr.prometheus.collector.config.SolrCollectorConfigTest,testGetMetricsConfig,0.294117647058824,10,34\norg.apache.solr.prometheus.scraper.config.SolrScraperConfigTest,testGetJsonQueries,0.294117647058824,10,34\norg.apache.solr.prometheus.collector.config.SolrCollectorConfigTest,testCollectorConfig,0.294117647058824,10,34\n\n ",
            "author": "Hoss Man",
            "id": "comment-16374699"
        },
        {
            "date": "2018-02-23T17:36:04+0000",
            "content": "About snakeyaml: The Exception handling is broken in multiple ways: https://bitbucket.org/asomov/snakeyaml/src/9ffe9d8b2ba4e5eabde045d407799a71997cda20/src/main/java/org/yaml/snakeyaml/introspector/PropertyUtils.java?at=default&fileviewer=file-view-default#PropertyUtils.java-124:151\n\n\n\tUses e.printStackTrace() -> forbidden, this is not acceptable behaviour of a library\n\tcatches only those exceptions, that eclipse autogenerated (of course... this is incredible shitty code, sorry!), of curse missing the runtime exceptions thrown by Java 9 when illegal access is denied\n\tdoes not use AccessController.doPrivileged, so it can never be made safe with security manager!\n\n\n\nIMHO, the only workaround here (without patching this library) is to install a security amnager that explicitely denies deep refelection access to java.beans (so at least the secruity exception is catched).\n\nOr much simpler: Get rid of YAML! ",
            "author": "Uwe Schindler",
            "id": "comment-16374707"
        },
        {
            "date": "2018-02-23T19:14:58+0000",
            "content": "Are the issues here serious enough that we should roll this back for the 7.3 release in two weeks? \n\nIf so, the issues can be addressed and it can be included in  7.4+.\n\nI don't have a strong opinion as I haven't reviewed the code. Based on several comments though, I thought it a question worth asking since it'll be harder once the code is in a release. ",
            "author": "Erick Erickson",
            "id": "comment-16374866"
        },
        {
            "date": "2018-02-24T01:20:35+0000",
            "content": "I can't apologize enough for this. \n\n> Now we have XML, JSON, properties files and now YAML. Why not use one that's already used by other places in Solr?\n\nAs for using yaml, I asked the contributor why using it rather than json and I just accepted the reason (more readable and understandable, able to include comment etc.) but I should gain favor with committers about importing new config format.\n\n> Or much simpler: Get rid of YAML!\n\nI'd like to talk to him that we could use json for config but it'll take time to apply.\n\nI'm going to revert this soon. ",
            "author": "Koji Sekiguchi",
            "id": "comment-16375195"
        },
        {
            "date": "2018-02-24T02:07:45+0000",
            "content": "Commit 720eba0ae40edbff47bd4de059d03b9ed8475f94 in lucene-solr's branch refs/heads/master from koji\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=720eba0 ]\n\nRevert \"SOLR-11795: add more stuff under dev-tools for prometheus-exporter\"\n\nThis reverts commit df0f141907b0701d7b1f1fc297ae33ef901844a0. ",
            "author": "ASF subversion and git services",
            "id": "comment-16375241"
        },
        {
            "date": "2018-02-24T02:07:47+0000",
            "content": "Commit 4e198a273763e27122a00243e3694d28f1e5b3a4 in lucene-solr's branch refs/heads/master from koji\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4e198a2 ]\n\nRevert \"SOLR-11795: Add Solr metrics exporter for Prometheus\"\n\nThis reverts commit 6859acc450af0a2cafdf880ef6ef516c3d95db18. ",
            "author": "ASF subversion and git services",
            "id": "comment-16375242"
        },
        {
            "date": "2018-02-24T02:31:42+0000",
            "content": "Commit a3452cc28d45da6164da399fe2425415692009c0 in lucene-solr's branch refs/heads/branch_7x from koji\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a3452cc ]\n\nRevert \"SOLR-11795: add more stuff under dev-tools for prometheus-exporter\"\n\nThis reverts commit bdd9cdd8198be84cebca93f1db63a99dfc580264. ",
            "author": "ASF subversion and git services",
            "id": "comment-16375256"
        },
        {
            "date": "2018-02-24T02:31:43+0000",
            "content": "Commit d7f6cb93837e1bde1066c96606845c4ab04e50cf in lucene-solr's branch refs/heads/branch_7x from koji\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d7f6cb9 ]\n\nRevert \"SOLR-11795: Add Solr metrics exporter for Prometheus\"\n\nThis reverts commit 90741a5d329a5cf33f880eca1ceebc6ed769d6b1. ",
            "author": "ASF subversion and git services",
            "id": "comment-16375257"
        },
        {
            "date": "2018-02-24T09:57:17+0000",
            "content": "Thanks Koji Sekiguchi. I think here the main problem is not only YAML and this library, the issue is that it uses a config file to build an object graph solely via reflection. This is all fine, if it only affects classes from Lucene/Solr, but the reflective code should not start to make stuff accessible with setAccessible() anywhere - whenever you do this you counterpart Java's security and you can be sure that you are doing something wrong. This also brings in opportunities to new security issues. I tend to say that because of recent security reports, Solr should run inside a security manager also in production (like Elasticsearch), to prevent malicious Scripts or Plugins to escape the Solr sandbox (like we do in tests). I would spend time to do that, but external libraries like this one would completely prevent \"correct\" usage of a security manager to accomplish this.\n\nAbout this module: I am not 100% sure: As this is more or less a completely static config file for the reporting, why to hell not build this object graph in pure Java code? Or is this intended to be customized by end-users? ",
            "author": "Uwe Schindler",
            "id": "comment-16375460"
        },
        {
            "date": "2018-02-24T11:26:32+0000",
            "content": "Uwe Schindler, I apologize for any inconvenience caused, and appreciate your bringing this issue to my attention.\n\nI will answer your question.\n\nQ. Why to hell not build this object graph in pure Java code?\n\u00a0 \u00a0 A. There is a library named SnakeYAML. It seemed easy to handle YAML, so I used it. I was not careful enough with that.\n\nQ. Or is this intended to be customized by end-users?\n\u00a0 \u00a0 A. Yes. I think the metrics that end-user want to get by end users will differ. I want to be able to add what they needed and delete what they did not need like solrconfig.xml. ",
            "author": "Minoru Osuka",
            "id": "comment-16375507"
        },
        {
            "date": "2018-02-24T11:46:33+0000",
            "content": "Hi,\nI'd suggest to create a branch forked from current master. Commit all stuff there and start developing again. I can setup the Linux and Windows Policeman Jenkins jobs that run that branch with all possible JVMs, 2 times per day. I would disable reporting to mailing list and just put you on the list. You can also maintain the branch on Github, just tell me branch name and where to find it.\nIs this an idea on how to proceed? I think the stuff here is great, but it needs baking and some more developers to look at it. Otherwise it might end up like the morphlines/map-reduce contribs! ",
            "author": "Uwe Schindler",
            "id": "comment-16375519"
        },
        {
            "date": "2018-02-24T14:03:21+0000",
            "content": "Thanks for the kind suggestion. I'd like to create a branch for this and let you know the name. ",
            "author": "Koji Sekiguchi",
            "id": "comment-16375582"
        },
        {
            "date": "2018-02-24T19:14:09+0000",
            "content": "Hi Koji,\nthe snakeyaml people are fixing the bug with Java 9. So it looks like we may get a relaese - it should be enough to update the dependency then. I have no plans about their schedule.\n\nNevertheless, I am not really happy with another config file format. We should somehow decide for one of them, not add many more. ",
            "author": "Uwe Schindler",
            "id": "comment-16375749"
        },
        {
            "date": "2018-02-25T10:55:58+0000",
            "content": "Hi Koji Sekiguchi and Minoru Osuka,\n\nI verified that the patched snakeyaml version passes Solr's test suite in Java 9: https://bitbucket.org/asomov/snakeyaml/issues/393/warning-an-illegal-reflective-access#comment-43522954\n\nSo we should wait a bit until they hopefully do a release of version 1.20. I branched the version before your revert into a local branch and used the snapshot version that I built locally. Should I push this branch for further development?\n\nUwe ",
            "author": "Uwe Schindler",
            "id": "comment-16376031"
        },
        {
            "date": "2018-02-25T16:19:30+0000",
            "content": "We don't need another configuration file format (YAML).  This has already been argued in some other issue over the past year. ",
            "author": "David Smiley",
            "id": "comment-16376138"
        },
        {
            "date": "2018-02-25T23:23:07+0000",
            "content": "Hi,\u00a0Uwe Schindler and David Smiley,\n I'm working on replace YAML to XML like solrconfig.xml. I'll attach new patch file. ",
            "author": "Minoru Osuka",
            "id": "comment-16376293"
        },
        {
            "date": "2018-03-01T12:11:24+0000",
            "content": "FYI, snakeyaml 1.20, which fixes the Java 9 bug, was released yesterday. ",
            "author": "Uwe Schindler",
            "id": "comment-16381901"
        },
        {
            "date": "2018-03-01T13:27:46+0000",
            "content": "Hi Koji Sekiguchi and Uwe Schindler\n\nI apologize for the delay.\nI attached the latest patch (SOLR-11795-10.patch) that gathered all changes into one.\n\n\tChanged configuration file format to XML.\n\tIncluded dev-tools.\n\n\n\nCould you please test it on a test branch? ",
            "author": "Minoru Osuka",
            "id": "comment-16381992"
        },
        {
            "date": "2018-03-01T22:48:21+0000",
            "content": "latest patch, there still be 'yaml' word in adoc.\nIt's just my question, as to argparse4j dependency, why not use DOMUtil or common.util.Util.etc that's already used by other places in Solr? ",
            "author": "Shinichiro Abe",
            "id": "comment-16382801"
        },
        {
            "date": "2018-03-02T00:16:18+0000",
            "content": "Shinichiro Abe,\n\nThank you for finding a typo.\nArgparse4j dependency? Could you please show me the code of the question in this patch so that I can understand your question?\n\nKoji Sekiguchi and Uwe Schindler,\n\nI Attach a patch (SOLR-11795-11.patch) that fixed typo. ",
            "author": "Minoru Osuka",
            "id": "comment-16382918"
        },
        {
            "date": "2018-03-02T01:37:16+0000",
            "content": "i made a mistake when looking the patch, please ignore that, sorry. ",
            "author": "Shinichiro Abe",
            "id": "comment-16382980"
        },
        {
            "date": "2018-03-02T02:18:41+0000",
            "content": "Commit 328800efc939a52c94f7b92c2d4cc4de2066215b in lucene-solr's branch refs/heads/SOLR-11795 from koji\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=328800e ]\n\nSOLR-11795: Add Solr metrics exporter for Prometheus ",
            "author": "ASF subversion and git services",
            "id": "comment-16383020"
        },
        {
            "date": "2018-03-02T02:52:11+0000",
            "content": "Commit 961269aa5d0feef86cac9b4a94c2268de9f498f6 in lucene-solr's branch refs/heads/branch_7x-SOLR-11795 from koji\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=961269a ]\n\nSOLR-11795: Add Solr metrics exporter for Prometheus ",
            "author": "ASF subversion and git services",
            "id": "comment-16383067"
        },
        {
            "date": "2018-03-02T03:01:40+0000",
            "content": "Hi Uwe,\n\nI created the following branches:\n\n\n\tSOLR-11795 (for master)\n\tbranch_7x-SOLR-11795 (for branch_7x)\n\n\n\nSorry to put you to the trouble but can you setup the Linux and Windows Policeman Jenkins jobs that you kindly suggested a week ago? Thank you very much in advance! ",
            "author": "Koji Sekiguchi",
            "id": "comment-16383080"
        },
        {
            "date": "2018-03-02T12:13:24+0000",
            "content": "Hi Koji,\nI added: https://jenkins.thetaphi.de/job/SOLR-11795/\nIt does not send any mails, so keep an eye on it. To receive e-mail give me the address. I only setup a master job, that should be enough.\nUwe ",
            "author": "Uwe Schindler",
            "id": "comment-16383524"
        },
        {
            "date": "2018-03-02T19:59:39+0000",
            "content": "Hi. Just curious; why does this issue get its own dedicated Jenkins job?  Not that there's anything wrong with that but I'm just curious.  Do Koji/Minoru feel that it's likely to turn up spurious test failures that a local \"ant beast ...\" wouldn't find? ",
            "author": "David Smiley",
            "id": "comment-16384085"
        },
        {
            "date": "2018-03-05T03:46:47+0000",
            "content": "Uwe's suggestion helped us to check this patch working on various platforms without causing someone trouble. Actually, Java 9 Jenkins found that SnakeYAML stuff uses reflection in illegal ways, which we couldn't notice before committing.\n\n... and the results look good so far. I'd like to commit this to master and branch_7x soon. ",
            "author": "Koji Sekiguchi",
            "id": "comment-16385552"
        },
        {
            "date": "2018-03-05T06:36:54+0000",
            "content": "Commit 6d66fc04b23358f58ae13020a399013e13063b4f in lucene-solr's branch refs/heads/master from koji\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6d66fc0 ]\n\nSOLR-11795: Add Solr metrics exporter for Prometheus ",
            "author": "ASF subversion and git services",
            "id": "comment-16385658"
        },
        {
            "date": "2018-03-05T07:05:02+0000",
            "content": "Commit b07382c6e429fbb0db3a33d6d85044ee730a7fc0 in lucene-solr's branch refs/heads/branch_7x from koji\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b07382c ]\n\nSOLR-11795: Add Solr metrics exporter for Prometheus ",
            "author": "ASF subversion and git services",
            "id": "comment-16385685"
        },
        {
            "date": "2018-03-05T08:20:36+0000",
            "content": "Hi Koji,\nlooks fine now. I hope Windows Jenkins is also happy (I had not enabled it on the branch). But the new code looks like it closes all files correctly in tests.\n\nDavid Smiley: The reason for the extra job was: We had a separate branch to improve the module, because originally there were multiple problems with it:\n\n\n\tOthers and I complained about yet another config file format\n\tsnakeYAML had problems on Java 9 and later (this was solved upstream, but the first item caused us to go away from that library) and change to conventional solr-like XML.\n\tBeasting wouldn't have helped, as it was platform-specific test failures , easy to reproduce. So running it in a branch before merging was a good idea. The main reason was also the noise currently going on on the mailing lists about BadApples, so it was easier to track separately.\n\tThere was also lots of commit activity, so a branch looked like a good idea.\n\n\n\nPersonally, I often create a private branch on Github and execute it on Policeman Jenkins. I did this for the MR-JAR changes for longer time, just to test all variants of environments.\n\nThanks to all,\nUwe ",
            "author": "Uwe Schindler",
            "id": "comment-16385766"
        },
        {
            "date": "2018-03-05T08:23:54+0000",
            "content": "Can we resolve the issue? ",
            "author": "Uwe Schindler",
            "id": "comment-16385769"
        },
        {
            "date": "2018-03-05T08:28:06+0000",
            "content": "Yes, thanks Uwe and all! ",
            "author": "Koji Sekiguchi",
            "id": "comment-16385777"
        },
        {
            "date": "2018-03-05T22:37:48+0000",
            "content": "A couple of really tiny things I noticed when I was reviewing the documentation. These could go in another issue if you'd like since this one is resolved already:\n\n\n\tI downloaded the branch_7x build from Jenkins in order to try it out, and noticed that in contrib/prometheus-exporter there is a README.txt but it only contains the text literally \"README.md\". In the source, I see README.md also but it and its contents are not coming out in the built version.\n\tThe alternative form of the -n parameter is --num-thread, but everywhere else in the code and docs the word \"threads\" is used in its plural form. I think it will cause a bit of confusion is the parameter is --num-thread instead of --num-threads, and we should change it before it's released.\n\t\n\t\tSpeaking of which, anything else the docs could say about this parameter besides \"the number of threads\"? What's a recommended number of threads? Is there a default number? What are the impacts of higher and lower numbers of threads?\n\t\n\t\n\n ",
            "author": "Cassandra Targett",
            "id": "comment-16386879"
        },
        {
            "date": "2018-03-06T02:15:42+0000",
            "content": "Hi\u00a0Cassandra Targett,\nThanks for letting me know it. I will attach patch for Ref Guide. Please wait a moment. ",
            "author": "Minoru Osuka",
            "id": "comment-16387161"
        },
        {
            "date": "2018-03-06T05:46:52+0000",
            "content": "Hi\u00a0Cassandra Targett and Koji Sekiguchi,\n\nI attached a new patch (SOLR-11795-12.patch) for above comment.\n\nIt includes the following changes:\n\n\tFix typo in CLI help and document.\n\tDescribe default values.\n\tFormat a document like other one.\n\tChange README.txt to synbolic link like contrib/ltr.\n\n\n\nCould you please review again? ",
            "author": "Minoru Osuka",
            "id": "comment-16387324"
        },
        {
            "date": "2018-03-06T07:26:15+0000",
            "content": "Hi\u00a0Cassandra Targett and Koji Sekiguchi,\n\nSorry, I will make README.txt without creating README.md.\nI withdraw SOLR-11795-12.patch. ",
            "author": "Minoru Osuka",
            "id": "comment-16387417"
        },
        {
            "date": "2018-03-06T07:46:37+0000",
            "content": "Hi\u00a0Cassandra Targett and Koji Sekiguchi,\n\nI'm sorry to bother you over and over. I attached SOLR-11795-ref-guide.patch for above comment.\n\nIt includes the following changes:\n\n\tFix typo in CLI help and document.\n\tDescribe default values.\n\tFormat a document like other one.\n\tCreate correct README.txt.\n\n ",
            "author": "Minoru Osuka",
            "id": "comment-16387431"
        },
        {
            "date": "2018-03-06T07:55:40+0000",
            "content": "Thanks. I'll apply the additional patch soon. ",
            "author": "Koji Sekiguchi",
            "id": "comment-16387437"
        },
        {
            "date": "2018-03-06T13:23:34+0000",
            "content": "Can we remove the monitoring-solr-with-prometheus-and-grafana.adoc changes from the patch? When I said I was \"reviewing\" it\u00a0as committed, I should have said I was actually doing some extensive structural changes to the page. I can use the added info in the patch to augment the\u00a0information within the changes I'm making, but if you commit those changes I'll have a big conflict to work through.\n\nFYI, among the changes I'm making to monitoring-solr-with-prometheus-and-grafana.adoc:\n\n\tChanging the solr-exporter help output section to a labeled list of\u00a0properly presented parameters\n\tChanging parameters in tables to labeled lists\n\tAdding more context to the instructions throughout based on a first-time experience setting it up and using it\n\tCorrecting paths to the contrib folder and files within it\n\tAdding a tab section for the startup instructions to present Linux\u00a0& Windows\u00a0\n\tAdding context to the solr-exporter configuration file to explain its overall structure\n\n\n\nI'm only about halfway through, but the page will be a much more complete section of documentation when I'm done. I could have made these recommendations earlier, but I was busy with other things and didn't get a chance. ",
            "author": "Cassandra Targett",
            "id": "comment-16387754"
        },
        {
            "date": "2018-03-06T14:03:09+0000",
            "content": "Looking at the patch closer, it seems many of the changes I'm making locally are done there also. \n\nAnd, after catching up with commits overnight my time, it seems it was already committed. OK, half a day's work wasted, I'll figure it out. ",
            "author": "Cassandra Targett",
            "id": "comment-16387824"
        },
        {
            "date": "2018-03-06T15:55:38+0000",
            "content": "Sorry, one more bit of feedback - I didn't realize until the new doc updates that the default port for Prometheus to listen on is 9983. That's the default port that Solr uses for the embedded ZooKeeper. If someone is in SolrCloud mode with the embedded ZK, that would cause a port conflict. IMO, it would be best for us to simply reserve port 9983 in Solr for ZK always, and a different default port should be selected here. ",
            "author": "Cassandra Targett",
            "id": "comment-16387997"
        },
        {
            "date": "2018-03-07T02:30:01+0000",
            "content": "Hi Cassandra Targett,\n\nThank you for your feedback and the corrections. Your corrections are pretty clear!\nhttps://github.com/apache/lucene-solr/commit/be11f56bbcf3085829f09eb9d30eede4bba62705 ",
            "author": "Minoru Osuka",
            "id": "comment-16388911"
        },
        {
            "date": "2018-03-13T05:05:35+0000",
            "content": "Mark as resolved. Thanks everyone! ",
            "author": "Koji Sekiguchi",
            "id": "comment-16396550"
        }
    ]
}