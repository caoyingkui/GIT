{
    "id": "SOLR-11088",
    "title": "MetricsHandlerTest.testPropertyFilter failures on jenkins",
    "details": {
        "labels": "",
        "priority": "Minor",
        "components": [
            "Tests"
        ],
        "type": "Bug",
        "fix_versions": [
            "7.0",
            "master (8.0)"
        ],
        "affect_versions": "None",
        "resolution": "Fixed",
        "status": "Resolved"
    },
    "description": "This test fails sporadically on jenkins on all branches.\n\nBuild: https://jenkins.thetaphi.de/job/Lucene-Solr-7.0-Linux/26/\nJava: 32bit/jdk-9-ea+175 -client -XX:+UseG1GC --illegal-access=deny\n\n1 tests failed.\nFAILED:  org.apache.solr.handler.admin.MetricsHandlerTest.testPropertyFilter\n\nError Message:\n\n\nStack Trace:\njava.lang.AssertionError\n        at __randomizedtesting.SeedInfo.seed([B82CD91875945ACD:DA412759BA1A3AF3]:0)\n        at org.junit.Assert.fail(Assert.java:92)\n        at org.junit.Assert.assertTrue(Assert.java:43)\n        at org.junit.Assert.assertNotNull(Assert.java:526)\n        at org.junit.Assert.assertNotNull(Assert.java:537)\n        at org.apache.solr.handler.admin.MetricsHandlerTest.testPropertyFilter(MetricsHandlerTest.java:201)",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2017-07-16T03:30:28+0000",
            "content": "Log from the run given in description:\n\n   [junit4] Suite: org.apache.solr.handler.admin.MetricsHandlerTest\n   [junit4]   2> Creating dataDir: /home/jenkins/workspace/Lucene-Solr-7.0-Linux/solr/build/solr-core/test/J2/temp/solr.handler.admin.MetricsHandlerTest_B82CD91875945ACD-001/init-core-data-001\n   [junit4]   2> 566051 WARN  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.SolrTestCaseJ4 startTrackingSearchers: numOpens=11 numCloses=11\n   [junit4]   2> 566051 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.SolrTestCaseJ4 Using PointFields (NUMERIC_POINTS_SYSPROP=true) w/NUMERIC_DOCVALUES_SYSPROP=false\n   [junit4]   2> 566052 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.SolrTestCaseJ4 Randomized ssl (true) and clientAuth (true) via: @org.apache.solr.util.RandomizeSSL(reason=\"\", ssl=0.0/0.0, value=0.0/0.0, clientAuth=0.0/0.0)\n   [junit4]   2> 566053 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.SolrTestCaseJ4 ####initCore\n   [junit4]   2> 566054 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.c.SolrResourceLoader [null] Added 2 libs to classloader, from paths: [/home/jenkins/workspace/Lucene-Solr-7.0-Linux/solr/core/src/test-files/solr/collection1/lib, /home/jenkins/workspace/Lucene-Solr-7.0-Linux/solr/core/src/test-files/solr/collection1/lib/classes]\n   [junit4]   2> 566087 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.c.SolrConfig Using Lucene MatchVersion: 7.0.0\n   [junit4]   2> 566110 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.s.IndexSchema [null] Schema name=test\n   [junit4]   2> 566280 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.s.IndexSchema Loaded schema test/1.0 with uniqueid field id\n   [junit4]   2> 566336 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.m.r.SolrJmxReporter JMX monitoring for 'solr.node' (registry 'solr.node') enabled at server: com.sun.jmx.mbeanserver.JmxMBeanServer@f72a74\n   [junit4]   2> 566341 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.m.r.SolrJmxReporter JMX monitoring for 'solr.jvm' (registry 'solr.jvm') enabled at server: com.sun.jmx.mbeanserver.JmxMBeanServer@f72a74\n   [junit4]   2> 566342 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.m.r.SolrJmxReporter JMX monitoring for 'solr.jetty' (registry 'solr.jetty') enabled at server: com.sun.jmx.mbeanserver.JmxMBeanServer@f72a74\n   [junit4]   2> 566347 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.c.SolrResourceLoader [null] Added 2 libs to classloader, from paths: [/home/jenkins/workspace/Lucene-Solr-7.0-Linux/solr/core/src/test-files/solr/collection1/lib, /home/jenkins/workspace/Lucene-Solr-7.0-Linux/solr/core/src/test-files/solr/collection1/lib/classes]\n   [junit4]   2> 566377 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.c.SolrConfig Using Lucene MatchVersion: 7.0.0\n   [junit4]   2> 566395 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.s.IndexSchema [collection1] Schema name=test\n   [junit4]   2> 566461 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.s.IndexSchema Loaded schema test/1.0 with uniqueid field id\n   [junit4]   2> 566468 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.c.CoreContainer Creating SolrCore 'collection1' using configuration from instancedir /home/jenkins/workspace/Lucene-Solr-7.0-Linux/solr/core/src/test-files/solr/collection1, trusted=true\n   [junit4]   2> 566469 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.m.r.SolrJmxReporter JMX monitoring for 'solr.core.collection1' (registry 'solr.core.collection1') enabled at server: com.sun.jmx.mbeanserver.JmxMBeanServer@f72a74\n   [junit4]   2> 566469 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.c.SolrCore solr.RecoveryStrategy.Builder\n   [junit4]   2> 566469 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.c.SolrCore [[collection1] ] Opening new SolrCore at [/home/jenkins/workspace/Lucene-Solr-7.0-Linux/solr/core/src/test-files/solr/collection1], dataDir=[/home/jenkins/workspace/Lucene-Solr-7.0-Linux/solr/build/solr-core/test/J2/temp/solr.handler.admin.MetricsHandlerTest_B82CD91875945ACD-001/init-core-data-001/]\n   [junit4]   2> 566471 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.u.RandomMergePolicy RandomMergePolicy wrapping class org.apache.lucene.index.TieredMergePolicy: [TieredMergePolicy: maxMergeAtOnce=30, maxMergeAtOnceExplicit=12, maxMergedSegmentMB=40.8544921875, floorSegmentMB=1.2548828125, forceMergeDeletesPctAllowed=18.404155282579794, segmentsPerTier=19.0, maxCFSSegmentSizeMB=8.796093022207999E12, noCFSRatio=0.0\n   [junit4]   2> 566513 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.u.UpdateHandler Using UpdateLog implementation: org.apache.solr.update.UpdateLog\n   [junit4]   2> 566513 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.u.UpdateLog Initializing UpdateLog: dataDir= defaultSyncLevel=FLUSH numRecordsToKeep=100 maxNumLogsToKeep=10 numVersionBuckets=65536\n   [junit4]   2> 566514 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.u.CommitTracker Hard AutoCommit: disabled\n   [junit4]   2> 566514 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.u.CommitTracker Soft AutoCommit: disabled\n   [junit4]   2> 566515 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.u.RandomMergePolicy RandomMergePolicy wrapping class org.apache.lucene.index.AlcoholicMergePolicy: [AlcoholicMergePolicy: minMergeSize=0, mergeFactor=10, maxMergeSize=2084253271, maxMergeSizeForForcedMerge=9223372036854775807, calibrateSizeByDeletes=true, maxMergeDocs=2147483647, maxCFSSegmentSizeMB=8.796093022207999E12, noCFSRatio=0.1]\n   [junit4]   2> 566515 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.s.SolrIndexSearcher Opening [Searcher@8999d5[collection1] main]\n   [junit4]   2> 566516 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.h.c.SpellCheckComponent Initializing spell checkers\n   [junit4]   2> 566538 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.s.DirectSolrSpellChecker init: {name=direct,classname=DirectSolrSpellChecker,field=lowerfilt,minQueryLength=3}\n   [junit4]   2> 566599 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.h.ReplicationHandler Commits will be reserved for  10000\n   [junit4]   2> 566599 INFO  (coreLoadExecutor-1767-thread-1) [    ] o.a.s.u.UpdateLog Could not find max version in index or recent updates, using new clock 1573032644271144960\n   [junit4]   2> 566600 INFO  (searcherExecutor-1768-thread-1) [    ] o.a.s.h.c.SpellCheckComponent Loading spell index for spellchecker: default\n   [junit4]   2> 566601 INFO  (searcherExecutor-1768-thread-1) [    ] o.a.s.h.c.SpellCheckComponent Loading spell index for spellchecker: direct\n   [junit4]   2> 566601 INFO  (searcherExecutor-1768-thread-1) [    ] o.a.s.h.c.SpellCheckComponent Loading spell index for spellchecker: wordbreak\n   [junit4]   2> 566601 INFO  (searcherExecutor-1768-thread-1) [    ] o.a.s.h.c.SpellCheckComponent Loading spell index for spellchecker: multipleFields\n   [junit4]   2> 566601 INFO  (searcherExecutor-1768-thread-1) [    ] o.a.s.h.c.SpellCheckComponent Loading spell index for spellchecker: jarowinkler\n   [junit4]   2> 566601 INFO  (searcherExecutor-1768-thread-1) [    ] o.a.s.h.c.SpellCheckComponent Loading spell index for spellchecker: external\n   [junit4]   2> 566601 INFO  (searcherExecutor-1768-thread-1) [    ] o.a.s.h.c.SpellCheckComponent Loading spell index for spellchecker: freq\n   [junit4]   2> 566602 INFO  (searcherExecutor-1768-thread-1) [    ] o.a.s.h.c.SpellCheckComponent Loading spell index for spellchecker: fqcn\n   [junit4]   2> 566602 INFO  (searcherExecutor-1768-thread-1) [    ] o.a.s.h.c.SpellCheckComponent Loading spell index for spellchecker: perDict\n   [junit4]   2> 566602 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.SolrTestCaseJ4 ####initCore end\n   [junit4]   2> 566604 INFO  (TEST-MetricsHandlerTest.testPropertyFilter-seed#[B82CD91875945ACD]) [    ] o.a.s.SolrTestCaseJ4 ###Starting testPropertyFilter\n   [junit4]   2> 566606 INFO  (TEST-MetricsHandlerTest.testPropertyFilter-seed#[B82CD91875945ACD]) [    ] o.a.s.SolrTestCaseJ4 ###Ending testPropertyFilter\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=MetricsHandlerTest -Dtests.method=testPropertyFilter -Dtests.seed=B82CD91875945ACD -Dtests.multiplier=3 -Dtests.slow=true -Dtests.locale=yo-NG -Dtests.timezone=IET -Dtests.asserts=true -Dtests.file.encoding=UTF-8\n   [junit4] FAILURE 0.00s J2 | MetricsHandlerTest.testPropertyFilter <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([B82CD91875945ACD:DA412759BA1A3AF3]:0)\n   [junit4]    > \tat org.apache.solr.handler.admin.MetricsHandlerTest.testPropertyFilter(MetricsHandlerTest.java:201)\n   [junit4]    > \tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n   [junit4]    > \tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n   [junit4]    > \tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n   [junit4]    > \tat java.base/java.lang.reflect.Method.invoke(Method.java:564)\n   [junit4]    > \tat java.base/java.lang.Thread.run(Thread.java:844)\n   [junit4]   2> 566609 INFO  (searcherExecutor-1768-thread-1) [    ] o.a.s.c.SolrCore [collection1] Registered new searcher Searcher@8999d5[collection1] main{ExitableDirectoryReader(UninvertingDirectoryReader())}\n   [junit4]   2> 566615 INFO  (TEST-MetricsHandlerTest.testCompact-seed#[B82CD91875945ACD]) [    ] o.a.s.SolrTestCaseJ4 ###Starting testCompact\n   [junit4]   2> 566622 INFO  (TEST-MetricsHandlerTest.testCompact-seed#[B82CD91875945ACD]) [    ] o.a.s.c.TransientSolrCoreCacheDefault Allocating transient cache for 2147483647 transient cores\n   [junit4]   2> 566639 INFO  (TEST-MetricsHandlerTest.testCompact-seed#[B82CD91875945ACD]) [    ] o.a.s.SolrTestCaseJ4 ###Ending testCompact\n   [junit4]   2> 566646 INFO  (TEST-MetricsHandlerTest.test-seed#[B82CD91875945ACD]) [    ] o.a.s.SolrTestCaseJ4 ###Starting test\n   [junit4]   2> 566672 INFO  (TEST-MetricsHandlerTest.test-seed#[B82CD91875945ACD]) [    ] o.a.s.SolrTestCaseJ4 ###Ending test\n   [junit4]   2> 566673 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.SolrTestCaseJ4 ###deleteCore\n   [junit4]   2> 566673 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.c.CoreContainer Shutting down CoreContainer instance=8976589\n   [junit4]   2> 566673 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.m.SolrMetricManager Closing metric reporters for registry=solr.node, tag=null\n   [junit4]   2> 566674 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.m.SolrMetricManager Closing metric reporters for registry=solr.jvm, tag=null\n   [junit4]   2> 566685 INFO  (SUITE-MetricsHandlerTest-seed#[B82CD91875945ACD]-worker) [    ] o.a.s.m.SolrMetricManager Closing metric reporters for registry=solr.jetty, tag=null\n   [junit4]   2> 566686 INFO  (coreCloseExecutor-1773-thread-1) [    ] o.a.s.c.SolrCore [collection1]  CLOSING SolrCore org.apache.solr.core.SolrCore@1701e0b\n   [junit4]   2> 566701 INFO  (coreCloseExecutor-1773-thread-1) [    ] o.a.s.m.SolrMetricManager Closing metric reporters for registry=solr.core.collection1, tag=24124939\n   [junit4]   2> NOTE: leaving temporary files on disk at: /home/jenkins/workspace/Lucene-Solr-7.0-Linux/solr/build/solr-core/test/J2/temp/solr.handler.admin.MetricsHandlerTest_B82CD91875945ACD-001\n   [junit4]   2> NOTE: test params are: codec=Lucene70, sim=RandomSimilarity(queryNorm=false): {}, locale=yo-NG, timezone=IET\n   [junit4]   2> NOTE: Linux 4.10.0-26-generic i386/Oracle Corporation 9 (32-bit)/cpus=8,threads=1,free=159274152,total=536870912\n   [junit4]   2> NOTE: All tests run in this JVM: [TestStressUserVersions, TestClassicSimilarityFactory, DirectUpdateHandlerOptimizeTest, JvmMetricsTest, AtomicUpdatesTest, HdfsRestartWhileUpdatingTest, SubstringBytesRefFilterTest, PKIAuthenticationIntegrationTest, HdfsChaosMonkeyNothingIsSafeTest, TestPerFieldSimilarityWithDefaultOverride, TestSurroundQueryParser, TestCloudInspectUtil, TestPseudoReturnFields, SimpleFacetsTest, TestRestoreCore, OverriddenZkACLAndCredentialsProvidersTest, TestStressInPlaceUpdates, BlockDirectoryTest, SimpleCollectionCreateDeleteTest, TestPolicyCloud, TestAnalyzedSuggestions, TestSolrDeletionPolicy2, TestPivotHelperCode, UniqFieldsUpdateProcessorFactoryTest, TestMacroExpander, TestRandomCollapseQParserPlugin, SuggesterTest, TestDocBasedVersionConstraints, TestLMJelinekMercerSimilarityFactory, PathHierarchyTokenizerFactoryTest, MetricUtilsTest, ResponseLogComponentTest, UninvertDocValuesMergePolicyTest, OverseerTest, TestDistributedStatsComponentCardinality, StatsComponentTest, ReplaceNodeTest, PeerSyncReplicationTest, HdfsTlogReplayBufferedWhileIndexingTest, VersionInfoTest, TestMultiWordSynonyms, CircularListTest, PrimitiveFieldTypeTest, DocumentBuilderTest, TestSuggestSpellingConverter, TestFastWriter, TestManagedResource, DistributedQueryComponentOptimizationTest, TestLegacyNumericRangeQueryBuilder, TestSolrCloudWithKerberosAlt, TestCollapseQParserPlugin, TestFreeTextSuggestions, TestLRUStatsCache, UnloadDistributedZkTest, TestBulkSchemaAPI, TestQuerySenderListener, AliasIntegrationTest, TestHdfsBackupRestoreCore, BitVectorTest, CoreAdminRequestStatusTest, TestCorePropertiesReload, PingRequestHandlerTest, TestShortCircuitedRequests, TermsComponentTest, TestLeaderInitiatedRecoveryThread, TestSubQueryTransformer, TestSimpleTextCodec, TestRequestStatusCollectionAPI, MetricsHandlerTest]\n\n ",
            "author": "Shalin Shekhar Mangar",
            "id": "comment-16088793"
        },
        {
            "date": "2017-07-16T03:32:28+0000",
            "content": "The problem here is that the test fetches prefix=CACHE.searcher from the metrics handler and according to the logs, the searcher hasn't been registered before the test ran. So it fails after finding that the core stats being registered are null. It should be easy to fix by making a query to the core (which can only return after a searcher is registered) and then calling metrics handler. ",
            "author": "Shalin Shekhar Mangar",
            "id": "comment-16088794"
        },
        {
            "date": "2017-07-16T03:37:33+0000",
            "content": "Commit bab1731b23feb1a85c4258d26913e668d6c18397 in lucene-solr's branch refs/heads/master from Shalin Shekhar Mangar\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=bab1731 ]\n\nSOLR-11088: Fix sporadic failures of MetricsHandlerTest.testPropertyFilter on jenkins ",
            "author": "ASF subversion and git services",
            "id": "comment-16088795"
        },
        {
            "date": "2017-07-16T03:38:12+0000",
            "content": "I'll keep this open for a while to see if the commit fixed the problem on master. ",
            "author": "Shalin Shekhar Mangar",
            "id": "comment-16088796"
        },
        {
            "date": "2017-07-20T02:44:36+0000",
            "content": "I haven't seen this happen on master but the same error has been seen on 7.x. I'll backport to other branches and keep an eye on jenkins. ",
            "author": "Shalin Shekhar Mangar",
            "id": "comment-16094101"
        },
        {
            "date": "2017-07-20T02:47:11+0000",
            "content": "Commit 43570e55dd1f29f84826ee19675f3e05ab0dbf34 in lucene-solr's branch refs/heads/branch_7x from Shalin Shekhar Mangar\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=43570e5 ]\n\nSOLR-11088: Fix sporadic failures of MetricsHandlerTest.testPropertyFilter on jenkins\n\n(cherry picked from commit bab1731) ",
            "author": "ASF subversion and git services",
            "id": "comment-16094104"
        },
        {
            "date": "2017-07-20T02:47:53+0000",
            "content": "Commit eac6484fd4ea7e94d9d3cff9c7d48a7863e57a67 in lucene-solr's branch refs/heads/branch_7_0 from Shalin Shekhar Mangar\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=eac6484 ]\n\nSOLR-11088: Fix sporadic failures of MetricsHandlerTest.testPropertyFilter on jenkins\n\n(cherry picked from commit bab1731)\n\n(cherry picked from commit 43570e5) ",
            "author": "ASF subversion and git services",
            "id": "comment-16094105"
        }
    ]
}