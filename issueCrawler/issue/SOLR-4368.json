{
    "id": "SOLR-4368",
    "title": "StatsComponent fails working with TriField",
    "details": {
        "affect_versions": "4.0",
        "status": "Open",
        "fix_versions": [],
        "components": [
            "SearchComponents - other"
        ],
        "type": "Bug",
        "priority": "Minor",
        "labels": "",
        "resolution": "Unresolved"
    },
    "description": "in the schema.xml under the solr/example/solr/collection1/conf/ directory, I modified the following three fields' type to TriField:\n   <field name=\"weight\" type=\"tfloat\" indexed=\"true\" stored=\"true\"/>\n   <field name=\"price\"  type=\"tfloat\" indexed=\"true\" stored=\"true\"/>\n   <field name=\"popularity\" type=\"tint\" indexed=\"true\" stored=\"true\" />\nThen I upload some documents under solr/exampledocs\njava -Durl=http://localhost:8983/solr/collection1/update -jar post.jar mem.xml\njava -Durl=http://localhost:8983/solr/collection1/update -jar post.jar monitor.xml\njava -Durl=http://localhost:8983/solr/collection1/update -jar post.jar monitor2.xml\njava -Durl=http://localhost:8983/solr/collection1/update -jar post.jar ipad_other.xml\n\nAfter that, I call the StatsComponent:\nhttp://localhost:8983/solr/collection1/select?q=*:*&wt=xml&rows=0&stats=true&stats.field=weight&stats.field=price&stats.facet=popularity\n\nI will catch an error:\nJan 24, 2013 6:03:30 PM org.apache.solr.core.SolrCore execute\nINFO: [collection1] webapp=/solr path=/select params=\n{stats=true&distrib=false&wt=javabin&rows=10&version=2&NOW=1359021750668&shard.url=chn-bigdata-node3:8983/solr/collection1/&fl=id,score&df=text&start=0&stats.field=ss_quantity&q=*:*&isShard=true&fsv=true&f.ss_quantity.stats.facet=ss_store_sk&f.ss_quantity.stats.facet=ss_item_sk}\n hits=71995919 status=500 QTime=59252 \nJan 24, 2013 6:03:30 PM org.apache.solr.common.SolrException log\nSEVERE: null:java.lang.NumberFormatException: For input string: \"L\"\n        at java.lang.NumberFormatException.forInputString(NumberFormatException.java:65)\n        at java.lang.Integer.parseInt(Integer.java:481)\n        at java.lang.Integer.parseInt(Integer.java:514)\n        at org.apache.solr.schema.TrieField.readableToIndexed(TrieField.java:312)\n        at org.apache.solr.schema.TrieField.readableToIndexed(TrieField.java:303)\n        at org.apache.solr.schema.TrieField.toInternal(TrieField.java:333)\n        at org.apache.solr.request.UnInvertedField.getStats(UnInvertedField.java:610)\n        at org.apache.solr.handler.component.SimpleStats.getStatsFields(StatsComponent.java:225)\n        at org.apache.solr.handler.component.SimpleStats.getStatsCounts(StatsComponent.java:201)\n        at org.apache.solr.handler.component.StatsComponent.process(StatsComponent.java:70)\n        at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:206)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1699)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:455)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:276)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1337)\n        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:484)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:119)\n        at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:524)\n        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:233)\n        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1065)\n        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:413)\n        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:192)\n        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:999)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:117)\n        at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:250)\n        at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:149)\n        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:111)\n        at org.eclipse.jetty.server.Server.handle(Server.java:351)\n        at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:454)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handleRequest(BlockingHttpConnection.java:47)\n        at org.eclipse.jetty.server.AbstractHttpConnection.content(AbstractHttpConnection.java:900)\n        at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.content(AbstractHttpConnection.java:954)\n        at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:857)\n        at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:66)\n        at org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:254)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:599)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:534)\n        at java.lang.Thread.run(Thread.java:679)\n\nJan 25, 2013 9:57:58 AM org.apache.solr.common.SolrException log\nSEVERE: java.lang.NumberFormatException: For input string: \"L\"\n        at java.lang.NumberFormatException.forInputString(NumberFormatException.java:65)\n        at java.lang.Integer.parseInt(Integer.java:481)\n        at java.lang.Integer.parseInt(Integer.java:514)\n        at org.apache.solr.schema.TrieField.readableToIndexed(TrieField.java:312)\n        at org.apache.solr.schema.TrieField.readableToIndexed(TrieField.java:303)\n        at org.apache.solr.schema.TrieField.toInternal(TrieField.java:333)\n        at org.apache.solr.request.UnInvertedField.getStats(UnInvertedField.java:610)\n        at org.apache.solr.handler.component.SimpleStats.getStatsFields(StatsComponent.java:225)\n        at org.apache.solr.handler.component.SimpleStats.getStatsCounts(StatsComponent.java:201)\n        at org.apache.solr.handler.component.StatsComponent.process(StatsComponent.java:70)\n        at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:206)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1699)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:455)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:276)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1337)\n        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:484)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:119)\n        at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:524)\n        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:233)\n        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1065)\n        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:413)\n        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:192)\n        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:999)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:117)\n        at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:250)\n        at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:149)\n        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:111)\n        at org.eclipse.jetty.server.Server.handle(Server.java:351)\n        at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:454)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handleRequest(BlockingHttpConnection.java:47)\n        at org.eclipse.jetty.server.AbstractHttpConnection.content(AbstractHttpConnection.java:900)\n        at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.content(AbstractHttpConnection.java:954)\n        at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:857)\n        at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:66)\n        at org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:254)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:599)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:534)\n        at java.lang.Thread.run(Thread.java:679)\n\nJan 25, 2013 9:57:58 AM org.apache.solr.core.SolrCore execute\nINFO: [collection1] webapp=/solr path=/select params=\n{stats=true&distrib=false&wt=javabin&rows=10&version=2&NOW=1359079054099&shard.url=chn-bigdata-node3:8983/solr/collection1/&fl=id,score&df=text&start=0&stats.field=ss_quantity&q=*:*&isShard=true&fsv=true&f.ss_quantity.stats.facet=ss_store_sk&f.ss_quantity.stats.facet=ss_item_sk}\n hits=71995919 status=500 QTime=24250 \nJan 25, 2013 9:57:58 AM org.apache.solr.common.SolrException log\nSEVERE: null:java.lang.NumberFormatException: For input string: \"L\"\n        at java.lang.NumberFormatException.forInputString(NumberFormatException.java:65)\n        at java.lang.Integer.parseInt(Integer.java:481)\n        at java.lang.Integer.parseInt(Integer.java:514)\n        at org.apache.solr.schema.TrieField.readableToIndexed(TrieField.java:312)\n        at org.apache.solr.schema.TrieField.readableToIndexed(TrieField.java:303)\n        at org.apache.solr.schema.TrieField.toInternal(TrieField.java:333)\n        at org.apache.solr.request.UnInvertedField.getStats(UnInvertedField.java:610)\n        at org.apache.solr.handler.component.SimpleStats.getStatsFields(StatsComponent.java:225)\n        at org.apache.solr.handler.component.SimpleStats.getStatsCounts(StatsComponent.java:201)\n        at org.apache.solr.handler.component.StatsComponent.process(StatsComponent.java:70)\n        at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:206)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1699)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:455)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:276)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1337)\n        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:484)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:119)\n        at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:524)\n        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:233)\n        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1065)\n        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:413)\n        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:192)\n        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:999)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:117)\n        at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:250)\n        at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:149)\n        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:111)\n        at org.eclipse.jetty.server.Server.handle(Server.java:351)\n        at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:454)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handleRequest(BlockingHttpConnection.java:47)\n        at org.eclipse.jetty.server.AbstractHttpConnection.content(AbstractHttpConnection.java:900)\n        at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.content(AbstractHttpConnection.java:954)\n        at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:857)\n        at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:66)\n        at org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:254)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:599)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:534)\n        at java.lang.Thread.run(Thread.java:679)",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "author": "zuwang",
            "id": "comment-13564018",
            "date": "2013-01-28T03:28:40+0000",
            "content": "in one method in org.apache.solr.handler.component.FieldFacetStats.java, I annotated the line of code that I think it's a Bug, and add the correct code bellow. Now it works well.\n\n  public boolean facetTermNum(int docID, int statsTermNum) {\n\n    int term = si.getOrd(docID);\n    int arrIdx = term - startTermIndex;\n    if (arrIdx >= 0 && arrIdx < nTerms) {\n      final BytesRef br = si.lookup(term, tempBR);\n      //String key = br == null ? null : br.utf8ToString();\n      String key = (br == null)?null:facet_sf.getType().indexedToReadable(br.utf8ToString());\n      HashMap<String, Integer> statsTermCounts = facetStatsTerms.get(statsTermNum);\n      Integer statsTermCount = statsTermCounts.get(key);\n      if (statsTermCount == null) \n{\n        statsTermCounts.put(key, 1);\n      }\n else \n{\n        statsTermCounts.put(key, statsTermCount + 1);\n      }\n      return true;\n    }\n    return false;\n  } "
        },
        {
            "author": "zuwang",
            "id": "comment-13565196",
            "date": "2013-01-29T08:49:15+0000",
            "content": "I found the results is incorrect. I will look into it later. "
        }
    ]
}