{
    "id": "SOLR-11278",
    "title": "Fix race in cdcr bootstrap process",
    "details": {
        "labels": "",
        "priority": "Critical",
        "components": [
            "CDCR"
        ],
        "type": "Bug",
        "fix_versions": [
            "7.1"
        ],
        "affect_versions": "6.6.1,                                            7.0",
        "resolution": "Fixed",
        "status": "Closed"
    },
    "description": "CdcrBootstrapTest is failing while running beasts for significant iterations.\n\nThe bootstrapping is failing in the test, after the first batch is indexed for each testmethod, which results in documents mismatch ::\n\n\n  [beaster]   2> 39167 ERROR (updateExecutor-39-thread-1-processing-n:127.0.0.1:42155_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42155_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler Bootstrap operation failed\n  [beaster]   2> java.util.concurrent.ExecutionException: java.lang.AssertionError\n  [beaster]   2> \tat java.util.concurrent.FutureTask.report(FutureTask.java:122)\n  [beaster]   2> \tat java.util.concurrent.FutureTask.get(FutureTask.java:192)\n  [beaster]   2> \tat org.apache.solr.handler.CdcrRequestHandler.lambda$handleBootstrapAction$0(CdcrRequestHandler.java:654)\n  [beaster]   2> \tat com.codahale.metrics.InstrumentedExecutorService$InstrumentedRunnable.run(InstrumentedExecutorService.java:176)\n  [beaster]   2> \tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n  [beaster]   2> \tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n  [beaster]   2> \tat org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:188)\n  [beaster]   2> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n  [beaster]   2> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n  [beaster]   2> \tat java.lang.Thread.run(Thread.java:748)\n  [beaster]   2> Caused by: java.lang.AssertionError\n  [beaster]   2> \tat org.apache.solr.handler.CdcrRequestHandler$BootstrapCallable.call(CdcrRequestHandler.java:813)\n  [beaster]   2> \tat org.apache.solr.handler.CdcrRequestHandler$BootstrapCallable.call(CdcrRequestHandler.java:724)\n  [beaster]   2> \tat com.codahale.metrics.InstrumentedExecutorService$InstrumentedCallable.call(InstrumentedExecutorService.java:197)\n  [beaster]   2> \t... 5 more\n\n\n\n\n  [beaster] [01:37:16.282] FAILURE  153s | CdcrBootstrapTest.testBootstrapWithSourceCluster <<<\n  [beaster]    > Throwable #1: java.lang.AssertionError: Document mismatch on target after sync expected:<2000> but was:<1000>",
    "attachments": {
        "SOLR-11278-cancel-bootstrap-on-stop.patch": "https://issues.apache.org/jira/secure/attachment/12884483/SOLR-11278-cancel-bootstrap-on-stop.patch",
        "master-bs.patch": "https://issues.apache.org/jira/secure/attachment/12884984/master-bs.patch",
        "SOLR-11278.patch": "https://issues.apache.org/jira/secure/attachment/12884217/SOLR-11278.patch",
        "SOLR-11278-awaits-fix.patch": "https://issues.apache.org/jira/secure/attachment/12885097/SOLR-11278-awaits-fix.patch",
        "test_results": "https://issues.apache.org/jira/secure/attachment/12883404/test_results"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2017-08-23T20:00:06+0000",
            "content": "attached entire log: test_results ",
            "author": "Amrit Sarkar",
            "id": "comment-16138977"
        },
        {
            "date": "2017-08-28T06:45:07+0000",
            "content": "In waitForTargetToSync(), we are issuing commit to \"targetCollection\" every second, making it close old searcher and open a new one. Not sure whether this is the best way to verify documents indexed in \"target\" collection. ",
            "author": "Amrit Sarkar",
            "id": "comment-16143436"
        },
        {
            "date": "2017-08-28T12:13:51+0000",
            "content": "Here's another fail on branch_6_6 : https://jenkins.thetaphi.de/job/Lucene-Solr-6.6-Windows/40/ ",
            "author": "Varun Thacker",
            "id": "comment-16143712"
        },
        {
            "date": "2017-08-28T15:50:30+0000",
            "content": "\n \n [beaster] Tests with failures [seed: 8D740119BA9589F1]:\n  [beaster]   - org.apache.solr.cloud.CdcrBootstrapTest.testConvertClusterToCdcrAndBootstrap\n  [beaster]   - org.apache.solr.cloud.CdcrBootstrapTest.testBootstrapWithSourceCluster\n\n\n\nSafe to say, all the three tests are NOT passable at all the seeds. ",
            "author": "Amrit Sarkar",
            "id": "comment-16143926"
        },
        {
            "date": "2017-08-28T15:56:03+0000",
            "content": "My bet, and this would be for verification purposes only:\n\nIf on failure we added a single document to the source and tried again we wouldn't fail. Which would implicate SOLR-11034 and SOLR-11035. Hmmm, let me give that a whirl. Those two JIRAs are holding up several other JIRAs,... ",
            "author": "Erick Erickson",
            "id": "comment-16143931"
        },
        {
            "date": "2017-08-28T16:10:55+0000",
            "content": "Posting SOLR-11003 discussion here:\n\nAll the tests in this class fails where we stop CDCR, index docs in source and then turns on CDCR again and expect BOOTSTRAP to happen. If I debug on IDE, all tests passes successfully (as the steps slows down), suggesting the time to wait for target to sync is low. But increasing it to 5 minutes even, instead of default 2 minutes, doesn't work. I increased explicit commit issued while waiting from 1 to 3 second, doesn't work either.\nLet me know if there are other tests which are failing too related to CDCR.\n\nThough the tests which are constantly failing I mentioned above, do Solr Core reload every second when it waits for target to sync. It can very well be variant of SOLR-11034 and/or SOLR-11035, as we can see occasional NPE at IndexFetcher.java:753.\n ",
            "author": "Amrit Sarkar",
            "id": "comment-16143949"
        },
        {
            "date": "2017-08-29T09:40:31+0000",
            "content": "Ok here's what I am able to diagnose and have some questions and observations:\n\n1. Bootstrap process runs in a seperate thread, then what happens we issue a commit when BOOTSTRAPPING, replication / fetchIndex is taking place. Something wrong? Solr core will reload when on the background index is getting copied.\n2. I bumped up the time / sleep time b/w issuing CDCR and checking target collection for numDocs to 7 seconds, and lowered documents from 10K to 2K, since BOOTSTRAP will be issued anything above maxBatchSize: 1024.\n3. The new patch uploaded successfully ran on my system, but it is not a full-proof solution, just like: SOLR-10734, where we cannot agree on a batch / thread count. It may fail for a seed in future or now.\n\nVarun Thacker, requesting if you can apply the patch and verify whether the tests are passing successfully. ",
            "author": "Amrit Sarkar",
            "id": "comment-16145007"
        },
        {
            "date": "2017-08-29T09:42:58+0000",
            "content": "I am running beasts of 100 rounds, if passed, we may very well be comfortable with these changes. ",
            "author": "Amrit Sarkar",
            "id": "comment-16145011"
        },
        {
            "date": "2017-08-29T09:47:26+0000",
            "content": "Hi Amrit,\n\nI removed 6.6 from the Affects Versions(s) as this test fails regularly on other branches too.\n\nIn general this has failed quite a bit while building out an RC for 6.6.1 so it will be nice if we can figure out a fix for it ",
            "author": "Varun Thacker",
            "id": "comment-16145012"
        },
        {
            "date": "2017-08-29T10:17:26+0000",
            "content": "> 2. I bumped up the time / sleep time b/w issuing CDCR and checking target collection for numDocs to 7 seconds, \n\nI don't get the logic for this. Doesn't {[waitForTargetToSync}} already wait for 120 seconds ? Adding another 7 seconds shouldn't help much no?\n\n> and lowered documents from 10K to 2K\n\nI'm guessing this will help but don't you think the bigger problem is why can't replicate 10k documents ( 2 fields ) in 120 seconds? Perhaps we can add some more logging to the test case like when the bootstrapping starts etc .\n\n\nBefore we wait for the target cluster to catch up , we print the queue size from the source cluster in the test case.\n\n\n[junit4]   1&gt; Cdcr queue response: {responseHeader={status=0,QTime=2},queues={127.0.0.1:64653/solr={cdcr-target={queueSize=2020,lastTimestamp=}}},tlogTotalSize=96279,tlogTotalCount=20,updateLogSynchronizer=stopped}\n\n\n\nSo this doesn't seem like a lot of documents to take 120 seconds to catch up? ",
            "author": "Varun Thacker",
            "id": "comment-16145066"
        },
        {
            "date": "2017-08-29T16:02:43+0000",
            "content": "bq: I'm guessing this will help but don't you think the bigger problem is why can't replicate 10k documents ( 2 fields ) in 120 seconds? Perhaps we can add some more logging to the test case like when the bootstrapping starts etc .\n\nThe evidence from a test I ran the other day (results in SOLR-11003) is that these delays won't help. Or if they do let the test pass they just mask a more fundamental problem. I changed one of the tests so if waitForTargetToSync didn't return the proper number of docs I'd add one more document to the source and call waitForTargetToSync again. Here's the important bits:\n\nAt the initial mismatch in waitForTargetToSync\ntarget: 1901\nsource: 2000\n\nAfter my new loop that adds a single doc to source then calls waitForTargetToSync again I see counts of\ntarget: 1902\nsource: 2001\n\nClearly my new doc is being indexed to the source and sent to the target so it's not just a matter of the docs getting to the target but somehow not being available to the currently-open searcher. They're just not on the target at all.\n\nI'll instrument the tests a little more. It's strange that the difference is 99 and the packet size is 100, kind of feels like an off-by-one error. ",
            "author": "Erick Erickson",
            "id": "comment-16145551"
        },
        {
            "date": "2017-08-29T16:04:29+0000",
            "content": "Varun Thacker Erick Erickson :: This is on Solr Version: 6.3\n\nYes you are right. This solution is not full-proofed.\n\nI am able to narrow down one problem, still no solution on the way:\n\n\n   [junit4]   2> 93761 ERROR (recoveryExecutor-5-thread-1-processing-n:127.0.0.1:55637_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:55637_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.ReplicationHandler Index fetch failed :org.apache.solr.common.SolrException: Index fetch failed : \n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:540)\n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:251)\n   [junit4]   2> \tat org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:397)\n   [junit4]   2> \tat org.apache.solr.handler.CdcrRequestHandler$BootstrapCallable.call(CdcrRequestHandler.java:758)\n   [junit4]   2> \tat org.apache.solr.handler.CdcrRequestHandler$BootstrapCallable.call(CdcrRequestHandler.java:713)\n   [junit4]   2> \tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n   [junit4]   2> \tat org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:229)\n   [junit4]   2> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n   [junit4]   2> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:745)\n   [junit4]   2> Caused by: java.lang.NullPointerException\n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.openNewSearcherAndUpdateCommitPoint(IndexFetcher.java:753)\n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:517)\n   [junit4]   2> \t... 9 more\n   [junit4]   2> \n\n\n\nThe problem is with target.shutdown. While doing target shutdown, it doesn't shutdown properly.\n\n\n   [junit4]   2> 67512 INFO  (coreCloseExecutor-49-thread-1) [n:127.0.0.1:55637_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.CdcrRequestHandler Solr core is being closed - shutting down CDCR handler @ cdcr-target:shard1\n   [junit4]   2> 67515 WARN  (updateExecutor-4-thread-1-processing-n:127.0.0.1:55637_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:55637_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.CdcrRequestHandler Bootstrap was interrupted\n   [junit4]   2> java.lang.InterruptedException\n   [junit4]   2> \tat java.util.concurrent.FutureTask.awaitDone(FutureTask.java:404)\n   [junit4]   2> \tat java.util.concurrent.FutureTask.get(FutureTask.java:191)\n   [junit4]   2> \tat org.apache.solr.handler.CdcrRequestHandler.lambda$handleBootstrapAction$0(CdcrRequestHandler.java:644)\n   [junit4]   2> \tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n   [junit4]   2> \tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n   [junit4]   2> \tat org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:229)\n   [junit4]   2> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n   [junit4]   2> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:745)\n\n\n\nand the core gets reloaded and throws NPE. I am diving into this properly, but it have a feeling this is a machine specific issue as we didn't see much of these in Jenkins failures as mentioned by Varun. ",
            "author": "Amrit Sarkar",
            "id": "comment-16145553"
        },
        {
            "date": "2017-08-29T16:10:52+0000",
            "content": "Now we're getting somewhere! I'm re-running some tests and will see if I get the same error in failing cases.\n\nThis starts to hang together with the close-to-packet-size difference in doc counts: my bet is there's a segment missing on the target. I'll think about how to test that. ",
            "author": "Erick Erickson",
            "id": "comment-16145564"
        },
        {
            "date": "2017-08-29T18:19:09+0000",
            "content": "yeah! I verified the bootstrap status comes out to be RUNNING instead of FINISHED even after all the operations are completed, assertions are true, and we are going to shut down both source and target next. \n\n\n.......\n.......\n        foundDocs = waitForTargetToSync(numDocs, targetSolrClient);\n        assertEquals(\"Document mismatch on target after sync\", numDocs, foundDocs);\n\n        System.out.println(\" bs status 1 :: \" + invokeCdcrAction(targetSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n\n        cdcrStop(targetSolrClient);\n        cdcrStop(sourceSolrClient);\n\n        System.out.println(\" bs status 2 :: \" + invokeCdcrAction(targetSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n\n      } finally {\n        source.shutdown();\n        System.out.println(\"source shutdown\");\n      }\n    } finally {\n      target.shutdown();\n      System.out.println(\"target shutdown\");\n    }\n  }\n\n\n\nsomething's off with bootstrap or bootstrap_status, they are not in sync. ",
            "author": "Amrit Sarkar",
            "id": "comment-16145829"
        },
        {
            "date": "2017-08-30T07:40:43+0000",
            "content": "Ok here's what's happening :\n\nBOOTSTRAP_STATUS is never calculated / comes to be FINISHED in target cluster for all the three tests in the testClass.\n\nI need to confirm what happens if bootstrap is not completed and solrcore is requested to be closed. ",
            "author": "Amrit Sarkar",
            "id": "comment-16146821"
        },
        {
            "date": "2017-08-30T12:30:54+0000",
            "content": "Still rambling:\n\n\n  /**\n   * This test start cdcr source, adds data,starts target cluster, verifies replication,\n   * stops cdcr replication and buffering, adds more data, re-enables cdcr and verify replication\n   */\n  public void testBootstrapWithSourceCluster() throws Exception {\n    // start the target first so that we know its zkhost\n    MiniSolrCloudCluster target = new MiniSolrCloudCluster(1, createTempDir(\"cdcr-target\"), buildJettyConfig(\"/solr\"));\n    try {\n      target.waitForAllNodes(30);\n      System.out.println(\"Target zkHost = \" + target.getZkServer().getZkAddress());\n      System.setProperty(\"cdcr.target.zkHost\", target.getZkServer().getZkAddress());\n\n      MiniSolrCloudCluster source = new MiniSolrCloudCluster(1, createTempDir(\"cdcr-source\"), buildJettyConfig(\"/solr\"));\n      try {\n        source.waitForAllNodes(30);\n        source.uploadConfigSet(configset(\"cdcr-source\"), \"cdcr-source\");\n\n        CollectionAdminRequest.createCollection(\"cdcr-source\", \"cdcr-source\", 1, 1)\n            .withProperty(\"solr.directoryFactory\", \"solr.StandardDirectoryFactory\")\n            .process(source.getSolrClient());\n\n        CloudSolrClient sourceSolrClient = source.getSolrClient();\n        sourceSolrClient.setDefaultCollection(\"cdcr-source\");\n        int docs = (TEST_NIGHTLY ? 100 : 10);\n        int numDocs = 0;\n        for (int k = 0; k < docs; k++) {\n          UpdateRequest req = new UpdateRequest();\n          for (; numDocs < (k + 1) * 100; numDocs++) {\n            SolrInputDocument doc = new SolrInputDocument();\n            doc.addField(\"id\", \"source_\" + numDocs);\n            doc.addField(\"xyz\", numDocs);\n            req.add(doc);\n          }\n          req.setAction(AbstractUpdateRequest.ACTION.COMMIT, true, true);\n          System.out.println(\"Adding \" + docs + \" docs with commit=true, numDocs=\" + numDocs);\n          req.process(sourceSolrClient);\n        }\n\n        QueryResponse response = sourceSolrClient.query(new SolrQuery(\"*:*\"));\n        assertEquals(\"\", numDocs, response.getResults().getNumFound());\n\n        // setup the target cluster\n        target.uploadConfigSet(configset(\"cdcr-target\"), \"cdcr-target\");\n        CollectionAdminRequest.createCollection(\"cdcr-target\", \"cdcr-target\", 1, 1)\n            .process(target.getSolrClient());\n        CloudSolrClient targetSolrClient = target.getSolrClient();\n        targetSolrClient.setDefaultCollection(\"cdcr-target\");\n\n        cdcrStart(targetSolrClient);\n        cdcrStart(sourceSolrClient);\n\n        System.out.println(\"bs status TX :: \" + invokeCdcrAction(targetSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n        System.out.println(\"bs status SX :: \" + invokeCdcrAction(sourceSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n\n        response = getCdcrQueue(sourceSolrClient);\n        System.out.println(\"Cdcr queue response: \" + response.getResponse());\n        long foundDocs = waitForTargetToSync(numDocs, targetSolrClient);\n\n        System.out.println(\"bs status TY :: \" + invokeCdcrAction(targetSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n        System.out.println(\"bs status SY :: \" + invokeCdcrAction(sourceSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n\n        assertEquals(\"Document mismatch on target after sync\", numDocs, foundDocs);\n\n        System.out.println(\"bs status TZ :: \" + invokeCdcrAction(targetSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n        System.out.println(\"bs status SZ :: \" + invokeCdcrAction(sourceSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n\n        cdcrStop(sourceSolrClient);\n        cdcrDisableBuffer(sourceSolrClient);\n\n        System.out.println(\"bs status TA :: \" + invokeCdcrAction(targetSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n        System.out.println(\"bs status SA :: \" + invokeCdcrAction(sourceSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n\n        int c = 0;\n        for (int k = 0; k < 10; k++) {\n          UpdateRequest req = new UpdateRequest();\n          for (; c < (k + 1) * 100; c++, numDocs++) {\n            SolrInputDocument doc = new SolrInputDocument();\n            doc.addField(\"id\", \"source_\" + numDocs);\n            doc.addField(\"xyz\", numDocs);\n            req.add(doc);\n          }\n          req.setAction(AbstractUpdateRequest.ACTION.COMMIT, true, true);\n          System.out.println(\"Adding 100 docs with commit=true, numDocs=\" + numDocs);\n          req.process(sourceSolrClient);\n        }\n\n        response = sourceSolrClient.query(new SolrQuery(\"*:*\"));\n        assertEquals(\"\", numDocs, response.getResults().getNumFound());\n\n        cdcrStart(sourceSolrClient);\n        cdcrEnableBuffer(sourceSolrClient);\n\n        System.out.println(\"bs status T1 :: \" + invokeCdcrAction(targetSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n        System.out.println(\"bs status S1 :: \" + invokeCdcrAction(sourceSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n\n        foundDocs = waitForTargetToSync(numDocs, targetSolrClient);\n\n        System.out.println(\"bs status T2 :: \" + invokeCdcrAction(targetSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n        System.out.println(\"bs status S2 :: \" + invokeCdcrAction(sourceSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n\n        assertEquals(\"Document mismatch on target after sync\", numDocs, foundDocs);\n\n        System.out.println(\"bs status T3 :: \" + invokeCdcrAction(targetSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n        System.out.println(\"bs status S3 :: \" + invokeCdcrAction(sourceSolrClient, CdcrParams.CdcrAction.BOOTSTRAP_STATUS));\n      } finally {\n        source.shutdown();\n      }\n    } finally {\n      target.shutdown();\n    }\n  }\n\n\n\nresponses for BS ::\n\nT - target, S - source\n\n   [junit4]   1> bs status TX :: {responseHeader={status=0,QTime=0},STATUS=notfound,msg=No bootstrap found in running, completed or failed states}\n   [junit4]   1> bs status SX :: {responseHeader={status=0,QTime=0},STATUS=notfound,msg=No bootstrap found in running, completed or failed states}\n   [junit4]   1> bs status TY :: {responseHeader={status=0,QTime=0},STATUS=running}\n   [junit4]   1> bs status SY :: {responseHeader={status=0,QTime=0},STATUS=notfound,msg=No bootstrap found in running, completed or failed states}\n   [junit4]   1> bs status TZ :: {responseHeader={status=0,QTime=0},STATUS=running}\n   [junit4]   1> bs status SZ :: {responseHeader={status=0,QTime=0},STATUS=notfound,msg=No bootstrap found in running, completed or failed states}\n   [junit4]   1> bs status TA :: {responseHeader={status=0,QTime=0},STATUS=running}\n   [junit4]   1> bs status SA :: {responseHeader={status=0,QTime=0},STATUS=notfound,msg=No bootstrap found in running, completed or failed states}\n   [junit4]   1> bs status T1 :: {responseHeader={status=0,QTime=0},STATUS=running}\n   [junit4]   1> bs status S1 :: {responseHeader={status=0,QTime=0},STATUS=notfound,msg=No bootstrap found in running, completed or failed states}\n   [junit4]   1> bs status T2 :: {responseHeader={status=0,QTime=0},STATUS=cancelled}\n   [junit4]   1> bs status S2 :: {responseHeader={status=0,QTime=0},STATUS=notfound,msg=No bootstrap found in running, completed or failed states}\n\n\n\nbs status T3 was never written as assertion was failed. But why is bootstrap cancelled after waiting for the target for 120 sec? \n\n\n[junit4]   1> bs status T2 :: {responseHeader={status=0,QTime=0},STATUS=cancelled}\n   [junit4]   2> 167151 INFO  (qtp666966491-24) [n:127.0.0.1:62331_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.S.Request [cdcr-target_shard1_replica1]  webapp=/solr path=/cdcr params={qt=/cdcr&action=BOOTSTRAP_STATUS&wt=javabin&version=2} status=0 QTime=0\n   [junit4]   2> 167153 INFO  (qtp666966491-24) [n:127.0.0.1:62331_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.S.Request [cdcr-target_shard1_replica1]  webapp=/solr path=/cdcr params={qt=/cdcr&action=BOOTSTRAP_STATUS&wt=javabin&version=2} status=0 QTime=0\n   [junit4]   2> 167153 INFO  (qtp1588339772-65) [n:127.0.0.1:62339_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/cdcr params={qt=/cdcr&_stateVer_=cdcr-source:4&action=bootstrap_status&wt=javabin&version=2} status=0 QTime=0\n   [junit4]   1> bs status S2 :: {responseHeader={status=0,QTime=0},STATUS=notfound,msg=No bootstrap found in running, completed or failed states}\n   [junit4]   2> 167155 INFO  (qtp666966491-23) [n:127.0.0.1:62331_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.S.Request [cdcr-target_shard1_replica1]  webapp=/solr path=/cdcr params={qt=/cdcr&action=BOOTSTRAP_STATUS&wt=javabin&version=2} status=0 QTime=0\n   [junit4]   2> 167161 INFO  (qtp666966491-30) [n:127.0.0.1:62331_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.S.Request [cdcr-target_shard1_replica1]  webapp=/solr path=/cdcr params={qt=/cdcr&action=BOOTSTRAP_STATUS&wt=javabin&version=2} status=0 QTime=0\n   [junit4]   2> 167163 INFO  (qtp666966491-29) [n:127.0.0.1:62331_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.S.Request [cdcr-target_shard1_replica1]  webapp=/solr path=/cdcr params={qt=/cdcr&action=BOOTSTRAP_STATUS&wt=javabin&version=2} status=0 QTime=0\n   [junit4]   2> 167166 INFO  (qtp666966491-29) [n:127.0.0.1:62331_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.S.Request [cdcr-target_shard1_replica1]  webapp=/solr path=/cdcr params={qt=/cdcr&action=BOOTSTRAP_STATUS&wt=javabin&version=2} status=0 QTime=0\n   [junit4]   2> 167168 INFO  (jetty-closer-14-thread-1) [    ] o.e.j.s.AbstractConnector Stopped ServerConnector@4b790cef{HTTP/1.1,[http/1.1]}{127.0.0.1:0}\n   [junit4]   2> 167168 INFO  (qtp666966491-29) [n:127.0.0.1:62331_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.S.Request [cdcr-target_shard1_replica1]  webapp=/solr path=/cdcr params={qt=/cdcr&action=BOOTSTRAP_STATUS&wt=javabin&version=2} status=0 QTime=0\n   [junit4]   2> 167169 INFO  (jetty-closer-14-thread-1) [    ] o.a.s.c.CoreContainer Shutting down CoreContainer instance=820972786\n   [junit4]   2> 167169 INFO  (jetty-closer-14-thread-1) [    ] o.a.s.m.SolrMetricManager Closing metric reporters for: solr.node\n   [junit4]   2> 167170 INFO  (jetty-closer-14-thread-1) [    ] o.a.s.m.SolrMetricManager Closing metric reporters for: solr.jvm\n   [junit4]   2> 167170 INFO  (jetty-closer-14-thread-1) [    ] o.a.s.m.SolrMetricManager Closing metric reporters for: solr.jetty\n[junit4]   2> 167173 INFO  (qtp666966491-29) [n:127.0.0.1:62331_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.S.Request [cdcr-target_shard1_replica1]  webapp=/solr path=/cdcr params={qt=/cdcr&action=BOOTSTRAP_STATUS&wt=javabin&version=2} status=0 QTime=0\n   [junit4]   2> 167175 INFO  (qtp666966491-23) [n:127.0.0.1:62331_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.S.Request [cdcr-target_shard1_replica1]  webapp=/solr path=/cdcr params={qt=/cdcr&action=BOOTSTRAP_STATUS&wt=javabin&version=2} status=0 QTime=0\n   [junit4]   2> 167176 INFO  (coreCloseExecutor-44-thread-1) [n:127.0.0.1:62339_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.SolrCore [cdcr-source_shard1_replica1]  CLOSING SolrCore org.apache.solr.core.SolrCore@500834bb\n   [junit4]   2> 167176 INFO  (coreCloseExecutor-44-thread-1) [n:127.0.0.1:62339_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.h.CdcrRequestHandler Solr core is being closed - shutting down CDCR handler @ cdcr-source:shard1\n\n\n\nSource solr cluster shut down before bootstrap gets completed and issues CANCEL_BOOSTRAP. The assertions fail way before that. The question being why 1000 docs are not getting bootstrapped?\n\nIf you look above, the CDCR Bootstrap status from the beginning is \"running\" and even if the first batch is successfully fetched to target and we shut down CDCR on source. , the status is still being \"running\". \n\nI am running more tests, will update shortly. This is the crux of the problem, no solution on the way still. ",
            "author": "Amrit Sarkar",
            "id": "comment-16147149"
        },
        {
            "date": "2017-08-30T12:51:04+0000",
            "content": "When I commented out the second set of documents getting indexed in source, I didn't receive assertion failure, instead NPE returned back ::\n\n\n   [junit4]   2> 71670 ERROR (recoveryExecutor-6-thread-1-processing-n:127.0.0.1:62762_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:62762_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.ReplicationHandler Index fetch failed :org.apache.solr.common.SolrException: Index fetch failed : \n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:598)\n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:301)\n   [junit4]   2> \tat org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:400)\n   [junit4]   2> \tat org.apache.solr.handler.CdcrRequestHandler$BootstrapCallable.call(CdcrRequestHandler.java:759)\n   [junit4]   2> \tat org.apache.solr.handler.CdcrRequestHandler$BootstrapCallable.call(CdcrRequestHandler.java:714)\n   [junit4]   2> \tat com.codahale.metrics.InstrumentedExecutorService$InstrumentedCallable.call(InstrumentedExecutorService.java:197)\n   [junit4]   2> \tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n   [junit4]   2> \tat org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:229)\n   [junit4]   2> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n   [junit4]   2> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:745)\n   [junit4]   2> Caused by: java.lang.NullPointerException\n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.openNewSearcherAndUpdateCommitPoint(IndexFetcher.java:823)\n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:575)\n   [junit4]   2> \t... 10 more\n\n ",
            "author": "Amrit Sarkar",
            "id": "comment-16147168"
        },
        {
            "date": "2017-08-30T14:30:28+0000",
            "content": "This attached SOLR-11278-cancel-bootstrap-on-stop.patch fixes the strange status messages seen in the logs by Amrit. What happens is that on stopping cdcr, we stop only the bootstrap status runnable (started on the source cluster) but we do not abort the bootstrap running on the target cluster. This causes the status to return RUNNING on the target even after cdcr is stopped. This patch cancels the running bootstrap on the target cluster. ",
            "author": "Shalin Shekhar Mangar",
            "id": "comment-16147309"
        },
        {
            "date": "2017-08-30T17:29:41+0000",
            "content": "Commit b4c6bfafdb32127316b334ffdd195270e1077fbe in lucene-solr's branch refs/heads/master from Shalin Shekhar Mangar\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b4c6bfa ]\n\nSOLR-11278: Stopping CDCR should cancel a running bootstrap operation ",
            "author": "ASF subversion and git services",
            "id": "comment-16147647"
        },
        {
            "date": "2017-08-30T17:35:43+0000",
            "content": "Commit 56ddf473bcf80d9a8f7c3c17d6869cdd3c674223 in lucene-solr's branch refs/heads/branch_7x from Shalin Shekhar Mangar\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=56ddf47 ]\n\nSOLR-11278: Stopping CDCR should cancel a running bootstrap operation\n\n(cherry picked from commit b4c6bfa) ",
            "author": "ASF subversion and git services",
            "id": "comment-16147654"
        },
        {
            "date": "2017-08-31T04:56:21+0000",
            "content": "There are still failures in CdcrBootstrapTest.testBootstrapWithContinousIndexingOnSourceCluster after this fix. I don't have the time right now to dig but if someone is willing to do the investigation, I can help with reviews and fixes. ",
            "author": "Shalin Shekhar Mangar",
            "id": "comment-16148445"
        },
        {
            "date": "2017-08-31T05:31:05+0000",
            "content": "Shalin, I am onto this. CdcrBootstrapTest.testBootstrapWithContinousIndexingOnSourceCluster is failing intermittently when Bootstrap gets failed due to unannounced SolrCore shutdown. This SolrCore shutdown may not be the root issue, but fetchIndex from source. Please see below:\n\n\n  [beaster]   1> Adding 10 docs with commit=true, numDocs=1100\n  [beaster]   2> 62998 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.DirectUpdateHandler2 start commit{,optimize=false,openSearcher=false,waitSearcher=true,expungeDeletes=false,softCommit=false,prepareCommit=false}\n  [beaster]   2> 62998 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.SolrIndexWriter Calling setCommitData with IW:org.apache.solr.update.SolrIndexWriter@10111fe6\n  [beaster]   2> 63003 INFO  (qtp358530981-502) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/update params={_stateVer_=cdcr-source:3&wt=javabin&version=2} status=0 QTime=10\n  [beaster]   2> 63010 INFO  (qtp1081974557-457) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.S.Request [cdcr-target_shard1_replica1]  webapp=/solr path=/cdcr params={qt=/cdcr&masterUrl=http://127.0.0.1:36872/solr/cdcr-source_shard1_replica1/&action=BOOTSTRAP&wt=javabin&version=2} status=0 QTime=32\n  [beaster]   2> 63012 INFO  (qtp1081974557-459) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.S.Request [cdcr-target_shard1_replica1]  webapp=/solr path=/cdcr params={qt=/cdcr&action=BOOTSTRAP_STATUS&wt=javabin&version=2} status=0 QTime=0\n  [beaster]   2> 63013 INFO  (cdcr-bootstrap-status-136-thread-1-processing-n:127.0.0.1:36872_solr x:cdcr-source_shard1_replica1 s:shard1 c:cdcr-source r:core_node1) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.h.CdcrReplicatorManager CDCR bootstrap running for 1 seconds, sleeping for 2000 ms\n  [beaster]   2> 63171 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.s.SolrIndexSearcher Opening [Searcher@7cd86816[cdcr-source_shard1_replica1] realtime]\n  [beaster]   2> 63171 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.DirectUpdateHandler2 end_commit_flush\n  [beaster]   2> 63171 INFO  (qtp358530981-504) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.DirectUpdateHandler2 start commit{,optimize=false,openSearcher=true,waitSearcher=true,expungeDeletes=false,softCommit=false,prepareCommit=false}\n  [beaster]   2> 63171 INFO  (qtp358530981-504) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.SolrIndexWriter Calling setCommitData with IW:org.apache.solr.update.SolrIndexWriter@10111fe6\n  [beaster]   2> 63172 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/update params={waitSearcher=true&openSearcher=false&commit=true&softCommit=false&commit_end_point=true&wt=javabin&version=2} status=0 QTime=174\n  [beaster]   2> 63175 INFO  (qtp358530981-497) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={qt=/replication&wt=javabin&version=2&command=indexversion} status=0 QTime=0\n  [beaster]   2> 63176 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.IndexFetcher Master's generation: 12\n  [beaster]   2> 63176 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.IndexFetcher Master's version: 1504153213504\n  [beaster]   2> 63176 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.IndexFetcher Slave's generation: 1\n  [beaster]   2> 63176 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.IndexFetcher Slave's version: 0\n  [beaster]   2> 63176 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.IndexFetcher Starting replication process\n  [beaster]   2> 63205 INFO  (qtp358530981-497) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.h.ReplicationHandler Adding tlog files to list: [{size=4649, name=tlog.0000000000000000000.1577218955048648704}, {size=4770, name=tlog.0000000000000000001.1577218955134631936}, {size=4770, name=tlog.0000000000000000002.1577218955245780992}, {size=4770, name=tlog.0000000000000000003.1577218955347492864}, {size=4770, name=tlog.0000000000000000004.1577218955448156160}, {size=4770, name=tlog.0000000000000000005.1577218955573985280}, {size=4770, name=tlog.0000000000000000006.1577218955690377216}, {size=4770, name=tlog.0000000000000000007.1577218955795234816}, {size=4770, name=tlog.0000000000000000008.1577218955899043840}, {size=4770, name=tlog.0000000000000000009.1577218956028018688}]\n  [beaster]   2> 63206 INFO  (qtp358530981-497) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&wt=javabin&version=2&command=filelist} status=0 QTime=28\n  [beaster]   2> 63217 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.IndexFetcher Number of files in latest index in master: 39\n  [beaster]   2> 63217 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.IndexFetcher Number of tlog files in master: 10\n  [beaster]   2> 63228 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.u.DefaultSolrCoreState New IndexWriter is ready to be used.\n  [beaster]   2> 63229 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.IndexFetcher Starting download (fullCopy=false) to MockDirectoryWrapper(RAMDirectory@799f4d8d lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@633c5d00)\n  [beaster]   2> 63240 INFO  (qtp358530981-497) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a_LuceneVarGapDocFreqInterval_0.tiv&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63246 INFO  (qtp358530981-502) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a_Lucene50_0.pos&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63247 INFO  (qtp358530981-504) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.s.SolrIndexSearcher Opening [Searcher@3fed3b93[cdcr-source_shard1_replica1] main]\n  [beaster]   2> 63248 INFO  (qtp358530981-504) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.DirectUpdateHandler2 end_commit_flush\n  [beaster]   2> 63248 INFO  (searcherExecutor-170-thread-1-processing-n:127.0.0.1:36872_solr x:cdcr-source_shard1_replica1 s:shard1 c:cdcr-source r:core_node1) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.SolrCore [cdcr-source_shard1_replica1] Registered new searcher Searcher@3fed3b93[cdcr-source_shard1_replica1] main{ExitableDirectoryReader(UninvertingDirectoryReader(Uninverting(_a(6.6.1):C1000) Uninverting(_b(6.6.1):C1) Uninverting(_c(6.6.1):C99)))}\n  [beaster]   2> 63249 INFO  (qtp358530981-500) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a.fdt&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63254 INFO  (qtp358530981-500) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a_Lucene50_0.doc&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63257 INFO  (qtp358530981-501) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a_Lucene50_0.tim&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63260 INFO  (qtp358530981-497) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a.si&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63265 INFO  (qtp358530981-502) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a.fdx&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63269 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a_LuceneVarGapDocFreqInterval_0.doc&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63273 INFO  (qtp358530981-500) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a_Lucene50_0.tip&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63276 INFO  (qtp358530981-501) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a_TestBloomFilteredLucenePostings_0.blm&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63279 INFO  (qtp358530981-497) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a.nvm&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63282 INFO  (qtp358530981-502) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a.fnm&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63286 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a_TestBloomFilteredLucenePostings_0.doc&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63289 INFO  (qtp358530981-500) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a_TestBloomFilteredLucenePostings_0.tim&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63293 INFO  (qtp358530981-501) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a_LuceneVarGapDocFreqInterval_0.pos&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63296 INFO  (qtp358530981-497) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a_TestBloomFilteredLucenePostings_0.tip&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63299 INFO  (qtp358530981-502) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a.nvd&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63302 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a_LuceneVarGapDocFreqInterval_0.tib&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63306 INFO  (qtp358530981-500) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a_TestBloomFilteredLucenePostings_0.pos&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63309 INFO  (qtp358530981-501) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b_LuceneVarGapDocFreqInterval_0.doc&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63312 INFO  (qtp358530981-497) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b.nvd&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63316 INFO  (qtp358530981-502) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b_TestBloomFilteredLucenePostings_0.blm&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63320 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b.si&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63324 INFO  (qtp358530981-500) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b.nvm&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63327 INFO  (qtp358530981-501) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b.fnm&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63330 INFO  (qtp358530981-497) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b_LuceneVarGapDocFreqInterval_0.tiv&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63334 INFO  (qtp358530981-502) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b_TestBloomFilteredLucenePostings_0.tip&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63337 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b_Lucene50_0.pos&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63340 INFO  (qtp358530981-500) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b_Lucene50_0.tip&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63343 INFO  (qtp358530981-501) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b_TestBloomFilteredLucenePostings_0.doc&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63347 INFO  (qtp358530981-497) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b_TestBloomFilteredLucenePostings_0.tim&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63348 INFO  (qtp358530981-504) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/update params={_stateVer_=cdcr-source:3&waitSearcher=true&commit=true&softCommit=false&wt=javabin&version=2} status=0 QTime=343\n  [beaster]   1> Adding 10 docs with commit=true, numDocs=1200\n  [beaster]   2> 63350 INFO  (qtp358530981-502) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b_Lucene50_0.doc&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63354 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b_Lucene50_0.tim&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63356 INFO  (qtp358530981-498) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/update params={_stateVer_=cdcr-source:3&wt=javabin&version=2} status=0 QTime=5\n  [beaster]   2> 63357 INFO  (qtp358530981-501) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b.fdx&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63358 INFO  (qtp358530981-500) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.DirectUpdateHandler2 start commit{,optimize=false,openSearcher=true,waitSearcher=true,expungeDeletes=false,softCommit=false,prepareCommit=false}\n  [beaster]   2> 63358 INFO  (qtp358530981-500) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.SolrIndexWriter Calling setCommitData with IW:org.apache.solr.update.SolrIndexWriter@10111fe6\n  [beaster]   2> 63361 INFO  (qtp358530981-497) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b_TestBloomFilteredLucenePostings_0.pos&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63410 INFO  (qtp358530981-504) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b_LuceneVarGapDocFreqInterval_0.tib&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63416 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b.fdt&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63420 INFO  (qtp358530981-498) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_b_LuceneVarGapDocFreqInterval_0.pos&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63424 INFO  (qtp358530981-502) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=segments_c&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63425 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.IndexFetcher Starting download of tlog files from master: [{size=4649, name=tlog.0000000000000000000.1577218955048648704}, {size=4770, name=tlog.0000000000000000001.1577218955134631936}, {size=4770, name=tlog.0000000000000000002.1577218955245780992}, {size=4770, name=tlog.0000000000000000003.1577218955347492864}, {size=4770, name=tlog.0000000000000000004.1577218955448156160}, {size=4770, name=tlog.0000000000000000005.1577218955573985280}, {size=4770, name=tlog.0000000000000000006.1577218955690377216}, {size=4770, name=tlog.0000000000000000007.1577218955795234816}, {size=4770, name=tlog.0000000000000000008.1577218955899043840}, {size=4770, name=tlog.0000000000000000009.1577218956028018688}]\n  [beaster]   2> 63428 INFO  (qtp358530981-497) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&checksum=true&tlogFile=tlog.0000000000000000000.1577218955048648704&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63433 INFO  (qtp358530981-497) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&checksum=true&tlogFile=tlog.0000000000000000001.1577218955134631936&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63437 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&checksum=true&tlogFile=tlog.0000000000000000002.1577218955245780992&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63442 INFO  (qtp358530981-498) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&checksum=true&tlogFile=tlog.0000000000000000003.1577218955347492864&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63447 INFO  (qtp358530981-498) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&checksum=true&tlogFile=tlog.0000000000000000004.1577218955448156160&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63451 INFO  (qtp358530981-498) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&checksum=true&tlogFile=tlog.0000000000000000005.1577218955573985280&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63468 INFO  (qtp358530981-498) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&checksum=true&tlogFile=tlog.0000000000000000006.1577218955690377216&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63472 INFO  (qtp358530981-498) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&checksum=true&tlogFile=tlog.0000000000000000007.1577218955795234816&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63479 INFO  (qtp358530981-498) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&checksum=true&tlogFile=tlog.0000000000000000008.1577218955899043840&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63483 INFO  (qtp358530981-498) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/replication params={generation=12&qt=/replication&checksum=true&tlogFile=tlog.0000000000000000009.1577218956028018688&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 63484 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.IndexFetcher Total time taken for download (fullCopy=false,bytesDownloaded=101357) : 0 secs (null bytes/sec) to MockDirectoryWrapper(RAMDirectory@799f4d8d lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@633c5d00)\n  [beaster]   2> 63506 INFO  (qtp358530981-500) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.s.SolrIndexSearcher Opening [Searcher@4db46823[cdcr-source_shard1_replica1] main]\n  [beaster]   2> 63506 INFO  (qtp358530981-500) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.DirectUpdateHandler2 end_commit_flush\n  [beaster]   2> 63508 INFO  (searcherExecutor-170-thread-1-processing-n:127.0.0.1:36872_solr x:cdcr-source_shard1_replica1 s:shard1 c:cdcr-source r:core_node1) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.SolrCore [cdcr-source_shard1_replica1] Registered new searcher Searcher@4db46823[cdcr-source_shard1_replica1] main{ExitableDirectoryReader(UninvertingDirectoryReader(Uninverting(_a(6.6.1):C1000) Uninverting(_b(6.6.1):C1) Uninverting(_c(6.6.1):C99) Uninverting(_d(6.6.1):C100)))}\n  [beaster]   2> 63508 INFO  (qtp358530981-500) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/update params={_stateVer_=cdcr-source:3&waitSearcher=true&commit=true&softCommit=false&wt=javabin&version=2} status=0 QTime=150\n  [beaster]   1> Adding 10 docs with commit=true, numDocs=1300\n  [beaster]   2> 63510 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.u.DefaultSolrCoreState New IndexWriter is ready to be used.\n  [beaster]   2> 63510 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.IndexFetcher Reloading SolrCore cdcr-target_shard1_replica1\n  [beaster]   2> 63517 INFO  (qtp358530981-501) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/update params={_stateVer_=cdcr-source:3&wt=javabin&version=2} status=0 QTime=5\n  [beaster]   2> 63520 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.DirectUpdateHandler2 start commit{,optimize=false,openSearcher=true,waitSearcher=true,expungeDeletes=false,softCommit=false,prepareCommit=false}\n  [beaster]   2> 63520 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.SolrIndexWriter Calling setCommitData with IW:org.apache.solr.update.SolrIndexWriter@10111fe6\n  [beaster]   2> 63577 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.SolrConfig Using Lucene MatchVersion: 6.6.1\n  [beaster]   2> 63614 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.s.IndexSchema [cdcr-target_shard1_replica1] Schema name=minimal\n  [beaster]   2> 63621 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.s.IndexSchema Loaded schema minimal/1.1 with uniqueid field id\n  [beaster]   2> 63621 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.CoreContainer Reloading SolrCore 'cdcr-target_shard1_replica1' using configuration from collection cdcr-target\n  [beaster]   2> 63621 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.s.SolrIndexSearcher Opening [Searcher@5e7f193f[cdcr-source_shard1_replica1] main]\n  [beaster]   2> 63622 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.DirectUpdateHandler2 end_commit_flush\n  [beaster]   2> 63624 INFO  (searcherExecutor-170-thread-1-processing-n:127.0.0.1:36872_solr x:cdcr-source_shard1_replica1 s:shard1 c:cdcr-source r:core_node1) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.SolrCore [cdcr-source_shard1_replica1] Registered new searcher Searcher@5e7f193f[cdcr-source_shard1_replica1] main{ExitableDirectoryReader(UninvertingDirectoryReader(Uninverting(_a(6.6.1):C1000) Uninverting(_b(6.6.1):C1) Uninverting(_c(6.6.1):C99) Uninverting(_d(6.6.1):C100) Uninverting(_e(6.6.1):C100)))}\n  [beaster]   2> 63625 INFO  (qtp358530981-503) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/update params={_stateVer_=cdcr-source:3&waitSearcher=true&commit=true&softCommit=false&wt=javabin&version=2} status=0 QTime=104\n  [beaster]   1> Adding 10 docs with commit=true, numDocs=1400\n  [beaster]   2> 63629 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.SolrCore [[cdcr-target_shard1_replica1] ] Opening new SolrCore at [/home/jenkins/lucene-solr/solr/build/solr-core/test/J0/temp/solr.cloud.CdcrBootstrapTest_20C3001E01E3B41B-001/cdcr-target-004/node1/cdcr-target_shard1_replica1], dataDir=[/home/jenkins/lucene-solr/solr/build/solr-core/test/J0/temp/solr.cloud.CdcrBootstrapTest_20C3001E01E3B41B-001/cdcr-target-004/node1/./cdcr-target_shard1_replica1/data/]\n  [beaster]   2> 63634 INFO  (qtp358530981-502) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/update params={_stateVer_=cdcr-source:3&wt=javabin&version=2} status=0 QTime=6\n  [beaster]   2> 63636 INFO  (qtp358530981-504) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.DirectUpdateHandler2 start commit{,optimize=false,openSearcher=true,waitSearcher=true,expungeDeletes=false,softCommit=false,prepareCommit=false}\n  [beaster]   2> 63636 INFO  (qtp358530981-504) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.SolrIndexWriter Calling setCommitData with IW:org.apache.solr.update.SolrIndexWriter@10111fe6\n  [beaster]   2> 63806 INFO  (qtp358530981-504) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.s.SolrIndexSearcher Opening [Searcher@48e60ebb[cdcr-source_shard1_replica1] main]\n  [beaster]   2> 63806 INFO  (searcherExecutor-170-thread-1-processing-n:127.0.0.1:36872_solr x:cdcr-source_shard1_replica1 s:shard1 c:cdcr-source r:core_node1) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.SolrCore [cdcr-source_shard1_replica1] Registered new searcher Searcher@48e60ebb[cdcr-source_shard1_replica1] main{ExitableDirectoryReader(UninvertingDirectoryReader(Uninverting(_a(6.6.1):C1000) Uninverting(_b(6.6.1):C1) Uninverting(_c(6.6.1):C99) Uninverting(_d(6.6.1):C100) Uninverting(_e(6.6.1):C100) Uninverting(_f(6.6.1):C100)))}\n  [beaster]   2> 63807 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.u.CommitTracker Hard AutoCommit: disabled\n  [beaster]   2> 63807 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.u.CommitTracker Soft AutoCommit: disabled\n  [beaster]   2> 63807 INFO  (qtp358530981-504) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.DirectUpdateHandler2 end_commit_flush\n  [beaster]   2> 63808 INFO  (qtp358530981-504) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/update params={_stateVer_=cdcr-source:3&waitSearcher=true&commit=true&softCommit=false&wt=javabin&version=2} status=0 QTime=171\n  [beaster]   1> Adding 10 docs with commit=true, numDocs=1500\n  [beaster]   2> 63810 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.s.SolrIndexSearcher Opening [Searcher@28386b90[cdcr-target_shard1_replica1] main]\n  [beaster]   2> 63813 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.r.ManagedResourceStorage Configured ZooKeeperStorageIO with znodeBase: /configs/cdcr-target\n  [beaster]   2> 63814 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.r.ManagedResourceStorage Loaded null at path _rest_managed.json using ZooKeeperStorageIO:path=/configs/cdcr-target\n  [beaster]   2> 63814 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.s.ZkIndexSchemaReader Creating ZooKeeper watch for the managed schema at /configs/cdcr-target/managed-schema\n  [beaster]   2> 63815 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.s.ZkIndexSchemaReader Current schema version 0 is already the latest\n  [beaster]   2> 63815 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.ReplicationHandler Commits will be reserved for  10000\n  [beaster]   2> 63827 INFO  (qtp358530981-504) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.c.S.Request [cdcr-source_shard1_replica1]  webapp=/solr path=/update params={_stateVer_=cdcr-source:3&wt=javabin&version=2} status=0 QTime=15\n  [beaster]   2> 63832 INFO  (qtp358530981-497) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.DirectUpdateHandler2 start commit{,optimize=false,openSearcher=true,waitSearcher=true,expungeDeletes=false,softCommit=false,prepareCommit=false}\n  [beaster]   2> 63832 INFO  (qtp358530981-497) [n:127.0.0.1:36872_solr c:cdcr-source s:shard1 r:core_node1 x:cdcr-source_shard1_replica1] o.a.s.u.SolrIndexWriter Calling setCommitData with IW:org.apache.solr.update.SolrIndexWriter@10111fe6\n  [beaster]   2> 63853 INFO  (searcherExecutor-188-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.SolrCore [cdcr-target_shard1_replica1] Registered new searcher Searcher@28386b90[cdcr-target_shard1_replica1] main{ExitableDirectoryReader(UninvertingDirectoryReader(Uninverting(_a(6.6.1):C1000) Uninverting(_b(6.6.1):C1)))}\n  [beaster]   2> 63860 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.u.DefaultSolrCoreState New IndexWriter is ready to be used.\n  [beaster]   2> 63865 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.s.SolrIndexSearcher Opening [Searcher@4c22895c[cdcr-target_shard1_replica1] main]\n  [beaster]   2> 63866 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.SolrCore [cdcr-target_shard1_replica1]  CLOSING SolrCore org.apache.solr.core.SolrCore@ebbd9dc\n  [beaster]   2> 63866 INFO  (searcherExecutor-188-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.SolrCore [cdcr-target_shard1_replica1] Registered new searcher Searcher@4c22895c[cdcr-target_shard1_replica1] main{ExitableDirectoryReader(UninvertingDirectoryReader(Uninverting(_a(6.6.1):C1000) Uninverting(_b(6.6.1):C1)))}\n  [beaster]   2> 63866 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.CdcrRequestHandler Solr core is being closed - shutting down CDCR handler @ cdcr-target:shard1\n  [beaster]   2> 63868 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.m.SolrMetricManager Closing metric reporters for: solr.core.cdcr-target.shard1.replica1\n  [beaster]   2> 63869 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.CdcrRequestHandler No replay needed.\n  [beaster]   2> 63869 ERROR (updateExecutor-109-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.CdcrRequestHandler Bootstrap operation failed\n  [beaster]   2> java.util.concurrent.ExecutionException: java.lang.AssertionError\n  [beaster]   2> \tat java.util.concurrent.FutureTask.report(FutureTask.java:122)\n  [beaster]   2> \tat java.util.concurrent.FutureTask.get(FutureTask.java:192)\n  [beaster]   2> \tat org.apache.solr.handler.CdcrRequestHandler.lambda$handleBootstrapAction$0(CdcrRequestHandler.java:644)\n  [beaster]   2> \tat com.codahale.metrics.InstrumentedExecutorService$InstrumentedRunnable.run(InstrumentedExecutorService.java:176)\n  [beaster]   2> \tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n  [beaster]   2> \tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n  [beaster]   2> \tat org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:229)\n  [beaster]   2> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n  [beaster]   2> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n  [beaster]   2> \tat java.lang.Thread.run(Thread.java:748)\n  [beaster]   2> Caused by: java.lang.AssertionError\n  [beaster]   2> \tat org.apache.solr.handler.CdcrRequestHandler$BootstrapCallable.call(CdcrRequestHandler.java:787)\n  [beaster]   2> \tat org.apache.solr.handler.CdcrRequestHandler$BootstrapCallable.call(CdcrRequestHandler.java:714)\n  [beaster]   2> \tat com.codahale.metrics.InstrumentedExecutorService$InstrumentedCallable.call(InstrumentedExecutorService.java:197)\n  [beaster]   2> \t... 5 more\n\n\n\nReplication takes place successfully once:\n\n\n [beaster]   2> 63860 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.u.DefaultSolrCoreState New IndexWriter is ready to be used.\n  [beaster]   2> 63865 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.s.SolrIndexSearcher Opening [Searcher@4c22895c[cdcr-target_shard1_replica1] main]\n  [beaster]   2> 63866 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.SolrCore [cdcr-target_shard1_replica1]  CLOSING SolrCore org.apache.solr.core.SolrCore@ebbd9dc\n  [beaster]   2> 63866 INFO  (searcherExecutor-188-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.c.SolrCore [cdcr-target_shard1_replica1] Registered new searcher Searcher@4c22895c[cdcr-target_shard1_replica1] main{ExitableDirectoryReader(UninvertingDirectoryReader(Uninverting(_a(6.6.1):C1000) Uninverting(_b(6.6.1):C1)))}\n  [beaster]   2> 63484 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.IndexFetcher Total time taken for download (fullCopy=false,bytesDownloaded=101357) : 0 secs (null bytes/sec) to MockDirectoryWrapper(RAMDirectory@799f4d8d lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@633c5d00)\n\n\n\nthen cdcr-target abruptly closes, with bootstrap operation failed, giving status \"cancelled\":\n\n\n[beaster]   2> 63866 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.CdcrRequestHandler Solr core is being closed - shutting down CDCR handler @ cdcr-target:shard1\n  [beaster]   2> 63868 INFO  (Thread-98) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.m.SolrMetricManager Closing metric reporters for: solr.core.cdcr-target.shard1.replica1\n  [beaster]   2> 63869 INFO  (recoveryExecutor-110-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.CdcrRequestHandler No replay needed.\n  [beaster]   2> 63869 ERROR (updateExecutor-109-thread-1-processing-n:127.0.0.1:36154_solr x:cdcr-target_shard1_replica1 s:shard1 c:cdcr-target r:core_node1) [n:127.0.0.1:36154_solr c:cdcr-target s:shard1 r:core_node1 x:cdcr-target_shard1_replica1] o.a.s.h.CdcrRequestHandler Bootstrap operation failed\n  [beaster]   2> java.util.concurrent.ExecutionException: java.lang.AssertionError\n  .......\n\n\n\nI am adding addition logging in CdcrRequesHandler to catch and print the root problem of failed bootstrap operation. will post the results soon.  ",
            "author": "Amrit Sarkar",
            "id": "comment-16148468"
        },
        {
            "date": "2017-08-31T12:56:44+0000",
            "content": "Ok.\n\nI had three successful beast runs w/o any assertion failure :\n\nbranch_6_6 :: without applying Shalin's bootstrap status fix patch\n1. ant beast -Dbeast.iters=50 -Dtestcase=CdcrBootstrapTest\n2. ant beast -Dtests.dups=2 -Dtests.iters=2 -Dbeast.iters=35 -Dtestcase=CdcrBootstrapTest\n\nmaster :: patch is committed yesterday\n1. ant beast -Dbeast.iters=50 -Dtestcase=CdcrBootstrapTest -Dtests.dups=2 -Dtests.iters=2\n\nSuddenly life's good. Will keep testing more. ",
            "author": "Amrit Sarkar",
            "id": "comment-16148943"
        },
        {
            "date": "2017-09-01T06:35:34+0000",
            "content": "Rambling again:\n\nWhat is the use of bootstrapFuture essentially? to get status of the current operation, right?\n\nIn CdcrRequestHandler.java :: there are some custom log lines, ignore them:\n\n\n Runnable runnable = () -> {\n      Lock recoveryLock = req.getCore().getSolrCoreState().getRecoveryLock();\n      boolean locked = recoveryLock.tryLock();\n      SolrCoreState coreState = core.getSolrCoreState();\n      try {\n        if (!locked)  {\n          log.info(\"we reached this point :: CANCEL BOOTSTRAP, locked :: \" + locked);\n          handleCancelBootstrap(req, rsp);\n        } else if (leaderStateManager.amILeader())  {\n          coreState.setCdcrBootstrapRunning(true);\n          //running.set(true);\n          String masterUrl = req.getParams().get(ReplicationHandler.MASTER_URL);\n          BootstrapCallable bootstrapCallable = new BootstrapCallable(masterUrl, core);\n          coreState.setCdcrBootstrapCallable(bootstrapCallable);\n          Future<Boolean> bootstrapFuture = core.getCoreContainer().getUpdateShardHandler().getRecoveryExecutor()\n              .submit(bootstrapCallable);\n          try {\n            log.info(\"we reached this point :: all good, bootstrapFuture.get :: \" + bootstrapFuture.get());\n          } catch (Exception e) {\n            log.error(\"bootstrapFuture.get :: \",e);\n          }\n          coreState.setCdcrBootstrapFuture(bootstrapFuture);\n          try {\n            bootstrapFuture.get();\n          } catch (InterruptedException e) {\n            Thread.currentThread().interrupt();\n            log.warn(\"Bootstrap was interrupted\", e);\n          } catch (ExecutionException e) {\n            log.error(\"Bootstrap operation failed\", e);\n          }\n        } else  {\n          log.error(\"Action {} sent to non-leader replica @ {}:{}. Aborting bootstrap.\", CdcrParams.CdcrAction.BOOTSTRAP, collectionName, shard);\n        }\n      } finally {\n        if (locked) {\n          coreState.setCdcrBootstrapRunning(false);\n          recoveryLock.unlock();\n        }\n      }\n    };\n\n\n\nbootstrapFuture.get() throws:\n\n\n  [beaster]   2> 43072 ERROR (updateExecutor-39-thread-1-processing-n:127.0.0.1:41488_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:41488_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler Bootstrap operation failed\n  [beaster]   2> java.util.concurrent.ExecutionException: java.lang.AssertionError\n  [beaster]   2> \tat java.util.concurrent.FutureTask.report(FutureTask.java:122)\n  [beaster]   2> \tat java.util.concurrent.FutureTask.get(FutureTask.java:192)\n  [beaster]   2> \tat org.apache.solr.handler.CdcrRequestHandler.lambda$handleBootstrapAction$0(CdcrRequestHandler.java:653)\n  [beaster]   2> \tat com.codahale.metrics.InstrumentedExecutorService$InstrumentedRunnable.run(InstrumentedExecutorService.java:176)\n  [beaster]   2> \tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n  [beaster]   2> \tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n  [beaster]   2> \tat org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:188)\n  [beaster]   2> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n  [beaster]   2> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n  [beaster]   2> \tat java.lang.Thread.run(Thread.java:748)\n  [beaster]   2> Caused by: java.lang.AssertionError\n  [beaster]   2> \tat org.apache.solr.handler.CdcrRequestHandler$BootstrapCallable.call(CdcrRequestHandler.java:804)\n  [beaster]   2> \tat org.apache.solr.handler.CdcrRequestHandler$BootstrapCallable.call(CdcrRequestHandler.java:723)\n  [beaster]   2> \tat com.codahale.metrics.InstrumentedExecutorService$InstrumentedCallable.call(InstrumentedExecutorService.java:197)\n  [beaster]   2> \t... 5 more\n\nand bootstrap operation fails.\n\nFutureTask.java ::\n\n    /**\n     * Returns result or throws exception for completed task.\n     * @param s completed state value\n     */\n    @SuppressWarnings(\"unchecked\")\n    private V report(int s) throws ExecutionException {\n        Object x = outcome;\n        if (s == NORMAL)\n            return (V)x;\n        if (s >= CANCELLED)\n            throw new CancellationException();\n        throw new ExecutionException((Throwable)x);\n    }\n\n\n\nand the assertion failure is at BootstrapCallable call function finally block ::\n\n        if (closed || !success) {\n          // we cannot apply the buffer in this case because it will introduce newer versions in the\n          // update log and then the source cluster will get those versions via collectioncheckpoint\n          // causing the versions in between to be completely missed\n          boolean dropped = ulog.dropBufferedUpdates();\n          assert dropped;\n        }\n\n\n\ndropped is false, bufferredUpdates are not cleared / dropped?\n\nEarlier the assertion failure is for 2000 to 1000 or 1001, recently I got 2000 to 1100.\n\nI will test with disabled buffer and see if there's any change. ",
            "author": "Amrit Sarkar",
            "id": "comment-16150114"
        },
        {
            "date": "2017-09-01T09:04:01+0000",
            "content": "Root cause of the assertion error ::\n\nIn bootstrap process, in bootstrap callable process,\n\n\n        Future<UpdateLog.RecoveryInfo> future = ulog.applyBufferedUpdates();\n          ....................\n        }\n        return success;\n      } finally {\n        if (closed || !success) {\n          ...................\n          boolean dropped = ulog.dropBufferedUpdates();\n          log.info(\"boostrap callable dropped :: \" + dropped);\n          assert dropped;\n        }\n      }\n\n\n\nulog.dropBufferedUpdates() is getting calculated as false at ::\n\nUpdateLog::dropBufferedUpdates::\n\n\n  /** Returns true if we were able to drop buffered updates and return to the ACTIVE state */\n  public boolean dropBufferedUpdates() {\n    versionInfo.blockUpdates();\n    try {\n      log.info(\"dropBufferedUpdates :: state :: start \" + state);\n      if (state != State.BUFFERING){\n        return false;\n      }\n...............\n\n\n\nThis state is assigned ACTIVE instead of buffering and it returns false and returns..\n\nin UpdateLog, I cannot figure out where exactly state is getting assigned as ACTIVE b/w applybufferedupdates and dropbufferedupdates and running test to detect the same. Ideally the initial value of state is assigned ACTIVE. ",
            "author": "Amrit Sarkar",
            "id": "comment-16150247"
        },
        {
            "date": "2017-09-01T09:06:54+0000",
            "content": "Due to this assertion error, the waitForTargetSync emits the same 1000 / 1001 / 1100 numFound for target for 120 seconds, as bootstrap has failed due to \"UNABLE TO DROP BUFFER UPDATES\". I am not sure what is the significance of dropping updates in finally block in bootstrap process. Would appreciate some advice on this. ",
            "author": "Amrit Sarkar",
            "id": "comment-16150251"
        },
        {
            "date": "2017-09-01T13:01:09+0000",
            "content": "Alright!\n\nThere are two issues in the troubled CDCR test :\n\n1. Why bootstrap is called two seperate times in single life cycle\n\n-> first time bootstrap is called when we enable CDCR, and 1000 documents are boostrapped to target\n\n-> the second one is when bootstrapping is happening in background and new updates are getting shoved down to source. Once the first boostrap is successfully completed, target sees (I speculate) it is much behind and issues bootstrap again, which I don't really understand and putting extra logging doesn't really helps too. I am seeing more. OR all this is wrong, and boostrap is happening just one time in a weird manner.\n\n-> as above listed, the first bootstrap and indexing into source cluster happens simulteneouly at one point. How it is suppose to behave that time.\n\naccording to code: CdcrRequestHandler:BootstrapCallable:call()::\n\n\n........\n @Override\n    public Boolean call() throws Exception {\n      boolean success = false;\n      Throwable exception = null;\n      UpdateLog ulog = core.getUpdateHandler().getUpdateLog();\n      // we start buffering updates as a safeguard however we do not expect\n      // to receive any updates from the source during bootstrap\n      ulog.bufferUpdates();\n      try {\n        commitOnLeader(masterUrl);\n........\n\n\n\n2. Why bootstrap issues at the second time (if it is) fails miserably\n\n-> when the bootstrap is issued, it calls boostrapCallable to apply buffer updates and if \"fetchIndex is not successful OR boostrapCallable is closed\", drop those updates from UpdateLog in finally block\n\n-> in this case, when bootstrap gets issued :: it checks whether it can get the LOCK ::\n\n\nprivate void handleBootstrapAction(SolrQueryRequest req, SolrQueryResponse rsp) throws IOException, SolrServerException {\n    .......................\n\n    Runnable runnable = () -> {\n      Lock recoveryLock = req.getCore().getSolrCoreState().getRecoveryLock();\n      boolean locked = recoveryLock.tryLock();\n      SolrCoreState coreState = core.getSolrCoreState();\n      try {\n        if (!locked)  {\n          log.info(\"we reached this point :: CANCEL BOOTSTRAP, locked :: \" + locked);\n          handleCancelBootstrap(req, rsp);\n        } \n\n\n\nand if not, it issues CANCEL BOOTSTRAP, which happend exactly in this case. CANCEL_BOOSTRAP is issued and applied QUIETLY.\n\n->  in the background within the bootstrap,  applyBufferUpdates, in ulog, tlog is mysteriously NULL, suggesting no updates were recieved, umm why? and return bootstrapFuture as null and set the STATE of replication as ACTIVE.\n\naccording to code :: UpdatesLog.java ::\n\n\n/** Returns the Future to wait on, or null if no replay was needed */\n  public Future<RecoveryInfo> applyBufferedUpdates() {\n    // recovery trips this assert under some race - even when\n    // it checks the state first\n    // assert state == State.BUFFERING;\n\n    // block all updates to eliminate race conditions\n    // reading state and acting on it in the update processor\n    versionInfo.blockUpdates();\n    try {\n      cancelApplyBufferUpdate = false;\n      log.info(\"applyBufferedUpdates :: state :: start :: \" + state);\n      if (state != State.BUFFERING){\n        return null;\n      }\n      operationFlags &= ~FLAG_GAP;\n\n      // handle case when no log was even created because no updates\n      // were received.\n      if (tlog == null) {\n        log.info(\"applyBufferedUpdates :: state :: middle 1 :: \" + state);\n        state = State.ACTIVE;\n        return null;\n      }\n      log.info(\"applyBufferedUpdates :: state :: middle 2 :: \" + state);\n\n\n\n-> now in finally block, the fetchIndex is successfull but \"closed\" is true (DUE TO CANCEL BOOTSTRAP apprently) which is initialised to false:: it tries to drop the buffer updates from ulog where ::\n\n\n /** Returns true if we were able to drop buffered updates and return to the ACTIVE state */\n  public boolean dropBufferedUpdates() {\n    versionInfo.blockUpdates();\n    try {\n      log.info(\"dropBufferedUpdates :: state :: start \" + state);\n      if (state != State.BUFFERING){\n        return false;\n      }\n.......\n\n\n\nSTATE is ACTIVE and returns false.\n\nfaling the \"assert dropped\" in BootstrapCallable and eventually emitting: \"bootstrap operation failed\".\n\nOnce bootstrap fails, in CdcrBootsrapTest::waitTargetToSync :: it waits for 120 seconds, and recieves constant numFound from target, == 1000 / 1001 / 1100, any number basically before boostrap failed and eventually Assertion at CdcrBootsrapTest fails.\n\nThere are still some unanswered questions like:\n\n1. Why in the first place two boostrap command are issued OR we think we two are issued and it one wrapped up in an awkward life time. Why the conventional forwarding not happening?\n2. When it tries to drop the buffer updates, why the tlog is null? It has recieved updates from source, but why it is NULL in target cluster. Is there a synchrnization issue?\n\nso the matter of the question is this lock ::\n\n\nLock recoveryLock = req.getCore().getSolrCoreState().getRecoveryLock();\n      boolean locked = recoveryLock.tryLock();\n\n\n\nMore insights will be deeply appreciated. I believe we are very close. ",
            "author": "Amrit Sarkar",
            "id": "comment-16150469"
        },
        {
            "date": "2017-09-01T16:01:08+0000",
            "content": "Confirmed there are two seperate bootstrap threads initiated, one acquires lock, one fails ::\n\n[beaster]   2> 34430 INFO  (updateExecutor-39-thread-1-processing-n:127.0.0.1:35690_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:35690_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler what' the lock this time :: true\n  [beaster]   2> 34431 INFO  (qtp510024884-173) [n:127.0.0.1:35690_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.S.Request [cdcr-target_shard1_replica_n1]  webapp=/solr path=/cdcr params={qt=/cdcr&masterUrl=http://127.0.0.1:38721/solr/cdcr-source_shard1_replica_n1/&action=BOOTSTRAP&wt=javabin&version=2} status=0 QTime=10\n  [beaster]   2> 34432 INFO  (qtp600983226-216) [n:127.0.0.1:38721_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.c.S.Request [cdcr-source_shard1_replica_n1]  webapp=/solr path=/update params={_stateVer_=cdcr-source:4&wt=javabin&version=2} status=0 QTime=13\n  [beaster]   2> 34433 INFO  (updateExecutor-39-thread-2-processing-n:127.0.0.1:35690_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:35690_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler what' the lock this time :: false\n\n\n\nupdateExecutor-39-thread-1-processing.....\nupdateExecutor-39-thread-2-processing.....\n\nThere are only three lines printed (two added for extensive logging) for updateExecutor-39-thread-2-processing, why? and why it is introduced at first place.\n\n\n  [beaster]   2> 34433 INFO  (updateExecutor-39-thread-2-processing-n:127.0.0.1:35690_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:35690_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler what' the lock this time :: false\n  [beaster]   2> 34433 INFO  (updateExecutor-39-thread-2-processing-n:127.0.0.1:35690_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:35690_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler we reached this point :: CANCEL BOOTSTRAP, locked :: false\n  [beaster]   2> 34433 INFO  (updateExecutor-39-thread-2-processing-n:127.0.0.1:35690_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:35690_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler someone called me, yes they did\n\n\n\nMy best guess :\n\nSee after updateExecutor-39-thread-1-processing gets the lock and invoke BOOTSTRAP api. An update is received on source collection and right after that another \"updateExecutor-39-thread-2-processing\" is invoked trying to acquire the lock and eventually when it fails, invoke CANCEL_BOOTSTRAP, creating chaos.\n\nThe fine time frame b/w INVOKING bootstrap, CHANGING bootstrap status to running and RECEIVING a new update on source is creating confusion/chaos, as handleBootrapStatus is runnable thread, so more than one can gets invoked.\n\nGot the cause, need the solution. ",
            "author": "Amrit Sarkar",
            "id": "comment-16150771"
        },
        {
            "date": "2017-09-01T17:32:48+0000",
            "content": "Another example, why two simultaneous threads are getting created to invoke BOOTSTRAP?\n\n\n  [beaster]   2> 38858 INFO  (updateExecutor-39-thread-1-processing-n:127.0.0.1:42155_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42155_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler what' the lock this time :: true :: thread :: org.apache.solr.handler.CdcrRequestHandler@64d1ccf3\n  [beaster]   2> 38858 INFO  (qtp1415866434-168) [n:127.0.0.1:42155_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.S.Request [cdcr-target_shard1_replica_n1]  webapp=/solr path=/cdcr params={qt=/cdcr&action=BOOTSTRAP_STATUS&wt=javabin&version=2} status=0 QTime=0\n  [beaster]   2> 38859 WARN  (cdcr-bootstrap-status-66-thread-1-processing-n:127.0.0.1:36193_solr x:cdcr-source_shard1_replica_n1 s:shard1 c:cdcr-source r:core_node2) [n:127.0.0.1:36193_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.h.CdcrReplicatorManager Bootstrap process was not found on target collection: cdcr-target shard: shard1, leader: http://127.0.0.1:42155/solr/cdcr-target_shard1_replica_n1/\n  [beaster]   2> 38860 INFO  (cdcr-bootstrap-status-66-thread-1-processing-n:127.0.0.1:36193_solr x:cdcr-source_shard1_replica_n1 s:shard1 c:cdcr-source r:core_node2) [n:127.0.0.1:36193_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.h.CdcrReplicatorManager Attempting to bootstrap target collection: cdcr-target shard: shard1 leader: http://127.0.0.1:42155/solr/cdcr-target_shard1_replica_n1/\n  [beaster]   2> 38860 INFO  (qtp1415866434-173) [n:127.0.0.1:42155_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler Boostrap is issued now. Request :: {action=BOOTSTRAP&qt=/cdcr&masterUrl=http://127.0.0.1:36193/solr/cdcr-source_shard1_replica_n1/&wt=javabin&version=2} : collection : cdcr-target\n  [beaster]   2> 38865 INFO  (recoveryExecutor-40-thread-1-processing-n:127.0.0.1:42155_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42155_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.u.UpdateLog Starting to buffer updates. FSUpdateLog{state=ACTIVE, tlog=null}\n  [beaster]   2> 38865 INFO  (qtp1415866434-173) [n:127.0.0.1:42155_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.S.Request [cdcr-target_shard1_replica_n1]  webapp=/solr path=/cdcr params={qt=/cdcr&masterUrl=http://127.0.0.1:36193/solr/cdcr-source_shard1_replica_n1/&action=BOOTSTRAP&wt=javabin&version=2} status=0 QTime=4\n  [beaster]   2> 38865 INFO  (updateExecutor-39-thread-2-processing-n:127.0.0.1:42155_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42155_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler what' the lock this time :: false :: thread :: org.apache.solr.handler.CdcrRequestHandler@64d1ccf3\n\n\n\nthe code is like this:\n\n\nprivate void handleBootstrapAction(SolrQueryRequest req, SolrQueryResponse rsp) throws IOException, SolrServerException {\n...................\n...................\n    Runnable runnable = () -> {\n      Lock recoveryLock = req.getCore().getSolrCoreState().getRecoveryLock();\n      boolean locked = recoveryLock.tryLock();\n      log.info(\"what' the lock this time :: \" + locked + \" :: thread :: \" + this);\n      SolrCoreState coreState = core.getSolrCoreState();\n\n ",
            "author": "Amrit Sarkar",
            "id": "comment-16150879"
        },
        {
            "date": "2017-09-01T17:36:38+0000",
            "content": "Uploading patch I used for testing:: master-bs.patch ",
            "author": "Amrit Sarkar",
            "id": "comment-16150889"
        },
        {
            "date": "2017-09-02T17:40:37+0000",
            "content": "I just ran the patch against 7x with two different modes:\n\n1> the original patch x 100\n2> removed the three second wait in the test case x 250\n\n<1> had no errors\n<2> had one error, not the same one and I haven't pursued it yet, excerpt below. I have the full test case. I'm going to put the 3 second wait back in and try 1,000 iterations to see if this error occurs again.\n\nNOTE: I don't think then sleep is something we want to leave in the code, just seeing if it alters the results for a clue where to look next.\n\nThis is good progress! Oh, I haven't reviewed the patch in detail yet either, just trying to get a sense of what the behavior is before diving in.\n\n[junit4]   2> 49759 INFO  (Thread-83) [n:127.0.0.1:59962_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.SolrCore [cdcr-target_shard1_replica_n1]  CLOSING SolrCore org.apache.solr.core.SolrCore@2fdc6dad\n   [junit4]   2> 49759 INFO  (Thread-83) [n:127.0.0.1:59962_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.m.SolrMetricManager Closing metric reporters for registry=solr.core.cdcr-target.shard1.replica_n1, tag=802975149\n   [junit4]   2> 49759 INFO  (Thread-83) [n:127.0.0.1:59962_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.m.r.SolrJmxReporter Closing reporter [org.apache.solr.metrics.reporters.SolrJmxReporter@7b017431: rootName = solr_59962, domain = solr.core.cdcr-target.shard1.replica_n1, service url = null, agent id = null] for registry solr.core.cdcr-target.shard1.replica_n1 / com.codahale.metrics.MetricRegistry@67a56b63\n   [junit4]   2> 49760 INFO  (searcherExecutor-150-thread-1-processing-n:127.0.0.1:59962_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:59962_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.SolrCore [cdcr-target_shard1_replica_n1] Registered new searcher Searcher@51a42485[cdcr-target_shard1_replica_n1] main\n{ExitableDirectoryReader(UninvertingDirectoryReader(Uninverting(_k(7.1.0):C1900) Uninverting(_l(7.1.0):C100)))}\n   [junit4]   2> 49774 INFO  (Thread-83) [n:127.0.0.1:59962_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.m.SolrMetricManager Closing metric reporters for registry=solr.collection.cdcr-target.shard1.leader, tag=802975149\n   [junit4]   2> 49775 INFO  (Thread-83) [n:127.0.0.1:59962_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler Solr core is being closed - shutting down CDCR handler @ cdcr-target:shard1\n   [junit4]   2> 62525 ERROR (Thread-83) [n:127.0.0.1:59962_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.CachingDirectoryFactory Timeout waiting for all directory ref counts to be released - gave up waiting on CachedDir<<refCount=1;path=/Users/Erick/apache/solrJiras/beast/results/beast-tmp/203/J0/temp/solr.cloud.CdcrBootstrapTest_DCBEC103DFB44964-001/cdcr-target-003/node1/./cdcr-target_shard1_replica_n1/data/index.20170902102657976;done=false>>\n   [junit4]   2> 62526 ERROR (Thread-83) [n:127.0.0.1:59962_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.CachingDirectoryFactory Error closing directory:org.apache.solr.common.SolrException: Timeout waiting for all directory ref counts to be released - gave up waiting on CachedDir<<refCount=1;path=/Users/Erick/apache/solrJiras/beast/results/beast-tmp/203/J0/temp/solr.cloud.CdcrBootstrapTest_DCBEC103DFB44964-001/cdcr-target-003/node1/./cdcr-target_shard1_replica_n1/data/index.20170902102657976;done=false>>\n   [junit4]   2> \tat org.apache.solr.core.CachingDirectoryFactory.close(CachingDirectoryFactory.java:178)\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.close(SolrCore.java:1613)\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.registerCore(CoreContainer.java:859)\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.reload(CoreContainer.java:1232)\n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.lambda$reloadCore$0(IndexFetcher.java:900)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:745)\n   [junit4]   2> \n   [junit4]   2> 75243 ERROR (Thread-83) [n:127.0.0.1:59962_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.CachingDirectoryFactory Timeout waiting for all directory ref counts to be released - gave up waiting on CachedDir<<refCount=1;path=/Users/Erick/apache/solrJiras/beast/results/beast-tmp/203/J0/temp/solr.cloud.CdcrBootstrapTest_DCBEC103DFB44964-001/cdcr-target-003/node1/./cdcr-target_shard1_replica_n1/data/index;done=false>>\n   [junit4]   2> 75243 ERROR (Thread-83) [n:127.0.0.1:59962_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.CachingDirectoryFactory Error closing directory:org.apache.solr.common.SolrException: Timeout waiting for all directory ref counts to be released - gave up waiting on CachedDir<<refCount=1;path=/Users/Erick/apache/solrJiras/beast/results/beast-tmp/203/J0/temp/solr.cloud.CdcrBootstrapTest_DCBEC103DFB44964-001/cdcr-target-003/node1/./cdcr-target_shard1_replica_n1/data/index;done=false>>\n   [junit4]   2> \tat org.apache.solr.core.CachingDirectoryFactory.close(CachingDirectoryFactory.java:178)\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.close(SolrCore.java:1613)\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.registerCore(CoreContainer.java:859)\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.reload(CoreContainer.java:1232)\n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.lambda$reloadCore$0(IndexFetcher.java:900)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:745)\n   [junit4]   2> \n   [junit4]   2> 75244 ERROR (Thread-83) [n:127.0.0.1:59962_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.SolrCore java.lang.AssertionError: 1\n   [junit4]   2> \tat org.apache.solr.core.CachingDirectoryFactory.close(CachingDirectoryFactory.java:192)\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.close(SolrCore.java:1613)\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.registerCore(CoreContainer.java:859)\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.reload(CoreContainer.java:1232)\n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.lambda$reloadCore$0(IndexFetcher.java:900)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:745)\n   [junit4]   2> \n   [junit4]   2> 75245 ERROR (recoveryExecutor-81-thread-1-processing-n:127.0.0.1:59962_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:59962_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.ReplicationHandler Index fetch failed :org.apache.solr.common.SolrException: Index fetch failed : \n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:655)\n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:332)\n   [junit4]   2> \tat org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:419)\n   [junit4]   2> \tat org.apache.solr.handler.CdcrRequestHandler$BootstrapCallable.call(CdcrRequestHandler.java:773)\n   [junit4]   2> \tat org.apache.solr.handler.CdcrRequestHandler$BootstrapCallable.call(CdcrRequestHandler.java:724)\n   [junit4]   2> \tat com.codahale.metrics.InstrumentedExecutorService$InstrumentedCallable.call(InstrumentedExecutorService.java:197)\n   [junit4]   2> \tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n   [junit4]   2> \tat org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:188)\n   [junit4]   2> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n   [junit4]   2> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:745)\n   [junit4]   2> Caused by: java.lang.NullPointerException\n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.openNewSearcherAndUpdateCommitPoint(IndexFetcher.java:888)\n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:632)\n   [junit4]   2> \t... 10 more\n   [junit4]   2> \n   [junit4]   2> 75245 INFO  (recoveryExecutor-81-thread-1-processing-n:127.0.0.1:59962_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:59962_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler boostrap cal\n ",
            "author": "Erick Erickson",
            "id": "comment-16151552"
        },
        {
            "date": "2017-09-02T19:35:15+0000",
            "content": "Thanks Erick, I was also seeing that NPE earlier, but after Shalin's patch I didn't came across it again.\n\nMeanwhile I am also running a beaster: ant beast -Dbeast.iters=100 -Dtestcase=CdcrBootstrapTest -Dtests.dups=2 -Dtests.iters=2\n\nI think we should put AwaitsFix(...) if the problem is only with: testBootstrapWithContinousIndexingOnSourceCluster to give us some cushion to work upon it. if we are seeing the same issue with other testMethods, we can ignore the entire test, whatever's best. I have uploaded AwaitsFix patch. Erick Erickson Shalin Shekhar Mangar please do the necessary. ",
            "author": "Amrit Sarkar",
            "id": "comment-16151569"
        },
        {
            "date": "2017-09-04T04:13:06+0000",
            "content": "Commit e782082e711286a4c1a6ca101a9fa11bafab7b0d in lucene-solr's branch refs/heads/master from Shalin Shekhar Mangar\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=e782082 ]\n\nSOLR-11278: Disable frequently failing method with AwaitsFix ",
            "author": "ASF subversion and git services",
            "id": "comment-16152103"
        },
        {
            "date": "2017-09-04T04:13:50+0000",
            "content": "Commit f8906b6533bc2c3f4aebe48d3caa93a9634f6a31 in lucene-solr's branch refs/heads/branch_7x from Shalin Shekhar Mangar\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f8906b6 ]\n\nSOLR-11278: Disable frequently failing method with AwaitsFix\n\n(cherry picked from commit e782082) ",
            "author": "ASF subversion and git services",
            "id": "comment-16152105"
        },
        {
            "date": "2017-09-04T04:14:30+0000",
            "content": "Commit b6cbf75d003bff603d8a2a5fe67de841be7b1e78 in lucene-solr's branch refs/heads/branch_7_0 from Shalin Shekhar Mangar\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b6cbf75 ]\n\nSOLR-11278: Disable frequently failing method with AwaitsFix\n\n(cherry picked from commit e782082)\n\n(cherry picked from commit f8906b6) ",
            "author": "ASF subversion and git services",
            "id": "comment-16152106"
        },
        {
            "date": "2017-09-05T09:11:37+0000",
            "content": "More detailing,\n\n\n  [beaster]   2> 76078 INFO  (zkCallback-171-thread-1-processing-n:127.0.0.1:39903_solr) [n:127.0.0.1:39903_solr    ] o.a.s.h.CdcrProcessStateManager Received new CDCR process state from watcher: STARTED @ cdcr-source:shard1\n  [beaster]   2> 76079 INFO  (qtp499216332-625) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler Boostrap is issued now. Request :: {action=BOOTSTRAP&qt=/cdcr&masterUrl=http://127.0.0.1:39903/solr/cdcr-source_shard1_replica_n1/&wt=javabin&version=2} : collection : cdcr-target\n  [beaster]   2> 76079 INFO  (qtp499216332-625) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler bs runnable : org.apache.solr.handler.CdcrRequestHandler$$Lambda$256/1608384375@cfd51e6\n  [beaster]   2> 76079 INFO  (qtp499216332-625) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler bs service : com.codahale.metrics.InstrumentedExecutorService@23aae09\n  [beaster]   2> 76079 INFO  (qtp499216332-625) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.S.Request [cdcr-target_shard1_replica_n1]  webapp=/solr path=/cdcr params={qt=/cdcr&masterUrl=http://127.0.0.1:39903/solr/cdcr-source_shard1_replica_n1/&action=BOOTSTRAP&wt=javabin&version=2} status=0 QTime=0\n  [beaster]   2> 76079 INFO  (qtp1089963867-718) [n:127.0.0.1:39903_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.c.S.Request [cdcr-source_shard1_replica_n1]  webapp=/solr path=/cdcr params={qt=/cdcr&_stateVer_=cdcr-source:7&action=queues&wt=javabin&version=2} status=0 QTime=0\n  [beaster]   1> Cdcr queue response: {responseHeader={status=0,QTime=0},queues={127.0.0.1:37043/solr={cdcr-target={queueSize=-1703936001,lastTimestamp=}}},tlogTotalSize=4773,tlogTotalCount=1,updateLogSynchronizer=stopped}\n  [beaster]   2> 76081 INFO  (qtp499216332-629) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.u.DirectUpdateHandler2 start commit{_version_=1577620265858236416,optimize=false,openSearcher=true,waitSearcher=true,expungeDeletes=false,softCommit=false,prepareCommit=false}\n  [beaster]   2> 76082 INFO  (qtp499216332-629) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.u.DirectUpdateHandler2 No uncommitted changes. Skipping IW.commit.\n  [beaster]   2> 76082 INFO  (updateExecutor-143-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler what the fuck is happening :: Thread[updateExecutor-143-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2,5,TGRP-CdcrBootstrapTest]\n  [beaster]   2> 76083 INFO  (updateExecutor-143-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler what' the lock this time :: true :: thread :: org.apache.solr.handler.CdcrRequestHandler@259eac66\n  [beaster]   2> 76083 INFO  (updateExecutor-143-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler we reached this point :: BOOTSTRAP will go on, locked :: true\n  [beaster]   2> 76083 INFO  (qtp499216332-628) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.S.Request [cdcr-target_shard1_replica_n1]  webapp=/solr path=/cdcr params={qt=/cdcr&action=BOOTSTRAP_STATUS&wt=javabin&version=2} status=0 QTime=0\n  [beaster]   2> 76082 INFO  (qtp499216332-629) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.u.DirectUpdateHandler2 end_commit_flush\n  [beaster]   2> 76083 INFO  (qtp499216332-629) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.S.Request [cdcr-target_shard1_replica_n1]  webapp=/solr path=/update params={_stateVer_=cdcr-target:4&waitSearcher=true&commit=true&softCommit=false&wt=javabin&version=2} status=0 QTime=2\n  [beaster]   2> 76084 WARN  (cdcr-bootstrap-status-177-thread-1-processing-n:127.0.0.1:39903_solr x:cdcr-source_shard1_replica_n1 s:shard1 c:cdcr-source r:core_node2) [n:127.0.0.1:39903_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.h.CdcrReplicatorManager Bootstrap process was not found on target collection: cdcr-target shard: shard1, leader: http://127.0.0.1:42370/solr/cdcr-target_shard1_replica_n1/\n  [beaster]   2> 76085 INFO  (qtp499216332-623) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.S.Request [cdcr-target_shard1_replica_n1]  webapp=/solr path=/select params={q=*:*&_stateVer_=cdcr-target:4&wt=javabin&version=2} hits=0 status=0 QTime=0\n  [beaster]   2> 76085 INFO  (TEST-CdcrBootstrapTest.testConvertClusterToCdcrAndBootstrap-seed#[950E76D71DFD418]) [    ] o.a.s.c.CdcrBootstrapTest numDocs found for now :: 1 :: 0\n  [beaster]   2> 76085 INFO  (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.u.UpdateLog Starting to buffer updates. FSUpdateLog{state=ACTIVE, tlog=null}\n  [beaster]   2> 76092 INFO  (cdcr-bootstrap-status-177-thread-1-processing-n:127.0.0.1:39903_solr x:cdcr-source_shard1_replica_n1 s:shard1 c:cdcr-source r:core_node2) [n:127.0.0.1:39903_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.h.CdcrReplicatorManager Attempting to bootstrap target collection: cdcr-target shard: shard1 leader: http://127.0.0.1:42370/solr/cdcr-target_shard1_replica_n1/\n  [beaster]   2> 76093 INFO  (qtp499216332-627) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler Boostrap is issued now. Request :: {action=BOOTSTRAP&qt=/cdcr&masterUrl=http://127.0.0.1:39903/solr/cdcr-source_shard1_replica_n1/&wt=javabin&version=2} : collection : cdcr-target\n  [beaster]   2> 76093 INFO  (qtp499216332-627) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler bs runnable : org.apache.solr.handler.CdcrRequestHandler$$Lambda$256/1608384375@785b9b5f\n  [beaster]   2> 76093 INFO  (qtp499216332-627) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler bs service : com.codahale.metrics.InstrumentedExecutorService@23aae09\n  [beaster]   2> 76094 INFO  (qtp1089963867-721) [n:127.0.0.1:39903_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.u.DirectUpdateHandler2 start commit{_version_=1577620265871867904,optimize=false,openSearcher=false,waitSearcher=true,expungeDeletes=false,softCommit=false,prepareCommit=false}\n  [beaster]   2> 76094 INFO  (qtp499216332-627) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.S.Request [cdcr-target_shard1_replica_n1]  webapp=/solr path=/cdcr params={qt=/cdcr&masterUrl=http://127.0.0.1:39903/solr/cdcr-source_shard1_replica_n1/&action=BOOTSTRAP&wt=javabin&version=2} status=0 QTime=0\n  [beaster]   2> 76100 INFO  (qtp1089963867-721) [n:127.0.0.1:39903_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.u.DirectUpdateHandler2 No uncommitted changes. Skipping IW.commit.\n  [beaster]   2> 76101 INFO  (qtp1089963867-721) [n:127.0.0.1:39903_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.u.DirectUpdateHandler2 end_commit_flush\n  [beaster]   2> 76102 INFO  (qtp1089963867-721) [n:127.0.0.1:39903_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.c.S.Request [cdcr-source_shard1_replica_n1]  webapp=/solr path=/update params={waitSearcher=true&openSearcher=false&commit=true&softCommit=false&commit_end_point=true&wt=javabin&version=2} status=0 QTime=8\n  [beaster]   2> 76102 INFO  (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler boostrap callable closed :: false\n  [beaster]   2> 76104 INFO  (updateExecutor-143-thread-2-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler what the fuck is happening :: Thread[updateExecutor-143-thread-2-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2,5,TGRP-CdcrBootstrapTest]\n  [beaster]   2> 76104 INFO  (updateExecutor-143-thread-2-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler what' the lock this time :: false :: thread :: org.apache.solr.handler.CdcrRequestHandler@259eac66\n  [beaster]   2> 76104 INFO  (updateExecutor-143-thread-2-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler we reached this point :: CANCEL BOOTSTRAP, locked :: false\n  [beaster]   2> 76104 INFO  (updateExecutor-143-thread-2-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler someone called me, yes they did\n  [beaster]   2> 76104 INFO  (qtp1089963867-722) [n:127.0.0.1:39903_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.c.S.Request [cdcr-source_shard1_replica_n1]  webapp=/solr path=/replication params={qt=/replication&wt=javabin&version=2&command=indexversion} status=0 QTime=0\n  [beaster]   2> 76104 INFO  (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.IndexFetcher Master's generation: 12\n  [beaster]   2> 76104 INFO  (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.IndexFetcher Master's version: 1504535923111\n  [beaster]   2> 76105 INFO  (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.IndexFetcher Slave's generation: 1\n  [beaster]   2> 76105 INFO  (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.IndexFetcher Slave's version: 0\n  [beaster]   2> 76105 INFO  (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.IndexFetcher Starting replication process\n  [beaster]   2> 76111 INFO  (qtp1089963867-722) [n:127.0.0.1:39903_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.h.ReplicationHandler Adding tlog files to list: [{size=4773, name=tlog.0000000000000000009}]\n  [beaster]   2> 76111 INFO  (qtp1089963867-722) [n:127.0.0.1:39903_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.c.S.Request [cdcr-source_shard1_replica_n1]  webapp=/solr path=/replication params={generation=12&qt=/replication&wt=javabin&version=2&command=filelist} status=0 QTime=5\n  [beaster]   2> 76111 INFO  (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.IndexFetcher Number of files in latest index in master: 13\n  [beaster]   2> 76111 INFO  (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.IndexFetcher Number of tlog files in master: 1\n  [beaster]   2> 76112 INFO  (qtp499216332-622) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.c.S.Request [cdcr-target_shard1_replica_n1]  webapp=/solr path=/cdcr params={qt=/cdcr&action=BOOTSTRAP_STATUS&wt=javabin&version=2} status=0 QTime=0\n  [beaster]   2> 76113 INFO  (cdcr-bootstrap-status-177-thread-1-processing-n:127.0.0.1:39903_solr x:cdcr-source_shard1_replica_n1 s:shard1 c:cdcr-source r:core_node2) [n:127.0.0.1:39903_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.h.CdcrReplicatorManager CDCR bootstrap running for 1 seconds, sleeping for 2000 ms\n  [beaster]   2> 76119 INFO  (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.u.DefaultSolrCoreState New IndexWriter is ready to be used.\n  [beaster]   2> 76119 INFO  (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.IndexFetcher Starting download (fullCopy=false) to MockDirectoryWrapper(RAMDirectory@1ec60471 lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@1b16e27d)\n  [beaster]   2> 76120 INFO  (qtp1089963867-723) [n:127.0.0.1:39903_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.c.S.Request [cdcr-source_shard1_replica_n1]  webapp=/solr path=/replication params={generation=12&qt=/replication&file=_a_Lucene50_0.pos&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0\n  [beaster]   2> 76122 INFO  (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.u.DefaultSolrCoreState New IndexWriter is ready to be used.\n  [beaster]   2> 76122 ERROR (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.IndexFetcher User aborted Replication\n  [beaster]   2> 76122 INFO  (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler boostrap callable status :: false\n  [beaster]   2> 76122 INFO  (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler boostrap callable closed :: true\n  [beaster]   2> 76122 ERROR (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler fetch failed for bootstrap :: org.apache.solr.handler.IndexFetcher$ReplicationHandlerException: User aborted replication\n\n\n\nFirst time the Bootstrap is called, it checks whether the BOOTSTRAP is started or not.\n\n\n[beaster]   2> 76084 WARN  (cdcr-bootstrap-status-177-thread-1-processing-n:127.0.0.1:39903_solr x:cdcr-source_shard1_replica_n1 s:shard1 c:cdcr-source r:core_node2) [n:127.0.0.1:39903_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.h.CdcrReplicatorManager Bootstrap process was not found on target collection: cdcr-target shard: shard1, leader: http://127.0.0.1:42370/solr/cdcr-target_shard1_replica_n1/\n\n\n\nand then attempts to starts BOOTSTRAP again. Please MIND, the first call is still in play and second one is called too ::\n\n\n [beaster]   2> 76092 INFO  (cdcr-bootstrap-status-177-thread-1-processing-n:127.0.0.1:39903_solr x:cdcr-source_shard1_replica_n1 s:shard1 c:cdcr-source r:core_node2) [n:127.0.0.1:39903_solr c:cdcr-source s:shard1 r:core_node2 x:cdcr-source_shard1_replica_n1] o.a.s.h.CdcrReplicatorManager Attempting to bootstrap target collection: cdcr-target shard: shard1 leader: http://127.0.0.1:42370/solr/cdcr-target_shard1_replica_n1/\n\n\n\nReplication begins successfully:\n\n\n  [beaster]   2> 76105 INFO  (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.IndexFetcher Starting replication process\n\n\n\nbut in the end: its gets aborted saying \"Uber aborted .......\". THIS ABORT is due to CANCEL_BOOTSTRAP called by 2nd thread.\n\n\n  [beaster]   2> 76122 ERROR (recoveryExecutor-144-thread-1-processing-n:127.0.0.1:42370_solr x:cdcr-target_shard1_replica_n1 s:shard1 c:cdcr-target r:core_node2) [n:127.0.0.1:42370_solr c:cdcr-target s:shard1 r:core_node2 x:cdcr-target_shard1_replica_n1] o.a.s.h.CdcrRequestHandler fetch failed for bootstrap :: org.apache.solr.handler.IndexFetcher$ReplicationHandlerException: User aborted replication\n\n ",
            "author": "Amrit Sarkar",
            "id": "comment-16153335"
        },
        {
            "date": "2017-09-19T00:43:13+0000",
            "content": "I had an offline discussion with Shalin and Varun and we are able to figure out what's wrong in the Cdcr Bootstrap.\n\n\n\tsince issuing bootstrap is an asynchronous call, there is a probable race around condition where after issuing a bootstrap, it immediately checks for bootstrap status and if not found, another bootstrap gets issued.\n\tthis 2nd bootstrap fails to acquire lock issues cancel boostrap\n\tsince the bootstrap at target is now \"cancelled\", the bootstrap status in CdcrReplicatorManager goes into rigorous infinite loop as the condition \"cancelled\" is not handled.\n\n\n\nIn the patch both \"submitted\" and \"cancelled\" bootstrap status conditions and 'what to do next' is covered, which will nullify the extensive bootstrap calling and even the bootstrap should complete successfully.  ",
            "author": "Amrit Sarkar",
            "id": "comment-16170958"
        },
        {
            "date": "2017-09-19T16:28:48+0000",
            "content": "I'm going to commit this to master and see how Jenkins behaves for the next couple of days ",
            "author": "Varun Thacker",
            "id": "comment-16171988"
        },
        {
            "date": "2017-09-19T16:30:41+0000",
            "content": "Commit 8e12f201131d44034efe0cd97dee23df4b16b015 in lucene-solr's branch refs/heads/master from Varun Thacker\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=8e12f20 ]\n\nSOLR-11278: Fix race-condition in CDCR submitting a bootstrap call and checking it's status ",
            "author": "ASF subversion and git services",
            "id": "comment-16171992"
        },
        {
            "date": "2017-09-19T17:13:33+0000",
            "content": "Thanks Varun, \n\nSuccessfully beasted: ant beast -Dtestcase=CdcrBootstrapTest -Dbeast.iters=500 -Dtests.iters=3 for the committed patch. ",
            "author": "Amrit Sarkar",
            "id": "comment-16172036"
        },
        {
            "date": "2017-09-20T23:44:03+0000",
            "content": "Uploading another patch which makes sure if we request bootstrap status after submitting a bootstrap, we get the correct status: RUNNING. Used CountDownLatch internally in the function. ",
            "author": "Amrit Sarkar",
            "id": "comment-16174015"
        },
        {
            "date": "2017-09-22T20:56:22+0000",
            "content": "Slight modifications on discussion with Shalin offline. Patch uploaded. ",
            "author": "Amrit Sarkar",
            "id": "comment-16177106"
        },
        {
            "date": "2017-09-27T21:34:53+0000",
            "content": "Commit 26677ab2b041a074fd984457677cbea8b58363ab in lucene-solr's branch refs/heads/master from Varun Thacker\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=26677ab ]\n\nSOLR-11278: Fix a race condition in the CDCR bootstrap process which could lead to bootstraps cancelling itself ",
            "author": "ASF subversion and git services",
            "id": "comment-16183297"
        },
        {
            "date": "2017-09-27T22:21:41+0000",
            "content": "Commit 1de25182370dec69a34a9999721127aee0ecc0fe in lucene-solr's branch refs/heads/branch_7x from Varun Thacker\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=1de2518 ]\n\nSOLR-11278: Fix a race condition in the CDCR bootstrap process which could lead to bootstraps cancelling itself ",
            "author": "ASF subversion and git services",
            "id": "comment-16183361"
        },
        {
            "date": "2017-09-27T22:21:53+0000",
            "content": "Thanks Amrit and Shalin! ",
            "author": "Varun Thacker",
            "id": "comment-16183362"
        },
        {
            "date": "2017-09-29T22:08:28+0000",
            "content": "Should the commits on this issue be backported to branch_7_0, to be included in Solr 7.0.1? ",
            "author": "Steve Rowe",
            "id": "comment-16186578"
        },
        {
            "date": "2017-09-29T22:20:24+0000",
            "content": "Looks like it was happy for 1 day but today I see a failure : https://jenkins.thetaphi.de/job/Lucene-Solr-7.x-Linux/517/\n\nI won't get time to look at this for another till tuesday atleast . Let's not hold up 7.0.1 for this? \n\nPeople who hit this race condition in 7.0 can fix it by restarting the target cluster as the bootstrap will fail. Not the best experience but they are starting a new cluster so hopefully not a big deal. ",
            "author": "Varun Thacker",
            "id": "comment-16186592"
        },
        {
            "date": "2017-09-30T10:45:12+0000",
            "content": "[...] today I see a failure [....] Let's not hold up 7.0.1 for this?\n\n+1 ",
            "author": "Steve Rowe",
            "id": "comment-16187021"
        },
        {
            "date": "2017-10-02T21:44:11+0000",
            "content": "Still seeing failures on Jenkins ",
            "author": "Varun Thacker",
            "id": "comment-16188903"
        },
        {
            "date": "2017-10-07T13:16:35+0000",
            "content": "Varun Thacker,\n\nFailure is very inconsistent. None of the failuers accessible at https://jenkins.thetaphi.de/job/Lucene-Solr-7.x-Linux/ have the test failing and I am unable to produce it for 100 and 500 beasts. Not sure, how to proceed on this now. ",
            "author": "Amrit Sarkar",
            "id": "comment-16195690"
        },
        {
            "date": "2017-10-07T14:32:02+0000",
            "content": "Amrit:\n\nOne strategy is to put debugging only code into master (not 7x) to test hypotheses. Be sure to track it carefully and take it out as soon as you can of course. ",
            "author": "Erick Erickson",
            "id": "comment-16195727"
        },
        {
            "date": "2017-10-11T04:41:44+0000",
            "content": "Closing this issue out as the fix will be part of the 7.1 release.\n\nLet's open a new Jira to fix the new failures ",
            "author": "Varun Thacker",
            "id": "comment-16199800"
        },
        {
            "date": "2017-10-17T11:03:49+0000",
            "content": "Bulk close after 7.1.0 release ",
            "author": "Shalin Shekhar Mangar",
            "id": "comment-16207379"
        }
    ]
}