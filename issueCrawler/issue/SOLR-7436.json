{
    "id": "SOLR-7436",
    "title": "Solr stops printing stacktraces in log and output",
    "details": {
        "components": [],
        "type": "Bug",
        "labels": "",
        "fix_versions": [
            "6.3",
            "7.0"
        ],
        "affect_versions": "5.1",
        "status": "Closed",
        "resolution": "Fixed",
        "priority": "Major"
    },
    "description": "After a short while, Solr suddenly stops printing stacktraces in the log and output. \n\n\n251043 [qtp1121454968-17] INFO  org.apache.solr.core.SolrCore.Request  [   suggests] - [suggests] webapp=/solr path=/select params={q=*:*&fq={!collapse+field%3Dquery_digest}&fq={!collapse+field%3Dresult_digest}} status=500 QTime=3 \n251043 [qtp1121454968-17] ERROR org.apache.solr.servlet.SolrDispatchFilter  [   suggests] - null:java.lang.NullPointerException\n        at org.apache.solr.search.CollapsingQParserPlugin$IntScoreCollector.finish(CollapsingQParserPlugin.java:743)\n        at org.apache.solr.search.CollapsingQParserPlugin$IntScoreCollector.finish(CollapsingQParserPlugin.java:780)\n        at org.apache.solr.search.SolrIndexSearcher.buildAndRunCollectorChain(SolrIndexSearcher.java:203)\n        at org.apache.solr.search.SolrIndexSearcher.getDocListNC(SolrIndexSearcher.java:1660)\n        at org.apache.solr.search.SolrIndexSearcher.getDocListC(SolrIndexSearcher.java:1479)\n        at org.apache.solr.search.SolrIndexSearcher.search(SolrIndexSearcher.java:556)\n        at org.apache.solr.handler.component.QueryComponent.process(QueryComponent.java:518)\n        at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:222)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:143)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1984)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:829)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:446)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:220)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)\n        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:455)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)\n        at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:557)\n        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231)\n        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1075)\n        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:384)\n        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)\n        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1009)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)\n        at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:255)\n        at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:154)\n        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)\n        at org.eclipse.jetty.server.Server.handle(Server.java:368)\n        at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:489)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handleRequest(BlockingHttpConnection.java:53)\n        at org.eclipse.jetty.server.AbstractHttpConnection.headerComplete(AbstractHttpConnection.java:942)\n        at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete(AbstractHttpConnection.java:1004)\n        at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:640)\n        at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:72)\n        at org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:264)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543)\n        at java.lang.Thread.run(Thread.java:745)\n\n251184 [qtp1121454968-17] ERROR org.apache.solr.core.SolrCore  [   suggests] - java.lang.NullPointerException\n        at org.apache.solr.search.CollapsingQParserPlugin$IntScoreCollector.finish(CollapsingQParserPlugin.java:743)\n        at org.apache.solr.search.CollapsingQParserPlugin$IntScoreCollector.finish(CollapsingQParserPlugin.java:780)\n        at org.apache.solr.search.SolrIndexSearcher.buildAndRunCollectorChain(SolrIndexSearcher.java:203)\n        at org.apache.solr.search.SolrIndexSearcher.getDocListNC(SolrIndexSearcher.java:1660)\n        at org.apache.solr.search.SolrIndexSearcher.getDocListC(SolrIndexSearcher.java:1479)\n        at org.apache.solr.search.SolrIndexSearcher.search(SolrIndexSearcher.java:556)\n        at org.apache.solr.handler.component.QueryComponent.process(QueryComponent.java:518)\n        at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:222)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:143)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1984)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:829)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:446)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:220)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)\n        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:455)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)\n        at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:557)\n        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231)\n        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1075)\n        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:384)\n        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)\n        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1009)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)\n        at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:255)\n        at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:154)\n        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)\n        at org.eclipse.jetty.server.Server.handle(Server.java:368)\n        at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:489)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handleRequest(BlockingHttpConnection.java:53)\n        at org.eclipse.jetty.server.AbstractHttpConnection.headerComplete(AbstractHttpConnection.java:942)\n        at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete(AbstractHttpConnection.java:1004)\n        at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:640)\n        at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:72)\n        at org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:264)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543)\n        at java.lang.Thread.run(Thread.java:745)\n\n251184 [qtp1121454968-17] INFO  org.apache.solr.core.SolrCore.Request  [   suggests] - [suggests] webapp=/solr path=/select params={q=*:*&fq={!collapse+field%3Dquery_digest}&fq={!collapse+field%3Dresult_digest}} status=500 QTime=2 \n251185 [qtp1121454968-17] ERROR org.apache.solr.servlet.SolrDispatchFilter  [   suggests] - null:java.lang.NullPointerException\n        at org.apache.solr.search.CollapsingQParserPlugin$IntScoreCollector.finish(CollapsingQParserPlugin.java:743)\n        at org.apache.solr.search.CollapsingQParserPlugin$IntScoreCollector.finish(CollapsingQParserPlugin.java:780)\n        at org.apache.solr.search.SolrIndexSearcher.buildAndRunCollectorChain(SolrIndexSearcher.java:203)\n        at org.apache.solr.search.SolrIndexSearcher.getDocListNC(SolrIndexSearcher.java:1660)\n        at org.apache.solr.search.SolrIndexSearcher.getDocListC(SolrIndexSearcher.java:1479)\n        at org.apache.solr.search.SolrIndexSearcher.search(SolrIndexSearcher.java:556)\n        at org.apache.solr.handler.component.QueryComponent.process(QueryComponent.java:518)\n        at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:222)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:143)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1984)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:829)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:446)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:220)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)\n        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:455)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)\n        at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:557)\n        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231)\n        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1075)\n        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:384)\n        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)\n        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1009)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)\n        at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:255)\n        at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:154)\n        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)\n        at org.eclipse.jetty.server.Server.handle(Server.java:368)\n        at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:489)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handleRequest(BlockingHttpConnection.java:53)\n        at org.eclipse.jetty.server.AbstractHttpConnection.headerComplete(AbstractHttpConnection.java:942)\n        at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete(AbstractHttpConnection.java:1004)\n        at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:640)\n        at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:72)\n        at org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:264)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543)\n        at java.lang.Thread.run(Thread.java:745)\n\n251343 [qtp1121454968-17] ERROR org.apache.solr.core.SolrCore  [   suggests] - java.lang.NullPointerException\n\n251343 [qtp1121454968-17] INFO  org.apache.solr.core.SolrCore.Request  [   suggests] - [suggests] webapp=/solr path=/select params={q=*:*&fq={!collapse+field%3Dquery_digest}&fq={!collapse+field%3Dresult_digest}} status=500 QTime=3 \n251344 [qtp1121454968-17] ERROR org.apache.solr.servlet.SolrDispatchFilter  [   suggests] - null:java.lang.NullPointerException\n\n251501 [qtp1121454968-17] ERROR org.apache.solr.core.SolrCore  [   suggests] - java.lang.NullPointerException\n\n251502 [qtp1121454968-17] INFO  org.apache.solr.core.SolrCore.Request  [   suggests] - [suggests] webapp=/solr path=/select params={q=*:*&fq={!collapse+field%3Dquery_digest}&fq={!collapse+field%3Dresult_digest}} status=500 QTime=3 \n251502 [qtp1121454968-17] ERROR org.apache.solr.servlet.SolrDispatchFilter  [   suggests] - null:java.lang.NullPointerException\n\n251753 [qtp1121454968-17] ERROR org.apache.solr.core.SolrCore  [   suggests] - java.lang.NullPointerException\n\n251753 [qtp1121454968-17] INFO  org.apache.solr.core.SolrCore.Request  [   suggests] - [suggests] webapp=/solr path=/select params={q=*:*&fq={!collapse+field%3Dquery_digest}&fq={!collapse+field%3Dresult_digest}} status=500 QTime=2 \n251754 [qtp1121454968-17] ERROR org.apache.solr.servlet.SolrDispatchFilter  [   suggests] - null:java.lang.NullPointerException\n\n252250 [qtp1121454968-17] ERROR org.apache.solr.core.SolrCore  [   suggests] - java.lang.NullPointerException\n\n252250 [qtp1121454968-17] INFO  org.apache.solr.core.SolrCore.Request  [   suggests] - [suggests] webapp=/solr path=/select params={q=*:*&fq={!collapse+field%3Dquery_digest}&fq={!collapse+field%3Dresult_digest}} status=500 QTime=2 \n252250 [qtp1121454968-17] ERROR org.apache.solr.servlet.SolrDispatchFilter  [   suggests] - null:java.lang.NullPointerException\n\n252447 [qtp1121454968-17] ERROR org.apache.solr.core.SolrCore  [   suggests] - java.lang.NullPointerException\n\n252448 [qtp1121454968-17] INFO  org.apache.solr.core.SolrCore.Request  [   suggests] - [suggests] webapp=/solr path=/select params={q=*:*&fq={!collapse+field%3Dquery_digest}&fq={!collapse+field%3Dresult_digest}} status=500 QTime=2 \n252448 [qtp1121454968-17] ERROR org.apache.solr.servlet.SolrDispatchFilter  [   suggests] - null:java.lang.NullPointerException\n\n252587 [qtp1121454968-17] ERROR org.apache.solr.core.SolrCore  [   suggests] - java.lang.NullPointerException\n\n252588 [qtp1121454968-17] INFO  org.apache.solr.core.SolrCore.Request  [   suggests] - [suggests] webapp=/solr path=/select params={q=*:*&fq={!collapse+field%3Dquery_digest}&fq={!collapse+field%3Dresult_digest}} status=500 QTime=3 \n252588 [qtp1121454968-17] ERROR org.apache.solr.servlet.SolrDispatchFilter  [   suggests] - null:java.lang.NullPointerException",
    "attachments": {
        "solr-8983-console.log": "https://issues.apache.org/jira/secure/attachment/12730151/solr-8983-console.log"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2015-04-24T15:50:23+0000",
            "author": "Hoss Man",
            "content": "I'm having ahard time wrapping my head arround this.\n\ncan you provide some more details please?  \n\n\n\tdescription of solr setup? (single node? cluster? jvm version?)\n\tconfigs used?\n\tsteps to reproduce?\n\tdefinition of \"a short while\" ?\n\n ",
            "id": "comment-14511257"
        },
        {
            "date": "2015-05-04T10:25:37+0000",
            "author": "Markus Jelsma",
            "content": "Hello, this is a local Solr 5.1 running on:\n\njava version \"1.7.0_79\"\nOpenJDK Runtime Environment (IcedTea 2.5.5) (7u79-2.5.5-0ubuntu0.14.10.2)\nOpenJDK 64-Bit Server VM (build 24.79-b02, mixed mode)\n\nSee attached log. I fire a query that produces a NPE (see SOLR-7435). I repeat it a couple of times and then the stack trace is gone. ",
            "id": "comment-14526504"
        },
        {
            "date": "2015-05-04T20:55:46+0000",
            "author": "Hoss Man",
            "content": "Best guess, based on random googling since there's nothing in solr that i could think of to explain this, is that you are running into this HotSpot gotcha...\n\nhttp://jawspeak.com/2010/05/26/hotspot-caused-exceptions-to-lose-their-stack-traces-in-production-and-the-fix/\n\nhttps://stackoverflow.com/questions/2295015/log4j-not-printing-the-stacktrace-for-exceptions\n\nThe compiler in the server VM now provides correct stack backtraces for all \"cold\" built-in exceptions. For performance purposes, when such an exception is thrown a few times, the method may be recompiled. After recompilation, the compiler may choose a faster tactic using preallocated exceptions that do not provide a stack trace. To disable completely the use of preallocated exceptions, use this new flag: -XX:-OmitStackTraceInFastThrow. ",
            "id": "comment-14527279"
        },
        {
            "date": "2015-05-06T09:28:23+0000",
            "author": "Ramkumar Aiyengar",
            "content": "I remember encountering this quite a few months and being left completely puzzled, and gave up after trying stuff like digging into code for Exception classes. Hoss' links seem to explain this.\n\nFor a server at least this is really trippy behaviour and we should switch it off with the startup script. Imagine you having cloud trouble and you eventually resolving it. All exceptions thrown during the trouble will now be hot and any unrelated issues after the issue is past will be hard to debug.. ",
            "id": "comment-14530229"
        },
        {
            "date": "2015-05-06T10:57:14+0000",
            "author": "Markus Jelsma",
            "content": "I can confirm OmitStackTraceInFastThrow resolves the issue. This should indeed be part of the JVM flags for Solr instances. ",
            "id": "comment-14530333"
        },
        {
            "date": "2016-09-28T08:06:23+0000",
            "author": "ASF subversion and git services",
            "content": "Commit eba3939a046a41fdd2b172c47b19b442f95751cf in lucene-solr's branch refs/heads/master from Jan H\u00f8ydahl\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=eba3939 ]\n\nSOLR-7436: Solr stops printing stacktraces in log and output (add -XX:-OmitStackTraceInFastThrow to solr.in.{sh|cmd)) ",
            "id": "comment-15528803"
        },
        {
            "date": "2016-09-28T08:09:01+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 4ce1908a21c9210db16033e3a8740cb642695492 in lucene-solr's branch refs/heads/branch_6x from Jan H\u00f8ydahl\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=4ce1908 ]\n\nSOLR-7436: Solr stops printing stacktraces in log and output (add -XX:-OmitStackTraceInFastThrow to solr.in.{sh|cmd))\n\n(cherry picked from commit eba3939) ",
            "id": "comment-15528817"
        },
        {
            "date": "2016-09-28T08:10:21+0000",
            "author": "Jan H\u00f8ydahl",
            "content": "Added the -XX:-OmitStackTraceInFastThrow option to solr.in files ",
            "id": "comment-15528820"
        },
        {
            "date": "2016-11-09T08:38:12+0000",
            "author": "Shalin Shekhar Mangar",
            "content": "Closing after 6.3.0 release. ",
            "id": "comment-15650270"
        }
    ]
}