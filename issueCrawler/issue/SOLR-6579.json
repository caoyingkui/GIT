{
    "id": "SOLR-6579",
    "title": "SnapPuller Replication blocks clean shutdown of tomcat",
    "details": {
        "components": [
            "replication (java)"
        ],
        "type": "Bug",
        "labels": "",
        "fix_versions": [
            "4.10.4",
            "5.0",
            "6.0"
        ],
        "affect_versions": "4.10.1",
        "status": "Closed",
        "resolution": "Fixed",
        "priority": "Major"
    },
    "description": "main issue was described in the mailing list here:\nhttp://mail-archives.apache.org/mod_mbox/lucene-solr-user/201409.mbox/browser\nand \nhere:\n\nbut also including the quotes:\noriginal message from Nick\n\nHello,\nI have solr 4.10 running on tomcat 7. I'm doing replication from one master\nto about 10 slaves, with standard configuration:\n\n      <requestHandler name=\"/replication\" class=\"solr.ReplicationHandler\" >\n           <lst name=\"master\">\n             <str name=\"enable\">${enable.master:false}</str>\n             <str name=\"replicateAfter\">commit</str>\n             <str name=\"replicateAfter\">startup</str>\n             <str name=\"confFiles\">schema.xml,stopwords.txt</str>\n             <!-- str name=\"commitReserveDuration\">00:00:10</str -->\n           </lst>\n           <lst name=\"slave\">\n             <str name=\"enable\">${enable.slave:false}</str>\n             <str name=\"masterUrl\">http://master:8080/solr/mycore</str>\n             <str name=\"pollInterval\">00:00:60</str>\n           </lst>\n      </requestHandler>\n\n\nIt appears that if tomcat gets shutdown while solr is replicating, it\nprevents tomcat from shutting down fully. Immediately after receiving the\nshutdown command, a thread dump is logged into catalina.out (this may have\nbeen turned on by some configuration someone else on my team made). I\nremoved some threads that didn't look related, mostly about tomcat session\nreplication, or with names like \"http-bio-8080-exec-10\".\n\n\n    62252 [http-bio-8080-exec-1] INFO  org.apache.solr.core.SolrCore  \u2013\n[mycore] webapp=/solr path=/replication\nparams={command=details&_=1412014928648&wt=json} status=0 QTime=6\n    63310 [http-bio-8080-exec-1] INFO  org.apache.solr.core.SolrCore  \u2013\n[mycore] webapp=/solr path=/replication\nparams={command=details&_=1412014929699&wt=json} status=0 QTime=6\n    2014-09-29 14:22:10\n    Full thread dump Java HotSpot(TM) 64-Bit Server VM (24.65-b04 mixed\nmode):\n\n    \"fsyncService-12-thread-1\" prio=10 tid=0x00007f3bd4002000 nid=0x203d\nwaiting on condition [0x00007f3c271f0000]\n       java.lang.Thread.State: WAITING (parking)\n            at sun.misc.Unsafe.park(Native Method)\n            - parking to wait for  <0x00000007e1ff4458> (a\njava.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)\n            at\njava.util.concurrent.locks.LockSupport.park(LockSupport.java:186)\n            at\njava.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2043)\n            at\njava.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)\n            at\njava.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)\n            at\njava.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)\n            at\njava.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n            at java.lang.Thread.run(Thread.java:745)\n\n    \"explicit-fetchindex-cmd\" daemon prio=10 tid=0x00007f3c0413e800\nnid=0x203c runnable [0x00007f3c272f1000]\n       java.lang.Thread.State: RUNNABLE\n            at java.net.SocketInputStream.socketRead0(Native Method)\n            at java.net.SocketInputStream.read(SocketInputStream.java:152)\n            at java.net.SocketInputStream.read(SocketInputStream.java:122)\n            at\norg.apache.http.impl.io.AbstractSessionInputBuffer.read(AbstractSessionInputBuffer.java:198)\n            at\norg.apache.http.impl.io.ChunkedInputStream.read(ChunkedInputStream.java:174)\n            at\norg.apache.http.conn.EofSensorInputStream.read(EofSensorInputStream.java:137)\n            at\norg.apache.solr.common.util.FastInputStream.readWrappedStream(FastInputStream.java:80)\n            at\norg.apache.solr.common.util.FastInputStream.read(FastInputStream.java:114)\n            at\norg.apache.solr.common.util.FastInputStream.readFully(FastInputStream.java:152)\n            at\norg.apache.solr.handler.SnapPuller$DirectoryFileFetcher.fetchPackets(SnapPuller.java:1239)\n            at\norg.apache.solr.handler.SnapPuller$DirectoryFileFetcher.fetchFile(SnapPuller.java:1187)\n            at\norg.apache.solr.handler.SnapPuller.downloadIndexFiles(SnapPuller.java:774)\n            at\norg.apache.solr.handler.SnapPuller.fetchLatestIndex(SnapPuller.java:424)\n            at\norg.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:337)\n            at\norg.apache.solr.handler.ReplicationHandler$1.run(ReplicationHandler.java:227)\n\n    \"process reaper\" daemon prio=10 tid=0x00007f3c0409c000 nid=0x203b\nwaiting on condition [0x00007f3c984e9000]\n       java.lang.Thread.State: TIMED_WAITING (parking)\n            at sun.misc.Unsafe.park(Native Method)\n            - parking to wait for  <0x00000007dfbfd890> (a\njava.util.concurrent.SynchronousQueue$TransferStack)\n            at\njava.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)\n            at\njava.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)\n            at\njava.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:359)\n            at\njava.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:942)\n            at\njava.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)\n            at\njava.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)\n            at\njava.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n            at java.lang.Thread.run(Thread.java:745)\n\n    \"process reaper\" daemon prio=10 tid=0x00007f3c0409a000 nid=0x2039\nwaiting on condition [0x00007f3cac040000]\n       java.lang.Thread.State: TIMED_WAITING (parking)\n            at sun.misc.Unsafe.park(Native Method)\n            - parking to wait for  <0x00000007dfbfd890> (a\njava.util.concurrent.SynchronousQueue$TransferStack)\n            at\njava.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)\n            at\njava.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)\n            at\njava.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:359)\n            at\njava.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:942)\n            at\njava.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)\n            at\njava.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)\n            at\njava.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n            at java.lang.Thread.run(Thread.java:745)\n\n    \"ajp-bio-8009-AsyncTimeout\" daemon prio=10 tid=0x00007f3ce013c000\nnid=0x202e waiting on condition [0x00007f3c27af9000]\n       java.lang.Thread.State: TIMED_WAITING (sleeping)\n            at java.lang.Thread.sleep(Native Method)\n            at\norg.apache.tomcat.util.net.JIoEndpoint$AsyncTimeout.run(JIoEndpoint.java:148)\n            at java.lang.Thread.run(Thread.java:745)\n\n    \"ajp-bio-8009-Acceptor-0\" daemon prio=10 tid=0x00007f3ce013a800\nnid=0x202d runnable [0x00007f3c985ea000]\n       java.lang.Thread.State: RUNNABLE\n            at java.net.PlainSocketImpl.socketAccept(Native Method)\n            at\njava.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:398)\n            at java.net.ServerSocket.implAccept(ServerSocket.java:530)\n            at java.net.ServerSocket.accept(ServerSocket.java:498)\n            at\norg.apache.tomcat.util.net.DefaultServerSocketFactory.acceptSocket(DefaultServerSocketFactory.java:60)\n            at\norg.apache.tomcat.util.net.JIoEndpoint$Acceptor.run(JIoEndpoint.java:216)\n            at java.lang.Thread.run(Thread.java:745)\n\n    \"http-bio-8080-exec-1\" daemon prio=10 tid=0x00007f3c0c001800 nid=0x202c\nrunnable [0x00007f3c986eb000]\n       java.lang.Thread.State: RUNNABLE\n            at java.net.SocketInputStream.socketRead0(Native Method)\n            at java.net.SocketInputStream.read(SocketInputStream.java:152)\n            at java.net.SocketInputStream.read(SocketInputStream.java:122)\n            at\norg.apache.coyote.http11.InternalInputBuffer.fill(InternalInputBuffer.java:516)\n            at\norg.apache.coyote.http11.InternalInputBuffer.fill(InternalInputBuffer.java:501)\n            at\norg.apache.coyote.http11.Http11Processor.setRequestLineReadTimeout(Http11Processor.java:173)\n            at\norg.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:927)\n            at\norg.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:589)\n            at\norg.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:312)\n            - locked <0x00000007df0874b0> (a\norg.apache.tomcat.util.net.SocketWrapper)\n            at\njava.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n            at\njava.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n            at java.lang.Thread.run(Thread.java:745)\n\n    \"http-bio-8080-AsyncTimeout\" daemon prio=10 tid=0x00007f3ce0139000\nnid=0x202b waiting on condition [0x00007f3cac1aa000]\n       java.lang.Thread.State: TIMED_WAITING (sleeping)\n            at java.lang.Thread.sleep(Native Method)\n            at\norg.apache.tomcat.util.net.JIoEndpoint$AsyncTimeout.run(JIoEndpoint.java:148)\n            at java.lang.Thread.run(Thread.java:745)\n\n    \"http-bio-8080-Acceptor-0\" daemon prio=10 tid=0x00007f3ce0138000\nnid=0x202a runnable [0x00007f3cac2ab000]\n       java.lang.Thread.State: RUNNABLE\n            at java.net.PlainSocketImpl.socketAccept(Native Method)\n            at\njava.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:398)\n            at java.net.ServerSocket.implAccept(ServerSocket.java:530)\n            at java.net.ServerSocket.accept(ServerSocket.java:498)\n            at\norg.apache.tomcat.util.net.DefaultServerSocketFactory.acceptSocket(DefaultServerSocketFactory.java:60)\n            at\norg.apache.tomcat.util.net.JIoEndpoint$Acceptor.run(JIoEndpoint.java:216)\n            at java.lang.Thread.run(Thread.java:745)\n\n    \"ContainerBackgroundProcessor[StandardEngine[Catalina]]\" daemon prio=10\ntid=0x00007f3ce05b4000 nid=0x2029 waiting on condition [0x00007f3cacbb7000]\n       java.lang.Thread.State: TIMED_WAITING (sleeping)\n            at java.lang.Thread.sleep(Native Method)\n            at\norg.apache.catalina.core.ContainerBase$ContainerBackgroundProcessor.run(ContainerBase.java:1508)\n            at java.lang.Thread.run(Thread.java:745)\n\n    \"clock:10000\" daemon prio=10 tid=0x00007f3c5cafc000 nid=0x2028 in\nObject.wait() [0x00007f3c27bfa000]\n       java.lang.Thread.State: TIMED_WAITING (on object monitor)\n            at java.lang.Object.wait(Native Method)\n            - waiting on <0x00000007dc6cf7e8> (a\norg.webmacro.util.Clock$ClockThread)\n            at org.webmacro.util.Clock$ClockThread.run(Clock.java:108)\n            - locked <0x00000007dc6cf7e8> (a\norg.webmacro.util.Clock$ClockThread)\n\n    \"TimeLoop(1000,600)\" daemon prio=10 tid=0x00007f3c5cac6000 nid=0x2027\nwaiting on condition [0x00007f3c27cfb000]\n       java.lang.Thread.State: TIMED_WAITING (sleeping)\n            at java.lang.Thread.sleep(Native Method)\n            at\norg.webmacro.util.TimeLoop$TimeLoopThread.run(TimeLoop.java:237)\n\n    \"pool-1-thread-2\" daemon prio=10 tid=0x00007f3c5d1b3800 nid=0x2022\nwaiting on condition [0x00007f3c98246000]\n       java.lang.Thread.State: WAITING (parking)\n            at sun.misc.Unsafe.park(Native Method)\n            - parking to wait for  <0x000000070b90b4a0> (a\njava.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)\n            at\njava.util.concurrent.locks.LockSupport.park(LockSupport.java:186)\n            at\njava.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2043)\n            at\njava.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)\n            at\njava.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)\n            at\njava.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)\n            at\njava.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n            at java.lang.Thread.run(Thread.java:745)\n\n    \"Java2D Disposer\" daemon prio=10 tid=0x00007f3c5cfeb800 nid=0x2021 in\nObject.wait() [0x00007f3c9835d000]\n       java.lang.Thread.State: WAITING (on object monitor)\n            at java.lang.Object.wait(Native Method)\n            - waiting on <0x00000007e6030140> (a\njava.lang.ref.ReferenceQueue$Lock)\n            at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:135)\n            - locked <0x00000007e6030140> (a\njava.lang.ref.ReferenceQueue$Lock)\n            at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:151)\n            at sun.java2d.Disposer.run(Disposer.java:145)\n            at java.lang.Thread.run(Thread.java:745)\n\n    \"MySQL Statement Cancellation Timer\" daemon prio=10\ntid=0x00007f3c5ca0c000 nid=0x2020 in Object.wait() [0x00007f3c9845e000]\n       java.lang.Thread.State: WAITING (on object monitor)\n            at java.lang.Object.wait(Native Method)\n            - waiting on <0x00000007e5f45ad8> (a java.util.TaskQueue)\n            at java.lang.Object.wait(Object.java:503)\n            at java.util.TimerThread.mainLoop(Timer.java:526)\n            - locked <0x00000007e5f45ad8> (a java.util.TaskQueue)\n            at java.util.TimerThread.run(Timer.java:505)\n\n    \"Timer-0\" daemon prio=10 tid=0x00007f3c5c9f7800 nid=0x201f in\nObject.wait() [0x00007f3cad0bc000]\n       java.lang.Thread.State: WAITING (on object monitor)\n            at java.lang.Object.wait(Native Method)\n            - waiting on <0x00000007e605a8d8> (a java.util.TaskQueue)\n            at java.lang.Object.wait(Object.java:503)\n            at java.util.TimerThread.mainLoop(Timer.java:526)\n            - locked <0x00000007e605a8d8> (a java.util.TaskQueue)\n            at java.util.TimerThread.run(Timer.java:505)\n\n    \"Thread-5\" daemon prio=10 tid=0x00007f3c5c00f800 nid=0x201e in\nObject.wait() [0x00007f3cac3ac000]\n       java.lang.Thread.State: WAITING (on object monitor)\n            at java.lang.Object.wait(Native Method)\n            - waiting on <0x000000070b92b230> (a java.lang.Object)\n            at java.lang.Object.wait(Object.java:503)\n            at org.apache.solr.core.CloserThread.run(CoreContainer.java:905)\n            - locked <0x000000070b92b230> (a java.lang.Object)\n\n    \"snapPuller-10-thread-1\" prio=10 tid=0x00007f3c6c26e800 nid=0x201d\nwaiting on condition [0x00007f3cac555000]\n       java.lang.Thread.State: TIMED_WAITING (parking)\n            at sun.misc.Unsafe.park(Native Method)\n            - parking to wait for  <0x000000070b92b2a8> (a\njava.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)\n            at\njava.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:226)\n            at\njava.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2082)\n            at\njava.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:1090)\n            at\njava.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:807)\n            at\njava.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)\n            at\njava.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)\n            at\njava.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n            at java.lang.Thread.run(Thread.java:745)\n\n    \"searcherExecutor-6-thread-1\" prio=10 tid=0x00007f3c6c1ea000 nid=0x201c\nwaiting on condition [0x00007f3cac810000]\n       java.lang.Thread.State: WAITING (parking)\n            at sun.misc.Unsafe.park(Native Method)\n            - parking to wait for  <0x000000070b92b440> (a\njava.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)\n            at\njava.util.concurrent.locks.LockSupport.park(LockSupport.java:186)\n            at\njava.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2043)\n            at\njava.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)\n            at\njava.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1068)\n            at\njava.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)\n            at\njava.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n            at java.lang.Thread.run(Thread.java:745)\n\n    \"GC Daemon\" daemon prio=10 tid=0x00007f3ce0536000 nid=0x200d in\nObject.wait() [0x00007f3cd8137000]\n       java.lang.Thread.State: TIMED_WAITING (on object monitor)\n            at java.lang.Object.wait(Native Method)\n            - waiting on <0x000000070bbee5b0> (a sun.misc.GC$LatencyLock)\n            at sun.misc.GC$Daemon.run(GC.java:117)\n            - locked <0x000000070bbee5b0> (a sun.misc.GC$LatencyLock)\n\n    \"Service Thread\" daemon prio=10 tid=0x00007f3ce00a6000 nid=0x200b\nrunnable [0x0000000000000000]\n       java.lang.Thread.State: RUNNABLE\n\n    \"C2 CompilerThread1\" daemon prio=10 tid=0x00007f3ce00a4000 nid=0x200a\nwaiting on condition [0x0000000000000000]\n       java.lang.Thread.State: RUNNABLE\n\n    \"C2 CompilerThread0\" daemon prio=10 tid=0x00007f3ce00a1000 nid=0x2009\nwaiting on condition [0x0000000000000000]\n       java.lang.Thread.State: RUNNABLE\n\n    \"Signal Dispatcher\" daemon prio=10 tid=0x00007f3ce009f800 nid=0x2008\nwaiting on condition [0x0000000000000000]\n       java.lang.Thread.State: RUNNABLE\n\n    \"Finalizer\" daemon prio=10 tid=0x00007f3ce0077800 nid=0x2007 in\nObject.wait() [0x00007f3cd8c1b000]\n       java.lang.Thread.State: WAITING (on object monitor)\n            at java.lang.Object.wait(Native Method)\n            - waiting on <0x000000070bbee828> (a\njava.lang.ref.ReferenceQueue$Lock)\n            at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:135)\n            - locked <0x000000070bbee828> (a\njava.lang.ref.ReferenceQueue$Lock)\n            at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:151)\n            at\njava.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:209)\n\n    \"Reference Handler\" daemon prio=10 tid=0x00007f3ce0075800 nid=0x2006 in\nObject.wait() [0x00007f3cadffe000]\n       java.lang.Thread.State: WAITING (on object monitor)\n            at java.lang.Object.wait(Native Method)\n            - waiting on <0x000000070b8b23b8> (a\njava.lang.ref.Reference$Lock)\n            at java.lang.Object.wait(Object.java:503)\n            at\njava.lang.ref.Reference$ReferenceHandler.run(Reference.java:133)\n            - locked <0x000000070b8b23b8> (a java.lang.ref.Reference$Lock)\n\n    \"main\" prio=10 tid=0x00007f3ce0009000 nid=0x1ffc runnable\n[0x00007f3ce675c000]\n       java.lang.Thread.State: RUNNABLE\n            at java.net.PlainSocketImpl.socketAccept(Native Method)\n            at\njava.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:398)\n            at java.net.ServerSocket.implAccept(ServerSocket.java:530)\n            at java.net.ServerSocket.accept(ServerSocket.java:498)\n            at\norg.apache.catalina.core.StandardServer.await(StandardServer.java:452)\n            at org.apache.catalina.startup.Catalina.await(Catalina.java:766)\n            at org.apache.catalina.startup.Catalina.start(Catalina.java:712)\n            at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n            at\nsun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n            at\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n            at java.lang.reflect.Method.invoke(Method.java:606)\n            at\norg.apache.catalina.startup.Bootstrap.start(Bootstrap.java:322)\n            at\norg.apache.catalina.startup.Bootstrap.main(Bootstrap.java:456)\n\n    JNI global references: 422\n\n    Heap\n     PSYoungGen      total 1184256K, used 1031985K [0x00000007aaa80000,\n0x0000000800000000, 0x0000000800000000)\n      eden space 970240K, 94% used\n[0x00000007aaa80000,0x00000007e259e740,0x00000007e5e00000)\n      from space 214016K, 55% used\n[0x00000007e5e00000,0x00000007ed2adfd0,0x00000007f2f00000)\n      to   space 212480K, 0% used\n[0x00000007f3080000,0x00000007f3080000,0x0000000800000000)\n     ParOldGen       total 1398272K, used 209681K [0x0000000700000000,\n0x0000000755580000, 0x00000007aaa80000)\n      object space 1398272K, 14% used\n[0x0000000700000000,0x000000070ccc4700,0x0000000755580000)\n     PSPermGen       total 78848K, used 78659K [0x00000006c0000000,\n0x00000006c4d00000, 0x0000000700000000)\n      object space 78848K, 99% used\n[0x00000006c0000000,0x00000006c4cd0ca8,0x00000006c4d00000)\n\nright after this, here comes the shutdown:\n\n    Sep 29, 2014 2:22:10 PM org.apache.catalina.core.StandardServer await\n    INFO: A valid shutdown command was received via the shutdown port.\nStopping the Server instance.\n    Sep 29, 2014 2:22:10 PM org.apache.coyote.AbstractProtocol pause\n    INFO: Pausing ProtocolHandler [\"http-bio-8080\"]\n    Sep 29, 2014 2:22:10 PM org.apache.coyote.AbstractProtocol pause\n    INFO: Pausing ProtocolHandler [\"ajp-bio-8009\"]\n    Sep 29, 2014 2:22:11 PM org.apache.catalina.core.StandardService\nstopInternal\n    INFO: Stopping service Catalina\n    Sep 29, 2014 2:22:11 PM\norg.apache.catalina.ha.session.JvmRouteBinderValve stopInternal\n    INFO: JvmRouteBinderValve stopped\n    Sep 29, 2014 2:22:11 PM org.apache.catalina.ha.session.DeltaManager\nstopInternal\n    INFO: Manager [localhost#/dy] expiring sessions upon shutdown\n\n(snip some stuff about an unrelated webapp, then the solr errors)\n\n    64876 [localhost-startStop-2] INFO  org.apache.solr.core.CoreContainer\n \u2013 Shutting down CoreContainer instance=1359815787\n    64877 [localhost-startStop-2] INFO  org.apache.solr.core.SolrCore  \u2013\n[mycore]  CLOSING SolrCore org.apache.solr.core.SolrCore@1ade5d50\n    64882 [localhost-startStop-2] INFO\n org.apache.solr.update.UpdateHandler  \u2013 closing\nDirectUpdateHandler2{commits=0,autocommit\nmaxTime=15000ms,autocommits=0,soft\nautocommits=0,optimizes=0,rollbacks=0,expungeDeletes=0,docsPending=0,adds=0,deletesById=0,deletesByQuery=0,errors=0,cumulative_adds=0,cumulative_deletesById=0,cumulative_deletesByQuery=0,cumulative_errors=0,transaction_logs_total_size=0,transaction_logs_total_number=0}\n    64883 [localhost-startStop-2] INFO\n org.apache.solr.update.SolrCoreState  \u2013 Closing SolrCoreState\n    64883 [localhost-startStop-2] INFO\n org.apache.solr.update.DefaultSolrCoreState  \u2013 SolrCoreState ref count has\nreached 0 - closing IndexWriter\n    64883 [localhost-startStop-2] INFO\n org.apache.solr.update.DefaultSolrCoreState  \u2013 closing IndexWriter with\nIndexWriterCloser\n    64885 [localhost-startStop-2] ERROR\norg.apache.solr.update.DefaultSolrCoreState  \u2013 Error during shutdown of\nwriter.\n    org.apache.lucene.store.AlreadyClosedException: this IndexWriter is\nclosed\n            at\norg.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:700)\n            at\norg.apache.lucene.index.IndexWriter.waitForMerges(IndexWriter.java:2384)\n            at\norg.apache.solr.update.DirectUpdateHandler2.closeWriter(DirectUpdateHandler2.java:795)\n            at\norg.apache.solr.update.DefaultSolrCoreState.closeIndexWriter(DefaultSolrCoreState.java:70)\n            at\norg.apache.solr.update.DefaultSolrCoreState.close(DefaultSolrCoreState.java:371)\n            at\norg.apache.solr.update.SolrCoreState.decrefSolrCoreState(SolrCoreState.java:72)\n            at org.apache.solr.core.SolrCore.close(SolrCore.java:1073)\n            at org.apache.solr.core.SolrCores.close(SolrCores.java:117)\n            at\norg.apache.solr.core.CoreContainer.shutdown(CoreContainer.java:347)\n            at\norg.apache.solr.servlet.SolrDispatchFilter.destroy(SolrDispatchFilter.java:200)\n            at\norg.apache.catalina.core.ApplicationFilterConfig.release(ApplicationFilterConfig.java:315)\n            at\norg.apache.catalina.core.StandardContext.filterStop(StandardContext.java:4782)\n            at\norg.apache.catalina.core.StandardContext.stopInternal(StandardContext.java:5565)\n            at\norg.apache.catalina.util.LifecycleBase.stop(LifecycleBase.java:232)\n            at\norg.apache.catalina.core.ContainerBase$StopChild.call(ContainerBase.java:1575)\n            at\norg.apache.catalina.core.ContainerBase$StopChild.call(ContainerBase.java:1564)\n            at java.util.concurrent.FutureTask.run(FutureTask.java:262)\n            at\njava.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n            at\njava.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n            at java.lang.Thread.run(Thread.java:745)\n    2014-09-29T14:22:11.384-0400: [GC 1299401K->384944K(2543104K),\n0.0427280 secs]\n    64929 [localhost-startStop-2] INFO  org.apache.solr.core.SolrCore  \u2013\n[mycore] Closing main searcher on request.\n    64935 [localhost-startStop-2] INFO\n org.apache.solr.core.CachingDirectoryFactory  \u2013 Closing\nNRTCachingDirectoryFactory - 3 directories currently being tracked\n    69937 [explicit-fetchindex-cmd] INFO\n org.apache.solr.update.DefaultSolrCoreState  \u2013 Creating new IndexWriter...\n    69938 [explicit-fetchindex-cmd] ERROR\norg.apache.solr.handler.ReplicationHandler  \u2013 SnapPull failed\n:org.apache.lucene.store.AlreadyClosedException: Already closed\n            at\norg.apache.solr.core.CachingDirectoryFactory.get(CachingDirectoryFactory.java:341)\n            at\norg.apache.solr.handler.ReplicationHandler.loadReplicationProperties(ReplicationHandler.java:827)\n            at\norg.apache.solr.handler.SnapPuller.logReplicationTimeAndConfFiles(SnapPuller.java:569)\n            at\norg.apache.solr.handler.SnapPuller.fetchLatestIndex(SnapPuller.java:511)\n            at\norg.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:337)\n            at\norg.apache.solr.handler.ReplicationHandler$1.run(ReplicationHandler.java:227)\n\n    69942 [localhost-startStop-2] INFO\n org.apache.solr.core.CachingDirectoryFactory  \u2013 looking to close\n/usr/local/apache-tomcat-7.0.39/solr/mycore/data\n[CachedDir<<refCount=0;path=/usr/local/apache-tomcat-7.0.39/solr/mycore/data;done=false>>]\n    69942 [localhost-startStop-2] INFO\n org.apache.solr.core.CachingDirectoryFactory  \u2013 Closing directory:\n/usr/local/apache-tomcat-7.0.39/solr/mycore/data\n    69942 [localhost-startStop-2] INFO\n org.apache.solr.core.CachingDirectoryFactory  \u2013 looking to close\n/usr/local/apache-tomcat-7.0.39/solr/mycore/data/index\n[CachedDir<<refCount=0;path=/usr/local/apache-tomcat-7.0.39/solr/mycore/data/index;done=false>>]\n    69942 [localhost-startStop-2] INFO\n org.apache.solr.core.CachingDirectoryFactory  \u2013 Closing directory:\n/usr/local/apache-tomcat-7.0.39/solr/mycore/data/index\n    69942 [localhost-startStop-2] INFO\n org.apache.solr.core.CachingDirectoryFactory  \u2013 looking to close\n/usr/local/apache-tomcat-7.0.39/solr/mycore/data/index.20140929142203447\n[CachedDir<<refCount=0;path=/usr/local/apache-tomcat-7.0.39/solr/mycore/data/index.20140929142203447;done=true>>]\n    69942 [localhost-startStop-2] INFO\n org.apache.solr.core.CachingDirectoryFactory  \u2013 Closing directory:\n/usr/local/apache-tomcat-7.0.39/solr/mycore/data/index.20140929142203447\n    69943 [localhost-startStop-2] INFO\n org.apache.solr.core.CachingDirectoryFactory  \u2013 Removing directory before\ncore close:\n/usr/local/apache-tomcat-7.0.39/solr/mycore/data/index.20140929142203447\n    Sep 29, 2014 2:22:16 PM org.apache.catalina.ha.session.DeltaManager\nstopInternal\n    INFO: Manager [localhost#/solr] expiring sessions upon shutdown\n    Sep 29, 2014 2:22:16 PM org.apache.catalina.loader.WebappClassLoader\nclearReferencesThreads\n    SEVERE: The web application [/solr] appears to have started a thread\nnamed [fsyncService-12-thread-1] but has failed to stop it. This is very\nlikely to create a memory leak.\n    Sep 29, 2014 2:22:16 PM org.apache.catalina.loader.WebappClassLoader\ncheckThreadLocalMapForLeaks\n    SEVERE: The web application [/solr] created a ThreadLocal with key of\ntype [org.apache.solr.schema.DateField.ThreadLocalDateFormat] (value\n[org.apache.solr.schema.DateField$ThreadLocalDateFormat@66271f62]) and a\nvalue of type [org.apache.solr.schema.DateField.ISO8601CanonicalDateFormat]\n(value [org.apache.solr.schema.DateField$ISO8601CanonicalDateFormat@6b2ed43a])\nbut failed to remove it when the web application was stopped. Threads are\ngoing to be renewed over time to try and avoid a probable memory leak.\n    Sep 29, 2014 2:22:16 PM org.apache.coyote.AbstractProtocol stop\n    INFO: Stopping ProtocolHandler [\"http-bio-8080\"]\n    Sep 29, 2014 2:22:16 PM org.apache.coyote.AbstractProtocol stop\n    INFO: Stopping ProtocolHandler [\"ajp-bio-8009\"]\n    Sep 29, 2014 2:22:16 PM org.apache.coyote.AbstractProtocol destroy\n    INFO: Destroying ProtocolHandler [\"http-bio-8080\"]\n    Sep 29, 2014 2:22:16 PM org.apache.coyote.AbstractProtocol destroy\n    INFO: Destroying ProtocolHandler [\"ajp-bio-8009\"]\n\n\nAt this point it looks like tomcat has shutdown, but the process is still\nrunning, as checked by ps. If I start a new tomcat and repeat this process\na few times, we end up with several zombie instances of tomcat running.\n\nIs this designed behavior? What is supposed to happen when the container is\nshutdown while replication is running? How are others handling this?\n\nPlease let me know if I can provide any more information.\n\nThanks in advance,\nNick\n\n\nMy followup\n\nI was helping to look into this with Nick & I think we may have figured out the core of the problem...\n\nThe problem is easily reproducible by starting replication on the slave and then sending a shutdown command to tomcat (e.g. catalina.sh stop).\n\nWith a debugger attached, it looks like the fsyncService thread is blocking VM shutdown because it is created as a non-daemon thread.\n\nEssentially what seems to be happening is that the fsyncService thread is running when 'catalina.sh stop' is executed. This goes in and calls SnapPuller.destroy() which aborts the current sync. Around line 517 of the SnapPuller, there is code that is supposed to cleanup the fsyncService thread, but I don't think it is getting executed because the thread that called SnapPuller.fetchLatestIndex() is configured as a daemon Thread, so the JVM ends up shutting that down before it can cleanup the fysncService...\n\nSo... it seems like:\n\n    if (fsyncService != null) \nExecutorUtil.shutdownNowAndAwaitTermination(fsyncService);\n\n\ncould be added around line 1706 of SnapPuller.java,  or\n\n           // since otherwise the JVM may kill the thread before any cleanup\n           // code can be called\n          puller.setDaemon(false);\n\n\ncould be added around line 230 of ReplicationHandler.java, however this needs some additional work (and I think it might need to be added regardless) since the cleanup code in SnapPuller(around 517) that shuts down the fsync thread never gets execute since logReplicationTimeAndConfFiles() can throw IO exceptions bypassing the rest of the finally block...So the call to \n\nlogReplicationTimeAndConfFiles()\n\n around line 512 would need to get wrapped with a try/catch block to catch the IO exception...\n\nI will attach a patch as well that I believe fixes the issues. Is there a reason to not perform a hard shutdown of the fysnc thread? It seems sane enough to me to do a hard shutdown of the fsyncService if the action is aborted...",
    "attachments": {
        "cleanupSnapPullerFinally.patch": "https://issues.apache.org/jira/secure/attachment/12672549/cleanupSnapPullerFinally.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2014-10-28T15:55:39+0000",
            "author": "Philip Black-Knight",
            "content": "Just curious if there were any plans to pull in my patch for the next release or if there is anything else I can do to move this along.... ",
            "id": "comment-14186990"
        },
        {
            "date": "2014-11-10T14:51:56+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 1637879 from Noble Paul in branch 'dev/trunk'\n[ https://svn.apache.org/r1637879 ]\n\nSOLR-6579 SnapPuller Replication blocks clean shutdown of tomcat ",
            "id": "comment-14204842"
        },
        {
            "date": "2014-11-10T14:57:14+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 1637881 from Noble Paul in branch 'dev/branches/branch_5x'\n[ https://svn.apache.org/r1637881 ]\n\nSOLR-6579 SnapPuller Replication blocks clean shutdown of tomcat ",
            "id": "comment-14204852"
        },
        {
            "date": "2015-02-23T05:01:18+0000",
            "author": "Anshum Gupta",
            "content": "Bulk close after 5.0 release. ",
            "id": "comment-14332680"
        },
        {
            "date": "2015-02-26T12:12:41+0000",
            "author": "Shalin Shekhar Mangar",
            "content": "Reopening to backport to 4.10.4 ",
            "id": "comment-14338304"
        },
        {
            "date": "2015-02-26T12:14:16+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 1662430 from shalin@apache.org in branch 'dev/branches/lucene_solr_4_10'\n[ https://svn.apache.org/r1662430 ]\n\nSOLR-6579: SnapPuller Replication blocks clean shutdown of tomcat ",
            "id": "comment-14338307"
        },
        {
            "date": "2015-03-05T15:36:28+0000",
            "author": "Michael McCandless",
            "content": "Bulk close for 4.10.4 release ",
            "id": "comment-14348911"
        }
    ]
}