{
    "id": "LUCENE-7016",
    "title": "Solr/Lucene 5.4.1: FastVectorHighlighter still fails with StringIndexOutOfBoundsException",
    "details": {
        "resolution": "Unresolved",
        "affect_versions": "5.4.1",
        "components": [
            "modules/highlighter"
        ],
        "labels": "",
        "fix_versions": [],
        "priority": "Minor",
        "status": "Open",
        "type": "Bug"
    },
    "description": "I have reported issues with highlighting of EdgeNGram fields in SOLR-7926. \n\nAs a workaround I now try to use an NGramField and the FastVectorHighlighter, but I often hit the FastVectorHighlighter StringIndexOutOfBoundsException-issue.\n\nNote that I use luceneMatchVersion=\"4.3\". Without this, the whole term is highlighted, not just the search-term, as I reported in SOLR-7926.\n\nAny help with this would be highly appreciated! (Or tips on how otherwise to achieve proper highlighting of EdgeNGram and NGram-fields.)\n\nThe issue can easily be reproduced by following these steps: \n\nDownload and start Solr 5.4.1, create a core:\n-------------------------------------------------------------\n$ wget http://apache.uib.no/lucene/solr/5.4.1/solr-5.4.1.tgz\n$ tar xvf solr-5.4.1.tgz\n$ cd solr-5.4.1\n$ bin/solr start -f \n$ bin/solr create_core -c test -d server/solr/configsets/basic_configs\n(in a second terminal window)\n\n\nAdd dynamic field and fieldtype to server/solr/test/conf/schema.xml:\n-----------------------------------------------------------------------------------------\n\n    <dynamicField name=\"*_ngram\" type=\"text_ngram\" indexed=\"true\"  stored=\"true\" termVectors=\"true\" termPositions=\"true\" termOffsets=\"true\"/>\n\n\t<fieldType name=\"text_ngram\" class=\"solr.TextField\">\n \t\t<analyzer type=\"index\">\n\t\t\t<tokenizer class=\"solr.WhitespaceTokenizerFactory\"/>\n\t\t\t<filter class=\"solr.LowerCaseFilterFactory\"/>\n\t\t\t<filter class=\"solr.NGramFilterFactory\" minGramSize=\"1\" maxGramSize=\"20\" luceneMatchVersion=\"4.3\"/>\n\t\t</analyzer>\n\t\t<analyzer type=\"query\">\n\t\t\t<tokenizer class=\"solr.StandardTokenizerFactory\"/>\n\t\t\t<filter class=\"solr.LowerCaseFilterFactory\"/>\n\t\t</analyzer>\n\t</fieldType>\n\nReplace existing /select requestHandler in server/solr/test/conf/solrconfig.xml with:\n-------------------------------------------------------------------------------------\n    <requestHandler name=\"/select\" class=\"solr.SearchHandler\">\n       <lst name=\"defaults\">\n         <str name=\"echoParams\">explicit</str>\n         <int name=\"rows\">10</int>\n         <str name=\"df\">name_ngram</str>\n         <str name=\"mm\">100%</str>\n         <str name=\"defType\">edismax</str>\n\n         <str name=\"qf\">\n              name_ngram\n         </str>\n\n         <str name=\"fl\">*</str>\n         <str name=\"hl\">true</str>\n         <str name=\"hl.fl\">name_ngram </str>\n         <str name=\"hl.useFastVectorHighlighter\">true</str>\n       </lst>\n\n      </requestHandler>\n\nStop and restart Solr\n-----------------------      \n\nCreate and index this document: \n------------------------------      \n$ more doc.xml \n<add>\n  <doc>\n    <field name=\"id\">1</field>\n    <field name=\"name_ngram\">Jan-Ole Pedersen</field>\n  </doc>\n</add>\n\n$ bin/post -c test doc.xml \n\nExecute search: \n\n$ curl \"http://localhost:8983/solr/test/select?q=jan+ol&wt=json&indent=true\"\n{\n  \"responseHeader\":{\n    \"status\":500,\n    \"QTime\":3,\n    \"params\":{\n      \"q\":\"jan ol\",\n      \"indent\":\"true\",\n      \"wt\":\"json\"}},\n  \"response\":{\"numFound\":1,\"start\":0,\"docs\":[\n      \n{\n        \"id\":\"1\",\n        \"name_ngram\":\"Jan-Ole Pedersen\",\n        \"_version_\":1525256012582354944}\n]\n  },\n  \"error\":\n{\n    \"msg\":\"String index out of range: -6\",\n    \"trace\":\"java.lang.StringIndexOutOfBoundsException: String index out of range: -6\\n\\tat java.lang.String.substring(String.java:1954)\\n\\tat org.apache.lucene.search.vectorhighlight.BaseFragmentsBuilder.makeFragment(BaseFragmentsBuilder.java:180)\\n\\tat org.apache.lucene.search.vectorhighlight.BaseFragmentsBuilder.createFragments(BaseFragmentsBuilder.java:145)\\n\\tat org.apache.lucene.search.vectorhighlight.FastVectorHighlighter.getBestFragments(FastVectorHighlighter.java:187)\\n\\tat org.apache.solr.highlight.DefaultSolrHighlighter.doHighlightingByFastVectorHighlighter(DefaultSolrHighlighter.java:479)\\n\\tat org.apache.solr.highlight.DefaultSolrHighlighter.doHighlighting(DefaultSolrHighlighter.java:426)\\n\\tat org.apache.solr.handler.component.HighlightComponent.process(HighlightComponent.java:143)\\n\\tat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:273)\\n\\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:156)\\n\\tat org.apache.solr.core.SolrCore.execute(SolrCore.java:2073)\\n\\tat org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:658)\\n\\tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:457)\\n\\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:223)\\n\\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:181)\\n\\tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\\n\\tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:585)\\n\\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\\n\\tat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:577)\\n\\tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:223)\\n\\tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1127)\\n\\tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:515)\\n\\tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\\n\\tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1061)\\n\\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\\n\\tat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:215)\\n\\tat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:110)\\n\\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97)\\n\\tat org.eclipse.jetty.server.Server.handle(Server.java:499)\\n\\tat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:310)\\n\\tat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:257)\\n\\tat org.eclipse.jetty.io.AbstractConnection$2.run(AbstractConnection.java:540)\\n\\tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:635)\\n\\tat org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:555)\\n\\tat java.lang.Thread.run(Thread.java:745)\\n\",\n    \"code\":500}\n    }",
    "attachments": {
        "SOLR-4137.patch": "https://issues.apache.org/jira/secure/attachment/12794002/SOLR-4137.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "id": "comment-15138959",
            "author": "Bj\u00f8rn Hjelle",
            "date": "2016-02-09T13:51:35+0000",
            "content": "I just found out that by using the StandardTokenizerFactory instead of the WhitespaceTokenizerFactory, the exception is not raised. I will set the priority to minor as this is not an issue for me now.\n\nThe exception is still raised when using the WhitespaceTokenizerFactory (on both the index and query side), so I will leave the issue open.  "
        },
        {
            "id": "comment-15195502",
            "author": "Bj\u00f8rn Hjelle",
            "date": "2016-03-15T15:39:52+0000",
            "content": "Unfortunately I have come across another example where this error occurs, with the StandardTokenizerFactory this time. Steps to reproduce with Solr 5.5.0: \n\nDownload and start Solr 5.5.0, create a core:\n-------------------------------------------------------------\n$ wget http://apache.uib.no/lucene/solr/5.5.0/solr-5.5.0.tgz\n$ tar xvf solr-5.5.0.tgz\n$ cd solr-5.5.0\n$ bin/solr start -f \n$ bin/solr create_core -c test -d server/solr/configsets/basic_configs\n(in a second terminal window)\n\n\nAdd a fieldtype and a dynamic field:\n--------------------------------------------------\n$ curl -X POST -H 'Content-type:application/json' --data-binary '{\n  \"add-field-type\":{\n     \"name\":\"text_ngram\",\n     \"class\":\"solr.TextField\",\n     \"indexAnalyzer\":{\n        \"tokenizer\":\n{\n           \"class\":\"solr.StandardTokenizerFactory\" }\n,\n        \"filters\":[\n             \n{\"class\":\"solr.LowerCaseFilterFactory\"}\n,\n             \n{\"class\":\"solr.NGramFilterFactory\",\n              \"minGramSize\":\"1\", \"maxGramSize\":\"20\", \"luceneMatchVersion\":\"4.3\"}\n]},\n     \"queryAnalyzer\":{\n        \"tokenizer\":\n{ \n           \"class\":\"solr.StandardTokenizerFactory\" }\n,\n        \"filters\":[\n             \n{\"class\":\"solr.LowerCaseFilterFactory\"}\n]}}\n}' http://localhost:8983/solr/test/schema\n\n$ curl -X POST -H 'Content-type:application/json' --data-binary '{\n  \"add-dynamic-field\":\n{\n     \"name\":\"*_ngram\",\n     \"type\":\"text_ngram\",\n     \"stored\":true, \"indexed\":true, \"termVectors\":true, \"termPositions\":true, \"termOffsets\":true }\n}' http://localhost:8983/solr/test/schema\n\n\nIndex this document, post a commit: \n-----------------------------------\n\n$ curl http://localhost:8983/solr/test/update/json -H 'Content-type:application/json' -d '[\n{\"id\" : \"1\", \"name_ngram\" : \"arne.berg\"}\n]'\n\n$ curl \"http://localhost:8983/solr/test/update?commit=true\"\n\n\nPerform a search to get the StringIndexOutOfBoundsException:\n\n$ curl \"http://localhost:8983/solr/test/select?q=name_ngram:(arne+b)&wt=json&indent=true&hl=true&hl.fl=name_ngram&hl.useFastVectorHighlighter=true\"\n{\n  \"responseHeader\":{\n    \"status\":500,\n    \"QTime\":2,\n    \"params\":{\n      \"q\":\"name_ngram:(arne b)\",\n      \"hl.useFastVectorHighlighter\":\"true\",\n      \"hl\":\"true\",\n      \"indent\":\"true\",\n      \"hl.fl\":\"name_ngram\",\n      \"wt\":\"json\"}},\n  \"response\":{\"numFound\":1,\"start\":0,\"docs\":[\n      \n{\n        \"id\":\"1\",\n        \"name_ngram\":\"arne.berg\",\n        \"_version_\":1528882472730755072}\n]\n  },\n  \"error\":{\n    \"msg\":\"String index out of range: -6\",\n    \"trace\":\"java.lang.StringIndexOutOfBoundsException: String index out of range: -6\\n\\tat java.lang.String.substring(String.java:1954)\\n\\tat org.apache.lucene.search.vectorhighlight.BaseFragmentsBuilder.makeFragment(BaseFragmentsBuilder.java:179)\\n\\tat org.apache.lucene.search.vectorhighlight.BaseFragmentsBuilder.createFragments(BaseFragmentsBuilder.java:144)\\n\\tat org.apache.lucene.search.vectorhighlight.FastVectorHighlighter.getBestFragments(FastVectorHighlighter.java:186)\\n\\tat org.apache.solr.highlight.DefaultSolrHighlighter.doHighlightingByFastVectorHighlighter(DefaultSolrHighlighter.java:479)\\n\\tat org.apache.solr.highlight.DefaultSolrHighlighter.doHighlighting(DefaultSolrHighlighter.java:426)\\n\\tat org.apache.solr.handler.component.HighlightComponent.process(HighlightComponent.java:142)\\n\\tat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:272)\\n\\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:155)\\n\\tat org.apache.solr.core.SolrCore.execute(SolrCore.java:2082)\\n\\tat org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:670)\\n\\tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:458)\\n\\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:225)\\n\\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:183)\\n\\tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\\n\\tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:585)\\n\\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\\n\\tat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:577)\\n\\tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:223)\\n\\tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1127)\\n\\tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:515)\\n\\tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\\n\\tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1061)\\n\\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\\n\\tat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:215)\\n\\tat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:110)\\n\\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97)\\n\\tat org.eclipse.jetty.server.Server.handle(Server.java:499)\\n\\tat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:310)\\n\\tat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:257)\\n\\tat org.eclipse.jetty.io.AbstractConnection$2.run(AbstractConnection.java:540)\\n\\tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:635)\\n\\tat org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:555)\\n\\tat java.lang.Thread.run(Thread.java:745)\\n\",\n    \"code\":500}}\n\n\nAs a side note, with the standard highlighter this is what gets highlighted: \n\n  \"highlighting\":{\n    \"1\":\n{\n      \"name_ngram\":[\"arne.<em>b</em>er<em>arne</em>g\"]}\n}}\n\n\nAs before, without specifying luceneMatchVersion \"4.3\", the whole term gets highlighted: \n\n  \"highlighting\":{\n    \"1\":\n{\n      \"name_ngram\":[\"<em>arne.berg</em>\"]}\n}} "
        },
        {
            "id": "comment-15199484",
            "author": "Markus Jelsma",
            "date": "2016-03-17T13:11:07+0000",
            "content": "See SOLR-4137, it was never fully resolved. It has a patch that solves this problem. "
        },
        {
            "id": "comment-15199654",
            "author": "Bj\u00f8rn Hjelle",
            "date": "2016-03-17T14:53:50+0000",
            "content": "Markus, \nyes, I have seen that, but if I read it correctly that patch should have been incorporated into Solr 4.3. \nSome time ago, I had a look at the current source code for BaseFragmentsBuilder.java, and it has changed compared to what is included in SOLR-4137. So, I am not sure that applying that patch to the current version of Solr is a good solution.\n\nThanks anyway! "
        },
        {
            "id": "comment-15199740",
            "author": "Markus Jelsma",
            "date": "2016-03-17T15:41:23+0000",
            "content": "Here's a modified patch. It was never incorporated in Lucene. It applies to 5.5. "
        },
        {
            "id": "comment-15201399",
            "author": "Bj\u00f8rn Hjelle",
            "date": "2016-03-18T12:29:23+0000",
            "content": "Where is the patch? Should there be a link?\n\nThanks, \nBj\u00f8rn "
        },
        {
            "id": "comment-15202237",
            "author": "Erick Erickson",
            "date": "2016-03-18T21:55:16+0000",
            "content": "It's attached, underneath the description. The fact that the description is quite long makes it harder to find... "
        },
        {
            "id": "comment-15202662",
            "author": "Bj\u00f8rn Hjelle",
            "date": "2016-03-19T08:43:27+0000",
            "content": "Thanks! Found it, will report back as soon as I have been able to test it.  "
        },
        {
            "id": "comment-15203999",
            "author": "Bj\u00f8rn Hjelle",
            "date": "2016-03-21T10:33:40+0000",
            "content": "I have now tested the patch and the exception is not thrown anymore, but the highlighting is not quite right. Using the same example as posted above: \n\n$ curl \"http://localhost:8983/solr/test/select?q=name_ngram:(arne+b)&wt=json&indent=true&hl=true&hl.fl=name_ngram&hl.useFastVectorHighlighter=true\"\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":1,\n    \"params\":{\n      \"q\":\"name_ngram:(arne b)\",\n      \"hl.useFastVectorHighlighter\":\"true\",\n      \"hl\":\"true\",\n      \"indent\":\"true\",\n      \"hl.fl\":\"name_ngram\",\n      \"wt\":\"json\"}},\n  \"response\":{\"numFound\":1,\"start\":0,\"docs\":[\n      \n{\n        \"id\":\"1\",\n        \"name_ngram\":\"arne.berg\",\n        \"_version_\":1529406846871273472}\n]\n  },\n  \"highlighting\":{\n    \"1\":\n{\n      \"name_ngram\":[\"arne.<em>b</em>.berg\"]}\n}}\n\nSo, the highlight is \"arne.<em>b</em>.berg\", but it should have been \"<em>arne</em>.<em>b</em>erg\".\n\n "
        }
    ]
}