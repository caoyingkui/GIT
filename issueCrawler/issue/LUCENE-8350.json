{
    "id": "LUCENE-8350",
    "title": "RandomPolygonTest times out",
    "details": {
        "components": [],
        "status": "Closed",
        "resolution": "Fixed",
        "fix_versions": [
            "6.6.5",
            "7.4",
            "7.5",
            "master (8.0)"
        ],
        "affect_versions": "None",
        "labels": "",
        "priority": "Minor",
        "type": "Test"
    },
    "description": "I saw a failure on the Elastic CI that I can reproduce locally. The test either never finishes or is very very slow. This is due to the fact that the do ... polygon = ... while(polygon.getClass().equals(largePolygon.getClass())); never returns. NOTE: the test result below was on branch_7x\n\n\n21:13:34    [junit4] Suite: org.apache.lucene.spatial3d.geom.RandomGeoPolygonTest\n21:13:34    [junit4]   2> jun 08, 2018 12:13:10 AM com.carrotsearch.randomizedtesting.ThreadLeakControl$2 evaluate\n21:13:34    [junit4]   2> ADVERTENCIA: Suite execution timed out: org.apache.lucene.spatial3d.geom.RandomGeoPolygonTest\n21:13:34    [junit4]   2>    1) Thread[id=23, name=TEST-RandomGeoPolygonTest.testCompareBigPolygons-seed#[E636FFE9E01130D7], state=RUNNABLE, group=TGRP-RandomGeoPolygonTest]\n21:13:34    [junit4]   2>         at java.util.TimSort.mergeLo(TimSort.java:730)\n21:13:34    [junit4]   2>         at java.util.TimSort.mergeAt(TimSort.java:514)\n21:13:34    [junit4]   2>         at java.util.TimSort.mergeCollapse(TimSort.java:439)\n21:13:34    [junit4]   2>         at java.util.TimSort.sort(TimSort.java:245)\n21:13:34    [junit4]   2>         at java.util.Arrays.sort(Arrays.java:1438)\n21:13:34    [junit4]   2>         at org.apache.lucene.spatial3d.geom.GeoComplexPolygon$Tree.<init>(GeoComplexPolygon.java:918)\n21:13:34    [junit4]   2>         at org.apache.lucene.spatial3d.geom.GeoComplexPolygon$XTree.<init>(GeoComplexPolygon.java:1048)\n21:13:34    [junit4]   2>         at org.apache.lucene.spatial3d.geom.GeoComplexPolygon.<init>(GeoComplexPolygon.java:129)\n21:13:34    [junit4]   2>         at org.apache.lucene.spatial3d.geom.GeoPolygonFactory$BestShape.createGeoComplexPolygon(GeoPolygonFactory.java:463)\n21:13:34    [junit4]   2>         at org.apache.lucene.spatial3d.geom.GeoPolygonFactory.makeLargeGeoPolygon(GeoPolygonFactory.java:389)\n21:13:34    [junit4]   2>         at org.apache.lucene.spatial3d.geom.GeoPolygonFactory.makeGeoPolygon(GeoPolygonFactory.java:226)\n21:13:34    [junit4]   2>         at org.apache.lucene.spatial3d.geom.GeoPolygonFactory.makeGeoPolygon(GeoPolygonFactory.java:142)\n21:13:34    [junit4]   2>         at org.apache.lucene.spatial3d.geom.RandomGeoPolygonTest.testComparePolygons(RandomGeoPolygonTest.java:156)\n21:13:34    [junit4]   2>         at org.apache.lucene.spatial3d.geom.RandomGeoPolygonTest.testCompareBigPolygons(RandomGeoPolygonTest.java:98)\n21:13:34    [junit4]   2>         at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n21:13:34    [junit4]   2>         at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n21:13:34    [junit4]   2>         at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n21:13:34    [junit4]   2>         at java.lang.reflect.Method.invoke(Method.java:498)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1737)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.RandomizedRunner$8.evaluate(RandomizedRunner.java:934)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.RandomizedRunner$9.evaluate(RandomizedRunner.java:970)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.RandomizedRunner$10.evaluate(RandomizedRunner.java:984)\n21:13:34    [junit4]   2>         at org.apache.lucene.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:49)\n21:13:34    [junit4]   2>         at org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n21:13:34    [junit4]   2>         at org.apache.lucene.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:48)\n21:13:34    [junit4]   2>         at org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:64)\n21:13:34    [junit4]   2>         at org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:47)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:368)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.ThreadLeakControl.forkTimeoutingTask(ThreadLeakControl.java:817)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.ThreadLeakControl$3.evaluate(ThreadLeakControl.java:468)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:943)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:829)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:879)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:890)\n21:13:34    [junit4]   2>         at org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n21:13:34    [junit4]   2>         at org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:41)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n21:13:34    [junit4]   2>         at org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:53)\n21:13:34    [junit4]   2>         at org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:47)\n21:13:34    [junit4]   2>         at org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:64)\n21:13:34    [junit4]   2>         at org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:54)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:368)\n21:13:34    [junit4]   2>         at java.lang.Thread.run(Thread.java:748)\n21:13:34    [junit4]   2>    2) Thread[id=1, name=main, state=WAITING, group=main]\n21:13:34    [junit4]   2>         at java.lang.Object.wait(Native Method)\n21:13:34    [junit4]   2>         at java.lang.Thread.join(Thread.java:1252)\n21:13:34    [junit4]   2>         at java.lang.Thread.join(Thread.java:1326)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.RandomizedRunner.runSuite(RandomizedRunner.java:636)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.RandomizedRunner.run(RandomizedRunner.java:493)\n21:13:34    [junit4]   2>         at com.carrotsearch.ant.tasks.junit4.slave.SlaveMain.execute(SlaveMain.java:251)\n21:13:34    [junit4]   2>         at com.carrotsearch.ant.tasks.junit4.slave.SlaveMain.main(SlaveMain.java:368)\n21:13:34    [junit4]   2>         at com.carrotsearch.ant.tasks.junit4.slave.SlaveMainSafe.main(SlaveMainSafe.java:13)\n21:13:34    [junit4]   2>    3) Thread[id=18, name=JUnit4-serializer-daemon, state=TIMED_WAITING, group=main]\n21:13:34    [junit4]   2>         at java.lang.Thread.sleep(Native Method)\n21:13:34    [junit4]   2>         at com.carrotsearch.ant.tasks.junit4.events.Serializer$1.run(Serializer.java:50)\n21:13:34    [junit4]   2>    4) Thread[id=22, name=SUITE-RandomGeoPolygonTest-seed#[E636FFE9E01130D7], state=RUNNABLE, group=TGRP-RandomGeoPolygonTest]\n21:13:34    [junit4]   2>         at java.lang.Thread.getStackTrace(Thread.java:1559)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.ThreadLeakControl$4.run(ThreadLeakControl.java:696)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.ThreadLeakControl$4.run(ThreadLeakControl.java:693)\n21:13:34    [junit4]   2>         at java.security.AccessController.doPrivileged(Native Method)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.ThreadLeakControl.getStackTrace(ThreadLeakControl.java:693)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.ThreadLeakControl.getThreadsWithTraces(ThreadLeakControl.java:709)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.ThreadLeakControl.formatThreadStacksFull(ThreadLeakControl.java:689)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.ThreadLeakControl.access$1000(ThreadLeakControl.java:65)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.ThreadLeakControl$2.evaluate(ThreadLeakControl.java:415)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.RandomizedRunner.runSuite(RandomizedRunner.java:705)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.RandomizedRunner.access$200(RandomizedRunner.java:139)\n21:13:34    [junit4]   2>         at com.carrotsearch.randomizedtesting.RandomizedRunner$2.run(RandomizedRunner.java:626)\n21:13:34    [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=RandomGeoPolygonTest -Dtests.method=testCompareBigPolygons -Dtests.seed=E636FFE9E01130D7 -Dtests.slow=true -Dtests.badapples=true -Dtests.locale=es-DO -Dtests.timezone=Asia/Tel_Aviv -Dtests.asserts=true -Dtests.file.encoding=UTF8\n21:13:34    [junit4] ERROR   7193s J1 | RandomGeoPolygonTest.testCompareBigPolygons {seed=[E636FFE9E01130D7:7E192D1921BDFE08]} <<<\n21:13:34    [junit4]    > Throwable #1: java.lang.Exception: Test abandoned because suite timeout was reached.\n21:13:34    [junit4]    > \tat __randomizedtesting.SeedInfo.seed([E636FFE9E01130D7]:0)",
    "attachments": {
        "LUCENE-8350.patch": "https://issues.apache.org/jira/secure/attachment/12927027/LUCENE-8350.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "id": "comment-16505807",
            "author": "Ignacio Vera",
            "content": "The problem is that with the points provided, the polygon factory can never build a standard polygon. Because points are not cleard after each iteration it loos for ever. I attach a fix for the test. ",
            "date": "2018-06-08T07:53:26+0000"
        },
        {
            "id": "comment-16505872",
            "author": "Adrien Grand",
            "content": "Thanks for jumping on it Ignacio Vera! +1 ",
            "date": "2018-06-08T09:45:31+0000"
        },
        {
            "id": "comment-16505901",
            "author": "Karl Wright",
            "content": "Ignacio Vera, please feel free to commit this to the appropriate branches, which I think are 6x, 7x, master, and 7.4. ",
            "date": "2018-06-08T10:28:47+0000"
        },
        {
            "id": "comment-16505908",
            "author": "ASF subversion and git services",
            "content": "Commit 36b7cdde06d711e7d0691e1d5bb10c458d83fb11 in lucene-solr's branch refs/heads/master from ivera\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=36b7cdd ]\n\nLUCENE-8350: Fix for time-out in RandomGeoPolygonTests ",
            "date": "2018-06-08T10:50:18+0000"
        },
        {
            "id": "comment-16505909",
            "author": "ASF subversion and git services",
            "content": "Commit e4cbbcfb594baf5e9cd01d0cad808f6b5cac4f0f in lucene-solr's branch refs/heads/branch_7x from ivera\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=e4cbbcf ]\n\nLUCENE-8350: Fix for time-out in RandomGeoPolygonTests ",
            "date": "2018-06-08T10:50:33+0000"
        },
        {
            "id": "comment-16505912",
            "author": "ASF subversion and git services",
            "content": "Commit 63d7f5d902d8f6ca22dd442df505b47660cc450d in lucene-solr's branch refs/heads/branch_6x from ivera\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=63d7f5d ]\n\nLUCENE-8350: Fix for time-out in RandomGeoPolygonTests ",
            "date": "2018-06-08T10:51:00+0000"
        },
        {
            "id": "comment-16505913",
            "author": "ASF subversion and git services",
            "content": "Commit 0e7b4c950d6a120abccca8cf8845e00d0b70c79d in lucene-solr's branch refs/heads/branch_7_4 from ivera\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=0e7b4c9 ]\n\nLUCENE-8350: Fix for time-out in RandomGeoPolygonTests ",
            "date": "2018-06-08T10:51:25+0000"
        }
    ]
}