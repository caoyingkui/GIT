{
    "id": "LUCENE-3855",
    "title": "TestStressNRT failures (reproducible)",
    "details": {
        "labels": "",
        "priority": "Minor",
        "components": [],
        "type": "Bug",
        "fix_versions": [
            "4.0-ALPHA"
        ],
        "affect_versions": "None",
        "resolution": "Fixed",
        "status": "Closed"
    },
    "description": "Build server logs. Reproduces on at least two machines.\n\n\n    [junit] ------------- Standard Error -----------------\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=\"-Dfile.encoding=UTF-8\"\n    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Etc/GMT+1\n    [junit] NOTE: all tests run in this JVM:\n    [junit] [TestStressNRT]\n    [junit] NOTE: Linux 3.0.0-16-generic amd64/Sun Microsystems Inc. 1.6.0_27 (64-bit)/cpus=2,threads=1,free=74960064,total=135987200\n    [junit] ------------- ---------------- ---------------\n    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):\tCaused an ERROR\n    [junit] MockDirectoryWrapper: cannot close: there are still open files: {_ng.cfs=8}\n    [junit] java.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still open files: {_ng.cfs=8}\n    [junit] \tat org.apache.lucene.store.MockDirectoryWrapper.close(MockDirectoryWrapper.java:555)\n    [junit] \tat org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:385)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)\n    [junit] \tat org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] Caused by: java.lang.RuntimeException: unclosed IndexInput: _ng.cfs\n    [junit] \tat org.apache.lucene.store.MockDirectoryWrapper.addFileHandle(MockDirectoryWrapper.java:479)\n    [junit] \tat org.apache.lucene.store.MockDirectoryWrapper$1.openSlice(MockDirectoryWrapper.java:777)\n    [junit] \tat org.apache.lucene.store.CompoundFileDirectory.openInput(CompoundFileDirectory.java:221)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.TermInfosReader.<init>(TermInfosReader.java:112)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.Lucene3xFields.<init>(Lucene3xFields.java:84)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat$1.<init>(PreFlexRWPostingsFormat.java:51)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat.fieldsProducer(PreFlexRWPostingsFormat.java:51)\n    [junit] \tat org.apache.lucene.index.SegmentCoreReaders.<init>(SegmentCoreReaders.java:108)\n    [junit] \tat org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:51)\n    [junit] \tat org.apache.lucene.index.IndexWriter$ReadersAndLiveDocs.getMergeReader(IndexWriter.java:521)\n    [junit] \tat org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3587)\n    [junit] \tat org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)\n    [junit] \n    [junit] \n    [junit] Test org.apache.lucene.index.TestStressNRT FAILED",
    "attachments": {
        "output1.log": "https://issues.apache.org/jira/secure/attachment/12517389/output1.log",
        "output2.log": "https://issues.apache.org/jira/secure/attachment/12517390/output2.log",
        "hoss-r1298470-fixed-seed__TEST-org.apache.lucene.index.TestStressNRT.xml": "https://issues.apache.org/jira/secure/attachment/12517594/hoss-r1298470-fixed-seed__TEST-org.apache.lucene.index.TestStressNRT.xml",
        "output4.log": "https://issues.apache.org/jira/secure/attachment/12517392/output4.log",
        "output3.log": "https://issues.apache.org/jira/secure/attachment/12517391/output3.log",
        "LUCENE-3855.patch": "https://issues.apache.org/jira/secure/attachment/12517887/LUCENE-3855.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2012-03-07T11:45:43+0000",
            "content": "This must be a timing issue/race of some sort?\n\nDoesn't reproduce on my machine... does it need multiple iterations usually to fail? ",
            "author": "Robert Muir",
            "id": "comment-13224214"
        },
        {
            "date": "2012-03-07T12:28:59+0000",
            "content": "Ok, it doesn't always happen, but it happens quite frequently (I re-run the test from scratch, didn't use repetitions). Interestingly, the problem seems to be different every time. I'll attach logs. ",
            "author": "Dawid Weiss",
            "id": "comment-13224232"
        },
        {
            "date": "2012-03-07T12:37:38+0000",
            "content": "Four executions, four errors (same seed). ",
            "author": "Dawid Weiss",
            "id": "comment-13224236"
        },
        {
            "date": "2012-03-07T12:39:21+0000",
            "content": "\njunit-sequential:\n    [junit] Testsuite: org.apache.lucene.index.TestStressNRT\n    [junit] Tests run: 1, Failures: 0, Errors: 1, Time elapsed: 10.377 sec\n    [junit] \n    [junit] ------------- Standard Error -----------------\n    [junit] The following exceptions were thrown by threads:\n    [junit] *** Thread: Lucene Merge Thread #133 ***\n    [junit] org.apache.lucene.index.MergePolicy$MergeException: java.lang.AssertionError\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler.handleMergeException(ConcurrentMergeScheduler.java:507)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:480)\n    [junit] Caused by: java.lang.AssertionError\n    [junit] \tat org.apache.lucene.index.IndexWriter.commitMergedDeletes(IndexWriter.java:3028)\n    [junit] \tat org.apache.lucene.index.IndexWriter.commitMerge(IndexWriter.java:3137)\n    [junit] \tat org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3718)\n    [junit] \tat org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=\"-Dfile.encoding=UTF-8\"\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=\"-Dfile.encoding=UTF-8\"\n    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Etc/GMT+1\n    [junit] NOTE: all tests run in this JVM:\n    [junit] [TestStressNRT]\n    [junit] NOTE: Linux 3.0.0-16-generic amd64/Sun Microsystems Inc. 1.6.0_27 (64-bit)/cpus=2,threads=1,free=86308600,total=202244096\n    [junit] ------------- ---------------- ---------------\n    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):\tCaused an ERROR\n    [junit] java.lang.AssertionError: Some threads threw uncaught exceptions!\n    [junit] java.lang.RuntimeException: java.lang.AssertionError: Some threads threw uncaught exceptions!\n    [junit] \tat org.apache.lucene.util.LuceneTestCase.tearDownInternal(LuceneTestCase.java:816)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase.access$1100(LuceneTestCase.java:137)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:640)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)\n    [junit] \tat org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] Caused by: java.lang.AssertionError: Some threads threw uncaught exceptions!\n    [junit] \tat org.apache.lucene.util.LuceneTestCase.checkUncaughtExceptionsAfter(LuceneTestCase.java:844)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase.tearDownInternal(LuceneTestCase.java:788)\n    [junit] \n    [junit] \n\njunit-sequential:\n    [junit] Testsuite: org.apache.lucene.index.TestStressNRT\n    [junit] Tests run: 1, Failures: 0, Errors: 1, Time elapsed: 11.454 sec\n    [junit] \n    [junit] ------------- Standard Error -----------------\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=\"-Dfile.encoding=UTF-8\"\n    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Etc/GMT+1\n    [junit] NOTE: all tests run in this JVM:\n    [junit] [TestStressNRT]\n    [junit] NOTE: Linux 3.0.0-16-generic amd64/Sun Microsystems Inc. 1.6.0_27 (64-bit)/cpus=2,threads=1,free=77427992,total=143851520\n    [junit] ------------- ---------------- ---------------\n    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):\tCaused an ERROR\n    [junit] MockDirectoryWrapper: cannot close: there are still open files: {_eb.cfs=5}\n    [junit] java.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still open files: {_eb.cfs=5}\n    [junit] \tat org.apache.lucene.store.MockDirectoryWrapper.close(MockDirectoryWrapper.java:555)\n    [junit] \tat org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:385)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)\n    [junit] \tat org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] Caused by: java.lang.RuntimeException: unclosed IndexInput: _eb.cfs\n    [junit] \tat org.apache.lucene.store.MockDirectoryWrapper.addFileHandle(MockDirectoryWrapper.java:479)\n    [junit] \tat org.apache.lucene.store.MockDirectoryWrapper$1.openSlice(MockDirectoryWrapper.java:777)\n    [junit] \tat org.apache.lucene.store.CompoundFileDirectory.openInput(CompoundFileDirectory.java:221)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.TermInfosReader.<init>(TermInfosReader.java:112)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.Lucene3xFields.<init>(Lucene3xFields.java:84)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat$1.<init>(PreFlexRWPostingsFormat.java:51)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat.fieldsProducer(PreFlexRWPostingsFormat.java:51)\n    [junit] \tat org.apache.lucene.index.SegmentCoreReaders.<init>(SegmentCoreReaders.java:108)\n    [junit] \tat org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:51)\n    [junit] \tat org.apache.lucene.index.IndexWriter$ReadersAndLiveDocs.getMergeReader(IndexWriter.java:521)\n    [junit] \tat org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3587)\n    [junit] \tat org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)\n    [junit] \n    [junit] \n\njunit-sequential:\n    [junit] Testsuite: org.apache.lucene.index.TestStressNRT\n    [junit] Tests run: 1, Failures: 0, Errors: 1, Time elapsed: 10.892 sec\n    [junit] \n    [junit] ------------- Standard Error -----------------\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=\"-Dfile.encoding=UTF-8\"\n    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Etc/GMT+1\n    [junit] NOTE: all tests run in this JVM:\n    [junit] [TestStressNRT]\n    [junit] NOTE: Linux 3.0.0-16-generic amd64/Sun Microsystems Inc. 1.6.0_27 (64-bit)/cpus=2,threads=1,free=70056648,total=148111360\n    [junit] ------------- ---------------- ---------------\n    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):\tCaused an ERROR\n    [junit] MockDirectoryWrapper: cannot close: there are still open files: {_30.frq=1, _l8.cfs=5, _30.tis=1, _30.tvx=1, _30.fdx=1, _30.fdt=1, _30.tvf=1, _30.tvd=1}\n    [junit] java.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still open files: {_30.frq=1, _l8.cfs=5, _30.tis=1, _30.tvx=1, _30.fdx=1, _30.fdt=1, _30.tvf=1, _30.tvd=1}\n    [junit] \tat org.apache.lucene.store.MockDirectoryWrapper.close(MockDirectoryWrapper.java:555)\n    [junit] \tat org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:385)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)\n    [junit] \tat org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] Caused by: java.lang.RuntimeException: unclosed IndexInput: _30.tis\n    [junit] \tat org.apache.lucene.store.MockDirectoryWrapper.addFileHandle(MockDirectoryWrapper.java:479)\n    [junit] \tat org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:504)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.TermInfosReader.<init>(TermInfosReader.java:112)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.Lucene3xFields.<init>(Lucene3xFields.java:84)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat$1.<init>(PreFlexRWPostingsFormat.java:51)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat.fieldsProducer(PreFlexRWPostingsFormat.java:51)\n    [junit] \tat org.apache.lucene.index.SegmentCoreReaders.<init>(SegmentCoreReaders.java:108)\n    [junit] \tat org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:51)\n    [junit] \tat org.apache.lucene.index.IndexWriter$ReadersAndLiveDocs.getMergeReader(IndexWriter.java:521)\n    [junit] \tat org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3587)\n    [junit] \tat org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)\n    [junit] \n    [junit] \n\njunit-sequential:\n    [junit] Testsuite: org.apache.lucene.index.TestStressNRT\n    [junit] Tests run: 1, Failures: 0, Errors: 1, Time elapsed: 11.678 sec\n    [junit] \n    [junit] ------------- Standard Error -----------------\n    [junit] The following exceptions were thrown by threads:\n    [junit] *** Thread: Lucene Merge Thread #78 ***\n    [junit] org.apache.lucene.index.MergePolicy$MergeException: java.lang.AssertionError\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler.handleMergeException(ConcurrentMergeScheduler.java:507)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:480)\n    [junit] Caused by: java.lang.AssertionError\n    [junit] \tat org.apache.lucene.index.IndexWriter.commitMergedDeletes(IndexWriter.java:3028)\n    [junit] \tat org.apache.lucene.index.IndexWriter.commitMerge(IndexWriter.java:3137)\n    [junit] \tat org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3718)\n    [junit] \tat org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)\n    [junit] *** Thread: Lucene Merge Thread #125 ***\n    [junit] org.apache.lucene.index.MergePolicy$MergeException: java.lang.AssertionError\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler.handleMergeException(ConcurrentMergeScheduler.java:507)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:480)\n    [junit] Caused by: java.lang.AssertionError\n    [junit] \tat org.apache.lucene.index.IndexWriter.commitMergedDeletes(IndexWriter.java:3028)\n    [junit] \tat org.apache.lucene.index.IndexWriter.commitMerge(IndexWriter.java:3137)\n    [junit] \tat org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3718)\n    [junit] \tat org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=\"-Dfile.encoding=UTF-8\"\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=\"-Dfile.encoding=UTF-8\"\n    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Etc/GMT+1\n    [junit] NOTE: all tests run in this JVM:\n    [junit] [TestStressNRT]\n    [junit] NOTE: Linux 3.0.0-16-generic amd64/Sun Microsystems Inc. 1.6.0_27 (64-bit)/cpus=2,threads=1,free=135293744,total=194379776\n    [junit] ------------- ---------------- ---------------\n    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):\tCaused an ERROR\n    [junit] java.lang.AssertionError: Some threads threw uncaught exceptions!\n    [junit] java.lang.RuntimeException: java.lang.AssertionError: Some threads threw uncaught exceptions!\n    [junit] \tat org.apache.lucene.util.LuceneTestCase.tearDownInternal(LuceneTestCase.java:816)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase.access$1100(LuceneTestCase.java:137)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:640)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)\n    [junit] \tat org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] Caused by: java.lang.AssertionError: Some threads threw uncaught exceptions!\n    [junit] \tat org.apache.lucene.util.LuceneTestCase.checkUncaughtExceptionsAfter(LuceneTestCase.java:844)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase.tearDownInternal(LuceneTestCase.java:788)\n    [junit] \n    [junit] \n\n ",
            "author": "Dawid Weiss",
            "id": "comment-13224239"
        },
        {
            "date": "2012-03-07T16:52:54+0000",
            "content": "I began to think it's the Java version/ jvm bug that is causing these, but doesn't seem like it. Ran with the newest JRE 1.6:\n\njunit-sequential:\n    [junit] Testsuite: org.apache.lucene.index.TestStressNRT\n    [junit] Tests run: 1, Failures: 1, Errors: 0, Time elapsed: 9.536 sec\n    [junit]\n    [junit] ------------- Standard Error -----------------\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=\"-Dfile.encoding=UTF-8\"\n    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=US/East-Indiana\n    [junit] NOTE: all tests run in this JVM:\n    [junit] [TestStressNRT]\n    [junit] NOTE: Linux 3.0.0-16-generic amd64/Sun Microsystems Inc. 1.6.0_31 (64-bit)/cpus=2,threads=1,free=95936736,total=148307968\n    [junit] ------------- ---------------- ---------------\n    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):      FAILED\n    [junit] info=_gx(4.0):C9/7 isn't live\n    [junit] junit.framework.AssertionFailedError: info=_gx(4.0):C9/7 isn't live\n    [junit]     at org.apache.lucene.index.IndexWriter$ReaderPool.infoIsLive(IndexWriter.java:663)\n    [junit]     at org.apache.lucene.index.IndexWriter$ReaderPool.dropAll(IndexWriter.java:717)\n    [junit]     at org.apache.lucene.index.IndexWriter.closeInternal(IndexWriter.java:1136)\n    [junit]     at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1069)\n    [junit]     at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1033)\n    [junit]     at org.apache.lucene.index.RandomIndexWriter.close(RandomIndexWriter.java:408)\n    [junit]     at org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:380)\n    [junit]     at org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)\n    [junit]     at org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)\n    [junit]     at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit]     at org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)\n    [junit]     at org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)\n    [junit]     at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)\n    [junit]     at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)\n    [junit]     at org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)\n    [junit]     at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit]\n    [junit]\n    [junit] Test org.apache.lucene.index.TestStressNRT FAILED\n\n ",
            "author": "Dawid Weiss",
            "id": "comment-13224500"
        },
        {
            "date": "2012-03-07T22:38:03+0000",
            "content": "Can't reproduce this on Windows, interestingly. But on another Ubuntu machine, without a problem \u2013\n\njunit-sequential:\n    [junit] Testsuite: org.apache.lucene.index.TestStressNRT\n    [junit] Tests run: 1, Failures: 1, Errors: 0, Time elapsed: 4.449 sec\n    [junit]\n    [junit] ------------- Standard Error -----------------\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=\"-Dfile.encoding=UTF-8\"\n    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Etc/GMT+11\n    [junit] NOTE: all tests run in this JVM:\n    [junit] [TestStressNRT]\n    [junit] NOTE: Linux 2.6.32-38-server amd64/Sun Microsystems Inc. 1.6.0_20 (64-bit)/cpus=4,threads=1,free=150044128,total=174260224\n    [junit] ------------- ---------------- ---------------\n    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):      FAILED\n    [junit] info=_dm(4.0):cv6/4 isn't live\n    [junit] junit.framework.AssertionFailedError: info=_dm(4.0):cv6/4 isn't live\n    [junit]     at org.apache.lucene.index.IndexWriter$ReaderPool.infoIsLive(IndexWriter.java:663)\n    [junit]     at org.apache.lucene.index.IndexWriter$ReaderPool.dropAll(IndexWriter.java:717)\n    [junit]     at org.apache.lucene.index.IndexWriter.closeInternal(IndexWriter.java:1136)\n    [junit]     at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1069)\n    [junit]     at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1033)\n    [junit]     at org.apache.lucene.index.RandomIndexWriter.close(RandomIndexWriter.java:408)\n    [junit]     at org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:380)\n    [junit]     at org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)\n    [junit]     at org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)\n    [junit]     at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit]     at org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)\n    [junit]     at org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)\n    [junit]     at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)\n    [junit]     at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)\n    [junit]     at org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)\n    [junit]     at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit]\n    [junit]\n    [junit] Test org.apache.lucene.index.TestStressNRT FAILED\n\n ",
            "author": "Dawid Weiss",
            "id": "comment-13224801"
        },
        {
            "date": "2012-03-08T07:04:01+0000",
            "content": "It fails here as well, not as often though,  \n\n\n    [junit] ------------- Standard Error -----------------\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=\"-Dfile.encoding=UTF-8\"\n    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=US/East-Indiana\n    [junit] NOTE: all tests run in this JVM:\n    [junit] [TestStressNRT]\n    [junit] NOTE: Linux 3.2.7-1.fc16.x86_64 amd64/Sun Microsystems Inc. 1.6.0_24 (64-bit)/cpus=2,threads=1,free=44668576,total=133169152\n    [junit] ------------- ---------------- ---------------\n\n    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):\tCaused an ERROR\n    [junit] MockDirectoryWrapper: cannot close: there are still open files: {_vv.cfs=5, _j1.cfs=5}\n    [junit] java.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still open files: {_vv.cfs=5, _j1.cfs=5}\n    [junit] \tat org.apache.lucene.store.MockDirectoryWrapper.close(MockDirectoryWrapper.java:555)\n    [junit] \tat org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:385)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)\n    [junit] \tat org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] Caused by: java.lang.RuntimeException: unclosed IndexInput: _j1.cfs\n    [junit] \tat org.apache.lucene.store.MockDirectoryWrapper.addFileHandle(MockDirectoryWrapper.java:479)\n    [junit] \tat org.apache.lucene.store.MockDirectoryWrapper$1.openSlice(MockDirectoryWrapper.java:777)\n    [junit] \tat org.apache.lucene.store.CompoundFileDirectory.openInput(CompoundFileDirectory.java:221)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.Lucene3xStoredFieldsReader.<init>(Lucene3xStoredFieldsReader.java:156)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.Lucene3xStoredFieldsFormat.fieldsReader(Lucene3xStoredFieldsFormat.java:38)\n    [junit] \tat org.apache.lucene.index.SegmentCoreReaders.<init>(SegmentCoreReaders.java:116)\n    [junit] \tat org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:51)\n    [junit] \tat org.apache.lucene.index.IndexWriter$ReadersAndLiveDocs.getMergeReader(IndexWriter.java:521)\n    [junit] \tat org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3587)\n    [junit] \tat org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)\n    [junit] \n\n ",
            "author": "Gilad Barkai",
            "id": "comment-13225057"
        },
        {
            "date": "2012-03-08T08:29:49+0000",
            "content": "Yep, there is something severely wrong in there, but I won't be able to figure it out on my own. Don't get the logic in IndexWriter. But I tracked one of the above exceptions to this scenario:\n\n\n    [junit] junit.framework.AssertionFailedError: info=_dm(4.0):cv6/4 isn't live\n    [junit]     at org.apache.lucene.index.IndexWriter$ReaderPool.infoIsLive(IndexWriter.java:663)\n    [junit]     at org.apache.lucene.index.IndexWriter$ReaderPool.dropAll(IndexWriter.java:717)\n    [junit]     at org.apache.lucene.index.IndexWriter.closeInternal(IndexWriter.java:1136)\n    [junit]     at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1069)\n    [junit]     at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1033)\n    [junit]     at org.apache.lucene.index.RandomIndexWriter.close(RandomIndexWriter.java:408)\n    [junit]     at org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:380)\n\n\n\nSo, the case here is that infoIsLive attempts to check:\n\n\n      int idx = segmentInfos.indexOf(info);\n      assert idx != -1: \"info=\" + info + \" isn't live\";\n\n\n\nI added tracing to segmentInfos when segments do get removed from the underlying array. Once executed, I get the listing:\n\n\n...\n>>> Removing: _o1(4.0):Cv13/13\n>>> Removing: _o0(4.0):Cv6/6\n>>> Removing: _nu(4.0):C12/12\n>>> Removing: _nw(4.0):Cv12/12\n>>> Removing: _o9(4.0):c2/2\n>>> Removing: _q2(4.0):C12/12\n>>> Removing: _qc(4.0):Cv7/7\n>>> Removing: _q6(4.0):C12/12\n>>> Not found: _d9(4.0):Cv8/3\n\n\n\nBut that last segment is never on the list of removed segments. It was never added there in the first place. The allocation stack for that segment is:\n\n\n\tat java.lang.Thread.getStackTrace(Thread.java:1436)\n\tat org.apache.lucene.index.SegmentInfo.<init>(SegmentInfo.java:130)\n\tat org.apache.lucene.index.IndexWriter._mergeInit(IndexWriter.java:3418)\n\tat org.apache.lucene.index.IndexWriter.mergeInit(IndexWriter.java:3382)\n\tat org.apache.lucene.index.ConcurrentMergeScheduler.merge(ConcurrentMergeScheduler.java:346)\n\tat org.apache.lucene.index.IndexWriter.maybeMerge(IndexWriter.java:1905)\n\tat org.apache.lucene.index.IndexWriter.maybeMerge(IndexWriter.java:1899)\n\tat org.apache.lucene.index.IndexWriter.prepareCommit(IndexWriter.java:2726)\n\tat org.apache.lucene.index.IndexWriter.commitInternal(IndexWriter.java:2809)\n\tat org.apache.lucene.index.IndexWriter.commit(IndexWriter.java:2791)\n\tat org.apache.lucene.index.IndexWriter.commit(IndexWriter.java:2775)\n\tat org.apache.lucene.index.RandomIndexWriter.commit(RandomIndexWriter.java:313)\n\tat org.apache.lucene.index.TestStressNRT$1.run(TestStressNRT.java:156)\n\n\n\nSo this looks like a race condition between closing the writer and a concurrent merge scheduler? \n\nLet me know if you need any further stacks/ tracing listings \u2013 this is fairly easy to reproduce on my machine and I can add anything. ",
            "author": "Dawid Weiss",
            "id": "comment-13225085"
        },
        {
            "date": "2012-03-08T08:49:55+0000",
            "content": "This is definitely a race between ConcurrentMergeScheduler and the thread calling close. Everything else seems to stem from this problem. For example this one:\n\n\njava.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still open files: {_dc.tvx=1, _dc.tvf=1, _dc.tvd=1, _dc.fdx=1, _dc.fdt=1, _dc.frq=1, _dc.tis=1}\n\tat org.apache.lucene.store.MockDirectoryWrapper.close(MockDirectoryWrapper.java:555)\n\tat org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:385)\n\n\nhas an underlying open file handle stack:\n\nCaused by: java.lang.RuntimeException: unclosed IndexInput: _dc.tvf\n\tat org.apache.lucene.store.MockDirectoryWrapper.addFileHandle(MockDirectoryWrapper.java:479)\n\tat org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:504)\n\tat org.apache.lucene.codecs.lucene3x.Lucene3xTermVectorsReader.<init>(Lucene3xTermVectorsReader.java:137)\n\tat org.apache.lucene.codecs.lucene3x.PreFlexRWTermVectorsFormat$1.<init>(PreFlexRWTermVectorsFormat.java:39)\n\tat org.apache.lucene.codecs.lucene3x.PreFlexRWTermVectorsFormat.vectorsReader(PreFlexRWTermVectorsFormat.java:39)\n\tat org.apache.lucene.index.SegmentCoreReaders.<init>(SegmentCoreReaders.java:119)\n\tat org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:51)\n\tat org.apache.lucene.index.IndexWriter$ReadersAndLiveDocs.getMergeReader(IndexWriter.java:521)\n\tat org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3591)\n\tat org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3261)\n\tat org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)\n\tat org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)\n\n\n\nUwe, this just calls for your German analytic mind to solve  ",
            "author": "Dawid Weiss",
            "id": "comment-13225088"
        },
        {
            "date": "2012-03-08T11:09:45+0000",
            "content": "I can [eventually] reproduce the failure too, if I beast the test... ",
            "author": "Michael McCandless",
            "id": "comment-13225134"
        },
        {
            "date": "2012-03-08T11:12:47+0000",
            "content": "I think you can try to run a few threads in the background doing just while (true);. I have a slower computer 2-core computer and this happens there most often. ",
            "author": "Dawid Weiss",
            "id": "comment-13225136"
        },
        {
            "date": "2012-03-08T14:45:07+0000",
            "content": "Hmm... compounding problems here is that, somehow, an exception is occurring in a CMS merge thread, yet is never reported by the test runner.  I hit a fail, and only got this:\n\n    [junit] ------------- Standard Error -----------------\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=\"-Dfile.encoding=UTF-8\"\n    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Australia/LHI\n    [junit] NOTE: all tests run in this JVM:\n    [junit] [TestStressNRT]\n    [junit] NOTE: Linux 2.6.33.6-147.fc13.x86_64 amd64/Sun Microsystems Inc. 1.6.0_21 (64-bit)/cpus=24,threads=1,free=257856112,total=285933568\n    [junit] ------------- ---------------- ---------------\n    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):\tFAILED\n    [junit] info=_fu(4.0):C11/1 isn't live\n    [junit] junit.framework.AssertionFailedError: info=_fu(4.0):C11/1 isn't live\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)\n    [junit] \tat org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] \tat org.apache.lucene.index.IndexWriter$ReaderPool.infoIsLive(IndexWriter.java:663)\n    [junit] \tat org.apache.lucene.index.IndexWriter$ReaderPool.dropAll(IndexWriter.java:717)\n    [junit] \tat org.apache.lucene.index.IndexWriter.closeInternal(IndexWriter.java:1137)\n    [junit] \tat org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1069)\n    [junit] \tat org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1033)\n    [junit] \tat org.apache.lucene.index.RandomIndexWriter.close(RandomIndexWriter.java:408)\n    [junit] \tat org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:386)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)\n    [junit] \n    [junit] \n\n\n\nI also separately added a SOP to ConcurrentMergeScheduler.handleMergeException and we are calling that... yet something is not then reporting this exception.\n\nHowever: I made a silly small test case that spawns a thread that throws an exception from its run method, and when I run that indeed I see the \"unhandled exception from thread\".  So I'm not sure why exceptions in CMS threads in particular are not being reported... ",
            "author": "Michael McCandless",
            "id": "comment-13225229"
        },
        {
            "date": "2012-03-08T15:04:46+0000",
            "content": "I'll fix this, Mike. ",
            "author": "Dawid Weiss",
            "id": "comment-13225241"
        },
        {
            "date": "2012-03-08T15:05:08+0000",
            "content": "And by \"this\" I mean LUCENE-3857. ",
            "author": "Dawid Weiss",
            "id": "comment-13225242"
        },
        {
            "date": "2012-03-08T15:13:13+0000",
            "content": "Thanks Dawid!  I'm not sure LUCENE-3857 is what I'm hitting (this test doesn't have a @beforeClass).\n\nOne more piece of data: sometimes the CMS exception is printed in the \"unhandled exceptions\" output... so it's somehow intermittant.  Hmm, it could be... the main thread threw its exc before CMS thread did?  Odd, though, because IW closes CMS first (which should join to all outstanding threads), before hitting the exc in main thread.  Still baffled...\n\nAnyway it's not a blocker for me... I'm printing the exc in CMS.handleExc. ",
            "author": "Michael McCandless",
            "id": "comment-13225250"
        },
        {
            "date": "2012-03-08T15:36:05+0000",
            "content": "I'm not sure LUCENE-3857 is what I'm hitting (this test doesn't have a @beforeClass).\n\nNo, I don't think it is. But I'll fix that issue anyway.\n\nOne more piece of data: sometimes the CMS exception is printed in the \"unhandled exceptions\" output... so it's somehow intermittant.\n\nThis is really messy in the current LTC. I'll try to do something about it. ",
            "author": "Dawid Weiss",
            "id": "comment-13225265"
        },
        {
            "date": "2012-03-08T19:15:11+0000",
            "content": "attached file was generated using trunk r1298470 with the command...\n\n\nX=0; while ant test-core -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=\"-Dfile.encoding=UTF-8\"; do X=$(($X+1)); echo \"Finished Loop $X\"; done; echo \"TOTAL LOOPS: $X\"\n\n\n\nthe failure occured on loop #52\n\n\njunit-sequential:\n    [junit] Testsuite: org.apache.lucene.index.TestStressNRT\n    [junit] Tests run: 1, Failures: 0, Errors: 1, Time elapsed: 5.082 sec\n    [junit] \n    [junit] ------------- Standard Error -----------------\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=\"-Dfile.encoding=UTF-8\"\n    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Asia/Thimphu\n    [junit] NOTE: all tests run in this JVM:\n    [junit] [TestStressNRT]\n    [junit] NOTE: Linux 2.6.31-23-generic amd64/Sun Microsystems Inc. 1.6.0_24 (64-bit)/cpus=2,threads=1,free=192293192,total=256966656\n    [junit] ------------- ---------------- ---------------\n    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):\tCaused an ERROR\n    [junit] MockDirectoryWrapper: cannot close: there are still open files: {_47.frq=1, _47.tis=1, _47.fdx=1, _47.fdt=1}\n    [junit] java.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still open files: {_47.frq=1, _47.tis=1, _47.fdx=1, _47.fdt=1}\n    [junit] \tat org.apache.lucene.store.MockDirectoryWrapper.close(MockDirectoryWrapper.java:555)\n    [junit] \tat org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:385)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)\n    [junit] \tat org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] Caused by: java.lang.RuntimeException: unclosed IndexInput: _47.tis\n    [junit] \tat org.apache.lucene.store.MockDirectoryWrapper.addFileHandle(MockDirectoryWrapper.java:479)\n    [junit] \tat org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:504)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.TermInfosReader.<init>(TermInfosReader.java:112)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.Lucene3xFields.<init>(Lucene3xFields.java:84)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat$1.<init>(PreFlexRWPostingsFormat.java:51)\n    [junit] \tat org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat.fieldsProducer(PreFlexRWPostingsFormat.java:51)\n    [junit] \tat org.apache.lucene.index.SegmentCoreReaders.<init>(SegmentCoreReaders.java:108)\n    [junit] \tat org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:51)\n    [junit] \tat org.apache.lucene.index.IndexWriter$ReadersAndLiveDocs.getMergeReader(IndexWriter.java:521)\n    [junit] \tat org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3587)\n    [junit] \tat org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)\n    [junit] \tat org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)\n    [junit] \n    [junit] \n    [junit] Test org.apache.lucene.index.TestStressNRT FAILED\n\nBUILD FAILED\n/home/hossman/lucene/dev/lucene/build.xml:43: The following error occurred while executing this line:\n/home/hossman/lucene/dev/lucene/common-build.xml:688: The following error occurred while executing this line:\n/home/hossman/lucene/dev/lucene/common-build.xml:677: Tests failed!\n\nTotal time: 8 seconds\nTOTAL LOOPS: 52\n\n ",
            "author": "Hoss Man",
            "id": "comment-13225416"
        },
        {
            "date": "2012-03-08T21:11:01+0000",
            "content": "Mike, would it help if we dumped a linear sequence of each thread's ops on indexwriter/ segmentinfos, whatever else? If you can tell me which classes and methods would be of interest then I can provide such dumps with relative ease (using an aspect or even hardcoded printlns).\n\nAlternatively, can you express certain assertions that should always hold wrt multi-threaded access? I mean something that I could try to weave into the code so that we can catch an abnormal interaction pattern while it's happening (as opposed just seing the result)? ",
            "author": "Dawid Weiss",
            "id": "comment-13225517"
        },
        {
            "date": "2012-03-09T20:11:11+0000",
            "content": "Mike, would it help if we dumped a linear sequence of each thread's ops on indexwriter/ segmentinfos, whatever else?\n\nThanks Dawid!\n\nI actually know the root cause here:\n\nUncaught exception by thread: Thread[Lucene Merge Thread #72,6,main]\norg.apache.lucene.index.MergePolicy$MergeException: java.lang.AssertionError\n\tat org.apache.lucene.index.ConcurrentMergeScheduler.handleMergeException(ConcurrentMergeScheduler.java:509)\n\tat org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:480)\nCaused by: java.lang.AssertionError\n\tat org.apache.lucene.index.IndexWriter.commitMergedDeletes(IndexWriter.java:3028)\n\tat org.apache.lucene.index.IndexWriter.commitMerge(IndexWriter.java:3137)\n\tat org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3718)\n\tat org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)\n\tat org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)\n\tat org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)\n\n\n\nAfter that assert trips all kinds of crazy other exceptions can happen (not-closed files, not-live SegmentInfo, etc.).\n\nAfter the merge finishes, which can take a long time, in commitMergedDeletes we revisit each segment so we can \"carry forward\" any new deletions recorded against that segment, to the newly merged segment.  In an active NRT app there can be many deletes to carry forward...\n\nThat tripped assert was to verify the ReadersAndLiveDocs (RLD) was still present in IW's ReaderPool; it's supposed to remain present throughout merging because we had incRef'd the SegmentReader we opened for merging.\n\nBut, it can in fact be dropped (the bug here) by another thread opening a reader and applying deletes and decRef'ing the reader all after the merge thread 1) acquired the RLD but 2) before it opened the mergeReader from it.\n\nI (accidentally!!) caused this with LUCENE-3631, where we moved writeable deletes from SegmentReader into IndexWriter.  I suspect we need to add a separate refCount to RLD to fix this... I'm working on that. ",
            "author": "Michael McCandless",
            "id": "comment-13226393"
        },
        {
            "date": "2012-03-11T13:29:48+0000",
            "content": "Patch, fixing the issue.  I think it's ready...\n\nBasically I added a refCount to ReadersAndLiveDocs, and\nincRef/decRef'd in the right places.  I also pulled out\nReadersAndLiveDocs to its own source, and tried to simplify\nit a bit (separate method calls to dropChanges,\ndrop, release). ",
            "author": "Michael McCandless",
            "id": "comment-13227045"
        },
        {
            "date": "2012-03-11T14:40:23+0000",
            "content": "\nI also pulled out\nReadersAndLiveDocs to its own source\n\n+1 ",
            "author": "Robert Muir",
            "id": "comment-13227058"
        },
        {
            "date": "2012-03-12T08:02:58+0000",
            "content": "I'm no longer able to reproduce this with the patch applied. I think this should be committed in as soon as possible? ",
            "author": "Dawid Weiss",
            "id": "comment-13227358"
        }
    ]
}