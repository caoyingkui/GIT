{
    "id": "LUCENE-5666",
    "title": "Add UninvertingReader",
    "details": {
        "type": "Improvement",
        "priority": "Major",
        "labels": "",
        "resolution": "Fixed",
        "components": [],
        "affect_versions": "None",
        "status": "Closed",
        "fix_versions": [
            "5.0",
            "6.0"
        ]
    },
    "description": "Currently the fieldcache is not pluggable at all. It would be better if everything used the docvalues apis.\n\nThis would allow people to customize the implementation, extend the classes with custom subclasses with additional stuff, etc etc.\n\nFieldCache can be accessed via the docvalues apis, using the FilterReader api.",
    "attachments": {
        "LUCENE-5666.patch": "https://issues.apache.org/jira/secure/attachment/12644786/LUCENE-5666.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "id": "comment-13994550",
            "author": "ASF subversion and git services",
            "content": "Commit 1593790 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1593790 ]\n\nLUCENE-5666: current state to branch ",
            "date": "2014-05-11T13:49:42+0000"
        },
        {
            "id": "comment-13994554",
            "author": "ASF subversion and git services",
            "content": "Commit 1593792 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1593792 ]\n\nLUCENE-5666: fix testBasic to use dv always ",
            "date": "2014-05-11T13:57:44+0000"
        },
        {
            "id": "comment-13994563",
            "author": "ASF subversion and git services",
            "content": "Commit 1593797 from Michael McCandless in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1593797 ]\n\nLUCENE-5666: fix test bug ",
            "date": "2014-05-11T14:31:22+0000"
        },
        {
            "id": "comment-13994568",
            "author": "ASF subversion and git services",
            "content": "Commit 1593802 from Michael McCandless in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1593802 ]\n\nLUCENE-5666: fix testBasic ",
            "date": "2014-05-11T14:52:21+0000"
        },
        {
            "id": "comment-13994579",
            "author": "ASF subversion and git services",
            "content": "Commit 1593806 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1593806 ]\n\nLUCENE-5666: add docvalues for JDK collator, too ",
            "date": "2014-05-11T15:29:23+0000"
        },
        {
            "id": "comment-13994586",
            "author": "ASF subversion and git services",
            "content": "Commit 1593807 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1593807 ]\n\nLUCENE-5666: fix facet example ",
            "date": "2014-05-11T15:37:36+0000"
        },
        {
            "id": "comment-13994591",
            "author": "ASF subversion and git services",
            "content": "Commit 1593808 from Michael McCandless in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1593808 ]\n\nLUCENE-5666: fix AllGroupHeadsCollectorTest ",
            "date": "2014-05-11T15:50:51+0000"
        },
        {
            "id": "comment-13994606",
            "author": "ASF subversion and git services",
            "content": "Commit 1593816 from Michael McCandless in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1593816 ]\n\nLUCENE-5666: fix grouping tests ",
            "date": "2014-05-11T17:01:03+0000"
        },
        {
            "id": "comment-13994611",
            "author": "ASF subversion and git services",
            "content": "Commit 1593819 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1593819 ]\n\nLUCENE-5666: clean up test and fix testSimple ",
            "date": "2014-05-11T17:13:51+0000"
        },
        {
            "id": "comment-13994614",
            "author": "ASF subversion and git services",
            "content": "Commit 1593822 from Michael McCandless in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1593822 ]\n\nLUCENE-5666: more grouping tests ",
            "date": "2014-05-11T17:20:34+0000"
        },
        {
            "id": "comment-13994617",
            "author": "ASF subversion and git services",
            "content": "Commit 1593825 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1593825 ]\n\nLUCENE-5666: fix testRandom ",
            "date": "2014-05-11T17:35:00+0000"
        },
        {
            "id": "comment-13994666",
            "author": "ASF subversion and git services",
            "content": "Commit 1593850 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1593850 ]\n\nLUCENE-5666: move out more uninverting ",
            "date": "2014-05-11T20:17:14+0000"
        },
        {
            "id": "comment-13994676",
            "author": "ASF subversion and git services",
            "content": "Commit 1593856 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1593856 ]\n\nLUCENE-5666: get solr compiling ",
            "date": "2014-05-11T20:38:23+0000"
        },
        {
            "id": "comment-13994992",
            "author": "Adrien Grand",
            "content": "+1 ",
            "date": "2014-05-12T10:36:30+0000"
        },
        {
            "id": "comment-13995532",
            "author": "ASF subversion and git services",
            "content": "Commit 1594069 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594069 ]\n\nLUCENE-5666: javadocs, support SORTED_SET for multi-valued numerics ",
            "date": "2014-05-12T19:39:12+0000"
        },
        {
            "id": "comment-13995647",
            "author": "ASF subversion and git services",
            "content": "Commit 1594095 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594095 ]\n\nLUCENE-5666: actually make a single-valued fc if the field is not multi-valued ",
            "date": "2014-05-12T21:20:17+0000"
        },
        {
            "id": "comment-13996304",
            "author": "ASF subversion and git services",
            "content": "Commit 1594204 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594204 ]\n\nLUCENE-5666: move sortedset sortfield out of sandbox ",
            "date": "2014-05-13T11:58:39+0000"
        },
        {
            "id": "comment-13996315",
            "author": "ASF subversion and git services",
            "content": "Commit 1594211 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594211 ]\n\nLUCENE-5666: add SortedSetFieldSource ",
            "date": "2014-05-13T12:23:36+0000"
        },
        {
            "id": "comment-13996513",
            "author": "ASF subversion and git services",
            "content": "Commit 1594254 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594254 ]\n\nLUCENE-5666: get solr started ",
            "date": "2014-05-13T15:49:18+0000"
        },
        {
            "id": "comment-13996536",
            "author": "ASF subversion and git services",
            "content": "Commit 1594258 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594258 ]\n\nLUCENE-5666: fix test to assert from raw reader ",
            "date": "2014-05-13T16:07:46+0000"
        },
        {
            "id": "comment-13996717",
            "author": "ASF subversion and git services",
            "content": "Commit 1594311 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594311 ]\n\nLUCENE-5666: fix some tests ",
            "date": "2014-05-13T18:08:37+0000"
        },
        {
            "id": "comment-13996742",
            "author": "ASF subversion and git services",
            "content": "Commit 1594316 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594316 ]\n\nLUCENE-5666: fix bug (null is no longer allowed) ",
            "date": "2014-05-13T18:28:04+0000"
        },
        {
            "id": "comment-13996770",
            "author": "ASF subversion and git services",
            "content": "Commit 1594327 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594327 ]\n\nLUCENE-5666: fix test and bug ",
            "date": "2014-05-13T18:55:35+0000"
        },
        {
            "id": "comment-13997030",
            "author": "ASF subversion and git services",
            "content": "Commit 1594417 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594417 ]\n\nLUCENE-5666: fix test failures ",
            "date": "2014-05-13T23:17:51+0000"
        },
        {
            "id": "comment-13997038",
            "author": "ASF subversion and git services",
            "content": "Commit 1594418 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594418 ]\n\nLUCENE-5666: fix rewrite bug ",
            "date": "2014-05-13T23:24:50+0000"
        },
        {
            "id": "comment-13997165",
            "author": "ASF subversion and git services",
            "content": "Commit 1594441 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594441 ]\n\nLUCENE-5666: fix StatsComponent insanity ",
            "date": "2014-05-14T01:25:55+0000"
        },
        {
            "id": "comment-13997182",
            "author": "ASF subversion and git services",
            "content": "Commit 1594445 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594445 ]\n\nLUCENE-5666: still return missing count etc when there are no terms ",
            "date": "2014-05-14T01:57:50+0000"
        },
        {
            "id": "comment-13997259",
            "author": "ASF subversion and git services",
            "content": "Commit 1594452 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594452 ]\n\nLUCENE-5666: remove insanity during distributed grouping ",
            "date": "2014-05-14T04:22:13+0000"
        },
        {
            "id": "comment-13997343",
            "author": "ASF subversion and git services",
            "content": "Commit 1594492 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594492 ]\n\nLUCENE-5666: support the 2 crazy instances of insanity that are too hard for me to fix  ",
            "date": "2014-05-14T07:05:53+0000"
        },
        {
            "id": "comment-13997359",
            "author": "ASF subversion and git services",
            "content": "Commit 1594505 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594505 ]\n\nLUCENE-5666: clear nocommits and fix precommit ",
            "date": "2014-05-14T07:44:13+0000"
        },
        {
            "id": "comment-13997365",
            "author": "ASF subversion and git services",
            "content": "Commit 1594507 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594507 ]\n\nLUCENE-5666: merge trunk ",
            "date": "2014-05-14T07:46:53+0000"
        },
        {
            "id": "comment-13997370",
            "author": "Robert Muir",
            "content": "Patch (from diff-sources.py) showing the differences between trunk and branch.\n\nUnfortunately I could not remove all fieldcache insanity in solr (i really tried), so there are two narrow cases where its explicitly \"enabled\":\n\n\tord/rord on single-valued numeric fields\n\tgrouping with faceting (group.facet) on single-valued numeric fields.\n\n\n\nOtherwise no more insanity and things are a lot more flexible. ",
            "date": "2014-05-14T07:51:48+0000"
        },
        {
            "id": "comment-13997662",
            "author": "ASF subversion and git services",
            "content": "Commit 1594612 from Michael McCandless in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594612 ]\n\nLUCENE-5666: fix test ",
            "date": "2014-05-14T15:42:28+0000"
        },
        {
            "id": "comment-13997663",
            "author": "ASF subversion and git services",
            "content": "Commit 1594615 from Michael McCandless in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1594615 ]\n\nLUCENE-5666: fix javadocs ",
            "date": "2014-05-14T15:43:04+0000"
        },
        {
            "id": "comment-13999871",
            "author": "ASF subversion and git services",
            "content": "Commit 1595228 from Robert Muir in branch 'dev/branches/lucene5666'\n[ https://svn.apache.org/r1595228 ]\n\nLUCENE-5666: merge trunk ",
            "date": "2014-05-16T15:04:29+0000"
        },
        {
            "id": "comment-13999957",
            "author": "ASF subversion and git services",
            "content": "Commit 1595259 from Robert Muir in branch 'dev/trunk'\n[ https://svn.apache.org/r1595259 ]\n\nLUCENE-5666: Add UninvertingReader ",
            "date": "2014-05-16T16:40:05+0000"
        },
        {
            "id": "comment-14000654",
            "author": "David Smiley",
            "content": "Wow, this was clearly a lot of work and welcome enhancement for sure! Can you please add some more comments on how this impacted the APIs, at least the more public/visible parts we're likely to encounter?  There is a lot to review manually.  I tried to use Fisheye it's unusable at the moment, which possibly can't handle a codebase this size. ",
            "date": "2014-05-17T04:14:30+0000"
        },
        {
            "id": "comment-14000670",
            "author": "Robert Muir",
            "content": "Is the CHANGES.txt entry not good here? The docvalues apis did not change... ",
            "date": "2014-05-17T05:03:17+0000"
        },
        {
            "id": "comment-14000782",
            "author": "David Smiley",
            "content": "Oh, right.  I'll repost it here for everyone's benefit:\n\n* LUCENE-5666: Change uninverted access (sorting, faceting, grouping, etc)\n  to use the DocValues API instead of FieldCache. For FieldCache functionality,\n  use UninvertingReader in lucene/misc (or implement your own FilterReader).\n  UninvertingReader is more efficient: supports multi-valued numeric fields,\n  detects when a multi-valued field is single-valued, reuses caches\n  of compatible types (e.g. SORTED also supports BINARY and SORTED_SET access\n  without insanity).  \"Insanity\" is no longer possible unless you explicitly want it. \n  Rename FieldCache* and DocTermOrds* classes in the search package to DocValues*. \n  Move SortedSetSortField to core and add SortedSetFieldSource to queries/, which\n  takes the same selectors. Add helper methods to DocValues.java that are better \n  suited for search code (never return null, etc).  (Mike McCandless, Robert Muir)\n\n\n\nI looked up DocValues which is new to me but the commit message references LUCENE-5573 which seems mis-attributed. I'm kinda surprised FieldCache isn't deprecated.  It could be marked @lucene.internal.  At least... it's name doesn't seem appropriate anymore.  Maybe UninvertedCache. But perhaps a rename like that would introduce too much change for now, even though it's trunk.  It could use some javadocs stating that DocValues.java should generally be used instead. ",
            "date": "2014-05-17T12:57:11+0000"
        },
        {
            "id": "comment-14000784",
            "author": "Robert Muir",
            "content": "I think you missed the point. it does not have any javadocs: its package private. ",
            "date": "2014-05-17T13:12:47+0000"
        },
        {
            "id": "comment-14000961",
            "author": "David Smiley",
            "content": "Ok, I see that now; it's good. ",
            "date": "2014-05-18T03:03:25+0000"
        },
        {
            "id": "comment-14001204",
            "author": "Adrien Grand",
            "content": "+1 I like the change a lot! ",
            "date": "2014-05-18T20:54:00+0000"
        },
        {
            "id": "comment-14004172",
            "author": "ASF subversion and git services",
            "content": "Commit 1596429 from Anshum Gupta in branch 'dev/trunk'\n[ https://svn.apache.org/r1596429 ]\n\nLUCENE-5666: Fix idea project files ",
            "date": "2014-05-21T00:56:40+0000"
        },
        {
            "id": "comment-14084125",
            "author": "Mikhail Khludnev",
            "content": "Robert Muir I'm poring SOLR-6234 to trunk, and observe the annoying issue. Before, FieldCache was always available, but now if doc-vals are not written (indexed), DocValues.get...  yields emptyXxx, that break tests silently. I'd rather prefer to get NPE or other Illegal..Exception explicitly. \nWhat do I see wrong?   ",
            "date": "2014-08-03T20:26:06+0000"
        },
        {
            "id": "comment-14332959",
            "author": "Anshum Gupta",
            "content": "Bulk close after 5.0 release. ",
            "date": "2015-02-23T05:02:49+0000"
        },
        {
            "id": "comment-15129040",
            "author": "Mikhail Khludnev",
            "content": "Hello, \nI want to clarify \nDeleteByQueryWrapper refers to some caching\nEven though we wrap for each query, UninvertingReader's core cache key is the inner one, so it still reuses fieldcaches and so on. \nWe evidence that indexing stuck on repeatedly building UninversionMap for every deleteByQuery \n\n  \n AtomicReader wrap(AtomicReader reader) {\n    return new UninvertingReader(reader, schema.getUninversionMap(reader));  \n}\n\n\nIs there any chance to make it faster?  ",
            "date": "2016-02-02T21:12:58+0000"
        },
        {
            "id": "comment-15166917",
            "author": "Mikhail Khludnev",
            "content": "followup LUCENE-7049  ",
            "date": "2016-02-25T08:31:49+0000"
        }
    ]
}