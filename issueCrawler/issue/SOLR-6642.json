{
    "id": "SOLR-6642",
    "title": "ArrayIndexOutOfBoundException when searching by specific keywords",
    "details": {
        "components": [
            "SolrJ"
        ],
        "type": "Bug",
        "labels": "",
        "fix_versions": [
            "4.9.1"
        ],
        "affect_versions": "4.9.1",
        "status": "Open",
        "resolution": "Unresolved",
        "priority": "Major"
    },
    "description": "Recently we migrated from 4.7.0 to 4.9.1 and hitting this issue on production, where some keywords search will fail with the following stack trace. I'll update the issue with the exact query used to search.\n\nCaused by: org.apache.solr.client.solrj.SolrServerException: java.lang.ArrayIndexOutOfBoundsException: 31\n\tat com.sabax.datastore.impl.DatastoreImpl$EmbeddedSolrServer.request(DatastoreImpl.java:607) ~[sabasearch.jar:na]\n\t... 196 common frames omitted\nCaused by: java.lang.ArrayIndexOutOfBoundsException: 31\n\tat org.apache.lucene.util.FixedBitSet.nextSetBit(FixedBitSet.java:294) ~[sabasearch.jar:na]\n\tat org.apache.solr.search.DocSetBase$1$1$1.advance(DocSetBase.java:202) ~[sabasearch.jar:na]\n\tat org.apache.lucene.search.ConstantScoreQuery$ConstantScorer.advance(ConstantScoreQuery.java:278) ~[sabasearch.jar:na]\n\tat org.apache.lucene.search.ConjunctionScorer.doNext(ConjunctionScorer.java:69) ~[sabasearch.jar:na]\n\tat org.apache.lucene.search.ConjunctionScorer.nextDoc(ConjunctionScorer.java:100) ~[sabasearch.jar:na]\n\tat org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:192) ~[sabasearch.jar:na]\n\tat org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:163) ~[sabasearch.jar:na]\n\tat org.apache.lucene.search.BulkScorer.score(BulkScorer.java:35) ~[sabasearch.jar:na]\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:621) ~[sabasearch.jar:na]\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:297) ~[sabasearch.jar:na]\n\tat org.apache.solr.search.SolrIndexSearcher.numDocs(SolrIndexSearcher.java:2040) ~[sabasearch.jar:na]\n\tat org.apache.solr.request.SimpleFacets.rangeCount(SimpleFacets.java:1338) ~[sabasearch.jar:na]\n\tat org.apache.solr.request.SimpleFacets.getFacetRangeCounts(SimpleFacets.java:1262) ~[sabasearch.jar:na]\n\tat org.apache.solr.request.SimpleFacets.getFacetRangeCounts(SimpleFacets.java:1197) ~[sabasearch.jar:na]\n\tat org.apache.solr.request.SimpleFacets.getFacetRangeCounts(SimpleFacets.java:1141) ~[sabasearch.jar:na]\n\tat org.apache.solr.request.SimpleFacets.getFacetCounts(SimpleFacets.java:262) ~[sabasearch.jar:na]\n\tat org.apache.solr.handler.component.FacetComponent.process(FacetComponent.java:84) ~[sabasearch.jar:na]\n\tat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:218) ~[sabasearch.jar:na]\n\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135) ~[sabasearch.jar:na]\n\tat org.apache.solr.core.SolrCore.execute(SolrCore.java:1962) ~[sabasearch.jar:na]\n\tat com.sabax.datastore.impl.DatastoreImpl$EmbeddedSolrServer.request(DatastoreImpl.java:602) ~[sabasearch.jar:na]\n\t... 196 common frames omitted",
    "attachments": {
        "JapaneseChars.docx": "https://issues.apache.org/jira/secure/attachment/12680437/JapaneseChars.docx"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2014-11-08T23:00:20+0000",
            "author": "Mohmed",
            "content": "More analysis revealed it fails when we have indexed documents with many Japanese characters and have indexed it using tika parser. The search is successful when we turn OFF facets on the only one date param used. Following is the SolrParam Query\n\nq=((((resource_type:CURRICULUM^0.001((audtype_id:audiexxxxxxxxxxxxxxx^0.001)(disc_from:[2014-11-09T14:27:27.137Z TO *]^0.001 +status:200^0.001 +disp_web:true^0.001 +avail_from:[* TO 2014-11-08T14:27:27.137Z]^0.001)))(+resource_type:OFFERING^1.0(is_private:false^0.001 +course_avail_from:[* TO 2014-11-08T14:27:27.137Z]^0.001 +course_disp_web:true^0.001 +course_disc_from:[2014-11-08T14:27:27.137Z TO *]^0.001 +is_recurring_course:0^0.001 +course_ispublished:true^0.001 +disp_web:true^0.001((offering_enroll_close:[2014-11-08T22:27:27.137Z TO *]^0.001 +base_delivery_type:100^0.001 +endDate:[2014-11-07T22:27:27.137Z TO *]^0.001 +offering_open_enroll:[* TO 2014-11-08T22:27:27.137Z]^0.001 +status:100^0.001)(+base_delivery_type:200^0.001 +disc_from:[2014-11-08T14:27:27.137Z TO *]^0.001 +avail_from:[* TO 2014-11-08T14:27:27.137Z]^0.001))(audtype_id:audiexxxxxxxxxxxxxxx^0.001)))(resource_type:CERTIFICATION^0.001(+(disp_web:true^0.001 +status:200^0.001 +avail_from:[* TO 2014-11-08T14:27:27.053Z]^0.001 +disc_from:[2014-11-09T14:27:27.053Z TO *]^0.001)(audtype_id:audiexxxxxxxxxxxxxxx^0.001))))(((is_alumni:0^1.0))(description_lower:ras_course_with_content_02*^100.0 name_tokenized:ras_course_with_content_02*^10000.0 name_lower:\"ras_course_with_content_02\"^10000.0 course_description_lower:ras_course_with_content_02*^100.0 offering_template_no:ras_course_with_content_02*^1000.0 part_no:ras_course_with_content_02*^1000.0 tag_name:ras_course_with_content_02*^1000.0 name_tokenized:ras_course_with_content_02*^10000.0 tag_name:ras_course_with_content_02*^1000.0 name_tokenized:ras_course_with_content_02*^10000.0 description_lower:ras_course_with_content_02*^100.0 part_no:ras_course_with_content_02*^1000.0 tag_name:ras_course_with_content_02*^1000.0 part_no:ras_course_with_content_02*^1000.0 name_lower:\"ras_course_with_content_02\"^10000.0 offering_template_no:ras_course_with_content_02*^1000.0 name_tokenized:ras_course_with_content_02*^10000.0 description_lower:ras_course_with_content_02*^100.0 part_no:ras_course_with_content_02*^1000.0 name_lower:\"ras_course_with_content_02\"^10000.0 tag_name:ras_course_with_content_02*^1000.0 part_no:ras_course_with_content_02*^1000.0 name_lower:\"ras_course_with_content_02\"^10000.0 description_lower:ras_course_with_content_02*^100.0 name_tokenized:ras_course_with_content_02*^10000.0 name_lower:\"ras_course_with_content_02\"^10000.0 part_no:ras_course_with_content_02*^1000.0 keywords:ras_course_with_content_02*^1000.0 description_lower:ras_course_with_content_02*^100.0 name_lower:\"ras_course_with_content_02\"^10000.0 description_lower:ras_course_with_content_02*^100.0 course_description_lower:ras_course_with_content_02*^100.0 tag_name:ras_course_with_content_02*^1000.0 keywords:ras_course_with_content_02*^1000.0 keywords:ras_course_with_content_02*^1000.0 tag_name:ras_course_with_content_02*^1000.0 name_tokenized:ras_course_with_content_02*^10000.0 keywords:ras_course_with_content_02*^1000.0))))&facet=true&hl.start=1&group.limit=101&facet.method=enum&hl=false&com.saba.datastore.paging.start=1&f.startDate.facet.date.start=2014-11-01T00:00:00.000Z&debugQuery=true&fl=*&fl=score&f.startDate.facet.date.gap=+1MONTH&com.saba.datastore.security.userId=emplo000000000169692&group.field=groupbyid&facet.field=lrnEventType&facet.field=category_id_facet&facet.field=location_id_facet&facet.field=resource_type&facet.field=delivery_id&facet.field=offering_language_id&hl.requireFieldMatch=true&group.format=grouped&group.ngroups=true&com.saba.datastore.paging.rows=60&facet.mincount=1&f.startDate.facet.date.end=2015-11-30T00:00:00.000Z&facet.date=startDate&hl.end=61&com.saba.datastore.security.tenantId=SomeSite&facet.sort=index&group=true&indexKey=SomeSite:SocialSearchIndex&datastoreId=/127.0.0.1:8098&shards=\n\nThanks\n-Hussain ",
            "id": "comment-14203670"
        },
        {
            "date": "2014-11-08T23:01:29+0000",
            "author": "Mohmed",
            "content": "The doc that caused the issue. ",
            "id": "comment-14203671"
        }
    ]
}