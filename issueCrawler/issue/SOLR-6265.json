{
    "id": "SOLR-6265",
    "title": "core errors on startup are not showing up in the log until attempts to use the core?",
    "details": {
        "affect_versions": "None",
        "status": "Resolved",
        "fix_versions": [
            "4.10",
            "6.0"
        ],
        "components": [],
        "type": "Bug",
        "priority": "Blocker",
        "labels": "",
        "resolution": "Fixed"
    },
    "description": "As of r1612418, both the 4x and trunk svn trees seem to have a bug where any core specific init errors that occur on startup don't show up in the log until/unless someone attempts to access that core via HTTP.\n\ni'm not sure when exactly this bug was introduced, but it definitely isn't in 4.9.\n\nThe impact on users, particularly new users, is that starting up solr with a mistake in your configs appears to work fine until you actually try to use solr and then you get ugly errors.",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "author": "Hoss Man",
            "id": "comment-14069559",
            "date": "2014-07-22T00:07:55+0000",
            "content": "Example of how to reproduce:\n\n1) apply this patch to either trunk or 4x...\n\n\nIndex: solr/example/solr/collection1/conf/schema.xml\n===================================================================\n--- solr/example/solr/collection1/conf/schema.xml\t(revision 1612418)\n+++ solr/example/solr/collection1/conf/schema.xml\t(working copy)\n@@ -696,7 +696,7 @@\n       The subFields are an implementation detail of the fieldType, and end\n       users normally should not need to know about them.\n      -->\n-    <fieldType name=\"point\" class=\"solr.PointType\" dimension=\"2\" subFieldSuffix=\"_d\"/>\n+    <fieldType name=\"point\" class=\"solr.PointType\" dimension=\"-2\" subFieldSuffix=\"_d\"/>\n \n     <!-- A specialized field for geospatial search. If indexed, this fieldType must not be multivalued. -->\n     <fieldType name=\"location\" class=\"solr.LatLonType\" subFieldSuffix=\"_coordinate\"/>\n\n\n\n2) start the example, and watch the logs...\n\n\nhossman@frisbee:~/lucene/dev/solr/example$ java -jar start.jar \n0    [main] INFO  org.eclipse.jetty.server.Server  \u2013 jetty-8.1.10.v20130312\n20   [main] INFO  org.eclipse.jetty.deploy.providers.ScanningAppProvider  \u2013 Deployment monitor /home/hossman/lucene/dev/solr/example/contexts at interval 0\n26   [main] INFO  org.eclipse.jetty.deploy.DeploymentManager  \u2013 Deployable added: /home/hossman/lucene/dev/solr/example/contexts/solr-jetty-context.xml\n952  [main] INFO  org.eclipse.jetty.webapp.StandardDescriptorProcessor  \u2013 NO JSP Support for /solr, did not find org.apache.jasper.servlet.JspServlet\n999  [main] INFO  org.apache.solr.servlet.SolrDispatchFilter  \u2013 SolrDispatchFilter.init()\n1012 [main] INFO  org.apache.solr.core.SolrResourceLoader  \u2013 JNDI not configured for solr (NoInitialContextEx)\n1012 [main] INFO  org.apache.solr.core.SolrResourceLoader  \u2013 solr home defaulted to 'solr/' (could not find system property or JNDI)\n1013 [main] INFO  org.apache.solr.core.SolrResourceLoader  \u2013 new SolrResourceLoader for directory: 'solr/'\n1109 [main] INFO  org.apache.solr.core.ConfigSolr  \u2013 Loading container configuration from /home/hossman/lucene/dev/solr/example/solr/solr.xml\n1209 [main] INFO  org.apache.solr.core.CoresLocator  \u2013 Config-defined core root directory: /home/hossman/lucene/dev/solr/example/solr\n1216 [main] INFO  org.apache.solr.core.CoreContainer  \u2013 New CoreContainer 1906063587\n1217 [main] INFO  org.apache.solr.core.CoreContainer  \u2013 Loading cores into CoreContainer [instanceDir=solr/]\n1231 [main] INFO  org.apache.solr.handler.component.HttpShardHandlerFactory  \u2013 Setting socketTimeout to: 0\n1231 [main] INFO  org.apache.solr.handler.component.HttpShardHandlerFactory  \u2013 Setting urlScheme to: null\n   ...CoreContainer obviously init'ing fine...\n   ...more expected stuff...\n1439 [main] INFO  org.apache.solr.core.CoresLocator  \u2013 Found core collection1 in /home/hossman/lucene/dev/solr/example/solr/collection1/\n1439 [main] INFO  org.apache.solr.core.CoresLocator  \u2013 Found 1 core definitions\n1441 [coreLoadExecutor-5-thread-1] INFO  org.apache.solr.core.SolrResourceLoader  \u2013 new SolrResourceLoader for directory: '/home/hossman/lucene/dev/solr/example/solr/collection1/'\n1514 [coreLoadExecutor-5-thread-1] INFO  org.apache.solr.core.SolrConfig  \u2013 Adding specified lib dirs to ClassLoader\n1516 [coreLoadExecutor-5-thread-1] INFO  org.apache.solr.core.SolrResourceLoader  \u2013 Adding 'file:/home/hossman/lucene/dev/solr/contrib/extraction/lib/xz-1.4.jar' to classloader\n   ...solr found collection1 and is clearly parsing solrconfig.xml to load libs...\n   ...more expected stuff...\n1534 [coreLoadExecutor-5-thread-1] INFO  org.apache.solr.core.SolrResourceLoader  \u2013 Adding 'file:/home/hossman/lucene/dev/solr/dist/solr-velocity-5.0-SNAPSHOT.jar' to classloader\n1679 [coreLoadExecutor-5-thread-1] INFO  org.apache.solr.update.SolrIndexConfig  \u2013 IndexWriter infoStream solr logging is enabled\n1688 [coreLoadExecutor-5-thread-1] INFO  org.apache.solr.core.SolrConfig  \u2013 Using Lucene MatchVersion: LUCENE_5_0\n1845 [coreLoadExecutor-5-thread-1] INFO  org.apache.solr.core.Config  \u2013 Loaded SolrConfig: solrconfig.xml\n1852 [coreLoadExecutor-5-thread-1] INFO  org.apache.solr.schema.IndexSchema  \u2013 Reading Solr Schema from schema.xml\n1929 [coreLoadExecutor-5-thread-1] INFO  org.apache.solr.schema.IndexSchema  \u2013 [collection1] Schema name=example\n2411 [main] INFO  org.apache.solr.servlet.SolrDispatchFilter  \u2013 user.dir=/home/hossman/lucene/dev/solr/example\n2411 [main] INFO  org.apache.solr.servlet.SolrDispatchFilter  \u2013 SolrDispatchFilter.init() done\n2434 [main] INFO  org.eclipse.jetty.server.AbstractConnector  \u2013 Started SocketConnector@0.0.0.0:8983\n\n\n\nNOTE: that's the whole log \u2013 nothing about anything found in schema.xml\n\n3) load this URL: http://localhost:8983/solr/admin/cores\n\nYou'll get a response like this...\n\n\n$ curl http://localhost:8983/solr/admin/cores\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<response>\n<lst name=\"responseHeader\"><int name=\"status\">0</int><int name=\"QTime\">1</int></lst><str name=\"defaultCoreName\">collection1</str><lst name=\"initFailures\"><str name=\"collection1\">org.apache.solr.common.SolrException:org.apache.solr.common.SolrException: Could not load core configuration for core collection1</str></lst><lst name=\"status\"/>\n</response>\n\n\n\n\nAnd meanwhile the terminal with the solr log in it will grow by one line...\n\n\n210453 [qtp546236873-14] INFO  org.apache.solr.servlet.SolrDispatchFilter  \u2013 [admin] webapp=null path=/admin/cores params={} status=0 QTime=1 \n\n\n\n4) attempt to quey the core: http://localhost:8983/solr/collection1/select?q=*:*\n\nyour browser will get all the details about hwy this core couldn't be init'ed, and now the error shows up in the log...\n\n\n255212 [qtp546236873-11] ERROR org.apache.solr.servlet.SolrDispatchFilter  \u2013 null:org.apache.solr.common.SolrException: SolrCore 'collection1' is not available due to init failure: Could not load core configuration for core collection1\n\tat org.apache.solr.core.CoreContainer.getCore(CoreContainer.java:740)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:300)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:208)\n\tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)\n\tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:455)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)\n\tat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:557)\n\tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1075)\n\tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:384)\n\tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1009)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)\n\tat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:255)\n\tat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:154)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)\n\tat org.eclipse.jetty.server.Server.handle(Server.java:368)\n\tat org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:489)\n\tat org.eclipse.jetty.server.BlockingHttpConnection.handleRequest(BlockingHttpConnection.java:53)\n\tat org.eclipse.jetty.server.AbstractHttpConnection.headerComplete(AbstractHttpConnection.java:942)\n\tat org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete(AbstractHttpConnection.java:1004)\n\tat org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:640)\n\tat org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:235)\n\tat org.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:72)\n\tat org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:264)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543)\n\tat java.lang.Thread.run(Thread.java:744)\nCaused by: org.apache.solr.common.SolrException: Could not load core configuration for core collection1\n\tat org.apache.solr.core.ConfigSetService.getConfig(ConfigSetService.java:66)\n\tat org.apache.solr.core.CoreContainer.create(CoreContainer.java:485)\n\tat org.apache.solr.core.CoreContainer$1.call(CoreContainer.java:251)\n\tat org.apache.solr.core.CoreContainer$1.call(CoreContainer.java:248)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:262)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\t... 1 more\nCaused by: org.apache.solr.common.SolrException: Plugin Initializing failure for [schema.xml] fieldType. Schema file is /home/hossman/lucene/dev/solr/example/solr/collection1/schema.xml\n\tat org.apache.solr.schema.IndexSchema.readSchema(IndexSchema.java:600)\n\tat org.apache.solr.schema.IndexSchema.<init>(IndexSchema.java:171)\n\tat org.apache.solr.schema.IndexSchemaFactory.create(IndexSchemaFactory.java:55)\n\tat org.apache.solr.schema.IndexSchemaFactory.buildIndexSchema(IndexSchemaFactory.java:69)\n\tat org.apache.solr.core.ConfigSetService.createIndexSchema(ConfigSetService.java:89)\n\tat org.apache.solr.core.ConfigSetService.getConfig(ConfigSetService.java:62)\n\t... 7 more\nCaused by: org.apache.solr.common.SolrException: Plugin Initializing failure for [schema.xml] fieldType\n\tat org.apache.solr.util.plugin.AbstractPluginLoader.load(AbstractPluginLoader.java:193)\n\tat org.apache.solr.schema.IndexSchema.readSchema(IndexSchema.java:491)\n\t... 12 more\nCaused by: org.apache.solr.common.SolrException: The dimension must be > 0: -2\n\tat org.apache.solr.schema.PointType.init(PointType.java:52)\n\tat org.apache.solr.schema.FieldType.setArgs(FieldType.java:166)\n\tat org.apache.solr.schema.FieldTypePluginLoader.init(FieldTypePluginLoader.java:141)\n\tat org.apache.solr.schema.FieldTypePluginLoader.init(FieldTypePluginLoader.java:43)\n\tat org.apache.solr.util.plugin.AbstractPluginLoader.load(AbstractPluginLoader.java:190)\n\t... 13 more\n\n\n\n\nAlan Woodward: is this a side effect of some of the CoreContainer init changes you made? \n\n(It seems like really, REALLY, bad behavior that this stuff is somehow now getting \"lazy logged\") "
        },
        {
            "author": "Erick Erickson",
            "id": "comment-14069587",
            "date": "2014-07-22T00:30:54+0000",
            "content": "Any chance this is specified as a \"lazily loaded\" core? In that case this would be expected behavior....\n\nUnlikely to be the problem, but I thought I'd ask to be sure. "
        },
        {
            "author": "Hoss Man",
            "id": "comment-14069602",
            "date": "2014-07-22T00:37:56+0000",
            "content": "Any chance this is specified as a \"lazily loaded\" core? In that case this would be expected behavior....\n\n\n\tthis is the stock example collection1 - nothing in core.properties about being lazy\n\tthe core init is definitely not lazy \u2013 as noted above, you can see it explicitly loading the collection1 core, parsing the solrconfig.xml & loading the schema.xml \u2013 it's the error it encounters when it gets to the schema.xml that is never logged unless/until someone tries to use the core.\n\n "
        },
        {
            "author": "Shalin Shekhar Mangar",
            "id": "comment-14069898",
            "date": "2014-07-22T06:31:56+0000",
            "content": "This may be related to SOLR-6232 "
        },
        {
            "author": "Alan Woodward",
            "id": "comment-14069975",
            "date": "2014-07-22T08:09:48+0000",
            "content": "Ah crap, I missed out a log line when moving stuff around.  Patch to fix:\n\ndiff --git a/solr/core/src/java/org/apache/solr/core/CoreContainer.java b/solr/core/src/java/org/apache/solr/core/CoreContainer.java\nindex f82a713..93aeff4 100644\n--- a/solr/core/src/java/org/apache/solr/core/CoreContainer.java\n+++ b/solr/core/src/java/org/apache/solr/core/CoreContainer.java\n@@ -499,6 +499,7 @@ public class CoreContainer {\n     }\n     catch (Exception e) {\n       coreInitFailures.put(dcore.getName(), new CoreLoadFailure(dcore, e));\n+      log.error(\"Error creating core [{}]: {}\", dcore.getName(), e);\n       throw new SolrException(ErrorCode.SERVER_ERROR, \"Unable to create core [\" + dcore.getName() + \"]\", e);\n     }\n\n\n\nI'm not near a machine that has commit access for the next couple of weeks, so feel free to commit this Hoss. "
        },
        {
            "author": "Erick Erickson",
            "id": "comment-14070376",
            "date": "2014-07-22T15:18:07+0000",
            "content": "Hmmm, that shows an error, it's just not a horribly informative one, certainly not the full stack trace...\n\nDon't really have time to pursue this now though. "
        },
        {
            "author": "Hoss Man",
            "id": "comment-14072031",
            "date": "2014-07-23T17:51:48+0000",
            "content": "Hmmm, that shows an error, it's just not a horribly informative one, certainly not the full stack trace...\n\nyeah ... we just need to log the exception object, not just the message.\n\nI'm resolving as a part of SOLR-6232 \u2013 fix committed under the banner of that issue since it hasn't been released yet. "
        }
    ]
}