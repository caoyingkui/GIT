{
    "id": "SOLR-4090",
    "title": "Indexing mangles documents under load",
    "details": {
        "affect_versions": "4.0",
        "status": "Closed",
        "fix_versions": [
            "4.1"
        ],
        "components": [],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Duplicate"
    },
    "description": "Sometimes when indexing documents with multiple concurrent processes, I get intermittent data corruption errors.  The data submitted for indexing is valid, but Solr will complain that it is malformed and return an HTTP 500 or 400 error.  The errors are similar whether submitting as XML, JSON, or CSV.  The problem has not occurred using a single process (i.e., one process POSTing to Solr), is rare with four processes, and is pretty reproducible with 16 (or 64, or 128).  I've seen this problem since at least Solr 1.4; we generally just use four threads and hope for the best.  It seems a bit more common with Solr 4, so I decided to track it down.  \n\nI have dummy documents for the example (\"collection1\") schema that, when posted using many simultaneous processes, often generate parsing errors.  I use something like this to pound Solr with repeated POSTs of the same document:\n\n\nyes docs.xml | xargs -P64 -I{} curl -s --data-binary @{} --header 'Content-type: text/xml' 'http://localhost:8983/solr/collection1/update'\n\n\n\nWhich fairly reliably gives this error:\n\n\nSEVERE: org.apache.solr.common.SolrException: Unexpected '<'  in attribute value\n at [row,col {unknown-source}]: [2765,74]\n        at org.apache.solr.handler.loader.XMLLoader.load(XMLLoader.java:159)\n        at org.apache.solr.handler.UpdateRequestHandler$1.load(UpdateRequestHandler.java:92)\n        at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:74)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1699)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:455)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:276)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1337)\n        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:484)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:119)\n        at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:524)\n        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:233)\n        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1065)\n        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:413)\n        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:192)\n        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:999)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:117)\n        at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:250)\n        at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:149)\n        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:111)\n        at org.eclipse.jetty.server.Server.handle(Server.java:351)\n        at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:454)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handleRequest(BlockingHttpConnection.java:47)\n        at org.eclipse.jetty.server.AbstractHttpConnection.headerComplete(AbstractHttpConnection.java:890)\n        at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete(AbstractHttpConnection.java:944)\n        at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:642)\n        at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:230)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:66)\n        at org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:254)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:599)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:534)\n        at java.lang.Thread.run(Thread.java:722)\nCaused by: com.ctc.wstx.exc.WstxParsingException: Unexpected '<'  in attribute value\n at [row,col {unknown-source}]: [2765,74]\n        at com.ctc.wstx.sr.StreamScanner.constructWfcException(StreamScanner.java:630)\n        at com.ctc.wstx.sr.StreamScanner.throwParseError(StreamScanner.java:461)\n        at com.ctc.wstx.sr.BasicStreamReader.parseNormalizedAttrValue(BasicStreamReader.java:1951)\n        at com.ctc.wstx.sr.BasicStreamReader.handleNsAttrs(BasicStreamReader.java:3037)\n        at com.ctc.wstx.sr.BasicStreamReader.handleStartElem(BasicStreamReader.java:2936)\n        at com.ctc.wstx.sr.BasicStreamReader.nextFromTree(BasicStreamReader.java:2848)\n        at com.ctc.wstx.sr.BasicStreamReader.next(BasicStreamReader.java:1019)\n        at org.apache.solr.handler.loader.XMLLoader.readDoc(XMLLoader.java:370)\n        at org.apache.solr.handler.loader.XMLLoader.processUpdate(XMLLoader.java:229)\n        at org.apache.solr.handler.loader.XMLLoader.load(XMLLoader.java:157)\n        ... 31 more\n\n\n\n\nWhen posting the same data as JSON:\n\n\nyes docs.json | xargs -P64 -I{} curl -s --data-binary @{} --header 'Content-type: application/json' 'http://localhost:8983/solr/collection1/update'\n\n\n\nThe errors look like this:\n\n\nSEVERE: org.apache.solr.common.SolrException: ERROR: [doc=3] multiple values encountered for non multiValued field f0008_t: [388888888888888888888888888888888888888888888888888, 9888888888888888888888888888888888888888888888888888]\n        at org.apache.solr.update.DocumentBuilder.toDocument(DocumentBuilder.java:243)\n        at org.apache.solr.update.AddUpdateCommand.getLuceneDocument(AddUpdateCommand.java:73)\n        at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:208)\n        at org.apache.solr.update.processor.RunUpdateProcessor.processAdd(RunUpdateProcessorFactory.java:61)\n        at org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:51)\n        at org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalAdd(DistributedUpdateProcessor.java:432)\n        at org.apache.solr.update.processor.DistributedUpdateProcessor.versionAdd(DistributedUpdateProcessor.java:557)\n        at org.apache.solr.update.processor.DistributedUpdateProcessor.processAdd(DistributedUpdateProcessor.java:325)\n        at org.apache.solr.update.processor.LogUpdateProcessor.processAdd(LogUpdateProcessorFactory.java:100)\n        at org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.handleAdds(JsonLoader.java:386)\n        at org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.processUpdate(JsonLoader.java:111)\n        at org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.load(JsonLoader.java:95)\n        at org.apache.solr.handler.loader.JsonLoader.load(JsonLoader.java:59)\n        at org.apache.solr.handler.UpdateRequestHandler$1.load(UpdateRequestHandler.java:92)\n        at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:74)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1699)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:455)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:276)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1337)\n        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:484)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:119)\n        at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:524)\n        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:233)\n        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1065)\n        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:413)\n        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:192)\n        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:999)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:117)\n        at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:250)\n        at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:149)\n        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:111)\n        at org.eclipse.jetty.server.Server.handle(Server.java:351)\n        at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:454)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handleRequest(BlockingHttpConnection.java:47)\n        at org.eclipse.jetty.server.AbstractHttpConnection.headerComplete(AbstractHttpConnection.java:890)\n        at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.headerComplete(AbstractHttpConnection.java:944)\n        at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:642)\n        at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:230)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:66)\n        at org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:254)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:599)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:534)\n        at java.lang.Thread.run(Thread.java:722)\n\n\n\nI would like to emphasize that the stack traces are misleading: there is no problem with the data. Often the exact same document will index just fine a thousand times before throwing an error.  Somewhere between being submitted and parsed, the data is being occasionally corrupted.  The errors are intermittent, but when the do happen, they often complain about exactly the same byte in the input.\n\nHere's what I know:\n\n\n\tSmall POSTs, or single large documents, don't seem to trigger the problem; it seems to take multiple documents totaling ~150K or more.\n\tMore threads trigger the error more often.\n\tRestricting the JVM heap to say -Xmx384M seems to trigger the problem more often.\n\tSetting commit=true with each post seems to alleviate the problem.\n\tI can't seem to reproduce it with 3.6.1, or 4.1-2012-11-16_01-01-43 nightly \u2013 maybe related to SOLR-3621?\n\tTo test if it was Jetty, I wrote a small servlet that just decodes JSON and pounded it under both Jetty 8.1.2 and 8.1.7  without problems \u2013 however, SOLR-4031 sounds awfully similar, and...\n\tIf I unzip the 4.0 tarball, and replace jetty (example/\n{lib/,start.jar}\n) with the jetty 8.1.7 from 4.1 nightly, it seems to fix the problem.\n\tIf I take Jetty 8.1.2 from 4.0 and use it with 4.1, it breaks 4.1.\n\n\n\nI'm posting this in case anyone runs into similar problems, and meanwhile I will keep testing 4.1.",
    "attachments": {
        "docs.xml": "https://issues.apache.org/jira/secure/attachment/12553821/docs.xml",
        "docs.json": "https://issues.apache.org/jira/secure/attachment/12553820/docs.json"
    },
    "issue_links": {},
    "comments": [
        {
            "author": "Jay Hacker",
            "id": "comment-13499041",
            "date": "2012-11-16T19:37:08+0000",
            "content": "Here are the test documents that make Solr bork. "
        },
        {
            "author": "Yonik Seeley",
            "id": "comment-13499202",
            "date": "2012-11-16T22:29:28+0000",
            "content": "If I understand your description of what you tried, it definitely seems like a Jetty bug that SOLR-4031 fixed?\nSetting commit=true probably just \"fixes\" the problem because it slows everything down enough to not hit the jetty concurrency errors. "
        },
        {
            "author": "Jay Hacker",
            "id": "comment-13510742",
            "date": "2012-12-05T20:37:49+0000",
            "content": "Yes, it appears to be the same Jetty bug and seems fixed now. "
        }
    ]
}