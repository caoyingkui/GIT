{
    "id": "SOLR-2282",
    "title": "Distributed Support for Search Result Clustering",
    "details": {
        "affect_versions": "1.4,                                            1.4.1",
        "status": "Closed",
        "fix_versions": [
            "3.1",
            "4.0-ALPHA"
        ],
        "components": [
            "contrib - Clustering"
        ],
        "type": "New Feature",
        "priority": "Minor",
        "labels": "",
        "resolution": "Fixed"
    },
    "description": "Brad Giaccio contributed a patch for this in SOLR-769. I'd like to incorporate it.",
    "attachments": {
        "SOLR-2282_test.patch": "https://issues.apache.org/jira/secure/attachment/12468132/SOLR-2282_test.patch",
        "SOLR-2282-diagnostics.patch": "https://issues.apache.org/jira/secure/attachment/12468236/SOLR-2282-diagnostics.patch",
        "SOLR-2282.patch": "https://issues.apache.org/jira/secure/attachment/12466516/SOLR-2282.patch",
        "SOLR-2282-concurrency-trunk.patch": "https://issues.apache.org/jira/secure/attachment/12468456/SOLR-2282-concurrency-trunk.patch",
        "SOLR-2282-concurrency-branch_3x.patch": "https://issues.apache.org/jira/secure/attachment/12468457/SOLR-2282-concurrency-branch_3x.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "author": "Koji Sekiguchi",
            "id": "comment-12972703",
            "date": "2010-12-18T00:21:23+0000",
            "content": "A patch attached. Currently, carrot.produceSummary doesn't work in distributed mode:\n\nClusteringComponent.finishStage()\n// TODO: Currently, docIds is set to null in distributed environment.\n// This causes CarrotParams.PRODUCE_SUMMARY doesn't work.\n// To work CarrotParams.PRODUCE_SUMMARY under distributed mode, we can choose either one of:\n// (a) In each shard, ClusteringComponent produces summary and finishStage()\n//     merges these summaries.\n// (b) Adding doHighlighting(SolrDocumentList, ...) method to SolrHighlighter and\n//     making SolrHighlighter uses \"external text\" rather than stored values to produce snippets.\n\n "
        },
        {
            "author": "Koji Sekiguchi",
            "id": "comment-12973069",
            "date": "2010-12-20T02:01:20+0000",
            "content": "Updated test to avoid deprecated version of cluster method. "
        },
        {
            "author": "Koji Sekiguchi",
            "id": "comment-12973072",
            "date": "2010-12-20T02:35:33+0000",
            "content": "Add a simple test for distributed mode contributed by Brad Giaccio in SOLR-769.\n\nCurrently, the test fails due to class path problem when launching Jetty:\n\n\norg/mortbay/jetty/SessionIdManager\njava.lang.NoClassDefFoundError: org/mortbay/jetty/SessionIdManager\n\tat org.apache.solr.BaseDistributedSearchTestCase.createJetty(BaseDistributedSearchTestCase.java:211)\n\tat org.apache.solr.BaseDistributedSearchTestCase.createJetty(BaseDistributedSearchTestCase.java:202)\n\tat org.apache.solr.BaseDistributedSearchTestCase.createServers(BaseDistributedSearchTestCase.java:148)\n\tat org.apache.solr.BaseDistributedSearchTestCase.testDistribSearch(BaseDistributedSearchTestCase.java:566)\n\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1104)\n\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1042)\nCaused by: java.lang.ClassNotFoundException: org.mortbay.jetty.SessionIdManager\n\tat java.net.URLClassLoader$1.run(URLClassLoader.java:202)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat java.net.URLClassLoader.findClass(URLClassLoader.java:190)\n\tat java.lang.ClassLoader.loadClass(ClassLoader.java:307)\n\tat sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:301)\n\tat java.lang.ClassLoader.loadClass(ClassLoader.java:248)\n\n(I have to move now, if someone solves the problem, it is welcome  "
        },
        {
            "author": "Koji Sekiguchi",
            "id": "comment-12973121",
            "date": "2010-12-20T06:54:13+0000",
            "content": "Updated patch. I think this is ready to go. "
        },
        {
            "author": "Koji Sekiguchi",
            "id": "comment-12973131",
            "date": "2010-12-20T07:52:38+0000",
            "content": "Forgot to svn add a file... "
        },
        {
            "author": "Koji Sekiguchi",
            "id": "comment-12974011",
            "date": "2010-12-22T01:15:37+0000",
            "content": "trunk: Committed revision 1051715.\n3x: Committed revision 1051725. "
        },
        {
            "author": "Hoss Man",
            "id": "comment-12974311",
            "date": "2010-12-22T18:10:59+0000",
            "content": "Reopening issue.\n\nThe new test added by this issue...\n\norg.apache.solr.handler.clustering.DistributedClusteringComponentTest.testDistribSearch\n\n...was failing consistently on both hudson, and robert muir's machine, so rmuir disabled it with @Ignore.\n\nwe should get to the bottom of this before resolving\n\nerror from hudson...\n\n\nError Message\n\nSome threads threw uncaught exceptions!\n\nStacktrace\n\njunit.framework.AssertionFailedError: Some threads threw uncaught exceptions!\n\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:950)\n\tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:888)\n\tat org.apache.lucene.util.LuceneTestCase.tearDown(LuceneTestCase.java:371)\n\tat org.apache.solr.SolrTestCaseJ4.tearDown(SolrTestCaseJ4.java:78)\n\tat org.apache.solr.BaseDistributedSearchTestCase.tearDown(BaseDistributedSearchTestCase.java:130)\n\nStandard Error\n\n22-Dec-2010 6:27:38 AM org.apache.solr.common.SolrException log\nSEVERE: java.lang.Error: Error: could not match input\n\tat org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.zzScanError(ExtendedWhitespaceTokenizerImpl.java:687)\n\tat org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.getNextToken(ExtendedWhitespaceTokenizerImpl.java:836)\n\tat org.carrot2.text.analysis.ExtendedWhitespaceTokenizer.nextToken(ExtendedWhitespaceTokenizer.java:46)\n\tat org.carrot2.text.preprocessing.Tokenizer.tokenize(Tokenizer.java:147)\n\tat org.carrot2.text.preprocessing.pipeline.CompletePreprocessingPipeline.preprocess(CompletePreprocessingPipeline.java:54)\n\tat org.carrot2.text.preprocessing.pipeline.BasicPreprocessingPipeline.preprocess(BasicPreprocessingPipeline.java:92)\n\tat org.carrot2.clustering.lingo.LingoClusteringAlgorithm.cluster(LingoClusteringAlgorithm.java:199)\n\tat org.carrot2.clustering.lingo.LingoClusteringAlgorithm.access$000(LingoClusteringAlgorithm.java:44)\n\tat org.carrot2.clustering.lingo.LingoClusteringAlgorithm$1.process(LingoClusteringAlgorithm.java:178)\n\tat org.carrot2.text.clustering.MultilingualClustering.clusterByLanguage(MultilingualClustering.java:222)\n\tat org.carrot2.text.clustering.MultilingualClustering.process(MultilingualClustering.java:110)\n\tat org.carrot2.clustering.lingo.LingoClusteringAlgorithm.process(LingoClusteringAlgorithm.java:171)\n\tat org.carrot2.core.ControllerUtils.performProcessing(ControllerUtils.java:101)\n\tat org.carrot2.core.Controller.process(Controller.java:287)\n\tat org.carrot2.core.Controller.process(Controller.java:180)\n\tat org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(CarrotClusteringEngine.java:105)\n\tat org.apache.solr.handler.clustering.ClusteringComponent.finishStage(ClusteringComponent.java:171)\n\tat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:296)\n\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:131)\n\tat org.apache.solr.core.SolrCore.execute(SolrCore.java:1358)\n\tat org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:341)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:244)\n\tat org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1212)\n\tat org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:399)\n\tat org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182)\n\tat org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:766)\n\tat org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)\n\tat org.mortbay.jetty.Server.handle(Server.java:326)\n\tat org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542)\n\tat org.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:928)\n\tat org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:549)\n\tat org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:212)\n\tat org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404)\n\tat org.mortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:228)\n\tat org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)\n\nNOTE: reproduce with: ant test -Dtestcase=DistributedClusteringComponentTest -Dtestmethod=testDistribSearch -Dtests.seed=412049972111174180:6405396687385598457 -Dtests.multiplier=3\nThe following exceptions were thrown by threads:\n\n\t\n\t\n\t\t\n\t\t\n\t\t\tThread: Thread-13 ***\njunit.framework.AssertionFailedError: .clusters.length:4!=5\n\tat junit.framework.Assert.fail(Assert.java:47)\n\tat org.apache.solr.BaseDistributedSearchTestCase.compareResponses(BaseDistributedSearchTestCase.java:494)\n\tat org.apache.solr.BaseDistributedSearchTestCase$5.run(BaseDistributedSearchTestCase.java:262)\n\t\t\tThread: Thread-14 ***\njava.lang.RuntimeException: org.apache.solr.client.solrj.SolrServerException: Error executing query\n\tat org.apache.solr.BaseDistributedSearchTestCase$5.run(BaseDistributedSearchTestCase.java:265)\nCaused by: org.apache.solr.client.solrj.SolrServerException: Error executing query\n\tat org.apache.solr.client.solrj.request.QueryRequest.process(QueryRequest.java:95)\n\tat org.apache.solr.client.solrj.SolrServer.query(SolrServer.java:118)\n\tat org.apache.solr.BaseDistributedSearchTestCase$5.run(BaseDistributedSearchTestCase.java:260)\nCaused by: org.apache.solr.common.SolrException: Error: could not match input  java.lang.Error: Error: could not match input \tat org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.zzScanError(ExtendedWhitespaceTokenizerImpl.java:687) \tat org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.getNextToken(ExtendedWhitespaceTokenizerImpl.java:836) \tat org.carrot2.text.analysis.ExtendedWhitespaceTokenizer.nextToken(ExtendedWhitespaceTokenizer.java:46) \tat org.carrot2.text.preprocessing.Tokenizer.tokenize(Tokenizer.java:147) \tat org.carrot2.text.preprocessing.pipeline.CompletePreprocessingPipeline.preprocess(CompletePreprocessingPipeline.java:54) \tat org.carrot2.text.preprocessing.pipeline.BasicPreprocessingPipeline.preprocess(BasicPreprocessingPipeline.java:92) \tat org.carrot2.clustering.lingo.LingoClusteringAlgorithm.cluster(LingoClusteringAlgorithm.java:199) \tat org.carrot2.clustering.lingo.LingoClusteringAlgorithm.access$000(LingoClusteringAlgorithm.java:44) \tat org.carrot2.clustering.lingo.LingoClusteringAlgorithm$1.process(LingoClusteringAlgorithm.java:178) \tat org.carrot2.text.clustering.MultilingualClustering.clusterByLanguage(MultilingualClustering.java:222) \tat org.carrot2.text.clustering.MultilingualClustering.process(MultilingualClustering.java:110) \tat org.carrot2.clustering.lingo.LingoClusteringAlgorithm.process(LingoClusteringAlgorithm.java:171) \tat org.carrot2.core.ControllerUtils.performProcessing(ControllerUtils.java:101) \tat org.carrot2.core.Controller.process(Controller.java:287) \tat org.carrot2.core.Controller.process(Controller.java:180) \tat org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(CarrotClusteringEngine.java:105) \tat org.apache.solr.handler.clustering.ClusteringComponent.finishStage(ClusteringComponent.java:171) \tat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:296) \tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:131) \tat org.apache.solr.core.SolrCore.execute(SolrCore.java:1358) \tat org.apache.solr.servlet.SolrDispatchFilter.\n\t\t\n\t\t\n\t\n\t\n\n\n\nError: could not match input  java.lang.Error: Error: could not match input \tat org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.zzScanError(ExtendedWhitespaceTokenizerImpl.java:687) \tat org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.getNextToken(ExtendedWhitespaceTokenizerImpl.java:836) \tat org.carrot2.text.analysis.ExtendedWhitespaceTokenizer.nextToken(ExtendedWhitespaceTokenizer.java:46) \tat org.carrot2.text.preprocessing.Tokenizer.tokenize(Tokenizer.java:147) \tat org.carrot2.text.preprocessing.pipeline.CompletePreprocessingPipeline.preprocess(CompletePreprocessingPipeline.java:54) \tat org.carrot2.text.preprocessing.pipeline.BasicPreprocessingPipeline.preprocess(BasicPreprocessingPipeline.java:92) \tat org.carrot2.clustering.lingo.LingoClusteringAlgorithm.cluster(LingoClusteringAlgorithm.java:199) \tat org.carrot2.clustering.lingo.LingoClusteringAlgorithm.access$000(LingoClusteringAlgorithm.java:44) \tat org.carrot2.clustering.lingo.LingoClusteringAlgorithm$1.process(LingoClusteringAlgorithm.java:178) \tat org.carrot2.text.clustering.MultilingualClustering.clusterByLanguage(MultilingualClustering.java:222) \tat org.carrot2.text.clustering.MultilingualClustering.process(MultilingualClustering.java:110) \tat org.carrot2.clustering.lingo.LingoClusteringAlgorithm.process(LingoClusteringAlgorithm.java:171) \tat org.carrot2.core.ControllerUtils.performProcessing(ControllerUtils.java:101) \tat org.carrot2.core.Controller.process(Controller.java:287) \tat org.carrot2.core.Controller.process(Controller.java:180) \tat org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(CarrotClusteringEngine.java:105) \tat org.apache.solr.handler.clustering.ClusteringComponent.finishStage(ClusteringComponent.java:171) \tat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:296) \tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:131) \tat org.apache.solr.core.SolrCore.execute(SolrCore.java:1358) \tat org.apache.solr.servlet.SolrDispatchFilter.\n\nrequest: http://localhost:14333/solr/select?clustering=true&q=*:*&sort=id desc&clustering.results=true&shards=localhost:14333/solr&wt=javabin&version=2\n\tat org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:435)\n\tat org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:244)\n\tat org.apache.solr.client.solrj.request.QueryRequest.process(QueryRequest.java:89)\n\t... 2 more\nWARNING: test class left thread running: Thread[MultiThreadedHttpConnectionManager cleanup,5,main]\nWARNING: test class left thread running: Thread[pool-7-thread-1,5,main]\nWARNING: test class left thread running: Thread[pool-7-thread-3,5,main]\nWARNING: test class left thread running: Thread[pool-7-thread-2,5,main]\nWARNING: test class left thread running: Thread[pool-7-thread-4,5,main]\nWARNING: test class left thread running: Thread[pool-7-thread-5,5,main]\nWARNING: test class left thread running: Thread[pool-7-thread-6,5,main]\nRESOURCE LEAK: test class left 7 thread(s) running\nNOTE: test params are: locale=en_CA, timezone=Asia/Ashgabat\nNOTE: all tests run in this JVM:\n[ClusteringComponentTest, DistributedClusteringComponentTest] "
        },
        {
            "author": "Stanislaw Osinski",
            "id": "comment-12974314",
            "date": "2010-12-22T18:21:25+0000",
            "content": "This may be related to a concurrency bug we fixed in the latest (3.4.2) release of Carrot2. Tomorrow morning I can prepare a Carrot2 upgrade patch, which should hopefully fix the problem. "
        },
        {
            "author": "Stanislaw Osinski",
            "id": "comment-12974679",
            "date": "2010-12-23T17:59:08+0000",
            "content": "Linking Carrot2 upgrade issue (with patches) that may fix the exception. I wasn't able to reproduce the original failure on my machine though. "
        },
        {
            "author": "Stanislaw Osinski",
            "id": "comment-12979555",
            "date": "2011-01-10T12:05:20+0000",
            "content": "Thanks for committing SOLR-2296, Koji! When I now run the test, I'm getting a different exception, which looks like some misconfiguration of the test itself:\n\n\ntest:\n    [junit] Testsuite: org.apache.solr.handler.clustering.DistributedClusteringComponentTest\n    [junit] Tests run: 1, Failures: 0, Errors: 1, Time elapsed: 4,539 sec\n    [junit] ------------- Standard Error -----------------\n    [junit] 10 Januari 2011 2:59:26 PM org.apache.solr.common.SolrException log\n    [junit] SEVERE: org.apache.solr.common.SolrException: ERROR:unknown field 'url'\n    [junit]     at org.apache.solr.update.DocumentBuilder.toDocument(DocumentBuilder.java:321)\n    [junit]     at org.apache.solr.update.processor.RunUpdateProcessor.processAdd(RunUpdateProcessorFactory.java:60)\n    [junit]     at org.apache.solr.handler.XMLLoader.processUpdate(XMLLoader.java:119)\n    [junit]     at org.apache.solr.handler.XMLLoader.load(XMLLoader.java:69)\n    [junit]     at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:54)\n    [junit]     at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n    [junit]     at org.apache.solr.core.SolrCore.execute(SolrCore.java:1296)\n    [junit]     at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:338)\n    [junit]     at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:240)\n    [junit]     at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1212)\n    [junit]     at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:399)\n    [junit]     at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182)\n    [junit]     at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:766)\n    [junit]     at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)\n    [junit]     at org.mortbay.jetty.Server.handle(Server.java:326)\n    [junit]     at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542)\n    [junit]     at org.mortbay.jetty.HttpConnection$RequestHandler.content(HttpConnection.java:945)\n    [junit]     at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:843)\n    [junit]     at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:218)\n    [junit]     at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404)\n    [junit]     at org.mortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:228)\n    [junit]     at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)\n    [junit]\n    [junit] NOTE: reproduce with: ant test -Dtestcase=DistributedClusteringComponentTest -Dtestmethod=testDistribSearch\n-Dtests.seed=412049972111174180:6405396687385598457 -Dtests.multiplier=3\n\n "
        },
        {
            "author": "Koji Sekiguchi",
            "id": "comment-12980622",
            "date": "2011-01-12T08:35:55+0000",
            "content": "When I now run the test, I'm getting a different exception, which looks like some misconfiguration of the test itself: \n\nConfirmed.\n\ncontrib/clustering/build.xml seems to be changed in SOLR-2299, but I'm not sure the cause of the failure. "
        },
        {
            "author": "Koji Sekiguchi",
            "id": "comment-12980741",
            "date": "2011-01-12T15:03:01+0000",
            "content": "I've committed the fix for \"unknown field 'url'\". "
        },
        {
            "author": "Robert Muir",
            "id": "comment-12980749",
            "date": "2011-01-12T15:24:06+0000",
            "content": "sorry guys, i screwed this up, by not adding logic to the BaseDistributedTestCase to make it work for contribs, from resources.\n\nI saw that it extended SolrTestCaseJ4 but I neglected to realize that it doesnt use initCore, so i'll take a look at fixing this. "
        },
        {
            "author": "Robert Muir",
            "id": "comment-12980763",
            "date": "2011-01-12T15:51:33+0000",
            "content": "here's a patch to fix the BaseDistributedTestCase, so clustering and other contribs can set their own home and use it.\n\nthis fixes the unknown field problem, but i'm still seeing the zzBuffer array index out of bounds exception... perhaps \nmy checkout is somehow out of date... maybe you can test the patch? "
        },
        {
            "author": "Stanislaw Osinski",
            "id": "comment-12980881",
            "date": "2011-01-12T19:43:04+0000",
            "content": "Sure, I'll take a look at it tomorrow morning.  "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-12980936",
            "date": "2011-01-12T21:29:54+0000",
            "content": "Robert, can you somehow check if it's the input that's causing these errors?\n\nSEVERE: java.lang.Error: Error: could not match input\n\nI don't have any idea when such an error could happen, but it doesn't seem to be related to concurrency (at first glance). "
        },
        {
            "author": "Koji Sekiguchi",
            "id": "comment-12981100",
            "date": "2011-01-13T02:49:32+0000",
            "content": "Thanks, Robert! I committed the fix. (Still I couldn't reproduce the hudson problem on my mac if I comment out @Ignore in DistributedClusteringComponentTest.java.) "
        },
        {
            "author": "Stanislaw Osinski",
            "id": "comment-12981168",
            "date": "2011-01-13T08:10:26+0000",
            "content": "Hi Robert,\n\nWhat's the configuration (OS / JVM) on which the test is failing for you? I can't get it to fail on my machines (Win 7 64-bit with Sun JVM 1.6.0_20 Client VM and Oracle 1.6.0_23 Server VM, Ubuntu 64-bit with Sun JVM 1.6.0_20 Server VM). I'm running the test using the command I found in Hudson logs (ant test -Dtestcase=DistributedClusteringComponentTest -Dtestmethod=testDistribSearch -Dtests.seed=412049972111174180:6405396687385598457 -Dtests.multiplier=3).\n\nS. "
        },
        {
            "author": "Robert Muir",
            "id": "comment-12981178",
            "date": "2011-01-13T08:40:39+0000",
            "content": "Stanislaw: it is true that with that exact random seed, the test passes for me.\nBut if i just run 'ant test', often it fails.\n\nBelow is the output... i put my OS configuration first here... sorry for the noise.\n\n\n    [junit] NOTE: Windows Vista 6.0 x86/Sun Microsystems Inc. 1.6.0_23 (32-bit)/cpus=4,threads=4,free=5267640,total=16384000\n\ntest:\n    [junit] Testsuite: org.apache.solr.handler.clustering.DistributedClusteringComponentTest\n    [junit] Tests run: 1, Failures: 1, Errors: 0, Time elapsed: 13.18 sec\n    [junit] ------------- Standard Error -----------------\n    [junit] 2011-1-13 3:35:19 org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine cluster\n    [junit] SEVERE: Carrot2 clustering failed\n    [junit] java.lang.IndexOutOfBoundsException\n    [junit]     at java.io.StringReader.read(StringReader.java:76)\n    [junit]     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.zzRefill(ExtendedWhitespaceTokenizerImpl.java:557)\n    [junit]     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.getNextToken(ExtendedWhitespaceTokenizerImpl.java:754)\n    [junit]     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizer.nextToken(ExtendedWhitespaceTokenizer.java:46)\n    [junit]     at org.carrot2.text.preprocessing.Tokenizer.tokenize(Tokenizer.java:147)\n    [junit]     at org.carrot2.text.preprocessing.pipeline.CompletePreprocessingPipeline.preprocess(CompletePreprocessingPipeline.java:54)\n    [junit]     at org.carrot2.text.preprocessing.pipeline.BasicPreprocessingPipeline.preprocess(BasicPreprocessingPipeline.java:92)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.cluster(LingoClusteringAlgorithm.java:198)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.access$000(LingoClusteringAlgorithm.java:43)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm$1.process(LingoClusteringAlgorithm.java:177)\n    [junit]     at org.carrot2.text.clustering.MultilingualClustering.clusterByLanguage(MultilingualClustering.java:223)\n\n    [junit]     at org.carrot2.text.clustering.MultilingualClustering.process(MultilingualClustering.java:111)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.process(LingoClusteringAlgorithm.java:170)\n    [junit]     at org.carrot2.core.ControllerUtils.performProcessing(ControllerUtils.java:102)\n    [junit]     at org.carrot2.core.Controller.process(Controller.java:347)\n    [junit]     at org.carrot2.core.Controller.process(Controller.java:239)\n    [junit]     at org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(CarrotClusteringEngine.java:106)\n    [junit]     at org.apache.solr.handler.clustering.ClusteringComponent.finishStage(ClusteringComponent.java:167)\n    [junit]     at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:336)\n    [junit]     at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n    [junit]     at org.apache.solr.core.SolrCore.execute(SolrCore.java:1296)\n    [junit]     at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:338)\n    [junit]     at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:240)\n    [junit]     at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1212)\n    [junit]     at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:399)\n    [junit]     at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182)\n    [junit]     at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:766)\n    [junit]     at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)\n    [junit]     at org.mortbay.jetty.Server.handle(Server.java:326)\n    [junit]     at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542)\n    [junit]     at org.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:928)\n    [junit]     at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:549)\n    [junit]     at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:212)\n    [junit]     at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404)\n    [junit]     at org.mortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:228)\n    [junit]     at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)\n    [junit] 2011-1-13 3:35:19 org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine cluster\n    [junit] SEVERE: Carrot2 clustering failed\n    [junit] java.lang.IndexOutOfBoundsException\n    [junit]     at java.io.StringReader.read(StringReader.java:76)\n    [junit]     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.zzRefill(ExtendedWhitespaceTokenizerImpl.java:557)\n    [junit]     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.getNextToken(ExtendedWhitespaceTokenizerImpl.java:754)\n    [junit]     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizer.nextToken(ExtendedWhitespaceTokenizer.java:46)\n    [junit]     at org.carrot2.text.preprocessing.Tokenizer.tokenize(Tokenizer.java:147)\n    [junit]     at org.carrot2.text.preprocessing.pipeline.CompletePreprocessingPipeline.preprocess(CompletePreprocessingPipeline.java:54)\n    [junit]     at org.carrot2.text.preprocessing.pipeline.BasicPreprocessingPipeline.preprocess(BasicPreprocessingPipeline.java:92)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.cluster(LingoClusteringAlgorithm.java:198)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.access$000(LingoClusteringAlgorithm.java:43)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm$1.process(LingoClusteringAlgorithm.java:177)\n    [junit]     at org.carrot2.text.clustering.MultilingualClustering.clusterByLanguage(MultilingualClustering.java:223)\n\n    [junit]     at org.carrot2.text.clustering.MultilingualClustering.process(MultilingualClustering.java:111)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.process(LingoClusteringAlgorithm.java:170)\n    [junit]     at org.carrot2.core.ControllerUtils.performProcessing(ControllerUtils.java:102)\n    [junit]     at org.carrot2.core.Controller.process(Controller.java:347)\n    [junit]     at org.carrot2.core.Controller.process(Controller.java:239)\n    [junit]     at org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(CarrotClusteringEngine.java:106)\n    [junit]     at org.apache.solr.handler.clustering.ClusteringComponent.finishStage(ClusteringComponent.java:167)\n    [junit]     at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:336)\n    [junit]     at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n    [junit]     at org.apache.solr.core.SolrCore.execute(SolrCore.java:1296)\n    [junit]     at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:338)\n    [junit]     at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:240)\n    [junit]     at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1212)\n    [junit]     at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:399)\n    [junit]     at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182)\n    [junit]     at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:766)\n    [junit]     at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)\n    [junit]     at org.mortbay.jetty.Server.handle(Server.java:326)\n    [junit]     at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542)\n    [junit]     at org.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:928)\n    [junit]     at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:549)\n    [junit]     at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:212)\n    [junit]     at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404)\n    [junit]     at org.mortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:228)\n    [junit]     at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)\n    [junit] 2011-1-13 3:35:19 org.apache.solr.common.SolrException log\n    [junit] SEVERE: org.apache.solr.common.SolrException: Carrot2 clustering failed\n    [junit]     at org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(CarrotClusteringEngine.java:110)\n    [junit]     at org.apache.solr.handler.clustering.ClusteringComponent.finishStage(ClusteringComponent.java:167)\n    [junit]     at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:336)\n    [junit]     at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n    [junit]     at org.apache.solr.core.SolrCore.execute(SolrCore.java:1296)\n    [junit]     at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:338)\n    [junit]     at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:240)\n    [junit]     at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1212)\n    [junit]     at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:399)\n    [junit]     at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182)\n    [junit]     at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:766)\n    [junit]     at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)\n    [junit]     at org.mortbay.jetty.Server.handle(Server.java:326)\n    [junit]     at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542)\n    [junit]     at org.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:928)\n    [junit]     at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:549)\n    [junit]     at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:212)\n    [junit]     at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404)\n    [junit]     at org.mortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:228)\n    [junit]     at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)\n    [junit] Caused by: java.lang.IndexOutOfBoundsException\n    [junit]     at java.io.StringReader.read(StringReader.java:76)\n    [junit]     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.zzRefill(ExtendedWhitespaceTokenizerImpl.java:557)\n    [junit]     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.getNextToken(ExtendedWhitespaceTokenizerImpl.java:754)\n    [junit]     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizer.nextToken(ExtendedWhitespaceTokenizer.java:46)\n    [junit]     at org.carrot2.text.preprocessing.Tokenizer.tokenize(Tokenizer.java:147)\n    [junit]     at org.carrot2.text.preprocessing.pipeline.CompletePreprocessingPipeline.preprocess(CompletePreprocessingPipeline.java:54)\n    [junit]     at org.carrot2.text.preprocessing.pipeline.BasicPreprocessingPipeline.preprocess(BasicPreprocessingPipeline.java:92)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.cluster(LingoClusteringAlgorithm.java:198)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.access$000(LingoClusteringAlgorithm.java:43)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm$1.process(LingoClusteringAlgorithm.java:177)\n    [junit]     at org.carrot2.text.clustering.MultilingualClustering.clusterByLanguage(MultilingualClustering.java:223)\n\n    [junit]     at org.carrot2.text.clustering.MultilingualClustering.process(MultilingualClustering.java:111)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.process(LingoClusteringAlgorithm.java:170)\n    [junit]     at org.carrot2.core.ControllerUtils.performProcessing(ControllerUtils.java:102)\n    [junit]     at org.carrot2.core.Controller.process(Controller.java:347)\n    [junit]     at org.carrot2.core.Controller.process(Controller.java:239)\n    [junit]     at org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(CarrotClusteringEngine.java:106)\n    [junit]     ... 19 more\n    [junit]\n    [junit] 2011-1-13 3:35:19 org.apache.solr.common.SolrException log\n    [junit] SEVERE: org.apache.solr.common.SolrException: Carrot2 clustering failed\n    [junit]     at org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(CarrotClusteringEngine.java:110)\n    [junit]     at org.apache.solr.handler.clustering.ClusteringComponent.finishStage(ClusteringComponent.java:167)\n    [junit]     at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:336)\n    [junit]     at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n    [junit]     at org.apache.solr.core.SolrCore.execute(SolrCore.java:1296)\n    [junit]     at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:338)\n    [junit]     at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:240)\n    [junit]     at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1212)\n    [junit]     at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:399)\n    [junit]     at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182)\n    [junit]     at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:766)\n    [junit]     at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)\n    [junit]     at org.mortbay.jetty.Server.handle(Server.java:326)\n    [junit]     at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542)\n    [junit]     at org.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:928)\n    [junit]     at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:549)\n    [junit]     at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:212)\n    [junit]     at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404)\n    [junit]     at org.mortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:228)\n    [junit]     at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)\n    [junit] Caused by: java.lang.IndexOutOfBoundsException\n    [junit]     at java.io.StringReader.read(StringReader.java:76)\n    [junit]     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.zzRefill(ExtendedWhitespaceTokenizerImpl.java:557)\n    [junit]     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.getNextToken(ExtendedWhitespaceTokenizerImpl.java:754)\n    [junit]     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizer.nextToken(ExtendedWhitespaceTokenizer.java:46)\n    [junit]     at org.carrot2.text.preprocessing.Tokenizer.tokenize(Tokenizer.java:147)\n    [junit]     at org.carrot2.text.preprocessing.pipeline.CompletePreprocessingPipeline.preprocess(CompletePreprocessingPipeline.java:54)\n    [junit]     at org.carrot2.text.preprocessing.pipeline.BasicPreprocessingPipeline.preprocess(BasicPreprocessingPipeline.java:92)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.cluster(LingoClusteringAlgorithm.java:198)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.access$000(LingoClusteringAlgorithm.java:43)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm$1.process(LingoClusteringAlgorithm.java:177)\n    [junit]     at org.carrot2.text.clustering.MultilingualClustering.clusterByLanguage(MultilingualClustering.java:223)\n\n    [junit]     at org.carrot2.text.clustering.MultilingualClustering.process(MultilingualClustering.java:111)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.process(LingoClusteringAlgorithm.java:170)\n    [junit]     at org.carrot2.core.ControllerUtils.performProcessing(ControllerUtils.java:102)\n    [junit]     at org.carrot2.core.Controller.process(Controller.java:347)\n    [junit]     at org.carrot2.core.Controller.process(Controller.java:239)\n    [junit]     at org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(CarrotClusteringEngine.java:106)\n    [junit]     ... 19 more\n    [junit]\n    [junit] NOTE: reproduce with: ant test -Dtestcase=DistributedClusteringComponentTest -Dtestmethod=testDistribSearch\n-Dtests.seed=8909233178291932652:-4859244606911873252\n    [junit] The following exceptions were thrown by threads:\n    [junit] *** Thread: Thread-29 ***\n    [junit] java.lang.RuntimeException: org.apache.solr.client.solrj.SolrServerException: Error executing query\n    [junit]     at org.apache.solr.BaseDistributedSearchTestCase$5.run(BaseDistributedSearchTestCase.java:333)\n    [junit] Caused by: org.apache.solr.client.solrj.SolrServerException: Error executing query\n    [junit]     at org.apache.solr.client.solrj.request.QueryRequest.process(QueryRequest.java:95)\n    [junit]     at org.apache.solr.client.solrj.SolrServer.query(SolrServer.java:119)\n    [junit]     at org.apache.solr.BaseDistributedSearchTestCase$5.run(BaseDistributedSearchTestCase.java:328)\n    [junit] Caused by: org.apache.solr.common.SolrException: Carrot2 clustering failed  org.apache.solr.common.SolrExcep\ntion: Carrot2 clustering failed         at org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(Car\nrotClusteringEngine.java:110)   at org.apache.solr.handler.clustering.ClusteringComponent.finishStage(ClusteringComponen\nt.java:167)     at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:336)    at org.a\npache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)        at org.apache.solr.core.SolrCore\n.execute(SolrCore.java:1296)    at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:338)\nat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:240)     at org.mortbay.jetty.servlet.Ser\nvletHandler$CachedChain.doFilter(ServletHandler.java:1212)      at org.mortbay.jetty.servlet.ServletHandler.handle(Servl\netHandler.java:399)     at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182)     at org.mortbay.j\netty.handler.ContextHandler.handle(ContextHandler.java:766)     at org.mortbay.jetty.handler.HandlerWrapper.handle(Handl\nerWrapper.java:152)     at org.mortbay.jetty.Server.handle(Server.java:326)     at org.mortbay.jetty.HttpConnection.hand\nleRequest(HttpConnection.java:542)      at org.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection\n.java:928)      at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:549)          at org.mortbay.jetty.HttpParser.\nparseAvailable(HttpParser.java:212)     at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404)     at org.m\nortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:228)       at org.mortbay.thread.QueuedThreadPool$P\noolThread.run(QueuedThreadPool.java:582)  Caused by: java.lang.IndexOutOfBoundsException        at java.io.StringReader.\nread(StringReader.java:76)      at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.zzRefill(ExtendedWhitespace\nTokenizerImpl.java:557)         at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.getNextToken(ExtendedWhites\npaceTokenizerImpl\n    [junit]\n    [junit] Carrot2 clustering failed  org.apache.solr.common.SolrException: Carrot2 clustering failed          at org.a\npache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(CarrotClusteringEngine.java:110)   at org.apache.so\nlr.handler.clustering.ClusteringComponent.finishStage(ClusteringComponent.java:167)     at org.apache.solr.handler.compo\nnent.SearchHandler.handleRequestBody(SearchHandler.java:336)    at org.apache.solr.handler.RequestHandlerBase.handleRequ\nest(RequestHandlerBase.java:129)        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1296)    at org.apache.so\nlr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:338)      at org.apache.solr.servlet.SolrDispatchFilter.do\nFilter(SolrDispatchFilter.java:240)     at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.\njava:1212)      at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:399)     at org.mortbay.jetty.ser\nvlet.SessionHandler.handle(SessionHandler.java:182)     at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandle\nr.java:766)     at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)     at org.mortbay.jetty.Ser\nver.handle(Server.java:326)     at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542)      at org.m\nortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:928)      at org.mortbay.jetty.HttpParser.\nparseNext(HttpParser.java:549)          at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:212)     at org.m\nortbay.jetty.HttpConnection.handle(HttpConnection.java:404)     at org.mortbay.jetty.bio.SocketConnector$Connection.run(\nSocketConnector.java:228)       at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)  Caused\n by: java.lang.IndexOutOfBoundsException        at java.io.StringReader.read(StringReader.java:76)      at org.carrot2.t\next.analysis.ExtendedWhitespaceTokenizerImpl.zzRefill(ExtendedWhitespaceTokenizerImpl.java:557)     at org.carrot2.text.\nanalysis.ExtendedWhitespaceTokenizerImpl.getNextToken(ExtendedWhitespaceTokenizerImpl\n    [junit]\n    [junit] request: http://localhost:65510/solr/select?clustering=true&q=*:*&sort=id desc&clustering.results=true&shard\ns=localhost:65509/solr,[::1]:33332/solr|localhost:65510/solr&wt=javabin&version=2\n    [junit]     at org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:435)\n    [junit]     at org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:244)\n    [junit]     at org.apache.solr.client.solrj.request.QueryRequest.process(QueryRequest.java:89)\n    [junit]     ... 2 more\n    [junit] *** Thread: Thread-27 ***\n    [junit] java.lang.RuntimeException: org.apache.solr.client.solrj.SolrServerException: Error executing query\n    [junit]     at org.apache.solr.BaseDistributedSearchTestCase$5.run(BaseDistributedSearchTestCase.java:333)\n    [junit] Caused by: org.apache.solr.client.solrj.SolrServerException: Error executing query\n    [junit]     at org.apache.solr.client.solrj.request.QueryRequest.process(QueryRequest.java:95)\n    [junit]     at org.apache.solr.client.solrj.SolrServer.query(SolrServer.java:119)\n    [junit]     at org.apache.solr.BaseDistributedSearchTestCase$5.run(BaseDistributedSearchTestCase.java:328)\n    [junit] Caused by: org.apache.solr.common.SolrException: Carrot2 clustering failed  org.apache.solr.common.SolrExcep\ntion: Carrot2 clustering failed         at org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(Car\nrotClusteringEngine.java:110)   at org.apache.solr.handler.clustering.ClusteringComponent.finishStage(ClusteringComponen\nt.java:167)     at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:336)    at org.a\npache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)        at org.apache.solr.core.SolrCore\n.execute(SolrCore.java:1296)    at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:338)\nat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:240)     at org.mortbay.jetty.servlet.Ser\nvletHandler$CachedChain.doFilter(ServletHandler.java:1212)      at org.mortbay.jetty.servlet.ServletHandler.handle(Servl\netHandler.java:399)     at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182)     at org.mortbay.j\netty.handler.ContextHandler.handle(ContextHandler.java:766)     at org.mortbay.jetty.handler.HandlerWrapper.handle(Handl\nerWrapper.java:152)     at org.mortbay.jetty.Server.handle(Server.java:326)     at org.mortbay.jetty.HttpConnection.hand\nleRequest(HttpConnection.java:542)      at org.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection\n.java:928)      at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:549)          at org.mortbay.jetty.HttpParser.\nparseAvailable(HttpParser.java:212)     at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404)     at org.m\nortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:228)       at org.mortbay.thread.QueuedThreadPool$P\noolThread.run(QueuedThreadPool.java:582)  Caused by: java.lang.IndexOutOfBoundsException        at java.io.StringReader.\nread(StringReader.java:76)      at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.zzRefill(ExtendedWhitespace\nTokenizerImpl.java:557)         at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.getNextToken(ExtendedWhites\npaceTokenizerImpl\n    [junit]\n    [junit] Carrot2 clustering failed  org.apache.solr.common.SolrException: Carrot2 clustering failed          at org.a\npache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(CarrotClusteringEngine.java:110)   at org.apache.so\nlr.handler.clustering.ClusteringComponent.finishStage(ClusteringComponent.java:167)     at org.apache.solr.handler.compo\nnent.SearchHandler.handleRequestBody(SearchHandler.java:336)    at org.apache.solr.handler.RequestHandlerBase.handleRequ\nest(RequestHandlerBase.java:129)        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1296)    at org.apache.so\nlr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:338)      at org.apache.solr.servlet.SolrDispatchFilter.do\nFilter(SolrDispatchFilter.java:240)     at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.\njava:1212)      at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:399)     at org.mortbay.jetty.ser\nvlet.SessionHandler.handle(SessionHandler.java:182)     at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandle\nr.java:766)     at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)     at org.mortbay.jetty.Ser\nver.handle(Server.java:326)     at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542)      at org.m\nortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:928)      at org.mortbay.jetty.HttpParser.\nparseNext(HttpParser.java:549)          at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:212)     at org.m\nortbay.jetty.HttpConnection.handle(HttpConnection.java:404)     at org.mortbay.jetty.bio.SocketConnector$Connection.run(\nSocketConnector.java:228)       at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)  Caused\n by: java.lang.IndexOutOfBoundsException        at java.io.StringReader.read(StringReader.java:76)      at org.carrot2.t\next.analysis.ExtendedWhitespaceTokenizerImpl.zzRefill(ExtendedWhitespaceTokenizerImpl.java:557)     at org.carrot2.text.\nanalysis.ExtendedWhitespaceTokenizerImpl.getNextToken(ExtendedWhitespaceTokenizerImpl\n    [junit]\n    [junit] request: http://localhost:65510/solr/select?clustering=true&q=*:*&sort=id desc&clustering.results=true&shards=localhost:65509/solr,[::1]:33332/solr|localhost:65510/solr&wt=javabin&version=2\n    [junit]     at org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:435)\n    [junit]     at org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:244)\n    [junit]     at org.apache.solr.client.solrj.request.QueryRequest.process(QueryRequest.java:89)\n    [junit]     ... 2 more\n    [junit] WARNING: test class left thread running: Thread[MultiThreadedHttpConnectionManager cleanup,5,main]\n    [junit] WARNING: test class left thread running: Thread[pool-5-thread-1,5,main]\n    [junit] WARNING: test class left thread running: Thread[pool-5-thread-2,5,main]\n    [junit] WARNING: test class left thread running: Thread[pool-5-thread-3,5,main]\n    [junit] WARNING: test class left thread running: Thread[pool-6-thread-1,5,main]\n    [junit] RESOURCE LEAK: test class left 5 thread(s) running\n    [junit] NOTE: test params are: codec=PreFlex, locale=zh, timezone=America/Indiana/Vincennes\n    [junit] NOTE: all tests run in this JVM:\n    [junit] [DistributedClusteringComponentTest]\n    [junit] NOTE: Windows Vista 6.0 x86/Sun Microsystems Inc. 1.6.0_23 (32-bit)/cpus=4,threads=4,free=5267640,total=16384000\n    [junit] ------------- ---------------- ---------------\n    [junit]\n    [junit] Testcase: testDistribSearch took 6.559 sec\n    [junit]     FAILED\n    [junit] Some threads threw uncaught exceptions!\n    [junit] junit.framework.AssertionFailedError: Some threads threw uncaught exceptions!\n    [junit]     at org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1127)\n    [junit]     at org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1059)\n    [junit]     at org.apache.lucene.util.LuceneTestCase.tearDown(LuceneTestCase.java:511)\n    [junit]     at org.apache.solr.SolrTestCaseJ4.tearDown(SolrTestCaseJ4.java:81)\n    [junit]     at org.apache.solr.BaseDistributedSearchTestCase.tearDown(BaseDistributedSearchTestCase.java:153)\n    [junit]\n    [junit] Test org.apache.solr.handler.clustering.DistributedClusteringComponentTest FAILED\n\nBUILD FAILED\n\n "
        },
        {
            "author": "Stanislaw Osinski",
            "id": "comment-12981191",
            "date": "2011-01-13T09:32:17+0000",
            "content": "Robert: I was using the random seed from the build result in the hope that it will fail the test for me. I'm still unable to get the exception though, with or without the seed. I suppose it shouldn't matter whether I run the complete test suite or just this one test method? (I was doing the latter to save time)\n\nIf you have a spare moment, would you be able check the following two things on your machine:\n\n1. Apply the attached diagnostics patch and run the tests. If the test doesn't fail after the change, this means there's some concurrency issue in Carrot2's internal resource pooling mechanisms that we'll need to find. This patch is not a solution to the problem though, just a diagnostic measure.\n\n2. It's paranoid, but can you run the test with the -Dargs=-XX:+TraceClassLoading option and check that there's no old (v3.4.0) Carrot2 JAR hiding in the bushes? Version 3.4.0 had a subtle bug that could be causing the exception. If there's no traces of Carrot2 3.4.0 JAR in the classpath, we'll need to do further inspection of our code. "
        },
        {
            "author": "Robert Muir",
            "id": "comment-12981237",
            "date": "2011-01-13T13:04:57+0000",
            "content": "Robert: I was using the random seed from the build result in the hope that it will fail the test for me. I'm still unable to get the exception though, with or without the seed. I suppose it shouldn't matter whether I run the complete test suite or just this one test method? (I was doing the latter to save time)\n\nwell, its not completely consistent even with the seed to me (smells like a concurrency issue).\n\nSilly question, but did you remove the @Ignore on DistributedClusteringComponentTest?\nOtherwise, the reproducibility problem could be that it doesn't consistently fail every time, even with the same seed.\n\nI ran my previous fail three times, with the patch: \n\nant test -Dtestcase=DistributedClusteringComponentTest -Dtestmethod=testDistribSearch -Dtests.seed=8909233178291932652:-4859244606911873252\n\n\n\nThis failed two out of three times.\n\nI also then ran it with traceclassloading, logging to a file:\n\nant test -Dtestcase=DistributedClusteringComponentTest -Dtestmethod=testDistribSearch -Dtests.seed=8909233178291932652:-4859244606911873252 -Dargs=\"-XX:+TraceClassLoading\" > test.out\n\n\n\nall the carrot classes are being loaded from solr/contrib/clustering/lib/carrot2-core-3.4.2.jar "
        },
        {
            "author": "Stanislaw Osinski",
            "id": "comment-12981241",
            "date": "2011-01-13T13:23:30+0000",
            "content": "\nwell, its not completely consistent even with the seed to me (smells like a concurrency issue).\n\nThis is what I've been suspecting from the beginning, I hope Dawid gets better luck at reproducing the problem on his 4-core HT machine.\n\n\nSilly question, but did you remove the @Ignore on DistributedClusteringComponentTest?\nOtherwise, the reproducibility problem could be that it doesn't consistently fail every time, even with the same seed.\n\nYeah, I did remove the @Ignore, I'm getting \"Testsuite: org.apache.solr.handler.clustering.DistributedClusteringComponentTest, Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 59,658 sec\" in the test results dir. When it comes to reproducibility, I wasn't able to reproduce some other concurrency issue on my 2-core machine, while on Dawid's 4-core hardware the tests would fail sometimes, so I hope we can eventually get the exception locally.\n\n\nI ran my previous fail three times, with the patch. This failed two out of three times.\n\nThanks for verifying this! It looks like the bug may be at some other place in C2 code than I initially thought. Let us review the code once again, as soon as we come up with the fix, I'll attach a patch. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-12981453",
            "date": "2011-01-13T20:09:15+0000",
            "content": "I confirm this must be something related to concurrency, although from whitebox code review I have no clue how this can happen. Seems like a long, fascinating weekend is waiting for me (I am busy tomorrow and won't be able to look into it). What is weird is that we're running this code on our demo server, we do have parallel stress tests and still this happens only here. Life.\n\n\ntest:\n    [junit] Testsuite: org.apache.solr.handler.clustering.DistributedClusteringComponentTest\n    [junit] Tests run: 1, Failures: 1, Errors: 0, Time elapsed: 12.311 sec\n    [junit] ------------- Standard Error -----------------\n    [junit] 2011-1-13 20:05:39 org.apache.solr.common.SolrException log\n    [junit] SEVERE: java.lang.Error: Error: could not match input\n    [junit]     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.zzScanError(ExtendedWhitespaceTokenizerImpl.java:687)\n    [junit]     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.getNextToken(ExtendedWhitespaceTokenizerImpl.java:836)\n    [junit]     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizer.nextToken(ExtendedWhitespaceTokenizer.java:46)\n    [junit]     at org.carrot2.text.preprocessing.Tokenizer.tokenize(Tokenizer.java:147)\n    [junit]     at org.carrot2.text.preprocessing.pipeline.CompletePreprocessingPipeline.preprocess(CompletePreprocessingPipeline.java:54)\n    [junit]     at org.carrot2.text.preprocessing.pipeline.BasicPreprocessingPipeline.preprocess(BasicPreprocessingPipeline.java:92)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.cluster(LingoClusteringAlgorithm.java:198)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.access$000(LingoClusteringAlgorithm.java:43)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm$1.process(LingoClusteringAlgorithm.java:177)\n    [junit]     at org.carrot2.text.clustering.MultilingualClustering.clusterByLanguage(MultilingualClustering.java:223)\n    [junit]     at org.carrot2.text.clustering.MultilingualClustering.process(MultilingualClustering.java:111)\n    [junit]     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.process(LingoClusteringAlgorithm.java:170)\n    [junit]     at org.carrot2.core.ControllerUtils.performProcessing(ControllerUtils.java:102)\n    [junit]     at org.carrot2.core.Controller.process(Controller.java:347)\n    [junit]     at org.carrot2.core.Controller.process(Controller.java:239)\n    [junit]     at org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(CarrotClusteringEngine.java:106)\n    [junit]     at org.apache.solr.handler.clustering.ClusteringComponent.finishStage(ClusteringComponent.java:167)\n    [junit]     at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:336)\n    [junit]     at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n    [junit]     at org.apache.solr.core.SolrCore.execute(SolrCore.java:1296)\n    [junit]     at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:338)\n    [junit]     at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:240)\n    [junit]     at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1212)\n    [junit]     at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:399)\n    [junit]     at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182)\n    [junit]     at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:766)\n    [junit]     at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)\n    [junit]     at org.mortbay.jetty.Server.handle(Server.java:326)\n    [junit]     at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542)\n    [junit]     at org.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:928)\n    [junit]     at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:549)\n    [junit]     at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:212)\n    [junit]     at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404)\n    [junit]     at org.mortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:228)\n    [junit]     at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)\n    [junit]\n    [junit] NOTE: reproduce with: ant test -Dtestcase=DistributedClusteringComponentTest -Dtestmethod=testDistribSearch -Dtests.seed=8909233178291932652:-485924\n4606911873252\n    [junit] The following exceptions were thrown by threads:\n    [junit] *** Thread: Thread-28 ***\n    [junit] junit.framework.AssertionFailedError: .clusters.length:4!=5\n    [junit]     at junit.framework.Assert.fail(Assert.java:47)\n    [junit]     at org.apache.solr.BaseDistributedSearchTestCase.compareResponses(BaseDistributedSearchTestCase.java:562)\n    [junit]     at org.apache.solr.BaseDistributedSearchTestCase$5.run(BaseDistributedSearchTestCase.java:330)\n    [junit] *** Thread: Thread-27 ***\n    [junit] java.lang.RuntimeException: org.apache.solr.client.solrj.SolrServerException: Error executing query\n    [junit]     at org.apache.solr.BaseDistributedSearchTestCase$5.run(BaseDistributedSearchTestCase.java:333)\n    [junit] Caused by: org.apache.solr.client.solrj.SolrServerException: Error executing query\n    [junit]     at org.apache.solr.client.solrj.request.QueryRequest.process(QueryRequest.java:95)\n    [junit]     at org.apache.solr.client.solrj.SolrServer.query(SolrServer.java:119)\n    [junit]     at org.apache.solr.BaseDistributedSearchTestCase$5.run(BaseDistributedSearchTestCase.java:328)\n    [junit] Caused by: org.apache.solr.common.SolrException: Error: could not match input  java.lang.Error: Error: could not match input        at org.carrot2.t\next.analysis.ExtendedWhitespaceTokenizerImpl.zzScanError(ExtendedWhitespaceTokenizerImpl.java:687)      at org.carrot2.text.analysis.ExtendedWhitespaceTokenizer\nImpl.getNextToken(ExtendedWhitespaceTokenizerImpl.java:836)     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizer.nextToken(ExtendedWhitespaceTokenizer.j\nava:46)         at org.carrot2.text.preprocessing.Tokenizer.tokenize(Tokenizer.java:147)        at org.carrot2.text.preprocessing.pipeline.CompletePreprocessing\nPipeline.preprocess(CompletePreprocessingPipeline.java:54)      at org.carrot2.text.preprocessing.pipeline.BasicPreprocessingPipeline.preprocess(BasicPreprocess\ningPipeline.java:92)    at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.cluster(LingoClusteringAlgorithm.java:198)     at org.carrot2.clustering.lingo.\nLingoClusteringAlgorithm.access$000(LingoClusteringAlgorithm.java:43)   at org.carrot2.clustering.lingo.LingoClusteringAlgorithm$1.process(LingoClusteringAlgori\nthm.java:177)   at org.carrot2.text.clustering.MultilingualClustering.clusterByLanguage(MultilingualClustering.java:223)        at org.carrot2.text.clustering.M\nultilingualClustering.process(MultilingualClustering.java:111)          at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.process(LingoClusteringAlgorith\nm.java:170)     at org.carrot2.core.ControllerUtils.performProcessing(ControllerUtils.java:102)     at org.carrot2.core.Controller.process(Controller.java:347)\n        at org.carrot2.core.Controller.process(Controller.java:239)     at org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(CarrotClust\neringEngine.java:106)   at org.apache.solr.handler.clustering.ClusteringComponent.finishStage(ClusteringComponent.java:167)     at org.apache.solr.handler.compo\nnent.SearchHandler.handleRequestBody(SearchHandler.java:336)    at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\nat org.apache.solr.core.SolrCore.execute(SolrCore.java:1296)    at org.apache.solr.servle\n    [junit]\n    [junit] Error: could not match input  java.lang.Error: Error: could not match input         at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.zzS\ncanError(ExtendedWhitespaceTokenizerImpl.java:687)      at org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.getNextToken(ExtendedWhitespaceTokenizerImp\nl.java:836)     at org.carrot2.text.analysis.ExtendedWhitespaceTokenizer.nextToken(ExtendedWhitespaceTokenizer.java:46)         at org.carrot2.text.preprocessin\ng.Tokenizer.tokenize(Tokenizer.java:147)        at org.carrot2.text.preprocessing.pipeline.CompletePreprocessingPipeline.preprocess(CompletePreprocessingPipelin\ne.java:54)      at org.carrot2.text.preprocessing.pipeline.BasicPreprocessingPipeline.preprocess(BasicPreprocessingPipeline.java:92)    at org.carrot2.clusterin\ng.lingo.LingoClusteringAlgorithm.cluster(LingoClusteringAlgorithm.java:198)     at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.access$000(LingoCluster\ningAlgorithm.java:43)   at org.carrot2.clustering.lingo.LingoClusteringAlgorithm$1.process(LingoClusteringAlgorithm.java:177)   at org.carrot2.text.clustering.M\nultilingualClustering.clusterByLanguage(MultilingualClustering.java:223)        at org.carrot2.text.clustering.MultilingualClustering.process(MultilingualCluste\nring.java:111)          at org.carrot2.clustering.lingo.LingoClusteringAlgorithm.process(LingoClusteringAlgorithm.java:170)     at org.carrot2.core.ControllerUt\nils.performProcessing(ControllerUtils.java:102)         at org.carrot2.core.Controller.process(Controller.java:347)     at org.carrot2.core.Controller.process(C\nontroller.java:239)     at org.apache.solr.handler.clustering.carrot2.CarrotClusteringEngine.cluster(CarrotClusteringEngine.java:106)   at org.apache.solr.handl\ner.clustering.ClusteringComponent.finishStage(ClusteringComponent.java:167)     at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandl\ner.java:336)    at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)        at org.apache.solr.core.SolrCore.execute(SolrCor\ne.java:1296)    at org.apache.solr.servle\n    [junit]\n    [junit] request: http://localhost:1550/solr/select?clustering=true&q=*:*&sort=id desc&clustering.results=true&shards=localhost:1549/solr,[::1]:33332/solr|lo\ncalhost:1550/solr&wt=javabin&version=2\n    [junit]     at org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:435)\n    [junit]     at org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:244)\n    [junit]     at org.apache.solr.client.solrj.request.QueryRequest.process(QueryRequest.java:89)\n    [junit]     ... 2 more\n    [junit] WARNING: test class left thread running: Thread[MultiThreadedHttpConnectionManager cleanup,5,main]\n    [junit] WARNING: test class left thread running: Thread[pool-5-thread-1,5,main]\n    [junit] WARNING: test class left thread running: Thread[pool-5-thread-2,5,main]\n    [junit] WARNING: test class left thread running: Thread[pool-6-thread-1,5,main]\n    [junit] RESOURCE LEAK: test class left 4 thread(s) running\n    [junit] NOTE: test params are: codec=PreFlex, locale=zh, timezone=Europe/London\n    [junit] NOTE: all tests run in this JVM:\n    [junit] [DistributedClusteringComponentTest]\n    [junit] NOTE: Windows 7 6.1 amd64/Sun Microsystems Inc. 1.6.0_20 (64-bit)/cpus=8,threads=4,free=129024280,total=219873280\n\n "
        },
        {
            "author": "Robert Muir",
            "id": "comment-12981501",
            "date": "2011-01-13T21:49:55+0000",
            "content": "Guys, thanks for the debugging help already.\n\nJust as a side note: for these tricky non-reproducible ones, sometimes its helpful to use something like -Dtests.iter=10 \nits just a convenient way to run the test method multiple times. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-12981651",
            "date": "2011-01-14T07:19:00+0000",
            "content": "This tests.iter is exactly what I will need  I'll most likely weave a runtime aspect into the code to verify when two threads enter the same critical section. Again, from whitebox review it seems impossible, but then actually detecting and fixing impossible things are what we love in our profession...  "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-12982061",
            "date": "2011-01-15T10:44:55+0000",
            "content": "I think I nailed it. I did whitebox-inspect Carrot2 code and thought it impossible for a concurrency bug to creep in (in particular with a simple controller), but what we didn't take into account is that Carrot2 infrastructure itself allows a scenario in which a single object instance is bound to multiple components at runtime (and is then effectively shared in a multi threaded context). This code happens to be in Solr's code base, not in Carrot2. The bug happens because of the following series of events:\n\n1) The controller in Solr itself is initialized with a single instance of \"new LuceneLanguageModelFactory()\" \u2013 this factory is then injected into all components at runtime.\n2) The base class of LuceneLanguageModelFactory is DefaultLanguageModelFactory which has an object-local cache of stemmers and tokenizers. In Carrot2 3.4.2, factories are component-bound anyway, so a factory can reuse its resources. In the trunk version, this is no longer the case (factories simply create new objects as they are requested).\n3) Because of the tokenizers/stemmers cache, tokenizers and stemmers can be used in parallel when two requests are made at the same time. I think this should be fairly repeatable on all computers, regardless of the number of cores/speed, it's just a matter of time. Clustering is relatively longer than tokenization, so for two tokenizations to overlap (and screw up internal data structures) is a rare event (and yet, as we could see, frequent enough to manifest itself during tests).\n\n\n    // Customize the language model factory. The implementation we provide here\n    // is included in the code base of Solr, so that it's possible to refactor\n    // the Lucene APIs the factory relies on if needed.\n    initAttributes.put(\"PreprocessingPipeline.languageModelFactory\",\n      new LuceneLanguageModelFactory());\n    this.controller.init(initAttributes);\n\n\n\nThe fix for the problem would be to:\n\n1) upgrade to trunk/future Carrot2 version (because of different memory management in factories),\n2) pass a class instead of an instance to the initialization parameters. So this should do:\n\n\n    // Customize the language model factory. The implementation we provide here\n    // is included in the code base of Solr, so that it's possible to refactor\n    // the Lucene APIs the factory relies on if needed.\n    initAttributes.put(\"PreprocessingPipeline.languageModelFactory\",\n      LuceneLanguageModelFactory.class);\n    this.controller.init(initAttributes);\n\n\n\nWorks on my machine  But I'll let Staszek review this again so that we're sure it's really this.\n "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-12982062",
            "date": "2011-01-15T10:48:51+0000",
            "content": "One more side comment for those interested. I used my favorite technique for debugging such things \u2013 created another project in Eclipse (AspectJ-enabled), created a runtime weaving launch config in Eclipse that started that particular test, wrote this aspect:\n\n\npackage com.carrotsearch.aspects;\n\nimport java.util.HashMap;\n\n/**\n * Check for multithreaded access in supposedly single-threaded objects.\n */\npublic aspect Solr2282\n{\n    pointcut guardedMethods() :\n        execution(* org.carrot2.text.analysis.ExtendedWhitespaceTokenizerImpl.*(..));\n\n    private HashMap<Object, Thread> t = new HashMap<Object, Thread>();\n    \n    Object around() : guardedMethods()\n    {\n        Object tokenizer = thisJoinPoint.getThis();\n        Thread current = Thread.currentThread();\n        try {\n            synchronized (Solr2282.class) {\n                Thread owner = t.get(tokenizer);\n                if (owner != null && owner != current)\n                    halt();\n                t.put(tokenizer, current);\n            }\n\n            return proceed();\n        } catch (Throwable e) {\n            halt();\n            return null;\n        } finally {\n            synchronized (Solr2282.class) {\n                Thread owner = t.get(tokenizer);\n                if (owner != null && owner != current)\n                    halt();\n                t.remove(tokenizer);\n            }\n        }\n    }\n\n    private void halt()\n    {\n        System.out.println(\"## HALT! \");\n    }\n}\n\n\n\nand placed a VM-halting breakpoint in sysout inside halt()... Once I got two threads running on the same tokenizer instance, it was a matter of inspecting which objects are shared and how this could possibly happen. \n\nAspect-oriented programming never really won me, but as a debugging/ performance analysis tool it simply rocks. "
        },
        {
            "author": "Stanislaw Osinski",
            "id": "comment-12982105",
            "date": "2011-01-15T14:33:03+0000",
            "content": "Thanks for debugging this, Dawid! I think solution 2) you suggested would be the best because it applies both to version 3.4.2 of Carrot2 (currently used by Solr) and the 3.5.0 version (not yet released).\n\nI'm attaching patches for Solr trunk and branch_3x that fix the concurrency issue and correct a typo in a log message output by LuceneLanguageModelFactory. "
        },
        {
            "author": "Robert Muir",
            "id": "comment-12982114",
            "date": "2011-01-15T15:14:26+0000",
            "content": "Thanks a lot for tracking this one down... I tested the patch over here and didn't have any test fails.\n\n+1 from me to commit the patch and enable the distributed test "
        },
        {
            "author": "Koji Sekiguchi",
            "id": "comment-12982192",
            "date": "2011-01-16T00:29:53+0000",
            "content": "Thanks everyone!\n\ntrunk: Committed revision 1059426.\n3x: Committed revision 1059428. "
        },
        {
            "author": "Grant Ingersoll",
            "id": "comment-13013100",
            "date": "2011-03-30T15:45:32+0000",
            "content": "Bulk close for 3.1.0 release "
        }
    ]
}