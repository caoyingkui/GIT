{
    "id": "SOLR-166",
    "title": "trunk requires solr.solr.home set even if JNDI is set",
    "details": {
        "affect_versions": "1.2",
        "status": "Closed",
        "fix_versions": [
            "1.2"
        ],
        "components": [],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Fixed"
    },
    "description": "The current trunk requires the solr.solr.home property to be set - even if JNDI is configured properly.  \n\nI think this is because SolrServlet loads before SolrDispatchFilter and calls SolrCore.getSolrCore();\n\nis there a way to make sure SolrDispatchFilter gets initalized first?",
    "attachments": {
        "SOLR-166-InitalizationOrder.patch": "https://issues.apache.org/jira/secure/attachment/12351544/SOLR-166-InitalizationOrder.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "author": "Ryan McKinley",
            "id": "comment-12474296",
            "date": "2007-02-19T22:14:01+0000",
            "content": "running resin on winXP from cwd: c:/tmp\n\nresin.conf:\n\n\n      <web-app id=\"/solr\" character-encoding=\"utf-8\"\n        document-directory=\"C:/workspace/solr-clean/example/webapps/solr\" \n              archive-path=\"C:/workspace/solr-clean/example/webapps/solr.war\">\n\t    <env-entry>\n\t      <env-entry-name>solr/home</env-entry-name>\n\t      <env-entry-type>java.lang.String</env-entry-type>\n\t      <env-entry-value>C:/workspace/solr-clean/example/solr</env-entry-value>\n\t    </env-entry>\n\t  </web-app>\n\n\nwhen i run, i get:\n\nStarting Resin on Mon, 19 Feb 2007 14:05:42 -0800 (PST)\n\n[14:05:43.343] Server[] starting\n[14:05:43.343] \n[14:05:43.343] Windows XP 5.1 x86\n[14:05:43.343] Java 1.5.0_07-b03, 32, mixed mode, Cp1252, en, Sun Microsystems Inc.\n[14:05:43.343] resin.home = null\n[14:05:43.343] server.root = null\n[14:05:43.343] \n[14:05:43.390] http listening to *:8080\n[14:05:43.421] Host[] starting\n[14:05:43.906] WebApphttp://localhost:8080/solr starting\n[14:05:43.937] SolrServer: init\n[14:05:43.937] SolrServlet.init()\n[14:05:44.000] Solr home defaulted to 'solr/' (system property solr.solr.home not set)\n[14:05:44.015] java.lang.ExceptionInInitializerError\n[14:05:44.015] \tat org.apache.solr.update.SolrIndexConfig.<clinit>(SolrIndexConfig.java:36)\n[14:05:44.015] \tat org.apache.solr.core.SolrCore.<clinit>(SolrCore.java:73)\n[14:05:44.015] \tat org.apache.solr.servlet.SolrServlet.init(SolrServlet.java:48)\n[14:05:44.015] \tat javax.servlet.GenericServlet.init(GenericServlet.java:69)\n[14:05:44.015] \tat com.caucho.server.dispatch.ServletConfigImpl.createServletImpl(ServletConfigImpl.java:646)\n[14:05:44.015] \tat com.caucho.server.dispatch.ServletConfigImpl.createServlet(ServletConfigImpl.java:587)\n[14:05:44.015] \tat com.caucho.server.dispatch.ServletManager.init(ServletManager.java:154)\n[14:05:44.015] \tat com.caucho.server.webapp.Application.start(Application.java:1654)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.startImpl(DeployController.java:621)\n[14:05:44.015] \tat com.caucho.server.deploy.StartAutoRedeployAutoStrategy.startOnInit(StartAutoRedeployAutoStrategy.java:72)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.startOnInit(DeployController.java:509)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployContainer.start(DeployContainer.java:153)\n[14:05:44.015] \tat com.caucho.server.webapp.ApplicationContainer.start(ApplicationContainer.java:670)\n[14:05:44.015] \tat com.caucho.server.host.Host.start(Host.java:420)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.startImpl(DeployController.java:621)\n[14:05:44.015] \tat com.caucho.server.deploy.StartAutoRedeployAutoStrategy.startOnInit(StartAutoRedeployAutoStrategy.java:72)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.startOnInit(DeployController.java:509)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployContainer.start(DeployContainer.java:153)\n[14:05:44.015] \tat com.caucho.server.host.HostContainer.start(HostContainer.java:504)\n[14:05:44.015] \tat com.caucho.server.resin.ServletServer.start(ServletServer.java:971)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.startImpl(DeployController.java:621)\n[14:05:44.015] \tat com.caucho.server.deploy.AbstractDeployControllerStrategy.start(AbstractDeployControllerStrategy.java:56)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.start(DeployController.java:517)\n[14:05:44.015] \tat com.caucho.server.resin.ResinServer.start(ResinServer.java:546)\n[14:05:44.015] \tat com.caucho.server.resin.Resin.init(Resin.java)\n[14:05:44.015] \tat com.caucho.server.resin.Resin.main(Resin.java:625)\n[14:05:44.015] \tat com.caucho.server.http.ResinServer.main(ResinServer.java:61)\n[14:05:44.015] Caused by: java.lang.RuntimeException: Error in solrconfig.xml\n[14:05:44.015] \tat org.apache.solr.core.SolrConfig.<clinit>(SolrConfig.java:82)\n[14:05:44.015] \t... 27 more\n[14:05:44.015] Caused by: java.lang.RuntimeException: Can't find resource 'solrconfig.xml' in classpath or 'solr/conf/', cwd=C:\\tmp\n[14:05:44.015] \tat org.apache.solr.core.Config.openResource(Config.java:324)\n[14:05:44.015] \tat org.apache.solr.core.SolrConfig.initConfig(SolrConfig.java:72)\n[14:05:44.015] \tat org.apache.solr.core.SolrConfig.<clinit>(SolrConfig.java:80)\n[14:05:44.015] \t... 27 more\n[14:05:44.015] javax.servlet.ServletException: java.lang.ExceptionInInitializerError\n[14:05:44.015] \tat com.caucho.server.dispatch.ServletConfigImpl.createServlet(ServletConfigImpl.java:618)\n[14:05:44.015] \tat com.caucho.server.dispatch.ServletManager.init(ServletManager.java:154)\n[14:05:44.015] \tat com.caucho.server.webapp.Application.start(Application.java:1654)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.startImpl(DeployController.java:621)\n[14:05:44.015] \tat com.caucho.server.deploy.StartAutoRedeployAutoStrategy.startOnInit(StartAutoRedeployAutoStrategy.java:72)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.startOnInit(DeployController.java:509)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployContainer.start(DeployContainer.java:153)\n[14:05:44.015] \tat com.caucho.server.webapp.ApplicationContainer.start(ApplicationContainer.java:670)\n[14:05:44.015] \tat com.caucho.server.host.Host.start(Host.java:420)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.startImpl(DeployController.java:621)\n[14:05:44.015] \tat com.caucho.server.deploy.StartAutoRedeployAutoStrategy.startOnInit(StartAutoRedeployAutoStrategy.java:72)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.startOnInit(DeployController.java:509)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployContainer.start(DeployContainer.java:153)\n[14:05:44.015] \tat com.caucho.server.host.HostContainer.start(HostContainer.java:504)\n[14:05:44.015] \tat com.caucho.server.resin.ServletServer.start(ServletServer.java:971)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.startImpl(DeployController.java:621)\n[14:05:44.015] \tat com.caucho.server.deploy.AbstractDeployControllerStrategy.start(AbstractDeployControllerStrategy.java:56)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.start(DeployController.java:517)\n[14:05:44.015] \tat com.caucho.server.resin.ResinServer.start(ResinServer.java:546)\n[14:05:44.015] \tat com.caucho.server.resin.Resin.init(Resin.java)\n[14:05:44.015] \tat com.caucho.server.resin.Resin.main(Resin.java:625)\n[14:05:44.015] \tat com.caucho.server.http.ResinServer.main(ResinServer.java:61)\n[14:05:44.015] Caused by: java.lang.ExceptionInInitializerError\n[14:05:44.015] \tat org.apache.solr.update.SolrIndexConfig.<clinit>(SolrIndexConfig.java:36)\n[14:05:44.015] \tat org.apache.solr.core.SolrCore.<clinit>(SolrCore.java:73)\n[14:05:44.015] \tat org.apache.solr.servlet.SolrServlet.init(SolrServlet.java:48)\n[14:05:44.015] \tat javax.servlet.GenericServlet.init(GenericServlet.java:69)\n[14:05:44.015] \tat com.caucho.server.dispatch.ServletConfigImpl.createServletImpl(ServletConfigImpl.java:646)\n[14:05:44.015] \tat com.caucho.server.dispatch.ServletConfigImpl.createServlet(ServletConfigImpl.java:587)\n[14:05:44.015] \t... 21 more\n[14:05:44.015] Caused by: java.lang.RuntimeException: Error in solrconfig.xml\n[14:05:44.015] \tat org.apache.solr.core.SolrConfig.<clinit>(SolrConfig.java:82)\n[14:05:44.015] \t... 27 more\n[14:05:44.015] Caused by: java.lang.RuntimeException: Can't find resource 'solrconfig.xml' in classpath or 'solr/conf/', cwd=C:\\tmp\n[14:05:44.015] \tat org.apache.solr.core.Config.openResource(Config.java:324)\n[14:05:44.015] \tat org.apache.solr.core.SolrConfig.initConfig(SolrConfig.java:72)\n[14:05:44.015] \tat org.apache.solr.core.SolrConfig.<clinit>(SolrConfig.java:80)\n[14:05:44.015] \t... 27 more\n[14:05:44.015] javax.servlet.ServletException: java.lang.ExceptionInInitializerError\n[14:05:44.015] \tat com.caucho.server.dispatch.ServletConfigImpl.createServlet(ServletConfigImpl.java:618)\n[14:05:44.015] \tat com.caucho.server.dispatch.ServletManager.init(ServletManager.java:154)\n[14:05:44.015] \tat com.caucho.server.webapp.Application.start(Application.java:1654)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.startImpl(DeployController.java:621)\n[14:05:44.015] \tat com.caucho.server.deploy.StartAutoRedeployAutoStrategy.startOnInit(StartAutoRedeployAutoStrategy.java:72)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.startOnInit(DeployController.java:509)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployContainer.start(DeployContainer.java:153)\n[14:05:44.015] \tat com.caucho.server.webapp.ApplicationContainer.start(ApplicationContainer.java:670)\n[14:05:44.015] \tat com.caucho.server.host.Host.start(Host.java:420)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.startImpl(DeployController.java:621)\n[14:05:44.015] \tat com.caucho.server.deploy.StartAutoRedeployAutoStrategy.startOnInit(StartAutoRedeployAutoStrategy.java:72)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.startOnInit(DeployController.java:509)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployContainer.start(DeployContainer.java:153)\n[14:05:44.015] \tat com.caucho.server.host.HostContainer.start(HostContainer.java:504)\n[14:05:44.015] \tat com.caucho.server.resin.ServletServer.start(ServletServer.java:971)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.startImpl(DeployController.java:621)\n[14:05:44.015] \tat com.caucho.server.deploy.AbstractDeployControllerStrategy.start(AbstractDeployControllerStrategy.java:56)\n[14:05:44.015] \tat com.caucho.server.deploy.DeployController.start(DeployController.java:517)\n[14:05:44.015] \tat com.caucho.server.resin.ResinServer.start(ResinServer.java:546)\n[14:05:44.015] \tat com.caucho.server.resin.Resin.init(Resin.java)\n[14:05:44.015] \tat com.caucho.server.resin.Resin.main(Resin.java:625)\n[14:05:44.015] \tat com.caucho.server.http.ResinServer.main(ResinServer.java:61)\n[14:05:44.015] Caused by: java.lang.ExceptionInInitializerError\n[14:05:44.015] \tat org.apache.solr.update.SolrIndexConfig.<clinit>(SolrIndexConfig.java:36)\n[14:05:44.015] \tat org.apache.solr.core.SolrCore.<clinit>(SolrCore.java:73)\n[14:05:44.015] \tat org.apache.solr.servlet.SolrServlet.init(SolrServlet.java:48)\n[14:05:44.015] \tat javax.servlet.GenericServlet.init(GenericServlet.java:69)\n[14:05:44.015] \tat com.caucho.server.dispatch.ServletConfigImpl.createServletImpl(ServletConfigImpl.java:646)\n[14:05:44.015] \tat com.caucho.server.dispatch.ServletConfigImpl.createServlet(ServletConfigImpl.java:587)\n[14:05:44.015] \t... 21 more\n[14:05:44.015] Caused by: java.lang.RuntimeException: Error in solrconfig.xml\n[14:05:44.015] \tat org.apache.solr.core.SolrConfig.<clinit>(SolrConfig.java:82)\n[14:05:44.015] \t... 27 more\n[14:05:44.015] Caused by: java.lang.RuntimeException: Can't find resource 'solrconfig.xml' in classpath or 'solr/conf/', cwd=C:\\tmp\n[14:05:44.015] \tat org.apache.solr.core.Config.openResource(Config.java:324)\n[14:05:44.015] \tat org.apache.solr.core.SolrConfig.initConfig(SolrConfig.java:72)\n[14:05:44.015] \tat org.apache.solr.core.SolrConfig.<clinit>(SolrConfig.java:80)\n[14:05:44.015] \t... 27 more\n "
        },
        {
            "author": "Hoss Man",
            "id": "comment-12474300",
            "date": "2007-02-19T22:26:38+0000",
            "content": "load-on-startup in the web.xml is what tells the servlet container which order to load things on startup (if not set, things are loaded on first use)\n\ni have no idea if the servlet spec says all servelets should be loaded before all filters, or if they are in the same \"load pool\"\n\nRyan: can you try setting a low load-on-startup for the dispatch filter (and change the values for hte servlets to be something high) and see if that solves the problem? "
        },
        {
            "author": "Ryan McKinley",
            "id": "comment-12474302",
            "date": "2007-02-19T22:37:44+0000",
            "content": "I don't see anyway to set load-on-startup for filters.  It seems to only work for servlets.  I'm able to fix this problem two ways on resin:\n\n 1. remove \"<load-on-startup>1</load-on-startup>\" from SolrServer servlet\n 2. lazy load core = SolrCore.getSolrCore()\n\nI think 1 is the better option.  Filters are initalized are startup in most servlet containers.  aparently resin first handles the \"load-on-startup\" servlets, then moves on to the filters.  Jetty does the opposite.\n\nNote, the <load-on-startup>2</load-on-startup> for SolrUpdate does not affect anything.  that servlet just punts anyway. "
        },
        {
            "author": "Hoss Man",
            "id": "comment-12474310",
            "date": "2007-02-19T23:30:00+0000",
            "content": "hmmm ... servlet spec 2.4 says that all fitlers should be loaded before any servlets (see p78 in SRV.9.12) ... so unless that's changed between 2.3 nad 2.4 it's a resin bug.\n\nRyan: one thing to try is changing the web.xml to use the 2.4 XSD instead of the 2.3 DTD and see if that forces resin to be compliant about loading the filter first.\n\nin general, i think it's good to load Servlets on startup even if there is no special initialization code they need to run, because it helps validate that the servlet is there on startup, and reduces the request time for the \"first request\" to that servlet because the class is alrready loaded.\n\na third option you didn't mention would be moving all of the setInstanceDir logic using JNDI from the SolrDispatchFilter into Config.getInstanceDir ... off the top of my head i'm not sure why it was ever in the Dispatcher/SolrServlet in the first place.\n\nIn a nutshell, getInstanceDir should check if a dir has been set, if not try JNDI, then system prop, then default to CWD and call setInstanceDir.\n\n\nwhat do you think? "
        },
        {
            "author": "Ryan McKinley",
            "id": "comment-12474314",
            "date": "2007-02-19T23:44:00+0000",
            "content": "\n> Ryan: one thing to try is changing the web.xml to use the 2.4 XSD instead of the 2.3 DTD\n\nno dice.  it must be a resin bug.\n\n> \n> in general, i think it's good to load Servlets on startup even if...\n\nagreed\n\n> \n> In a nutshell, getInstanceDir should check if a dir has been set, if not \n\n1. try JNDI, \n2. system prop, \n3. default to CWD\n\ncall setInstanceDir.\n\n> \n> what do you think?\n\nI like it!  as long as it only attempts the JNDI stuff if does not require extra libraries for a lightweight embedded version.\n "
        },
        {
            "author": "Ryan McKinley",
            "id": "comment-12474319",
            "date": "2007-02-19T23:59:41+0000",
            "content": "quick patch.  it works for me... "
        },
        {
            "author": "Hoss Man",
            "id": "comment-12474331",
            "date": "2007-02-20T01:42:58+0000",
            "content": "commited with two small changes...\n\n1) log any unexpected RuntimeExceptions durring JNDI checks as warnings instead of silently ignoring (expected exceptions when JNDI isn't available are already loged as \"info\")\n\n2) use !isInstanceDirInitalized() instead of testing ==null directly.\n\n\nthanks for finding this and implimenting the fix Ryan "
        },
        {
            "author": "Hoss Man",
            "id": "comment-12589321",
            "date": "2008-04-15T23:44:45+0000",
            "content": "This bug was modified as part of a bulk update using the criteria...\n\n\n\tMarked (\"Resolved\" or \"Closed\") and \"Fixed\"\n\tHad no \"Fix Version\" versions\n\tWas listed in the CHANGES.txt for 1.2\n\n\n\nThe Fix Version for all 39 issues found was set to 1.2, email notification\nwas suppressed to prevent excessive email.\n\nFor a list of all the issues modified, search jira comments for this\n(hopefully) unique string: 20080415hossman2 "
        }
    ]
}