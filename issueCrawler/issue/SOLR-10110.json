{
    "id": "SOLR-10110",
    "title": "SolrCore reload can miss commit hooks if the commit tracker tries to open a new searcher on a closed core.",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "None",
        "resolution": "Unresolved",
        "status": "Open"
    },
    "description": "",
    "attachments": {
        "stdout-2": "https://issues.apache.org/jira/secure/attachment/12851890/stdout-2",
        "stdout": "https://issues.apache.org/jira/secure/attachment/12851889/stdout"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2017-02-09T16:27:37+0000",
            "content": "\n   [junit4]   2> 14356 ERROR (commitScheduler-18-thread-1) [    x:collection1] o.a.s.u.CommitTracker auto commit error...:org.apache.solr.common.SolrException: Error opening new searcher\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.openNewSearcher(SolrCore.java:1994)\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:2114)\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:1851)\n   [junit4]   2> \tat org.apache.solr.update.DirectUpdateHandler2.commit(DirectUpdateHandler2.java:644)\n   [junit4]   2> \tat org.apache.solr.update.CommitTracker.run(CommitTracker.java:217)\n   [junit4]   2> \tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n   [junit4]   2> \tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n   [junit4]   2> \tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)\n   [junit4]   2> \tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)\n   [junit4]   2> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n   [junit4]   2> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:745)\n   [junit4]   2> Caused by: org.apache.solr.common.SolrException: openNewSearcher called on closed core\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.openNewSearcher(SolrCore.java:1981)\n   [junit4]   2> \t... 11 more\n\n\n\n\n   [junit4]   2> NOTE: test params are: codec=CheapBastard, sim=RandomSimilarity(queryNorm=true): {}, locale=bg, timezone=Asia/Kamchatka\n   [junit4]   2> NOTE: Linux 4.8.0-37-generic amd64/Oracle Corporation 1.8.0_121 (64-bit)/cpus=12,threads=1,free=217811792,total=258473984\n   [junit4]   2> NOTE: All tests run in this JVM: [SoftAutoCommitTest]\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=SoftAutoCommitTest -Dtests.seed=6AC5A21713906536 -Dtests.slow=true -Dtests.locale=bg -Dtests.timezone=Asia/Kamchatka -Dtests.asserts=true -Dtests.file.encoding=UTF-8\n   [junit4] ERROR   0.00s | SoftAutoCommitTest (suite) <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError: ObjectTracker found 1 object(s) that were not released!!! [TransactionLog]\n   [junit4]    > org.apache.solr.common.util.ObjectReleaseTracker$ObjectTrackerException\n   [junit4]    > \tat org.apache.solr.common.util.ObjectReleaseTracker.track(ObjectReleaseTracker.java:43)\n   [junit4]    > \tat org.apache.solr.update.TransactionLog.<init>(TransactionLog.java:188)\n   [junit4]    > \tat org.apache.solr.update.UpdateLog.newTransactionLog(UpdateLog.java:442)\n   [junit4]    > \tat org.apache.solr.update.UpdateLog.ensureLog(UpdateLog.java:1101)\n   [junit4]    > \tat org.apache.solr.update.UpdateLog.add(UpdateLog.java:528)\n   [junit4]    > \tat org.apache.solr.update.UpdateLog.add(UpdateLog.java:513)\n   [junit4]    > \tat org.apache.solr.update.DirectUpdateHandler2.doNormalUpdate(DirectUpdateHandler2.java:299)\n   [junit4]    > \tat org.apache.solr.update.DirectUpdateHandler2.addDoc0(DirectUpdateHandler2.java:213)\n   [junit4]    > \tat org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:168)\n   [junit4]    > \tat org.apache.solr.update.processor.RunUpdateProcessor.processAdd(RunUpdateProcessorFactory.java:67)\n   [junit4]    > \tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:48)\n   [junit4]    > \tat org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalAdd(DistributedUpdateProcessor.java:971)\n   [junit4]    > \tat org.apache.solr.update.processor.DistributedUpdateProcessor.versionAdd(DistributedUpdateProcessor.java:1184)\n   [junit4]    > \tat org.apache.solr.update.processor.DistributedUpdateProcessor.processAdd(DistributedUpdateProcessor.java:749)\n   [junit4]    > \tat org.apache.solr.update.processor.LogUpdateProcessorFactory$LogUpdateProcessor.processAdd(LogUpdateProcessorFactory.java:103)\n   [junit4]    > \tat org.apache.solr.handler.loader.XMLLoader.processUpdate(XMLLoader.java:250)\n   [junit4]    > \tat org.apache.solr.handler.loader.XMLLoader.load(XMLLoader.java:177)\n   [junit4]    > \tat org.apache.solr.handler.UpdateRequestHandler$1.load(UpdateRequestHandler.java:97)\n   [junit4]    > \tat org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:68)\n   [junit4]    > \tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:171)\n   [junit4]    > \tat org.apache.solr.core.SolrCore.execute(SolrCore.java:2402)\n   [junit4]    > \tat org.apache.solr.servlet.DirectSolrConnection.request(DirectSolrConnection.java:124)\n   [junit4]    > \tat org.apache.solr.util.TestHarness.update(TestHarness.java:278)\n   [junit4]    > \tat org.apache.solr.util.BaseTestHarness.checkUpdateStatus(BaseTestHarness.java:281)\n   [junit4]    > \tat org.apache.solr.util.BaseTestHarness.validateUpdate(BaseTestHarness.java:251)\n   [junit4]    > \tat org.apache.solr.SolrTestCaseJ4.checkUpdateU(SolrTestCaseJ4.java:811)\n   [junit4]    > \tat org.apache.solr.SolrTestCaseJ4.assertU(SolrTestCaseJ4.java:790)\n   [junit4]    > \tat org.apache.solr.SolrTestCaseJ4.assertU(SolrTestCaseJ4.java:784)\n   [junit4]    > \tat org.apache.solr.update.SoftAutoCommitTest.testSoftAndHardCommitMaxTimeRapidAdds(SoftAutoCommitTest.java:310)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:745)\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([6AC5A21713906536]:0)\n   [junit4]    > \tat org.apache.solr.SolrTestCaseJ4.teardownTestCases(SolrTestCaseJ4.java:289)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:745)\n   [junit4] Completed [1/1 (1!)] in 51.31s, 3 tests, 1 failure <<< FAILURES!\n\n ",
            "author": "Mark Miller",
            "id": "comment-15859747"
        },
        {
            "date": "2017-02-10T00:34:43+0000",
            "content": "I took this reload out of SoftAutoCommitTest. SoftAutoCommitTest is a historically super fragile test and it's unrelated to what this test is trying to test and is both costly to the test (it's simply using it as a reset, but not not a good one at all) and can randomly interfere or not with the test depending on how fast it's searcher opens and loads or behaves against a closing/opening core, or when it's auto commit trackers hit. Removing allows fixing other parts of the test and making it a bit more logical ... and a lot more stable. We can roll back this test temporarily to check the behavior, but we would want something separate from SoftAutoCommitTest and without it's already delicate waits and assertions. ",
            "author": "Mark Miller",
            "id": "comment-15860463"
        }
    ]
}