{
    "id": "SOLR-7062",
    "title": "CLUSTERSTATUS returns a collection with state=active, even though the collection could not be created due to a missing configSet",
    "details": {
        "components": [
            "SolrCloud"
        ],
        "type": "Bug",
        "labels": "",
        "fix_versions": [],
        "affect_versions": "4.10.3",
        "status": "Resolved",
        "resolution": "Cannot Reproduce",
        "priority": "Major"
    },
    "description": "A collection can not be created, if its configSet does not exist. Nevertheless, a subsequent CLUSTERSTATUS CollectionAdminRequest returns this collection with a state=active.\n\nSee log below.\n\n\n[INFO] Overseer Collection Processor: Get the message id:/overseer/collection-queue-work/qn-0000000110 message:{\n  \"operation\":\"createcollection\",\n  \"fromApi\":\"true\",\n  \"name\":\"blueprint_media_comments\",\n  \"collection.configName\":\"elastic\",\n  \"numShards\":\"1\",\n  \"property.dataDir\":\"data\",\n  \"property.instanceDir\":\"cores/blueprint_media_comments\"}\n[WARNING] OverseerCollectionProcessor.processMessage : createcollection , {\n  \"operation\":\"createcollection\",\n  \"fromApi\":\"true\",\n  \"name\":\"blueprint_media_comments\",\n  \"collection.configName\":\"elastic\",\n  \"numShards\":\"1\",\n  \"property.dataDir\":\"data\",\n  \"property.instanceDir\":\"cores/blueprint_media_comments\"}\n[INFO] creating collections conf node /collections/blueprint_media_comments \n[INFO] makePath: /collections/blueprint_media_comments\n[INFO] Got user-level KeeperException when processing sessionid:0x14b315b0f4a000e type:create cxid:0x2f2e zxid:0x2f4 txntype:-1 reqpath:n/a Error Path:/overseer Error:KeeperErrorCode = NodeExists for /overseer\n[INFO] LatchChildWatcher fired on path: /overseer/queue state: SyncConnected type NodeChildrenChanged\n[INFO] building a new collection: blueprint_media_comments\n[INFO] Create collection blueprint_media_comments with shards [shard1]\n[INFO] A cluster state change: WatchedEvent state:SyncConnected type:NodeDataChanged path:/clusterstate.json, has occurred - updating... (live nodes size: 1)\n[INFO] Creating SolrCores for new collection blueprint_media_comments, shardNames [shard1] , replicationFactor : 1\n[INFO] Creating shard blueprint_media_comments_shard1_replica1 as part of slice shard1 of collection blueprint_media_comments on localhost:44080_solr\n[INFO] core create command qt=/admin/cores&property.dataDir=data&collection.configName=elastic&name=blueprint_media_comments_shard1_replica1&action=CREATE&numShards=1&collection=blueprint_media_comments&shard=shard1&wt=javabin&version=2&property.instanceDir=cores/blueprint_media_comments\n[INFO] publishing core=blueprint_media_comments_shard1_replica1 state=down collection=blueprint_media_comments\n[INFO] LatchChildWatcher fired on path: /overseer/queue state: SyncConnected type NodeChildrenChanged\n[INFO] look for our core node name\n[INFO] Update state numShards=1 message={\n  \"core\":\"blueprint_media_comments_shard1_replica1\",\n  \"roles\":null,\n  \"base_url\":\"http://localhost:44080/solr\",\n  \"node_name\":\"localhost:44080_solr\",\n  \"numShards\":\"1\",\n  \"state\":\"down\",\n  \"shard\":\"shard1\",\n  \"collection\":\"blueprint_media_comments\",\n  \"operation\":\"state\"}\n[INFO] A cluster state change: WatchedEvent state:SyncConnected type:NodeDataChanged path:/clusterstate.json, has occurred - updating... (live nodes size: 1)\n[INFO] waiting to find shard id in clusterstate for blueprint_media_comments_shard1_replica1\n[INFO] Check for collection zkNode:blueprint_media_comments\n[INFO] Collection zkNode exists\n[INFO] Load collection config from:/collections/blueprint_media_comments\n[ERROR] Specified config does not exist in ZooKeeper:elastic\n[ERROR] Error creating core [blueprint_media_comments_shard1_replica1]: Specified config does not exist in ZooKeeper:elastic\norg.apache.solr.common.cloud.ZooKeeperException: Specified config does not exist in ZooKeeper:elastic\n\tat org.apache.solr.common.cloud.ZkStateReader.readConfigName(ZkStateReader.java:160)\n\tat org.apache.solr.cloud.CloudConfigSetService.createCoreResourceLoader(CloudConfigSetService.java:37)\n\tat org.apache.solr.core.ConfigSetService.getConfig(ConfigSetService.java:58)\n\tat org.apache.solr.core.CoreContainer.create(CoreContainer.java:489)\n\tat org.apache.solr.core.CoreContainer.create(CoreContainer.java:466)\n\tat org.apache.solr.handler.admin.CoreAdminHandler.handleCreateAction(CoreAdminHandler.java:575)\n\tat org.apache.solr.handler.admin.CoreAdminHandler.handleRequestInternal(CoreAdminHandler.java:199)\n\tat org.apache.solr.handler.admin.CoreAdminHandler.handleRequestBody(CoreAdminHandler.java:188)\n\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)\n\tat org.apache.solr.servlet.SolrDispatchFilter.handleAdminRequest(SolrDispatchFilter.java:729)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:258)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:207)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:220)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:122)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:170)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:103)\n\tat org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:950)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:116)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:421)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1070)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:611)\n\tat org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:314)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n\tat java.lang.Thread.run(Thread.java:745)\n[ERROR] org.apache.solr.common.SolrException: Error CREATEing SolrCore 'blueprint_media_comments_shard1_replica1': Unable to create core [blueprint_media_comments_shard1_replica1] Caused by: Specified config does not exist in ZooKeeper:elastic\n\tat org.apache.solr.handler.admin.CoreAdminHandler.handleCreateAction(CoreAdminHandler.java:613)\n\tat org.apache.solr.handler.admin.CoreAdminHandler.handleRequestInternal(CoreAdminHandler.java:199)\n\tat org.apache.solr.handler.admin.CoreAdminHandler.handleRequestBody(CoreAdminHandler.java:188)\n\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)\n\tat org.apache.solr.servlet.SolrDispatchFilter.handleAdminRequest(SolrDispatchFilter.java:729)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:258)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:207)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:241)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:220)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:122)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:170)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:103)\n\tat org.apache.catalina.valves.AccessLogValve.invoke(AccessLogValve.java:950)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:116)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:421)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1070)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:611)\n\tat org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:314)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n\tat java.lang.Thread.run(Thread.java:745)\nCaused by: org.apache.solr.common.SolrException: Unable to create core [blueprint_media_comments_shard1_replica1]\n\tat org.apache.solr.core.CoreContainer.create(CoreContainer.java:507)\n\tat org.apache.solr.core.CoreContainer.create(CoreContainer.java:466)\n\tat org.apache.solr.handler.admin.CoreAdminHandler.handleCreateAction(CoreAdminHandler.java:575)\n\t... 22 more\nCaused by: org.apache.solr.common.cloud.ZooKeeperException: Specified config does not exist in ZooKeeper:elastic\n\tat org.apache.solr.common.cloud.ZkStateReader.readConfigName(ZkStateReader.java:160)\n\tat org.apache.solr.cloud.CloudConfigSetService.createCoreResourceLoader(CloudConfigSetService.java:37)\n\tat org.apache.solr.core.ConfigSetService.getConfig(ConfigSetService.java:58)\n\tat org.apache.solr.core.CoreContainer.create(CoreContainer.java:489)\n\t... 24 more\n\n[INFO] [admin] webapp=null path=/admin/cores params={qt=/admin/cores&property.dataDir=data&collection.configName=elastic&name=blueprint_media_comments_shard1_replica1&action=CREATE&numShards=1&collection=blueprint_media_comments&shard=shard1&wt=javabin&version=2&property.instanceDir=cores/blueprint_media_comments} status=400 QTime=1005 \n[ERROR] Error from shard: http://localhost:44080/solr\norg.apache.solr.client.solrj.impl.HttpSolrServer$RemoteSolrException: Error CREATEing SolrCore 'blueprint_media_comments_shard1_replica1': Unable to create core [blueprint_media_comments_shard1_replica1] Caused by: Specified config does not exist in ZooKeeper:elastic\n\tat org.apache.solr.client.solrj.impl.HttpSolrServer.executeMethod(HttpSolrServer.java:552)\n\tat org.apache.solr.client.solrj.impl.HttpSolrServer.request(HttpSolrServer.java:210)\n\tat org.apache.solr.client.solrj.impl.HttpSolrServer.request(HttpSolrServer.java:206)\n\tat org.apache.solr.handler.component.HttpShardHandler$1.call(HttpShardHandler.java:157)\n\tat org.apache.solr.handler.component.HttpShardHandler$1.call(HttpShardHandler.java:119)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n\tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat java.lang.Thread.run(Thread.java:745)\n[INFO] Finished create command on all shards for collection: blueprint_media_comments\n[INFO] LatchChildWatcher fired on path: /overseer/queue state: SyncConnected type NodeChildrenChanged\n[INFO] Overseer Collection Processor: Message id:/overseer/collection-queue-work/qn-0000000110 complete, response:{failure={null=org.apache.solr.client.solrj.impl.HttpSolrServer$RemoteSolrException:Error CREATEing SolrCore 'blueprint_media_comments_shard1_replica1': Unable to create core [blueprint_media_comments_shard1_replica1] Caused by: Specified config does not exist in ZooKeeper:elastic}}\n[INFO] LatchChildWatcher fired on path: /overseer/collection-queue-work/qnr-0000000110 state: SyncConnected type NodeDataChanged\n[INFO] [admin] webapp=null path=/admin/collections params={property.dataDir=data&collection.configName=elastic&name=blueprint_media_comments&action=CREATE&numShards=1&wt=javabin&version=2&property.instanceDir=cores/blueprint_media_comments} status=0 QTime=1134 \n[INFO] LatchChildWatcher fired on path: /overseer/collection-queue-work state: SyncConnected type NodeChildrenChanged\n[INFO] LatchChildWatcher fired on path: /overseer/collection-queue-work state: SyncConnected type NodeChildrenChanged\n[WARNING] OverseerCollectionProcessor.processMessage : clusterstatus , {\"operation\":\"clusterstatus\"}\n[INFO] Overseer Collection Processor: Message id:/overseer/collection-queue-work/qn-0000000112 complete, response:{cluster={collections={live={replicationFactor=1, shards={shard1={range=80000000-7fffffff, state=active, replicas={live={core=live, base_url=http://localhost:44080/solr, node_name=localhost:44080_solr, state=active, leader=true}}}}, router={name=compositeId}, maxShardsPerNode=1, autoAddReplicas=false, autoCreated=true},studio={replicationFactor=1, shards={shard1={range=80000000-7fffffff, state=active, replicas={studio={core=studio, base_url=http://localhost:44080/solr, node_name=localhost:44080_solr, state=active, leader=true}}}}, router={name=compositeId}, maxShardsPerNode=1, autoAddReplicas=false, autoCreated=true},preview={replicationFactor=1, shards={shard1={range=80000000-7fffffff, state=active, replicas={preview={core=preview, base_url=http://localhost:44080/solr, node_name=localhost:44080_solr, state=active, leader=true}}}}, router={name=compositeId}, maxShardsPerNode=1, autoAddReplicas=false, autoCreated=true},blueprint_media_comments={replicationFactor=1, shards={shard1={range=80000000-7fffffff, state=active, replicas={core_node1={core=blueprint_media_comments_shard1_replica1, base_url=http://localhost:44080/solr, node_name=localhost:44080_solr, state=down}}}}, router={name=compositeId}, maxShardsPerNode=1, autoAddReplicas=false}},live_nodes=[localhost:44080_solr]}}",
    "attachments": {
        "SOLR-7062.patch": "https://issues.apache.org/jira/secure/attachment/12704803/SOLR-7062.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2015-03-16T16:10:24+0000",
            "author": "Vitaliy Zhovtyuk",
            "content": "Added test reproducing issue in this issue and SOLR-7053. The reason is preRegister call in CoreContainer creating record in ZK. Core create is failed with exception but state in ZK remains active and inconsistent. There 2 options to solve this: rollback ZK data if core create was failed, check that configSet exists before creating core and throw exception. Implemented last one check. ",
            "id": "comment-14363408"
        },
        {
            "date": "2015-06-04T06:06:57+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 1683466 from Noble Paul in branch 'dev/trunk'\n[ https://svn.apache.org/r1683466 ]\n\nSOLR-7062 testcase to reproduce the bug. Looks like it is not reproducible ",
            "id": "comment-14572227"
        },
        {
            "date": "2015-06-04T06:13:43+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 1683467 from Noble Paul in branch 'dev/branches/branch_5x'\n[ https://svn.apache.org/r1683467 ]\n\nSOLR-7062 testcase to reproduce the bug. Looks like it is not reproducible ",
            "id": "comment-14572236"
        }
    ]
}