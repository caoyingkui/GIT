{
    "id": "SOLR-2040",
    "title": "is ConcurrentLRUCache really a thread-safe/LRU implementation?",
    "details": {
        "affect_versions": "None",
        "status": "Closed",
        "fix_versions": [],
        "components": [],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Not A Problem"
    },
    "description": "hi, i wrote a simple test\n\npackage lru.solr;\n\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Random;\nimport java.util.concurrent.Callable;\nimport java.util.concurrent.ExecutorService;\nimport java.util.concurrent.Executors;\nimport java.util.concurrent.Future;\nimport java.util.concurrent.atomic.AtomicInteger;\n\npublic class ConcurrentLRUCacheTest {\n\tstatic final int loop = 10000;\n\tstatic final int threadCount = 500;\n\tstatic final ConcurrentLRUCache lruMap = new ConcurrentLRUCache(128, 80,\n\t\t\t100, 100, false, false, null);\n\tstatic final ExecutorService exec = Executors\n\t\t\t.newFixedThreadPool(threadCount);\n\tstatic final AtomicInteger totalRuncounter = new AtomicInteger();\n\tstatic final AtomicInteger putCounter = new AtomicInteger();\n\tstatic final AtomicInteger sizeCounter = new AtomicInteger();\n\tstatic long totalTime = 0;\n\n\tpublic static void main(String[] args) throws Exception {\n\t\tList<Callable<Long>> callList = new ArrayList<Callable<Long>>();\n\t\tfor (int i = 0; i < threadCount; i++) {\n\t\t\tcallList.add(new Callable<Long>() {\n\t\t\t\tint maxCacheSize = 0;\n\t\t\t\tint maxCacheInternalMapSize = 0;\n\n\t\t\t\tpublic Long call() throws Exception {\n\t\t\t\t\tfinal long begin = System.nanoTime();\n\t\t\t\t\tRandom r = new Random();\n\t\t\t\t\tfor (int j = 0; j < loop; j++) {\n\t\t\t\t\t\ttotalRuncounter.getAndIncrement();\n\t\t\t\t\t\tint n = r.nextInt(10000);\n\t\t\t\t\t\tint currentCacheSize = lruMap.size();\n\t\t\t\t\t\tint currentCacheInternalMapSize = lruMap.getMap()\n\t\t\t\t\t\t\t\t.size();\n\t\t\t\t\t\tmaxCacheSize = Math.max(currentCacheSize, maxCacheSize);\n\t\t\t\t\t\tmaxCacheInternalMapSize = Math.max(\n\t\t\t\t\t\t\t\tcurrentCacheInternalMapSize,\n\t\t\t\t\t\t\t\tmaxCacheInternalMapSize);\n\t\t\t\t\t\tif (null == lruMap.get(n)) {\n\t\t\t\t\t\t\tlruMap.put(n, j);\n\t\t\t\t\t\t\tputCounter.getAndIncrement();\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tlruMap.size();\n\t\t\t\t\t\t\tsizeCounter.getAndIncrement();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tSystem.out.println(\"maxCacheSize: \" + maxCacheSize\n\t\t\t\t\t\t\t+ \" ,maxCacheInternalMapSize: \"\n\t\t\t\t\t\t\t+ maxCacheInternalMapSize);\n\t\t\t\t\tfinal long end = System.nanoTime();\n\t\t\t\t\treturn (end - begin);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tList<Future<Long>> futureList = exec.invokeAll(callList);\n\t\tfor (Future<Long> future : futureList) {\n\t\t\ttotalTime += future.get();\n\t\t}\n\t\tSystem.out.println(\"final cache size: \" + lruMap.size());\n\t\tSystem.out.println(\"final cache internal map size: \"\n\t\t\t\t+ lruMap.getMap().size());\n\t\tSystem.out.println(\"total get: \"+totalRuncounter + \" spend time=\" + totalTime / 1000\n\t\t\t\t+ \" , put: \" + putCounter.get() + \" , size: \"\n\t\t\t\t+ sizeCounter.get());\n\t\texec.shutdown();\n\n\t}\n\n}\n\n\n\nand here is the result\n\nupper: 128\nlower: 80\nacceptable: 100\ninitial: 100\nmaxCacheSize: 9692 ,maxCacheInternalMapSize: 9694\nmaxCacheSize: 9856 ,maxCacheInternalMapSize: 9859\nmaxCacheSize: 9674 ,maxCacheInternalMapSize: 9676\nmaxCacheSize: 9814 ,maxCacheInternalMapSize: 9817\nmaxCacheSize: 9098 ,maxCacheInternalMapSize: 9765\nmaxCacheSize: 9426 ,maxCacheInternalMapSize: 9429\nmaxCacheSize: 9986 ,maxCacheInternalMapSize: 9987\nmaxCacheSize: 9987 ,maxCacheInternalMapSize: 9988\nmaxCacheSize: 9996 ,maxCacheInternalMapSize: 9997\nmaxCacheSize: 9998 ,maxCacheInternalMapSize: 9999\nmaxCacheSize: 9999 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10001 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 9986 ,maxCacheInternalMapSize: 9987\nmaxCacheSize: 10001 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10001 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 8091 ,maxCacheInternalMapSize: 8090\nmaxCacheSize: 9291 ,maxCacheInternalMapSize: 9290\nmaxCacheSize: 8639 ,maxCacheInternalMapSize: 8639\nmaxCacheSize: 9275 ,maxCacheInternalMapSize: 9275\nmaxCacheSize: 9816 ,maxCacheInternalMapSize: 9816\nmaxCacheSize: 9910 ,maxCacheInternalMapSize: 9910\nmaxCacheSize: 9975 ,maxCacheInternalMapSize: 9975\nmaxCacheSize: 9994 ,maxCacheInternalMapSize: 9994\nmaxCacheSize: 9998 ,maxCacheInternalMapSize: 9998\nmaxCacheSize: 9999 ,maxCacheInternalMapSize: 9999\nmaxCacheSize: 9999 ,maxCacheInternalMapSize: 9999\nmaxCacheSize: 9999 ,maxCacheInternalMapSize: 9999\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10001 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10001 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 9787 ,maxCacheInternalMapSize: 9787\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 9996 ,maxCacheInternalMapSize: 9996\nmaxCacheSize: 9994 ,maxCacheInternalMapSize: 9994\nmaxCacheSize: 9996 ,maxCacheInternalMapSize: 9996\nmaxCacheSize: 9930 ,maxCacheInternalMapSize: 9930\nmaxCacheSize: 9995 ,maxCacheInternalMapSize: 9995\nmaxCacheSize: 9951 ,maxCacheInternalMapSize: 9951\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 8733 ,maxCacheInternalMapSize: 8733\nmaxCacheSize: 9808 ,maxCacheInternalMapSize: 9808\nmaxCacheSize: 9824 ,maxCacheInternalMapSize: 9824\nmaxCacheSize: 9979 ,maxCacheInternalMapSize: 9979\nmaxCacheSize: 9980 ,maxCacheInternalMapSize: 9980\nmaxCacheSize: 9981 ,maxCacheInternalMapSize: 9981\nmaxCacheSize: 9751 ,maxCacheInternalMapSize: 9754\nmaxCacheSize: 1144 ,maxCacheInternalMapSize: 1143\nmaxCacheSize: 362 ,maxCacheInternalMapSize: 362\nmaxCacheSize: 3985 ,maxCacheInternalMapSize: 3985\nmaxCacheSize: 7305 ,maxCacheInternalMapSize: 7305\nmaxCacheSize: 8279 ,maxCacheInternalMapSize: 8279\nmaxCacheSize: 8332 ,maxCacheInternalMapSize: 8332\nmaxCacheSize: 8320 ,maxCacheInternalMapSize: 8320\nmaxCacheSize: 9330 ,maxCacheInternalMapSize: 9329\nmaxCacheSize: 9447 ,maxCacheInternalMapSize: 9446\nmaxCacheSize: 9836 ,maxCacheInternalMapSize: 9835\nmaxCacheSize: 9948 ,maxCacheInternalMapSize: 9947\nmaxCacheSize: 8608 ,maxCacheInternalMapSize: 8602\nmaxCacheSize: 8542 ,maxCacheInternalMapSize: 8542\nmaxCacheSize: 8407 ,maxCacheInternalMapSize: 8407\nmaxCacheSize: 9950 ,maxCacheInternalMapSize: 9950\nmaxCacheSize: 320 ,maxCacheInternalMapSize: 320\nmaxCacheSize: 315 ,maxCacheInternalMapSize: 315\nmaxCacheSize: 513 ,maxCacheInternalMapSize: 513\nmaxCacheSize: 510 ,maxCacheInternalMapSize: 510\nmaxCacheSize: 9050 ,maxCacheInternalMapSize: 9050\nmaxCacheSize: 9505 ,maxCacheInternalMapSize: 9505\nmaxCacheSize: 9505 ,maxCacheInternalMapSize: 9505\nmaxCacheSize: 9815 ,maxCacheInternalMapSize: 9815\nmaxCacheSize: 9975 ,maxCacheInternalMapSize: 9975\nmaxCacheSize: 9973 ,maxCacheInternalMapSize: 9973\nmaxCacheSize: 9886 ,maxCacheInternalMapSize: 9886\nmaxCacheSize: 9933 ,maxCacheInternalMapSize: 9933\nmaxCacheSize: 9966 ,maxCacheInternalMapSize: 9966\nmaxCacheSize: 9995 ,maxCacheInternalMapSize: 9995\nmaxCacheSize: 9995 ,maxCacheInternalMapSize: 9995\nmaxCacheSize: 9998 ,maxCacheInternalMapSize: 9998\nmaxCacheSize: 9999 ,maxCacheInternalMapSize: 9999\nmaxCacheSize: 9999 ,maxCacheInternalMapSize: 9999\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 9979 ,maxCacheInternalMapSize: 9979\nmaxCacheSize: 9987 ,maxCacheInternalMapSize: 9987\nmaxCacheSize: 9990 ,maxCacheInternalMapSize: 9990\nmaxCacheSize: 9999 ,maxCacheInternalMapSize: 9999\nmaxCacheSize: 9999 ,maxCacheInternalMapSize: 9999\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 9842 ,maxCacheInternalMapSize: 9842\nmaxCacheSize: 9843 ,maxCacheInternalMapSize: 9843\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 9974 ,maxCacheInternalMapSize: 9973\nmaxCacheSize: 9993 ,maxCacheInternalMapSize: 9992\nmaxCacheSize: 9999 ,maxCacheInternalMapSize: 9998\nmaxCacheSize: 10001 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10001 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10001 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 9731 ,maxCacheInternalMapSize: 9731\nmaxCacheSize: 9929 ,maxCacheInternalMapSize: 9929\nmaxCacheSize: 9968 ,maxCacheInternalMapSize: 9968\nmaxCacheSize: 9993 ,maxCacheInternalMapSize: 9993\nmaxCacheSize: 9997 ,maxCacheInternalMapSize: 9997\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 9959 ,maxCacheInternalMapSize: 9959\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 9963 ,maxCacheInternalMapSize: 9963\nmaxCacheSize: 9869 ,maxCacheInternalMapSize: 9869\nmaxCacheSize: 9857 ,maxCacheInternalMapSize: 9857\nmaxCacheSize: 9842 ,maxCacheInternalMapSize: 9842\nmaxCacheSize: 9972 ,maxCacheInternalMapSize: 9972\nmaxCacheSize: 1376 ,maxCacheInternalMapSize: 1376\nmaxCacheSize: 2183 ,maxCacheInternalMapSize: 2183\nmaxCacheSize: 8625 ,maxCacheInternalMapSize: 8624\nmaxCacheSize: 9457 ,maxCacheInternalMapSize: 9456\nmaxCacheSize: 9717 ,maxCacheInternalMapSize: 9716\nmaxCacheSize: 9905 ,maxCacheInternalMapSize: 9904\nmaxCacheSize: 9971 ,maxCacheInternalMapSize: 9970\nmaxCacheSize: 9973 ,maxCacheInternalMapSize: 9972\nmaxCacheSize: 9985 ,maxCacheInternalMapSize: 9985\nmaxCacheSize: 9984 ,maxCacheInternalMapSize: 9984\nmaxCacheSize: 7085 ,maxCacheInternalMapSize: 7085\nmaxCacheSize: 9335 ,maxCacheInternalMapSize: 9335\nmaxCacheSize: 6945 ,maxCacheInternalMapSize: 6945\nmaxCacheSize: 9408 ,maxCacheInternalMapSize: 9408\nmaxCacheSize: 9849 ,maxCacheInternalMapSize: 9849\nmaxCacheSize: 9875 ,maxCacheInternalMapSize: 9875\nmaxCacheSize: 9977 ,maxCacheInternalMapSize: 9977\nmaxCacheSize: 9998 ,maxCacheInternalMapSize: 9998\nmaxCacheSize: 9999 ,maxCacheInternalMapSize: 9999\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 5031 ,maxCacheInternalMapSize: 5029\nmaxCacheSize: 9843 ,maxCacheInternalMapSize: 9843\nmaxCacheSize: 4651 ,maxCacheInternalMapSize: 4651\nmaxCacheSize: 4670 ,maxCacheInternalMapSize: 4670\nmaxCacheSize: 4457 ,maxCacheInternalMapSize: 4457\nmaxCacheSize: 3766 ,maxCacheInternalMapSize: 3766\nmaxCacheSize: 3723 ,maxCacheInternalMapSize: 3723\nmaxCacheSize: 6293 ,maxCacheInternalMapSize: 6294\nmaxCacheSize: 3372 ,maxCacheInternalMapSize: 3372\nmaxCacheSize: 6281 ,maxCacheInternalMapSize: 6282\nmaxCacheSize: 6394 ,maxCacheInternalMapSize: 6395\nmaxCacheSize: 8684 ,maxCacheInternalMapSize: 8685\nmaxCacheSize: 9488 ,maxCacheInternalMapSize: 9487\nmaxCacheSize: 9354 ,maxCacheInternalMapSize: 9354\nmaxCacheSize: 8700 ,maxCacheInternalMapSize: 8700\nmaxCacheSize: 6720 ,maxCacheInternalMapSize: 6720\nmaxCacheSize: 7370 ,maxCacheInternalMapSize: 7370\nmaxCacheSize: 7368 ,maxCacheInternalMapSize: 7368\nmaxCacheSize: 9478 ,maxCacheInternalMapSize: 9478\nmaxCacheSize: 7389 ,maxCacheInternalMapSize: 7389\nmaxCacheSize: 8639 ,maxCacheInternalMapSize: 8639\nmaxCacheSize: 6542 ,maxCacheInternalMapSize: 6542\nmaxCacheSize: 7959 ,maxCacheInternalMapSize: 7959\nmaxCacheSize: 6485 ,maxCacheInternalMapSize: 6485\nmaxCacheSize: 2546 ,maxCacheInternalMapSize: 2546\nmaxCacheSize: 8156 ,maxCacheInternalMapSize: 8156\nmaxCacheSize: 8242 ,maxCacheInternalMapSize: 8242\nmaxCacheSize: 8403 ,maxCacheInternalMapSize: 8403\nmaxCacheSize: 8345 ,maxCacheInternalMapSize: 8345\nmaxCacheSize: 8444 ,maxCacheInternalMapSize: 8444\nmaxCacheSize: 7381 ,maxCacheInternalMapSize: 7381\nmaxCacheSize: 320 ,maxCacheInternalMapSize: 320\nmaxCacheSize: 1245 ,maxCacheInternalMapSize: 1245\nmaxCacheSize: 2301 ,maxCacheInternalMapSize: 2301\nmaxCacheSize: 3719 ,maxCacheInternalMapSize: 3719\nmaxCacheSize: 3717 ,maxCacheInternalMapSize: 3717\nmaxCacheSize: 7719 ,maxCacheInternalMapSize: 7719\nmaxCacheSize: 7926 ,maxCacheInternalMapSize: 7926\nmaxCacheSize: 7911 ,maxCacheInternalMapSize: 7911\nmaxCacheSize: 6737 ,maxCacheInternalMapSize: 6736\nmaxCacheSize: 7165 ,maxCacheInternalMapSize: 7165\nmaxCacheSize: 8387 ,maxCacheInternalMapSize: 8387\nmaxCacheSize: 8815 ,maxCacheInternalMapSize: 8815\nmaxCacheSize: 9174 ,maxCacheInternalMapSize: 9174\nmaxCacheSize: 7273 ,maxCacheInternalMapSize: 7273\nmaxCacheSize: 7291 ,maxCacheInternalMapSize: 7291\nmaxCacheSize: 9207 ,maxCacheInternalMapSize: 9207\nmaxCacheSize: 1162 ,maxCacheInternalMapSize: 1162\nmaxCacheSize: 4802 ,maxCacheInternalMapSize: 4802\nmaxCacheSize: 4987 ,maxCacheInternalMapSize: 4987\nmaxCacheSize: 6046 ,maxCacheInternalMapSize: 6046\nmaxCacheSize: 6039 ,maxCacheInternalMapSize: 6039\nmaxCacheSize: 6048 ,maxCacheInternalMapSize: 6048\nmaxCacheSize: 7305 ,maxCacheInternalMapSize: 7306\nmaxCacheSize: 8164 ,maxCacheInternalMapSize: 8164\nmaxCacheSize: 8203 ,maxCacheInternalMapSize: 8202\nmaxCacheSize: 8156 ,maxCacheInternalMapSize: 8156\nmaxCacheSize: 8288 ,maxCacheInternalMapSize: 8288\nmaxCacheSize: 4075 ,maxCacheInternalMapSize: 4074\nmaxCacheSize: 519 ,maxCacheInternalMapSize: 519\nmaxCacheSize: 551 ,maxCacheInternalMapSize: 550\nmaxCacheSize: 5913 ,maxCacheInternalMapSize: 5913\nmaxCacheSize: 5473 ,maxCacheInternalMapSize: 5473\nmaxCacheSize: 5893 ,maxCacheInternalMapSize: 5893\nmaxCacheSize: 5637 ,maxCacheInternalMapSize: 5638\nmaxCacheSize: 128 ,maxCacheInternalMapSize: 128\nmaxCacheSize: 7561 ,maxCacheInternalMapSize: 7561\nmaxCacheSize: 9440 ,maxCacheInternalMapSize: 9440\nmaxCacheSize: 9699 ,maxCacheInternalMapSize: 9699\nmaxCacheSize: 9723 ,maxCacheInternalMapSize: 9723\nmaxCacheSize: 9722 ,maxCacheInternalMapSize: 9722\nmaxCacheSize: 7560 ,maxCacheInternalMapSize: 7560\nmaxCacheSize: 5176 ,maxCacheInternalMapSize: 5174\nmaxCacheSize: 4014 ,maxCacheInternalMapSize: 4014\nmaxCacheSize: 6677 ,maxCacheInternalMapSize: 6677\nmaxCacheSize: 7629 ,maxCacheInternalMapSize: 7628\nmaxCacheSize: 8773 ,maxCacheInternalMapSize: 8772\nmaxCacheSize: 8569 ,maxCacheInternalMapSize: 8569\nmaxCacheSize: 9041 ,maxCacheInternalMapSize: 9041\nmaxCacheSize: 9083 ,maxCacheInternalMapSize: 9083\nmaxCacheSize: 8265 ,maxCacheInternalMapSize: 8265\nmaxCacheSize: 8526 ,maxCacheInternalMapSize: 8526\nmaxCacheSize: 8641 ,maxCacheInternalMapSize: 8641\nmaxCacheSize: 8646 ,maxCacheInternalMapSize: 8646\nmaxCacheSize: 5400 ,maxCacheInternalMapSize: 5399\nmaxCacheSize: 8639 ,maxCacheInternalMapSize: 8639\nmaxCacheSize: 355 ,maxCacheInternalMapSize: 354\nmaxCacheSize: 8477 ,maxCacheInternalMapSize: 8477\nmaxCacheSize: 8656 ,maxCacheInternalMapSize: 8656\nmaxCacheSize: 8652 ,maxCacheInternalMapSize: 8652\nmaxCacheSize: 8395 ,maxCacheInternalMapSize: 8395\nmaxCacheSize: 8193 ,maxCacheInternalMapSize: 8193\nmaxCacheSize: 6710 ,maxCacheInternalMapSize: 6710\nmaxCacheSize: 6684 ,maxCacheInternalMapSize: 6684\nmaxCacheSize: 6617 ,maxCacheInternalMapSize: 6617\nmaxCacheSize: 8341 ,maxCacheInternalMapSize: 8342\nmaxCacheSize: 8470 ,maxCacheInternalMapSize: 8470\nmaxCacheSize: 9239 ,maxCacheInternalMapSize: 9239\nmaxCacheSize: 9262 ,maxCacheInternalMapSize: 9261\nmaxCacheSize: 9667 ,maxCacheInternalMapSize: 9667\nmaxCacheSize: 9867 ,maxCacheInternalMapSize: 9867\nmaxCacheSize: 9889 ,maxCacheInternalMapSize: 9889\nmaxCacheSize: 9977 ,maxCacheInternalMapSize: 9977\nmaxCacheSize: 9977 ,maxCacheInternalMapSize: 9977\nmaxCacheSize: 9060 ,maxCacheInternalMapSize: 9060\nmaxCacheSize: 9670 ,maxCacheInternalMapSize: 9670\nmaxCacheSize: 9274 ,maxCacheInternalMapSize: 9273\nmaxCacheSize: 9747 ,maxCacheInternalMapSize: 9746\nmaxCacheSize: 9831 ,maxCacheInternalMapSize: 9830\nmaxCacheSize: 9967 ,maxCacheInternalMapSize: 9966\nmaxCacheSize: 9983 ,maxCacheInternalMapSize: 9982\nmaxCacheSize: 8487 ,maxCacheInternalMapSize: 8487\nmaxCacheSize: 9985 ,maxCacheInternalMapSize: 9984\nmaxCacheSize: 408 ,maxCacheInternalMapSize: 408\nmaxCacheSize: 1906 ,maxCacheInternalMapSize: 1905\nmaxCacheSize: 4299 ,maxCacheInternalMapSize: 4299\nmaxCacheSize: 8014 ,maxCacheInternalMapSize: 8014\nmaxCacheSize: 8536 ,maxCacheInternalMapSize: 8536\nmaxCacheSize: 8540 ,maxCacheInternalMapSize: 8540\nmaxCacheSize: 9515 ,maxCacheInternalMapSize: 9515\nmaxCacheSize: 9873 ,maxCacheInternalMapSize: 9873\nmaxCacheSize: 9940 ,maxCacheInternalMapSize: 9940\nmaxCacheSize: 9952 ,maxCacheInternalMapSize: 9952\nmaxCacheSize: 9979 ,maxCacheInternalMapSize: 9979\nmaxCacheSize: 7385 ,maxCacheInternalMapSize: 7385\nmaxCacheSize: 8119 ,maxCacheInternalMapSize: 8118\nmaxCacheSize: 6605 ,maxCacheInternalMapSize: 6604\nmaxCacheSize: 7213 ,maxCacheInternalMapSize: 7213\nmaxCacheSize: 7194 ,maxCacheInternalMapSize: 7193\nmaxCacheSize: 8289 ,maxCacheInternalMapSize: 8289\nmaxCacheSize: 9551 ,maxCacheInternalMapSize: 9550\nmaxCacheSize: 7498 ,maxCacheInternalMapSize: 7498\nmaxCacheSize: 8447 ,maxCacheInternalMapSize: 8447\nmaxCacheSize: 9565 ,maxCacheInternalMapSize: 9565\nmaxCacheSize: 7816 ,maxCacheInternalMapSize: 7816\nmaxCacheSize: 8643 ,maxCacheInternalMapSize: 8643\nmaxCacheSize: 9567 ,maxCacheInternalMapSize: 9567\nmaxCacheSize: 8666 ,maxCacheInternalMapSize: 8666\nmaxCacheSize: 9137 ,maxCacheInternalMapSize: 9137\nmaxCacheSize: 6618 ,maxCacheInternalMapSize: 6619\nmaxCacheSize: 7506 ,maxCacheInternalMapSize: 7506\nmaxCacheSize: 7593 ,maxCacheInternalMapSize: 7593\nmaxCacheSize: 7197 ,maxCacheInternalMapSize: 7197\nmaxCacheSize: 8704 ,maxCacheInternalMapSize: 8704\nmaxCacheSize: 9583 ,maxCacheInternalMapSize: 9583\nmaxCacheSize: 9764 ,maxCacheInternalMapSize: 9764\nmaxCacheSize: 8300 ,maxCacheInternalMapSize: 8300\nmaxCacheSize: 9770 ,maxCacheInternalMapSize: 9770\nmaxCacheSize: 9484 ,maxCacheInternalMapSize: 9484\nmaxCacheSize: 9781 ,maxCacheInternalMapSize: 9781\nmaxCacheSize: 8082 ,maxCacheInternalMapSize: 8082\nmaxCacheSize: 8148 ,maxCacheInternalMapSize: 8148\nmaxCacheSize: 7437 ,maxCacheInternalMapSize: 7437\nmaxCacheSize: 8277 ,maxCacheInternalMapSize: 8275\nmaxCacheSize: 6634 ,maxCacheInternalMapSize: 6634\nmaxCacheSize: 6656 ,maxCacheInternalMapSize: 6656\nmaxCacheSize: 8077 ,maxCacheInternalMapSize: 8077\nmaxCacheSize: 8353 ,maxCacheInternalMapSize: 8353\nmaxCacheSize: 8394 ,maxCacheInternalMapSize: 8394\nmaxCacheSize: 9251 ,maxCacheInternalMapSize: 9251\nmaxCacheSize: 9282 ,maxCacheInternalMapSize: 9282\nmaxCacheSize: 8270 ,maxCacheInternalMapSize: 8270\nmaxCacheSize: 8373 ,maxCacheInternalMapSize: 8373\nmaxCacheSize: 9316 ,maxCacheInternalMapSize: 9316\nmaxCacheSize: 9725 ,maxCacheInternalMapSize: 9725\nmaxCacheSize: 9726 ,maxCacheInternalMapSize: 9726\nmaxCacheSize: 9895 ,maxCacheInternalMapSize: 9895\nmaxCacheSize: 9965 ,maxCacheInternalMapSize: 9965\nmaxCacheSize: 9977 ,maxCacheInternalMapSize: 9977\nmaxCacheSize: 9737 ,maxCacheInternalMapSize: 9737\nmaxCacheSize: 8870 ,maxCacheInternalMapSize: 8870\nmaxCacheSize: 9205 ,maxCacheInternalMapSize: 9205\nmaxCacheSize: 9802 ,maxCacheInternalMapSize: 9802\nmaxCacheSize: 9904 ,maxCacheInternalMapSize: 9904\nmaxCacheSize: 9954 ,maxCacheInternalMapSize: 9954\nmaxCacheSize: 9997 ,maxCacheInternalMapSize: 9997\nmaxCacheSize: 9997 ,maxCacheInternalMapSize: 9997\nmaxCacheSize: 9998 ,maxCacheInternalMapSize: 9998\nmaxCacheSize: 9998 ,maxCacheInternalMapSize: 9998\nmaxCacheSize: 9716 ,maxCacheInternalMapSize: 9716\nmaxCacheSize: 8898 ,maxCacheInternalMapSize: 8898\nmaxCacheSize: 7962 ,maxCacheInternalMapSize: 7961\nmaxCacheSize: 8912 ,maxCacheInternalMapSize: 8912\nmaxCacheSize: 6886 ,maxCacheInternalMapSize: 6886\nmaxCacheSize: 5221 ,maxCacheInternalMapSize: 5221\nmaxCacheSize: 6693 ,maxCacheInternalMapSize: 6693\nmaxCacheSize: 8275 ,maxCacheInternalMapSize: 8275\nmaxCacheSize: 8959 ,maxCacheInternalMapSize: 8959\nmaxCacheSize: 8984 ,maxCacheInternalMapSize: 8983\nmaxCacheSize: 8538 ,maxCacheInternalMapSize: 8538\nmaxCacheSize: 9198 ,maxCacheInternalMapSize: 9198\nmaxCacheSize: 9700 ,maxCacheInternalMapSize: 9700\nmaxCacheSize: 9264 ,maxCacheInternalMapSize: 9264\nmaxCacheSize: 9691 ,maxCacheInternalMapSize: 9691\nmaxCacheSize: 9952 ,maxCacheInternalMapSize: 9952\nmaxCacheSize: 9972 ,maxCacheInternalMapSize: 9972\nmaxCacheSize: 9986 ,maxCacheInternalMapSize: 9986\nmaxCacheSize: 9995 ,maxCacheInternalMapSize: 9995\nmaxCacheSize: 9995 ,maxCacheInternalMapSize: 9995\nmaxCacheSize: 9767 ,maxCacheInternalMapSize: 9767\nmaxCacheSize: 6405 ,maxCacheInternalMapSize: 6405\nmaxCacheSize: 7381 ,maxCacheInternalMapSize: 7381\nmaxCacheSize: 7565 ,maxCacheInternalMapSize: 7565\nmaxCacheSize: 7574 ,maxCacheInternalMapSize: 7574\nmaxCacheSize: 5837 ,maxCacheInternalMapSize: 5837\nmaxCacheSize: 7671 ,maxCacheInternalMapSize: 7671\nmaxCacheSize: 7451 ,maxCacheInternalMapSize: 7451\nmaxCacheSize: 7570 ,maxCacheInternalMapSize: 7570\nmaxCacheSize: 7551 ,maxCacheInternalMapSize: 7551\nmaxCacheSize: 5653 ,maxCacheInternalMapSize: 5652\nmaxCacheSize: 8352 ,maxCacheInternalMapSize: 8352\nmaxCacheSize: 8273 ,maxCacheInternalMapSize: 8273\nmaxCacheSize: 7226 ,maxCacheInternalMapSize: 7226\nmaxCacheSize: 8336 ,maxCacheInternalMapSize: 8336\nmaxCacheSize: 1626 ,maxCacheInternalMapSize: 1624\nmaxCacheSize: 352 ,maxCacheInternalMapSize: 352\nmaxCacheSize: 6310 ,maxCacheInternalMapSize: 6310\nmaxCacheSize: 7590 ,maxCacheInternalMapSize: 7590\nmaxCacheSize: 9212 ,maxCacheInternalMapSize: 9212\nmaxCacheSize: 9415 ,maxCacheInternalMapSize: 9415\nmaxCacheSize: 9664 ,maxCacheInternalMapSize: 9664\nmaxCacheSize: 9734 ,maxCacheInternalMapSize: 9734\nmaxCacheSize: 9937 ,maxCacheInternalMapSize: 9937\nmaxCacheSize: 9966 ,maxCacheInternalMapSize: 9966\nmaxCacheSize: 9990 ,maxCacheInternalMapSize: 9990\nmaxCacheSize: 9990 ,maxCacheInternalMapSize: 9990\nmaxCacheSize: 9999 ,maxCacheInternalMapSize: 9999\nmaxCacheSize: 9999 ,maxCacheInternalMapSize: 9999\nmaxCacheSize: 9999 ,maxCacheInternalMapSize: 9999\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 10000 ,maxCacheInternalMapSize: 10000\nmaxCacheSize: 8443 ,maxCacheInternalMapSize: 8443\nmaxCacheSize: 4645 ,maxCacheInternalMapSize: 4643\nmaxCacheSize: 1755 ,maxCacheInternalMapSize: 1755\nmaxCacheSize: 8582 ,maxCacheInternalMapSize: 8582\nmaxCacheSize: 8699 ,maxCacheInternalMapSize: 8699\nmaxCacheSize: 9365 ,maxCacheInternalMapSize: 9365\nmaxCacheSize: 8659 ,maxCacheInternalMapSize: 8658\nmaxCacheSize: 8727 ,maxCacheInternalMapSize: 8726\nmaxCacheSize: 9363 ,maxCacheInternalMapSize: 9363\nfinal cache size: 113\nfinal cache internal map size: 113\ntotal get: 5000000 spend time=31994581 , put: 1422532 , size: 3577468",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "author": "lszwycn",
            "id": "comment-12897559",
            "date": "2010-08-12T03:21:04+0000",
            "content": "to simply test this, try add synchronized to the put method, then the LRU works, the size of this cache will not exceed the initial size   "
        },
        {
            "author": "Noble Paul",
            "id": "comment-12928596",
            "date": "2010-11-05T14:13:28+0000",
            "content": "I fail to understand where is the problem . What is the expected behavior Vs. actual behavior?  "
        },
        {
            "author": "Lance Norskog",
            "id": "comment-12928927",
            "date": "2010-11-06T03:59:34+0000",
            "content": "lszwycn - please rewrite this in the form of a junit test. Add asserts for the numbers you expect to see v.s. the actual size.\nThis will help other people figure out if it is a bug or not.\n\nThanks. "
        },
        {
            "author": "Yonik Seeley",
            "id": "comment-12929800",
            "date": "2010-11-08T23:10:32+0000",
            "content": "ConcurrentLRUCache is not strictly bounded by the size - when the max size is hit, we still allow other puts to proceed while evicting the oldest entries - by design for greater concurrency.\n\nIf adds to the cache are very cheap to generate, this is not an appropriate cache to use since evictions won't keep up with additions.  The uses in Solr are all appropriate however, so trying to fix this via additional synchronization will only result in lower throughput. "
        },
        {
            "author": "Yonik Seeley",
            "id": "comment-12929801",
            "date": "2010-11-08T23:11:16+0000",
            "content": "Closing - this is working as designed as far as I see. "
        }
    ]
}