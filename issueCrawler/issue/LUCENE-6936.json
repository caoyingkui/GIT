{
    "id": "LUCENE-6936",
    "title": "TestDimensionalRangeQuery failures: AIOOBE while merging",
    "details": {
        "resolution": "Fixed",
        "affect_versions": "6.0",
        "components": [],
        "labels": "",
        "fix_versions": [
            "6.0"
        ],
        "priority": "Major",
        "status": "Resolved",
        "type": "Bug"
    },
    "description": "From http://jenkins.sarowe.net/job/Lucene-Solr-Nightly-trunk/105/ - neither failure reproduced for me on the same box:\n\n\n   [junit4] Suite: org.apache.lucene.search.TestDimensionalRangeQuery\n   [junit4]   2> NOTE: download the large Jenkins line-docs file by running 'ant get-jenkins-line-docs' in the lucene directory.\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestDimensionalRangeQuery -Dtests.method=testRandomLongsBig -Dtests.seed=BEF1D45ADA12B09B -Dtests.multiplier=2 -Dtests.nightly=true -Dtests.slow=true -Dtests.linedocsfile=/home/jenkins/lucene-data/enwiki.random.lines.txt -Dtests.locale=cs_CZ -Dtests.timezone=Africa/Porto-Novo -Dtests.asserts=true -Dtests.file.encoding=ISO-8859-1\n   [junit4] ERROR   43.4s J5  | TestDimensionalRangeQuery.testRandomLongsBig <<<\n   [junit4]    > Throwable #1: org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed\n   [junit4]    >        at __randomizedtesting.SeedInfo.seed([BEF1D45ADA12B09B:95C7B6D701973443]:0)\n   [junit4]    >        at org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:714)\n   [junit4]    >        at org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:728)\n   [junit4]    >        at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1459)\n   [junit4]    >        at org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1242)\n   [junit4]    >        at org.apache.lucene.index.RandomIndexWriter.addDocument(RandomIndexWriter.java:170)\n   [junit4]    >        at org.apache.lucene.search.TestDimensionalRangeQuery.verifyLongs(TestDimensionalRangeQuery.java:208)\n   [junit4]    >        at org.apache.lucene.search.TestDimensionalRangeQuery.doTestRandomLongs(TestDimensionalRangeQuery.java:147)\n   [junit4]    >        at org.apache.lucene.search.TestDimensionalRangeQuery.testRandomLongsBig(TestDimensionalRangeQuery.java:114)\n   [junit4]    >        at java.lang.Thread.run(Thread.java:745)\n   [junit4]    > Caused by: java.lang.ArrayIndexOutOfBoundsException: 1024\n   [junit4]    >        at org.apache.lucene.util.bkd.BKDWriter$MergeReader.next(BKDWriter.java:279)\n   [junit4]    >        at org.apache.lucene.util.bkd.BKDWriter.merge(BKDWriter.java:413)\n   [junit4]    >        at org.apache.lucene.codecs.lucene60.Lucene60DimensionalWriter.merge(Lucene60DimensionalWriter.java:159)\n   [junit4]    >        at org.apache.lucene.index.SegmentMerger.mergeDimensionalValues(SegmentMerger.java:168)\n   [junit4]    >        at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:117)\n   [junit4]    >        at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4062)\n   [junit4]    >        at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3642)\n   [junit4]    >        at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:588)\n   [junit4]    >        at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:626)\n   [junit4]   2> NOTE: leaving temporary files on disk at: /var/lib/jenkins/jobs/Lucene-Solr-Nightly-trunk/workspace/lucene/build/core/test/J5/temp/lucene.search.TestDimensionalRangeQuery_BEF1D45ADA12B09B-001\n   [junit4]   2> Dec 15, 2015 11:03:38 PM com.carrotsearch.randomizedtesting.RandomizedRunner$QueueUncaughtExceptionsHandler uncaughtException\n   [junit4]   2> WARNING: Uncaught exception in thread: Thread[Lucene Merge Thread #634,5,TGRP-TestDimensionalRangeQuery]\n   [junit4]   2> org.apache.lucene.index.MergePolicy$MergeException: java.lang.ArrayIndexOutOfBoundsException: 1024\n   [junit4]   2>        at __randomizedtesting.SeedInfo.seed([BEF1D45ADA12B09B]:0)\n   [junit4]   2>        at org.apache.lucene.index.ConcurrentMergeScheduler.handleMergeException(ConcurrentMergeScheduler.java:668)\n   [junit4]   2>        at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:648)\n   [junit4]   2> Caused by: java.lang.ArrayIndexOutOfBoundsException: 1024\n   [junit4]   2>        at org.apache.lucene.util.bkd.BKDWriter$MergeReader.next(BKDWriter.java:279)\n   [junit4]   2>        at org.apache.lucene.util.bkd.BKDWriter.merge(BKDWriter.java:413)\n   [junit4]   2>        at org.apache.lucene.codecs.lucene60.Lucene60DimensionalWriter.merge(Lucene60DimensionalWriter.java:159)\n   [junit4]   2>        at org.apache.lucene.index.SegmentMerger.mergeDimensionalValues(SegmentMerger.java:168)\n   [junit4]   2>        at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:117)\n   [junit4]   2>        at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4062)\n   [junit4]   2>        at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3642)\n   [junit4]   2>        at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:588)\n   [junit4]   2>        at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:626)\n   [junit4]   2> \n   [junit4]   2> Dec 15, 2015 11:03:38 PM com.carrotsearch.randomizedtesting.ThreadLeakControl checkThreadLeaks\n   [junit4]   2> WARNING: Will linger awaiting termination of 1 leaked thread(s).\n   [junit4]   2> NOTE: test params are: codec=FastCompressingStoredFields(storedFieldsFormat=CompressingStoredFieldsFormat(compressionMode=FAST, chunkSize=4, maxDocsPerChunk=729, blockSize=3), termVectorsFormat=CompressingTermVectorsFormat(compressionMode=FAST, chunkSize=4, blockSize=3)), sim=RandomSimilarityProvider(queryNorm=false,coord=no): {}, locale=cs_CZ, timezone=Africa/Porto-Novo\n   [junit4]   2> NOTE: Linux 4.1.0-custom2-amd64 amd64/Oracle Corporation 1.8.0_45 (64-bit)/cpus=16,threads=1,free=166342976,total=535298048\n   [junit4]   2> NOTE: All tests run in this JVM: [TestPositionIncrement, TestConcurrentMergeScheduler, TestDimensionalRangeQuery]\n   [junit4]   2> NOTE: download the large Jenkins line-docs file by running 'ant get-jenkins-line-docs' in the lucene directory.\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestDimensionalRangeQuery -Dtests.seed=BEF1D45ADA12B09B -Dtests.multiplier=2 -Dtests.nightly=true -Dtests.slow=true -Dtests.linedocsfile=/home/jenkins/lucene-data/enwiki.random.lines.txt -Dtests.locale=cs_CZ -Dtests.timezone=Africa/Porto-Novo -Dtests.asserts=true -Dtests.file.encoding=ISO-8859-1\n   [junit4] ERROR   0.00s J5  | TestDimensionalRangeQuery (suite) <<<\n   [junit4]    > Throwable #1: com.carrotsearch.randomizedtesting.UncaughtExceptionError: Captured an uncaught exception in thread: Thread[id=5397, name=Lucene Merge Thread #634, state=RUNNABLE, group=TGRP-TestDimensionalRangeQuery]\n   [junit4]    > Caused by: org.apache.lucene.index.MergePolicy$MergeException: java.lang.ArrayIndexOutOfBoundsException: 1024\n   [junit4]    >        at __randomizedtesting.SeedInfo.seed([BEF1D45ADA12B09B]:0)\n   [junit4]    >        at org.apache.lucene.index.ConcurrentMergeScheduler.handleMergeException(ConcurrentMergeScheduler.java:668)\n   [junit4]    >        at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:648)\n   [junit4]    > Caused by: java.lang.ArrayIndexOutOfBoundsException: 1024\n   [junit4]    >        at org.apache.lucene.util.bkd.BKDWriter$MergeReader.next(BKDWriter.java:279)\n   [junit4]    >        at org.apache.lucene.util.bkd.BKDWriter.merge(BKDWriter.java:413)\n   [junit4]    >        at org.apache.lucene.codecs.lucene60.Lucene60DimensionalWriter.merge(Lucene60DimensionalWriter.java:159)\n   [junit4]    >        at org.apache.lucene.index.SegmentMerger.mergeDimensionalValues(SegmentMerger.java:168)\n   [junit4]    >        at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:117)\n   [junit4]    >        at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4062)\n   [junit4]    >        at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3642)\n   [junit4]    >        at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:588)\n   [junit4]    >        at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:626)\n   [junit4] Completed [185/403 (1!)] on J5 in 727.10s, 17 tests, 2 errors <<< FAILURES!",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "id": "comment-15060237",
            "author": "Michael McCandless",
            "date": "2015-12-16T16:24:48+0000",
            "content": "Looks like fun \n\nThanks Steve Rowe! "
        },
        {
            "id": "comment-15063989",
            "author": "ASF subversion and git services",
            "date": "2015-12-18T14:25:01+0000",
            "content": "Commit 1720798 from Michael McCandless in branch 'dev/trunk'\n[ https://svn.apache.org/r1720798 ]\n\nLUCENE-6936: don't try to merge dimentional values that have 0 points/documents (when all docs having dimensional values were deleted) "
        },
        {
            "id": "comment-15063993",
            "author": "Michael McCandless",
            "date": "2015-12-18T14:26:49+0000",
            "content": "This was a fun corner case, where we merged N segments such that all documents that did have dimensional values were deleted, and then later tried to merge that merged segment ... "
        },
        {
            "id": "comment-15064416",
            "author": "ASF subversion and git services",
            "date": "2015-12-18T18:25:33+0000",
            "content": "Commit 1720837 from Michael McCandless in branch 'dev/trunk'\n[ https://svn.apache.org/r1720837 ]\n\nLUCENE-6936: duh, get dimensional value merging working again "
        }
    ]
}