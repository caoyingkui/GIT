{
    "id": "LUCENE-1381",
    "title": "Hanging while indexing/digesting on multiple threads",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [
            "modules/analysis"
        ],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "2.3.2",
        "resolution": "Invalid",
        "status": "Resolved"
    },
    "description": "With several older lucene projects already running and \"stable\", I have recently written a multi-threading indexer using to the 2.3.2 release.\nMy volume is in the millions of documents indexed daily and I have been stress testing for a while now.  My current setup has 3 JVMs, each running 6 threads indexing different documents, with 1 IndexWriter per JVM.  For stability testing, the indexer shutsdown and exits every 5-10 minutes, with a new JVM is started again for a clean restart. At this rate, I have noticed an rare, but eventually consistent internal hang/deadlock in all indexer threads while parsing documents.  My 'manager' thread is alive and regularly polling the indexer threads and displaying their state variables, but the indexer threads themselves appear not to be making progress while using up nearly 100% of available CPU.  Memory usage is relativly low and stable at 481m out of 2048m available. \n\nMost stack traces, and STAY in this state even after repeated inspections: (pressing CTRL-\\ in active JVM window)\n----------\nFull thread dump Java HotSpot(TM) 64-Bit Server VM (1.5.0_16-b02 mixed mode):\n\n\"Thread-6\" prio=1 tid=0x0000002b25750920 nid=0x34f6 runnable [0x0000000041465000..0x0000000041465db0]\n        at java.util.WeakHashMap.eq(WeakHashMap.java:254)\n        at java.util.WeakHashMap.get(WeakHashMap.java:345)\n        at org.apache.commons.beanutils.MethodUtils.getMatchingAccessibleMethod(MethodUtils.java:530)\n        at org.apache.commons.beanutils.MethodUtils.invokeMethod(MethodUtils.java:209)\n        at org.apache.commons.digester.CallMethodRule.end(CallMethodRule.java:625)\n        at org.apache.commons.digester.Rule.end(Rule.java:230)\n        at org.apache.commons.digester.Digester.endElement(Digester.java:1130)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.endElement(AbstractSAXParser.java:633)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanEndElement(XMLDocumentFragmentScannerImpl.java:1241)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl$FragmentContentDispatcher.dispatch(XMLDocumentFragmentScannerImpl.java:1685)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanDocument(XMLDocumentFragmentScannerImpl.java:368)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:834)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:764)\n        at com.sun.org.apache.xerces.internal.parsers.XMLParser.parse(XMLParser.java:148)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.parse(AbstractSAXParser.java:1242)\n        at org.apache.commons.digester.Digester.parse(Digester.java:1685)\n...\n\n\"Thread-5\" prio=1 tid=0x0000002b25754eb0 nid=0x34f5 runnable [0x0000000041364000..0x0000000041364d30]\n        at java.lang.String.equals(String.java:858)\n        at org.apache.commons.beanutils.MethodUtils$MethodDescriptor.equals(MethodUtils.java:833)\n        at java.util.WeakHashMap.eq(WeakHashMap.java:254)\n        at java.util.WeakHashMap.get(WeakHashMap.java:345)\n        at org.apache.commons.beanutils.MethodUtils.getMatchingAccessibleMethod(MethodUtils.java:530)\n        at org.apache.commons.beanutils.MethodUtils.invokeMethod(MethodUtils.java:209)\n        at org.apache.commons.digester.CallMethodRule.end(CallMethodRule.java:625)\n        at org.apache.commons.digester.Rule.end(Rule.java:230)\n        at org.apache.commons.digester.Digester.endElement(Digester.java:1130)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.endElement(AbstractSAXParser.java:633)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanEndElement(XMLDocumentFragmentScannerImpl.java:1241)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl$FragmentContentDispatcher.dispatch(XMLDocumentFragmentScannerImpl.java:1685)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanDocument(XMLDocumentFragmentScannerImpl.java:368)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:834)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:764)\n        at com.sun.org.apache.xerces.internal.parsers.XMLParser.parse(XMLParser.java:148)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.parse(AbstractSAXParser.java:1242)\n        at org.apache.commons.digester.Digester.parse(Digester.java:1685)\n...\n\n\"Thread-4\" prio=1 tid=0x0000002b25754860 nid=0x34f4 runnable [0x0000000041263000..0x0000000041263cb0]\n        at java.lang.String.equals(String.java:858)\n        at org.apache.commons.beanutils.MethodUtils$MethodDescriptor.equals(MethodUtils.java:833)\n        at java.util.WeakHashMap.eq(WeakHashMap.java:254)\n        at java.util.WeakHashMap.get(WeakHashMap.java:345)\n        at org.apache.commons.beanutils.MethodUtils.getMatchingAccessibleMethod(MethodUtils.java:530)\n        at org.apache.commons.beanutils.MethodUtils.invokeMethod(MethodUtils.java:209)\n        at org.apache.commons.digester.CallMethodRule.end(CallMethodRule.java:625)\n        at org.apache.commons.digester.Rule.end(Rule.java:230)\n        at org.apache.commons.digester.Digester.endElement(Digester.java:1130)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.endElement(AbstractSAXParser.java:633)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanEndElement(XMLDocumentFragmentScannerImpl.java:1241)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl$FragmentContentDispatcher.dispatch(XMLDocumentFragmentScannerImpl.java:1685)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanDocument(XMLDocumentFragmentScannerImpl.java:368)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:834)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:764)\n        at com.sun.org.apache.xerces.internal.parsers.XMLParser.parse(XMLParser.java:148)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.parse(AbstractSAXParser.java:1242)\n        at org.apache.commons.digester.Digester.parse(Digester.java:1685)\n...\n\n\n\"Thread-3\" prio=1 tid=0x0000002b2509d360 nid=0x34f3 runnable [0x0000000041162000..0x0000000041162c30]\n        at java.lang.String.equals(String.java:858)\n        at org.apache.commons.beanutils.MethodUtils$MethodDescriptor.equals(MethodUtils.java:833)\n        at java.util.WeakHashMap.eq(WeakHashMap.java:254)\n        at java.util.WeakHashMap.get(WeakHashMap.java:345)\n        at org.apache.commons.beanutils.MethodUtils.getMatchingAccessibleMethod(MethodUtils.java:530)\n        at org.apache.commons.beanutils.MethodUtils.invokeMethod(MethodUtils.java:209)\n        at org.apache.commons.digester.CallMethodRule.end(CallMethodRule.java:625)\n        at org.apache.commons.digester.Rule.end(Rule.java:230)\n        at org.apache.commons.digester.Digester.endElement(Digester.java:1130)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.endElement(AbstractSAXParser.java:633)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanEndElement(XMLDocumentFragmentScannerImpl.java:1241)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl$FragmentContentDispatcher.dispatch(XMLDocumentFragmentScannerImpl.java:1685)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanDocument(XMLDocumentFragmentScannerImpl.java:368)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:834)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:764)\n        at com.sun.org.apache.xerces.internal.parsers.XMLParser.parse(XMLParser.java:148)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.parse(AbstractSAXParser.java:1242)\n        at org.apache.commons.digester.Digester.parse(Digester.java:1685)\n...\n\n\n\"Thread-2\" prio=1 tid=0x0000002b25083e00 nid=0x34f2 runnable [0x0000000041061000..0x0000000041061bb0]\n        at java.util.WeakHashMap.expungeStaleEntries(WeakHashMap.java:289)\n        at java.util.WeakHashMap.getTable(WeakHashMap.java:297)\n        at java.util.WeakHashMap.get(WeakHashMap.java:341)\n        at org.apache.commons.beanutils.MethodUtils.getMatchingAccessibleMethod(MethodUtils.java:530)\n        at org.apache.commons.beanutils.MethodUtils.invokeMethod(MethodUtils.java:209)\n        at org.apache.commons.digester.CallMethodRule.end(CallMethodRule.java:625)\n        at org.apache.commons.digester.Rule.end(Rule.java:230)\n        at org.apache.commons.digester.Digester.endElement(Digester.java:1130)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.endElement(AbstractSAXParser.java:633)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractXMLDocumentParser.emptyElement(AbstractXMLDocumentParser.java:221)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanStartElement(XMLDocumentFragmentScannerImpl.java:872)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl$FragmentContentDispatcher.dispatch(XMLDocumentFragmentScannerImpl.java:1693)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanDocument(XMLDocumentFragmentScannerImpl.java:368)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:834)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:764)\n        at com.sun.org.apache.xerces.internal.parsers.XMLParser.parse(XMLParser.java:148)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.parse(AbstractSAXParser.java:1242)\n        at org.apache.commons.digester.Digester.parse(Digester.java:1685)\n...\n\n\n\"Thread-1\" prio=1 tid=0x0000002b2509a4a0 nid=0x34f1 runnable [0x0000000040f60000..0x0000000040f60b30]\n        at java.util.WeakHashMap.expungeStaleEntries(WeakHashMap.java:289)\n        at java.util.WeakHashMap.getTable(WeakHashMap.java:297)\n        at java.util.WeakHashMap.get(WeakHashMap.java:341)\n        at org.apache.commons.beanutils.MethodUtils.getMatchingAccessibleMethod(MethodUtils.java:530)\n        at org.apache.commons.beanutils.MethodUtils.invokeMethod(MethodUtils.java:209)\n        at org.apache.commons.digester.CallMethodRule.end(CallMethodRule.java:625)\n        at org.apache.commons.digester.Rule.end(Rule.java:230)\n        at org.apache.commons.digester.Digester.endElement(Digester.java:1130)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.endElement(AbstractSAXParser.java:633)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractXMLDocumentParser.emptyElement(AbstractXMLDocumentParser.java:221)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanStartElement(XMLDocumentFragmentScannerImpl.java:872)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl$FragmentContentDispatcher.dispatch(XMLDocumentFragmentScannerImpl.java:1693)\n        at com.sun.org.apache.xerces.internal.impl.XMLDocumentFragmentScannerImpl.scanDocument(XMLDocumentFragmentScannerImpl.java:368)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:834)\n        at com.sun.org.apache.xerces.internal.parsers.XML11Configuration.parse(XML11Configuration.java:764)\n        at com.sun.org.apache.xerces.internal.parsers.XMLParser.parse(XMLParser.java:148)\n        at com.sun.org.apache.xerces.internal.parsers.AbstractSAXParser.parse(AbstractSAXParser.java:1242)\n        at org.apache.commons.digester.Digester.parse(Digester.java:1685)\n...\n\n\n\"Low Memory Detector\" daemon prio=1 tid=0x0000002b25002430 nid=0x34ef runnable [0x0000000000000000..0x0000000000000000]\n\n\"CompilerThread1\" daemon prio=1 tid=0x0000002b250009d0 nid=0x34ee waiting on condition [0x0000000000000000..0x0000000040c5c6d0]\n\n\"CompilerThread0\" daemon prio=1 tid=0x0000002b220c2ce0 nid=0x34ed waiting on condition [0x0000000000000000..0x0000000040b5b650]\n\n\"AdapterThread\" daemon prio=1 tid=0x0000002b220c1750 nid=0x34ec waiting on condition [0x0000000000000000..0x0000000000000000]\n\n\"Signal Dispatcher\" daemon prio=1 tid=0x0000002b220c02d0 nid=0x34eb runnable [0x0000000000000000..0x0000000000000000]\n\n\"Finalizer\" daemon prio=1 tid=0x0000002b220ae1e0 nid=0x34ea in Object.wait() [0x0000000040859000..0x0000000040859bb0]\n        at java.lang.Object.wait(Native Method)\n\n\twaiting on <0x0000002b0a8d7408> (a java.lang.ref.ReferenceQueue$Lock)\n        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:120)\n\tlocked <0x0000002b0a8d7408> (a java.lang.ref.ReferenceQueue$Lock)\n        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:136)\n        at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:159)\n\n\n\n\"Reference Handler\" daemon prio=1 tid=0x0000002b220ab980 nid=0x34e9 in Object.wait() [0x0000000040758000..0x0000000040758b30]\n        at java.lang.Object.wait(Native Method)\n\n\twaiting on <0x0000002b0a7da3b0> (a java.lang.ref.Reference$Lock)\n        at java.lang.Object.wait(Object.java:474)\n        at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:116)\n\tlocked <0x0000002b0a7da3b0> (a java.lang.ref.Reference$Lock)\n\n\n\n\"main\" prio=1 tid=0x0000000040115ea0 nid=0x34e3 waiting on condition [0x0000007fbfffc000..0x0000007fbfffd280]\n        at java.lang.Thread.sleep(Native Method)\n...\n\n\n\"VM Thread\" prio=1 tid=0x0000002b220a7480 nid=0x34e8 runnable \n\n\"GC task thread#0 (ParallelGC)\" prio=1 tid=0x0000000040133fe0 nid=0x34e4 runnable \n\n\"GC task thread#1 (ParallelGC)\" prio=1 tid=0x0000000040135630 nid=0x34e5 runnable \n\n\"GC task thread#2 (ParallelGC)\" prio=1 tid=0x0000000040136480 nid=0x34e6 runnable \n\n\"GC task thread#3 (ParallelGC)\" prio=1 tid=0x0000000040137300 nid=0x34e7 runnable \n\n\"VM Periodic Task Thread\" prio=1 tid=0x0000002b25004e10 nid=0x34f0 waiting on condition",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2008-09-11T17:45:58+0000",
            "content": "David, why not bring this up on java-user list first?\nAre your 4 IndexWriters writing to the same index?\nIs this really a Lucene problem? (I don't see any mentions of Lucene in those traces)\n ",
            "author": "Otis Gospodnetic",
            "id": "comment-12630270"
        },
        {
            "date": "2008-09-11T18:05:52+0000",
            "content": "Otis,\nYou are correct, I should have started by joining the mailing list and working with that first, sorry.\nAll threads share the same IndexWriter for the same index. \nI agree that nothing in the stack traces points to lucene and have been reviewing and upgrading the other apache libraries as well. This is fairly repeatable over time.\nDave ",
            "author": "David Fertig",
            "id": "comment-12630280"
        },
        {
            "date": "2008-09-11T19:00:13+0000",
            "content": "This is a new piece of code and the stack trace doesn't show Lucene, so I'm marking this as Invalid for now. ",
            "author": "Otis Gospodnetic",
            "id": "comment-12630310"
        },
        {
            "date": "2012-07-02T18:19:29+0000",
            "content": "This was fixed in BeanUtil version 1.8.3:\nhttps://issues.apache.org/jira/browse/BEANUTILS-373 ",
            "author": "yoav zibin",
            "id": "comment-13405197"
        }
    ]
}