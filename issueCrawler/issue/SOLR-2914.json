{
    "id": "SOLR-2914",
    "title": "UpdateRequestProcessor.proccessCommit Method not Called When Running DIH in Debug Mode",
    "details": {
        "affect_versions": "1.4.1",
        "status": "Closed",
        "fix_versions": [
            "3.5"
        ],
        "components": [
            "contrib - DataImportHandler"
        ],
        "type": "Bug",
        "priority": "Minor",
        "labels": "",
        "resolution": "Fixed"
    },
    "description": "Users can test their DIH import configuration files using the dataimport.jsp Admin page. If you check the commit box, and then run the DIH in debug mode, Lucene will commit the records to the index, but the UpdateRequestProcess.processCommit methods are not called. If you run the same DIH as a full import, the DIH will commit the documents, and the processCommit methods are called.",
    "attachments": {
        "solr-2914-config.zip": "https://issues.apache.org/jira/secure/attachment/12505053/solr-2914-config.zip"
    },
    "issue_links": {},
    "comments": [
        {
            "author": "Matt Parker",
            "id": "comment-13156960",
            "date": "2011-11-25T02:11:57+0000",
            "content": "I created a class that extends UpdateRequestProcessor, which logs calls to each method. In the console output, you'll see that only the processAdd methods are called when using the DIH in debug mode and the user checks verbose and commit.\n\nI've attached the SOLR configuration that can be used to replicate the issue. I'm assuming that once Lucene commits the files, the UpdateRequestProcessor.processCommit method should be called too. \n\nUpdateRequestProcessorTest.class\n\npackage org.apache.solr.handler.dataimport;\n\nimport java.io.IOException;\nimport org.apache.solr.update.AddUpdateCommand;\nimport org.apache.solr.update.CommitUpdateCommand;\nimport org.apache.solr.update.DeleteUpdateCommand;\nimport org.apache.solr.update.MergeIndexesCommand;\nimport org.apache.solr.update.RollbackUpdateCommand;\nimport org.apache.solr.update.processor.UpdateRequestProcessor;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\n/**\n\n\tClass used to show the interaction between the\n\tDIH process and the UpdateRequestProcessor chain.\n *\n */\npublic class UpdateRequestProcessorTest extends UpdateRequestProcessor\n{\n    protected static final Logger log = LoggerFactory.getLogger(UpdateRequestProcessorTest.class);\n\n\n\n    public UpdateRequestProcessorTest(UpdateRequestProcessor next) \n{\n        super(next);\n    }\n\n    public void finish() throws IOException \n{\n        log.info(\"finish called...\");\n        super.finish();\n    }\n\n    public void processAdd(AddUpdateCommand cmd) throws IOException \n{\n        log.info(\"processAdd called...\");\n        super.processAdd(cmd);\n    }\n\n    public void processDelete(DeleteUpdateCommand cmd) throws IOException \n{\n        log.info(\"processDelete called...\");\n        super.processDelete(cmd);\n    }\n\n    public void processMergeIndexes(MergeIndexesCommand cmd) throws IOException \n{\n        log.info(\"processMergeIndexes called...\");\n        super.processMergeIndexes(cmd);\n    }\n\n    public void processRollback(RollbackUpdateCommand cmd) throws IOException \n{\n        log.info(\"processRollback called...\");\n        super.processRollback(cmd);\n    }\n\n    public void processCommit(CommitUpdateCommand cmd) throws IOException \n{\n        log.info(\"processCommit called...\");\n        super.processCommit(cmd);\n    }\n\n}\n\nUpdateRequestProcessorTestFactory.class\n\npackage org.apache.solr.handler.dataimport;\n\nimport org.apache.solr.request.SolrQueryRequest;\nimport org.apache.solr.request.SolrQueryResponse;\nimport org.apache.solr.update.processor.UpdateRequestProcessor;\nimport org.apache.solr.update.processor.UpdateRequestProcessorFactory;\n\n/**\n\n\tFactory used to instantiate the UpdateRequestProcessorTest class\n\tin the UpdateRequest processor chain.\n *\n */\npublic class UpdateRequestProcessorTestFactory extends UpdateRequestProcessorFactory {\n\n\n\n    public UpdateRequestProcessor getInstance( SolrQueryRequest req, SolrQueryResponse rsp, UpdateRequestProcessor next )\n{\n        return new UpdateRequestProcessorTest(next);\n    }\n\n}\n\n\nConsole Output\n\nNov 24, 2011 8:50:39 PM org.apache.solr.core.SolrCore execute\nINFO: [] webapp=null path=null params=\n{start=0&event=firstSearcher&q=solr+rocks&rows=10}\n hits=0 status=0 QTime=74\nNov 24, 2011 8:50:39 PM org.apache.solr.core.SolrCore execute\nINFO: [] webapp=null path=null params=\n{event=firstSearcher&q=static+firstSearcher+warming+query+from+solrconfig.xml}\n hits=85 status=0 QTime=27\nNov 24, 2011 8:50:39 PM org.apache.solr.core.QuerySenderListener newSearcher\nINFO: QuerySenderListener done.\nNov 24, 2011 8:50:39 PM org.apache.solr.handler.component.SpellCheckComponent$SpellCheckerListener newSearcher\nINFO: Loading spell index for spellchecker: default\nNov 24, 2011 8:50:39 PM org.apache.solr.core.SolrCore registerSearcher\nINFO: [] Registered new searcher Searcher@6e4eeaaf main\nNov 24, 2011 8:51:32 PM org.apache.solr.core.SolrCore execute\nINFO: [] webapp=/solr path=/select params=\n{command=status&qt=/solr-2914-test-case}\n status=0 QTime=7\nNov 24, 2011 8:51:32 PM org.apache.solr.core.SolrCore execute\nINFO: [] webapp=/solr path=/select params=\n{command=show-config&qt=/solr-2914-test-case}\n status=0 QTime=1\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.DataImportHandler processConfiguration\nINFO: Processing configuration from solrconfig.xml: \n{config=./file-data-source-config.xml,update.processor=dih_test}\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.DataImporter loadDataConfig\nINFO: Data Configuration loaded successfully\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.DataImporter verifyWithSchema\nINFO: id is a required field in SolrSchema . But not found in DataConfig\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.DataImporter doFullImport\nINFO: Starting Full Import\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.SolrWriter readIndexerProperties\nINFO: Read solr-2914-test-case.properties\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.LogTransformer transformRow\nINFO:       Processing C:\\Projects\\solr-test-cases\\SOLR-2914\\solr\\sample-data\\artcle1.txt\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.UpdateRequestProcessorTest processAdd\nINFO: processAdd called...\nNov 24, 2011 8:51:41 PM org.apache.solr.core.SolrDeletionPolicy onInit\nINFO: SolrDeletionPolicy.onInit: commits:num=1\n        commit{dir=C:\\Projects\\apache-solr-1.4.1\\example\\solr\\data\\index,segFN=segments_g,version=1322170573144,generation=16,filenames=[_l.fnm, _m.frq, _m.prx, _l.frq, _n.tis, _m.tis, _l.tis, _n.frq, _n.tii, _m.tii, _l.tii,\n _m.fnm, _n.fnm, _l.nrm, _n.nrm, _l.prx, _n.prx, _n.fdt, _n.fdx, _m.nrm, segments_g, _m.fdt, _l.fdx, _m.fdx, _l.fdt]\nNov 24, 2011 8:51:41 PM org.apache.solr.core.SolrDeletionPolicy updateCommits\nINFO: newest commit = 1322170573144\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.LogTransformer transformRow\nINFO:       Processing C:\\Projects\\solr-test-cases\\SOLR-2914\\solr\\sample-data\\article2.txt\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.UpdateRequestProcessorTest processAdd\nINFO: processAdd called...\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.LogTransformer transformRow\nINFO:       Processing C:\\Projects\\solr-test-cases\\SOLR-2914\\solr\\sample-data\\article3.txt\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.UpdateRequestProcessorTest processAdd\nINFO: processAdd called...\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.LogTransformer transformRow\nINFO:       Processing C:\\Projects\\solr-test-cases\\SOLR-2914\\solr\\sample-data\\article4.txt\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.UpdateRequestProcessorTest processAdd\nINFO: processAdd called...\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.LogTransformer transformRow\nINFO:       Processing C:\\Projects\\solr-test-cases\\SOLR-2914\\solr\\sample-data\\article5.txt\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.UpdateRequestProcessorTest processAdd\nINFO: processAdd called...\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.DocBuilder finish\nINFO: Import completed successfully\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.SolrWriter readIndexerProperties\nINFO: Read solr-2914-test-case.properties\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.SolrWriter persist\nINFO: Wrote last indexed time to solr-2914-test-case.properties\nNov 24, 2011 8:51:41 PM org.apache.solr.handler.dataimport.DocBuilder execute\nINFO: Time taken = 0:0:0.270\nNov 24, 2011 8:51:41 PM org.apache.solr.core.SolrCore execute\nINFO: [] webapp=/solr path=/select params={commit=on&start=0&dataConfig=<?xml+version%3D'1.0'?>%0d%0a+<dataConfig>%0d%0a+++<dataSource+type%3D\"FileDataSource\"/>%0d%0a+++<document>%0d%0a+++++++<entity+name%3D\"f\"+processor\n%3D\"FileListEntityProcessor\"baseDir%3D\"C:/Projects/solr-test-cases/SOLR-2914/solr/sample-data\"+fileName%3D\".*txt\"+rootEntity%3D\"false\"+dataSource%3D\"null\">%0d%0a%09%09+++<entity+processor%3D\"PlainTextEntityProcessor\"+name%\n3D\"x\"url%3D\"${f.fileAbsolutePath}\"+dataSource%3D\"f\"+transformer%3D\"LogTransformer\"+logTemplate%3D\"++++Processing${f.fileAbsolutePath}\"logLevel%3D\"info\">%0d%0a++++++++++++++++<!--+copies+the+text+to+a+field+called'tex\nt'in+Solr-->%0d%0a++++++++++++++<field+column%3D\"plainText\"+name%3D\"text\"/>%0d%0a++++++++++</entity>%0d%0a++++++</entity>%0d%0a+++</document>%0d%0a</dataConfig>&verbose=on&command=full-import&debug=on&qt=/solr-2914-t\nest-case&rows=10} status=0 QTime=291 "
        },
        {
            "author": "Matt Parker",
            "id": "comment-13156963",
            "date": "2011-11-25T02:16:21+0000",
            "content": "But if you run the DIH again by pressing the \"Full Import\" button, the processCommit method is called.\n\nConsole Output\n\nNov 24, 2011 9:13:40 PM org.apache.solr.core.SolrDeletionPolicy onInit\nINFO: SolrDeletionPolicy.onInit: commits:num=1\n        commit{dir=C:\\Projects\\apache-solr-1.4.1\\example\\solr\\data\\index,segFN=segments_h,version=1322170573145,generation=17,filenames=[_l.fnm, _m.frq, _m.prx, _l.frq, _o.tis, _n.tis, _o.prx, _m.tis, _l.tis, _n.frq, _n.tii,\n _m.tii, _l.tii, _m.fnm, _o.frq, _n.fnm, _o.fdt, _l.nrm, _n.nrm, _o.fnm, _o.fdx, _l.prx, _n.prx, _n.fdt, _n.fdx, _m.nrm, segments_h, _o.nrm, _m.fdt, _l.fdx, _o.tii, _m.fdx, _l.fdt]\nNov 24, 2011 9:13:40 PM org.apache.solr.core.SolrDeletionPolicy updateCommits\nINFO: newest commit = 1322170573145\nNov 24, 2011 9:13:40 PM org.apache.solr.handler.dataimport.LogTransformer transformRow\nINFO:       Processing C:\\Projects\\solr-test-cases\\SOLR-2914\\solr\\sample-data\\article2.txt\nNov 24, 2011 9:13:40 PM org.apache.solr.handler.dataimport.UpdateRequestProcessorTest processAdd\nINFO: processAdd called...\nNov 24, 2011 9:13:40 PM org.apache.solr.handler.dataimport.LogTransformer transformRow\nINFO:       Processing C:\\Projects\\solr-test-cases\\SOLR-2914\\solr\\sample-data\\article3.txt\nNov 24, 2011 9:13:40 PM org.apache.solr.handler.dataimport.UpdateRequestProcessorTest processAdd\nINFO: processAdd called...\nNov 24, 2011 9:13:40 PM org.apache.solr.handler.dataimport.LogTransformer transformRow\nINFO:       Processing C:\\Projects\\solr-test-cases\\SOLR-2914\\solr\\sample-data\\article4.txt\nNov 24, 2011 9:13:40 PM org.apache.solr.handler.dataimport.UpdateRequestProcessorTest processAdd\nINFO: processAdd called...\nNov 24, 2011 9:13:40 PM org.apache.solr.handler.dataimport.LogTransformer transformRow\nINFO:       Processing C:\\Projects\\solr-test-cases\\SOLR-2914\\solr\\sample-data\\article5.txt\nNov 24, 2011 9:13:40 PM org.apache.solr.handler.dataimport.UpdateRequestProcessorTest processAdd\nINFO: processAdd called...\nNov 24, 2011 9:13:40 PM org.apache.solr.handler.dataimport.DocBuilder finish\nINFO: Import completed successfully\nNov 24, 2011 9:13:40 PM org.apache.solr.handler.dataimport.UpdateRequestProcessorTest processCommit\nINFO: processCommit called...\nNov 24, 2011 9:13:40 PM org.apache.solr.update.DirectUpdateHandler2 commit\nINFO: start commit(optimize=true,waitFlush=false,waitSearcher=true,expungeDeletes=false) "
        },
        {
            "author": "Matt Parker",
            "id": "comment-13156966",
            "date": "2011-11-25T02:41:54+0000",
            "content": "I attached a setup of SOLR configuration files to replicate the issue.\n\nChange the basedir in file-data-source-config.xml to import the files.\n\nOnce SOLR is started, go to the dataimport.jsp page and run the SOLR-2914-Test-Case data handler. "
        },
        {
            "author": "Hoss Man",
            "id": "comment-13159057",
            "date": "2011-11-29T03:07:36+0000",
            "content": "As noted on the mailing list, this problem seems to have been fixed at some point between Solr 1.4.1 and Solr 3.5 (exactly when isn't obvious to me at the moment)\n\nhttps://mail-archives.apache.org/mod_mbox/lucene-solr-user/201111.mbox/%3Calpine.DEB.2.00.1111281659090.28937@bester%3E\n\nMatt: I tied testing your zip file to be sure, but it wouldn't work with 3.5 because of API changes in the UpdateProcessor classes \u2013 if you still reproduce a problem with 3.5 please feel free to reopen.  \n "
        },
        {
            "author": "Matt Parker",
            "id": "comment-13159755",
            "date": "2011-11-30T02:31:15+0000",
            "content": "Thanks for reviewing my posts. I'll look more into the DIH API. "
        }
    ]
}