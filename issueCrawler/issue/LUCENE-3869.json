{
    "id": "LUCENE-3869",
    "title": "possible hang in UIMATypeAwareAnalyzerTest",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [
            "modules/analysis"
        ],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "4.0-ALPHA",
        "resolution": "Unresolved",
        "status": "Open"
    },
    "description": "Just testing an unrelated patch, I was hung (with 100% cpu) in UIMATypeAwareAnalyzerTest.\n\nI'll attach stacktrace at the moment of the hang.\n\nThe fact we get a seed in the actual stacktraces for cases like this is awesome! Thanks Dawid!\nI don't think it reproduces 100%, but I'll try beasting this seed to see if i can reproduce the hang:\n\nshould be 'ant test -Dtestcase=UIMATypeAwareAnalyzerTest -Dtests.seed=-262aada3325aa87a:-44863926cf5c87e9:5c8c471d901b98bd' \nfrom what I can see.",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2012-03-14T14:52:18+0000",
            "content": "Stacktrace:\n\njunit-sequential:\n    [junit] Testsuite: org.apache.lucene.analysis.uima.UIMABaseAnalyzerTest\n    [junit] Tests run: 3, Failures: 0, Errors: 0, Time elapsed: 4.603 sec\n    [junit] \n    [junit] Testsuite: org.apache.lucene.analysis.uima.UIMATypeAwareAnalyzerTest\n    [junit] 2012-03-14 10:42:27\n    [junit] Full thread dump Java HotSpot(TM) 64-Bit Server VM (19.1-b02 mixed mode):\n    [junit] \n    [junit] \"Thread-9\" prio=10 tid=0x00007f3ba44af000 nid=0x34d1 runnable [0x00007f3ba3a72000]\n    [junit]    java.lang.Thread.State: RUNNABLE\n    [junit] \tat java.util.HashMap.transfer(HashMap.java:484)\n    [junit] \tat java.util.HashMap.resize(HashMap.java:463)\n    [junit] \tat java.util.HashMap.addEntry(HashMap.java:755)\n    [junit] \tat java.util.HashMap.put(HashMap.java:385)\n    [junit] \tat java.util.HashSet.add(HashSet.java:200)\n    [junit] \tat org.apache.uima.analysis_engine.impl.AnalysisEngineManagementImpl.setName(AnalysisEngineManagementImpl.java:245)\n    [junit] \tat org.apache.uima.analysis_engine.impl.AnalysisEngineImplBase.initialize(AnalysisEngineImplBase.java:181)\n    [junit] \tat org.apache.uima.analysis_engine.impl.AggregateAnalysisEngine_impl.initialize(AggregateAnalysisEngine_impl.java:127)\n    [junit] \tat org.apache.uima.impl.AnalysisEngineFactory_impl.produceResource(AnalysisEngineFactory_impl.java:94)\n    [junit] \tat org.apache.uima.impl.CompositeResourceFactory_impl.produceResource(CompositeResourceFactory_impl.java:62)\n    [junit] \tat org.apache.uima.UIMAFramework.produceResource(UIMAFramework.java:267)\n    [junit] \tat org.apache.uima.UIMAFramework.produceAnalysisEngine(UIMAFramework.java:335)\n    [junit] \tat org.apache.lucene.analysis.uima.ae.BasicAEProvider.getAE(BasicAEProvider.java:73)\n    [junit] \tat org.apache.lucene.analysis.uima.BaseUIMATokenizer.<init>(BaseUIMATokenizer.java:45)\n    [junit] \tat org.apache.lucene.analysis.uima.UIMATypeAwareAnnotationsTokenizer.<init>(UIMATypeAwareAnnotationsTokenizer.java:54)\n    [junit] \tat org.apache.lucene.analysis.uima.UIMATypeAwareAnalyzer.createComponents(UIMATypeAwareAnalyzer.java:40)\n    [junit] \tat org.apache.lucene.analysis.Analyzer.tokenStream(Analyzer.java:83)\n    [junit] \tat org.apache.lucene.analysis.BaseTokenStreamTestCase.checkRandomData(BaseTokenStreamTestCase.java:368)\n    [junit] \tat org.apache.lucene.analysis.BaseTokenStreamTestCase.checkRandomData(BaseTokenStreamTestCase.java:338)\n    [junit] \tat org.apache.lucene.analysis.BaseTokenStreamTestCase$AnalysisThread.run(BaseTokenStreamTestCase.java:330)\n    [junit] \n    [junit] \"Low Memory Detector\" daemon prio=10 tid=0x0000000041a0d000 nid=0x34c7 runnable [0x0000000000000000]\n    [junit]    java.lang.Thread.State: RUNNABLE\n    [junit] \n    [junit] \"CompilerThread1\" daemon prio=10 tid=0x0000000041a0a800 nid=0x34c6 waiting on condition [0x0000000000000000]\n    [junit]    java.lang.Thread.State: RUNNABLE\n    [junit] \n    [junit] \"CompilerThread0\" daemon prio=10 tid=0x0000000041a08000 nid=0x34c5 waiting on condition [0x0000000000000000]\n    [junit]    java.lang.Thread.State: RUNNABLE\n    [junit] \n    [junit] \"Signal Dispatcher\" daemon prio=10 tid=0x0000000041a05800 nid=0x34c4 waiting on condition [0x0000000000000000]\n    [junit]    java.lang.Thread.State: RUNNABLE\n    [junit] \n    [junit] \"Finalizer\" daemon prio=10 tid=0x00000000419e9000 nid=0x34c3 in Object.wait() [0x00007f3ba0920000]\n    [junit]    java.lang.Thread.State: WAITING (on object monitor)\n    [junit] \tat java.lang.Object.wait(Native Method)\n    [junit] \t- waiting on <0x00000000e6920d88> (a java.lang.ref.ReferenceQueue$Lock)\n    [junit] \tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:118)\n    [junit] \t- locked <0x00000000e6920d88> (a java.lang.ref.ReferenceQueue$Lock)\n    [junit] \tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:134)\n    [junit] \tat java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:159)\n    [junit] \n    [junit] \"Reference Handler\" daemon prio=10 tid=0x00000000419e6800 nid=0x34c2 in Object.wait() [0x00007f3ba8a21000]\n    [junit]    java.lang.Thread.State: WAITING (on object monitor)\n    [junit] \tat java.lang.Object.wait(Native Method)\n    [junit] \t- waiting on <0x00000000e6920d20> (a java.lang.ref.Reference$Lock)\n    [junit] \tat java.lang.Object.wait(Object.java:485)\n    [junit] \tat java.lang.ref.Reference$ReferenceHandler.run(Reference.java:116)\n    [junit] \t- locked <0x00000000e6920d20> (a java.lang.ref.Reference$Lock)\n    [junit] \n    [junit] \"LTC-main#seed=-262aada3325aa87a:-44863926cf5c87e9:5c8c471d901b98bd\" prio=10 tid=0x000000004197a800 nid=0x34b8 in Object.wait() [0x00007f3badfc6000]\n    [junit]    java.lang.Thread.State: WAITING (on object monitor)\n    [junit] \tat java.lang.Object.wait(Native Method)\n    [junit] \t- waiting on <0x00000000e9350b58> (a org.apache.lucene.analysis.BaseTokenStreamTestCase$AnalysisThread)\n    [junit] \tat java.lang.Thread.join(Thread.java:1186)\n    [junit] \t- locked <0x00000000e9350b58> (a org.apache.lucene.analysis.BaseTokenStreamTestCase$AnalysisThread)\n    [junit] \tat java.lang.Thread.join(Thread.java:1239)\n    [junit] \tat org.apache.lucene.analysis.BaseTokenStreamTestCase.checkRandomData(BaseTokenStreamTestCase.java:305)\n    [junit] \tat org.apache.lucene.analysis.BaseTokenStreamTestCase.checkRandomData(BaseTokenStreamTestCase.java:285)\n    [junit] \tat org.apache.lucene.analysis.uima.UIMATypeAwareAnalyzerTest.testRandomStrings(UIMATypeAwareAnalyzerTest.java:63)\n    [junit] \tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    [junit] \tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n    [junit] \tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n    [junit] \tat java.lang.reflect.Method.invoke(Method.java:597)\n    [junit] \tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:45)\n    [junit] \tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)\n    [junit] \tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:42)\n    [junit] \tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)\n    [junit] \tat org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)\n    [junit] \tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:30)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:729)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:645)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:556)\n    [junit] \tat org.apache.lucene.util.UncaughtExceptionsRule$1.evaluate(UncaughtExceptionsRule.java:51)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:618)\n    [junit] \tat org.junit.rules.RunRules.evaluate(RunRules.java:18)\n    [junit] \tat org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:263)\n    [junit] \tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:68)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)\n    [junit] \tat org.junit.runners.ParentRunner$3.run(ParentRunner.java:231)\n    [junit] \tat org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:60)\n    [junit] \tat org.junit.runners.ParentRunner.runChildren(ParentRunner.java:229)\n    [junit] \tat org.junit.runners.ParentRunner.access$000(ParentRunner.java:50)\n    [junit] \tat org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:222)\n    [junit] \tat org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)\n    [junit] \tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:30)\n    [junit] \tat org.apache.lucene.util.UncaughtExceptionsRule$1.evaluate(UncaughtExceptionsRule.java:51)\n    [junit] \tat org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)\n    [junit] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)\n    [junit] \tat org.junit.rules.RunRules.evaluate(RunRules.java:18)\n    [junit] \tat org.junit.runners.ParentRunner.run(ParentRunner.java:300)\n    [junit] \tat junit.framework.JUnit4TestAdapter.run(JUnit4TestAdapter.java:39)\n    [junit] \tat org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.run(JUnitTestRunner.java:420)\n    [junit] \tat org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.launch(JUnitTestRunner.java:911)\n    [junit] \tat org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.main(JUnitTestRunner.java:743)\n    [junit] \n    [junit] \"VM Thread\" prio=10 tid=0x00000000419e0000 nid=0x34c1 runnable \n    [junit] \n    [junit] \"GC task thread#0 (ParallelGC)\" prio=10 tid=0x000000004198d800 nid=0x34b9 runnable \n    [junit] \n    [junit] \"GC task thread#1 (ParallelGC)\" prio=10 tid=0x000000004198f800 nid=0x34ba runnable \n    [junit] \n    [junit] \"GC task thread#2 (ParallelGC)\" prio=10 tid=0x0000000041991800 nid=0x34bb runnable \n    [junit] \n    [junit] \"GC task thread#3 (ParallelGC)\" prio=10 tid=0x0000000041993000 nid=0x34bc runnable \n    [junit] \n    [junit] \"GC task thread#4 (ParallelGC)\" prio=10 tid=0x0000000041995000 nid=0x34bd runnable \n    [junit] \n    [junit] \"GC task thread#5 (ParallelGC)\" prio=10 tid=0x0000000041997000 nid=0x34be runnable \n    [junit] \n    [junit] \"GC task thread#6 (ParallelGC)\" prio=10 tid=0x0000000041998800 nid=0x34bf runnable \n    [junit] \n    [junit] \"GC task thread#7 (ParallelGC)\" prio=10 tid=0x000000004199a800 nid=0x34c0 runnable \n    [junit] \n    [junit] \"VM Periodic Task Thread\" prio=10 tid=0x0000000041a20000 nid=0x34c8 waiting on condition \n    [junit] \n    [junit] JNI global references: 1343\n    [junit] \n    [junit] Heap\n    [junit]  PSYoungGen      total 116480K, used 5575K [0x00000000f5560000, 0x0000000100000000, 0x0000000100000000)\n    [junit]   eden space 58240K, 9% used [0x00000000f5560000,0x00000000f5a89d50,0x00000000f8e40000)\n    [junit]   from space 58240K, 0% used [0x00000000f8e40000,0x00000000f8e88000,0x00000000fc720000)\n    [junit]   to   space 58240K, 0% used [0x00000000fc720000,0x00000000fc720000,0x0000000100000000)\n    [junit]  PSOldGen        total 299776K, used 163822K [0x00000000e0000000, 0x00000000f24c0000, 0x00000000f5560000)\n    [junit]   object space 299776K, 54% used [0x00000000e0000000,0x00000000e9ffb930,0x00000000f24c0000)\n    [junit]  PSPermGen       total 33600K, used 17723K [0x00000000dae00000, 0x00000000dced0000, 0x00000000e0000000)\n    [junit]   object space 33600K, 52% used [0x00000000dae00000,0x00000000dbf4ee90,0x00000000dced0000)\n\n ",
            "author": "Robert Muir",
            "id": "comment-13229238"
        },
        {
            "date": "2012-03-14T14:58:22+0000",
            "content": "Thanks Robert, I'm taking a look ",
            "author": "Tommaso Teofili",
            "id": "comment-13229241"
        },
        {
            "date": "2012-03-14T15:19:05+0000",
            "content": "If you try this seed a lot of times, eventually it will reproduce.\n\nI tried adding -Dtests.iter=10 to my command-line, \nso 'ant test -Dtestcase=UIMATypeAwareAnalyzerTest -Dtests.seed=-262aada3325aa87a:-44863926cf5c87e9:5c8c471d901b98bd -Dtests.iter=10'\n\nafter about 3 or 4 runs it hung... though interestingly it hung at 200% cpu usage (as if two of the analysis threads were stuck).\n\nStacktrace is in the same place, just for both threads:\n\n    [junit] \"Thread-48\" prio=10 tid=0x00007fbec0b9c000 nid=0x4979 runnable [0x00007fbebfa7d000]\n    [junit]    java.lang.Thread.State: RUNNABLE\n    [junit] \tat java.util.HashMap.getEntry(HashMap.java:347)\n    [junit] \tat java.util.HashMap.containsKey(HashMap.java:335)\n    [junit] \tat java.util.HashSet.contains(HashSet.java:184)\n    [junit] \tat org.apache.uima.analysis_engine.impl.AnalysisEngineManagementImpl.setName(AnalysisEngineManagementImpl.java:242)\n    [junit] \tat org.apache.uima.analysis_engine.impl.AnalysisEngineImplBase.initialize(AnalysisEngineImplBase.java:181)\n    [junit] \tat org.apache.uima.analysis_engine.impl.AggregateAnalysisEngine_impl.initialize(AggregateAnalysisEngine_impl.java:127)\n    [junit] \tat org.apache.uima.impl.AnalysisEngineFactory_impl.produceResource(AnalysisEngineFactory_impl.java:94)\n    [junit] \tat org.apache.uima.impl.CompositeResourceFactory_impl.produceResource(CompositeResourceFactory_impl.java:62)\n    [junit] \tat org.apache.uima.UIMAFramework.produceResource(UIMAFramework.java:267)\n    [junit] \tat org.apache.uima.UIMAFramework.produceAnalysisEngine(UIMAFramework.java:335)\n    [junit] \tat org.apache.lucene.analysis.uima.ae.BasicAEProvider.getAE(BasicAEProvider.java:73)\n    [junit] \tat org.apache.lucene.analysis.uima.BaseUIMATokenizer.<init>(BaseUIMATokenizer.java:45)\n    [junit] \tat org.apache.lucene.analysis.uima.UIMATypeAwareAnnotationsTokenizer.<init>(UIMATypeAwareAnnotationsTokenizer.java:54)\n    [junit] \tat org.apache.lucene.analysis.uima.UIMATypeAwareAnalyzer.createComponents(UIMATypeAwareAnalyzer.java:40)\n    [junit] \tat org.apache.lucene.analysis.Analyzer.tokenStream(Analyzer.java:83)\n    [junit] \tat org.apache.lucene.analysis.BaseTokenStreamTestCase.checkRandomData(BaseTokenStreamTestCase.java:368)\n    [junit] \tat org.apache.lucene.analysis.BaseTokenStreamTestCase.checkRandomData(BaseTokenStreamTestCase.java:338)\n    [junit] \tat org.apache.lucene.analysis.BaseTokenStreamTestCase$AnalysisThread.run(BaseTokenStreamTestCase.java:330)\n    [junit] \n    [junit] \"Thread-46\" prio=10 tid=0x00007fbec10df000 nid=0x4977 runnable [0x00007fbebfb7e000]\n    [junit]    java.lang.Thread.State: RUNNABLE\n    [junit] \tat java.util.HashMap.getEntry(HashMap.java:347)\n    [junit] \tat java.util.HashMap.containsKey(HashMap.java:335)\n    [junit] \tat java.util.HashSet.contains(HashSet.java:184)\n    [junit] \tat org.apache.uima.analysis_engine.impl.AnalysisEngineManagementImpl.setName(AnalysisEngineManagementImpl.java:242)\n    [junit] \tat org.apache.uima.analysis_engine.impl.AnalysisEngineImplBase.initialize(AnalysisEngineImplBase.java:181)\n    [junit] \tat org.apache.uima.analysis_engine.impl.AggregateAnalysisEngine_impl.initialize(AggregateAnalysisEngine_impl.java:127)\n    [junit] \tat org.apache.uima.impl.AnalysisEngineFactory_impl.produceResource(AnalysisEngineFactory_impl.java:94)\n    [junit] \tat org.apache.uima.impl.CompositeResourceFactory_impl.produceResource(CompositeResourceFactory_impl.java:62)\n    [junit] \tat org.apache.uima.UIMAFramework.produceResource(UIMAFramework.java:267)\n    [junit] \tat org.apache.uima.UIMAFramework.produceAnalysisEngine(UIMAFramework.java:335)\n    [junit] \tat org.apache.lucene.analysis.uima.ae.BasicAEProvider.getAE(BasicAEProvider.java:73)\n    [junit] \tat org.apache.lucene.analysis.uima.BaseUIMATokenizer.<init>(BaseUIMATokenizer.java:45)\n    [junit] \tat org.apache.lucene.analysis.uima.UIMATypeAwareAnnotationsTokenizer.<init>(UIMATypeAwareAnnotationsTokenizer.java:54)\n    [junit] \tat org.apache.lucene.analysis.uima.UIMATypeAwareAnalyzer.createComponents(UIMATypeAwareAnalyzer.java:40)\n    [junit] \tat org.apache.lucene.analysis.Analyzer.tokenStream(Analyzer.java:83)\n    [junit] \tat org.apache.lucene.analysis.BaseTokenStreamTestCase.checkRandomData(BaseTokenStreamTestCase.java:368)\n    [junit] \tat org.apache.lucene.analysis.BaseTokenStreamTestCase.checkRandomData(BaseTokenStreamTestCase.java:338)\n    [junit] \tat org.apache.lucene.analysis.BaseTokenStreamTestCase$AnalysisThread.run(BaseTokenStreamTestCase.java:330)\n\n ",
            "author": "Robert Muir",
            "id": "comment-13229255"
        },
        {
            "date": "2012-03-15T06:41:14+0000",
            "content": "I tried to reproduce that many times (same command/seed) but with no luck so far, which environment are you running Robert? ",
            "author": "Tommaso Teofili",
            "id": "comment-13229939"
        },
        {
            "date": "2012-03-15T11:02:35+0000",
            "content": "linux amd64. I can try to dig into this, and ill try upgrading my jvm etc too, its a bit outdated  ",
            "author": "Robert Muir",
            "id": "comment-13230069"
        },
        {
            "date": "2012-03-15T21:09:38+0000",
            "content": "I think i got lucky yesterday twice... its pretty hard to reproduce this now. Maybe a thread-safety issue?\n\nI'll look more. My computer has been known to be crazy... dont waste time on this one Tommaso, I'll try to dig in more. ",
            "author": "Robert Muir",
            "id": "comment-13230549"
        },
        {
            "date": "2012-03-16T09:23:24+0000",
            "content": "Ok thanks Robert, let me know if you find a specific scenario where this happens more frequently so that I can try it out as well.  ",
            "author": "Tommaso Teofili",
            "id": "comment-13230987"
        },
        {
            "date": "2012-03-16T14:33:14+0000",
            "content": "Tommaso my computer has been crazy before... I'll keep the issue open for a while and if someone else\nencounters this running tests, then we can take it more seriously. Otherwise after some time I will\njust cancel it as \"not a problem\". ",
            "author": "Robert Muir",
            "id": "comment-13231238"
        },
        {
            "date": "2015-03-25T16:08:32+0000",
            "content": "I think maybe this same hang happened again: http://build-eu-00.elastic.co/job/lucene_linux_java8_64_test_only/38965/console ",
            "author": "Michael McCandless",
            "id": "comment-14380128"
        },
        {
            "date": "2018-06-18T17:00:31+0000",
            "content": "I have no failures in Hoss' rollups since early March for:\nUIMABaseAnalyzerTest.testRandomStrings\nUIMABaseAnalyzerTest.testRandomStringsWithConfigurationParameters\nUIMATypeAwareAnalyzerTest.testRandomStrings\n\nCan I un-annotate them? Last week I just skipped anything with AwaitsFix, this week I'm looking at them a little more closely. ",
            "author": "Erick Erickson",
            "id": "comment-16516016"
        }
    ]
}