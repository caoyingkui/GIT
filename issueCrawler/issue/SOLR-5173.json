{
    "id": "SOLR-5173",
    "title": "Solr-core's Maven configuration includes test-only Hadoop dependencies as indirect compile-time dependencies",
    "details": {
        "affect_versions": "4.4",
        "status": "Closed",
        "fix_versions": [
            "4.5",
            "6.0"
        ],
        "components": [
            "Build"
        ],
        "type": "Bug",
        "priority": "Blocker",
        "labels": "",
        "resolution": "Fixed"
    },
    "description": "Chris Collins reported on solr-user that solr-core 4.4 has dependencies on hadoop, and indirectly on jetty 6.\n\nAs a workaround for Maven dependencies, the indirect jetty 6 dependency/ies can be excluded.\n\nThe Maven configuration should exclude any compile-time (and also run-time) dependencies that are not Ant/Ivy compile- and run-time dependencies, including jetty 6.",
    "attachments": {
        "SOLR-5173.patch": "https://issues.apache.org/jira/secure/attachment/12598765/SOLR-5173.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "author": "Robert Muir",
            "id": "comment-13743830",
            "date": "2013-08-19T14:03:58+0000",
            "content": "\nI think we can just remove the jetty and jetty-util 6.1.26 license files from solr/licenses/, since we don't ship those jars.\n\nWell as far as source release goes, we dont ship any jars. So do we really not care about licensing just because something is used by test code versus source code? Personally I would prefer if we still tracked this and didn't let it become a free-for-all. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13743832",
            "date": "2013-08-19T14:05:37+0000",
            "content": "I'm also +1 on keeping those license files - the src release includes all test stuff, and I think it's just the safe play. "
        },
        {
            "author": "Steve Rowe",
            "id": "comment-13743841",
            "date": "2013-08-19T14:21:55+0000",
            "content": "Actually, I was wrong about the binary distribution containing Jetty 6 license files - it contains the .jar.sha1 files for Jetty 6, but not the license files.\n\nIn fact, there is a whole bunch of .sha1 files included in the binary distribution that don't need to be there:\n\nsolr-4.4.0/licenses/activation-1.1.jar.sha1\nsolr-4.4.0/licenses/AlchemyAPIAnnotator-2.3.1.jar.sha1\nsolr-4.4.0/licenses/ant-1.8.2.jar.sha1\nsolr-4.4.0/licenses/apache-mime4j-core-0.7.2.jar.sha1\nsolr-4.4.0/licenses/apache-mime4j-dom-0.7.2.jar.sha1\nsolr-4.4.0/licenses/attributes-binder-1.0.1.jar.sha1\nsolr-4.4.0/licenses/bcmail-jdk15-1.45.jar.sha1\nsolr-4.4.0/licenses/bcprov-jdk15-1.45.jar.sha1\nsolr-4.4.0/licenses/boilerpipe-1.1.0.jar.sha1\nsolr-4.4.0/licenses/carrot2-mini-3.6.2.jar.sha1\nsolr-4.4.0/licenses/cglib-nodep-2.2.jar.sha1\nsolr-4.4.0/licenses/commons-beanutils-1.7.0.jar.sha1\nsolr-4.4.0/licenses/commons-cli-1.2.jar.sha1\nsolr-4.4.0/licenses/commons-codec-1.7.jar.sha1\nsolr-4.4.0/licenses/commons-collections-3.2.1.jar.sha1\nsolr-4.4.0/licenses/commons-compress-1.4.1.jar.sha1\nsolr-4.4.0/licenses/commons-configuration-1.6.jar.sha1\nsolr-4.4.0/licenses/commons-digester-2.0.jar.sha1\nsolr-4.4.0/licenses/commons-fileupload-1.2.1.jar.sha1\nsolr-4.4.0/licenses/commons-io-2.1.jar.sha1\nsolr-4.4.0/licenses/commons-lang-2.6.jar.sha1\nsolr-4.4.0/licenses/concurrentlinkedhashmap-lru-1.2.jar.sha1\nsolr-4.4.0/licenses/derby-10.9.1.0.jar.sha1\nsolr-4.4.0/licenses/dom4j-1.6.1.jar.sha1\nsolr-4.4.0/licenses/easymock-3.0.jar.sha1\nsolr-4.4.0/licenses/fontbox-1.8.1.jar.sha1\nsolr-4.4.0/licenses/guava-14.0.1.jar.sha1\nsolr-4.4.0/licenses/hadoop-annotations-2.0.5-alpha.jar.sha1\nsolr-4.4.0/licenses/hadoop-auth-2.0.5-alpha.jar.sha1\nsolr-4.4.0/licenses/hadoop-common-2.0.5-alpha.jar.sha1\nsolr-4.4.0/licenses/hadoop-common-2.0.5-alpha-tests.jar.sha1\nsolr-4.4.0/licenses/hadoop-hdfs-2.0.5-alpha.jar.sha1\nsolr-4.4.0/licenses/hadoop-hdfs-2.0.5-alpha-tests.jar.sha1\nsolr-4.4.0/licenses/hppc-0.4.1.jar.sha1\nsolr-4.4.0/licenses/hsqldb-1.8.0.10.jar.sha1\nsolr-4.4.0/licenses/httpclient-4.2.3.jar.sha1\nsolr-4.4.0/licenses/httpcore-4.2.2.jar.sha1\nsolr-4.4.0/licenses/httpmime-4.2.3.jar.sha1\nsolr-4.4.0/licenses/icu4j-49.1.jar.sha1\nsolr-4.4.0/licenses/isoparser-1.0-RC-1.jar.sha1\nsolr-4.4.0/licenses/jackson-core-asl-1.7.4.jar.sha1\nsolr-4.4.0/licenses/jackson-mapper-asl-1.7.4.jar.sha1\nsolr-4.4.0/licenses/javax.servlet-api-3.0.1.jar.sha1\nsolr-4.4.0/licenses/jcl-over-slf4j-1.6.6.jar.sha1\nsolr-4.4.0/licenses/jdom-1.0.jar.sha1\nsolr-4.4.0/licenses/jempbox-1.8.1.jar.sha1\nsolr-4.4.0/licenses/jersey-core-1.16.jar.sha1\nsolr-4.4.0/licenses/jetty-6.1.26.jar.sha1\nsolr-4.4.0/licenses/jetty-continuation-8.1.10.v20130312.jar.sha1\nsolr-4.4.0/licenses/jetty-deploy-8.1.10.v20130312.jar.sha1\nsolr-4.4.0/licenses/jetty-http-8.1.10.v20130312.jar.sha1\nsolr-4.4.0/licenses/jetty-io-8.1.10.v20130312.jar.sha1\nsolr-4.4.0/licenses/jetty-jmx-8.1.10.v20130312.jar.sha1\nsolr-4.4.0/licenses/jetty-security-8.1.10.v20130312.jar.sha1\nsolr-4.4.0/licenses/jetty-server-8.1.10.v20130312.jar.sha1\nsolr-4.4.0/licenses/jetty-servlet-8.1.10.v20130312.jar.sha1\nsolr-4.4.0/licenses/jetty-util-6.1.26.jar.sha1\nsolr-4.4.0/licenses/jetty-util-8.1.10.v20130312.jar.sha1\nsolr-4.4.0/licenses/jetty-webapp-8.1.10.v20130312.jar.sha1\nsolr-4.4.0/licenses/jetty-xml-8.1.10.v20130312.jar.sha1\nsolr-4.4.0/licenses/joda-time-2.2.jar.sha1\nsolr-4.4.0/licenses/jsonic-1.2.7.jar.sha1\nsolr-4.4.0/licenses/jul-to-slf4j-1.6.6.jar.sha1\nsolr-4.4.0/licenses/junit-4.10.jar.sha1\nsolr-4.4.0/licenses/junit4-ant-2.0.10.jar.sha1\nsolr-4.4.0/licenses/juniversalchardet-1.0.3.jar.sha1\nsolr-4.4.0/licenses/langdetect-1.1-20120112.jar.sha1\nsolr-4.4.0/licenses/log4j-1.2.16.jar.sha1\nsolr-4.4.0/licenses/mahout-collections-1.0.jar.sha1\nsolr-4.4.0/licenses/mahout-math-0.6.jar.sha1\nsolr-4.4.0/licenses/mail-1.4.1.jar.sha1\nsolr-4.4.0/licenses/metadata-extractor-2.6.2.jar.sha1\nsolr-4.4.0/licenses/morfologik-fsa-1.5.5.jar.sha1\nsolr-4.4.0/licenses/morfologik-polish-1.5.5.jar.sha1\nsolr-4.4.0/licenses/morfologik-stemming-1.5.5.jar.sha1\nsolr-4.4.0/licenses/netcdf-4.2-min.jar.sha1\nsolr-4.4.0/licenses/noggit-0.5.jar.sha1\nsolr-4.4.0/licenses/objenesis-1.2.jar.sha1\nsolr-4.4.0/licenses/OpenCalaisAnnotator-2.3.1.jar.sha1\nsolr-4.4.0/licenses/org.restlet.ext.servlet-2.1.1.jar.sha1\nsolr-4.4.0/licenses/org.restlet-2.1.1.jar.sha1\nsolr-4.4.0/licenses/pdfbox-1.8.1.jar.sha1\nsolr-4.4.0/licenses/poi-3.9.jar.sha1\nsolr-4.4.0/licenses/poi-ooxml-3.9.jar.sha1\nsolr-4.4.0/licenses/poi-ooxml-schemas-3.9.jar.sha1\nsolr-4.4.0/licenses/poi-scratchpad-3.9.jar.sha1\nsolr-4.4.0/licenses/protobuf-java-2.4.0a.jar.sha1\nsolr-4.4.0/licenses/randomizedtesting-runner-2.0.10.jar.sha1\nsolr-4.4.0/licenses/rome-0.9.jar.sha1\nsolr-4.4.0/licenses/servlet-api-3.0.jar.sha1\nsolr-4.4.0/licenses/simple-xml-2.6.4.jar.sha1\nsolr-4.4.0/licenses/slf4j-api-1.6.6.jar.sha1\nsolr-4.4.0/licenses/slf4j-log4j12-1.6.6.jar.sha1\nsolr-4.4.0/licenses/spatial4j-0.3.jar.sha1\nsolr-4.4.0/licenses/start.jar.sha1\nsolr-4.4.0/licenses/Tagger-2.3.1.jar.sha1\nsolr-4.4.0/licenses/tagsoup-1.2.1.jar.sha1\nsolr-4.4.0/licenses/tika-core-1.4.jar.sha1\nsolr-4.4.0/licenses/tika-parsers-1.4.jar.sha1\nsolr-4.4.0/licenses/uimaj-core-2.3.1.jar.sha1\nsolr-4.4.0/licenses/velocity-1.7.jar.sha1\nsolr-4.4.0/licenses/velocity-tools-2.0.jar.sha1\nsolr-4.4.0/licenses/vorbis-java-core-0.1.jar.sha1\nsolr-4.4.0/licenses/vorbis-java-tika-0.1.jar.sha1\nsolr-4.4.0/licenses/WhitespaceTokenizer-2.3.1.jar.sha1\nsolr-4.4.0/licenses/wstx-asl-3.2.7.jar.sha1\nsolr-4.4.0/licenses/xercesImpl-2.9.1.jar.sha1\nsolr-4.4.0/licenses/xmlbeans-2.3.0.jar.sha1\nsolr-4.4.0/licenses/xz-1.0.jar.sha1\nsolr-4.4.0/licenses/zookeeper-3.4.5.jar.sha1 "
        },
        {
            "author": "Steve Rowe",
            "id": "comment-13743862",
            "date": "2013-08-19T14:45:52+0000",
            "content": "Patch fixing Ivy and Maven configurations to treat hadoop-hdfs, hadoop-auth, and hadoop-annotations as test dependencies.\n\nThis causes the following solr-core compilation warnings, presumably because hadoop-common is in the compilation classpath but hadoop-annotations is not - Mark Miller, is this a problem?:\n\n\ncommon.compile-core:\n    [mkdir] Created dir: C:\\cygwin\\home\\s\\svn\\lucene\\dev\\trunk2\\solr\\build\\solr-core\\classes\\java\n    [javac] Compiling 615 source files to C:\\cygwin\\home\\s\\svn\\lucene\\dev\\trunk2\\solr\\build\\solr-core\\classes\\java\n    [javac] C:\\cygwin\\home\\s\\svn\\lucene\\dev\\trunk2\\solr\\core\\lib\\hadoop-common-2.0.5-alpha.jar(org/apache/hadoop/fs/FileSystem.class): warning: Cannot find annotation method 'value()' in type 'LimitedPrivate': class file for org.apache.hadoop.classification.InterfaceAudience not found\n    [javac] C:\\cygwin\\home\\s\\svn\\lucene\\dev\\trunk2\\solr\\core\\lib\\hadoop-common-2.0.5-alpha.jar(org/apache/hadoop/fs/FileSystem.class): warning: Cannot find annotation method 'value()' in type 'LimitedPrivate'\n    [javac] C:\\cygwin\\home\\s\\svn\\lucene\\dev\\trunk2\\solr\\core\\lib\\hadoop-common-2.0.5-alpha.jar(org/apache/hadoop/fs/FileSystem.class): warning: Cannot find annotation method 'value()' in type 'LimitedPrivate'\n    [javac] C:\\cygwin\\home\\s\\svn\\lucene\\dev\\trunk2\\solr\\core\\lib\\hadoop-common-2.0.5-alpha.jar(org/apache/hadoop/fs/Path.class): warning: Cannot find annotation method 'value()' in type 'LimitedPrivate'\n    [javac] C:\\cygwin\\home\\s\\svn\\lucene\\dev\\trunk2\\solr\\core\\lib\\hadoop-common-2.0.5-alpha.jar(org/apache/hadoop/security/UserGroupInformation.class): warning: Cannot find annotation method 'value()' in type 'LimitedPrivate'\n    [javac] C:\\cygwin\\home\\s\\svn\\lucene\\dev\\trunk2\\solr\\core\\lib\\hadoop-common-2.0.5-alpha.jar(org/apache/hadoop/metrics/MetricsUtil.class): warning: Cannot find annotation method 'value()' in type 'LimitedPrivate'\n    [javac] C:\\cygwin\\home\\s\\svn\\lucene\\dev\\trunk2\\solr\\core\\lib\\hadoop-common-2.0.5-alpha.jar(org/apache/hadoop/metrics/Updater.class): warning: Cannot find annotation method 'value()' in type 'LimitedPrivate'\n    [javac] C:\\cygwin\\home\\s\\svn\\lucene\\dev\\trunk2\\solr\\core\\lib\\hadoop-common-2.0.5-alpha.jar(org/apache/hadoop/fs/FSDataInputStream.class): warning: Cannot find annotation method 'value()' in type 'LimitedPrivate'\n    [javac] C:\\cygwin\\home\\s\\svn\\lucene\\dev\\trunk2\\solr\\core\\lib\\hadoop-common-2.0.5-alpha.jar(org/apache/hadoop/fs/FSDataOutputStream.class): warning: Cannot find annotation method 'value()' in type 'LimitedPrivate'\n    [javac] Note: Some input files use or override a deprecated API.\n    [javac] Note: Recompile with -Xlint:deprecation for details.\n    [javac] Note: Some input files use unchecked or unsafe operations.\n    [javac] Note: Recompile with -Xlint:unchecked for details.\n    [javac] 9 warnings "
        },
        {
            "author": "Steve Rowe",
            "id": "comment-13745054",
            "date": "2013-08-20T15:29:29+0000",
            "content": "From a #solr-dev IRC conversation today:\n\n\n10:15 <markrmiller> i think those 3 jars are the compile time dependencies\n10:16               it's the test jars that are not\n10:16               the hdfs common jar requires auth and annotations for whatever reason\n10:16               would be nice if they did something like we do with solrj for the client\n10:17               but they dont\n\n10:22 <sarowe>      compile succeeds with only hadoop-common, leaving out -auth,\n10:22               -annotations, and -hdfs -- there's just a compilation warning about annotations\n10:22               about solrj, I guess you mean a reduced-footprint set of dependencies?\n10:23               runtime deps I mean\n\n10:25 <markrmiller> perhaps its runtime then\n10:25               been many months since I added them\n10:26               but I seem to remember those 3 came in before any test work\n\n10:26 <sarowe>      ok, I'm confused - are you saying that the Ant setup as it is right now,\n10:26               without my patch, is as it should be?\n10:26               right now, the Ant/Ivy/dist setup for solr doesn't make a distinction\n10:27               between compile-time and run-time dependencies\n\n10:27 <markrmiller> not if it was shipping jetty 6\n10:27               I've got to look though\n10:27               the first draft that i committed\n10:27               it was setup right\n10:27               all the test stuff was in the test framework\n10:27               and core only had the min of what it needed\n\n10:27 <sarowe>      jetty 6 did not ship with 4.4\n\n10:27 <markrmiller> i thought that might be the case - its simply a dependency thing?\n\n10:28 <sarowe>      it's a *maven* dependency thing\n10:28               the direct deps for Ivy and Maven are the same\n\n10:28 <markrmiller> not much can be done about it - unless they make a sep client jar\n10:28               maven sucks in the world and thats what you get\n\n10:28 <sarowe>      but Maven also pulls in Jetty 6 as an indirect dep\n\n10:28 <markrmiller> yeah, thats a bummer\n10:28               but nothing we can do\n10:29               thats how maven and the hadoop guys have things\n\n10:29 <sarowe>      well, we can exclude jetty 6 as an indirect dep\n\n10:29 <markrmiller> there is prob a lot you can exclude\n\n10:29 <sarowe>      I did exclude a bunch of stuff\n10:30               but I didn't revisit the exclusions when I moved the test stuff\n10:30               from test-framework to solr-core unfortunately\n\n10:29 <markrmiller> i found the min jars i needed\n\n10:31 <sarowe>      so to confirm about the -hdfs, -auth, and -annotations jars:\n10:31               these are required at run-time, right?\n\n10:31 <markrmiller> as far as I know yes\n10:31               one sec, let me look at an older build\n\n10:32 <sarowe>      thanks - I'll change the patch to keep them as compile-time deps then,\n10:32               since as I said the Ant/Ivy setup doesn't make a distinction between\n10:32               compile-time and run-time deps\n10:32               assuming you find that the older build did that\n\n10:34 <markrmiller> what I added and need for compile/runtime was:\n10:35               common, hdfs, annotations, auth, commons-configuration, protobuf-java,\n10:35               perhaps concurrentlinkedhashmap unless it was already there\n10:35               <dependency org=\"org.apache.hadoop\" name=\"hadoop-common\" rev=\"${hadoop.version}\" transitive=\"false\"/>\n10:35               <dependency org=\"org.apache.hadoop\" name=\"hadoop-hdfs\" rev=\"${hadoop.version}\" transitive=\"false\"/>\n10:35               <dependency org=\"org.apache.hadoop\" name=\"hadoop-annotations\" rev=\"${hadoop.version}\" transitive=\"false\"/>\n10:35               <dependency org=\"org.apache.hadoop\" name=\"hadoop-auth\" rev=\"${hadoop.version}\" transitive=\"false\"/>\n10:35               <dependency org=\"commons-configuration\" name=\"commons-configuration\" rev=\"1.6\" transitive=\"false\"/>\n10:35               <dependency org=\"com.google.protobuf\" name=\"protobuf-java\" rev=\"2.4.0a\" transitive=\"false\"/>\n10:35               <dependency org=\"com.googlecode.concurrentlinkedhashmap\" name=\"concurrentlinkedhashmap-lru\" rev=\"1.2\" transitive=\"false\"/>\n\n "
        },
        {
            "author": "Steve Rowe",
            "id": "comment-13746733",
            "date": "2013-08-21T19:05:42+0000",
            "content": "This patch no longer removes hadoop-auth, hadoop-hdfs, and hdfs-annotations as Ivy and Maven dependencies.  Instead, the solr-core Maven dependencies are trimmed down to a minimum, and no longer include indirect jetty 6 dependencies.\n\nCommitting shortly. "
        },
        {
            "author": "ASF subversion and git services",
            "id": "comment-13746736",
            "date": "2013-08-21T19:12:44+0000",
            "content": "Commit 1516264 from Steve Rowe in branch 'dev/trunk'\n[ https://svn.apache.org/r1516264 ]\n\nSOLR-5173: Solr-core's Maven configuration includes test-only Hadoop dependencies as indirect compile-time dependencies "
        },
        {
            "author": "ASF subversion and git services",
            "id": "comment-13746768",
            "date": "2013-08-21T19:50:13+0000",
            "content": "Commit 1516273 from Steve Rowe in branch 'dev/branches/branch_4x'\n[ https://svn.apache.org/r1516273 ]\n\nSOLR-5173: Solr-core's Maven configuration includes test-only Hadoop dependencies as indirect compile-time dependencies (merged trunk r1516264) "
        },
        {
            "author": "Steve Rowe",
            "id": "comment-13746811",
            "date": "2013-08-21T20:33:47+0000",
            "content": "Committed to trunk and branch_4x.\n\nThanks Chris! "
        },
        {
            "author": "Adrien Grand",
            "id": "comment-13787002",
            "date": "2013-10-05T10:18:40+0000",
            "content": "4.5 release -> bulk close "
        }
    ]
}