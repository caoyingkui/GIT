{
    "id": "SOLR-9246",
    "title": "Errors for Streaming Expressions using JDBC (Oracle) stream source",
    "details": {
        "components": [],
        "type": "Bug",
        "labels": "",
        "fix_versions": [
            "6.0.2",
            "6.1.1",
            "6.2",
            "7.0"
        ],
        "affect_versions": "6.0.1",
        "status": "Closed",
        "resolution": "Fixed",
        "priority": "Major"
    },
    "description": "I have Solr 6.0.0 installed on my PC (windows 7), I was experimenting with \u2018Streaming Expression\u2019 by using Oracle jdbc as the \nstream source, but got 'null pointer' errors, below is the details on how to reproduce this error:\n\n1. create a collection 'document6' which only contain long and string data type, \n\nschema.xml for Solr collection 'document6': (newly created empty collections with 2 shards) \n===========================================================================================\n<schema name=\"document6\" version=\"1.1\">\n  <types>\n     <fieldType name=\"uuid\" class=\"solr.UUIDField\" />\n     <fieldType name=\"bigint\" class=\"solr.TrieLongField\" />\n     <fieldType name=\"string\" class=\"solr.StrField\" sortMissingLast=\"true\" docValues=\"true\" />\n     <fieldType name=\"long\" class=\"solr.TrieLongField\" docValues=\"true\" precisionStep=\"0\" positionIncrementGap=\"0\"/>\n     <fieldType name=\"text\" class=\"solr.TextField\">\n        <analyzer>\n           <tokenizer class=\"solr.StandardTokenizerFactory\"/>\n        </analyzer>\n      </fieldType>\n      <fieldType name=\"boolean\" class=\"solr.BoolField\" sortMissingLast=\"true\" omitNorms=\"true\"/>\n   </types>\n   <fields>\n     <field name=\"version\" type=\"long\" indexed=\"true\" stored=\"true\" multiValued=\"false\"/>\n     <field name=\"document_id\" type=\"long\" indexed=\"true\" stored=\"true\" docValues=\"true\"/>\n     <field name=\"sender_msg_dest\" type=\"string\" indexed=\"true\" stored=\"true\" docValues=\"true\"/>\n     <field name=\"recip_msg_dest\" type=\"string\" indexed=\"true\" stored=\"true\" docValues=\"true\"/>\n     <field name=\"document_type\" type=\"string\" indexed=\"true\" stored=\"true\" docValues=\"true\"/>\n     <field name=\"document_key\" type=\"string\" indexed=\"true\" stored=\"true\" docValues=\"true\"/>\n   </fields>\n  <defaultSearchField>document_id</defaultSearchField>\n  <uniqueKey>document_id</uniqueKey>\n</schema>\n\n2. create a new Oracle (version 11.2.0.3) table 'document6' that only contain columns whose jdbc type is long and string, \n\ncreate table document6 \n(document_id     number(12) not null,\n sender_msg_dest varchar2(256),\n recip_msg_dest  varchar2(256),\n document_type   varchar2(20),\n document_key    varchar2(100));\n\nloaded 9 records;\n\nOracle table 'document6': (newly created Oracle table with 9 records) \n=====================================================================\nQA_DOCREP@qlgdb1 > desc document6\n Name                                      Null?    Type\n ----------------------------------------- -------- ----------------------------\n DOCUMENT_ID                               NOT NULL NUMBER(12)\n SENDER_MSG_DEST                                    VARCHAR2(256)\n RECIP_MSG_DEST                                     VARCHAR2(256)\n DOCUMENT_TYPE                                      VARCHAR2(20)\n DOCUMENT_KEY                                       VARCHAR2(100)\n\n3. tried this jdbc streaming expression in my browser, getting the error stack (see below)\n\nhttp://localhost:8988/solr/document6/stream?expr=jdbc(connection=\"jdbc:oracle:thin:qa_docrep/abc123@lit-racq01-scan.qa.gxsonline.net:1521/qlgdb\",sql=\"SELECT document_id,sender_msg_dest,recip_msg_dest,document_type,document_key FROM document6\",sort=\"document_id asc\",driver=\"oracle.jdbc.driver.OracleDriver\")\n\nerrors in solr.log\n==================\n2016-06-23 14:07:02.833 INFO  (qtp1389647288-139) [c:document6 s:shard2 r:core_node1 x:document6_shard2_replica1] o.a.s.c.S.Request [document6_shard2_replica1]  webapp=/solr path=/stream params=\n{expr=jdbc(connection%3D\"jdbc:oracle:thin:qa_docrep/abc123@lit-racq01-scan.qa.gxsonline.net:1521/qlgdb\",sql%3D\"SELECT+document_id,sender_msg_dest,recip_msg_dest,document_type,document_key+FROM+document6\",sort%3D\"document_id+asc\",driver%3D\"oracle.jdbc.driver.OracleDriver\")}\n status=0 QTime=1\n2016-06-23 14:07:05.282 ERROR (qtp1389647288-139) [c:document6 s:shard2 r:core_node1 x:document6_shard2_replica1] o.a.s.c.s.i.s.ExceptionStream java.lang.NullPointerException\n\tat org.apache.solr.client.solrj.io.stream.JDBCStream.read(JDBCStream.java:305)\n\tat org.apache.solr.client.solrj.io.stream.ExceptionStream.read(ExceptionStream.java:64)\n\tat org.apache.solr.handler.StreamHandler$TimerStream.read(StreamHandler.java:374)\n\tat org.apache.solr.response.TextResponseWriter.writeTupleStream(TextResponseWriter.java:305)\n\tat org.apache.solr.response.TextResponseWriter.writeVal(TextResponseWriter.java:167)\n\tat org.apache.solr.response.JSONWriter.writeNamedListAsMapWithDups(JSONResponseWriter.java:183)\n\tat org.apache.solr.response.JSONWriter.writeNamedList(JSONResponseWriter.java:299)\n\tat org.apache.solr.response.JSONWriter.writeResponse(JSONResponseWriter.java:95)\n\tat org.apache.solr.response.JSONResponseWriter.write(JSONResponseWriter.java:60)\n\tat org.apache.solr.response.QueryResponseWriterUtil.writeQueryResponse(QueryResponseWriterUtil.java:65)\n\tat org.apache.solr.servlet.HttpSolrCall.writeResponse(HttpSolrCall.java:725)\n\tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:469)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:229)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:184)\n\tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1668)\n\tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:581)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\n\tat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\n\tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:226)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1160)\n\tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:511)\n\tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1092)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n\tat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)\n\tat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:119)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)\n\tat org.eclipse.jetty.server.Server.handle(Server.java:518)\n\tat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:308)\n\tat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:244)\n\tat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:273)\n\tat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:95)\n\tat org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)\n\tat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceAndRun(ExecuteProduceConsume.java:246)\n\tat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:156)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:654)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:572)\n\tat java.lang.Thread.run(Thread.java:745)\n\n2016-06-23 14:07:05.285 ERROR (qtp1389647288-139) [c:document6 s:shard2 r:core_node1 x:document6_shard2_replica1] o.a.s.s.HttpSolrCall null:java.lang.RuntimeException: java.lang.AbstractMethodError: Method oracle/jdbc/driver/T4CStatement.isClosed()Z is abstract\n\tat org.apache.solr.servlet.HttpSolrCall.sendError(HttpSolrCall.java:605)\n\tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:475)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:229)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:184)\n\tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1668)\n\tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:581)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\n\tat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\n\tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:226)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1160)\n\tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:511)\n\tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1092)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n\tat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)\n\tat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:119)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)\n\tat org.eclipse.jetty.server.Server.handle(Server.java:518)\n\tat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:308)\n\tat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:244)\n\tat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:273)\n\tat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:95)\n\tat org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)\n\tat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceAndRun(ExecuteProduceConsume.java:246)\n\tat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:156)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:654)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:572)\n\tat java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.AbstractMethodError: Method oracle/jdbc/driver/T4CStatement.isClosed()Z is abstract\n\tat oracle.jdbc.driver.T4CStatement.isClosed(T4CStatement.java)\n\tat org.apache.solr.client.solrj.io.stream.JDBCStream.close(JDBCStream.java:287)\n\tat org.apache.solr.client.solrj.io.stream.ExceptionStream.close(ExceptionStream.java:79)\n\tat org.apache.solr.handler.StreamHandler$TimerStream.close(StreamHandler.java:357)\n\tat org.apache.solr.response.TextResponseWriter.writeTupleStream(TextResponseWriter.java:317)\n\tat org.apache.solr.response.TextResponseWriter.writeVal(TextResponseWriter.java:167)\n\tat org.apache.solr.response.JSONWriter.writeNamedListAsMapWithDups(JSONResponseWriter.java:183)\n\tat org.apache.solr.response.JSONWriter.writeNamedList(JSONResponseWriter.java:299)\n\tat org.apache.solr.response.JSONWriter.writeResponse(JSONResponseWriter.java:95)\n\tat org.apache.solr.response.JSONResponseWriter.write(JSONResponseWriter.java:60)\n\tat org.apache.solr.response.QueryResponseWriterUtil.writeQueryResponse(QueryResponseWriterUtil.java:65)\n\tat org.apache.solr.servlet.HttpSolrCall.writeResponse(HttpSolrCall.java:725)\n\tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:469)\n\t... 26 more\n\nHere is the feedback from Joel Bernstein:\n=======================================\nI think we're going to have to add some debugging into the code to find what's going on. On line 225 in JDBCStream it's getting the class name for each column. It would be good know what the class names are that the Oracles driver is returning.\n\nhttps://github.com/apache/lucene-solr/blob/releases/lucene-solr/6.0.0/solr/solrj/src/java/org/apache/solr/client/solrj/io/stream/JDBCStream.java\n\nWe probably need to throw an exception that includes the class name to help users report what different drivers using for the classes.",
    "attachments": {
        "Re Errors for Streaming Expressions using JDBC (Oracle) stream source.txt": "https://issues.apache.org/jira/secure/attachment/12812868/Re%20Errors%20for%20Streaming%20Expressions%20using%20JDBC%20%28Oracle%29%20stream%20source.txt",
        "SOLR-9246.patch": "https://issues.apache.org/jira/secure/attachment/12812908/SOLR-9246.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2016-06-23T16:20:26+0000",
            "author": "Hui Liu",
            "content": "Attach the original email threads. ",
            "id": "comment-15346693"
        },
        {
            "date": "2016-06-23T18:54:58+0000",
            "author": "Dennis Gove",
            "content": "I'm gonna go ahead and post a patch with the exception. ",
            "id": "comment-15346979"
        },
        {
            "date": "2016-06-23T19:37:58+0000",
            "author": "Dennis Gove",
            "content": "On an unknown java class name an exception will now be thrown with the message \n\nUnable to determine the valueSelector for column '<name>' (col #<number>) of java class '<java class name>' and type '<SQL type name>'\n\n\n\nFor example\n\nUnable to determine the valueSelector for column 'UNSP' (col #2) of java class '[B' and type 'BINARY'\n\n\n\nThe weird looking java class name is because there doesn't appear to be a known java class for a BINARY type.\n\nDue to error handling within the JDBCStream, this exception will be caught and wrapped as the cause of an IOException. The full exception trace will look like this\n\njava.io.IOException: Failed to generate value selectors for sqlQuery 'select ID,UNSP from UNSUPPORTED_COLUMNS' against JDBC connection 'jdbc:hsqldb:mem:.'\n  at   <stacktrace>\nCaused by: java.sql.SQLException: Unable to determine the valueSelector for column 'UNSP' (col #2) of java class '[B' and type 'BINARY'\n  at <stacktrace>\n\n ",
            "id": "comment-15347040"
        },
        {
            "date": "2016-06-29T18:44:45+0000",
            "author": "ASF subversion and git services",
            "content": "Commit d1a9daec8787a3f6869bdcff282dee8b3936cf24 in lucene-solr's branch refs/heads/branch_6x from Dennis Gove\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d1a9dae ]\n\nSOLR-9246: If the JDBCStream sees an unknown column type it will now throw a detailed exception ",
            "id": "comment-15355604"
        },
        {
            "date": "2016-06-29T18:48:35+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 86a19829dbd18d7fe38c0d89d7e23c25419bc935 in lucene-solr's branch refs/heads/branch_6_1 from Dennis Gove\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=86a1982 ]\n\nSOLR-9246: If the JDBCStream sees an unknown column type it will now throw a detailed exception ",
            "id": "comment-15355614"
        },
        {
            "date": "2016-06-29T19:18:06+0000",
            "author": "ASF subversion and git services",
            "content": "Commit a1756f6deb379f99ada6222ddca3dd4a15dad7d3 in lucene-solr's branch refs/heads/branch_6_0 from Dennis Gove\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a1756f6 ]\n\nSOLR-9246: If the JDBCStream sees an unknown column type it will now throw a detailed exception ",
            "id": "comment-15355690"
        },
        {
            "date": "2016-06-29T19:19:17+0000",
            "author": "Dennis Gove",
            "content": "This was also committed to the master branch. I don't know why an auto note isn't being added here. https://github.com/apache/lucene-solr/commit/1ae0d8d6e1394a941b65c940cb449662d7cab5d2 ",
            "id": "comment-15355694"
        },
        {
            "date": "2016-10-31T13:46:36+0000",
            "author": "Aaron Danielson",
            "content": "The 'Caused by: ...' portion of the error message was never printed for me.  My column was using type DECIMAL, but JDBC only understands FLOAT or DOUBLE, so this took some serious time to figure out the issue without a more explicit error message.  For what it's worth, it would be really nice if the driver could automatically map column types of DECIMAL to FLOAT. ",
            "id": "comment-15622191"
        }
    ]
}