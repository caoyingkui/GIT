{
    "id": "SOLR-6995",
    "title": "On a new cluster setup, new nodes never move out of the 'down' state.",
    "details": {
        "components": [
            "SolrCloud"
        ],
        "type": "Bug",
        "labels": "",
        "fix_versions": [],
        "affect_versions": "4.10.3",
        "status": "Closed",
        "resolution": "Duplicate",
        "priority": "Major"
    },
    "description": "This is related to a question I posted on stackoverflow a day ago.\n\nWhen deploying a new cluster, new nodes never proceed to an 'active' state. I have used both a custom (yet simple) deployment, as well as using the example framework you get when downloading the Solr distribution. Further inspection of the logs, and comparing them to the output of a 4.10.1 start up, it looks like the nodes never move on to leader election.\n\nFor an apples-to-apples comparison I moved the solr/collection1 directory to solr/ttPoiMDS, and modified the core.properties appropriately. I also removed the 'conf' directory, assuming that it would pick this up from our ZooKeeper cluster.\n\nHere is the start up:\n\njava\n    -Dcollection.configName=ttPoiMDS\n    -Djava.util.logging.config.file=etc/logging.properties\n    -DzkHost=our_zk_host_1:<zk_port>\n    -Djetty.port=8983\n    -jar start.jar\n\n\n\nHere is the output in the logs:\n\n\n0    [main] INFO  org.eclipse.jetty.server.Server  \u2013 jetty-8.1.10.v20130312\n32   [main] INFO  org.eclipse.jetty.deploy.providers.ScanningAppProvider  \u2013 Deployment monitor /site/pkgs/solr/solr-4.10.3/example/contexts at interval 0\n38   [main] INFO  org.eclipse.jetty.deploy.DeploymentManager  \u2013 Deployable added: /site/pkgs/solr/solr-4.10.3/example/contexts/solr-jetty-context.xml\n114  [main] INFO  org.eclipse.jetty.webapp.WebInfConfiguration  \u2013 Extract jar:file:/site/pkgs/solr/solr-4.10.3/example/webapps/solr.war!/ to /site/pkgs/solr/solr-4.10.3/example/solr-webapp/webapp\n1527 [main] INFO  org.eclipse.jetty.webapp.StandardDescriptorProcessor  \u2013 NO JSP Support for /solr, did not find org.apache.jasper.servlet.JspServlet\n1597 [main] INFO  org.apache.solr.servlet.SolrDispatchFilter  \u2013 SolrDispatchFilter.init()\n1616 [main] INFO  org.apache.solr.core.SolrResourceLoader  \u2013 JNDI not configured for solr (NoInitialContextEx)\n1616 [main] INFO  org.apache.solr.core.SolrResourceLoader  \u2013 solr home defaulted to 'solr/' (could not find system property or JNDI)\n1617 [main] INFO  org.apache.solr.core.SolrResourceLoader  \u2013 new SolrResourceLoader for directory: 'solr/'\n1748 [main] INFO  org.apache.solr.core.ConfigSolr  \u2013 Loading container configuration from /site/pkgs/solr/solr-4.10.3/example/solr/solr.xml\n1884 [main] INFO  org.apache.solr.core.CoresLocator  \u2013 Config-defined core root directory: /site/pkgs/solr/solr-4.10.3/example/solr\n1890 [main] INFO  org.apache.solr.core.CoreContainer  \u2013 New CoreContainer 378496804\n1890 [main] INFO  org.apache.solr.core.CoreContainer  \u2013 Loading cores into CoreContainer [instanceDir=solr/]\n1905 [main] INFO  org.apache.solr.handler.component.HttpShardHandlerFactory  \u2013 Setting socketTimeout to: 0\n1905 [main] INFO  org.apache.solr.handler.component.HttpShardHandlerFactory  \u2013 Setting urlScheme to: null\n1909 [main] INFO  org.apache.solr.handler.component.HttpShardHandlerFactory  \u2013 Setting connTimeout to: 0\n1911 [main] INFO  org.apache.solr.handler.component.HttpShardHandlerFactory  \u2013 Setting maxConnectionsPerHost to: 20\n1912 [main] INFO  org.apache.solr.handler.component.HttpShardHandlerFactory  \u2013 Setting corePoolSize to: 0\n1912 [main] INFO  org.apache.solr.handler.component.HttpShardHandlerFactory  \u2013 Setting maximumPoolSize to: 2147483647\n1912 [main] INFO  org.apache.solr.handler.component.HttpShardHandlerFactory  \u2013 Setting maxThreadIdleTime to: 5\n1912 [main] INFO  org.apache.solr.handler.component.HttpShardHandlerFactory  \u2013 Setting sizeOfQueue to: -1\n1912 [main] INFO  org.apache.solr.handler.component.HttpShardHandlerFactory  \u2013 Setting fairnessPolicy to: false\n2054 [main] INFO  org.apache.solr.update.UpdateShardHandler  \u2013 Creating UpdateShardHandler HTTP client with params: socketTimeout=0&connTimeout=0&retry=false\n2056 [main] INFO  org.apache.solr.logging.LogWatcher  \u2013 SLF4J impl is org.slf4j.impl.Log4jLoggerFactory\n2057 [main] INFO  org.apache.solr.logging.LogWatcher  \u2013 Registering Log Listener [Log4j (org.slf4j.impl.Log4jLoggerFactory)]\n2058 [main] INFO  org.apache.solr.core.CoreContainer  \u2013 Host Name: \n2059 [main] INFO  org.apache.solr.core.ZkContainer  \u2013 Zookeeper client=our_zk_host_1:2195\n2140 [main] INFO  org.apache.solr.common.cloud.ConnectionManager  \u2013 Waiting for client to connect to ZooKeeper\n2220 [main-EventThread] INFO  org.apache.solr.common.cloud.ConnectionManager  \u2013 Watcher org.apache.solr.common.cloud.ConnectionManager@36dadde6 name:ZooKeeperConnection Watcher:our_zk_host_1:2195 got event WatchedEvent state:SyncConnected type:None path:null path:null type:None\n2220 [main] INFO  org.apache.solr.common.cloud.ConnectionManager  \u2013 Client is connected to ZooKeeper\n2293 [main] INFO  org.apache.solr.common.cloud.SolrZkClient  \u2013 makePath: /overseer/queue\n2447 [main] INFO  org.apache.solr.common.cloud.SolrZkClient  \u2013 makePath: /overseer/collection-queue-work\n2609 [main] INFO  org.apache.solr.common.cloud.SolrZkClient  \u2013 makePath: /overseer/collection-map-running\n2758 [main] INFO  org.apache.solr.common.cloud.SolrZkClient  \u2013 makePath: /overseer/collection-map-completed\n2919 [main] INFO  org.apache.solr.common.cloud.SolrZkClient  \u2013 makePath: /overseer/collection-map-failure\n3093 [main] INFO  org.apache.solr.common.cloud.SolrZkClient  \u2013 makePath: /live_nodes\n3173 [main] INFO  org.apache.solr.cloud.ZkController  \u2013 Register node as live in ZooKeeper:/live_nodes/our_solr_host:8983_solr\n3201 [main] INFO  org.apache.solr.common.cloud.SolrZkClient  \u2013 makePath: /live_nodes/our_solr_host:8983_solr\n3371 [main] INFO  org.apache.solr.common.cloud.SolrZkClient  \u2013 makePath: /overseer_elect\n3477 [main] INFO  org.apache.solr.common.cloud.SolrZkClient  \u2013 makePath: /overseer_elect/election\n3577 [main] INFO  org.apache.solr.cloud.Overseer  \u2013 Overseer (id=null) closing\n3659 [main] INFO  org.apache.solr.cloud.ElectionContext  \u2013 I am going to be the leader our_solr_host:8983_solr\n3662 [main] INFO  org.apache.solr.common.cloud.SolrZkClient  \u2013 makePath: /overseer_elect/leader\n3763 [main] INFO  org.apache.solr.cloud.Overseer  \u2013 Overseer (id=93155855038349319-our_solr_host:8983_solr-n_0000000000) starting\n3887 [main] INFO  org.apache.solr.common.cloud.SolrZkClient  \u2013 makePath: /overseer/queue-work\n4409 [main] INFO  org.apache.solr.cloud.OverseerAutoReplicaFailoverThread  \u2013 Starting OverseerAutoReplicaFailoverThread autoReplicaFailoverWorkLoopDelay=10000 autoReplicaFailoverWaitAfterExpiration=30000 autoReplicaFailoverBadNodeExpiration=60000\n4438 [OverseerCollectionProcessor-93155855038349319-our_solr_host:8983_solr-n_0000000000] INFO  org.apache.solr.cloud.OverseerCollectionProcessor  \u2013 Process current queue of collection creations\n4456 [main] INFO  org.apache.solr.common.cloud.SolrZkClient  \u2013 makePath: /clusterstate.json\n4559 [main] INFO  org.apache.solr.common.cloud.ZkStateReader  \u2013 Updating cluster state from ZooKeeper... \n4731 [OverseerStateUpdate-93155855038349319-our_solr_host:8983_solr-n_0000000000] INFO  org.apache.solr.cloud.Overseer  \u2013 Starting to work on the main queue\n4736 [main] INFO  org.apache.solr.core.CoresLocator  \u2013 Looking for core definitions underneath /site/pkgs/solr/solr-4.10.3/example/solr\n4744 [main] INFO  org.apache.solr.core.CoresLocator  \u2013 Found core ttPoiMDS in /site/pkgs/solr/solr-4.10.3/example/solr/ttPoiMDS/\n4744 [main] INFO  org.apache.solr.core.CoresLocator  \u2013 Found 1 core definitions\n4767 [coreLoadExecutor-6-thread-1] INFO  org.apache.solr.cloud.ZkController  \u2013 publishing core=ttPoiMDS state=down collection=ttPoiMDS\n4767 [coreLoadExecutor-6-thread-1] INFO  org.apache.solr.cloud.ZkController  \u2013 numShards not found on descriptor - reading it from system property\n4796 [coreLoadExecutor-6-thread-1] INFO  org.apache.solr.cloud.ZkController  \u2013 look for our core node name\n4797 [zkCallback-2-thread-1] INFO  org.apache.solr.cloud.DistributedQueue  \u2013 LatchChildWatcher fired on path: /overseer/queue state: SyncConnected type NodeChildrenChanged\n4897 [OverseerStateUpdate-93155855038349319-our_solr_host:8983_solr-n_0000000000] INFO  org.apache.solr.cloud.Overseer  \u2013 Update state numShards=null message={\n  \"operation\":\"state\",\n  \"shard\":null,\n  \"roles\":null,\n  \"state\":\"down\",\n  \"core\":\"ttPoiMDS\",\n  \"collection\":\"ttPoiMDS\",\n  \"node_name\":\"our_solr_host:8983_solr\",\n  \"base_url\":\"http://our_solr_host:8983/solr\"}\n4899 [OverseerStateUpdate-93155855038349319-our_solr_host:8983_solr-n_0000000000] INFO  org.apache.solr.cloud.Overseer  \u2013 Assigning new node to shard shard=shard1\n5052 [zkCallback-2-thread-1] INFO  org.apache.solr.common.cloud.ZkStateReader  \u2013 A cluster state change: WatchedEvent state:SyncConnected type:NodeDataChanged path:/clusterstate.json, has occurred - updating... (live nodes size: 1)\n5800 [coreLoadExecutor-6-thread-1] INFO  org.apache.solr.cloud.ZkController  \u2013 waiting to find shard id in clusterstate for ttPoiMDS\n5801 [coreLoadExecutor-6-thread-1] INFO  org.apache.solr.cloud.ZkController  \u2013 Check for collection zkNode:ttPoiMDS\n5924 [coreLoadExecutor-6-thread-1] INFO  org.apache.solr.cloud.ZkController  \u2013 Collection zkNode exists\n5925 [coreLoadExecutor-6-thread-1] INFO  org.apache.solr.common.cloud.ZkStateReader  \u2013 Load collection config from:/collections/ttPoiMDS\n5970 [coreLoadExecutor-6-thread-1] INFO  org.apache.solr.common.cloud.ZkStateReader  \u2013 path=/collections/ttPoiMDS configName=ttPoiMDS specified config exists in ZooKeeper\n5970 [coreLoadExecutor-6-thread-1] INFO  org.apache.solr.core.SolrResourceLoader  \u2013 new SolrResourceLoader for directory: '/site/pkgs/solr/solr-4.10.3/example/solr/ttPoiMDS/'\n6054 [coreLoadExecutor-6-thread-1] INFO  org.apache.solr.core.SolrConfig  \u2013 Adding specified lib dirs to ClassLoader\n6055 [coreLoadExecutor-6-thread-1] WARN  org.apache.solr.core.SolrResourceLoader  \u2013 Can't find (or read) directory to add to classloader: ../../lib/mq (resolved as: /site/pkgs/solr/solr-4.10.3/example/solr/ttPoiMDS/../../lib/mq).\n6139 [coreLoadExecutor-6-thread-1] INFO  org.apache.solr.core.SolrConfig  \u2013 Using Lucene MatchVersion: 4.10.3\n6238 [coreLoadExecutor-6-thread-1] INFO  org.apache.solr.core.Config  \u2013 Loaded SolrConfig: solrconfig.xml\n6320 [coreLoadExecutor-6-thread-1] INFO  org.apache.solr.schema.IndexSchema  \u2013 Reading Solr Schema from /configs/ttPoiMDS/schema.xml\n6347 [coreLoadExecutor-6-thread-1] INFO  org.apache.solr.schema.IndexSchema  \u2013 [ttPoiMDS] Schema name=poiMDS\n6582 [main] INFO  org.apache.solr.servlet.SolrDispatchFilter  \u2013 user.dir=/site/pkgs/solr/solr-4.10.3/example\n6582 [main] INFO  org.apache.solr.servlet.SolrDispatchFilter  \u2013 SolrDispatchFilter.init() done\n6614 [main] INFO  org.eclipse.jetty.server.AbstractConnector  \u2013 Started SocketConnector@0.0.0.0:8983\n\n\n\nStartup then seems to hang. The Solr UI is available, but it shows that no cores are available. In the cloud view the configuration from ZooKeeper is present.",
    "attachments": {},
    "issue_links": {},
    "comments": []
}