{
    "id": "SOLR-2052",
    "title": "Allow for a list of filter queries and a single docset filter in QueryComponent",
    "details": {
        "affect_versions": "4.0-ALPHA",
        "status": "Open",
        "fix_versions": [
            "4.9",
            "6.0"
        ],
        "components": [
            "search"
        ],
        "type": "Improvement",
        "priority": "Minor",
        "labels": "",
        "resolution": "Unresolved"
    },
    "description": "SolrIndexSearcher.QueryCommand allows you to specify a list of filter queries or a single filter (as a DocSet), but not both.  This restriction seems arbitrary, and there are cases where we can have both a list of filter queries and a DocSet generated by some other non-query process (e.g., filtering documents according to IDs pulled from some other source like a database.)\n\nFixing this requires a few small changes to SolrIndexSearcher to allow both of these to be set for a QueryCommand and to take both into account when evaluating the query.  It also requires a modification to ResponseBuilder to allow setting the single filter at query time.\n\nI've run into this against 1.4, but the same holds true for the trunk.",
    "attachments": {
        "SOLR-2052-4_0_0.patch": "https://issues.apache.org/jira/secure/attachment/12550582/SOLR-2052-4_0_0.patch",
        "SOLR-2052-3.patch": "https://issues.apache.org/jira/secure/attachment/12466676/SOLR-2052-3.patch",
        "SOLR-2052-trunk.patch": "https://issues.apache.org/jira/secure/attachment/12550581/SOLR-2052-trunk.patch",
        "SOLR-2052-3-6-1.patch": "https://issues.apache.org/jira/secure/attachment/12550202/SOLR-2052-3-6-1.patch",
        "SOLR-2052-2.patch": "https://issues.apache.org/jira/secure/attachment/12454043/SOLR-2052-2.patch",
        "SOLR-2052-4.patch": "https://issues.apache.org/jira/secure/attachment/12475231/SOLR-2052-4.patch",
        "SOLR-2052.patch": "https://issues.apache.org/jira/secure/attachment/12452203/SOLR-2052.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "author": "Stephen Green",
            "id": "comment-12899040",
            "date": "2010-08-16T19:10:36+0000",
            "content": "Patch for SolrIndexSearcher and ResponseBuilder.  Passes ant clean test with no errors. "
        },
        {
            "author": "Stephen Green",
            "id": "comment-12906977",
            "date": "2010-09-07T21:23:13+0000",
            "content": "Updated patch that fixes a bug when combining filter docsets and filter queries. "
        },
        {
            "author": "Otis Gospodnetic",
            "id": "comment-12928791",
            "date": "2010-11-05T19:47:32+0000",
            "content": "Looks straight forward, but doesn't apply any more.\n\n$ patch  -p0 -i SOLR-2052-2.patch --dry-run\npatching file src/java/org/apache/solr/search/SolrIndexSearcher.java\nHunk #1 succeeded at 1119 (offset 219 lines).\nHunk #2 succeeded at 1243 (offset 219 lines).\nHunk #3 succeeded at 1835 (offset 235 lines).\nHunk #4 succeeded at 1843 (offset 235 lines).\nHunk #5 succeeded at 1856 (offset 235 lines).\npatching file src/java/org/apache/solr/handler/component/ResponseBuilder.java\nHunk #2 succeeded at 58 (offset 2 lines).\nHunk #3 succeeded at 223 (offset 41 lines).\nHunk #4 FAILED at 282.\n1 out of 4 hunks FAILED \u2013 saving rejects to file src/java/org/apache/solr/handler/component/ResponseBuilder.java.rej "
        },
        {
            "author": "Stephen Green",
            "id": "comment-12930165",
            "date": "2010-11-09T15:30:09+0000",
            "content": "Thanks for taking a look, Otis.  I'm in CA this week, but I should have a chance to fix the patch when I'm back home. "
        },
        {
            "author": "Jonathan Rochkind",
            "id": "comment-12971715",
            "date": "2010-12-15T16:09:18+0000",
            "content": "Very interested in this functionality \u2013 but only if it could be combined with traditional fq's too. Would this patch allow a bit-filter as one filter, with additional ordinary fq's being additional filters on top, as well as an ordinary 'query' etc?  If so, definitely very interested.  "
        },
        {
            "author": "Stephen Green",
            "id": "comment-12971719",
            "date": "2010-12-15T16:14:26+0000",
            "content": "Yes, that was exactly the intended functionality: allow for a bitset, filter queries and a regular query.  It's been a month and a half now, but I will fix this this weekend so that the patch will apply against trunk. "
        },
        {
            "author": "Stephen Green",
            "id": "comment-12973458",
            "date": "2010-12-21T03:05:57+0000",
            "content": "A patch that works against trunk. "
        },
        {
            "author": "tylerw",
            "id": "comment-13014704",
            "date": "2011-04-01T15:50:08+0000",
            "content": "Updated patch that applies cleanly against trunk and works with groups/field collapsing features. "
        },
        {
            "author": "Robert Muir",
            "id": "comment-13043679",
            "date": "2011-06-03T16:46:29+0000",
            "content": "Bulk move 3.2 -> 3.3 "
        },
        {
            "author": "Robert Muir",
            "id": "comment-13106451",
            "date": "2011-09-16T14:51:09+0000",
            "content": "3.4 -> 3.5 "
        },
        {
            "author": "Hoss Man",
            "id": "comment-13234697",
            "date": "2012-03-21T18:08:55+0000",
            "content": "Bulk of fixVersion=3.6 -> fixVersion=4.0 for issues that have no assignee and have not been updated recently.\n\nemail notification suppressed to prevent mass-spam\npsuedo-unique token identifying these issues: hoss20120321nofix36 "
        },
        {
            "author": "Aaron Daubman",
            "id": "comment-13481044",
            "date": "2012-10-21T19:54:47+0000",
            "content": "Attaching the patch updated for 3.6.1 "
        },
        {
            "author": "Aaron Daubman",
            "id": "comment-13482913",
            "date": "2012-10-24T02:09:02+0000",
            "content": "Attaching patches against 4_0_0 and trunk "
        },
        {
            "author": "Aaron Daubman",
            "id": "comment-13504738",
            "date": "2012-11-27T16:36:01+0000",
            "content": "I am successfully using patch SOLR-2052-4_0_0 against https://github.com/apache/lucene-solr/tree/lucene_solr_4_0\n\nant clean test\nreports:\nBUILD SUCCESSFUL\nTotal time: 10 minutes 30 seconds\n\nWhat else can I do to help ensure this patch makes it into 4.1 (or the next bump to lucene_solr_4_0)? "
        },
        {
            "author": "Hoss Man",
            "id": "comment-13505132",
            "date": "2012-11-28T01:11:35+0000",
            "content": "Aaron: I don't really know/understand why the restriction is currently in place, but the fact that existing tests pass when you remove it doesn't in and of itself fill me with tons of confidence that it's definitely safe.\n\nIf you could add some tests to the patch demonstrating a codepath where both the Query filter and the DocSet filter get used, then i would be convinced (even just having a low level test that directly instantiated a SolrIndexSearcher.QueryCommand using both and executed demonstrating correct behavior would be re-assuring) "
        },
        {
            "author": "Yonik Seeley",
            "id": "comment-13505201",
            "date": "2012-11-28T03:18:32+0000",
            "content": "the fact that existing tests pass when you remove it doesn't in and of itself fill me with tons of confidence that it's definitely safe.\n\n+1\n\nI think some of the history is that stock Solr never used both at the same time, and because of that maybe not every place in the code worked with both, and because of that someone added the check/restriction.  I have no idea if all code paths would worth using both, but it's not something the current tests test for (since it's prohibited).  Changes to that should be backed up by new tests, and coverage analysis and/or a thorough code review. "
        },
        {
            "author": "Steve Rowe",
            "id": "comment-13717384",
            "date": "2013-07-23T18:48:04+0000",
            "content": "Bulk move 4.4 issues to 4.5 and 5.0 "
        },
        {
            "author": "Aaron Daubman",
            "id": "comment-13941385",
            "date": "2014-03-20T04:46:04+0000",
            "content": "Yonik Seeley, Hoss Man\nIs this test coverage sufficient?\nhttps://github.com/daubman/lucene-solr/blob/solr2052/solr/core/src/test/org/apache/solr/handler/component/QueryComponentTest.java\n\nYou can see the full set of changes here (pretty much the same as the attached patches have always been):\nhttps://github.com/daubman/lucene-solr/compare/solr2052?expand=1\n\nI would love to be able to provide the necessary/desired coverage to enable this to make it into trunk and 4.8 / 4.7.1 as we have been using this functionality successfully for years and I would really love to get out of the business of patching and using a custom build! =) "
        },
        {
            "author": "Aaron Daubman",
            "id": "comment-13949431",
            "date": "2014-03-27T15:04:46+0000",
            "content": "I am looking to add some tests to demonstrate the caching still works correctly with these changes per Hoss' recommendation on #solr. \nIn the meantime, maybe it is worth pointing out that at some point several places that in the past did not handle both a list of filter queries and a docset filter being set at the same time were updated to use searcher.getProcessedFilter(cmd.getFilter(), cmd.getFilterList()) - which does appear to handle the case where both are set appropriately...\n...this confuses me even more, since the defensive assertions in SolrIndexSearcher attempt to prevent both of these from being set, and yet getProcessedFilter has been updated to handle the case where both are set appropriately (as far as I can tell). It does look like this works correctly with caching as well - I am now just trying to figure out the right way and place to add tests to demonstrate this. "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13971147",
            "date": "2014-04-16T12:57:17+0000",
            "content": "Move issue to Solr 4.9. "
        }
    ]
}