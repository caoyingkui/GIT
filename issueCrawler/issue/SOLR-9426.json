{
    "id": "SOLR-9426",
    "title": "TesReplicationHandler.doTestIndexAndConfigAliasReplication() failure",
    "details": {
        "components": [],
        "type": "Bug",
        "labels": "",
        "fix_versions": [],
        "affect_versions": "None",
        "status": "Open",
        "resolution": "Unresolved",
        "priority": "Major"
    },
    "description": "My Jenkins found this branch_6x seed (reproduces for me, but only if I remove -Dtests.method=doTestIndexAndConfigAliasReplication from the cmdline):\n\n\nChecking out Revision 44df5b60266549e410b7691ebf49583d7370c0e3 (refs/remotes/origin/branch_6x)\n[...]\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestReplicationHandler -Dtests.method=doTestIndexAndConfigAliasReplication -Dtests.seed=8D2C8D836AE82A81 -Dtests.slow=true -Dtests.locale=pt-PT -Dtests.timezone=America/Panama -Dtests.asserts=true -Dtests.file.encoding=UTF-8\n   [junit4] FAILURE 37.2s J3  | TestReplicationHandler.doTestIndexAndConfigAliasReplication <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError: expected:<1> but was:<0>\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([8D2C8D836AE82A81:7A5F63DBAC008567]:0)\n   [junit4]    > \tat org.apache.solr.handler.TestReplicationHandler.doTestIndexAndConfigAliasReplication(TestReplicationHandler.java:1331)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:745)",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2016-09-07T12:59:51+0000",
            "author": "Alan Woodward",
            "content": "See also: https://builds.apache.org/job/Lucene-Solr-Tests-master/1385/\n\nGoing through the logs, this seems to be caused by the following Exception:\n\n [junit4]   2> 1585983 WARN  (indexFetcher-4517-thread-1) [    x:collection1] o.a.s.h.IndexFetcher Exception while updating statistics\n   [junit4]   2> java.io.IOException: file \"replication.properties\" was already written to\n   [junit4]   2> \tat org.apache.lucene.store.MockDirectoryWrapper.createOutput(MockDirectoryWrapper.java:654)\n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.logReplicationTimeAndConfFiles(IndexFetcher.java:695)\n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:507)\n   [junit4]   2> \tat org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:268)\n   [junit4]   2> \tat org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:397)\n   [junit4]   2> \tat org.apache.solr.handler.ReplicationHandler.lambda$setupPolling$2(ReplicationHandler.java:1154)\n   [junit4]   2> \tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n   [junit4]   2> \tat java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)\n   [junit4]   2> \tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)\n   [junit4]   2> \tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)\n   [junit4]   2> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n   [junit4]   2> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:745)\n\n ",
            "id": "comment-15470563"
        },
        {
            "date": "2016-09-13T16:24:10+0000",
            "author": "Alan Woodward",
            "content": "There are two Exceptions that get thrown here, the \"can't write replication.properties twice\" one above (which is enforced by MockDirectoryWrapper, and so won't actually cause problems outside tests) and a \"failed to close IndexWriter\" one.  The latter is the one that occasionally causes test failures, although sometimes it just gets swallowed silently - I'm not entirely clear why, but it makes reproducing these very tricky.  The IndexWriter closure failure is because on reload, SolrCore tries to remove old index directories, but it does this before closing the old IndexWriter, which tries to execute a rollback on its uncommitted data.\n\n\n73098 ERROR (Thread-165) [    x:collection1] o.a.s.u.SolrIndexWriter Error closing IndexWriter\n   [junit4]   2> java.nio.file.NoSuchFileException: /home/jenkins/workspace/Lucene-Solr-master-Linux/solr/build/solr-core/test/J0/temp/solr.handler.TestReplicationHandler_1B92CBF81297145D-001/solr-instance-002/collection1/data/index.20160912005540509\n   [junit4]   2>        at sun.nio.fs.UnixException.translateToIOException(UnixException.java:86)\n   [junit4]   2>        at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102)\n   [junit4]   2>        at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107)\n   [junit4]   2>        at sun.nio.fs.UnixFileSystemProvider.newDirectoryStream(UnixFileSystemProvider.java:427)\n   [junit4]   2>        at java.nio.file.Files.newDirectoryStream(Files.java:457)\n   [junit4]   2>        at org.apache.lucene.store.FSDirectory.listAll(FSDirectory.java:215)\n   [junit4]   2>        at org.apache.lucene.store.FSDirectory.listAll(FSDirectory.java:234)\n   [junit4]   2>        at org.apache.lucene.store.NRTCachingDirectory.listAll(NRTCachingDirectory.java:103)\n   [junit4]   2>        at org.apache.lucene.store.FilterDirectory.listAll(FilterDirectory.java:57)\n   [junit4]   2>        at org.apache.lucene.index.IndexFileDeleter.refresh(IndexFileDeleter.java:428)\n   [junit4]   2>        at org.apache.lucene.index.IndexWriter.rollbackInternalNoCommit(IndexWriter.java:2220)\n   [junit4]   2>        at org.apache.lucene.index.IndexWriter.rollbackInternal(IndexWriter.java:2162)\n   [junit4]   2>        at org.apache.lucene.index.IndexWriter.shutdown(IndexWriter.java:1120)\n   [junit4]   2>        at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1162)\n   [junit4]   2>        at org.apache.solr.update.SolrIndexWriter.close(SolrIndexWriter.java:130)\n   [junit4]   2>        at org.apache.solr.update.DefaultSolrCoreState.changeWriter(DefaultSolrCoreState.java:188)\n   [junit4]   2>        at org.apache.solr.update.DefaultSolrCoreState.newIndexWriter(DefaultSolrCoreState.java:212)\n   [junit4]   2>        at org.apache.solr.core.SolrCore.reload(SolrCore.java:507)\n   [junit4]   2>        at org.apache.solr.core.CoreContainer.reload(CoreContainer.java:962)\n   [junit4]   2>        at org.apache.solr.handler.IndexFetcher.lambda$reloadCore$0(IndexFetcher.java:787)\n   [junit4]   2>        at java.lang.Thread.run(Thread.java:745)\n\n ",
            "id": "comment-15487648"
        }
    ]
}