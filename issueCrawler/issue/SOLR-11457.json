{
    "id": "SOLR-11457",
    "title": "HealthCheckHandlerTest.testHealthCheckHandlerSolrJ() non-reproducible failures -- test order/timing realted?",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [],
        "type": "Bug",
        "fix_versions": [
            "master (8.0)"
        ],
        "affect_versions": "None",
        "resolution": "Fixed",
        "status": "Resolved"
    },
    "description": "jenkins emais indicates this test has failed a fair bit since it was added 2 months ago ... the only test log i managed to grab before they were deleted was from https://builds.apache.org/job/Lucene-Solr-Tests-master/2112/\n\nIIUC the root problem is that testHealthCheckHandler() is deliberately expring the ZK session, so if that actually happens (not garunteed, see SOLR-11456) and HealthCheckHandlerTest.testHealthCheckHandlerSolrJ() runs after it, then the helath check with fail and testHealthCheckHandlerSolrJ() will give a false negative.",
    "attachments": {
        "jenkins.2112.HealthCheckHandlerTest.txt": "https://issues.apache.org/jira/secure/attachment/12891183/jenkins.2112.HealthCheckHandlerTest.txt"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2017-10-10T01:24:05+0000",
            "content": "note this relevant bit from the attached jenkins log...\n\n\n   [junit4]   2> 7608228 INFO  (TEST-HealthCheckHandlerTest.testHealthCheckHandler-seed#[D95E86B813E36BF4]) [    ] o.a.s.SolrTestCaseJ4 ###Starting testHealthCheckHandler\n   [junit4]   2> 7608326 INFO  (qtp723337605-16665) [n:127.0.0.1:59629_solr    ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/health params={wt=javabin&version=2} status=0 QTime=0\n   [junit4]   2> 7608327 INFO  (TEST-HealthCheckHandlerTest.testHealthCheckHandler-seed#[D95E86B813E36BF4]) [    ] o.a.s.c.MiniSolrCloudCluster Expired zookeeper session 98767291805859843 from node htt\np://127.0.0.1:59629/solr\n   [junit4]   2> 7608347 INFO  (zkCallback-2223-thread-1) [    ] o.a.s.c.c.ZkStateReader Updated live nodes from ZooKeeper... (1) -> (0)\n   [junit4]   2> 7608514 WARN  (zkCallback-2218-thread-2-processing-n:127.0.0.1:59629_solr) [n:127.0.0.1:59629_solr    ] o.a.s.c.c.ConnectionManager Watcher org.apache.solr.common.cloud.ConnectionManager@7e690903 name: ZooKeeperConnection Watcher:127.0.0.1:54525/solr got event WatchedEvent state:Disconnected type:None path:null path: null type: None\n   [junit4]   2> 7608514 WARN  (zkCallback-2218-thread-2-processing-n:127.0.0.1:59629_solr) [n:127.0.0.1:59629_solr    ] o.a.s.c.c.ConnectionManager zkClient has disconnected\n   [junit4]   2> 7608521 INFO  (qtp723337605-16663) [n:127.0.0.1:59629_solr    ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/health params={wt=javabin&version=2} status=0 QTime=0\n   [junit4]   2> 7608607 INFO  (TEST-HealthCheckHandlerTest.testHealthCheckHandler-seed#[D95E86B813E36BF4]) [    ] o.a.s.SolrTestCaseJ4 ###Ending testHealthCheckHandler\n   [junit4]   2> 7608619 INFO  (TEST-HealthCheckHandlerTest.testHealthCheckHandlerWithCloudClient-seed#[D95E86B813E36BF4]) [    ] o.a.s.SolrTestCaseJ4 ###Starting testHealthCheckHandlerWithCloudClient\n   [junit4]   2> 7608647 INFO  (TEST-HealthCheckHandlerTest.testHealthCheckHandlerWithCloudClient-seed#[D95E86B813E36BF4]) [    ] o.a.s.SolrTestCaseJ4 ###Ending testHealthCheckHandlerWithCloudClient\n   [junit4]   2> 7608688 INFO  (TEST-HealthCheckHandlerTest.testHealthCheckHandlerSolrJ-seed#[D95E86B813E36BF4]) [    ] o.a.s.SolrTestCaseJ4 ###Starting testHealthCheckHandlerSolrJ\n   [junit4]   2> 7608706 INFO  (qtp723337605-16668) [n:127.0.0.1:59629_solr    ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/health params={wt=javabin&version=2} status=503 QTime=0\n   [junit4]   2> 7608707 INFO  (TEST-HealthCheckHandlerTest.testHealthCheckHandlerSolrJ-seed#[D95E86B813E36BF4]) [    ] o.a.s.SolrTestCaseJ4 ###Ending testHealthCheckHandlerSolrJ\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=HealthCheckHandlerTest -Dtests.method=testHealthCheckHandlerSolrJ -Dtests.seed=D95E86B813E36BF4 -Dtests.multiplier=2 -Dtests.slow=true -Dtests.locale=es-EC -Dtests.timezone=AGT -Dtests.asserts=true -Dtests.file.encoding=UTF-8\n   [junit4] ERROR   0.06s J1 | HealthCheckHandlerTest.testHealthCheckHandlerSolrJ <<<\n   [junit4]    > Throwable #1: org.apache.solr.client.solrj.impl.HttpSolrClient$RemoteSolrException: Error from server at http://127.0.0.1:59629/solr: Host Unavailable: Not connected to zk\n...\n\n\n\nas opposed to running the same seed (w/o all test methods) on my local machine where it passes locally \u2013 IIUC because the \"closing socket connection and attempting reconnect\" has a chance to kick in before testHealthCheckHandlerSolrJ starts\n\n\n$ ant test  -Dtestcase=HealthCheckHandlerTest -Dtests.seed=D95E86B813E36BF4 -Dtests.multiplier=2 -Dtests.slow=true -Dtests.locale=es-EC -Dtests.timezone=AGT -Dtests.asserts=true -Dtests.file.encoding=UTF-8\n...\n   [junit4]   2> 1976 INFO  (TEST-HealthCheckHandlerTest.testHealthCheckHandler-seed#[D95E86B813E36BF4]) [    ] o.a.s.SolrTestCaseJ4 ###Starting testHealthCheckHandler\n   [junit4]   2> 2172 INFO  (qtp2093157283-26) [n:127.0.0.1:46082_solr    ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/health params={wt=javabin&version=2} status=0 QTime=31\n   [junit4]   2> 2213 INFO  (TEST-HealthCheckHandlerTest.testHealthCheckHandler-seed#[D95E86B813E36BF4]) [    ] o.a.s.c.MiniSolrCloudCluster Expired zookeeper session 98801923520528387 from node http://127.0.0.1:46082/solr\n   [junit4]   2> 2214 INFO  (zkCallback-13-thread-1) [    ] o.a.s.c.c.ZkStateReader Updated live nodes from ZooKeeper... (1) -> (0)\n   [junit4]   2> 2214 WARN  (jetty-launcher-1-thread-1-SendThread(127.0.0.1:44037)) [n:127.0.0.1:46082_solr    ] o.a.z.ClientCnxn Session 0x15f03d372910003 for server null, unexpected error, closing socket connection and attempting reconnect\n   [junit4]   2> java.nio.channels.CancelledKeyException\n   [junit4]   2> \tat sun.nio.ch.SelectionKeyImpl.ensureValid(SelectionKeyImpl.java:73)\n   [junit4]   2> \tat sun.nio.ch.SelectionKeyImpl.interestOps(SelectionKeyImpl.java:77)\n   [junit4]   2> \tat org.apache.zookeeper.ClientCnxnSocketNIO.enableWrite(ClientCnxnSocketNIO.java:389)\n   [junit4]   2> \tat org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:373)\n   [junit4]   2> \tat org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1141)\n   [junit4]   2> 2315 INFO  (qtp2093157283-28) [n:127.0.0.1:46082_solr    ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/health params={wt=javabin&version=2} status=0 QTime=0\n   [junit4]   2> 2318 INFO  (TEST-HealthCheckHandlerTest.testHealthCheckHandler-seed#[D95E86B813E36BF4]) [    ] o.a.s.SolrTestCaseJ4 ###Ending testHealthCheckHandler\n   [junit4]   2> 2319 WARN  (zkCallback-8-thread-3-processing-n:127.0.0.1:46082_solr) [n:127.0.0.1:46082_solr    ] o.a.s.c.c.ConnectionManager Watcher org.apache.solr.common.cloud.ConnectionManager@30d07b10 name: ZooKeeperConnection Watcher:127.0.0.1:44037/solr got event WatchedEvent state:Disconnected type:None path:null path: null type: None\n   [junit4]   2> 2319 WARN  (zkCallback-8-thread-3-processing-n:127.0.0.1:46082_solr) [n:127.0.0.1:46082_solr    ] o.a.s.c.c.ConnectionManager zkClient has disconnected\n   [junit4] OK      0.37s | HealthCheckHandlerTest.testHealthCheckHandler\n   [junit4]   2> 2336 INFO  (TEST-HealthCheckHandlerTest.testHealthCheckHandlerWithCloudClient-seed#[D95E86B813E36BF4]) [    ] o.a.s.SolrTestCaseJ4 ###Starting testHealthCheckHandlerWithCloudClient\n   [junit4]   2> 2338 INFO  (TEST-HealthCheckHandlerTest.testHealthCheckHandlerWithCloudClient-seed#[D95E86B813E36BF4]) [    ] o.a.s.SolrTestCaseJ4 ###Ending testHealthCheckHandlerWithCloudClient\n   [junit4] OK      0.01s | HealthCheckHandlerTest.testHealthCheckHandlerWithCloudClient\n   [junit4]   2> 2342 INFO  (TEST-HealthCheckHandlerTest.testHealthCheckHandlerSolrJ-seed#[D95E86B813E36BF4]) [    ] o.a.s.SolrTestCaseJ4 ###Starting testHealthCheckHandlerSolrJ\n   [junit4]   2> 2345 INFO  (qtp2093157283-26) [n:127.0.0.1:46082_solr    ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/health params={wt=javabin&version=2} status=0 QTime=0\n   [junit4]   2> 2346 INFO  (TEST-HealthCheckHandlerTest.testHealthCheckHandlerSolrJ-seed#[D95E86B813E36BF4]) [    ] o.a.s.SolrTestCaseJ4 ###Ending testHealthCheckHandlerSolrJ\n   [junit4] OK      0.01s | HealthCheckHandlerTest.testHealthCheckHandlerSolrJ\n\n\n ",
            "author": "Hoss Man",
            "id": "comment-16197997"
        },
        {
            "date": "2017-10-10T18:00:45+0000",
            "content": "pretty sure these failures will be fixed automatically by the patch i just uploaded to SOLR-11456 ",
            "author": "Hoss Man",
            "id": "comment-16199095"
        },
        {
            "date": "2017-10-11T22:33:28+0000",
            "content": "fixed via SOLR-11456 ",
            "author": "Hoss Man",
            "id": "comment-16201091"
        }
    ]
}