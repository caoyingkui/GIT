{
    "id": "LUCENE-7032",
    "title": "jdk-9-ea+105 breaks MinimizeOperations.minimize()",
    "details": {
        "resolution": "Fixed",
        "affect_versions": "6.0",
        "components": [],
        "labels": "",
        "fix_versions": [],
        "priority": "Major",
        "status": "Resolved",
        "type": "Bug"
    },
    "description": "As soon as jdk-9-ea+105 was put into test rotation, automaton tests have been sporatically failing in non-reproducible ways. All of them invoke hopcroft minimization either directly or indirectly.\n\nThe bug manifests in several forms:\n\n\tArrayIndexOutOfBoundsException in minimize()\n\tIllegalArgumentException for an explicit bounds check\n\tincorrect resulting automaton\n\n\n\nThis method is ... let's say not the ideal one to debug something like this, but I've at least got it where I can make it fail in a few minutes with beasting, so we can try simple things like turning on/off jvm flags to try to narrow it more.\n\nIt would be really great to make it fail more efficiently, but unfortunately it takes many thousands of iterations until we understand more about it.",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "id": "comment-15149858",
            "author": "Robert Muir",
            "date": "2016-02-17T05:00:12+0000",
            "content": "Here is the current best I have. Its still very inefficient and slow, but tends to fail in less than five minutes:\n\n\nrmuir@beast:~/workspace/lucene-solr/lucene/core$ ant beast -Dtestcase=TestMinimize -Dtests.method=\"testBasic*\" -Dargs=\"-XX:+UseCompressedOops -XX:+UseParallelGC -XX:-UseSuperWord\" -Dtests.iters=1000 -Dtests.multiplier=3 -Dtests.seed=5E1BF6106DCA9EC9 -Dtests.failfast=yes -Dbeast.iters=1000 -Dtests.dups=8 -Dtests.jvms=8\nBuildfile: /home/rmuir/workspace/lucene-solr/lucene/core/build.xml\n\n-clover.disable:\n\nivy-availability-check:\n\nivy-fail:\n\nivy-configure:\n[ivy:configure] :: Apache Ivy 2.3.0 - 20130110142753 :: http://ant.apache.org/ivy/ ::\n[ivy:configure] :: loading settings :: file = /home/rmuir/workspace/lucene-solr/lucene/ivy-settings.xml\n\n-clover.load:\n\n-clover.classpath:\n\n-clover.setup:\n\nclover:\n\n-check-git-state:\n\n-git-cleanroot:\n\n-copy-git-state:\n\ngit-autoclean:\n\nresolve:\n\ninit:\n\ncompile-core:\n\ncompile-test-framework:\n\n-check-git-state:\n\n-git-cleanroot:\n\n-copy-git-state:\n\ngit-autoclean:\n\nivy-availability-check:\n\nivy-fail:\n\nivy-configure:\n[ivy:configure] :: loading settings :: file = /home/rmuir/workspace/lucene-solr/lucene/ivy-settings.xml\n\nresolve:\n\ninit:\n\ncompile-lucene-core:\n\n-check-git-state:\n\n-git-cleanroot:\n\n-copy-git-state:\n\ngit-autoclean:\n\nivy-availability-check:\n\nivy-fail:\n\nivy-configure:\n[ivy:configure] :: loading settings :: file = /home/rmuir/workspace/lucene-solr/lucene/ivy-settings.xml\n\nresolve:\n\ninit:\n\n-clover.disable:\n\n-clover.load:\n\n-clover.classpath:\n\n-clover.setup:\n\nclover:\n\ncompile-core:\n\ncompile-codecs:\n\n-check-git-state:\n\n-git-cleanroot:\n\n-copy-git-state:\n\ngit-autoclean:\n\nivy-availability-check:\n\nivy-fail:\n\nivy-configure:\n[ivy:configure] :: loading settings :: file = /home/rmuir/workspace/lucene-solr/lucene/ivy-settings.xml\n\nresolve:\n\ncommon.init:\n\ncompile-lucene-core:\n\ninit:\n\n-clover.disable:\n\n-clover.load:\n\n-clover.classpath:\n\n-clover.setup:\n\nclover:\n\ncompile-core:\n\n-clover.disable:\n\n-clover.load:\n\n-clover.classpath:\n\n-clover.setup:\n\nclover:\n\ncommon.compile-core:\n\ncompile-core:\n\ncompile-test:\n\ninstall-junit4-taskdef:\n\nvalidate:\n\nresolve-groovy:\n[ivy:cachepath] :: resolving dependencies :: org.codehaus.groovy#groovy-all-caller;working\n[ivy:cachepath] \tconfs: [default]\n[ivy:cachepath] \tfound org.codehaus.groovy#groovy-all;2.4.4 in public\n[ivy:cachepath] :: resolution report :: resolve 12ms :: artifacts dl 0ms\n\t---------------------------------------------------------------------\n\t|                  |            modules            ||   artifacts   |\n\t|       conf       | number| search|dwnlded|evicted|| number|dwnlded|\n\t---------------------------------------------------------------------\n\t|      default     |   1   |   0   |   0   |   0   ||   1   |   0   |\n\t---------------------------------------------------------------------\n\n-init-totals:\n\n-beast:\n  [beaster] Beast round: 1\n   [junit4] Duplicate suite name used with XML reports: org.apache.lucene.util.automaton.TestMinimize. This may confuse tools that process XML reports. Set 'ignoreDuplicateSuites' to true to skip this message.\n  [beaster] Executing 8 suites with 8 JVMs.\n  [beaster] \n  [beaster] Started J1 PID(8867@localhost).\n  [beaster] Started J6 PID(8857@localhost).\n  [beaster] Started J5 PID(8859@localhost).\n  [beaster] Started J3 PID(8861@localhost).\n  [beaster] Started J4 PID(8862@localhost).\n  [beaster] Started J0 PID(8858@localhost).\n  [beaster] Started J7 PID(8860@localhost).\n  [beaster] Started J2 PID(8863@localhost).\n  [beaster]   2> NOTE: reproduce with: ant test  -Dtestcase=TestMinimize -Dtests.method=testBasic -Dtests.seed=5E1BF6106DCA9EC9 -Dtests.multiplier=3 -Dtests.locale=fr-GF -Dtests.timezone=Africa/Khartoum -Dtests.asserts=true -Dtests.file.encoding=UTF-8\n  [beaster] [23:43:35.303] ERROR   0.62s J0 | TestMinimize.testBasic { seed=[5E1BF6106DCA9EC9:3C97F1414A872260]} <<<\n  [beaster]    > Throwable #1: java.lang.IllegalArgumentException: source=3 is out of bounds (maxState is 2)\n  [beaster]    > \tat __randomizedtesting.SeedInfo.seed([5E1BF6106DCA9EC9:3C97F1414A872260]:0)\n  [beaster]    > \tat org.apache.lucene.util.automaton.Automaton.addTransition(Automaton.java:165)\n  [beaster]    > \tat org.apache.lucene.util.automaton.MinimizationOperations.minimize(MinimizationOperations.java:245)\n  [beaster]    > \tat org.apache.lucene.util.automaton.RegExp.toAutomatonInternal(RegExp.java:537)\n  [beaster]    > \tat org.apache.lucene.util.automaton.RegExp.findLeaves(RegExp.java:617)\n  [beaster]    > \tat org.apache.lucene.util.automaton.RegExp.toAutomatonInternal(RegExp.java:521)\n  [beaster]    > \tat org.apache.lucene.util.automaton.RegExp.findLeaves(RegExp.java:617)\n  [beaster]    > \tat org.apache.lucene.util.automaton.RegExp.toAutomatonInternal(RegExp.java:512)\n  [beaster]    > \tat org.apache.lucene.util.automaton.RegExp.toAutomaton(RegExp.java:495)\n  [beaster]    > \tat org.apache.lucene.util.automaton.RegExp.toAutomaton(RegExp.java:426)\n  [beaster]    > \tat org.apache.lucene.util.automaton.AutomatonTestUtil.randomSingleAutomaton(AutomatonTestUtil.java:262)\n  [beaster]    > \tat org.apache.lucene.util.automaton.AutomatonTestUtil.randomAutomaton(AutomatonTestUtil.java:277)\n  [beaster]    > \tat org.apache.lucene.util.automaton.TestMinimize.testBasic(TestMinimize.java:30)\n  [beaster]    > \tat sun.reflect.GeneratedMethodAccessor3.invoke(Unknown Source)\n  [beaster]    > \tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n  [beaster]    > \tat java.lang.reflect.Method.invoke(Method.java:520)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1764)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$8.evaluate(RandomizedRunner.java:871)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$9.evaluate(RandomizedRunner.java:907)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$10.evaluate(RandomizedRunner.java:921)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:49)\n  [beaster]    > \tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:48)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:64)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:47)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:367)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.ThreadLeakControl.forkTimeoutingTask(ThreadLeakControl.java:809)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.ThreadLeakControl$3.evaluate(ThreadLeakControl.java:460)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:880)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:781)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:816)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:827)\n  [beaster]    > \tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:41)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:53)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:47)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:64)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:54)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:367)\n  [beaster]    > \tat java.lang.Thread.run(Thread.java:804)\n  [beaster]   2> NOTE: test params are: codec=Asserting(Lucene60): {}, docValues:{}, sim=RandomSimilarity(queryNorm=true,coord=no): {}, locale=fr-GF, timezone=Africa/Khartoum\n  [beaster]   2> NOTE: Linux 4.2.0-25-generic amd64/Oracle Corporation 9-ea (64-bit)/cpus=8,threads=1,free=159816632,total=242745344\n  [beaster]   2> NOTE: All tests run in this JVM: [TestMinimize]\n  [beaster]   2> NOTE: reproduce with: ant test  -Dtestcase=TestMinimize -Dtests.method=testBasic -Dtests.seed=5E1BF6106DCA9EC9 -Dtests.multiplier=3 -Dtests.locale=fr-GF -Dtests.timezone=Africa/Khartoum -Dtests.asserts=true -Dtests.file.encoding=UTF-8\n  [beaster] [23:43:38.117] ERROR   0.47s J1 | TestMinimize.testBasic { seed=[5E1BF6106DCA9EC9:ECAC52C8285BA478]} <<<\n  [beaster]    > Throwable #1: java.lang.ArrayIndexOutOfBoundsException: 10\n  [beaster]    > \tat __randomizedtesting.SeedInfo.seed([5E1BF6106DCA9EC9:ECAC52C8285BA478]:0)\n  [beaster]    > \tat org.apache.lucene.util.automaton.MinimizationOperations.minimize(MinimizationOperations.java:235)\n  [beaster]    > \tat org.apache.lucene.util.automaton.RegExp.toAutomatonInternal(RegExp.java:524)\n  [beaster]    > \tat org.apache.lucene.util.automaton.RegExp.toAutomaton(RegExp.java:495)\n  [beaster]    > \tat org.apache.lucene.util.automaton.RegExp.toAutomaton(RegExp.java:426)\n  [beaster]    > \tat org.apache.lucene.util.automaton.AutomatonTestUtil.randomSingleAutomaton(AutomatonTestUtil.java:262)\n  [beaster]    > \tat org.apache.lucene.util.automaton.AutomatonTestUtil.randomAutomaton(AutomatonTestUtil.java:276)\n  [beaster]    > \tat org.apache.lucene.util.automaton.TestMinimize.testBasic(TestMinimize.java:30)\n  [beaster]    > \tat sun.reflect.GeneratedMethodAccessor3.invoke(Unknown Source)\n  [beaster]    > \tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n  [beaster]    > \tat java.lang.reflect.Method.invoke(Method.java:520)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1764)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$8.evaluate(RandomizedRunner.java:871)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$9.evaluate(RandomizedRunner.java:907)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$10.evaluate(RandomizedRunner.java:921)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:49)\n  [beaster]    > \tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:48)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:64)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:47)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:367)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.ThreadLeakControl.forkTimeoutingTask(ThreadLeakControl.java:809)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.ThreadLeakControl$3.evaluate(ThreadLeakControl.java:460)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:880)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:781)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:816)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:827)\n  [beaster]    > \tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:41)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:53)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:47)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:64)\n  [beaster]    > \tat org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:54)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n  [beaster]    > \tat com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:367)\n  [beaster]    > \tat java.lang.Thread.run(Thread.java:804)\n  [beaster]   2> NOTE: test params are: codec=Asserting(Lucene60): {}, docValues:{}, sim=RandomSimilarity(queryNorm=true,coord=no): {}, locale=fr-GF, timezone=Africa/Khartoum\n  [beaster]   2> NOTE: Linux 4.2.0-25-generic amd64/Oracle Corporation 9-ea (64-bit)/cpus=8,threads=1,free=177601584,total=233832448\n  [beaster]   2> NOTE: All tests run in this JVM: [TestMinimize]\n  [beaster] \n  [beaster] Tests with failures [seed: 5E1BF6106DCA9EC9]:\n  [beaster]   - org.apache.lucene.util.automaton.TestMinimize.testBasic { seed=[5E1BF6106DCA9EC9:3C97F1414A872260]}\n  [beaster]   - org.apache.lucene.util.automaton.TestMinimize.testBasic { seed=[5E1BF6106DCA9EC9:ECAC52C8285BA478]}\n  [beaster] \n  [beaster] \n\nBUILD FAILED\n/home/rmuir/workspace/lucene-solr/lucene/common-build.xml:1467: The following error occurred while executing this line:\n/home/rmuir/workspace/lucene-solr/lucene/common-build.xml:1457: The following error occurred while executing this line:\n/home/rmuir/workspace/lucene-solr/lucene/common-build.xml:1014: There were test failures: 8 suites, 8000 tests, 2 errors, 1945 ignored (1945 assumptions) [seed: 5E1BF6106DCA9EC9]\n\n "
        },
        {
            "id": "comment-15149918",
            "author": "Robert Muir",
            "date": "2016-02-17T05:35:04+0000",
            "content": "The flags passed by our jenkins randomization (-Dargs=\"-XX:+UseCompressedOops -XX:+UseParallelGC -XX:-UseSuperWord\") are all irrelevant. It fails in the same way with any garbage collector and on/off for the other two.\n\nSo my reproduction line is something like this:\n\n\nant beast -Dtestcase=TestMinimize -Dtests.method=\"testBasic*\" -Dtests.iters=1000 -Dtests.multiplier=3 -Dtests.seed=5E1BF6106DCA9EC9 -Dtests.failfast=yes -Dbeast.iters=5 -Dtests.dups=8 -Dtests.jvms=8\n\n\n\nI lowered beast.iters to 5, even though so far it always fails in the first iteration... we want to be careful since its only failing once per thousands (inefficient). This is probably good enough to slowly bisect hotspot to find the problematic commit, or we could play a guessing game with jvm flags. Dawid Weiss, I know you have done this before: do you still have the bisection script? Maybe we should commit it to our dev-tools if you still have it around. "
        },
        {
            "id": "comment-15150063",
            "author": "Dawid Weiss",
            "date": "2016-02-17T07:51:40+0000",
            "content": "There was no script for that, unfortunately \u2013 I did it with mercurial's bisect on the hotspot repo manually (rebuilding the jvm.so each time and re-running Lucene tests on the rebuilt version). "
        },
        {
            "id": "comment-15150074",
            "author": "Dawid Weiss",
            "date": "2016-02-17T08:00:37+0000",
            "content": "I'd try to make it more consistent by:\n1) trying to make the compiler deterministic (I'm guessing C2),\n2) trying to make the compiler run sequentially,\n3) maybe we can lower some compilation threshold a bit or deoptimize a lot to throw some noise at the compiler... if it speeds up the repro, otherwise it doesn't make sense as it'd contribute lots of irrelevant compilation logs.\n4) running with JVM assertions (fastdebug).\n\nOptions for 1 and 2 are:\n\n-XX:-TieredCompilation -Xbatch -XX:CICompilerCount=1\n\n\n\nPotential options for 3 are:\n\n-XX:+DeoptimizeALot\n-XX:+MinInliningThreshold=250 (default)\n-XX:+CompileThreshold=10000 (default)\n\n\n\nOption 4 will require a custom build of the hotspot, as may other flags \u2013 didn't check which ones are available in fastdebug builds only. "
        },
        {
            "id": "comment-15150748",
            "author": "Robert Muir",
            "date": "2016-02-17T16:39:08+0000",
            "content": "Thanks dawid, I optimized test parameters further and experimented with your suggestions.\n\nIt now fails 100% reproducible for me with a single test method invocation on my linux machine (4 seconds):\n\n\nrmuir@beast:~/workspace/lucene-solr/lucene/core$ ant test -Dtestcase=TestMinimize -Dtests.method=\"testBasic*\" -Dtests.seed=5E1BF6106DCA9EC9 -Dargs=\"-XX:-TieredCompilation -Xbatch\"\n\n<<< anting >>>\n\n-test:\n[junit4:pickseed] Seed property 'tests.seed' already defined: 5E1BF6106DCA9EC9\n   [junit4] <JUnit4> says g'day! Master seed: 5E1BF6106DCA9EC9\n   [junit4] Executing 1 suite with 1 JVM.\n   [junit4] \n   [junit4] Started J0 PID(5919@localhost).\n   [junit4] Suite: org.apache.lucene.util.automaton.TestMinimize\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestMinimize -Dtests.method=testBasic -Dtests.seed=5E1BF6106DCA9EC9 -Dtests.locale=fr-GF -Dtests.timezone=Africa/Khartoum -Dtests.asserts=true -Dtests.file.encoding=UTF-8\n   [junit4] ERROR   0.59s | TestMinimize.testBasic <<<\n   [junit4]    > Throwable #1: java.lang.IllegalArgumentException: source=3 is out of bounds (maxState is 2)\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([5E1BF6106DCA9EC9:F5E1EB05B21618E7]:0)\n   [junit4]    > \tat org.apache.lucene.util.automaton.Automaton.addTransition(Automaton.java:165)\n   [junit4]    > \tat org.apache.lucene.util.automaton.MinimizationOperations.minimize(MinimizationOperations.java:245)\n   [junit4]    > \tat org.apache.lucene.util.automaton.RegExp.toAutomatonInternal(RegExp.java:537)\n   [junit4]    > \tat org.apache.lucene.util.automaton.RegExp.findLeaves(RegExp.java:617)\n   [junit4]    > \tat org.apache.lucene.util.automaton.RegExp.toAutomatonInternal(RegExp.java:519)\n   [junit4]    > \tat org.apache.lucene.util.automaton.RegExp.toAutomaton(RegExp.java:495)\n   [junit4]    > \tat org.apache.lucene.util.automaton.RegExp.toAutomaton(RegExp.java:426)\n   [junit4]    > \tat org.apache.lucene.util.automaton.AutomatonTestUtil.randomSingleAutomaton(AutomatonTestUtil.java:262)\n   [junit4]    > \tat org.apache.lucene.util.automaton.AutomatonTestUtil.randomAutomaton(AutomatonTestUtil.java:276)\n   [junit4]    > \tat org.apache.lucene.util.automaton.TestMinimize.testBasic(TestMinimize.java:30)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:804)\n   [junit4]   2> NOTE: test params are: codec=Asserting(Lucene60): {}, docValues:{}, sim=RandomSimilarity(queryNorm=true,coord=no): {}, locale=fr-GF, timezone=Africa/Khartoum\n   [junit4]   2> NOTE: Linux 4.2.0-25-generic amd64/Oracle Corporation 9-ea (64-bit)/cpus=8,threads=1,free=162224128,total=197132288\n   [junit4]   2> NOTE: All tests run in this JVM: [TestMinimize]\n   [junit4] Completed [1/1 (1!)] in 1.69s, 1 test, 1 error <<< FAILURES!\n   [junit4] \n   [junit4] \n   [junit4] Tests with failures [seed: 5E1BF6106DCA9EC9]:\n   [junit4]   - org.apache.lucene.util.automaton.TestMinimize.testBasic\n   [junit4] \n   [junit4] \n   [junit4] JVM J0:     0.58 ..     2.96 =     2.38s\n   [junit4] Execution time total: 2.98 sec.\n   [junit4] Tests summary: 1 suite, 1 test, 1 error\n\nBUILD FAILED\n/home/rmuir/workspace/lucene-solr/lucene/common-build.xml:1457: The following error occurred while executing this line:\n/home/rmuir/workspace/lucene-solr/lucene/common-build.xml:1014: There were test failures: 1 suite, 1 test, 1 error [seed: 5E1BF6106DCA9EC9]\n\nTotal time: 4 seconds\n\n\n\nNow, to think about how to boil it down from here. "
        },
        {
            "id": "comment-15150824",
            "author": "Uwe Schindler",
            "date": "2016-02-17T17:26:32+0000",
            "content": "Hi,\nI think we are now fine to open bug report. I did this several times. Maybe use older bug as template:\n\n\tHow to checkout lucene-core (modify to use GIT)\n\tHow to run the test (above command line)\n\tHow to get pure \"java\" command line with \"ant -verbose\"\n\n\n\nThe OpenJDK developers (e.g., Roland Westrelin) were able to reproduce and debug. I think thats enough. I would not spend too much time in debugging this. "
        },
        {
            "id": "comment-15150845",
            "author": "Uwe Schindler",
            "date": "2016-02-17T17:40:28+0000",
            "content": "Fails on Windows, too (Java HotSpot(TM) 64-Bit Server VM (build 9-ea+105-2016-02-11-003336.javare.4433.nc, mixed mode):\n\n\n   [junit4] Suite: org.apache.lucene.util.automaton.TestMinimize\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestMinimize -Dtests.method=testBasic -Dtests.seed=5E1BF6106DCA9EC9 -Dtests.locale=fr-GF -Dtests.timezone=Africa/Khartoum -Dtests.asserts=true -Dtests.file.encoding=Cp1252\n   [junit4] ERROR   0.69s | TestMinimize.testBasic <<<\n   [junit4]    > Throwable #1: java.lang.IllegalArgumentException: source=3 is out of bounds (maxState is 2)\n   [junit4]    >        at __randomizedtesting.SeedInfo.seed([5E1BF6106DCA9EC9:F5E1EB05B21618E7]:0)\n   [junit4]    >        at org.apache.lucene.util.automaton.Automaton.addTransition(Automaton.java:165)\n   [junit4]    >        at org.apache.lucene.util.automaton.MinimizationOperations.minimize(MinimizationOperations.java:245)\n   [junit4]    >        at org.apache.lucene.util.automaton.RegExp.toAutomatonInternal(RegExp.java:537)\n   [junit4]    >        at org.apache.lucene.util.automaton.RegExp.findLeaves(RegExp.java:617)\n   [junit4]    >        at org.apache.lucene.util.automaton.RegExp.toAutomatonInternal(RegExp.java:519)\n   [junit4]    >        at org.apache.lucene.util.automaton.RegExp.toAutomaton(RegExp.java:495)\n   [junit4]    >        at org.apache.lucene.util.automaton.RegExp.toAutomaton(RegExp.java:426)\n   [junit4]    >        at org.apache.lucene.util.automaton.AutomatonTestUtil.randomSingleAutomaton(AutomatonTestUtil.java:262)\n   [junit4]    >        at org.apache.lucene.util.automaton.AutomatonTestUtil.randomAutomaton(AutomatonTestUtil.java:276)\n   [junit4]    >        at org.apache.lucene.util.automaton.TestMinimize.testBasic(TestMinimize.java:30)\n   [junit4]    >        at java.lang.Thread.run(Thread.java:804)\n   [junit4]   2> NOTE: test params are: codec=Asserting(Lucene60): {}, docValues:{}, sim=RandomSimilarity(queryNorm=true,coord=no): {}, locale=fr-GF, timezone=Africa/Khartoum\n   [junit4]   2> NOTE: Windows 7 6.1 amd64/Oracle Corporation 9-ea (64-bit)/cpus=8,threads=1,free=94388736,total=130023424\n   [junit4]   2> NOTE: All tests run in this JVM: [TestMinimize]\n   [junit4] Completed [1/1 (1!)] in 1.60s, 1 test, 1 error <<< FAILURES!\n   [junit4]\n   [junit4]\n   [junit4] Tests with failures [seed: 5E1BF6106DCA9EC9]:\n   [junit4]   - org.apache.lucene.util.automaton.TestMinimize.testBasic\n   [junit4]\n   [junit4]\n   [junit4] JVM J0:     0.88 ..     3.61 =     2.73s\n   [junit4] Execution time total: 3.64 sec.\n   [junit4] Tests summary: 1 suite, 1 test, 1 error\n\n "
        },
        {
            "id": "comment-15154563",
            "author": "Robert Muir",
            "date": "2016-02-19T18:04:20+0000",
            "content": "Here is the openjdk bug: https://bugs.openjdk.java.net/browse/JDK-8150280 "
        },
        {
            "id": "comment-15170293",
            "author": "Robert Muir",
            "date": "2016-02-27T02:27:45+0000",
            "content": "See https://bugs.openjdk.java.net/browse/JDK-8150280\n\nTobias Hartmann debugged the issue. "
        }
    ]
}