{
    "id": "LUCENE-7424",
    "title": "TestGeo3DPoint.testGeo3DRelations() failures",
    "details": {
        "resolution": "Fixed",
        "affect_versions": "None",
        "components": [
            "modules/spatial3d"
        ],
        "labels": "",
        "fix_versions": [
            "7.0"
        ],
        "priority": "Major",
        "status": "Resolved",
        "type": "Bug"
    },
    "description": "My Jenkins found a reproducing master seed:\n\n\n  [junit4] Suite: org.apache.lucene.spatial3d.TestGeo3DPoint\n  [junit4]   1>     doc=1114 is contained by shape but is outside the returned XYZBounds\n  [junit4]   1>       unquantized=[lat=-1.5316724989005415, lon=3.141592653589793([X=-0.03902652216795768, Y=4.779370545484258E-18, Z=-0.9970038705813589])]\n  [junit4]   1>       quantized=[X=-0.03902652216283731, Y=2.3309121299774915E-10, Z=-0.9970038706538652]\n  [junit4]   1>   shape=GeoCompositeMembershipShape: {[GeoConvexPolygon: {planetmodel=PlanetModel.WGS84, points=[[lat=1.079437865394857, lon=-1.720224083538152E-11([X=0.47111944719262044, Y=-8.104310192839264E-12, Z=0.8803759987367299])], [lat=-1.5707963267948966, lon=0.017453291479645996([X=6.108601474971234E-17, Y=1.066260290095308E-18, Z=-0.997762292022105])], [lat=0.017453291479645996, lon=2.4457272005608357E-47([X=1.0009653513901666, Y=2.448088186713865E-47, Z=0.01747191415779267])]], internalEdges={2}}, GeoConvexPolygon: {planetmodel=PlanetModel.WGS84, points=[[lat=1.079437865394857, lon=-1.720224083538152E-11([X=0.47111944719262044, Y=-8.104310192839264E-12, Z=0.8803759987367299])], [lat=0.017453291479645996, lon=2.4457272005608357E-47([X=1.0009653513901666, Y=2.448088186713865E-47, Z=0.01747191415779267])], [lat=0.0884233366943164, lon=0.4323234231678824([X=0.9054355304510789, Y=0.4178006803188124, Z=0.08840463683725623])]], internalEdges={0}}]}\n  [junit4]   1>   bounds=XYZBounds: [xmin=-0.017533380657829275 xmax=1.0011188549924792 ymin=-1.0172214856320074E-9 ymax=0.4178006813199529 zmin=-0.9977622930221051 zmax=0.9977622930221051]\n  [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestGeo3DPoint -Dtests.method=testGeo3DRelations -Dtests.seed=DEA074FDC975E012 -Dtests.slow=true -Dtests.locale=de-LU -Dtests.timezone=Pacific/Pohnpei -Dtests.asserts=true -Dtests.file.encoding=UTF-8\n  [junit4] FAILURE 0.64s J6 | TestGeo3DPoint.testGeo3DRelations <<<\n  [junit4]    > Throwable #1: java.lang.AssertionError: invalid bounds for shape=GeoCompositeMembershipShape: {[GeoConvexPolygon: {planetmodel=PlanetModel.WGS84, points=[[lat=1.079437865394857, lon=-1.720224083538152E-11([X=0.47111944719262044, Y=-8.104310192839264E-12, Z=0.8803759987367299])], [lat=-1.5707963267948966, lon=0.017453291479645996([X=6.108601474971234E-17, Y=1.066260290095308E-18, Z=-0.997762292022105])], [lat=0.017453291479645996, lon=2.4457272005608357E-47([X=1.0009653513901666, Y=2.448088186713865E-47, Z=0.01747191415779267])]], internalEdges={2}}, GeoConvexPolygon: {planetmodel=PlanetModel.WGS84, points=[[lat=1.079437865394857, lon=-1.720224083538152E-11([X=0.47111944719262044, Y=-8.104310192839264E-12, Z=0.8803759987367299])], [lat=0.017453291479645996, lon=2.4457272005608357E-47([X=1.0009653513901666, Y=2.448088186713865E-47, Z=0.01747191415779267])], [lat=0.0884233366943164, lon=0.4323234231678824([X=0.9054355304510789, Y=0.4178006803188124, Z=0.08840463683725623])]], internalEdges={0}}]}\n  [junit4]    > \tat __randomizedtesting.SeedInfo.seed([DEA074FDC975E012:6EDF096946384E8E]:0)\n  [junit4]    > \tat org.apache.lucene.spatial3d.TestGeo3DPoint.testGeo3DRelations(TestGeo3DPoint.java:259)\n  [junit4]    > \tat java.lang.Thread.run(Thread.java:745)\n  [junit4] IGNOR/A 0.00s J6 | TestGeo3DPoint.testRandomBig\n  [junit4]    > Assumption #1: 'nightly' test group is disabled (@Nightly())\n  [junit4]   2> NOTE: test params are: codec=Asserting(Lucene62): {id=FSTOrd50}, docValues:{id=DocValuesFormat(name=Direct)}, maxPointsInLeafNode=1836, maxMBSortInHeap=5.467605512876335, sim=RandomSimilarity(queryNorm=true): {}, locale=de-LU, timezone=Pacific/Pohnpei\n  [junit4]   2> NOTE: Linux 4.1.0-custom2-amd64 amd64/Oracle Corporation 1.8.0_77 (64-bit)/cpus=16,threads=1,free=507535088,total=528482304\n  [junit4]   2> NOTE: All tests run in this JVM: [TestGeo3DPoint]\n  [junit4] Completed [11/11 (1!)] on J6 in 9.39s, 14 tests, 1 failure, 1 skipped <<< FAILURES!\n\n\n\nI looked back through email notifications from my Jenkins and found this older but still reproducing failure:\n\n\n  [junit4] Suite: org.apache.lucene.spatial3d.TestGeo3DPoint\n  [junit4] IGNOR/A 0.01s J1 | TestGeo3DPoint.testRandomBig\n  [junit4]    > Assumption #1: 'nightly' test group is disabled (@Nightly())\n  [junit4]   1>     doc=492 is contained by shape but is outside the returned XYZBounds\n  [junit4]   1>       unquantized=[lat=0.0, lon=-0.022127568649887065([X=1.0008737754335042, Y=-0.02215051847469871, Z=0.0])]\n  [junit4]   1>       quantized=[X=1.0008737754427615, Y=-0.022150518349539516, Z=2.3309121299774915E-10]\n  [junit4]   1>     doc=879 is contained by shape but is outside the returned XYZBounds\n  [junit4]   1>       unquantized=[lat=0.0, lon=-0.03833969548052218([X=1.0003831556734408, Y=-0.038373189391333544, Z=0.0])]\n  [junit4]   1>       quantized=[X=1.0003831557339953, Y=-0.03837318940337864, Z=2.3309121299774915E-10]\n  [junit4]   1>   shape=GeoCompositeMembershipShape: {[GeoConvexPolygon: {planetmodel=PlanetModel.WGS84, points=[[lat=0.0, lon=-2.0764049210215627E-307([X=1.0011188539924791, Y=-2.078728114957451E-307, Z=0.0])], [lat=-0.05235987755982989, lon=1.1522039653792695([X=0.4063681026669516, Y=0.9134222954698412, Z=-0.05239402894622555])], [lat=0.0, lon=0.9689058028225104([X=0.5668352773145171, Y=0.825188904561246, Z=0.0])]], internalEdges={2}}, GeoConvexPolygon: {planetmodel=PlanetModel.WGS84, points=[[lat=0.0, lon=-2.0764049210215627E-307([X=1.0011188539924791, Y=-2.078728114957451E-307, Z=0.0])], [lat=0.0, lon=0.9689058028225104([X=0.5668352773145171, Y=0.825188904561246, Z=0.0])], [lat=8.602294890145611E-12, lon=2.336616258000507([X=-0.6939037589206829, Y=0.7216207682536315, Z=8.611919602127933E-12])]], internalEdges={0}}]}\n  [junit4]   1>   bounds=XYZBounds: [xmin=-0.823578472647096 xmax=1.0011188549924792 ymin=-1.0000286565170571E-9 ymax=1.0011188549924792 zmin=-0.05239402994622555 zmax=1.0119474874643955E-9]\n  [junit4]   2> NOTE: download the large Jenkins line-docs file by running 'ant get-jenkins-line-docs' in the lucene directory.\n  [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestGeo3DPoint -Dtests.method=testGeo3DRelations -Dtests.seed=6D5666E45E8F3CDA -Dtests.slow=true -Dtests.linedocsfile=/home/jenkins/lucene-data/enwiki.random.lines.txt -Dtests.locale=ar-TN -Dtests.timezone=America/Sitka -Dtests.asserts=true -Dtests.file.encoding=UTF-8\n  [junit4] FAILURE 0.06s J1 | TestGeo3DPoint.testGeo3DRelations <<<\n  [junit4]    > Throwable #1: java.lang.AssertionError: invalid bounds for shape=GeoCompositeMembershipShape: {[GeoConvexPolygon: {planetmodel=PlanetModel.WGS84, points=[[lat=0.0, lon=-2.0764049210215627E-307([X=1.0011188539924791, Y=-2.078728114957451E-307, Z=0.0])], [lat=-0.05235987755982989, lon=1.1522039653792695([X=0.4063681026669516, Y=0.9134222954698412, Z=-0.05239402894622555])], [lat=0.0, lon=0.9689058028225104([X=0.5668352773145171, Y=0.825188904561246, Z=0.0])]], internalEdges={2}}, GeoConvexPolygon: {planetmodel=PlanetModel.WGS84, points=[[lat=0.0, lon=-2.0764049210215627E-307([X=1.0011188539924791, Y=-2.078728114957451E-307, Z=0.0])], [lat=0.0, lon=0.9689058028225104([X=0.5668352773145171, Y=0.825188904561246, Z=0.0])], [lat=8.602294890145611E-12, lon=2.336616258000507([X=-0.6939037589206829, Y=0.7216207682536315, Z=8.611919602127933E-12])]], internalEdges={0}}]}\n  [junit4]    > \tat __randomizedtesting.SeedInfo.seed([6D5666E45E8F3CDA:DD291B70D1C29246]:0)\n  [junit4]    > \tat org.apache.lucene.spatial3d.TestGeo3DPoint.testGeo3DRelations(TestGeo3DPoint.java:259)\n  [junit4]    > \tat java.lang.Thread.run(Thread.java:745)\n  [junit4]   2> NOTE: test params are: codec=Lucene62, sim=RandomSimilarity(queryNorm=false,coord=crazy): {}, locale=ar-TN, timezone=America/Sitka\n  [junit4]   2> NOTE: Linux 4.1.0-custom2-amd64 amd64/Oracle Corporation 1.8.0_77 (64-bit)/cpus=16,threads=1,free=506426848,total=534773760\n  [junit4]   2> NOTE: All tests run in this JVM: [TestGeo3DPoint]\n  [junit4] Completed [11/11 (1!)] on J1 in 10.42s, 14 tests, 1 failure, 1 skipped <<< FAILURES!",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "id": "comment-15435427",
            "author": "Karl Wright",
            "date": "2016-08-24T18:24:05+0000",
            "content": "Once again, I will not have a chance to look at this for at least a week. "
        },
        {
            "id": "comment-15436397",
            "author": "Karl Wright",
            "date": "2016-08-25T07:13:42+0000",
            "content": "Some data.\n\nThe point that is \"inside\" the shape but outside the bounds:\n\n\n   [junit4]   1>       unquantized=[lat=-1.5316724989005415, lon=3.141592653589793([X=-0.03902652216795768, Y=4.779370545484258E-18, Z=-0.9970038705813589])]\n   [junit4]   1>       quantized=[X=-0.03902652216283731, Y=2.3309121299774915E-10, Z=-0.9970038706538652]\n\n\n\nThe shape:\n\n\n   [junit4]   1>   shape=GeoCompositeMembershipShape: {[GeoConvexPolygon: {planetmodel=PlanetModel.WGS84, points=[\n   [lat=1.079437865394857, lon=-1.720224083538152E-11([X=0.47111944719262044, Y=-8.104310192839264E-12, Z=0.8803759987367299])], \n   [lat=-1.5707963267948966, lon=0.017453291479645996([X=6.108601474971234E-17, Y=1.066260290095308E-18, Z=-0.997762292022105])], \n   [lat=0.017453291479645996, lon=2.4457272005608357E-47([X=1.0009653513901666, Y=2.448088186713865E-47, Z=0.01747191415779267])]], internalEdges={2}},\n   GeoConvexPolygon: {planetmodel=PlanetModel.WGS84, points=[\n   [lat=1.079437865394857, lon=-1.720224083538152E-11([X=0.47111944719262044, Y=-8.104310192839264E-12, Z=0.8803759987367299])], \n   [lat=0.017453291479645996, lon=2.4457272005608357E-47([X=1.0009653513901666, Y=2.448088186713865E-47, Z=0.01747191415779267])], \n   [lat=0.0884233366943164, lon=0.4323234231678824([X=0.9054355304510789, Y=0.4178006803188124, Z=0.08840463683725623])]], internalEdges={0}}]}\n\n\n\nThe computed bounds:\n\n\n   [junit4]   1>   bounds=XYZBounds: [xmin=-0.017533380657829275 xmax=1.0011188549924792 ymin=-1.0172214856320074E-9 ymax=0.4178006813199529 zmin=-0.9977622930221051 zmax=0.9977622930221051]\n\n\n\nWorthy of note: The first convex polygon is essentially coplanar.  There's special code that I introduced recently for computing bounds for extremely acute plane intersections but it's not apparently working in polygons.  I would expect that that is the problem.  Here's the code:\n\n\n    // Add planes with membership.\n    for (final SidedPlane edge : edges) {\n      bounds.addPlane(planetModel, edge, eitherBounds.get(edge));\n      final Membership m = intersectionBounds.get(edge);\n      if (m != null) {\n        bounds.addIntersection(planetModel, edgePlanes.get(edge), edge, m);\n      }\n    }\n\n\n "
        },
        {
            "id": "comment-15436754",
            "author": "Karl Wright",
            "date": "2016-08-25T12:26:11+0000",
            "content": "Boiled this down to a test case that fails:\n\n\n  @Test\n  public void testPolygonFailureCase2() {\n    /*\n   [junit4]   1>   shape=GeoCompositeMembershipShape: {[GeoConvexPolygon: {planetmodel=PlanetModel.WGS84, points=[\n   [lat=1.079437865394857, lon=-1.720224083538152E-11([X=0.47111944719262044, Y=-8.104310192839264E-12, Z=0.8803759987367299])], \n   [lat=-1.5707963267948966, lon=0.017453291479645996([X=6.108601474971234E-17, Y=1.066260290095308E-18, Z=-0.997762292022105])], \n   [lat=0.017453291479645996, lon=2.4457272005608357E-47([X=1.0009653513901666, Y=2.448088186713865E-47, Z=0.01747191415779267])]], internalEdges={2}},\n   GeoConvexPolygon: {planetmodel=PlanetModel.WGS84, points=[\n   [lat=1.079437865394857, lon=-1.720224083538152E-11([X=0.47111944719262044, Y=-8.104310192839264E-12, Z=0.8803759987367299])], \n   [lat=0.017453291479645996, lon=2.4457272005608357E-47([X=1.0009653513901666, Y=2.448088186713865E-47, Z=0.01747191415779267])], \n   [lat=0.0884233366943164, lon=0.4323234231678824([X=0.9054355304510789, Y=0.4178006803188124, Z=0.08840463683725623])]], internalEdges={0}}]}\n    */\n    final List<GeoPoint> poly1List = new ArrayList<>();\n    poly1List.add(new GeoPoint(PlanetModel.WGS84, 1.079437865394857, -1.720224083538152E-11));\n    poly1List.add(new GeoPoint(PlanetModel.WGS84, -1.5707963267948966, 0.017453291479645996));\n    poly1List.add(new GeoPoint(PlanetModel.WGS84, 0.017453291479645996, 2.4457272005608357E-47));\n    \n    final GeoConvexPolygon poly1 = new GeoConvexPolygon(PlanetModel.WGS84, poly1List);\n    \n    /*\n   [junit4]   1>       unquantized=[lat=-1.5316724989005415, lon=3.141592653589793([X=-0.03902652216795768, Y=4.779370545484258E-18, Z=-0.9970038705813589])]\n   [junit4]   1>       quantized=[X=-0.03902652216283731, Y=2.3309121299774915E-10, Z=-0.9970038706538652]\n    */\n    \n    final GeoPoint point = new GeoPoint(PlanetModel.WGS84, -1.5316724989005415, 3.141592653589793);\n\n    assertTrue(poly1.isWithin(point));\n    \n    final XYZBounds actualBounds1 = new XYZBounds();\n    poly1.getBounds(actualBounds1);\n    \n    final XYZSolid solid = XYZSolidFactory.makeXYZSolid(PlanetModel.WGS84,\n      actualBounds1.getMinimumX(), actualBounds1.getMaximumX(),\n      actualBounds1.getMinimumY(), actualBounds1.getMaximumY(),\n      actualBounds1.getMinimumZ(), actualBounds1.getMaximumZ());\n\n    assertTrue(solid.isWithin(point));\n  }\n\n "
        },
        {
            "id": "comment-15437811",
            "author": "ASF subversion and git services",
            "date": "2016-08-25T22:10:53+0000",
            "content": "Commit 884aa1609a72e273307a93a6a07f181eab25faad in lucene-solr's branch refs/heads/master from Karl Wright\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=884aa16 ]\n\nLUCENE-7424: GeoPolygon computation of intersection bounds was incorrect. "
        },
        {
            "id": "comment-15437816",
            "author": "ASF subversion and git services",
            "date": "2016-08-25T22:12:58+0000",
            "content": "Commit 6242717a29ceee9d774c07970d97603384599218 in lucene-solr's branch refs/heads/branch_6x from Karl Wright\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6242717 ]\n\nLUCENE-7424: GeoPolygon computation of intersection bounds was incorrect. "
        }
    ]
}