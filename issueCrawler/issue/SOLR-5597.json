{
    "id": "SOLR-5597",
    "title": "ClassCastException occurs when importing CLOB-fields using SqlEntityProcessor and SortedMapBackedCache",
    "details": {
        "affect_versions": "4.6",
        "status": "Open",
        "fix_versions": [],
        "components": [
            "contrib - DataImportHandler"
        ],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Unresolved"
    },
    "description": "Using the SqlEntityProcessor with the SortedMapBackedCache as cache implementation, gives the following ClassCastException when trying to import a field of type oracle.sql.CLOB.\n\n2014-01-02 09:32:19,143 [ERROR] [Thread-54] Exception in entity : <field-name>:java.lang.ClassCastException: oracle.sql.CLOB cannot be cast to java.lang.Comparable\n        at java.util.TreeMap.getEntry(TreeMap.java:325)\n        at java.util.TreeMap.get(TreeMap.java:255)\n        at org.apache.solr.handler.dataimport.SortedMapBackedCache.add(SortedMapBackedCache.java:61)\n        at org.apache.solr.handler.dataimport.DIHCacheSupport.populateCache(DIHCacheSupport.java:124)\n        at org.apache.solr.handler.dataimport.DIHCacheSupport.getSimpleCacheData(DIHCacheSupport.java:199)\n        at org.apache.solr.handler.dataimport.DIHCacheSupport.getCacheData(DIHCacheSupport.java:147)\n        at org.apache.solr.handler.dataimport.EntityProcessorBase.getNext(EntityProcessorBase.java:129)\n        at org.apache.solr.handler.dataimport.SqlEntityProcessor.nextRow(SqlEntityProcessor.java:75)\n        at org.apache.solr.handler.dataimport.EntityProcessorWrapper.nextRow(EntityProcessorWrapper.java:243)\n        at org.apache.solr.handler.dataimport.DocBuilder.buildDocument(DocBuilder.java:469)\n        at org.apache.solr.handler.dataimport.DocBuilder.buildDocument(DocBuilder.java:495)\n        at org.apache.solr.handler.dataimport.DocBuilder.buildDocument(DocBuilder.java:408)\n        at org.apache.solr.handler.dataimport.DocBuilder.doFullDump(DocBuilder.java:323)\n        at org.apache.solr.handler.dataimport.DocBuilder.execute(DocBuilder.java:231)\n        at org.apache.solr.handler.dataimport.DataImporter.doFullImport(DataImporter.java:411)\n        at org.apache.solr.handler.dataimport.DataImporter.runCmd(DataImporter.java:476)\n        at org.apache.solr.handler.dataimport.DataImporter$1.run(DataImporter.java:457)\n\u2013 org.apache.solr.handler.dataimport.EntityProcessorWrapper\n\nIt seems that this occurs because the SortedMapBackedCache uses a java.util.TreeMap as the underlying cache, and TreeMap requires that all elements implements the java.lang.Comparable interface. However oracle.sql.CLOB does not implement Comparable and the import fails when the TreeMap implementation tries to cast the element to a Comparable (this occurs on line 325 in TreeMap.java - java version 1.6.0_33).",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "author": "Gunnlaugur Thor Briem",
            "id": "comment-13900283",
            "date": "2014-02-13T12:37:39+0000",
            "content": "Same error occurs with a field of type integer. I suggest changing title to \u201cDataImportHandler fails if integer column used as key or value in cache\u201d. I'm working around this by casting all columns involved to TEXT:\n\n\n<entity name=\"parent\" dataSource=\"d\" query=\"SELECT id, xyz, child_id::TEXT FROM parent;\">\n  <entity name=\"child\" dataSource=\"d\" query=\"SELECT id::TEXT, abc FROM child;\"\n          processor=\"CachedSqlEntityProcessor\"\n          where=\"id=par.child_id\"/>\n</entity>\n\n\n\n(As the use of the legacy CachedSqlEntityProcessor suggests, I encountered this while trying an upgrade from Solr 3.5, where integer columns were working.)\n\nThe stack trace I got:\n\n\n8233662 [Thread-23] ERROR org.apache.solr.handler.dataimport.DataImporter  ? Full Import failed:java.lang.RuntimeException: java.lang.RuntimeException: org.apache.solr.handler.dataimport.DataImportHandlerException: java.lang.ClassCastException: java.lang.String cannot be cast to java.lang.Integer\n\tat org.apache.solr.handler.dataimport.DocBuilder.execute(DocBuilder.java:270)\n\tat org.apache.solr.handler.dataimport.DataImporter.doFullImport(DataImporter.java:411)\n\tat org.apache.solr.handler.dataimport.DataImporter.runCmd(DataImporter.java:476)\n\tat org.apache.solr.handler.dataimport.DataImporter$1.run(DataImporter.java:457)\nCaused by: java.lang.RuntimeException: org.apache.solr.handler.dataimport.DataImportHandlerException: java.lang.ClassCastException: java.lang.String cannot be cast to java.lang.Integer\n\tat org.apache.solr.handler.dataimport.DocBuilder.buildDocument(DocBuilder.java:410)\n\tat org.apache.solr.handler.dataimport.DocBuilder.doFullDump(DocBuilder.java:323)\n\tat org.apache.solr.handler.dataimport.DocBuilder.execute(DocBuilder.java:231)\n\t... 3 more\nCaused by: org.apache.solr.handler.dataimport.DataImportHandlerException: java.lang.ClassCastException: java.lang.String cannot be cast to java.lang.Integer\n\tat org.apache.solr.handler.dataimport.DataImportHandlerException.wrapAndThrow(DataImportHandlerException.java:63)\n\tat org.apache.solr.handler.dataimport.EntityProcessorWrapper.nextRow(EntityProcessorWrapper.java:246)\n\tat org.apache.solr.handler.dataimport.DocBuilder.buildDocument(DocBuilder.java:469)\n\tat org.apache.solr.handler.dataimport.DocBuilder.buildDocument(DocBuilder.java:495)\n\tat org.apache.solr.handler.dataimport.DocBuilder.buildDocument(DocBuilder.java:408)\n\t... 5 more\nCaused by: java.lang.ClassCastException: java.lang.String cannot be cast to java.lang.Integer\n\tat java.lang.Integer.compareTo(Integer.java:37)\n\tat java.util.TreeMap.getEntry(TreeMap.java:328)\n\tat java.util.TreeMap.get(TreeMap.java:255)\n\tat org.apache.solr.handler.dataimport.SortedMapBackedCache.iterator(SortedMapBackedCache.java:147)\n\tat org.apache.solr.handler.dataimport.DIHCacheSupport.getIdCacheData(DIHCacheSupport.java:179)\n\tat org.apache.solr.handler.dataimport.DIHCacheSupport.getCacheData(DIHCacheSupport.java:145)\n\tat org.apache.solr.handler.dataimport.EntityProcessorBase.getNext(EntityProcessorBase.java:129)\n\tat org.apache.solr.handler.dataimport.SqlEntityProcessor.nextRow(SqlEntityProcessor.java:75)\n\tat org.apache.solr.handler.dataimport.EntityProcessorWrapper.nextRow(EntityProcessorWrapper.java:243)\n\t... 8 more\n\n "
        }
    ]
}