{
    "id": "SOLR-11876",
    "title": "InPlace update fails when resolving from Tlog if schema has a required field",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "7.2",
        "resolution": "Unresolved",
        "status": "Patch Available"
    },
    "description": "The situation is doing an in place update of a non-indexed/stored numeric doc values field multiple times in fast succession. The schema \nhas a required field (\"name\") in it. On the third update request the update fails complaining \"missing required field: name\". It seems this happens \nwhen the update document is being resolved from from the TLog.\n\nTo reproduce:\n\n1. Setup a schema that has:\n\n\u00a0 \u00a0 - A required field other than the uniquekey field, in my case it's called \"name\"\n\u00a0 \u00a0 - A numeric doc values field suitable for in place update (non-indexed, non-stored), in my case it's\u00a0called \"likes\"\n\n2. Execute an in place update of the document a few times in fast succession:\n\nfor i in `seq 10`; do\ncurl -X POST -H 'Content-Type: application/json' 'http://localhost:8983/solr/core1/update' --data-binary '\n[{\n \"id\": \"1\",\n \"likes\": { \"inc\": 1 }\n}]'\ndone\n\nThe resulting stack trace:\n\n2018-01-19 21:27:26.644 ERROR (qtp1873653341-14) [ x:core1] o.a.s.h.RequestHandlerBase org.apache.solr.common.SolrException: [doc=1] missing required field: name\n at org.apache.solr.update.DocumentBuilder.toDocument(DocumentBuilder.java:233)\n at org.apache.solr.handler.component.RealTimeGetComponent.toSolrDoc(RealTimeGetComponent.java:767)\n at org.apache.solr.handler.component.RealTimeGetComponent.resolveFullDocument(RealTimeGetComponent.java:423)\n at org.apache.solr.handler.component.RealTimeGetComponent.getInputDocumentFromTlog(RealTimeGetComponent.java:551)\n at org.apache.solr.handler.component.RealTimeGetComponent.getInputDocument(RealTimeGetComponent.java:609)\n at org.apache.solr.update.processor.AtomicUpdateDocumentMerger.doInPlaceUpdateMerge(AtomicUpdateDocumentMerger.java:253)\n at org.apache.solr.update.processor.DistributedUpdateProcessor.getUpdatedDocument(DistributedUpdateProcessor.java:1279)\n at org.apache.solr.update.processor.DistributedUpdateProcessor.versionAdd(DistributedUpdateProcessor.java:1008)\n at org.apache.solr.update.processor.DistributedUpdateProcessor.processAdd(DistributedUpdateProcessor.java:617)\n at org.apache.solr.update.processor.LogUpdateProcessorFactory$LogUpdateProcessor.processAdd(LogUpdateProcessorFactory.java:103)\n at org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n at org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:118)\n at org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n at org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:118)\n at org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n at org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:118)\n at org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n at org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:118)\n at org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n at org.apache.solr.update.processor.FieldNameMutatingUpdateProcessorFactory$1.processAdd(FieldNameMutatingUpdateProcessorFactory.java:75)\n at org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n at org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:118)\n at org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n at org.apache.solr.update.processor.AbstractDefaultValueUpdateProcessorFactory$DefaultValueUpdateProcessor.processAdd(AbstractDefaultValueUpdateProcessorFactory.java:92)\n at org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.handleAdds(JsonLoader.java:501)\n at org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.processUpdate(JsonLoader.java:145)\n at org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.load(JsonLoader.java:121)\n at org.apache.solr.handler.loader.JsonLoader.load(JsonLoader.java:84)\n at org.apache.solr.handler.UpdateRequestHandler$1.load(UpdateRequestHandler.java:97)\n at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:68)\n at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:177)\n at org.apache.solr.core.SolrCore.execute(SolrCore.java:2503)\n at org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:711)\n at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:517)\n at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:380)\n at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:326)\n at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1629)\n at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:533)\n at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\n at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\n at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\n at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:190)\n at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1595)\n at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:188)\n at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1253)\n at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:168)\n at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:473)\n at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1564)\n at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:166)\n at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1155)\n at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:219)\n at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)\n at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\n at org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:335)\n at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\n at org.eclipse.jetty.server.Server.handle(Server.java:530)\n at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:347)\n at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:256)\n at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:279)\n at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:102)\n at org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:124)\n at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:247)\n at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.produce(EatWhatYouKill.java:140)\n at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:131)\n at org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:382)\n at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:708)\n at org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:626)\n at java.lang.Thread.run(Thread.java:748)",
    "attachments": {
        "SOLR-11876.patch": "https://issues.apache.org/jira/secure/attachment/12906893/SOLR-11876.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2018-01-19T21:50:33+0000",
            "content": "I've attached my attempt at a patch for the issue, with a test case that reproduces the problem (TestInPlaceUpdatesRequiredField). The idea/approach was to try to pass through inPlaceUpdate as true into DocumentBuilder.toDocument when appropriate. It's my first Solr patch so my apologies if I am way off. I ran all the unit tests with the patch applied and everything passed.\u00a0 ",
            "author": "Justin Deoliveira",
            "id": "comment-16332930"
        },
        {
            "date": "2018-02-08T18:37:41+0000",
            "content": "Ishan Chattopadhyaya\u00a0: Apologies for the direct poke but as the mastermind of the recent work for inplace updates I was wondering if you had any thoughts on this patch?\u00a0 ",
            "author": "Justin Deoliveira",
            "id": "comment-16357378"
        },
        {
            "date": "2018-03-22T19:39:40+0000",
            "content": "\n\n\n  -1 overall \n\n\n\n\n\n\n\n\n\n Vote \n Subsystem \n Runtime \n Comment \n\n\n\u00a0\n\u00a0\n\u00a0\n  Prechecks  \n\n\n +1 \n  test4tests  \n   0m  0s \n  The patch appears to include 1 new or modified test files.  \n\n\n\u00a0\n\u00a0\n\u00a0\n  master Compile Tests  \n\n\n +1 \n  compile  \n   1m 23s \n  master passed  \n\n\n\u00a0\n\u00a0\n\u00a0\n  Patch Compile Tests  \n\n\n +1 \n  compile  \n   1m 15s \n  the patch passed  \n\n\n +1 \n  javac  \n   1m 15s \n  the patch passed  \n\n\n +1 \n  Release audit (RAT)  \n   1m 15s \n  the patch passed  \n\n\n +1 \n  Check forbidden APIs  \n   1m 15s \n  the patch passed  \n\n\n +1 \n  Validate source patterns  \n   1m 15s \n  the patch passed  \n\n\n\u00a0\n\u00a0\n\u00a0\n  Other Tests  \n\n\n -1 \n  unit  \n  49m  5s \n  core in the patch failed.  \n\n\n  \n   \n  54m  0s \n   \n\n\n\n\n\n\n\n\n\n Reason \n Tests \n\n\n Failed junit tests \n solr.update.processor.AtomicUpdateProcessorFactoryTest \n\n\n\n\n\n\n\n\n\n Subsystem \n Report/Notes \n\n\n JIRA Issue \n SOLR-11876 \n\n\n JIRA Patch URL \n https://issues.apache.org/jira/secure/attachment/12906893/SOLR-11876.patch \n\n\n Optional Tests \n  compile  javac  unit  ratsources  checkforbiddenapis  validatesourcepatterns  \n\n\n uname \n Linux lucene1-us-west 3.13.0-88-generic #135-Ubuntu SMP Wed Jun 8 21:10:42 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux \n\n\n Build tool \n ant \n\n\n Personality \n /home/jenkins/jenkins-slave/workspace/PreCommit-SOLR-Build/sourcedir/dev-tools/test-patch/lucene-solr-yetus-personality.sh \n\n\n git revision \n master / ea12b5f \n\n\n ant \n version: Apache Ant(TM) version 1.9.3 compiled on April 8 2014 \n\n\n Default Java \n 1.8.0_144 \n\n\n unit \n https://builds.apache.org/job/PreCommit-SOLR-Build/11/artifact/out/patch-unit-solr_core.txt \n\n\n  Test Results \n https://builds.apache.org/job/PreCommit-SOLR-Build/11/testReport/ \n\n\n modules \n C: solr/core U: solr/core \n\n\n Console output \n https://builds.apache.org/job/PreCommit-SOLR-Build/11/console \n\n\n Powered by \n Apache Yetus 0.7.0   http://yetus.apache.org \n\n\n\n\n\n\nThis message was automatically generated.\n ",
            "author": "Lucene/Solr QA",
            "id": "comment-16410174"
        }
    ]
}