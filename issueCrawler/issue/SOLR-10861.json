{
    "id": "SOLR-10861",
    "title": "Stream query on empty core throws IOException",
    "details": {
        "labels": "",
        "priority": "Minor",
        "components": [
            "search"
        ],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "5.5.1",
        "resolution": "Unresolved",
        "status": "Open"
    },
    "description": "When attempting to perform a stream query on an empty (no documents) Solr core, an IOException is thrown instead of returning an empty result set.\n\nFor example, only a newly created Solr core (core_1), I can curl:\n\ncurl --data-urlencode 'stream=search(core_1,q=\"*:*\",qt=\"/export\",fl=\"DocumentVersionIdDocValue\",sort=\"DocumentVersionIdDocValue asc\",fq=\"SolrDocumentType:Document\")' http://localhost:8085/solr/core_1/stream\n\n\n\nand the result is:\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<response>\n<lst name=\"error\"><str name=\"msg\">java.util.concurrent.ExecutionException: java.io.IOException: JSONTupleStream: expected OBJECT_START but got STRING</str><str name=\"trace\">java.io.IOException: java.util.concurrent.ExecutionException: java.io.IOException: JSONTupleStream: expected OBJECT_START but got STRING\n\tat org.apache.solr.client.solrj.io.stream.CloudSolrStream.openStreams(CloudSolrStream.java:332)\n\tat org.apache.solr.client.solrj.io.stream.CloudSolrStream.open(CloudSolrStream.java:231)\n\tat org.apache.solr.response.TextResponseWriter.writeTupleStream(TextResponseWriter.java:300)\n\tat org.apache.solr.response.TextResponseWriter.writeVal(TextResponseWriter.java:169)\n\tat org.apache.solr.response.XMLWriter.writeResponse(XMLWriter.java:113)\n\tat org.apache.solr.response.XMLResponseWriter.write(XMLResponseWriter.java:39)\n\tat org.apache.solr.response.QueryResponseWriterUtil.writeQueryResponse(QueryResponseWriterUtil.java:52)\n\tat org.apache.solr.servlet.HttpSolrCall.writeResponse(HttpSolrCall.java:728)\n\tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:469)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:257)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:208)\n\tat veeva.ecm.common.interfaces.web.SolrDispatchOverride.doFilter(SolrDispatchOverride.java:43)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:213)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:94)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:141)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:79)\n\tat org.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:620)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:88)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:502)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1104)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:684)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1519)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1475)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n\tat java.lang.Thread.run(Thread.java:745)\nCaused by: java.util.concurrent.ExecutionException: java.io.IOException: JSONTupleStream: expected OBJECT_START but got STRING\n\tat java.util.concurrent.FutureTask.report(FutureTask.java:122)\n\tat java.util.concurrent.FutureTask.get(FutureTask.java:192)\n\tat org.apache.solr.client.solrj.io.stream.CloudSolrStream.openStreams(CloudSolrStream.java:326)\n\t... 28 more\nCaused by: java.io.IOException: JSONTupleStream: expected OBJECT_START but got STRING\n\tat org.apache.solr.client.solrj.io.stream.JSONTupleStream.expect(JSONTupleStream.java:98)\n\tat org.apache.solr.client.solrj.io.stream.JSONTupleStream.advanceToDocs(JSONTupleStream.java:156)\n\tat org.apache.solr.client.solrj.io.stream.JSONTupleStream.next(JSONTupleStream.java:76)\n\tat org.apache.solr.client.solrj.io.stream.SolrStream.read(SolrStream.java:147)\n\tat org.apache.solr.client.solrj.io.stream.CloudSolrStream$TupleWrapper.next(CloudSolrStream.java:413)\n\tat org.apache.solr.client.solrj.io.stream.CloudSolrStream$StreamOpener.call(CloudSolrStream.java:436)\n\tat org.apache.solr.client.solrj.io.stream.CloudSolrStream$StreamOpener.call(CloudSolrStream.java:423)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n\tat org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor$1.run(ExecutorUtil.java:231)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\t... 1 more\n</str><int name=\"code\">500</int></lst>\n</response>\n\n\n\nAnd the Solr log contains:\n\nERROR org.apache.solr.servlet.HttpSolrCall - null:java.io.IOException: org.apache.solr.search.SyntaxError: xport RankQuery is required for xsort: rq={!xport}\n\tat org.apache.solr.response.SortingResponseWriter.write(SortingResponseWriter.java:101)\n\tat org.apache.solr.response.QueryResponseWriterUtil.writeQueryResponse(QueryResponseWriterUtil.java:52)\n\tat org.apache.solr.servlet.HttpSolrCall.writeResponse(HttpSolrCall.java:728)\n\tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:469)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:257)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:208)\n\tat veeva.ecm.common.interfaces.web.SolrDispatchOverride.doFilter(SolrDispatchOverride.java:43)\n\tat org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)\n\tat org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)\n\tat org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:213)\n\tat org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:94)\n\tat org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:141)\n\tat org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:79)\n\tat org.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:620)\n\tat org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:88)\n\tat org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:502)\n\tat org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1104)\n\tat org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:684)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1519)\n\tat org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1475)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)\n\tat java.lang.Thread.run(Thread.java:745)\nCaused by: org.apache.solr.search.SyntaxError: xport RankQuery is required for xsort: rq={!xport}\n\t... 24 more\n\n\n\n\nIndexing a single document and running the same curl command above returns the expected response:\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<response>\n<lst name=\"responseHeader\"><int name=\"status\">0</int><int name=\"QTime\">0</int></lst><result name=\"response\" numFound=\"-1\" start=\"-1\"><lst><bool name=\"EOF\">true</bool></lst></result>\n</response>",
    "attachments": {},
    "issue_links": {},
    "comments": []
}