{
    "id": "SOLR-12783",
    "title": "Slow queries log print status [-1] for potentially 500 error code",
    "details": {
        "type": "Bug",
        "status": "Patch Available",
        "labels": "",
        "fix_versions": [],
        "components": [],
        "priority": "Major",
        "resolution": "Unresolved",
        "affect_versions": "master (8.0)"
    },
    "description": "For slow queries on update/select handler, we receive status -1 at\u00a0number\u00a0of occasions;\n\nWARN - 2018-09-17 17:37:16.683; org.apache.solr.core.SolrCore; slow: [collection_shard2_replica0] webapp=/solr path=/update params={wt=javabin&version=2} status=-1 QTime=61066\nERROR - 2018-09-17 17:37:16.683; org.apache.solr.common.SolrException; null:org.apache.solr.update.processor.DistributedUpdateProcessor$DistributedUpdatesAsyncException: Async exception during distribute\nd update: Read timed out\nat org.apache.solr.update.processor.DistributedUpdateProcessor.doFinish(DistributedUpdateProcessor.java:972)\nat org.apache.solr.update.processor.DistributedUpdateProcessor.finish(DistributedUpdateProcessor.java:1911)\nat org.apache.solr.update.processor.UpdateRequestProcessor.finish(UpdateRequestProcessor.java:80)\nat org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:78)\nat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:173)\nat org.apache.solr.core.SolrCore.execute(SolrCore.java:2477)\nat org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:723)\nat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:529)\nat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:361)\nat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:305)\nat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1691)\nat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:582)\nat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\nat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\nat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:226)\nat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1180)\nat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:512)\nat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\nat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1112)\nat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\nat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)\nat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:119)\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)\nat org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:335)\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)\nat org.eclipse.jetty.server.Server.handle(Server.java:534)\nat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:320)\nat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:251)\nat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:273)\nat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:95)\nat org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)\nat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.executeProduceConsume(ExecuteProduceConsume.java:303)\nat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceConsume(ExecuteProduceConsume.java:148)\nat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:136)\nat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:671)\nat org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:589)\nat java.lang.Thread.run(Thread.java:745)\n\nWARN - 2018-09-17 17:37:16.683; org.apache.solr.servlet.ResponseUtils; invalid return code: -1\n\nstatusCode -1 doesn't\u00a0indicate anything; and appropriate HTTP response code will be better.",
    "attachments": {
        "SOLR-12783.patch": "https://issues.apache.org/jira/secure/attachment/12940460/SOLR-12783.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "id": "comment-16619768",
            "content": "Looking into the code;\n\nSolrCmdDistributor :\u00a0\n\npublic static class Error {\n  public Exception e;\n  public int statusCode = -1;\n\n\nDistributedUpdateProcessor :\n\n/** Helper method for constructor */\nprivate static int buildCode(List<Error> errors) {\n  assert null != errors;\n  assert 0 < errors.size();\n\n  int minCode = Integer.MAX_VALUE;\n  int maxCode = Integer.MIN_VALUE;\n  for (Error error : errors) {\n    log.trace(\"REMOTE ERROR: {}\", error);\n    minCode = Math.min(error.statusCode, minCode);\n    maxCode = Math.max(error.statusCode, maxCode);\n  }\n  if (minCode == maxCode) {\n    // all codes are consistent, use that...\n    return minCode;\n  } else if (400 <= minCode && maxCode < 500) {\n    // all codes are 4xx, use 400\n    return ErrorCode.BAD_REQUEST.code;\n  } \n  // ...otherwise use sensible default\n  return ErrorCode.SERVER_ERROR.code;\n}\n\n\n\nis where the inappropriate response codes are set. ",
            "author": "Amrit Sarkar",
            "date": "2018-09-18T21:41:04+0000"
        },
        {
            "id": "comment-16620984",
            "content": "Attaching patch within initializing statusCode to be 500, all test pass. ",
            "author": "Amrit Sarkar",
            "date": "2018-09-19T18:09:41+0000"
        },
        {
            "id": "comment-16623089",
            "content": "\n\n\n  -1 overall \n\n\n\n\n\n\n\n\n\n Vote \n Subsystem \n Runtime \n Comment \n\n\n\u00a0\n\u00a0\n\u00a0\n  Prechecks  \n\n\n -1 \n  test4tests  \n   0m  0s \n  The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch.  \n\n\n\u00a0\n\u00a0\n\u00a0\n  master Compile Tests  \n\n\n +1 \n  compile  \n   2m 20s \n  master passed  \n\n\n\u00a0\n\u00a0\n\u00a0\n  Patch Compile Tests  \n\n\n +1 \n  compile  \n   3m 25s \n  the patch passed  \n\n\n +1 \n  javac  \n   3m 25s \n  the patch passed  \n\n\n +1 \n  Release audit (RAT)  \n   3m 25s \n  the patch passed  \n\n\n +1 \n  Check forbidden APIs  \n   3m 25s \n  the patch passed  \n\n\n +1 \n  Validate source patterns  \n   3m 25s \n  the patch passed  \n\n\n\u00a0\n\u00a0\n\u00a0\n  Other Tests  \n\n\n -1 \n  unit  \n  88m 59s \n  core in the patch failed.  \n\n\n  \n   \n  99m 49s \n   \n\n\n\n\n\n\n\n\n\n Reason \n Tests \n\n\n Failed junit tests \n solr.cloud.DeleteStatusTest \n\n\n\u00a0\n solr.cloud.autoscaling.sim.TestSimTriggerIntegration \n\n\n\u00a0\n solr.cloud.autoscaling.sim.TestSimLargeCluster \n\n\n\n\n\n\n\n\n\n Subsystem \n Report/Notes \n\n\n JIRA Issue \n SOLR-12783 \n\n\n JIRA Patch URL \n https://issues.apache.org/jira/secure/attachment/12940460/SOLR-12783.patch \n\n\n Optional Tests \n  compile  javac  unit  ratsources  checkforbiddenapis  validatesourcepatterns  \n\n\n uname \n Linux lucene2-us-west.apache.org 4.4.0-112-generic #135-Ubuntu SMP Fri Jan 19 11:48:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux \n\n\n Build tool \n ant \n\n\n Personality \n /home/jenkins/jenkins-slave/workspace/PreCommit-SOLR-Build/sourcedir/dev-tools/test-patch/lucene-solr-yetus-personality.sh \n\n\n git revision \n master / 1d604d1 \n\n\n ant \n version: Apache Ant(TM) version 1.9.6 compiled on July 20 2018 \n\n\n Default Java \n 1.8.0_172 \n\n\n unit \n https://builds.apache.org/job/PreCommit-SOLR-Build/182/artifact/out/patch-unit-solr_core.txt \n\n\n  Test Results \n https://builds.apache.org/job/PreCommit-SOLR-Build/182/testReport/ \n\n\n modules \n C: solr/core U: solr/core \n\n\n Console output \n https://builds.apache.org/job/PreCommit-SOLR-Build/182/console \n\n\n Powered by \n Apache Yetus 0.7.0   http://yetus.apache.org \n\n\n\n\n\n\nThis message was automatically generated.\n ",
            "author": "Lucene/Solr QA",
            "date": "2018-09-21T05:24:29+0000"
        }
    ]
}