{
    "id": "SOLR-7721",
    "title": "When using group.facet=true there are duplicate facets returned",
    "details": {
        "components": [
            "Facet Module",
            "faceting"
        ],
        "type": "Bug",
        "labels": "",
        "fix_versions": [],
        "affect_versions": "4.10.4",
        "status": "Open",
        "resolution": "Unresolved",
        "priority": "Major"
    },
    "description": "I have the below schema, and I indexed documents with float fields\nschema.xml\n <field name=\"SKU\" type=\"string\" indexed=\"true\" stored=\"true\" multiValued=\"false\"/>\n <field name=\"ProductID\" type=\"string\" indexed=\"true\" stored=\"true\" multiValued=\"false\"/>\n<field name=\"NormalizedAverageReview\" type=\"tfloat\" default=\"0.0\" indexed=\"true\" stored=\"false\" multiValued=\"false\"/>\n\n\n\nAfterwards I add the following documents:\n\n\n<doc>\n    <field name=\"SKU\">P1SKU00</field>\n    <field name=\"ProductID\">P1</field>\n    <field name=\"NormalizedAverageReview\">0.0</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P1SKU05</field>\n    <field name=\"ProductID\">P1</field>\n    <field name=\"NormalizedAverageReview\">0.5</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P1SKU10</field>\n    <field name=\"ProductID\">P1</field>\n    <field name=\"NormalizedAverageReview\">1.0</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P1SKU15</field>\n    <field name=\"ProductID\">P1</field>\n    <field name=\"NormalizedAverageReview\">1.5</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P1SKU20</field>\n    <field name=\"ProductID\">P1</field>\n    <field name=\"NormalizedAverageReview\">2.0</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P1SKU25</field>\n    <field name=\"ProductID\">P1</field>\n    <field name=\"NormalizedAverageReview\">2.5</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P1SKU30</field>\n    <field name=\"ProductID\">P1</field>\n    <field name=\"NormalizedAverageReview\">3.0</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P1SKU35</field>\n    <field name=\"ProductID\">P1</field>\n    <field name=\"NormalizedAverageReview\">3.5</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P2SKU05</field>\n    <field name=\"ProductID\">P2</field>\n    <field name=\"NormalizedAverageReview\">0.5</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P2SKU15</field>\n    <field name=\"ProductID\">P2</field>\n    <field name=\"NormalizedAverageReview\">1.5</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P2SKU25</field>\n    <field name=\"ProductID\">P2</field>\n    <field name=\"NormalizedAverageReview\">2.5</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P2SKU35</field>\n    <field name=\"ProductID\">P2</field>\n    <field name=\"NormalizedAverageReview\">3.5</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P3SKU00</field>\n    <field name=\"ProductID\">P3</field>\n    <field name=\"NormalizedAverageReview\">0.0</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P3SKU10</field>\n    <field name=\"ProductID\">P3</field>\n    <field name=\"NormalizedAverageReview\">1.0</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P3SKU20</field>\n    <field name=\"ProductID\">P3</field>\n    <field name=\"NormalizedAverageReview\">2.0</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P3SKU30</field>\n    <field name=\"ProductID\">P3</field>\n    <field name=\"NormalizedAverageReview\">3.0</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P4SKU45</field>\n    <field name=\"ProductID\">P4</field>\n    <field name=\"NormalizedAverageReview\">4.5</field>\n</doc>\n<doc>\n    <field name=\"SKU\">P4SKU50</field>\n    <field name=\"ProductID\">P4</field>\n    <field name=\"NormalizedAverageReview\">5.0</field>\n</doc>\n\n\n\nAfter performing the following query\nhttp://localhost:8983/solr/collection1/select?q=ProductID:P1&wt=json&indent=true&facet=true&facet.field=NormalizedAverageReview&group=true&group.field=ProductID&group.ngroups=true&group.facet=true&group.limit=-1&indent=true\n\nThere are duplicate facets returned\nResponse\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":41,\n    \"params\":{\n      \"q\":\"ProductID:P1\",\n      \"facet.field\":\"NormalizedAverageReview\",\n      \"indent\":[\"true\",\n        \"true\"],\n      \"group.limit\":\"-1\",\n      \"group.facet\":\"true\",\n      \"group.ngroups\":\"true\",\n      \"wt\":\"json\",\n      \"facet\":\"true\",\n      \"group.field\":\"ProductID\",\n      \"group\":\"true\"}},\n  \"grouped\":{\n    \"ProductID\":{\n      \"matches\":8,\n      \"ngroups\":1,\n      \"groups\":[{\n          \"groupValue\":\"P1\",\n          \"doclist\":{\"numFound\":8,\"start\":0,\"docs\":[\n              {\n                \"SKU\":\"P1SKU00\",\n                \"ProductID\":\"P1\",\n                \"_version_\":1504885971465797632,\n                \"tx_CategoryEnabled\":false},\n              {\n                \"SKU\":\"P1SKU05\",\n                \"ProductID\":\"P1\",\n                \"_version_\":1504885971547586560,\n                \"tx_CategoryEnabled\":false},\n              {\n                \"SKU\":\"P1SKU10\",\n                \"ProductID\":\"P1\",\n                \"_version_\":1504885971549683712,\n                \"tx_CategoryEnabled\":false},\n              {\n                \"SKU\":\"P1SKU15\",\n                \"ProductID\":\"P1\",\n                \"_version_\":1504885971551780864,\n                \"tx_CategoryEnabled\":false},\n              {\n                \"SKU\":\"P1SKU20\",\n                \"ProductID\":\"P1\",\n                \"_version_\":1504885971552829440,\n                \"tx_CategoryEnabled\":false},\n              {\n                \"SKU\":\"P1SKU25\",\n                \"ProductID\":\"P1\",\n                \"_version_\":1504885971554926592,\n                \"tx_CategoryEnabled\":false},\n              {\n                \"SKU\":\"P1SKU30\",\n                \"ProductID\":\"P1\",\n                \"_version_\":1504885971555975168,\n                \"tx_CategoryEnabled\":false},\n              {\n                \"SKU\":\"P1SKU35\",\n                \"ProductID\":\"P1\",\n                \"_version_\":1504885971557023744,\n                \"tx_CategoryEnabled\":false}]\n          }}]}},\n  \"facet_counts\":{\n    \"facet_queries\":{},\n    \"facet_fields\":{\n      \"NormalizedAverageReview\":[\n        \"0.0\",1,\n        \"0.5\",1,\n        \"1.0\",1,\n        \"1.5\",1,\n        \"2.0\",1,\n        \"2.5\",1,\n        \"3.0\",1,\n        \"3.5\",1,\n        \"0.0\",0,\n        \"0.5\",0,\n        \"1.0\",0,\n        \"1.5\",0,\n        \"2.0\",0,\n        \"2.5\",0,\n        \"3.0\",0,\n        \"3.5\",0,\n        \"4.5\",0,\n        \"5.0\",0,\n        \"4.5\",0]},\n    \"facet_dates\":{},\n    \"facet_ranges\":{},\n    \"facet_intervals\":{}}}\n\n\n\n\nIf you notice the facet results, there are values repeated in there. For example 4.5 has 2 values (1, 0) as do many of the values. we would expect only 1 entry per value. Seems incorrect that there are duplicates with different values.\n\nPlease advice.",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2015-07-09T15:33:53+0000",
            "author": "Erik Hatcher",
            "content": "I've just tinkered with this myself.  Switching the field type of NormalizedAverageReview to \"float\" solves it.  The issue seems to be SimpleFacets#getGroupedCounts() doesn't work properly with trie fields with non-zero precisionStep like regular faceting and sorting is able to. ",
            "id": "comment-14620689"
        }
    ]
}