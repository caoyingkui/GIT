{
    "id": "LUCENE-6974",
    "title": "TesGeoPointQuery failures: some hits were wrong (should not match but did)",
    "details": {
        "resolution": "Resolved",
        "affect_versions": "6.0",
        "components": [],
        "labels": "",
        "fix_versions": [],
        "priority": "Major",
        "status": "Resolved",
        "type": "Bug"
    },
    "description": "Reproducible failure from Policeman Jenkins http://jenkins.thetaphi.de/job/Lucene-Solr-trunk-Linux/15540/:\n\n\n   [junit4] Suite: org.apache.lucene.search.TestGeoPointQuery\n   [junit4]   1> T0: id=1 should not match but did\n   [junit4]   1>   small=true query=GeoPointInPolygonQuery: field=point: Points: [4.3475002236664295, -39.484346117824316] [4.3475002236664295, -38.95751953125] [5.824887603521347, -38.95751953125] [5.824887603521347, -39.484346117824316] [4.3475002236664295, -39.484346117824316]  docID=1\n   [junit4]   1>   lat=-38.94430998712778 lon=4.362290930002928\n   [junit4]   1>   deleted?=false\n   [junit4]   2> JAN 13, 2016 6:53:32 R? com.carrotsearch.randomizedtesting.RandomizedRunner$QueueUncaughtExceptionsHandler uncaughtException\n   [junit4]   2> WARNING: Uncaught exception in thread: Thread[T0,5,TGRP-TestGeoPointQuery]\n   [junit4]   2> java.lang.AssertionError: some hits were wrong\n   [junit4]   2> \tat __randomizedtesting.SeedInfo.seed([30950A47BB2DFA04]:0)\n   [junit4]   2> \tat org.junit.Assert.fail(Assert.java:93)\n   [junit4]   2> \tat org.apache.lucene.util.BaseGeoPointTestCase$VerifyHits.test(BaseGeoPointTestCase.java:554)\n   [junit4]   2> \tat org.apache.lucene.util.BaseGeoPointTestCase$2._run(BaseGeoPointTestCase.java:758)\n   [junit4]   2> \tat org.apache.lucene.util.BaseGeoPointTestCase$2.run(BaseGeoPointTestCase.java:625)\n   [junit4]   2> \n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestGeoPointQuery -Dtests.method=testRandomTiny -Dtests.seed=30950A47BB2DFA04 -Dtests.multiplier=3 -Dtests.slow=true -Dtests.locale=mer_KE -Dtests.timezone=America/Martinique -Dtests.asserts=true -Dtests.file.encoding=US-ASCII\n   [junit4] ERROR   0.93s J0 | TestGeoPointQuery.testRandomTiny <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase.verify(BaseGeoPointTestCase.java:772)\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase.doTestRandom(BaseGeoPointTestCase.java:411)\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase.testRandomTiny(BaseGeoPointTestCase.java:331)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:747)Throwable #2: com.carrotsearch.randomizedtesting.UncaughtExceptionError: Captured an uncaught exception in thread: Thread[id=57, name=T0, state=RUNNABLE, group=TGRP-TestGeoPointQuery]\n   [junit4]    > Caused by: java.lang.AssertionError: some hits were wrong\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([30950A47BB2DFA04]:0)\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase$VerifyHits.test(BaseGeoPointTestCase.java:554)\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase$2._run(BaseGeoPointTestCase.java:758)\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase$2.run(BaseGeoPointTestCase.java:625)\n   [junit4] IGNOR/A 0.01s J0 | TestGeoPointQuery.testRandomBig\n   [junit4]    > Assumption #1: 'nightly' test group is disabled (@Nightly())\n   [junit4] IGNOR/A 0.00s J0 | TestGeoPointQuery.testAllLatEqual\n   [junit4]    > Assumption #1: GeoPoint*Query is too slow otherwise\n   [junit4]   1> T1: id=15902 should not match but did\n   [junit4]   1>   small=true query=GeoPointInPolygonQuery: field=point: Points: [4.3475002236664295, -39.484346117824316] [4.3475002236664295, -38.95751953125] [5.824887603521347, -38.95751953125] [5.824887603521347, -39.484346117824316] [4.3475002236664295, -39.484346117824316]  docID=714\n   [junit4]   1>   lat=-38.95061678253114 lon=5.752138886600733\n   [junit4]   1>   deleted?=false\n   [junit4]   1> T1: id=16650 should not match but did\n   [junit4]   1>   small=true query=GeoPointInPolygonQuery: field=point: Points: [4.3475002236664295, -39.484346117824316] [4.3475002236664295, -38.95751953125] [5.824887603521347, -38.95751953125] [5.824887603521347, -39.484346117824316] [4.3475002236664295, -39.484346117824316]  docID=739\n   [junit4]   1>   lat=-38.94194939173758 lon=5.094362664967775\n   [junit4]   1>   deleted?=false\n   [junit4]   1> T1: id=16686 should not match but did\n   [junit4]   1>   small=true query=GeoPointInPolygonQuery: field=point: Points: [4.3475002236664295, -39.484346117824316] [4.3475002236664295, -38.95751953125] [5.824887603521347, -38.95751953125] [5.824887603521347, -39.484346117824316] [4.3475002236664295, -39.484346117824316]  docID=772\n   [junit4]   1>   lat=-38.93946030177176 lon=4.663460422307253\n   [junit4]   1>   deleted?=false\n   [junit4]   1> T1: id=16777 should not match but did\n   [junit4]   1>   small=true query=GeoPointInPolygonQuery: field=point: Points: [4.3475002236664295, -39.484346117824316] [4.3475002236664295, -38.95751953125] [5.824887603521347, -38.95751953125] [5.824887603521347, -39.484346117824316] [4.3475002236664295, -39.484346117824316]  docID=862\n   [junit4]   1>   lat=-38.93717204220593 lon=5.471643526107073\n   [junit4]   1>   deleted?=false\n   [junit4]   1> T1: id=16779 should not match but did\n   [junit4]   1>   small=true query=GeoPointInPolygonQuery: field=point: Points: [4.3475002236664295, -39.484346117824316] [4.3475002236664295, -38.95751953125] [5.824887603521347, -38.95751953125] [5.824887603521347, -39.484346117824316] [4.3475002236664295, -39.484346117824316]  docID=864\n   [junit4]   1>   lat=-38.952266089618206 lon=4.8638697154819965\n   [junit4]   1>   deleted?=false\n   [junit4]   1> T1: id=17243 should not match but did\n   [junit4]   1>   small=true query=GeoPointInPolygonQuery: field=point: Points: [4.3475002236664295, -39.484346117824316] [4.3475002236664295, -38.95751953125] [5.824887603521347, -38.95751953125] [5.824887603521347, -39.484346117824316] [4.3475002236664295, -39.484346117824316]  docID=1325\n   [junit4]   1>   lat=-38.94860311411321 lon=5.118960868567228\n   [junit4]   1>   deleted?=false\n   [junit4]   1> T1: id=17254 should not match but did\n   [junit4]   1>   small=true query=GeoPointInPolygonQuery: field=point: Points: [4.3475002236664295, -39.484346117824316] [4.3475002236664295, -38.95751953125] [5.824887603521347, -38.95751953125] [5.824887603521347, -39.484346117824316] [4.3475002236664295, -39.484346117824316]  docID=1336\n   [junit4]   1>   lat=-38.94333106465638 lon=5.617008693516254\n   [junit4]   1>   deleted?=false\n\n[... skipped many many more \"should not match but did\" messages ...]\n\n   [junit4]   2> JAN 13, 2016 6:53:38 R? com.carrotsearch.randomizedtesting.RandomizedRunner$QueueUncaughtExceptionsHandler uncaughtException\n   [junit4]   2> WARNING: Uncaught exception in thread: Thread[T1,5,TGRP-TestGeoPointQuery]\n   [junit4]   2> java.lang.AssertionError: some hits were wrong\n   [junit4]   2> \tat __randomizedtesting.SeedInfo.seed([30950A47BB2DFA04]:0)\n   [junit4]   2> \tat org.junit.Assert.fail(Assert.java:93)\n   [junit4]   2> \tat org.apache.lucene.util.BaseGeoPointTestCase$VerifyHits.test(BaseGeoPointTestCase.java:554)\n   [junit4]   2> \tat org.apache.lucene.util.BaseGeoPointTestCase$2._run(BaseGeoPointTestCase.java:758)\n   [junit4]   2> \tat org.apache.lucene.util.BaseGeoPointTestCase$2.run(BaseGeoPointTestCase.java:625)\n   [junit4]   2> \n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestGeoPointQuery -Dtests.method=testRandomMedium -Dtests.seed=30950A47BB2DFA04 -Dtests.multiplier=3 -Dtests.slow=true -Dtests.locale=mer_KE -Dtests.timezone=America/Martinique -Dtests.asserts=true -Dtests.file.encoding=US-ASCII\n   [junit4] ERROR   6.07s J0 | TestGeoPointQuery.testRandomMedium <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase.verify(BaseGeoPointTestCase.java:772)\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase.doTestRandom(BaseGeoPointTestCase.java:411)\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase.testRandomMedium(BaseGeoPointTestCase.java:335)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:747)Throwable #2: com.carrotsearch.randomizedtesting.UncaughtExceptionError: Captured an uncaught exception in thread: Thread[id=63, name=T1, state=RUNNABLE, group=TGRP-TestGeoPointQuery]\n   [junit4]    > Caused by: java.lang.AssertionError: some hits were wrong\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([30950A47BB2DFA04]:0)\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase$VerifyHits.test(BaseGeoPointTestCase.java:554)\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase$2._run(BaseGeoPointTestCase.java:758)\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase$2.run(BaseGeoPointTestCase.java:625)\n   [junit4] IGNOR/A 0.00s J0 | TestGeoPointQuery.testMultiValued\n   [junit4]    > Assumption #1: GeoPoint*Query is too slow otherwise\n   [junit4] IGNOR/A 0.00s J0 | TestGeoPointQuery.testAllLonEqual\n   [junit4]    > Assumption #1: GeoPoint*Query is too slow otherwise\n   [junit4] IGNOR/A 0.00s J0 | TestGeoPointQuery.testSamePointManyTimes\n   [junit4]    > Assumption #1: GeoPoint*Query is too slow otherwise\n   [junit4]   2> NOTE: test params are: codec=Asserting(Lucene60): {string=Lucene50(blocksize=128), id=Lucene50(blocksize=128), point=PostingsFormat(name=Direct)}, docValues:{id=DocValuesFormat(name=Direct), point=DocValuesFormat(name=Lucene54)}, sim=RandomSimilarityProvider(queryNorm=true,coord=crazy): {}, locale=mer_KE, timezone=America/Martinique\n   [junit4]   2> NOTE: Linux 3.19.0-42-generic amd64/Oracle Corporation 9-ea (64-bit)/cpus=12,threads=1,free=452799456,total=517996544\n   [junit4]   2> NOTE: All tests run in this JVM: [FuzzyLikeThisQueryTest, TestIDVersionPostingsFormat, TestDocValuesRangeQuery, TestGeoPointQuery]\n   [junit4] Completed [9/13 (1!)] on J0 in 7.10s, 23 tests, 2 errors, 5 skipped <<< FAILURES!",
    "attachments": {
        "LUCENE-6974.patch": "https://issues.apache.org/jira/secure/attachment/12782126/LUCENE-6974.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "id": "comment-15096948",
            "author": "Nicholas Knize",
            "date": "2016-01-13T20:41:41+0000",
            "content": "Patch to fix simple bug in the horizontal collinear case. This also adds a short-cut to rectWithinPoly to bail when candidate rectangle crosses the bounding box. "
        },
        {
            "id": "comment-15110074",
            "author": "Steve Rowe",
            "date": "2016-01-21T05:20:32+0000",
            "content": "My Jenkins found a reproducible seed for a nightly branch_5x failure that still fails after I apply the patch attached on this issue:\n\n\n   [junit4] Suite: org.apache.lucene.bkdtree.TestBKDTree\n   [junit4]   1> T0: id=2 should match but did not\n   [junit4]   1>   small=true query=BKDPointInPolygonQuery: field=point: Points: [-22.73471034431732, -86.43202518386845] [-22.73471034431732, -85.92436153743739] [-21.576782146469277, -85.92436153743739] [-21.576782146469277, -86.43202518386845] [-22.73471034431732, -86.43202518386845]  docID=2\n   [junit4]   1>   lat=-86.15216347061619 lon=-22.37586099175772\n   [junit4]   1>   deleted?=false\n   [junit4]   1> T0: id=28 should match but did not\n   [junit4]   1>   small=true query=BKDPointInPolygonQuery: field=point: Points: [-22.73471034431732, -86.43202518386845] [-22.73471034431732, -85.92436153743739] [-21.576782146469277, -85.92436153743739] [-21.576782146469277, -86.43202518386845] [-22.73471034431732, -86.43202518386845]  docID=28\n   [junit4]   1>   lat=-85.94649486908592 lon=-21.945687183472103\n   [junit4]   1>   deleted?=false\n   [junit4]   1> T0: id=30 should match but did not\n   [junit4]   1>   small=true query=BKDPointInPolygonQuery: field=point: Points: [-22.73471034431732, -86.43202518386845] [-22.73471034431732, -85.92436153743739] [-21.576782146469277, -85.92436153743739] [-21.576782146469277, -86.43202518386845] [-22.73471034431732, -86.43202518386845]  docID=30\n   [junit4]   1>   lat=-86.39056434023333 lon=-22.586003049332326\n   [junit4]   1>   deleted?=false\n   [junit4]   1> T0: id=43 should match but did not\n   [junit4]   1>   small=true query=BKDPointInPolygonQuery: field=point: Points: [-22.73471034431732, -86.43202518386845] [-22.73471034431732, -85.92436153743739] [-21.576782146469277, -85.92436153743739] [-21.576782146469277, -86.43202518386845] [-22.73471034431732, -86.43202518386845]  docID=43\n   [junit4]   1>   lat=-86.3172243711346 lon=-21.89312640969617\n   [junit4]   1>   deleted?=false\n   [junit4]   1> T0: id=66 should match but did not\n   [junit4]   1>   small=true query=BKDPointInPolygonQuery: field=point: Points: [-22.73471034431732, -86.43202518386845] [-22.73471034431732, -85.92436153743739] [-21.576782146469277, -85.92436153743739] [-21.576782146469277, -86.43202518386845] [-22.73471034431732, -86.43202518386845]  docID=66\n   [junit4]   1>   lat=-86.1859727542263 lon=-21.81480387698287\n   [junit4]   1>   deleted?=false\n[...]\n   [junit4]   1> T0: id=262138 should match but did not\n   [junit4]   1>   small=true query=BKDPointInPolygonQuery: field=point: Points: [-22.73471034431732, -86.43202518386845] [-22.73471034431732, -85.92436153743739] [-21.576782146469277, -85.92436153743739] [-21.576782146469277, -86.43202518386845] [-22.73471034431732, -86.43202518386845]  docID=262138\n   [junit4]   1>   lat=-86.40505635643676 lon=-22.13216961174832\n   [junit4]   1>   deleted?=false\n   [junit4]   2> ene 20, 2016 3:55:21 PM com.carrotsearch.randomizedtesting.RandomizedRunner$QueueUncaughtExceptionsHandler uncaughtException\n   [junit4]   2> WARNING: Uncaught exception in thread: Thread[T0,5,TGRP-TestBKDTree]\n   [junit4]   2> java.lang.AssertionError: some hits were wrong\n   [junit4]   2> \tat __randomizedtesting.SeedInfo.seed([95DD13D65134F958]:0)\n   [junit4]   2> \tat org.junit.Assert.fail(Assert.java:93)\n   [junit4]   2> \tat org.apache.lucene.util.BaseGeoPointTestCase$VerifyHits.test(BaseGeoPointTestCase.java:548)\n   [junit4]   2> \tat org.apache.lucene.util.BaseGeoPointTestCase$2._run(BaseGeoPointTestCase.java:754)\n   [junit4]   2> \tat org.apache.lucene.util.BaseGeoPointTestCase$2.run(BaseGeoPointTestCase.java:619)\n   [junit4]   2> \n   [junit4]   2> NOTE: download the large Jenkins line-docs file by running 'ant get-jenkins-line-docs' in the lucene directory.\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestBKDTree -Dtests.method=testRandomBig -Dtests.seed=95DD13D65134F958 -Dtests.multiplier=2 -Dtests.nightly=true -Dtests.slow=true -Dtests.linedocsfile=/home/jenkins/lucene-data/enwiki.random.lines.txt -Dtests.locale=es-EC -Dtests.timezone=America/Yakutat -Dtests.asserts=true -Dtests.file.encoding=UTF-8\n   [junit4] ERROR   62.5s J0 | TestBKDTree.testRandomBig <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase.verify(BaseGeoPointTestCase.java:768)\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase.doTestRandom(BaseGeoPointTestCase.java:399)\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase.testRandomBig(BaseGeoPointTestCase.java:327)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:745)Throwable #2: com.carrotsearch.randomizedtesting.UncaughtExceptionError: Captured an uncaught exception in thread: Thread[id=43, name=T0, state=RUNNABLE, group=TGRP-TestBKDTree]\n   [junit4]    > Caused by: java.lang.AssertionError: some hits were wrong\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([95DD13D65134F958]:0)\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase$VerifyHits.test(BaseGeoPointTestCase.java:548)\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase$2._run(BaseGeoPointTestCase.java:754)\n   [junit4]    > \tat org.apache.lucene.util.BaseGeoPointTestCase$2.run(BaseGeoPointTestCase.java:619)\n   [junit4]   2> NOTE: leaving temporary files on disk at: /var/lib/jenkins/jobs/Lucene-Solr-Nightly-5.x-Java8/workspace/lucene/build/sandbox/test/J0/temp/lucene.bkdtree.TestBKDTree_95DD13D65134F958-001\n   [junit4]   2> NOTE: test params are: codec=Asserting(Lucene54): {}, docValues:{}, sim=DefaultSimilarity, locale=es-EC, timezone=America/Yakutat\n   [junit4]   2> NOTE: Linux 4.1.0-custom2-amd64 amd64/Oracle Corporation 1.8.0_45 (64-bit)/cpus=16,threads=1,free=195262360,total=534249472\n   [junit4]   2> NOTE: All tests run in this JVM: [TestBKDTree]\n   [junit4] Completed [17/20 (1!)] on J0 in 92.43s, 10 tests, 1 error <<< FAILURES!\n\n "
        },
        {
            "id": "comment-15110076",
            "author": "Steve Rowe",
            "date": "2016-01-21T05:23:23+0000",
            "content": "Sorry, I just realized that this is a different test than the one originally reported on in this issue, not sure if it's the same root cause or not, but the error messages look nearly the same. "
        },
        {
            "id": "comment-15110693",
            "author": "ASF subversion and git services",
            "date": "2016-01-21T14:48:44+0000",
            "content": "Commit 1725966 from Nicholas Knize in branch 'dev/trunk'\n[ https://svn.apache.org/r1725966 ]\n\nLUCENE-6974: Correct horizontal collinear logic bug in GeoRelationUtils.lineCrossesLine "
        },
        {
            "id": "comment-15110716",
            "author": "ASF subversion and git services",
            "date": "2016-01-21T14:59:01+0000",
            "content": "Commit 1725971 from Nicholas Knize in branch 'dev/branches/branch_5x'\n[ https://svn.apache.org/r1725971 ]\n\nLUCENE-6974: Correct horizontal collinear logic bug in GeoRelationUtils.lineCrossesLine "
        },
        {
            "id": "comment-15112584",
            "author": "Michael McCandless",
            "date": "2016-01-22T16:02:17+0000",
            "content": "Nicholas Knize, can this be closed now? "
        },
        {
            "id": "comment-15112989",
            "author": "Nicholas Knize",
            "date": "2016-01-22T20:23:46+0000",
            "content": "It can be resolved. Looks like I don't have that power on this issue. :/ "
        },
        {
            "id": "comment-15857787",
            "author": "ASF subversion and git services",
            "date": "2017-02-08T10:22:17+0000",
            "content": "Commit 91147a84515e0d84201a36a0aedaab40806a02a0 in lucene-solr's branch refs/heads/branch_5_5 from Adrien Grand\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=91147a8 ]\n\nLUCENE-6974: Fixed DecimalDigitFilter in case of supplementary code points. "
        }
    ]
}