{
    "id": "SOLR-12988",
    "title": "TestMiniSolrCloudClusterSSL.testSslWithCheckPeerName fails reliably on java11: \"SSLPeerUnverifiedException: peer not authenticated\"",
    "details": {
        "type": "Test",
        "status": "Open",
        "labels": "",
        "fix_versions": [],
        "components": [],
        "priority": "Major",
        "resolution": "Unresolved",
        "affect_versions": "None"
    },
    "description": "TestMiniSolrCloudClusterSSL.testSslWithCheckPeerName seems to fail 100% of the time when run with java11 (or java12), regardless of seed, on both master & 7x.\n\nThe nature of the problem and the way our htp stack works suggests it may ultimately be a jetty bug (perhaps related to jetty issue#2711?)\n\nHOWEVER ... as far as i can tell, whatever the root cause is, seems to have been fixed on the jira/http2 branch (as of 52bc163dc1804c31af09c1fba99647005da415ad) which should hopefully be getting merged to master soon.\n\nFiling this issue largely for tracking purpose, although we may also want to use it for discussions/considerations of other backports/fixes to 7x",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "id": "comment-16687008",
            "content": "\nExample seed as of master/95d01c6583b825b6b87591e4f27002c285ea25fb ..\n\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestMiniSolrCloudClusterSSL -Dtests.method=testSslWithCheckPeerName -Dtests.seed=BD8A4C6891EB95BD -Dtests.slow=true -Dtests.badapples=true -Dtests.locale=mzn -Dtests.timezone=UTC -Dtests.asserts=true -Dtests.file.encoding=UTF-8\n   [junit4] ERROR   3.40s | TestMiniSolrCloudClusterSSL.testSslWithCheckPeerName <<<\n   [junit4]    > Throwable #1: org.apache.solr.client.solrj.impl.HttpSolrClient$RemoteSolrException: Error from server at https://127.0.0.1:38383/solr: Error getting replica locations : unable to get autoscaling policy session\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([BD8A4C6891EB95BD:E0E9B982ABA0D6C]:0)\n   [junit4]    > \tat org.apache.solr.client.solrj.impl.HttpSolrClient.executeMethod(HttpSolrClient.java:643)\n   [junit4]    > \tat org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:255)\n   [junit4]    > \tat org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:244)\n   [junit4]    > \tat org.apache.solr.client.solrj.impl.LBHttpSolrClient.doRequest(LBHttpSolrClient.java:483)\n   [junit4]    > \tat org.apache.solr.client.solrj.impl.LBHttpSolrClient.request(LBHttpSolrClient.java:413)\n   [junit4]    > \tat org.apache.solr.client.solrj.impl.CloudSolrClient.sendRequest(CloudSolrClient.java:1107)\n   [junit4]    > \tat org.apache.solr.client.solrj.impl.CloudSolrClient.requestWithRetryOnStaleState(CloudSolrClient.java:884)\n   [junit4]    > \tat org.apache.solr.client.solrj.impl.CloudSolrClient.request(CloudSolrClient.java:817)\n   [junit4]    > \tat org.apache.solr.client.solrj.SolrRequest.process(SolrRequest.java:194)\n   [junit4]    > \tat org.apache.solr.client.solrj.SolrRequest.process(SolrRequest.java:211)\n   [junit4]    > \tat org.apache.solr.cloud.TestMiniSolrCloudClusterSSL.checkCreateCollection(TestMiniSolrCloudClusterSSL.java:261)\n   [junit4]    > \tat org.apache.solr.cloud.TestMiniSolrCloudClusterSSL.checkClusterWithCollectionCreations(TestMiniSolrCloudClusterSSL.java:233)\n   [junit4]    > \tat org.apache.solr.cloud.TestMiniSolrCloudClusterSSL.checkClusterWithNodeReplacement(TestMiniSolrCloudClusterSSL.java:157)\n   [junit4]    > \tat org.apache.solr.cloud.TestMiniSolrCloudClusterSSL.testSslWithCheckPeerName(TestMiniSolrCloudClusterSSL.java:139)\n   [junit4]    > \tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n   [junit4]    > \tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n   [junit4]    > \tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n   [junit4]    > \tat java.base/java.lang.reflect.Method.invoke(Method.java:566)\n   [junit4]    > \tat java.base/java.lang.Thread.run(Thread.java:834)\n\n\n\nFrom the logs...\n\n\n   [junit4]   2> Caused by: javax.net.ssl.SSLPeerUnverifiedException: peer not authenticated\n   [junit4]   2> \tat java.base/sun.security.ssl.SSLSessionImpl.getPeerCertificates(SSLSessionImpl.java:526)\n   [junit4]   2> \tat org.apache.http.conn.ssl.SSLConnectionSocketFactory.verifyHostname(SSLConnectionSocketFactory.java:464)\n   [junit4]   2> \tat org.apache.http.conn.ssl.SSLConnectionSocketFactory.createLayeredSocket(SSLConnectionSocketFactory.java:397)\n   [junit4]   2> \tat org.apache.http.conn.ssl.SSLConnectionSocketFactory.connectSocket(SSLConnectionSocketFactory.java:355)\n   [junit4]   2> \tat org.apache.http.impl.conn.DefaultHttpClientConnectionOperator.connect(DefaultHttpClientConnectionOperator.java:142)\n   [junit4]   2> \tat org.apache.http.impl.conn.PoolingHttpClientConnectionManager.connect(PoolingHttpClientConnectionManager.java:359)\n   [junit4]   2> \tat org.apache.http.impl.execchain.MainClientExec.establishRoute(MainClientExec.java:381)\n   [junit4]   2> \tat org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:237)\n   [junit4]   2> \tat org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:185)\n   [junit4]   2> \tat org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:89)\n   [junit4]   2> \tat org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:111)\n   [junit4]   2> \tat org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:185)\n   [junit4]   2> \tat org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:83)\n   [junit4]   2> \tat org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:56)\n   [junit4]   2> \tat org.apache.solr.client.solrj.impl.HttpSolrClient.executeMethod(HttpSolrClient.java:542)\n\n ",
            "author": "Hoss Man",
            "date": "2018-11-14T19:16:00+0000"
        }
    ]
}