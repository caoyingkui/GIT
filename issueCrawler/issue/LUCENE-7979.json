{
    "id": "LUCENE-7979",
    "title": "Move disjunctions to a radix heap",
    "details": {
        "labels": "",
        "priority": "Trivial",
        "resolution": "Won't Fix",
        "affect_versions": "None",
        "status": "Resolved",
        "type": "Improvement",
        "components": [],
        "fix_versions": []
    },
    "description": "An Elasticsearch user argued that we should look into using radix heaps in order to run disjunctions so I wanted to give it a try. I'm creating this issue to share findings. Spoiler: so far it does not seem to help but maybe I'm just doing it wrong?",
    "attachments": {
        "LUCENE-7979.patch": "https://issues.apache.org/jira/secure/attachment/12889106/LUCENE-7979.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "id": "comment-16181161",
            "date": "2017-09-26T17:13:19+0000",
            "content": "Here is a patch. It does not pass all tests as eg. the new priority queue does not work exactly as MinShouldMatchSumScorer expects but it should be enough for benchmarking.\n\nI tried wikimedium10m on the following tasks file, bulk scoring is disabled:\n\n\nOrHighHigh: several following # freq=436129 freq=416515\nOrHighHigh: publisher end # freq=1289029 freq=526636\nOrHighHigh: 2009 film # freq=887702 freq=432758\nOrHighHigh: http known # freq=3493581 freq=607158\nOrHighHigh: south county # freq=560468 freq=521126\nOrHighMed: international chris # freq=418261 freq=85523\nOrHighMed: right million # freq=630423 freq=175554\nOrHighMed: known created # freq=607158 freq=220831\nOrHighMed: its universal # freq=1173450 freq=47078\nOrHighMed: 9 network # freq=574434 freq=164997\nOrHighLow: 2005 valois # freq=835460 freq=2277\nOrHighLow: until universalist # freq=425389 freq=1230\nOrHighLow: made forays # freq=742313 freq=799\nOrHighLow: do bush's # freq=511178 freq=2681\nOrHighLow: 10 racedetail.html # freq=918339 freq=870\nOr5High5Med5Low: several publisher 2009 http south chris million created universal network valois universalist forays bush's racedetail.html\nOr5High5Med5Low: id title s called 2 reform face draft summary 1923 weed violently cantrell 10.1371 veneration\nOr128Med: second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although based small british group like each series film 18 place now against death her until pp 25 j great west major ii 13 london 14 long e 16 30 us 2003 center large day citation references could x d example population b even another style found do 2012 n 2002 what form those 2001 br public four 17 22 much following east 24 very needed article modern 19 country around f french v according old king within include still did jpg set music doi 21 age power family external using links order own house home german\nOr128Med: common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story without england president link original zh category roman short europe party white further image david though given h along human top society ja france school james 01 make 1998 best pdf late point robert man named service research information term local european led w western members present union convert la published important 1997 various popular l off former america text official control water considered uk black third river near five become army just usually established single how said result george down st others edition retrieved 02 land 1996 church support air full few 03 free less\n\n\n\n\n                    TaskQPS baseline      StdDev   QPS patch      StdDev                Pct diff\n               OrHighMed       27.75      (2.0%)       19.46      (0.6%)  -29.9% ( -31% -  -27%)\n               OrHighLow       45.52      (2.5%)       32.28      (0.4%)  -29.1% ( -31% -  -26%)\n              OrHighHigh       34.59      (1.5%)       25.91      (0.5%)  -25.1% ( -26% -  -23%)\n         Or5High5Med5Low        3.08      (1.6%)        2.84      (0.6%)   -7.9% (  -9% -   -5%)\n                Or128Med        0.24      (1.8%)        0.27      (0.5%)   12.8% (  10% -   15%)\n\n\n\nThis matches my intuition that the radix heap performs better when there are many terms, but the threshold looks quite high: even with 15 terms the regular binary heap still performs better.\n\nMaybe there are ways we could make it perform better for common numbers of terms in a disjunction? ",
            "author": "Adrien Grand"
        },
        {
            "id": "comment-16182877",
            "date": "2017-09-27T16:49:51+0000",
            "content": "I've been playing more with it, adding more tasks to figure out what the threshold is and optimizing the advance() implementation since the radix heap makes it efficient to identify sub scorers whose current doc id is less than the target.\n\n\nOr2Med: second june\nOr2Med: common r\nOr4Med: second june several october\nOr4Med: common r different non\nOr8Med: second june several october december july high because\nOr8Med: common r different non among 23 due science\nOr16Med: second june several october december july high because 20 general government m books him language february\nOr16Med: common r different non among 23 due science class reflist 28 27 political 26 ndash line\nOr32Med: second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although\nOr32Med: common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story\nOr64Med: second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although based small british group like each series film 18 place now against death her until pp 25 j great west major ii 13 london 14 long e 16 30 us 2003 center\nOr64Med: common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story without england president link original zh category roman short europe party white further image david though given h along human top society ja france school james 01 make 1998 best pdf late\nOr128Med: second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although based small british group like each series film 18 place now against death her until pp 25 j great west major ii 13 london 14 long e 16 30 us 2003 center large day citation references could x d example population b even another style found do 2012 n 2002 what form those 2001 br public four 17 22 much following east 24 very needed article modern 19 country around f french v according old king within include still did jpg set music doi 21 age power family external using links order own house home german\nOr128Med: common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story without england president link original zh category roman short europe party white further image david though given h along human top society ja france school james 01 make 1998 best pdf late point robert man named service research information term local european led w western members present union convert la published important 1997 various popular l off former america text official control water considered uk black third river near five become army just usually established single how said result george down st others edition retrieved 02 land 1996 church support air full few 03 free less\nAndLowOr2Med: +valois +(second june)\nAndLowOr2Med: +universalist +(common r)\nAndLowOr4Med: +valois +(second june several october)\nAndLowOr4Med: +universalist +(common r different non)\nAndLowOr8Med: +valois +(second june several october december july high because)\nAndLowOr8Med: +universalist +(common r different non among 23 due science)\nAndLowOr16Med: +valois +(second june several october december july high because 20 general government m books him language february)\nAndLowOr16Med: +universalist +(common r different non among 23 due science class reflist 28 27 political 26 ndash line)\nAndLowOr32Med: +valois +(second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although)\nAndLowOr32Med: +universalist +(common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story)\nAndLowOr64Med: +valois +(second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although based small british group like each series film 18 place now against death her until pp 25 j great west major ii 13 london 14 long e 16 30 us 2003 center)\nAndLowOr64Med: +universalist +(common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story without england president link original zh category roman short europe party white further image david though given h along human top society ja france school james 01 make 1998 best pdf late)\nAndLowOr128Med: +valois +(second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although based small british group like each series film 18 place now against death her until pp 25 j great west major ii 13 london 14 long e 16 30 us 2003 center large day citation references could x d example population b even another style found do 2012 n 2002 what form those 2001 br public four 17 22 much following east 24 very needed article modern 19 country around f french v according old king within include still did jpg set music doi 21 age power family external using links order own house home german)\nAndLowOr128Med: +universalist +(common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story without england president link original zh category roman short europe party white further image david though given h along human top society ja france school james 01 make 1998 best pdf late point robert man named service research information term local european led w western members present union convert la published important 1997 various popular l off former america text official control water considered uk black third river near five become army just usually established single how said result george down st others edition retrieved 02 land 1996 church support air full few 03 free less)\n\n\n\n\n                    TaskQPS baseline      StdDev   QPS patch      StdDev                Pct diff\n                  Or2Med       31.10      (1.9%)       21.80      (0.9%)  -29.9% ( -32% -  -27%)\n                  Or4Med       13.14      (1.7%)       10.43      (0.6%)  -20.6% ( -22% -  -18%)\n                  Or8Med        5.88      (2.0%)        4.86      (1.1%)  -17.4% ( -20% -  -14%)\n                 Or16Med        3.82      (2.3%)        3.41      (1.0%)  -10.6% ( -13% -   -7%)\n            AndLowOr2Med      884.67      (2.4%)      848.53      (2.4%)   -4.1% (  -8% -    0%)\n                 Or32Med        1.80      (2.8%)        1.76      (1.1%)   -1.9% (  -5% -    1%)\n            AndLowOr4Med      368.51      (3.1%)      362.91      (3.3%)   -1.5% (  -7% -    5%)\n            AndLowOr8Med      198.25      (3.7%)      202.56      (3.0%)    2.2% (  -4% -    9%)\n           AndLowOr16Med      132.13      (3.0%)      136.37      (4.1%)    3.2% (  -3% -   10%)\n           AndLowOr32Med       47.04      (2.9%)       49.89      (2.4%)    6.0% (   0% -   11%)\n           AndLowOr64Med       32.28      (2.1%)       34.49      (2.3%)    6.8% (   2% -   11%)\n                 Or64Med        0.81      (2.8%)        0.87      (1.1%)    7.1% (   3% -   11%)\n          AndLowOr128Med       15.40      (3.4%)       16.79      (2.1%)    9.0% (   3% -   15%)\n                Or128Med        0.27      (4.1%)        0.30      (1.9%)   10.2% (   3% -   16%)\n\n\n\nFor these particular dataset and queries, this gives us a threshold between 32 and 64 for top-level disjunctions, and between 4 and 8 for disjunctions within conjunctions, which is not bad considering that most of the time advance() is more useful that nextDoc() on disjunctions since we have a dedicated bulk scorer. ",
            "author": "Adrien Grand"
        },
        {
            "id": "comment-16191298",
            "date": "2017-10-04T14:08:41+0000",
            "content": "New iteration that optimizes the data-structure for ours needs. I like results on queries with 16 clauses or more, but on the other hand queries with less than 16 clauses perform worse than a regular binary heap. I'm not sure we want to specialize the >16 clauses case, which is not frequent I think? I tried many ideas and this is the best I could get.\n\n\nOr2Med: second june\nOr2Med: common r\nOr4Med: second june several october\nOr4Med: common r different non\nOr8Med: second june several october december july high because\nOr8Med: common r different non among 23 due science\nOr16Med: second june several october december july high because 20 general government m books him language february\nOr16Med: common r different non among 23 due science class reflist 28 27 political 26 ndash line\nOr32Med: second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although\nOr32Med: common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story\nOr64Med: second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although based small british group like each series film 18 place now against death her until pp 25 j great west major ii 13 london 14 long e 16 30 us 2003 center\nOr64Med: common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story without england president link original zh category roman short europe party white further image david though given h along human top society ja france school james 01 make 1998 best pdf late\nOr128Med: second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although based small british group like each series film 18 place now against death her until pp 25 j great west major ii 13 london 14 long e 16 30 us 2003 center large day citation references could x d example population b even another style found do 2012 n 2002 what form those 2001 br public four 17 22 much following east 24 very needed article modern 19 country around f french v according old king within include still did jpg set music doi 21 age power family external using links order own house home german\nOr128Med: common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story without england president link original zh category roman short europe party white further image david though given h along human top society ja france school james 01 make 1998 best pdf late point robert man named service research information term local european led w western members present union convert la published important 1997 various popular l off former america text official control water considered uk black third river near five become army just usually established single how said result george down st others edition retrieved 02 land 1996 church support air full few 03 free less\nAndLowOr2Med: +valois +(second june)\nAndLowOr2Med: +universalist +(common r)\nAndLowOr4Med: +valois +(second june several october)\nAndLowOr4Med: +universalist +(common r different non)\nAndLowOr8Med: +valois +(second june several october december july high because)\nAndLowOr8Med: +universalist +(common r different non among 23 due science)\nAndLowOr16Med: +valois +(second june several october december july high because 20 general government m books him language february)\nAndLowOr16Med: +universalist +(common r different non among 23 due science class reflist 28 27 political 26 ndash line)\nAndLowOr32Med: +valois +(second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although)\nAndLowOr32Med: +universalist +(common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story)\nAndLowOr64Med: +valois +(second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although based small british group like each series film 18 place now against death her until pp 25 j great west major ii 13 london 14 long e 16 30 us 2003 center)\nAndLowOr64Med: +universalist +(common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story without england president link original zh category roman short europe party white further image david though given h along human top society ja france school james 01 make 1998 best pdf late)\nAndLowOr128Med: +valois +(second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although based small british group like each series film 18 place now against death her until pp 25 j great west major ii 13 london 14 long e 16 30 us 2003 center large day citation references could x d example population b even another style found do 2012 n 2002 what form those 2001 br public four 17 22 much following east 24 very needed article modern 19 country around f french v according old king within include still did jpg set music doi 21 age power family external using links order own house home german)\nAndLowOr128Med: +universalist +(common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story without england president link original zh category roman short europe party white further image david though given h along human top society ja france school james 01 make 1998 best pdf late point robert man named service research information term local european led w western members present union convert la published important 1997 various popular l off former america text official control water considered uk black third river near five become army just usually established single how said result george down st others edition retrieved 02 land 1996 church support air full few 03 free less)\nAndHighOr2Med: +ref +(second june)\nAndHighOr2Med: +http +(common r)\nAndHighOr4Med: +ref +(second june several october)\nAndHighOr4Med: +http +(common r different non)\nAndHighOr8Med: +ref +(second june several october december july high because)\nAndHighOr8Med: +http +(common r different non among 23 due science)\nAndHighOr16Med: +ref +(second june several october december july high because 20 general government m books him language february)\nAndHighOr16Med: +http +(common r different non among 23 due science class reflist 28 27 political 26 ndash line)\nAndHighOr32Med: +ref +(second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although)\nAndHighOr32Med: +http +(common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story)\nAndHighOr64Med: +ref +(second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although based small british group like each series film 18 place now against death her until pp 25 j great west major ii 13 london 14 long e 16 30 us 2003 center)\nAndHighOr64Med: +http +(common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story without england president link original zh category roman short europe party white further image david though given h along human top society ja france school james 01 make 1998 best pdf late)\nAndHighOr128Med: +ref +(second june several october december july high because 20 general government m books him language february end august list issue same often area november 15 county international 2000 2004 times u.s although based small british group like each series film 18 place now against death her until pp 25 j great west major ii 13 london 14 long e 16 30 us 2003 center large day citation references could x d example population b even another style found do 2012 n 2002 what form those 2001 br public four 17 22 much following east 24 very needed article modern 19 country around f french v according old king within include still did jpg set music doi 21 age power family external using links order own house home german)\nAndHighOr128Med: +http +(common r different non among 23 due science class reflist 28 27 political 26 ndash line way military law william kingdom 1999 development she company back central 29 en began period story without england president link original zh category roman short europe party white further image david though given h along human top society ja france school james 01 make 1998 best pdf late point robert man named service research information term local european led w western members present union convert la published important 1997 various popular l off former america text official control water considered uk black third river near five become army just usually established single how said result george down st others edition retrieved 02 land 1996 church support air full few 03 free less)\n\n\n\n\n                    TaskQPS baseline      StdDev   QPS patch      StdDev                Pct diff\n                  Or2Med       31.03      (2.6%)       26.20      (3.2%)  -15.6% ( -20% -  -10%)\n           AndHighOr2Med       29.83      (2.3%)       27.10      (1.7%)   -9.2% ( -12% -   -5%)\n                  Or4Med       23.40      (2.5%)       21.65      (2.8%)   -7.5% ( -12% -   -2%)\n           AndHighOr4Med        8.81      (3.0%)        8.16      (2.0%)   -7.4% ( -12% -   -2%)\n           AndHighOr8Med        7.87      (2.6%)        7.36      (1.8%)   -6.5% ( -10% -   -2%)\n            AndLowOr2Med      669.76      (3.2%)      643.50      (2.9%)   -3.9% (  -9% -    2%)\n                  Or8Med        5.74      (2.6%)        5.53      (2.6%)   -3.7% (  -8% -    1%)\n            AndLowOr4Med      544.34      (4.1%)      537.14      (3.4%)   -1.3% (  -8% -    6%)\n            AndLowOr8Med      205.31      (3.5%)      206.22      (4.2%)    0.4% (  -7% -    8%)\n          AndHighOr16Med        2.64      (2.7%)        2.72      (2.4%)    2.9% (  -2% -    8%)\n           AndLowOr16Med      137.25      (3.1%)      141.61      (3.5%)    3.2% (  -3% -   10%)\n           AndLowOr32Med       68.60      (2.8%)       71.86      (3.6%)    4.7% (  -1% -   11%)\n           AndLowOr64Med       33.63      (2.8%)       35.87      (3.1%)    6.7% (   0% -   12%)\n                 Or16Med        2.64      (3.3%)        2.86      (3.0%)    8.1% (   1% -   14%)\n          AndLowOr128Med       11.63      (3.2%)       12.77      (3.6%)    9.8% (   3% -   17%)\n          AndHighOr32Med        1.93      (2.4%)        2.18      (2.6%)   12.9% (   7% -   18%)\n                 Or32Med        1.18      (3.3%)        1.50      (3.5%)   26.5% (  19% -   34%)\n          AndHighOr64Med        0.68      (2.1%)        0.94      (2.8%)   39.2% (  33% -   45%)\n                 Or64Med        0.54      (3.6%)        0.81      (4.4%)   49.7% (  40% -   59%)\n         AndHighOr128Med        0.49      (2.5%)        0.76      (2.7%)   56.1% (  49% -   62%)\n                Or128Med        0.39      (3.8%)        0.63      (4.7%)   61.8% (  51% -   73%)\n\n ",
            "author": "Adrien Grand"
        }
    ]
}