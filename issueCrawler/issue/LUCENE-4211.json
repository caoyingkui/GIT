{
    "id": "LUCENE-4211",
    "title": "in LuceneTestCase.maybeWrapReader: add an asserting impl",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [
            "general/test"
        ],
        "type": "Task",
        "fix_versions": [
            "4.0-BETA",
            "6.0"
        ],
        "affect_versions": "None",
        "resolution": "Fixed",
        "status": "Closed"
    },
    "description": "It would be nice to wrap with FIR here sometimes,\none that returns AssertingFields, etc etc.\n\nThis way we could check if consumers are doing bogus things (like reading nextDoc after it returned NO_MORE_DOCS, or TermsEnum.next after its exhausted, or things like that).\n\nThis would also be nice to catch tests that do this rather than doing\ncrazy debugging over whats not really a bug.",
    "attachments": {
        "LUCENE-4211.patch": "https://issues.apache.org/jira/secure/attachment/12536110/LUCENE-4211.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2012-07-11T20:54:26+0000",
            "content": "Here's a start to the patch, an AssertingAtomicReader.\n\nIt just needs asserts (i only added a few ones in the ctor)\n\nIt would be nice if we could also create an AssertingCompositeReader somehow, that would wrap another composite reader and ensure its subs are wrapped with AssertingAtomicReaders?\n\nMaybe it could also do some composite-level checks. ",
            "author": "Robert Muir",
            "id": "comment-13411980"
        },
        {
            "date": "2012-07-11T21:27:01+0000",
            "content": "For the composite stuff: I guess I mean an AssertingDirectoryReader actually.\n\nOtherwise we won't get many checks. ",
            "author": "Robert Muir",
            "id": "comment-13412013"
        },
        {
            "date": "2012-07-11T21:54:30+0000",
            "content": "I guess this is a good idea. But as said, some of those checks in your ctor should be done in the AtomicReader impl already, as they cost nothing (same for other readers). But of course asserting DocsEnums and TermsEnums is the real advantage of this! ",
            "author": "Uwe Schindler",
            "id": "comment-13412045"
        },
        {
            "date": "2012-07-12T20:41:29+0000",
            "content": "Updated patch with docsEnum and docsAndPositionsEnums asserts/state machines.\n\nAlso added a AssertingDirectoryReader which ensures subreaders are wrapped with AssertingAtomicReaders.\n\nAlso wraps termvectors with AssertingFields.\n\nTODO:\n\n\tadd state machine/asserts to TermsEnum\n\tadd an AssertingCodec that does these checks always, put it in rotation so that any code (e.g. solr) not necessarily using newSearcher() from LuceneTestCase still gets these checks.\n\n\n\nThere is a problem with a function query and fieldcache insanity, i dont understand this FCInvisibleReader etc goign on here:\n\nant test  -Dtestcase=TestOrdValues -Dtests.method=testReverseOrdFieldRank -Dtests.seed=E54A53902AE23DE0 -Dtests.slow=true -Dtests.locale=fr_CH -Dtests.timezone=America/Argentina/Cordoba -Dtests.file.encoding=UTF-8\n\n\n\nIts possible this is unrelated to the patch... ",
            "author": "Robert Muir",
            "id": "comment-13413174"
        },
        {
            "date": "2012-07-12T21:49:19+0000",
            "content": "OK i got past the insanity issue: thankfully Uwe already had a reusable hack in place in LuceneTestCase.\n\nBut then I added AssertingCodec/AssertingPostingsFormat that use these checks, and started running 'ant test -Dtests.codec=Asserting' and there are some bugs in tests I think ",
            "author": "Robert Muir",
            "id": "comment-13413265"
        },
        {
            "date": "2012-07-12T21:50:32+0000",
            "content": "\n[junit4:junit4] Suite: org.apache.lucene.index.TestDocsAndPositions\n[junit4:junit4] FAILURE 0.04s J3 | TestDocsAndPositions.testRandomPositions\n[junit4:junit4]    > Throwable #1: java.lang.AssertionError: nextDoc() called after iterator is exhausted!\n[junit4:junit4]    > \tat __randomizedtesting.SeedInfo.seed([35D7F00507FD5A9D:4BF3893054577754]:0)\n[junit4:junit4]    > \tat org.apache.lucene.index.AssertingAtomicReader$AssertingDocsAndPositionsEnum.nextDoc(AssertingAtomicReader.java:207)\n[junit4:junit4]    > \tat org.apache.lucene.index.TestDocsAndPositions.testRandomPositions(TestDocsAndPositions.java:178)\n[junit4:junit4]    > \tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n[junit4:junit4]    > \tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n[junit4:junit4]    > \tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n[junit4:junit4]    > \tat java.lang.reflect.Method.invoke(Method.java:597)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1995)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$1100(RandomizedRunner.java:132)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:818)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:877)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$8.evaluate(RandomizedRunner.java:891)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:50)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleFieldCacheSanity$1.evaluate(TestRuleFieldCacheSanity.java:32)\n[junit4:junit4]    > \tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleReportUncaughtExceptions$1.evaluate(TestRuleReportUncaughtExceptions.java:68)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:48)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:70)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:825)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$700(RandomizedRunner.java:132)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$3$1.run(RandomizedRunner.java:671)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$3.evaluate(RandomizedRunner.java:697)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$4.evaluate(RandomizedRunner.java:736)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:747)\n[junit4:junit4]    > \tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleReportUncaughtExceptions$1.evaluate(TestRuleReportUncaughtExceptions.java:68)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:38)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIcuHack$1.evaluate(TestRuleIcuHack.java:51)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleNoInstanceHooksOverrides$1.evaluate(TestRuleNoInstanceHooksOverrides.java:53)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleNoStaticHooksShadowing$1.evaluate(TestRuleNoStaticHooksShadowing.java:52)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:36)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:70)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:55)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSuite(RandomizedRunner.java:605)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$400(RandomizedRunner.java:132)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$2.run(RandomizedRunner.java:551)\n[junit4:junit4]    > \n[junit4:junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestDocsAndPositions -Dtests.method=testRandomPositions -Dtests.seed=35D7F00507FD5A9D -Dtests.slow=true -Dtests.codec=Asserting -Dtests.locale=ar_OM -Dtests.timezone=NST -Dtests.file.encoding=UTF-8\n[junit4:junit4]   2>\n[junit4:junit4]    > (@AfterClass output)\n[junit4:junit4]   2> NOTE: test params are: codec=Asserting, sim=RandomSimilarityProvider(queryNorm=true,coord=true): {foo=DFR GBZ(0.3)}, locale=ar_OM, timezone=NST\n\n[junit4:junit4] Suite: org.apache.lucene.index.TestPostingsOffsets\n[junit4:junit4] FAILURE 0.03s J2 | TestPostingsOffsets.testRandom\n[junit4:junit4]    > Throwable #1: java.lang.AssertionError: nextDoc() called after iterator is exhausted!\n[junit4:junit4]    > \tat __randomizedtesting.SeedInfo.seed([35D7F00507FD5A9D:479BD50AB69DECEE]:0)\n[junit4:junit4]    > \tat org.apache.lucene.index.AssertingAtomicReader$AssertingDocsAndPositionsEnum.nextDoc(AssertingAtomicReader.java:207)\n[junit4:junit4]    > \tat org.apache.lucene.index.TestPostingsOffsets.testRandom(TestPostingsOffsets.java:333)\n[junit4:junit4]    > \tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n[junit4:junit4]    > \tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n[junit4:junit4]    > \tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n[junit4:junit4]    > \tat java.lang.reflect.Method.invoke(Method.java:597)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1995)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$1100(RandomizedRunner.java:132)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:818)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:877)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$8.evaluate(RandomizedRunner.java:891)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:50)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleFieldCacheSanity$1.evaluate(TestRuleFieldCacheSanity.java:32)\n[junit4:junit4]    > \tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleReportUncaughtExceptions$1.evaluate(TestRuleReportUncaughtExceptions.java:68)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:48)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:70)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:825)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$700(RandomizedRunner.java:132)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$3$1.run(RandomizedRunner.java:671)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$3.evaluate(RandomizedRunner.java:697)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$4.evaluate(RandomizedRunner.java:736)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:747)\n[junit4:junit4]    > \tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleReportUncaughtExceptions$1.evaluate(TestRuleReportUncaughtExceptions.java:68)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:38)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIcuHack$1.evaluate(TestRuleIcuHack.java:51)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleNoInstanceHooksOverrides$1.evaluate(TestRuleNoInstanceHooksOverrides.java:53)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleNoStaticHooksShadowing$1.evaluate(TestRuleNoStaticHooksShadowing.java:52)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:36)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:70)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:55)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSuite(RandomizedRunner.java:605)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$400(RandomizedRunner.java:132)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$2.run(RandomizedRunner.java:551)\n[junit4:junit4]    > \n[junit4:junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestPostingsOffsets -Dtests.method=testRandom -Dtests.seed=35D7F00507FD5A9D -Dtests.slow=true -Dtests.codec=Asserting -Dtests.locale=nl_BE -Dtests.timezone=America/Los_Angeles -Dtests.file.encoding=UTF-8\n\n\n\nHere are an example of 2 fails. ",
            "author": "Robert Muir",
            "id": "comment-13413266"
        },
        {
            "date": "2012-07-12T22:02:01+0000",
            "content": "Mike committed fixes already for both these seeds... thanks Mike!\n\nContinuing testing... ",
            "author": "Robert Muir",
            "id": "comment-13413280"
        },
        {
            "date": "2012-07-12T22:21:32+0000",
            "content": "Patch, just adding checks to AssertingTermsEnum.  Tests pass with it ... ",
            "author": "Michael McCandless",
            "id": "comment-13413295"
        },
        {
            "date": "2012-07-13T12:58:13+0000",
            "content": "Latest patch: I fixed up all javadocs, and also setup AssertingCodec to wrap its term vectors with AssertingFields.\n\nBut this finds bugs in highlighter, they all look like this:\n\n\n[junit4:junit4] Suite: org.apache.lucene.search.highlight.HighlighterPhraseTest\n[junit4:junit4] FAILURE 0.07s J2 | HighlighterPhraseTest.testSparseSpan\n[junit4:junit4]    > Throwable #1: java.lang.AssertionError: nextPosition() called before nextDoc()/advance()\n[junit4:junit4]    > \tat __randomizedtesting.SeedInfo.seed([A46A143B772103ED:932787705C50F42E]:0)\n[junit4:junit4]    > \tat org.apache.lucene.index.AssertingAtomicReader$AssertingDocsAndPositionsEnum.nextPosition(AssertingAtomicReader.java:325)\n[junit4:junit4]    > \tat org.apache.lucene.search.highlight.TokenSources.hasPositions(TokenSources.java:131)\n[junit4:junit4]    > \tat org.apache.lucene.search.highlight.TokenSources.getTokenStream(TokenSources.java:170)\n[junit4:junit4]    > \tat org.apache.lucene.search.highlight.HighlighterPhraseTest.testSparseSpan(HighlighterPhraseTest.java:272)\n\n ",
            "author": "Robert Muir",
            "id": "comment-13413697"
        },
        {
            "date": "2012-07-13T13:05:00+0000",
            "content": "Attached patch with fix for highlighter.\n\nI will continue testing, I think we also need to improve the TermsEnum asserting (I added a TODO), to check where it goes past the end. ",
            "author": "Robert Muir",
            "id": "comment-13413702"
        },
        {
            "date": "2012-07-13T13:17:57+0000",
            "content": "New patch, fixing AssertingTermsEnum to track initial / past end. ",
            "author": "Michael McCandless",
            "id": "comment-13413710"
        },
        {
            "date": "2012-07-13T13:40:19+0000",
            "content": "final patch: all tests pass. Thanks Mike! ",
            "author": "Robert Muir",
            "id": "comment-13413731"
        },
        {
            "date": "2012-07-13T13:47:05+0000",
            "content": "Just as i say that:\n\nant test  -Dtestcase=TestFieldMaskingSpanQuery -Dtests.method=testNoop1 -Dtests.seed=4BB0E091C1580FE4 -Dtests.slow=true -Dtests.locale=pt_PT -Dtests.timezone=Europe/Samara -Dtests.file.encoding=US-ASCII\nant test  -Dtestcase=TestSloppyPhraseQuery -Dtests.method=testInfiniteFreq2 -Dtests.seed=4BB0E091C1580FE4 -Dtests.slow=true -Dtests.locale=uk -Dtests.timezone=Europe/Belfast -Dtests.file.encoding=US-ASCII\nant test  -Dtestcase=TestSpanExplanations -Dtests.method=testSNear8 -Dtests.seed=4BB0E091C1580FE4 -Dtests.slow=true -Dtests.locale=es_VE -Dtests.timezone=Asia/Dhaka -Dtests.file.encoding=US-ASCII\nant test  -Dtestcase=TestSimpleExplanations -Dtests.method=testMultiFieldBQofPQ4 -Dtests.seed=4BB0E091C1580FE4 -Dtests.slow=true -Dtests.locale=ar_IQ -Dtests.timezone=Asia/Kuwait -Dtests.file.encoding=US-ASCII\n...\n\n\n\nWith the latest patch. So something is up with MultiDocsAndPositionsEnum, or we have a bug depending on the reader chain... ",
            "author": "Robert Muir",
            "id": "comment-13413739"
        },
        {
            "date": "2012-07-13T13:56:40+0000",
            "content": "In AssertingDocsAndPositionsEnum.nextDoc, if super returns NO_MORE_DOCS I think you can't call freq()?\n\n(And same for DocsEnum).\n\nIe once these enums return NO_MORE_DOCS they are unpositioned and you can't call freq(), nextDoc(), nextPosition(), etc. ",
            "author": "Michael McCandless",
            "id": "comment-13413745"
        },
        {
            "date": "2012-07-13T14:01:31+0000",
            "content": "You are right: thats the bug. Ill also add asserts for this! The javadocs already document that!\n\nThe only reason this happened is because i turned off the 'always choose my wrapping-reader' to the normal\nrandom behavior, and for whatever reason newSearcher() decided to wrap Slow around AssertingReader  ",
            "author": "Robert Muir",
            "id": "comment-13413749"
        },
        {
            "date": "2012-07-13T14:07:39+0000",
            "content": "Latest patch: with all randomization turned back on, but also fixing the freq() bug, and also asserting nobody calls this stuff after NO_MORE_DOCS.\n\nBut now i found another bug, in join. I suspect it could be a bug in MultiDocsEnum or something, not returning -1 or NO_MORE_DOCS for the initial docId() before next() or advance() is called... (this would break one of BooleanScorer2's subscorers).\n\n\ncommon.test:\n    [mkdir] Created dir: /home/rmuir/workspace/lucene-trunk/lucene/build/join/test\n[junit4:junit4] <JUnit4> says hallo! Master seed: B08881265B54D7BC\n[junit4:junit4] Executing 2 suites with 2 JVMs.\n[junit4:junit4] Suite: org.apache.lucene.search.join.TestBlockJoin\n[junit4:junit4] Completed on J1 in 2.88s, 7 tests\n[junit4:junit4]  \n[junit4:junit4] Suite: org.apache.lucene.search.join.TestJoinUtil\n[junit4:junit4] FAILURE 3.42s J0 | TestJoinUtil.testMultiValueRandomJoin\n[junit4:junit4]    > Throwable #1: java.lang.AssertionError: invalid initial doc id: 76\n[junit4:junit4]    > \tat __randomizedtesting.SeedInfo.seed([B08881265B54D7BC:C1ED59C3AAE361B0]:0)\n[junit4:junit4]    > \tat org.apache.lucene.index.AssertingAtomicReader$AssertingDocsEnum.<init>(AssertingAtomicReader.java:239)\n[junit4:junit4]    > \tat org.apache.lucene.index.AssertingAtomicReader$AssertingTermsEnum.docs(AssertingAtomicReader.java:137)\n[junit4:junit4]    > \tat org.apache.lucene.search.join.TermsIncludingScoreQuery$MVInnerScorer.nextDoc(TermsIncludingScoreQuery.java:251)\n[junit4:junit4]    > \tat org.apache.lucene.search.join.TermsIncludingScoreQuery$SVInnerScorer.advance(TermsIncludingScoreQuery.java:197)\n[junit4:junit4]    > \tat org.apache.lucene.search.join.TermsIncludingScoreQuery$1.explain(TermsIncludingScoreQuery.java:104)\n[junit4:junit4]    > \tat org.apache.lucene.search.AssertingIndexSearcher$1.explain(AssertingIndexSearcher.java:63)\n[junit4:junit4]    > \tat org.apache.lucene.search.IndexSearcher.explain(IndexSearcher.java:618)\n[junit4:junit4]    > \tat org.apache.lucene.search.IndexSearcher.explain(IndexSearcher.java:599)\n[junit4:junit4]    > \tat org.apache.lucene.search.join.TestJoinUtil.executeRandomJoin(TestJoinUtil.java:349)\n[junit4:junit4]    > \tat org.apache.lucene.search.join.TestJoinUtil.testMultiValueRandomJoin(TestJoinUtil.java:243)\n[junit4:junit4]    > \tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n[junit4:junit4]    > \tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n[junit4:junit4]    > \tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n[junit4:junit4]    > \tat java.lang.reflect.Method.invoke(Method.java:597)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1995)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$1100(RandomizedRunner.java:132)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:818)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:877)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$8.evaluate(RandomizedRunner.java:891)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:50)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleFieldCacheSanity$1.evaluate(TestRuleFieldCacheSanity.java:32)\n[junit4:junit4]    > \tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleReportUncaughtExceptions$1.evaluate(TestRuleReportUncaughtExceptions.java:68)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:48)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:70)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:825)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$700(RandomizedRunner.java:132)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$3$1.run(RandomizedRunner.java:671)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$3.evaluate(RandomizedRunner.java:697)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$4.evaluate(RandomizedRunner.java:736)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:747)\n[junit4:junit4]    > \tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleReportUncaughtExceptions$1.evaluate(TestRuleReportUncaughtExceptions.java:68)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:38)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIcuHack$1.evaluate(TestRuleIcuHack.java:51)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleNoInstanceHooksOverrides$1.evaluate(TestRuleNoInstanceHooksOverrides.java:53)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleNoStaticHooksShadowing$1.evaluate(TestRuleNoStaticHooksShadowing.java:52)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:36)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:70)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:55)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSuite(RandomizedRunner.java:605)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$400(RandomizedRunner.java:132)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$2.run(RandomizedRunner.java:551)\n[junit4:junit4]    > \n[junit4:junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestJoinUtil -Dtests.method=testMultiValueRandomJoin -Dtests.seed=B08881265B54D7BC -Dtests.slow=true -Dtests.codec=Asserting -Dtests.locale=zh_CN -Dtests.timezone=Etc/GMT+8 -Dtests.file.encoding=US-ASCII\n[junit4:junit4]   2>\n[junit4:junit4] FAILURE 0.63s J0 | TestJoinUtil.testSingleValueRandomJoin\n[junit4:junit4]    > Throwable #1: java.lang.AssertionError: invalid initial doc id: 117\n[junit4:junit4]    > \tat __randomizedtesting.SeedInfo.seed([B08881265B54D7BC:5C30906CD397CB63]:0)\n[junit4:junit4]    > \tat org.apache.lucene.index.AssertingAtomicReader$AssertingDocsEnum.<init>(AssertingAtomicReader.java:239)\n[junit4:junit4]    > \tat org.apache.lucene.index.AssertingAtomicReader$AssertingTermsEnum.docs(AssertingAtomicReader.java:137)\n[junit4:junit4]    > \tat org.apache.lucene.search.join.TermsIncludingScoreQuery$SVInnerScorer.nextDoc(TermsIncludingScoreQuery.java:187)\n[junit4:junit4]    > \tat org.apache.lucene.search.join.TermsIncludingScoreQuery$SVInnerScorer.advance(TermsIncludingScoreQuery.java:197)\n[junit4:junit4]    > \tat org.apache.lucene.search.join.TermsIncludingScoreQuery$1.explain(TermsIncludingScoreQuery.java:104)\n[junit4:junit4]    > \tat org.apache.lucene.search.AssertingIndexSearcher$1.explain(AssertingIndexSearcher.java:63)\n[junit4:junit4]    > \tat org.apache.lucene.search.IndexSearcher.explain(IndexSearcher.java:618)\n[junit4:junit4]    > \tat org.apache.lucene.search.IndexSearcher.explain(IndexSearcher.java:599)\n[junit4:junit4]    > \tat org.apache.lucene.search.join.TestJoinUtil.executeRandomJoin(TestJoinUtil.java:349)\n[junit4:junit4]    > \tat org.apache.lucene.search.join.TestJoinUtil.testSingleValueRandomJoin(TestJoinUtil.java:235)\n[junit4:junit4]    > \tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n[junit4:junit4]    > \tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n[junit4:junit4]    > \tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n[junit4:junit4]    > \tat java.lang.reflect.Method.invoke(Method.java:597)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1995)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$1100(RandomizedRunner.java:132)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:818)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:877)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$8.evaluate(RandomizedRunner.java:891)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:50)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleFieldCacheSanity$1.evaluate(TestRuleFieldCacheSanity.java:32)\n[junit4:junit4]    > \tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleReportUncaughtExceptions$1.evaluate(TestRuleReportUncaughtExceptions.java:68)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:48)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:70)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:825)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$700(RandomizedRunner.java:132)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$3$1.run(RandomizedRunner.java:671)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$3.evaluate(RandomizedRunner.java:697)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$4.evaluate(RandomizedRunner.java:736)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:747)\n[junit4:junit4]    > \tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleReportUncaughtExceptions$1.evaluate(TestRuleReportUncaughtExceptions.java:68)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:38)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIcuHack$1.evaluate(TestRuleIcuHack.java:51)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleNoInstanceHooksOverrides$1.evaluate(TestRuleNoInstanceHooksOverrides.java:53)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleNoStaticHooksShadowing$1.evaluate(TestRuleNoStaticHooksShadowing.java:52)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:36)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:70)\n[junit4:junit4]    > \tat org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:55)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSuite(RandomizedRunner.java:605)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$400(RandomizedRunner.java:132)\n[junit4:junit4]    > \tat com.carrotsearch.randomizedtesting.RandomizedRunner$2.run(RandomizedRunner.java:551)\n[junit4:junit4]    > \n[junit4:junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestJoinUtil -Dtests.method=testSingleValueRandomJoin -Dtests.seed=B08881265B54D7BC -Dtests.slow=true -Dtests.codec=Asserting -Dtests.locale=zh_CN -Dtests.timezone=Etc/GMT+8 -Dtests.file.encoding=US-ASCII\n[junit4:junit4]   2>\n[junit4:junit4]    > (@AfterClass output)\n[junit4:junit4]   2> NOTE: test params are: codec=Asserting, sim=RandomSimilarityProvider(queryNorm=true,coord=true): {to=IB SPL-DZ(0.3), id=DefaultSimilarity, movieId=IB SPL-L1, price=DFR I(ne)1, description=IB LL-D3(800.0), name=DFR I(F)B3(800.0), value=DFR I(F)3(800.0), subtitle=IB LL-L1, from=DFR I(ne)Z(0.3), productId=DFR I(n)L2}, locale=zh_CN, timezone=Etc/GMT+8\n[junit4:junit4]   2> NOTE: Linux 3.2.0-24-generic amd64/Sun Microsystems Inc. 1.6.0_24 (64-bit)/cpus=8,threads=1,free=266099840,total=348258304\n[junit4:junit4]   2> NOTE: All tests run in this JVM: [TestJoinUtil]\n[junit4:junit4]   2> \n[junit4:junit4] Completed on J0 in 4.43s, 4 tests, 2 failures <<< FAILURES!\n[junit4:junit4]  \n[junit4:junit4] JVM J0:     0.30 ..     5.12 =     4.82s\n[junit4:junit4] JVM J1:     0.30 ..     3.65 =     3.36s\n[junit4:junit4] Execution time total: 5.14 sec.\n[junit4:junit4] Tests summary: 2 suites, 11 tests, 2 failures\n\n ",
            "author": "Robert Muir",
            "id": "comment-13413765"
        },
        {
            "date": "2012-07-13T14:21:41+0000",
            "content": "OK, the problem is in their reset(), doesnt reset docid back to -1.\n\nWe didnt find this in AssertingIndexSearcher, because we only check on score(), but not explain().\nIn this case the docsenums are reused.\n\nIll also add this check to AssertingIndexSearcher's explain()... ",
            "author": "Robert Muir",
            "id": "comment-13413773"
        },
        {
            "date": "2012-07-13T14:37:06+0000",
            "content": "updated patch. I think its ready for committing, finally. ",
            "author": "Robert Muir",
            "id": "comment-13413780"
        }
    ]
}