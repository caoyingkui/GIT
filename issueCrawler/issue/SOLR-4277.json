{
    "id": "SOLR-4277",
    "title": "Spellchecker sometimes falsely reports a spelling error and correction",
    "details": {
        "affect_versions": "4.0",
        "status": "Open",
        "fix_versions": [],
        "components": [
            "spellchecker"
        ],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Unresolved"
    },
    "description": "In some cases, the Solr spell checker improperly reports query terms as being misspelled.\n\nUsing the Solr example for 4.0, I added these mini documents:\n\n\ncurl http://localhost:8983/solr/update?commit=true -H 'Content-type:application/csv' -d '\nid,name\nspel-1,aardvark abacus ball bill cat cello\nspel-2,abate accord band bell cattle check\nspel-3,adorn border clean clock'\n\n\n\nI then issued this request:\n\n\ncurl \"http://localhost:8983/solr/spell/?q=check&indent=true\"\n\n\n\nThe spell checker falsely concluded that \"check\" was misspelled and improperly corrected it to \"clock\":\n\n\n<lst name=\"spellcheck\">\n  <lst name=\"suggestions\">\n    <lst name=\"check\">\n      <int name=\"numFound\">1</int>\n      <int name=\"startOffset\">0</int>\n      <int name=\"endOffset\">5</int>\n      <int name=\"origFreq\">1</int>\n      <arr name=\"suggestion\">\n        <lst>\n          <str name=\"word\">clock</str>\n          <int name=\"freq\">1</int>\n        </lst>\n      </arr>\n    </lst>\n    <bool name=\"correctlySpelled\">false</bool>\n    <lst name=\"collation\">\n      <str name=\"collationQuery\">clock</str>\n      <int name=\"hits\">1</int>\n      <lst name=\"misspellingsAndCorrections\">\n        <str name=\"check\">clock</str>\n      </lst>\n    </lst>\n  </lst>\n</lst>\n\n\n\nAnd if I query for \"clock\", it gets corrected to \"check\"!\n\n\ncurl \"http://localhost:8983/solr/spell/?q=clock&indent=true\"\n\n\n\n\n  <lst name=\"suggestions\">\n    <lst name=\"clock\">\n      <int name=\"numFound\">1</int>\n      <int name=\"startOffset\">0</int>\n      <int name=\"endOffset\">5</int>\n      <int name=\"origFreq\">1</int>\n      <arr name=\"suggestion\">\n        <lst>\n          <str name=\"word\">check</str>\n          <int name=\"freq\">1</int>\n        </lst>\n      </arr>\n    </lst>\n    <bool name=\"correctlySpelled\">false</bool>\n    <lst name=\"collation\">\n      <str name=\"collationQuery\">check</str>\n      <int name=\"hits\">1</int>\n      <lst name=\"misspellingsAndCorrections\">\n        <str name=\"clock\">check</str>\n      </lst>\n    </lst>\n  </lst>\n\n\n\nNote: This appears to be only because \"clock\" is so close to \"check\". With other terms I don't see the problem:\n\n\ncurl \"http://localhost:8983/solr/spell/?q=cattle+abate+check&indent=true\"\n\n\n\n\n  <lst name=\"suggestions\">\n    <lst name=\"check\">\n      <int name=\"numFound\">1</int>\n      <int name=\"startOffset\">13</int>\n      <int name=\"endOffset\">18</int>\n      <int name=\"origFreq\">1</int>\n      <arr name=\"suggestion\">\n        <lst>\n          <str name=\"word\">clock</str>\n          <int name=\"freq\">1</int>\n        </lst>\n      </arr>\n    </lst>\n    <bool name=\"correctlySpelled\">false</bool>\n    <lst name=\"collation\">\n      <str name=\"collationQuery\">cattle abate clock</str>\n      <int name=\"hits\">2</int>\n      <lst name=\"misspellingsAndCorrections\">\n        <str name=\"cattle\">cattle</str>\n        <str name=\"abate\">abate</str>\n        <str name=\"check\">clock</str>\n      </lst>\n    </lst>\n  </lst>\n\n\n\nAlthough, it inappropriately lists \"cattle\" and \"abate\" in the \"misspellings\" section even though no suggestions were offered.\n\nFinally, I can workaround this issue by removing the following line from solrconfig.xml:\n\n\n      <str name=\"spellcheck.alternativeTermCount\">5</str>\n\n\n\nWhich responds to the previous request with:\n\n\n  <lst name=\"suggestions\">\n    <bool name=\"correctlySpelled\">false</bool>\n  </lst>\n\n\n\nWhich makes the original problem go away. Although, it does beg the question as to why my 100% correct query is still tagged as \"correctlySpelled\" = \"false\", but that's a separate Jira.",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "author": "Jack Krupansky",
            "id": "comment-13545531",
            "date": "2013-01-07T00:09:32+0000",
            "content": "And for ironic humor, if I query for \"check clock\":\n\n\ncurl \"http://localhost:8983/solr/spell/?q=check+clock&indent=true\"\n\n\n\nI am offered three corrected queries:\n\n\n  <lst name=\"suggestions\">\n    <lst name=\"check\">\n      <int name=\"numFound\">1</int>\n      <int name=\"startOffset\">0</int>\n      <int name=\"endOffset\">5</int>\n      <int name=\"origFreq\">1</int>\n      <arr name=\"suggestion\">\n        <lst>\n          <str name=\"word\">clock</str>\n          <int name=\"freq\">1</int>\n        </lst>\n      </arr>\n    </lst>\n    <lst name=\"clock\">\n      <int name=\"numFound\">1</int>\n      <int name=\"startOffset\">6</int>\n      <int name=\"endOffset\">11</int>\n      <int name=\"origFreq\">1</int>\n      <arr name=\"suggestion\">\n        <lst>\n          <str name=\"word\">check</str>\n          <int name=\"freq\">1</int>\n        </lst>\n      </arr>\n    </lst>\n    <bool name=\"correctlySpelled\">false</bool>\n    <lst name=\"collation\">\n      <str name=\"collationQuery\">check check</str>\n      <int name=\"hits\">1</int>\n      <lst name=\"misspellingsAndCorrections\">\n        <str name=\"check\">check</str>\n        <str name=\"clock\">check</str>\n      </lst>\n    </lst>\n    <lst name=\"collation\">\n      <str name=\"collationQuery\">clock clock</str>\n      <int name=\"hits\">1</int>\n      <lst name=\"misspellingsAndCorrections\">\n        <str name=\"check\">clock</str>\n        <str name=\"clock\">clock</str>\n      </lst>\n    </lst>\n    <lst name=\"collation\">\n      <str name=\"collationQuery\">clock check</str>\n      <int name=\"hits\">2</int>\n      <lst name=\"misspellingsAndCorrections\">\n        <str name=\"check\">clock</str>\n        <str name=\"clock\">check</str>\n      </lst>\n    </lst>\n  </lst>\n\n "
        },
        {
            "author": "James Dyer",
            "id": "comment-13545976",
            "date": "2013-01-07T15:50:24+0000",
            "content": "Jack, \n\nCan you take a look at http://wiki.apache.org/solr/SpellCheckComponent#spellcheck.alternativeTermCount and also SOLR-2585.  I think at least some of what you describe is intended behavior.  For instance, if you specify \"spellcheck.alternateTermCount\", then it will try and give you suggestions for every word in the query.  The purpose being that \"alternateTermCount\" is to allow you to generate \"did-you-mean\" style suggestions.  It also helps in cases where a word is misspelled but is still a valid word in the dictionary.  (For instance, see the \"flew form Heathrow\" example in Manning's IR book section 3.3.5)\n\nI agree your humorous example with \"clock check\" is indeed quite absurd.  Perhaps we can add a feature to prevent it from reduplicating terms when generating a collation?  But keep in mind if in fact the user queried (\"6 o'clock\" check) ... or ... (+clock -check) ... or ... (foo:clock AND bar:check) ... then these corrections might indeed change the semantics of the query.  I would think that such a feature needs to be smart about these sorts of scenarios as well (much like is done when correcting Word Breaks, see SOLR-2993).\n\nShort of a new feature to prevent reduplication, the current way to avoid this from happening (most of the time) is to specify \"maxResultsForSuggest=n\".  This would mean you won't get suggestions unless your query returns n or fewer results.  Obviously this feature is hard to exercise on a very small index.\n\nAlso, if you had an index with a lot of documents and you specified \"alternateTermCount\" with \"maxResultsForSuggest>0\", then you wouldn't be getting suggestions at all unless your hit-count was below the threshold. "
        },
        {
            "author": "scott hobson",
            "id": "comment-13758364",
            "date": "2013-09-04T21:22:53+0000",
            "content": "Hi,\nI am having this same issue. The \"correctlySpelled\" flag is always false. I understand that it should still be giving suggestions for the \"did you mean...\" searches, but shouldn't the correctlySpelled flag at least be accurate? It could easily say true and still give you suggested words, and that would be even better because you can differentiate between a suggestion and a correction. Right now you cannot, unless I'm missing something... \n\nThanks,\nScott "
        }
    ]
}