{
    "id": "SOLR-3446",
    "title": "PatternSyntaxException Crash from Unvalidated Regular Expression Usage",
    "details": {
        "affect_versions": "3.5",
        "status": "Closed",
        "fix_versions": [
            "4.0-ALPHA"
        ],
        "components": [],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Fixed"
    },
    "description": "Solr sometimes crashes with an unhelpful stack trace.  If the PatternTokenizerFactory's \"pattern\" attribute is set to an invalid regular expression, a PatternSyntaxException is thrown and Solr fails to start. The PatternSyntaxException is not useful to users in diagnosing the error. I think it would be better to report a detailed error message. The attached patch makes this change.\n\nNote that the patch adds a small RegexUtil class with helper methods to determine whether a String is a valid regular expression and to generate error messages for invalid regular expressions. I feel that these helper methods are more readable than catching the PatternSyntaxException. Furthermore, they can be re-used if more bugs like this one are found.\n\nSteps to reproduce:\n\n\n\tPatch in bug.patch\n\t\n\t\tNote that this sets PatternTokenizerFactory's pattern attribute to an invalid regular expression.\n\t\n\t\n\tRun 'ant run-example' from the solr folder\n\tSee exception in console output on startup:\n\n\n\n\nApr 3, 2012 2:07:29 PM org.apache.solr.common.SolrException log\nSEVERE: java.util.regex.PatternSyntaxException: Unclosed group near index 1\n(\n ^\n       at java.util.regex.Pattern.error(Pattern.java:1713)\n       at java.util.regex.Pattern.accept(Pattern.java:1571)\n       at java.util.regex.Pattern.group0(Pattern.java:2533)\n       at java.util.regex.Pattern.sequence(Pattern.java:1806)\n       at java.util.regex.Pattern.expr(Pattern.java:1752)\n       at java.util.regex.Pattern.compile(Pattern.java:1460)\n       at java.util.regex.Pattern.<init>(Pattern.java:1133)\n       at java.util.regex.Pattern.compile(Pattern.java:847)\n       at org.apache.solr.analysis.PatternTokenizerFactory.init(PatternTokenizerFactory.java:90)\n       at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:901)\n       at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:890)\n       at org.apache.solr.util.plugin.AbstractPluginLoader.load(AbstractPluginLoader.java:148)\n       at org.apache.solr.schema.IndexSchema.readAnalyzer(IndexSchema.java:910)\n       at org.apache.solr.schema.IndexSchema.access$100(IndexSchema.java:62)\n       at org.apache.solr.schema.IndexSchema$1.create(IndexSchema.java:450)\n       at org.apache.solr.schema.IndexSchema$1.create(IndexSchema.java:435)\n       at org.apache.solr.util.plugin.AbstractPluginLoader.load(AbstractPluginLoader.java:140)\n       at org.apache.solr.schema.IndexSchema.readSchema(IndexSchema.java:480)\n       at org.apache.solr.schema.IndexSchema.<init>(IndexSchema.java:125)\n       at org.apache.solr.core.CoreContainer.create(CoreContainer.java:461)\n       at org.apache.solr.core.CoreContainer.load(CoreContainer.java:316)\n       at org.apache.solr.core.CoreContainer.load(CoreContainer.java:207)\n       at org.apache.solr.core.CoreContainer$Initializer.initialize(CoreContainer.java:130)\n       at org.apache.solr.servlet.SolrDispatchFilter.init(SolrDispatchFilter.java:94)\n       at org.mortbay.jetty.servlet.FilterHolder.doStart(FilterHolder.java:97)\n       at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)\n       at org.mortbay.jetty.servlet.ServletHandler.initialize(ServletHandler.java:713)\n       at org.mortbay.jetty.servlet.Context.startContext(Context.java:140)\n       at org.mortbay.jetty.webapp.WebAppContext.startContext(WebAppContext.java:1282)\n       at org.mortbay.jetty.handler.ContextHandler.doStart(ContextHandler.java:518)\n       at org.mortbay.jetty.webapp.WebAppContext.doStart(WebAppContext.java:499)\n       at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)\n       at org.mortbay.jetty.handler.HandlerCollection.doStart(HandlerCollection.java:152)\n       at org.mortbay.jetty.handler.ContextHandlerCollection.doStart(ContextHandlerCollection.java:156)\n       at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)\n       at org.mortbay.jetty.handler.HandlerCollection.doStart(HandlerCollection.java:152)\n       at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)\n       at org.mortbay.jetty.handler.HandlerWrapper.doStart(HandlerWrapper.java:130)\n       at org.mortbay.jetty.Server.doStart(Server.java:224)\n       at org.mortbay.component.AbstractLifeCycle.start(AbstractLifeCycle.java:50)\n       at org.mortbay.xml.XmlConfiguration.main(XmlConfiguration.java:985)\n       at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n       at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n       at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n       at java.lang.reflect.Method.invoke(Method.java:597)\n       at org.mortbay.start.Main.invokeMain(Main.java:194)\n       at org.mortbay.start.Main.start(Main.java:534)\n       at org.mortbay.start.Main.start(Main.java:441)\n       at org.mortbay.start.Main.main(Main.java:119)\n\n\n\n4. Visit http://localhost:8983/solr/admin/ and see a similar message:\n\n\nHTTP ERROR 500\n\nProblem accessing /solr/admin/. Reason:\n\n    Severe errors in solr configuration.\n\nCheck your log files for more detailed information on what may be wrong.\n\nIf you want solr to continue after configuration errors, change: \n\n <abortOnConfigurationError>false</abortOnConfigurationError>\n\nin solr.xml\n\n...\n\n-------------------------------------------------------------\njava.util.regex.PatternSyntaxException: Unclosed group near index 1\n(\n ^\n       at java.util.regex.Pattern.error(Pattern.java:1713)\n       at java.util.regex.Pattern.accept(Pattern.java:1571)\n       at java.util.regex.Pattern.group0(Pattern.java:2533)\n       at java.util.regex.Pattern.sequence(Pattern.java:1806)\n       at java.util.regex.Pattern.expr(Pattern.java:1752)\n       at java.util.regex.Pattern.compile(Pattern.java:1460)\n       at java.util.regex.Pattern.<init>(Pattern.java:1133)\n       at java.util.regex.Pattern.compile(Pattern.java:847)\n       at org.apache.solr.analysis.PatternTokenizerFactory.init(PatternTokenizerFactory.java:90)\n       at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:901)\n       at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:890)\n       at org.apache.solr.util.plugin.AbstractPluginLoader.load(AbstractPluginLoader.java:148)\n...\n\n\n\nAfter applying the patch, the following is printed to the console:\n\n\nSEVERE: org.apache.solr.common.SolrException: invalid \"pattern\" regular expression for PatternTokenizerFactory: Unclosed group near index 1\n(\n ^\n    at org.apache.solr.analysis.PatternTokenizerFactory.init(PatternTokenizerFactory.java:90)\n    at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:901)\n    at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:890)\n    at org.apache.solr.util.plugin.AbstractPluginLoader.load(AbstractPluginLoader.java:148)\n...\n\n\n\nAnd the following similar message is shown when visiting http://localhost:8983/solr/admin/ :\n\n\nHTTP ERROR 500\n\nProblem accessing /solr/admin/. Reason:\n\n    Severe errors in solr configuration.\n\nCheck your log files for more detailed information on what may be wrong.\n\nIf you want solr to continue after configuration errors, change: \n\n <abortOnConfigurationError>false</abortOnConfigurationError>\n\nin solr.xml\n\n...\n\n-------------------------------------------------------------\norg.apache.solr.common.SolrException: invalid \"pattern\" regular expression for PatternTokenizerFactory: Unclosed group near index 1\n(\n ^\n       at org.apache.solr.analysis.PatternTokenizerFactory.init(PatternTokenizerFactory.java:90)\n       at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:901)\n       at org.apache.solr.schema.IndexSchema$5.init(IndexSchema.java:890)\n       at org.apache.solr.util.plugin.AbstractPluginLoader.load(AbstractPluginLoader.java:148)\n...",
    "attachments": {
        "bug.patch": "https://issues.apache.org/jira/secure/attachment/12526083/bug.patch",
        "SOLR-3446.patch": "https://issues.apache.org/jira/secure/attachment/12526082/SOLR-3446.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "author": "Hoss Man",
            "id": "comment-13282988",
            "date": "2012-05-25T02:25:43+0000",
            "content": "\nEric: I'm not really a fan of the \"isRegex\" and \"regexError\" utilities you proposed in your patch, because they throw away info about the details of the exception, and require redundant calls to Pattern.compile in situations where it's known that Pattern.compile is going to fail.\n\nBut the crux of your bug report is spot on \u2013 PatternTokenizerFactory was dealing with the pattern init param poorly, and should have been following the model used in PatternReplaceCharFilterFactory and PatternReplaceFilterFactory \u2013 however even with those, the general plugin loading mechanism wasn't doing a very good job of drawing attention to where exactly the problem was.\n\nSo i've committed a fix that:\n\n\trefactors those three factories to use a common \"getPattern\" method in the base class\n\timproves AbstractPluginLoader to include the name of the plugin that had a problem (if known)\n\n\n\nCommitted revision 1342489.\n\nthanks for opening the bug and drawing attention to this! "
        }
    ]
}