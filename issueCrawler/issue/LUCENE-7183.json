{
    "id": "LUCENE-7183",
    "title": "JVM crash at ForUtil.readBlock",
    "details": {
        "resolution": "Unresolved",
        "affect_versions": "4.9",
        "components": [
            "core/search"
        ],
        "labels": "",
        "fix_versions": [],
        "priority": "Major",
        "status": "Open",
        "type": "Bug"
    },
    "description": "The JVM crashes occasionaly when performing IndexSearcher.search()\nDo you have any suggestions?\n\nBest Regards\nDavid\n\n\n#\n# A fatal error has been detected by the Java Runtime Environment:\n#\n#  SIGSEGV (0xb) at pc=0x00007ff64cea7bdd, pid=8645, tid=140693552637696\n#\n# JRE version: Java(TM) SE Runtime Environment (8.0_71-b15) (build 1.8.0_71-b15)\n# Java VM: Java HotSpot(TM) 64-Bit Server VM (25.71-b15 mixed mode linux-amd64 compressed oops)\n# Problematic frame:\n# J 8876 C2 org.apache.lucene.codecs.lucene41.ForUtil.readBlock(Lorg/apache/lucene/store/IndexInput;[B[I)V (130 bytes) @ 0x00007ff64cea7bdd [0x00007ff64cea7b40+0x9d]\n#\n# Failed to write core dump. Core dumps have been disabled. To enable core dumping, try \"ulimit -c unlimited\" before starting Java again\n#\n# If you would like to submit a bug report, please visit:\n#   http://bugreport.java.com/bugreport/crash.jsp\n#\n\n---------------  T H R E A D  ---------------\n\nCurrent thread (0x00007ff620073000):  JavaThread \"http-nio-8081-exec-695\" daemon [_thread_in_Java, id=31060, stack(0x00007ff5c52a2000,0x00007ff5c53a3000)]\n\nsiginfo: si_signo: 11 (SIGSEGV), si_code: 1 (SEGV_MAPERR), si_addr: 0x00007ff5cef8f848\n\nRegister to memory mapping:\n\nRAX=0x0000000756653d80 is an oop\norg.apache.lucene.codecs.lucene41.ForUtil \n - klass: 'org/apache/lucene/codecs/lucene41/ForUtil'\nRBX=0x000000000040b848 is an unknown value\nRCX=0x00007ff5ceb84000 is an unknown value\nRDX=0x00007ff5ceb84000 is an unknown value\nRSP=0x00007ff5c53a0bb0 is pointing into the stack for thread: 0x00007ff620073000\nRBP=0x00000007a3f4dd08 is an oop\norg.apache.lucene.codecs.lucene41.Lucene41PostingsReader$BlockDocsEnum \n - klass: 'org/apache/lucene/codecs/lucene41/Lucene41PostingsReader$BlockDocsEnum'\nRSI=0x0000000756653d80 is an oop\norg.apache.lucene.codecs.lucene41.ForUtil \n - klass: 'org/apache/lucene/codecs/lucene41/ForUtil'\nRDI=0x00007ff5cef8f849 is an unknown value\nR8 =0x000000000040b849 is an unknown value\nR9 =0x000000000040b849 is an unknown value\nR10=0x000000000040b848 is an unknown value\nR11=0x00000000005d52d6 is an unknown value\nR12=0x0000000000000000 is an unknown value\nR13=0x0000000000000007 is an unknown value\nR14=0x00000007a3f4e4e0 is an oop\njava.nio.DirectByteBufferR \n - klass: 'java/nio/DirectByteBufferR'\nR15=0x00007ff620073000 is a thread\n\n\nStack: [0x00007ff5c52a2000,0x00007ff5c53a3000],  sp=0x00007ff5c53a0bb0,  free space=1018k\nNative frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code)\nJ 8876 C2 org.apache.lucene.codecs.lucene41.ForUtil.readBlock(Lorg/apache/lucene/store/IndexInput;[B[I)V (130 bytes) @ 0x00007ff64cea7bdd [0x00007ff64cea7b40+0x9d]\nJ 10134 C2 org.apache.lucene.search.TermScorer.nextDoc()I (8 bytes) @ 0x00007ff64d51dd2c [0x00007ff64d51db20+0x20c]\nJ 8905 C2 org.apache.lucene.search.Weight$DefaultBulkScorer.score(Lorg/apache/lucene/search/Collector;I)Z (55 bytes) @ 0x00007ff64cc94d18 [0x00007ff64cc949c0+0x358]\nJ 12718 C2 org.apache.lucene.search.IndexSearcher.search(Ljava/util/List;Lorg/apache/lucene/search/Weight;Lorg/apache/lucene/search/Collector;)V (92 bytes) @ 0x00007ff64dbfe5ac [0x00007ff64dbfe0c0+0x4ec]\nJ 21599 C2 com.gentics.cr.lucene.autocomplete.Autocompleter.suggestWords(Lcom/gentics/cr/CRRequest;)Ljava/util/Collection; (316 bytes) @ 0x00007ff64f65b708 [0x00007ff64f65a660+0x10a8]\nJ 15153 C2 com.gentics.cr.lucene.autocomplete.AutocompleteRequestProcessor.getObjects(Lcom/gentics/cr/CRRequest;Z)Ljava/util/Collection; (28 bytes) @ 0x00007ff64dd2fa40 [0x00007ff64dd2fa00+0x40]\nJ 14318 C2 com.gentics.cr.rest.RESTSimpleContainer.processService(Lcom/gentics/cr/CRRequest;Lcom/gentics/cr/util/ContentRepositoryConfig;Ljava/util/Map;Ljava/io/OutputStream;Lcom/gentics/cr/util/response/IResponseTypeSetter;Z)V (407 bytes) @ 0x00007ff64e0aed74 [0x00007ff64e0ad860+0x1514]\nJ 14370 C2 com.gentics.cr.rest.RESTServlet.doServiceSafe(Ljavax/servlet/http/HttpServletRequest;Ljavax/servlet/http/HttpServletResponse;)V (354 bytes) @ 0x00007ff64e0d8344 [0x00007ff64e0d5940+0x2a04]\nJ 14237 C2 org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(Ljavax/servlet/ServletRequest;Ljavax/servlet/ServletResponse;)V (574 bytes) @ 0x00007ff64d6b8568 [0x00007ff64d6b7e80+0x6e8]\nJ 14237 C2 org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(Ljavax/servlet/ServletRequest;Ljavax/servlet/ServletResponse;)V (574 bytes) @ 0x00007ff64d6b7fc0 [0x00007ff64d6b7e80+0x140]\nJ 22020 C2 org.apache.catalina.core.StandardWrapperValve.invoke(Lorg/apache/catalina/connector/Request;Lorg/apache/catalina/connector/Response;)V (1414 bytes) @ 0x00007ff64c4f41c8 [0x00007ff64c4f36a0+0xb28]\nJ 15254 C2 org.apache.catalina.authenticator.AuthenticatorBase.invoke(Lorg/apache/catalina/connector/Request;Lorg/apache/catalina/connector/Response;)V (903 bytes) @ 0x00007ff64cd819f0 [0x00007ff64cd806e0+0x1310]\nJ 21449 C2 org.apache.catalina.core.StandardHostValve.invoke(Lorg/apache/catalina/connector/Request;Lorg/apache/catalina/connector/Response;)V (406 bytes) @ 0x00007ff64d36ad64 [0x00007ff64d36abc0+0x1a4]\nJ 22032 C2 org.apache.catalina.connector.CoyoteAdapter.service(Lorg/apache/coyote/Request;Lorg/apache/coyote/Response;)V (660 bytes) @ 0x00007ff64ea97964 [0x00007ff64ea97420+0x544]\nJ 22013 C2 org.apache.coyote.http11.AbstractHttp11Processor.process(Lorg/apache/tomcat/util/net/SocketWrapper;)Lorg/apache/tomcat/util/net/AbstractEndpoint$Handler$SocketState; (1102 bytes) @ 0x00007ff64f5df144 [0x00007ff64f5de940+0x804]\nJ 21897 C2 org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(Lorg/apache/tomcat/util/net/SocketWrapper;Lorg/apache/tomcat/util/net/SocketStatus;)Lorg/apache/tomcat/util/net/AbstractEndpoint$Handler$SocketState; (825 bytes) @ 0x00007ff64f6e9b8c [0x00007ff64f6e9640+0x54c]\nJ 22016 C2 org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(Ljava/nio/channels/SelectionKey;Lorg/apache/tomcat/util/net/NioEndpoint$KeyAttachment;)V (792 bytes) @ 0x00007ff64e6ed848 [0x00007ff64e6ed780+0xc8]\nJ 14471 C2 org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run()V (106 bytes) @ 0x00007ff64c074b28 [0x00007ff64c074980+0x1a8]\nJ 20138 C2 java.util.concurrent.ThreadPoolExecutor.runWorker(Ljava/util/concurrent/ThreadPoolExecutor$Worker;)V (225 bytes) @ 0x00007ff64f2327b8 [0x00007ff64f2324c0+0x2f8]\nJ 21511 C1 java.util.concurrent.ThreadPoolExecutor$Worker.run()V (9 bytes) @ 0x00007ff64d456b04 [0x00007ff64d456a00+0x104]\nJ 22048 C1 org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run()V (25 bytes) @ 0x00007ff64edee04c [0x00007ff64ededf40+0x10c]\nJ 23078 C2 java.lang.Thread.run()V (17 bytes) @ 0x00007ff64ee532ec [0x00007ff64ee532a0+0x4c]\nv  ~StubRoutines::call_stub\nV  [libjvm.so+0x68c656]  JavaCalls::call_helper(JavaValue*, methodHandle*, JavaCallArguments*, Thread*)+0x1056\nV  [libjvm.so+0x68cb61]  JavaCalls::call_virtual(JavaValue*, KlassHandle, Symbol*, Symbol*, JavaCallArguments*, Thread*)+0x321\nV  [libjvm.so+0x68d007]  JavaCalls::call_virtual(JavaValue*, Handle, KlassHandle, Symbol*, Symbol*, Thread*)+0x47\nV  [libjvm.so+0x723dc0]  thread_entry(JavaThread*, Thread*)+0xa0\nV  [libjvm.so+0xa69cff]  JavaThread::thread_main_inner()+0xdf\nV  [libjvm.so+0xa69e2c]  JavaThread::run()+0x11c\nV  [libjvm.so+0x91d918]  java_start(Thread*)+0x108\nC  [libpthread.so.0+0x7aa1]",
    "attachments": {
        "hs_err_pid7567.log": "https://issues.apache.org/jira/secure/attachment/12816198/hs_err_pid7567.log",
        "hs_err_pid22587.log": "https://issues.apache.org/jira/secure/attachment/12816199/hs_err_pid22587.log",
        "hs_err_pid8645.log": "https://issues.apache.org/jira/secure/attachment/12797281/hs_err_pid8645.log"
    },
    "issue_links": {},
    "comments": [
        {
            "id": "comment-15228177",
            "author": "Uwe Schindler",
            "date": "2016-04-06T12:22:17+0000",
            "content": "This looks like a not-yet known bug in Oracle's JVM. Please do the following:\n\n\tUpdate to Latest Java 8 (8u77 as of today)\n\tcontact Oracle support and/or open a bug report on their web page. Please mention \"Apache Lucene\".\nTo figure out what is going on, Oracle may need a reproducible testcase.\n\n\n\nI checked you command line: jvm_args: -Djava.util.logging.config.file=/opt/tomcat-search/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Xms3076m -Xmx3076m -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Djava.endorsed.dirs=/opt/tomcat-search/endorsed -Dcatalina.base=/opt/tomcat-search -Dcatalina.home=/opt/tomcat-search -Djava.io.tmpdir=/opt/tomcat-search/temp this looks fine, I was afraid that you may use some crazy JVM options (like aggressive opts or similar).\n "
        },
        {
            "id": "comment-15362634",
            "author": "David Rainer",
            "date": "2016-07-05T15:28:51+0000",
            "content": "Hi!\n\nThanks for your help.\nAnother two Sigsev again, same config, same lucene version (4.9), new java (1.8.0_91-b14) but with different problematic frames from the original problem:\norg.apache.lucene.codecs.blocktree.SegmentTermsEnumFrame.loadBlock()\n\nI reported the original problem via http://bugreport.java.com/bugreport/crash.jsp and received no answer (yet). I will report the new ones too (mentioning Apache Lucene) and keep you updated in case I get feedback.\n\nDo these cases have something in common?\nlog1 log1\n\nBest Regards\nDavid "
        },
        {
            "id": "comment-15362883",
            "author": "Uwe Schindler",
            "date": "2016-07-05T18:00:47+0000",
            "content": "Hi,\nWhat all three stack traces have in common: It looks like you are trying to search on an already closed IndexReader. Lucene tries to catch this, but under highly concurrent cases, it may happen that you try to access stuff that was already unmapped: Lucene memory maps the index into virtual address space, but forcefully unmaps this when closing indexreader. If you do this and e.g. another search is still running while closing (in another thread), the forceful unmapping will cause SIGSEGV or SIGBUS.\n\nTo debug this you can do the following:\n\n\tChange the FSDirectory implementation (which defaults to MMapDirectory) on 64 bit platforms to NIOFSDirectory. This will slow down searches, but does not have the risk of segfaults. Instead it will throw stuff like AlreadyClosedExceptions\n\tCheck your code that you don't suppress  any exceptions. It looks like your code meight do this, so you don't see the root cause (closing index while searches are running)\n\n\n\nOnce you found the bad code parts and fixed the issues in your code (closing IndexReader while searches are running), you can switch back to MMapDirectory. "
        }
    ]
}