{
    "id": "LUCENE-6998",
    "title": "We should detect truncation for all index files",
    "details": {
        "resolution": "Fixed",
        "affect_versions": "None",
        "components": [],
        "labels": "",
        "fix_versions": [
            "5.4.2",
            "5.5",
            "6.0"
        ],
        "priority": "Major",
        "status": "Closed",
        "type": "Bug"
    },
    "description": "Robert Muir noticed that Lucene60PointReader does not detect truncation of its data file on reader init ... so I added a test to catch this, confirmed it caught the bug, and fixed the bug, and fixed a couple other things uncovered by the test.\n\nI also improved the other TestAllFiles* tests to use LineFileDocs so they index points, and it caught another bug in Lucene60PointFormat (using the same codec name in two files).\n\nThere is more to do here, e.g. we also need a test that catches places where we fail to check the index header on init, which was also missing for Lucene60PointReader.",
    "attachments": {
        "LUCENE-6998.patch": "https://issues.apache.org/jira/secure/attachment/12784762/LUCENE-6998.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "id": "comment-15120328",
            "author": "Michael McCandless",
            "date": "2016-01-27T22:45:02+0000",
            "content": "Patch, I think it's close. "
        },
        {
            "id": "comment-15120346",
            "author": "Michael McCandless",
            "date": "2016-01-27T22:55:30+0000",
            "content": "Woops, first patch missed the new test ... "
        },
        {
            "id": "comment-15120352",
            "author": "Robert Muir",
            "date": "2016-01-27T22:59:33+0000",
            "content": "+1, especially for this test. These crazy ctors were \"manually stared at\" before, this is way better.\n\nafter this issue we can look at converting some of the other tests (e.g. TestIndexWriterExceptions2) to also use Points.\n\nwhen pushing can you change the comment for the new test (TestAllFilesDetectTruncation) ? "
        },
        {
            "id": "comment-15121091",
            "author": "Michael McCandless",
            "date": "2016-01-28T09:27:41+0000",
            "content": "Another iteration, I think it's ready.\n\nI added two more test cases, one of which catches the missing checkIndexHeader from Lucene60PointReader, the other one verifies that swapping in the same file name from another index into your index is always detected as corruption. "
        },
        {
            "id": "comment-15121140",
            "author": "ASF subversion and git services",
            "date": "2016-01-28T10:01:17+0000",
            "content": "Commit af3a19574e6242e1b29f2fb8861bbcc977f23435 in lucene-solr's branch refs/heads/master from Mike McCandless\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=af3a195 ]\n\nLUCENE-6998: fix a couple places to better detect truncated index files; improve corruption testing "
        },
        {
            "id": "comment-15121179",
            "author": "ASF subversion and git services",
            "date": "2016-01-28T10:31:33+0000",
            "content": "Commit 5e5a9cad9aa86555648099c262febe7a516ba48a in lucene-solr's branch refs/heads/branch_5x from Mike McCandless\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=5e5a9ca ]\n\nLUCENE-6998: fix a couple places to better detect truncated index files; improve corruption testing\n\nConflicts:\n\tlucene/core/src/java/org/apache/lucene/codecs/lucene60/Lucene60PointFormat.java\n\tlucene/core/src/java/org/apache/lucene/codecs/lucene60/Lucene60PointReader.java\n\tlucene/core/src/java/org/apache/lucene/codecs/lucene60/Lucene60PointWriter.java "
        },
        {
            "id": "comment-15121890",
            "author": "Steve Rowe",
            "date": "2016-01-28T17:01:34+0000",
            "content": "\nConflicts:\nlucene/core/src/java/org/apache/lucene/codecs/lucene60/Lucene60PointFormat.java\nlucene/core/src/java/org/apache/lucene/codecs/lucene60/Lucene60PointReader.java\nlucene/core/src/java/org/apache/lucene/codecs/lucene60/Lucene60PointWriter.java\n\nShould we worry about these?  (I haven't looked at the details.) "
        },
        {
            "id": "comment-15121901",
            "author": "Michael McCandless",
            "date": "2016-01-28T17:05:41+0000",
            "content": "Should we worry about these?\n\nThis is git being wonderfully honest (the same reason why I love the \"merge bubbles\").\n\nOn backport, git told me there were conflicts, since these files were changed in master but don't exist in 5.x (\"points\" is a 6.0 only feature).  So I removed them, and left this default commit message generated by git to preserve its honesty ....\n\nSo I don't think we need to worry  "
        },
        {
            "id": "comment-15121918",
            "author": "Steve Rowe",
            "date": "2016-01-28T17:16:41+0000",
            "content": "+1, thanks Mike "
        },
        {
            "id": "comment-15141033",
            "author": "Michael McCandless",
            "date": "2016-02-10T15:51:01+0000",
            "content": "Reopen for backport to 5.4.2. "
        },
        {
            "id": "comment-15141095",
            "author": "ASF subversion and git services",
            "date": "2016-02-10T16:27:39+0000",
            "content": "Commit df30bc6c5b4855fcd95c3660fdd2991d0e9c58bf in lucene-solr's branch refs/heads/branch_5_4 from Mike McCandless\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=df30bc6 ]\n\nLUCENE-6998: fix a couple places to better detect truncated index files; improve corruption testing\n\nConflicts:\n\tlucene/core/src/java/org/apache/lucene/codecs/lucene60/Lucene60PointFormat.java\n\tlucene/core/src/java/org/apache/lucene/codecs/lucene60/Lucene60PointReader.java\n\tlucene/core/src/java/org/apache/lucene/codecs/lucene60/Lucene60PointWriter.java\n\nConflicts:\n\tlucene/CHANGES.txt "
        }
    ]
}