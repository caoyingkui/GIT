{
    "id": "LUCENE-7352",
    "title": "TestSimpleExplanationsWithFillerDocs failures",
    "details": {
        "resolution": "Fixed",
        "affect_versions": "7.0",
        "components": [
            "core/search"
        ],
        "labels": "",
        "fix_versions": [
            "6.2",
            "7.0"
        ],
        "priority": "Major",
        "status": "Closed",
        "type": "Bug"
    },
    "description": "Policeman Jenkins found reproducible testDMQ8() and testDMQ9() failures on master http://jenkins.thetaphi.de/job/Lucene-Solr-master-Linux/17037/:\n\n\nChecking out Revision ece9d85cbea962fd7d327010f1ba184cefdfa8ed (refs/remotes/origin/master)\n[...]\n[junit4] Suite: org.apache.lucene.search.TestSimpleExplanationsWithFillerDocs\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestSimpleExplanationsWithFillerDocs -Dtests.method=testDMQ8 -Dtests.seed=882B619046E7216B -Dtests.multiplier=3 -Dtests.slow=true -Dtests.locale=fo -Dtests.timezone=Asia/Ashgabat -Dtests.asserts=true -Dtests.file.encoding=US-ASCII\n   [junit4] FAILURE 0.10s J2 | TestSimpleExplanationsWithFillerDocs.testDMQ8 <<<\n   [junit4]    > Throwable #1: junit.framework.AssertionFailedError: (+((field:yy (field:w5)^100.0) | (field:xx)^100000.0)~0.5 -extra:extra) NEVER:MATCH: score(doc=713)=-1.9956312E-6 != explanationScore=-3.9912625E-6 Explanation: -3.9912625E-6 = sum of:\n   [junit4]    >   -3.9912625E-6 = weight(field:w5 in 713) [RandomSimilarity], result of:\n   [junit4]    >     -3.9912625E-6 = score(IBSimilarity, doc=713, freq=1.0), computed from:\n   [junit4]    >       100.0 = boost\n   [junit4]    >       0.0 = NormalizationH2, computed from: \n   [junit4]    >         1.0 = tf\n   [junit4]    >         5.502638 = avgFieldLength\n   [junit4]    >         5.6493154E19 = len\n   [junit4]    >       0.2533109 = LambdaTTF, computed from: \n   [junit4]    >         2256.0 = totalTermFreq\n   [junit4]    >         8909.0 = numberOfDocuments\n   [junit4]    >       -3.9912624E-8 = DistributionSPL\n   [junit4]    >  expected:<-1.9956312E-6> but was:<-3.9912625E-6>\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([882B619046E7216B:D4118BC551735775]:0)\n   [junit4]    > \tat junit.framework.Assert.fail(Assert.java:50)\n   [junit4]    > \tat junit.framework.Assert.failNotEquals(Assert.java:287)\n   [junit4]    > \tat junit.framework.Assert.assertEquals(Assert.java:120)\n   [junit4]    > \tat org.apache.lucene.search.CheckHits.verifyExplanation(CheckHits.java:338)\n   [junit4]    > \tat org.apache.lucene.search.CheckHits.verifyExplanation(CheckHits.java:358)\n   [junit4]    > \tat org.apache.lucene.search.CheckHits.verifyExplanation(CheckHits.java:358)\n   [junit4]    > \tat org.apache.lucene.search.CheckHits.verifyExplanation(CheckHits.java:358)\n   [junit4]    > \tat org.apache.lucene.search.CheckHits$ExplanationAsserter.collect(CheckHits.java:501)\n   [junit4]    > \tat org.apache.lucene.search.AssertingLeafCollector.collect(AssertingLeafCollector.java:52)\n   [junit4]    > \tat org.apache.lucene.search.AssertingCollector$1.collect(AssertingCollector.java:56)\n   [junit4]    > \tat org.apache.lucene.search.AssertingLeafCollector.collect(AssertingLeafCollector.java:52)\n   [junit4]    > \tat org.apache.lucene.search.AssertingLeafCollector.collect(AssertingLeafCollector.java:52)\n   [junit4]    > \tat org.apache.lucene.search.Weight$DefaultBulkScorer.scoreRange(Weight.java:196)\n   [junit4]    > \tat org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:183)\n   [junit4]    > \tat org.apache.lucene.search.AssertingBulkScorer.score(AssertingBulkScorer.java:79)\n   [junit4]    > \tat org.apache.lucene.search.ReqExclBulkScorer.score(ReqExclBulkScorer.java:48)\n   [junit4]    > \tat org.apache.lucene.search.BulkScorer.score(BulkScorer.java:39)\n   [junit4]    > \tat org.apache.lucene.search.AssertingBulkScorer.score(AssertingBulkScorer.java:69)\n   [junit4]    > \tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:669)\n   [junit4]    > \tat org.apache.lucene.search.AssertingIndexSearcher.search(AssertingIndexSearcher.java:91)\n   [junit4]    > \tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:473)\n   [junit4]    > \tat org.apache.lucene.search.CheckHits.checkExplanations(CheckHits.java:310)\n   [junit4]    > \tat org.apache.lucene.search.QueryUtils.checkExplanations(QueryUtils.java:104)\n   [junit4]    > \tat org.apache.lucene.search.QueryUtils.check(QueryUtils.java:132)\n   [junit4]    > \tat org.apache.lucene.search.QueryUtils.check(QueryUtils.java:128)\n   [junit4]    > \tat org.apache.lucene.search.QueryUtils.check(QueryUtils.java:118)\n   [junit4]    > \tat org.apache.lucene.search.CheckHits.checkHitCollector(CheckHits.java:98)\n   [junit4]    > \tat org.apache.lucene.search.BaseExplanationTestCase.qtest(BaseExplanationTestCase.java:114)\n   [junit4]    > \tat org.apache.lucene.search.TestSimpleExplanationsWithFillerDocs.qtest(TestSimpleExplanationsWithFillerDocs.java:113)\n   [junit4]    > \tat org.apache.lucene.search.TestSimpleExplanations.testDMQ8(TestSimpleExplanations.java:182)\n   [junit4]    > \tat jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(java.base@9-ea/Native Method)\n   [junit4]    > \tat jdk.internal.reflect.NativeMethodAccessorImpl.invoke(java.base@9-ea/NativeMethodAccessorImpl.java:62)\n   [junit4]    > \tat jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(java.base@9-ea/DelegatingMethodAccessorImpl.java:43)\n   [junit4]    > \tat java.lang.Thread.run(java.base@9-ea/Thread.java:843)\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestSimpleExplanationsWithFillerDocs -Dtests.method=testDMQ9 -Dtests.seed=882B619046E7216B -Dtests.multiplier=3 -Dtests.slow=true -Dtests.locale=fo -Dtests.timezone=Asia/Ashgabat -Dtests.asserts=true -Dtests.file.encoding=US-ASCII\n   [junit4] FAILURE 0.09s J2 | TestSimpleExplanationsWithFillerDocs.testDMQ9 <<<\n   [junit4]    > Throwable #1: junit.framework.AssertionFailedError: (+((field:yy (field:w5)^100.0) | (field:xx)^0.0)~0.5 -extra:extra) NEVER:MATCH: score(doc=713)=-1.9956312E-6 != explanationScore=-3.9912625E-6 Explanation: -3.9912625E-6 = sum of:\n   [junit4]    >   -3.9912625E-6 = weight(field:w5 in 713) [RandomSimilarity], result of:\n   [junit4]    >     -3.9912625E-6 = score(IBSimilarity, doc=713, freq=1.0), computed from:\n   [junit4]    >       100.0 = boost\n   [junit4]    >       0.0 = NormalizationH2, computed from: \n   [junit4]    >         1.0 = tf\n   [junit4]    >         5.502638 = avgFieldLength\n   [junit4]    >         5.6493154E19 = len\n   [junit4]    >       0.2533109 = LambdaTTF, computed from: \n   [junit4]    >         2256.0 = totalTermFreq\n   [junit4]    >         8909.0 = numberOfDocuments\n   [junit4]    >       -3.9912624E-8 = DistributionSPL\n   [junit4]    >  expected:<-1.9956312E-6> but was:<-3.9912625E-6>\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([882B619046E7216B:15279865D6AD44BE]:0)\n   [junit4]    > \tat junit.framework.Assert.fail(Assert.java:50)\n   [junit4]    > \tat junit.framework.Assert.failNotEquals(Assert.java:287)\n   [junit4]    > \tat junit.framework.Assert.assertEquals(Assert.java:120)\n   [junit4]    > \tat org.apache.lucene.search.CheckHits.verifyExplanation(CheckHits.java:338)\n   [junit4]    > \tat org.apache.lucene.search.CheckHits.verifyExplanation(CheckHits.java:358)\n   [junit4]    > \tat org.apache.lucene.search.CheckHits.verifyExplanation(CheckHits.java:358)\n   [junit4]    > \tat org.apache.lucene.search.CheckHits.verifyExplanation(CheckHits.java:358)\n   [junit4]    > \tat org.apache.lucene.search.CheckHits$ExplanationAsserter.collect(CheckHits.java:501)\n   [junit4]    > \tat org.apache.lucene.search.AssertingLeafCollector.collect(AssertingLeafCollector.java:52)\n   [junit4]    > \tat org.apache.lucene.search.AssertingCollector$1.collect(AssertingCollector.java:56)\n   [junit4]    > \tat org.apache.lucene.search.AssertingLeafCollector.collect(AssertingLeafCollector.java:52)\n   [junit4]    > \tat org.apache.lucene.search.AssertingLeafCollector.collect(AssertingLeafCollector.java:52)\n   [junit4]    > \tat org.apache.lucene.search.AssertingLeafCollector.collect(AssertingLeafCollector.java:52)\n   [junit4]    > \tat org.apache.lucene.search.Weight$DefaultBulkScorer.scoreRange(Weight.java:196)\n   [junit4]    > \tat org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:183)\n   [junit4]    > \tat org.apache.lucene.search.AssertingBulkScorer.score(AssertingBulkScorer.java:79)\n   [junit4]    > \tat org.apache.lucene.search.ReqExclBulkScorer.score(ReqExclBulkScorer.java:48)\n   [junit4]    > \tat org.apache.lucene.search.AssertingBulkScorer.score(AssertingBulkScorer.java:79)\n   [junit4]    > \tat org.apache.lucene.search.AssertingBulkScorer.score(AssertingBulkScorer.java:63)\n   [junit4]    > \tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:669)\n   [junit4]    > \tat org.apache.lucene.search.AssertingIndexSearcher.search(AssertingIndexSearcher.java:91)\n   [junit4]    > \tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:473)\n   [junit4]    > \tat org.apache.lucene.search.CheckHits.checkExplanations(CheckHits.java:310)\n   [junit4]    > \tat org.apache.lucene.search.QueryUtils.checkExplanations(QueryUtils.java:104)\n   [junit4]    > \tat org.apache.lucene.search.QueryUtils.check(QueryUtils.java:132)\n   [junit4]    > \tat org.apache.lucene.search.QueryUtils.check(QueryUtils.java:128)\n   [junit4]    > \tat org.apache.lucene.search.QueryUtils.check(QueryUtils.java:118)\n   [junit4]    > \tat org.apache.lucene.search.CheckHits.checkHitCollector(CheckHits.java:98)\n   [junit4]    > \tat org.apache.lucene.search.BaseExplanationTestCase.qtest(BaseExplanationTestCase.java:114)\n   [junit4]    > \tat org.apache.lucene.search.TestSimpleExplanationsWithFillerDocs.qtest(TestSimpleExplanationsWithFillerDocs.java:113)\n   [junit4]    > \tat org.apache.lucene.search.TestSimpleExplanations.testDMQ9(TestSimpleExplanations.java:197)\n   [junit4]    > \tat jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(java.base@9-ea/Native Method)\n   [junit4]    > \tat jdk.internal.reflect.NativeMethodAccessorImpl.invoke(java.base@9-ea/NativeMethodAccessorImpl.java:62)\n   [junit4]    > \tat jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(java.base@9-ea/DelegatingMethodAccessorImpl.java:43)\n   [junit4]    > \tat java.lang.Thread.run(java.base@9-ea/Thread.java:843)\n   [junit4]   2> NOTE: test params are: codec=FastCompressingStoredFields(storedFieldsFormat=CompressingStoredFieldsFormat(compressionMode=FAST, chunkSize=8, maxDocsPerChunk=101, blockSize=5), termVectorsFormat=CompressingTermVectorsFormat(compressionMode=FAST, chunkSize=8, blockSize=5)), sim=RandomSimilarity(queryNorm=true,coord=no): {field=IB SPL-L2, NEVER=DFR I(ne)BZ(0.3), alt=IB SPL-L1}, locale=fo, timezone=Asia/Ashgabat\n   [junit4]   2> NOTE: Linux 4.4.0-24-generic i386/Oracle Corporation 9-ea (32-bit)/cpus=12,threads=1,free=25879888,total=112373760",
    "attachments": {
        "LUCENE-7352.patch": "https://issues.apache.org/jira/secure/attachment/12812751/LUCENE-7352.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "id": "comment-15344963",
            "author": "Steve Rowe",
            "date": "2016-06-22T18:43:02+0000",
            "content": "This suite was added under LUCENE-7132.\u0010 "
        },
        {
            "id": "comment-15345887",
            "author": "Adrien Grand",
            "date": "2016-06-23T06:34:51+0000",
            "content": "I am looking into it. It does not seem to be related to BS1 this time since the test still fails when I disable BS1. "
        },
        {
            "id": "comment-15345983",
            "author": "Adrien Grand",
            "date": "2016-06-23T07:41:38+0000",
            "content": "This is a test bug. CheckHits assumes that if there is a single sub explanation, then its value is necessarily the same as the parent explanation. This fails with dismax when there is a single sub that produces a negative score since in that case it uses 0 as a max score and multiplies the score with the tie breaker factor. "
        },
        {
            "id": "comment-15346143",
            "author": "Michael McCandless",
            "date": "2016-06-23T09:21:13+0000",
            "content": "+1\n\nThank you for digging Adrien Grand! "
        },
        {
            "id": "comment-15346767",
            "author": "ASF subversion and git services",
            "date": "2016-06-23T17:05:14+0000",
            "content": "Commit c5defadd70a9f91bc31012b7c31c39f16d883849 in lucene-solr's branch refs/heads/branch_6x from Adrien Grand\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=c5defad ]\n\nLUCENE-7352: Fix CheckHits for DisjunctionMax queries that generate negative scores. "
        },
        {
            "id": "comment-15346768",
            "author": "ASF subversion and git services",
            "date": "2016-06-23T17:05:15+0000",
            "content": "Commit 1e4d51f4085664ef073ecac18dd572b0a9a02757 in lucene-solr's branch refs/heads/master from Adrien Grand\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=1e4d51f ]\n\nLUCENE-7352: Fix CheckHits for DisjunctionMax queries that generate negative scores. "
        },
        {
            "id": "comment-15439000",
            "author": "Michael McCandless",
            "date": "2016-08-26T13:59:36+0000",
            "content": "Bulk close resolved issues after 6.2.0 release. "
        }
    ]
}