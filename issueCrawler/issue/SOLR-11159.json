{
    "id": "SOLR-11159",
    "title": "Facet buckets count missing after passing {refine:true} | SOLR-7542",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [
            "Facet Module"
        ],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "None",
        "resolution": "Not A Bug",
        "status": "Resolved"
    },
    "description": "I was experimenting / analysing the new Refinement feature in JSON Facet Apis introduced in SOLR-7452. Passing refine:true with the facet definition.\n\nI am listing down the test-scenarios along with test-data:\n\n3 sharded collection on 3 nodes\nnode/shard:          bucketVal - count\n\n8987:       C - 1\n8983:       C - 4       D - 1       E - 1       A - 1\n8985:       E - 2       A - 1       D - 1\n\nTotal: BUCKETS\nC - 5       E - 3       D - 2       A - 2\n\nIt is giving accurate results for COUNT ASC, LIMIT 1 - 4\n\ncurl http://localhost:8983/solr/collection1/select -d 'q=*:*&json.facet={cat_s:{type:terms,field:cat_s,sort:\"count asc\",limit:1,overrequest:0,refine:true}}&wt=json&indent=true'\n\n\n\n  \"facets\":{\n    \"count\":12,\n    \"cat_s\":{\n      \"buckets\":[{\n          \"val\":\"A\",\n          \"count\":2}]}}}\n\n\n\ncurl http://localhost:8983/solr/collection1/select -d 'q=*:*&json.facet={cat_s:{type:terms,field:cat_s,sort:\"count asc\",limit:2,overrequest:0,refine:true}}&wt=json&indent=true'\n\n\n\n  \"facets\":{\n    \"count\":12,\n    \"cat_s\":{\n      \"buckets\":[{\n          \"val\":\"A\",\n          \"count\":2},\n        {\n          \"val\":\"D\",\n          \"count\":2}]}}}\n\n\n\nBUT, COUNT DESC, LIMIT 2 and 3\n\n\ncurl http://localhost:8983/solr/collection1/select -d 'q=*:*&json.facet={cat_s:{type:terms,field:cat_s,sort:\"count desc\",limit:2,overrequest:0,refine:true}}&wt=json&indent=true'\n\n\n\n  \"facets\":{\n    \"count\":12,\n    \"cat_s\":{\n      \"buckets\":[{\n          \"val\":\"C\",\n          \"count\":5},\n        {\n          \"val\":\"A\",\n          \"count\":2}]}}}\n\n\n\ncurl http://localhost:8983/solr/collection1/select -d 'q=*:*&json.facet={cat_s:{type:terms,field:cat_s,sort:\"count desc\",limit:3,overrequest:0,refine:true}}&wt=json&indent=true'\n\n\n\n  \"facets\":{\n    \"count\":12,\n    \"cat_s\":{\n      \"buckets\":[{\n          \"val\":\"C\",\n          \"count\":5},\n        {\n          \"val\":\"A\",\n          \"count\":2},\n        {\n          \"val\":\"D\",\n          \"count\":2}]}}}\n\n\n\nbucketVal E and its count 3 is not in facet response Pardon me if I am missing some configuration or this behavior is right / justified. Ideally we should see bucketVal E and its count 3.\n\nI am attaching Index DOCS, debugQuery for COUNT DESC, LIMIT 2 and LIMIT 3.",
    "attachments": {
        "DOCS": "https://issues.apache.org/jira/secure/attachment/12879180/DOCS",
        "COUNT_DESC_LIMIT_3": "https://issues.apache.org/jira/secure/attachment/12879181/COUNT_DESC_LIMIT_3",
        "COUNT_DESC_LIMIT_2": "https://issues.apache.org/jira/secure/attachment/12879182/COUNT_DESC_LIMIT_2"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2017-07-27T15:39:50+0000",
            "content": "Some of my observations from debugQuery,\n\nHere's how per shard request is made for various purposes COUNT DEC, LIMIT 2 :\n\n1st request:\n\n          \"Response\":\"{responseHeader={zkConnected=true,status=0,QTime=2826,params={df=_text_,distrib=false,debug=[false, timing, track],_facet_={},fl=[id, score],shards.purpose=1048580,start=0,fsv=true,shard.url=http://127.0.0.1:8983/solr/collection1_shard3_replica_n4/,rows=10,rid=127.0.0.1-collection1_shard3_replica_n4-1501147655592-0,version=2,q=*:*,json.facet={cat_s:{type:terms,field:cat_s,sort:\\\"count desc\\\",limit:2,overrequest:0,refine:true}},requestPurpose=GET_TOP_IDS,NOW=1501147655590,isShard=true,wt=javabin,debugQuery=false}},response={numFound=1,start=0,maxScore=1.0,docs=[SolrDocument{id=5, score=1.0}]},sort_values={},facets={count=1,cat_s={buckets=[{val=C,count=1}]}},debug={facet-trace={processor=FacetQueryProcessor,elapse=2644,query=null,domainSize=1,sub-facet=[{processor=FacetFieldProcessorByArrayDV,elapse=1632,field=cat_s,limit=2,numBuckets=1,domainSize=1}]},json={facet={cat_s={type=terms, field=cat_s, sort=count desc, limit=2, overrequest=0, refine=true}}},timing={time=2817.0,prepare={time=7.0,query={time=1.0},facet={time=0.0},facet_module={time=6.0},mlt={time=0.0},highlight={time=0.0},stats={time=0.0},expand={time=0.0},terms={time=0.0},debug={time=0.0}},process={time=2741.0,query={time=0.0},facet={time=0.0},facet_module={time=2665.0},mlt={time=0.0},highlight={time=0.0},stats={time=0.0},expand={time=0.0},terms={time=0.0},debug={time=0.0}}}}}\"},\n\n\n2nd request:\n\n          \"Response\":\"{responseHeader={zkConnected=true,status=0,QTime=2828,params={df=_text_,distrib=false,debug=[false, timing, track],_facet_={},fl=[id, score],shards.purpose=1048580,start=0,fsv=true,shard.url=http://127.0.0.1:8983/solr/collection1_shard2_replica_n2/,rows=10,rid=127.0.0.1-collection1_shard3_replica_n4-1501147655592-0,version=2,q=*:*,json.facet={cat_s:{type:terms,field:cat_s,sort:\\\"count desc\\\",limit:2,overrequest:0,refine:true}},requestPurpose=GET_TOP_IDS,NOW=1501147655590,isShard=true,wt=javabin,debugQuery=false}},response={numFound=7,start=0,maxScore=1.0,docs=[SolrDocument{id=2, score=1.0}, SolrDocument{id=4, score=1.0}, SolrDocument{id=3, score=1.0}, SolrDocument{id=6, score=1.0}, SolrDocument{id=9, score=1.0}, SolrDocument{id=12, score=1.0}, SolrDocument{id=15, score=1.0}]},sort_values={},facets={count=7,cat_s={buckets=[{val=C,count=4}, {val=A,count=1}]}},debug={facet-trace={processor=FacetQueryProcessor,elapse=2090,query=null,domainSize=7,sub-facet=[{processor=FacetFieldProcessorByArrayDV,elapse=1098,field=cat_s,limit=2,numBuckets=4,domainSize=7}]},json={facet={cat_s={type=terms, field=cat_s, sort=count desc, limit=2, overrequest=0, refine=true}}},timing={time=2819.0,prepare={time=619.0,query={time=0.0},facet={time=0.0},facet_module={time=615.0},mlt={time=0.0},highlight={time=0.0},stats={time=0.0},expand={time=0.0},terms={time=0.0},debug={time=0.0}},process={time=2192.0,query={time=20.0},facet={time=0.0},facet_module={time=2095.0},mlt={time=0.0},highlight={time=0.0},stats={time=0.0},expand={time=0.0},terms={time=0.0},debug={time=74.0}}}}}\"}\n\n\n3rd request:\n\n          \"Response\":\"{responseHeader={zkConnected=true,status=0,QTime=3231,params={df=_text_,distrib=false,debug=[false, timing, track],_facet_={},fl=[id, score],shards.purpose=1048580,start=0,fsv=true,shard.url=http://127.0.0.1:8983/solr/collection1_shard1_replica_n1/,rows=10,rid=127.0.0.1-collection1_shard3_replica_n4-1501147655592-0,version=2,q=*:*,json.facet={cat_s:{type:terms,field:cat_s,sort:\\\"count desc\\\",limit:2,overrequest:0,refine:true}},requestPurpose=GET_TOP_IDS,NOW=1501147655590,isShard=true,wt=javabin,debugQuery=false}},response={numFound=4,start=0,maxScore=1.0,docs=[SolrDocument{id=1, score=1.0}, SolrDocument{id=8, score=1.0}, SolrDocument{id=10, score=1.0}, SolrDocument{id=0, score=1.0}]},sort_values={},facets={count=4,cat_s={buckets=[{val=E,count=2}, {val=A,count=1}]}},debug={facet-trace={processor=FacetQueryProcessor,elapse=1519,query=null,domainSize=4,sub-facet=[{processor=FacetFieldProcessorByArrayDV,elapse=997,field=cat_s,limit=2,numBuckets=3,domainSize=4}]},json={facet={cat_s={type=terms, field=cat_s, sort=count desc, limit=2, overrequest=0, refine=true}}},timing={time=2258.0,prepare={time=14.0,query={time=0.0},facet={time=0.0},facet_module={time=5.0},mlt={time=0.0},highlight={time=0.0},stats={time=0.0},expand={time=0.0},terms={time=0.0},debug={time=0.0}},process={time=2162.0,query={time=0.0},facet={time=0.0},facet_module={time=1650.0},mlt={time=1.0},highlight={time=0.0},stats={time=0.0},expand={time=0.0},terms={time=86.0},debug={time=2.0}}}}}\"}}\n\n\n4th request: REFINE DEF Included SHARD-3\n\n          \"Response\":\"{responseHeader={zkConnected=true,status=0,QTime=34533,params={df=_text_,distrib=false,debug=[false, timing, track],_facet_={\\\"refine\\\":{\\\"cat_s\\\":{\\\"_l\\\":[\\\"A\\\"]}}},shards.purpose=2097152,shard.url=http://127.0.0.1:8983/solr/collection1_shard3_replica_n4/,rows=0,rid=127.0.0.1-collection1_shard3_replica_n4-1501147655592-0,version=2,q=*:*,json.facet={cat_s:{type:terms,field:cat_s,sort:\\\"count desc\\\",limit:2,overrequest:0,refine:true}},requestPurpose=Unknown,NOW=1501147655590,isShard=true,facet=false,wt=javabin,debugQuery=false}},response={numFound=1,start=0,docs=[]},facets={cat_s={buckets=[{val=A,count=0}]}},debug={facet-trace={processor=FacetQueryProcessor,elapse=5027,query=null,domainSize=1,sub-facet=[{processor=FacetFieldProcessorByArrayDV,elapse=21,field=cat_s,limit=2,domainSize=1}]},json={facet={cat_s={type=terms, field=cat_s, sort=count desc, limit=2, overrequest=0, refine=true}}},timing={time=34427.0,prepare={time=3248.0,query={time=3.0},facet={time=0.0},facet_module={time=3244.0},mlt={time=0.0},highlight={time=0.0},stats={time=0.0},expand={time=0.0},terms={time=0.0},debug={time=0.0}},process={time=28945.0,query={time=0.0},facet={time=0.0},facet_module={time=5038.0},mlt={time=0.0},highlight={time=0.0},stats={time=0.0},expand={time=23903.0},terms={time=0.0},debug={time=0.0}}}}}\"},\n\n\n5th request:\n\n          \"Response\":\"{responseHeader={zkConnected=true,status=0,QTime=35712,params={df=_text_,distrib=false,debug=[true, timing, track],shards.purpose=320,shard.url=http://127.0.0.1:8983/solr/collection1_shard2_replica_n2/,rows=10,rid=127.0.0.1-collection1_shard3_replica_n4-1501147655592-0,version=2,q=*:*,json.facet={cat_s:{type:terms,field:cat_s,sort:\\\"count desc\\\",limit:2,overrequest:0,refine:true}},requestPurpose=GET_FIELDS,GET_DEBUG,NOW=1501147655590,ids=12,2,3,4,6,9,isShard=true,wt=javabin,debugQuery=true}},response={numFound=6,start=0,docs=[SolrDocument{id=12, cat_s=C, add_s=E-A, _version_=1573992355678126080}, SolrDocument{id=2, cat_s=C, add_s=D-A, _version_=1573992355673931776}, SolrDocument{id=3, cat_s=E, add_s=C-A, _version_=1573992355674980353}, SolrDocument{id=4, cat_s=D, add_s=B-A, _version_=1573992355673931777}, SolrDocument{id=6, cat_s=C, add_s=E-A, _version_=1573992355676028928}, SolrDocument{id=9, cat_s=A, add_s=C-A, _version_=1573992355676028929}]},debug={rawquerystring=*:*,querystring=*:*,parsedquery=MatchAllDocsQuery(*:*),parsedquery_toString=*:*,explain={12=\\n1.0 = *:*\\n,2=\\n1.0 = *:*\\n,3=\\n1.0 = *:*\\n,4=\\n1.0 = *:*\\n,6=\\n1.0 = *:*\\n,9=\\n1.0 = *:*\\n},json={facet={cat_s={type=terms, field=cat_s, sort=count desc, limit=2, overrequest=0, refine=true}}},QParser=LuceneQParser,timing={time=35611.0,prepare={time=10.0,query={time=3.0},facet={time=0.0},facet_module={time=3.0},mlt={time=0.0},highlight={time=0.0},stats={time=0.0},expand={time=0.0},terms={time=0.0},debug={time=0.0}},process={time=35544.0,query={time=2172.0},facet={time=0.0},facet_module={time=0.0},mlt={time=0.0},highlight={time=0.0},stats={time=0.0},expand={time=0.0},terms={time=0.0},debug={time=33370.0}}}}}\"},\n        \"http://127.0.0.1:8983/solr/collection1_shard1_replica_n1/\n\n\n6th Request: REFINE DEF Included SHARD-1\n\n          \"Response\":\"{responseHeader={zkConnected=true,status=0,QTime=38962,params={df=_text_,distrib=false,debug=[true, timing, track],_facet_={\\\"refine\\\":{\\\"cat_s\\\":{\\\"_l\\\":[\\\"C\\\"]}}},shards.purpose=2097472,shard.url=http://127.0.0.1:8983/solr/collection1_shard1_replica_n1/,rows=10,rid=127.0.0.1-collection1_shard3_replica_n4-1501147655592-0,version=2,q=*:*,json.facet={cat_s:{type:terms,field:cat_s,sort:\\\"count desc\\\",limit:2,overrequest:0,refine:true}},requestPurpose=GET_FIELDS,GET_DEBUG,NOW=1501147655590,ids=0,1,8,10,isShard=true,wt=javabin,debugQuery=true}},response={numFound=4,start=0,docs=[SolrDocument{id=0, cat_s=E, add_s=B-A, _version_=1573992355692806144}, SolrDocument{id=1, cat_s=E, add_s=E-A, _version_=1573992355690708992}, SolrDocument{id=8, cat_s=A, add_s=C-A, _version_=1573992355691757568}, SolrDocument{id=10, cat_s=D, add_s=E-A, _version_=1573992355691757569}]},facets={cat_s={buckets=[{val=C,count=0}]}},debug={rawquerystring=*:*,querystring=*:*,parsedquery=MatchAllDocsQuery(*:*),parsedquery_toString=*:*,explain={0=\\n1.0 = *:*\\n,1=\\n1.0 = *:*\\n,8=\\n1.0 = *:*\\n,10=\\n1.0 = *:*\\n},facet-trace={processor=FacetQueryProcessor,elapse=35906,query=null,domainSize=4,sub-facet=[{processor=FacetFieldProcessorByArrayDV,elapse=35897,field=cat_s,limit=2,domainSize=4}]},json={facet={cat_s={type=terms, field=cat_s, sort=count desc, limit=2, overrequest=0, refine=true}}},QParser=LuceneQParser,timing={time=38253.0,prepare={time=2228.0,query={time=0.0},facet={time=0.0},facet_module={time=2227.0},mlt={time=0.0},highlight={time=0.0},stats={time=0.0},expand={time=0.0},terms={time=0.0},debug={time=0.0}},process={time=36015.0,query={time=97.0},facet={time=0.0},facet_module={time=35913.0},mlt={time=0.0},highlight={time=0.0},stats={time=0.0},expand={time=0.0},terms={time=0.0},debug={time=4.0}}}}}\"}}\n\n\n\nThe REFINED attributes, leaves, partial or skip buckets did not get attached to SHARD-2 in 5th request listed above. While in COUNT ASC, in almost all possible LIMIT values, REFINED attributes are getting attached to all the SHARD requests, (4th-6th requests).  ",
            "author": "Amrit Sarkar",
            "id": "comment-16103359"
        },
        {
            "date": "2017-07-27T16:00:11+0000",
            "content": "I don't see any incorrect bucket counts, just a missing value of \"E\"?\n\nRefinement works like the following:\nphase 1) collect the top N buckets from each shard and find the global \"top N\" buckets\nphase 2) correct the counts of this global \"top N\" by requesting counts from shards that didn't provide a value for each bucket\n\nSo while we guarantee correct counts, we don't guarantee that a value is missed altogether.\nTo increase the chances that we get the true global top N, we normally overrequest on phase 1.  But in your example, you explicitly disabled overrequest.\n\nTo fix, simply remove the \"overrequest:0\" part of your request.\nFor other requests, you can increase this number to reduce or eliminate the chance of missing buckets. ",
            "author": "Yonik Seeley",
            "id": "comment-16103386"
        },
        {
            "date": "2017-07-27T16:11:27+0000",
            "content": "Thank you so much Yonik Seeley, I was following TestJsonFacetRefinement and didn't understand the significance of overrequest for refinement, my bad. Thank you for the above explanation too, made things absolutely clear and I am receiving all buckets with correct counts positively.\n\nI have corrected the JIRA title and would close this as \"Not a Bug\". Thank you again. ",
            "author": "Amrit Sarkar",
            "id": "comment-16103402"
        }
    ]
}