{
    "id": "LUCENE-4158",
    "title": "Windows Tests (4.x) hanging for 5 hrs in stall control again",
    "details": {
        "labels": "",
        "priority": "Critical",
        "components": [
            "core/index"
        ],
        "type": "Bug",
        "fix_versions": [
            "4.0-ALPHA",
            "6.0"
        ],
        "affect_versions": "4.0-ALPHA,                                            6.0",
        "resolution": "Fixed",
        "status": "Closed"
    },
    "description": "Here the stack dump, from build (extracted with jstack on windows): http://jenkins.sd-datasolutions.de/job/Lucene-Solr-4.x-Windows-Java6-64/118/\n\nJVM is 1.6.0_32, 64bit, server, 2 CPUs, Windows 7 64\n\n\n2012-06-19 17:21:42\nFull thread dump Java HotSpot(TM) 64-Bit Server VM (20.7-b02 mixed mode):\n\n\"Thread 0\" prio=6 tid=0x00000000070dc000 nid=0xcec waiting on condition [0x000000000e18f000]\n   java.lang.Thread.State: WAITING (parking)\n\tat sun.misc.Unsafe.park(Native Method)\n\t- parking to wait for  <0x00000000f684e8d8> (a org.apache.lucene.index.DocumentsWriterStallControl$Sync)\n\tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:156)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:811)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:969)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1281)\n\tat org.apache.lucene.index.DocumentsWriterStallControl.waitIfStalled(DocumentsWriterStallControl.java:120)\n\tat org.apache.lucene.index.DocumentsWriterFlushControl.waitIfStalled(DocumentsWriterFlushControl.java:618)\n\tat org.apache.lucene.index.DocumentsWriter.preUpdate(DocumentsWriter.java:301)\n\tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:361)\n\tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1327)\n\tat org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1078)\n\tat org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1059)\n\tat org.apache.lucene.index.TestNRTReaderWithThreads$RunThread.run(TestNRTReaderWithThreads.java:94)\n\n   Locked ownable synchronizers:\n\t- None\n\n\"TEST-TestScope-org.apache.lucene.index.TestNRTReaderWithThreads.testIndexing-seed#[641A6B3E2297F46E]\" prio=6 tid=0x00000000070d9800 nid=0x448 in Object.wait() [0x00000000058de000]\n   java.lang.Thread.State: WAITING (on object monitor)\n\tat java.lang.Object.wait(Native Method)\n\t- waiting on <0x00000000f685b540> (a org.apache.lucene.index.TestNRTReaderWithThreads$RunThread)\n\tat java.lang.Thread.join(Thread.java:1186)\n\t- locked <0x00000000f685b540> (a org.apache.lucene.index.TestNRTReaderWithThreads$RunThread)\n\tat java.lang.Thread.join(Thread.java:1239)\n\tat org.apache.lucene.index.TestNRTReaderWithThreads.testIndexing(TestNRTReaderWithThreads.java:61)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1969)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$1100(RandomizedRunner.java:132)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:814)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:875)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$8.evaluate(RandomizedRunner.java:889)\n\tat org.apache.lucene.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:50)\n\tat org.apache.lucene.util.TestRuleFieldCacheSanity$1.evaluate(TestRuleFieldCacheSanity.java:32)\n\tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n\tat com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n\tat org.apache.lucene.util.TestRuleReportUncaughtExceptions$1.evaluate(TestRuleReportUncaughtExceptions.java:68)\n\tat org.apache.lucene.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:48)\n\tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:821)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$700(RandomizedRunner.java:132)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$3$1.run(RandomizedRunner.java:669)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$3.evaluate(RandomizedRunner.java:695)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$4.evaluate(RandomizedRunner.java:734)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:745)\n\tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n\tat org.apache.lucene.util.TestRuleReportUncaughtExceptions$1.evaluate(TestRuleReportUncaughtExceptions.java:68)\n\tat org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:38)\n\tat org.apache.lucene.util.TestRuleIcuHack$1.evaluate(TestRuleIcuHack.java:51)\n\tat com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n\tat org.apache.lucene.util.TestRuleNoInstanceHooksOverrides$1.evaluate(TestRuleNoInstanceHooksOverrides.java:53)\n\tat org.apache.lucene.util.TestRuleNoStaticHooksShadowing$1.evaluate(TestRuleNoStaticHooksShadowing.java:52)\n\tat org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:36)\n\tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n\tat org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:56)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSuite(RandomizedRunner.java:605)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$400(RandomizedRunner.java:132)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$2.run(RandomizedRunner.java:551)\n\n   Locked ownable synchronizers:\n\t- None\n\n\"Low Memory Detector\" daemon prio=6 tid=0x000000000492f000 nid=0xfe4 runnable [0x0000000000000000]\n   java.lang.Thread.State: RUNNABLE\n\n   Locked ownable synchronizers:\n\t- None\n\n\"C2 CompilerThread1\" daemon prio=10 tid=0x000000000492c000 nid=0x6b0 waiting on condition [0x0000000000000000]\n   java.lang.Thread.State: RUNNABLE\n\n   Locked ownable synchronizers:\n\t- None\n\n\"C2 CompilerThread0\" daemon prio=10 tid=0x00000000002ca800 nid=0xf1c waiting on condition [0x0000000000000000]\n   java.lang.Thread.State: RUNNABLE\n\n   Locked ownable synchronizers:\n\t- None\n\n\"Attach Listener\" daemon prio=10 tid=0x00000000002c9000 nid=0xcc8 waiting on condition [0x0000000000000000]\n   java.lang.Thread.State: RUNNABLE\n\n   Locked ownable synchronizers:\n\t- None\n\n\"Signal Dispatcher\" daemon prio=10 tid=0x0000000004920800 nid=0x91c runnable [0x0000000000000000]\n   java.lang.Thread.State: RUNNABLE\n\n   Locked ownable synchronizers:\n\t- None\n\n\"Finalizer\" daemon prio=8 tid=0x00000000002b5000 nid=0xf4c in Object.wait() [0x00000000048df000]\n   java.lang.Thread.State: WAITING (on object monitor)\n\tat java.lang.Object.wait(Native Method)\n\t- waiting on <0x00000000e01873c8> (a java.lang.ref.ReferenceQueue$Lock)\n\tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:118)\n\t- locked <0x00000000e01873c8> (a java.lang.ref.ReferenceQueue$Lock)\n\tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:134)\n\tat java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:159)\n\n   Locked ownable synchronizers:\n\t- None\n\n\"Reference Handler\" daemon prio=10 tid=0x00000000002ac000 nid=0xe10 in Object.wait() [0x00000000047df000]\n   java.lang.Thread.State: WAITING (on object monitor)\n\tat java.lang.Object.wait(Native Method)\n\t- waiting on <0x00000000e0156290> (a java.lang.ref.Reference$Lock)\n\tat java.lang.Object.wait(Object.java:485)\n\tat java.lang.ref.Reference$ReferenceHandler.run(Reference.java:116)\n\t- locked <0x00000000e0156290> (a java.lang.ref.Reference$Lock)\n\n   Locked ownable synchronizers:\n\t- None\n\n\"main\" prio=6 tid=0x00000000003ae000 nid=0x558 in Object.wait() [0x0000000000e0f000]\n   java.lang.Thread.State: WAITING (on object monitor)\n\tat java.lang.Object.wait(Native Method)\n\t- waiting on <0x00000000f67e96b8> (a com.carrotsearch.randomizedtesting.RandomizedRunner$2)\n\tat java.lang.Thread.join(Thread.java:1186)\n\t- locked <0x00000000f67e96b8> (a com.carrotsearch.randomizedtesting.RandomizedRunner$2)\n\tat java.lang.Thread.join(Thread.java:1239)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSuite(RandomizedRunner.java:561)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.run(RandomizedRunner.java:521)\n\tat com.carrotsearch.ant.tasks.junit4.slave.SlaveMain.execute(SlaveMain.java:145)\n\tat com.carrotsearch.ant.tasks.junit4.slave.SlaveMain.main(SlaveMain.java:238)\n\tat com.carrotsearch.ant.tasks.junit4.slave.SlaveMainSafe.main(SlaveMainSafe.java:12)\n\n   Locked ownable synchronizers:\n\t- None\n\n\"VM Thread\" prio=10 tid=0x00000000002a3800 nid=0x614 runnable \n\n\"GC task thread#0 (ParallelGC)\" prio=6 tid=0x0000000000203000 nid=0x7dc runnable \n\n\"GC task thread#1 (ParallelGC)\" prio=6 tid=0x0000000000205000 nid=0xc20 runnable \n\n\"VM Periodic Task Thread\" prio=10 tid=0x0000000004938000 nid=0x720 waiting on condition \n\nJNI global references: 1586",
    "attachments": {
        "LUCENE-4158.patch": "https://issues.apache.org/jira/secure/attachment/12532865/LUCENE-4158.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2012-06-19T17:29:30+0000",
            "content": "Seed for lucene/core tests was: 641A6B3E2297F46E  ",
            "author": "Uwe Schindler",
            "id": "comment-13396943"
        },
        {
            "date": "2012-06-19T17:38:38+0000",
            "content": "ah, and CPU usage was 0% ",
            "author": "Uwe Schindler",
            "id": "comment-13396947"
        },
        {
            "date": "2012-06-21T12:54:07+0000",
            "content": "phew, I am fed up with DWStallControl. I simplified the class a lot moving to Monitor based stalling which should be totally fine since that isn't contended usually. Yet, I am still not sure if it really is DWStallControls false here of if we miss a place to unstall eventually. I plan to commit this and see if we still have problems so I can isolate causes.\n ",
            "author": "Simon Willnauer",
            "id": "comment-13398399"
        },
        {
            "date": "2012-06-21T12:56:36+0000",
            "content": "+1\nI agree, those bugs can only be found by testing, testing, testing all the time with different OS / processors /...\nIf we see another failure, we can reopen this issue. ",
            "author": "Uwe Schindler",
            "id": "comment-13398400"
        },
        {
            "date": "2012-06-21T16:23:05+0000",
            "content": "committed to trunk & 4x ",
            "author": "Simon Willnauer",
            "id": "comment-13398528"
        },
        {
            "date": "2012-06-25T06:35:28+0000",
            "content": "This time hanging 9hrs on Windows box:\n\n\n2012-06-25 06:33:11\nFull thread dump Java HotSpot(TM) 64-Bit Server VM (20.7-b02 mixed mode):\n\n\"Thread-876\" daemon prio=6 tid=0x0000000005239800 nid=0xaac in Object.wait() [0x000000000d04f000]\n   java.lang.Thread.State: WAITING (on object monitor)\n\tat java.lang.Object.wait(Native Method)\n\t- waiting on <0x00000000ff642ed8> (a org.apache.lucene.index.DocumentsWriterStallControl)\n\tat java.lang.Object.wait(Object.java:485)\n\tat org.apache.lucene.index.DocumentsWriterStallControl.waitIfStalled(DocumentsWriterStallControl.java:75)\n\t- locked <0x00000000ff642ed8> (a org.apache.lucene.index.DocumentsWriterStallControl)\n\tat org.apache.lucene.index.DocumentsWriterFlushControl.waitIfStalled(DocumentsWriterFlushControl.java:636)\n\tat org.apache.lucene.index.DocumentsWriter.preUpdate(DocumentsWriter.java:301)\n\tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:361)\n\tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1333)\n\tat org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1084)\n\tat org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1065)\n\tat org.apache.lucene.index.TestIndexWriterReader$2.run(TestIndexWriterReader.java:824)\n\n\"Thread-875\" daemon prio=6 tid=0x0000000005231000 nid=0x128 in Object.wait() [0x000000000cf4f000]\n   java.lang.Thread.State: WAITING (on object monitor)\n\tat java.lang.Object.wait(Native Method)\n\t- waiting on <0x00000000ff642ed8> (a org.apache.lucene.index.DocumentsWriterStallControl)\n\tat java.lang.Object.wait(Object.java:485)\n\tat org.apache.lucene.index.DocumentsWriterStallControl.waitIfStalled(DocumentsWriterStallControl.java:75)\n\t- locked <0x00000000ff642ed8> (a org.apache.lucene.index.DocumentsWriterStallControl)\n\tat org.apache.lucene.index.DocumentsWriterFlushControl.waitIfStalled(DocumentsWriterFlushControl.java:636)\n\tat org.apache.lucene.index.DocumentsWriter.preUpdate(DocumentsWriter.java:301)\n\tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:361)\n\tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1333)\n\tat org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1084)\n\tat org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1065)\n\tat org.apache.lucene.index.TestIndexWriterReader$2.run(TestIndexWriterReader.java:824)\n\n\"TEST-TestScope-org.apache.lucene.index.TestIndexWriterReader.testDuringAddDelete-seed#[7C8A1482E5F438AA]\" prio=6 tid=0x000000000522f000 nid=0xefc in Object.wait() [0x00000000056de000]\n   java.lang.Thread.State: WAITING (on object monitor)\n\tat java.lang.Object.wait(Native Method)\n\t- waiting on <0x00000000fedea578> (a org.apache.lucene.index.TestIndexWriterReader$2)\n\tat java.lang.Thread.join(Thread.java:1186)\n\t- locked <0x00000000fedea578> (a org.apache.lucene.index.TestIndexWriterReader$2)\n\tat java.lang.Thread.join(Thread.java:1239)\n\tat org.apache.lucene.index.TestIndexWriterReader.testDuringAddDelete(TestIndexWriterReader.java:856)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1969)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$1100(RandomizedRunner.java:132)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:814)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:875)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$8.evaluate(RandomizedRunner.java:889)\n\tat org.apache.lucene.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:50)\n\tat org.apache.lucene.util.TestRuleFieldCacheSanity$1.evaluate(TestRuleFieldCacheSanity.java:32)\n\tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n\tat com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n\tat org.apache.lucene.util.TestRuleReportUncaughtExceptions$1.evaluate(TestRuleReportUncaughtExceptions.java:68)\n\tat org.apache.lucene.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:48)\n\tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:821)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$700(RandomizedRunner.java:132)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$3$1.run(RandomizedRunner.java:669)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$3.evaluate(RandomizedRunner.java:695)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$4.evaluate(RandomizedRunner.java:734)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:745)\n\tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\n\tat org.apache.lucene.util.TestRuleReportUncaughtExceptions$1.evaluate(TestRuleReportUncaughtExceptions.java:68)\n\tat org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:38)\n\tat org.apache.lucene.util.TestRuleIcuHack$1.evaluate(TestRuleIcuHack.java:51)\n\tat com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n\tat org.apache.lucene.util.TestRuleNoInstanceHooksOverrides$1.evaluate(TestRuleNoInstanceHooksOverrides.java:53)\n\tat org.apache.lucene.util.TestRuleNoStaticHooksShadowing$1.evaluate(TestRuleNoStaticHooksShadowing.java:52)\n\tat org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:36)\n\tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n\tat org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:56)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSuite(RandomizedRunner.java:605)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$400(RandomizedRunner.java:132)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$2.run(RandomizedRunner.java:551)\n\n\"Low Memory Detector\" daemon prio=6 tid=0x0000000004882800 nid=0x990 runnable [0x0000000000000000]\n   java.lang.Thread.State: RUNNABLE\n\n\"C2 CompilerThread1\" daemon prio=10 tid=0x000000000487f000 nid=0x838 waiting on condition [0x0000000000000000]\n   java.lang.Thread.State: RUNNABLE\n\n\"C2 CompilerThread0\" daemon prio=10 tid=0x00000000003fa800 nid=0x9c4 waiting on condition [0x0000000000000000]\n   java.lang.Thread.State: RUNNABLE\n\n\"Attach Listener\" daemon prio=10 tid=0x00000000003f9000 nid=0xbb8 waiting on condition [0x0000000000000000]\n   java.lang.Thread.State: RUNNABLE\n\n\"Signal Dispatcher\" daemon prio=10 tid=0x0000000004870800 nid=0xa44 runnable [0x0000000000000000]\n   java.lang.Thread.State: RUNNABLE\n\n\"Finalizer\" daemon prio=8 tid=0x00000000003df800 nid=0xba4 in Object.wait() [0x000000000482f000]\n   java.lang.Thread.State: WAITING (on object monitor)\n\tat java.lang.Object.wait(Native Method)\n\t- waiting on <0x00000000e0000150> (a java.lang.ref.ReferenceQueue$Lock)\n\tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:118)\n\t- locked <0x00000000e0000150> (a java.lang.ref.ReferenceQueue$Lock)\n\tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:134)\n\tat java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:159)\n\n\"Reference Handler\" daemon prio=10 tid=0x00000000003dc000 nid=0x7e0 in Object.wait() [0x000000000472f000]\n   java.lang.Thread.State: WAITING (on object monitor)\n\tat java.lang.Object.wait(Native Method)\n\t- waiting on <0x00000000e003a880> (a java.lang.ref.Reference$Lock)\n\tat java.lang.Object.wait(Object.java:485)\n\tat java.lang.ref.Reference$ReferenceHandler.run(Reference.java:116)\n\t- locked <0x00000000e003a880> (a java.lang.ref.Reference$Lock)\n\n\"main\" prio=6 tid=0x00000000002fe000 nid=0xfcc in Object.wait() [0x0000000000d1f000]\n   java.lang.Thread.State: WAITING (on object monitor)\n\tat java.lang.Object.wait(Native Method)\n\t- waiting on <0x00000000fed943e8> (a com.carrotsearch.randomizedtesting.RandomizedRunner$2)\n\tat java.lang.Thread.join(Thread.java:1186)\n\t- locked <0x00000000fed943e8> (a com.carrotsearch.randomizedtesting.RandomizedRunner$2)\n\tat java.lang.Thread.join(Thread.java:1239)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSuite(RandomizedRunner.java:561)\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.run(RandomizedRunner.java:521)\n\tat com.carrotsearch.ant.tasks.junit4.slave.SlaveMain.execute(SlaveMain.java:145)\n\tat com.carrotsearch.ant.tasks.junit4.slave.SlaveMain.main(SlaveMain.java:238)\n\tat com.carrotsearch.ant.tasks.junit4.slave.SlaveMainSafe.main(SlaveMainSafe.java:12)\n\n\"VM Thread\" prio=10 tid=0x00000000003d3800 nid=0xb00 runnable \n\n\"GC task thread#0 (ParallelGC)\" prio=6 tid=0x0000000000333000 nid=0x7f0 runnable \n\n\"GC task thread#1 (ParallelGC)\" prio=6 tid=0x0000000000335000 nid=0x538 runnable \n\n\"VM Periodic Task Thread\" prio=10 tid=0x000000000488b800 nid=0xa20 waiting on condition \n\nJNI global references: 1196\n\n ",
            "author": "Uwe Schindler",
            "id": "comment-13400310"
        },
        {
            "date": "2012-06-25T06:36:29+0000",
            "content": "Build: http://jenkins.sd-datasolutions.de/job/Lucene-Solr-4.x-Windows-Java6-64/165/ ",
            "author": "Uwe Schindler",
            "id": "comment-13400311"
        },
        {
            "date": "2012-06-25T06:41:19+0000",
            "content": "I forgot to add: 0% CPU machine was silent. It looks like waiting forever for a notify(). ",
            "author": "Uwe Schindler",
            "id": "comment-13400314"
        },
        {
            "date": "2012-06-25T08:14:24+0000",
            "content": "this must be 'lucky monday'. I mean I really enjoy starting the week with a sneaky concurrency problem but it's even better if you can reproduce it! Well, it came even better... I reproduced the hang with IW output enabled and a debug pointer in place! How lucky is that! Good news, I know what happens and we can easily fix it. \n\nHere we go.... some thread triggers a full flush which means we take all DWPT out of the loop and flush them to do a reopen. Yet, at the same time we need to prevent later documents from sneaking into the flush. That is done by preventing any DWPT from flushing which was not part of the full flush until that is done! Yet if we pile up lots of docs (or have a smallish ram buffer / low max buffered docs) this can happen easily. Now if we reach the threashold for stalling while the full flush is flushing its last segment we check if we can help flushing with indexing threads. That is not possible since all DWPT that don't belong to the full flush are blocked. So we basically can not help and are over the stall limit, so we put ourself to sleep. Now the full flush is done and it gives us the wakeup call but nobody else will ever flush one of the blocked DWPT since all threads are waiting. \n\nbasically a chicken/egg problem.. this patch simply removes the loop in DWStallControl and lets the higher level logic restall after we retried to flush pending DWPT instances. ie healing ourself. ",
            "author": "Simon Willnauer",
            "id": "comment-13400355"
        },
        {
            "date": "2012-06-25T08:20:02+0000",
            "content": "Thanks for explanation. You are lucky  Gratulations for a fine start into the week! ",
            "author": "Uwe Schindler",
            "id": "comment-13400357"
        },
        {
            "date": "2012-06-25T19:35:45+0000",
            "content": "committed to trunk & 4.x ",
            "author": "Simon Willnauer",
            "id": "comment-13400811"
        }
    ]
}