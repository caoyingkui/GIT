{
    "id": "SOLR-1269",
    "title": "stack trace not clear when there is a SQL error",
    "details": {
        "affect_versions": "1.4",
        "status": "Closed",
        "fix_versions": [
            "1.4"
        ],
        "components": [
            "contrib - DataImportHandler"
        ],
        "type": "Improvement",
        "priority": "Major",
        "labels": "",
        "resolution": "Fixed"
    },
    "description": "When setting up a new JDBC datasource and the SQL isn't right yet, we are getting a stack trace that says ClassNotFoundException, but that is misleading.  \n\nA cleaner stack trace is warranted, indicating the actual error.\n\n[actual SQL statement omitted]\n\norg.apache.solr.handler.dataimport.DataImportHandlerException: Unable to execute query: SELECT     .....  Processing Document # 1\n\tat org.apache.solr.handler.dataimport.JdbcDataSource$ResultSetIterator.<init>(JdbcDataSource.java:250)\n\tat org.apache.solr.handler.dataimport.JdbcDataSource.getData(JdbcDataSource.java:207)\n\tat org.apache.solr.handler.dataimport.JdbcDataSource.getData(JdbcDataSource.java:40)\n\tat org.apache.solr.handler.dataimport.SqlEntityProcessor.initQuery(SqlEntityProcessor.java:58)\n\tat org.apache.solr.handler.dataimport.SqlEntityProcessor.nextRow(SqlEntityProcessor.java:71)\n\tat org.apache.solr.handler.dataimport.EntityProcessorWrapper.nextRow(EntityProcessorWrapper.java:237)\n\tat org.apache.solr.handler.dataimport.DocBuilder.buildDocument(DocBuilder.java:343)\n\tat org.apache.solr.handler.dataimport.DocBuilder.doFullDump(DocBuilder.java:224)\n\tat org.apache.solr.handler.dataimport.DocBuilder.execute(DocBuilder.java:167)\n\tat org.apache.solr.handler.dataimport.DataImporter.doFullImport(DataImporter.java:333)\n\tat org.apache.solr.handler.dataimport.DataImporter.runCmd(DataImporter.java:393)\n\tat org.apache.solr.handler.dataimport.DataImporter$1.run(DataImporter.java:372)\nCaused by: java.lang.ClassNotFoundException: Unable to load null or org.apache.solr.handler.dataimport.null\n\tat org.apache.solr.handler.dataimport.DocBuilder.loadClass(DocBuilder.java:723)\n\tat org.apache.solr.handler.dataimport.JdbcDataSource$1.call(JdbcDataSource.java:188)\n\tat org.apache.solr.handler.dataimport.JdbcDataSource$1.call(JdbcDataSource.java:127)\n\tat org.apache.solr.handler.dataimport.JdbcDataSource.getConnection(JdbcDataSource.java:362)\n\tat org.apache.solr.handler.dataimport.JdbcDataSource.access$300(JdbcDataSource.java:40)\n\tat org.apache.solr.handler.dataimport.JdbcDataSource$ResultSetIterator.<init>(JdbcDataSource.java:237)\n\t... 11 more\nCaused by: java.lang.NullPointerException\n\tat java.util.concurrent.ConcurrentHashMap.get(ConcurrentHashMap.java:768)\n\tat org.apache.solr.core.SolrResourceLoader.findClass(SolrResourceLoader.java:280)\n\tat org.apache.solr.handler.dataimport.DocBuilder.loadClass(DocBuilder.java:713)",
    "attachments": {
        "SOLR-1269.patch": "https://issues.apache.org/jira/secure/attachment/12418798/SOLR-1269.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "author": "Shalin Shekhar Mangar",
            "id": "comment-12752098",
            "date": "2009-09-07T11:26:38+0000",
            "content": "\n\tUsed DataImportHandlerException.wrapAndThrow to avoid incorrect messages\n\tAdd null check in JdbcDataSource#close\n\tFixed close() logic so that JdbcDataSource#close is not called after connection timeouts.\n\n\n\nI tried two scenarios:\n\n\tIncorrect driver name\n\tIncorrect sql query\n\n\n\nWith incorrect driver name, before this patch:\n\nSEVERE: Full Import failed\norg.apache.solr.handler.dataimport.DataImportHandlerException: Failed to initialize DataSource: null Processing Document # 1\n\tat org.apache.solr.handler.dataimport.DataImporter.getDataSourceInstance(DataImporter.java:307)\n\tat org.apache.solr.handler.dataimport.ContextImpl.getDataSource(ContextImpl.java:93)\n\tat org.apache.solr.handler.dataimport.SqlEntityProcessor.init(SqlEntityProcessor.java:52)\n\tat org.apache.solr.handler.dataimport.EntityProcessorWrapper.init(EntityProcessorWrapper.java:71)\n\tat org.apache.solr.handler.dataimport.DocBuilder.buildDocument(DocBuilder.java:302)\n\tat org.apache.solr.handler.dataimport.DocBuilder.doFullDump(DocBuilder.java:225)\n\tat org.apache.solr.handler.dataimport.DocBuilder.execute(DocBuilder.java:167)\n\tat org.apache.solr.handler.dataimport.DataImporter.doFullImport(DataImporter.java:333)\n\tat org.apache.solr.handler.dataimport.DataImporter.runCmd(DataImporter.java:393)\n\tat org.apache.solr.handler.dataimport.DataImporter$1.run(DataImporter.java:372)\nCaused by: org.apache.solr.handler.dataimport.DataImportHandlerException: Could not load driver: org.hsqldb.ajdbcDriver Processing Document # 1\n\tat org.apache.solr.handler.dataimport.DataImportHandlerException.wrapAndThrow(DataImportHandlerException.java:72)\n\tat org.apache.solr.handler.dataimport.JdbcDataSource.createConnectionFactory(JdbcDataSource.java:114)\n\tat org.apache.solr.handler.dataimport.JdbcDataSource.init(JdbcDataSource.java:62)\n\tat org.apache.solr.handler.dataimport.DataImporter.getDataSourceInstance(DataImporter.java:305)\n\t... 9 more\n\nAfter the patch:\n\nSEVERE: Full Import failed\norg.apache.solr.handler.dataimport.DataImportHandlerException: Could not load driver: org.hsqldb.ajdbcDriver Processing Document # 1\n\tat org.apache.solr.handler.dataimport.DataImportHandlerException.wrapAndThrow(DataImportHandlerException.java:72)\n\tat org.apache.solr.handler.dataimport.JdbcDataSource.createConnectionFactory(JdbcDataSource.java:114)\n\tat org.apache.solr.handler.dataimport.JdbcDataSource.init(JdbcDataSource.java:62)\n\tat org.apache.solr.handler.dataimport.DataImporter.getDataSourceInstance(DataImporter.java:306)\n\tat org.apache.solr.handler.dataimport.ContextImpl.getDataSource(ContextImpl.java:93)\n\tat org.apache.solr.handler.dataimport.SqlEntityProcessor.init(SqlEntityProcessor.java:52)\n\tat org.apache.solr.handler.dataimport.EntityProcessorWrapper.init(EntityProcessorWrapper.java:71)\n\tat org.apache.solr.handler.dataimport.DocBuilder.buildDocument(DocBuilder.java:302)\n\tat org.apache.solr.handler.dataimport.DocBuilder.doFullDump(DocBuilder.java:225)\n\tat org.apache.solr.handler.dataimport.DocBuilder.execute(DocBuilder.java:167)\n\tat org.apache.solr.handler.dataimport.DataImporter.doFullImport(DataImporter.java:333)\n\tat org.apache.solr.handler.dataimport.DataImporter.runCmd(DataImporter.java:393)\n\tat org.apache.solr.handler.dataimport.DataImporter$1.run(DataImporter.java:372)\nCaused by: java.lang.ClassNotFoundException: Unable to load org.hsqldb.ajdbcDriver or org.apache.solr.handler.dataimport.org.hsqldb.ajdbcDriver\n\tat org.apache.solr.handler.dataimport.DocBuilder.loadClass(DocBuilder.java:717)\n\tat org.apache.solr.handler.dataimport.JdbcDataSource.createConnectionFactory(JdbcDataSource.java:112)\n\t... 11 more\n\nIn the case of incorrect SQL query, the following is logged (before and after is same):\n\nSEVERE: Exception while processing: item document : SolrInputDocument[{}]\norg.apache.solr.handler.dataimport.DataImportHandlerException: Unable to execute query: select * from item1 Processing Document # 1\n\tat org.apache.solr.handler.dataimport.JdbcDataSource$ResultSetIterator.<init>(JdbcDataSource.java:251)\n\tat org.apache.solr.handler.dataimport.JdbcDataSource.getData(JdbcDataSource.java:208)\n\tat org.apache.solr.handler.dataimport.JdbcDataSource.getData(JdbcDataSource.java:39)\n\tat org.apache.solr.handler.dataimport.SqlEntityProcessor.initQuery(SqlEntityProcessor.java:58)\n\tat org.apache.solr.handler.dataimport.SqlEntityProcessor.nextRow(SqlEntityProcessor.java:71)\n\tat org.apache.solr.handler.dataimport.EntityProcessorWrapper.nextRow(EntityProcessorWrapper.java:237)\n\tat org.apache.solr.handler.dataimport.DocBuilder.buildDocument(DocBuilder.java:339)\n\tat org.apache.solr.handler.dataimport.DocBuilder.doFullDump(DocBuilder.java:225)\n\tat org.apache.solr.handler.dataimport.DocBuilder.execute(DocBuilder.java:167)\n\tat org.apache.solr.handler.dataimport.DataImporter.doFullImport(DataImporter.java:333)\n\tat org.apache.solr.handler.dataimport.DataImporter.runCmd(DataImporter.java:393)\n\tat org.apache.solr.handler.dataimport.DataImporter$1.run(DataImporter.java:372)\nCaused by: java.sql.SQLException: Table not found in statement [select * from item1]\n\tat org.hsqldb.jdbc.Util.sqlException(Unknown Source)\n\tat org.hsqldb.jdbc.jdbcStatement.fetchResult(Unknown Source)\n\tat org.hsqldb.jdbc.jdbcStatement.execute(Unknown Source)\n\tat org.apache.solr.handler.dataimport.JdbcDataSource$ResultSetIterator.<init>(JdbcDataSource.java:244)\n\t... 11 more "
        },
        {
            "author": "Shalin Shekhar Mangar",
            "id": "comment-12752131",
            "date": "2009-09-07T13:20:02+0000",
            "content": "Committed revision 812123.\n\nThanks Erik! "
        },
        {
            "author": "Grant Ingersoll",
            "id": "comment-12775481",
            "date": "2009-11-10T15:50:36+0000",
            "content": "Bulk close Solr 1.4 issues "
        }
    ]
}