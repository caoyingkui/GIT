{
    "id": "SOLR-4297",
    "title": "Atomic update including set null=true throws uniqueKey error depending on order",
    "details": {
        "affect_versions": "4.0,                                            4.1",
        "status": "Closed",
        "fix_versions": [
            "4.3",
            "6.0"
        ],
        "components": [
            "clients - java",
            "update"
        ],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Fixed"
    },
    "description": "There seems to be a field order issue going on when setting a field to null with a partial update.  I am running the nightly Solr 4.1.0.2013.01.11.08.23.02 build.  Ran into this issue using the nightly build version of Solrj, including the null field fix from Solr-4133.\n\nNull first, unique field second (this is what is being generated by Solrj)\n\ncurl 'http://localhost/solr/update?commit=true' -H 'Content-type:text/xml' -d '<add><doc boost=\"1.0\">\n<field name=\"timestamp\" update=\"set\" null=\"true\"/><field name=\"id\">test</field>\n</doc></add>'\n\n\n\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<response>\n<lst name=\"responseHeader\"><int name=\"status\">400</int><int name=\"QTime\">0</int></lst><lst name=\"error\"><str name=\"msg\">Document is missing mandatory uniqueKey field: id</str><int name=\"code\">400</int></lst>\n</response>\n\n\n\nid first, then null field\n\ncurl 'http://localhost/solr/update?commit=true' -H 'Content-type:text/xml' -d '<add><doc boost=\"1.0\">\n<field name=\"id\">test</field>\n<field name=\"timestamp\" update=\"set\" null=\"true\"/>\n</doc></add>'\n\n\n\n<response>\n<lst name=\"responseHeader\"><int name=\"status\">0</int><int name=\"QTime\">30</int></lst>\n</response>\n\n\n\nReal value first, then id\n\ncurl 'http://localhost/solr/update?commit=true' -H 'Content-type:text/xml' -d '<add><doc boost=\"1.0\">\n<field name=\"timestamp\" update=\"set\">1970-01-01T00:00:00Z</field>\n<field name=\"id\">test</field>\n</doc></add>'\n\n\n\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<response>\n<lst name=\"responseHeader\"><int name=\"status\">0</int><int name=\"QTime\">28</int></lst>\n</response>\n\n\n\nUnfortunately it is doing this field ordering every atomic update request via Solrj I do now.",
    "attachments": {
        "SOLR-4297.patch": "https://issues.apache.org/jira/secure/attachment/12573665/SOLR-4297.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "author": "Rob",
            "id": "comment-13589934",
            "date": "2013-02-28T21:21:06+0000",
            "content": "Based on its behavior it seems like having set=null results in the server flagging all subsequent elements from that update to be removed. (Hence the error message above noting that the mandatory Id is missing.\n\nAs a further example:\n\nIf I have the null=true cat field at the end of the doc\n\n<add><doc><field name=\"id\">Item1</field><field name=\"manu\" update=\"set\">Hello</field><field name=\"cat\" update=\"set\" null=\"true\" /></doc>\n\n\nThe resulting indexed document looks something like \n\n<doc><str name=\"id\">GB18030TEST</str><str name=\"manu\">Hello</str></doc>\n\n\nhowever if we place the null=true element before the manu element like thus\n\n<add><doc><field name=\"id\">Item1</field><field name=\"cat\" update=\"set\" null=\"true\" /><field name=\"manu\" update=\"set\">World</field></doc>\n\n\nthen manu item is also cleared although all other other fields not provided in the update do hang around.\nThe work around at the moment as noted is to ensure that all null=true fields are placed at the end of the doc. "
        },
        {
            "author": "Shalin Shekhar Mangar",
            "id": "comment-13602009",
            "date": "2013-03-14T03:57:46+0000",
            "content": "Test and fix. "
        },
        {
            "author": "Commit Tag Bot",
            "id": "comment-13602031",
            "date": "2013-03-14T05:00:32+0000",
            "content": "[trunk commit] Shalin Shekhar Mangar\nhttp://svn.apache.org/viewvc?view=revision&revision=1456322\n\nSOLR-4297: Atomic update request containing null=true sets all subsequent fields to null "
        },
        {
            "author": "Shalin Shekhar Mangar",
            "id": "comment-13602033",
            "date": "2013-03-14T05:02:48+0000",
            "content": "Fixed in branch_4x and trunk. "
        },
        {
            "author": "Commit Tag Bot",
            "id": "comment-13602038",
            "date": "2013-03-14T05:12:59+0000",
            "content": "[branch_4x commit] Shalin Shekhar Mangar\nhttp://svn.apache.org/viewvc?view=revision&revision=1456323\n\nSOLR-4297: Atomic update request containing null=true sets all subsequent fields to null "
        },
        {
            "author": "Commit Tag Bot",
            "id": "comment-13606482",
            "date": "2013-03-19T16:40:52+0000",
            "content": "[trunk commit] Mark Robert Miller\nhttp://svn.apache.org/viewvc?view=revision&revision=1458392\n\nSOLR-4297: Move CHANGES entry. "
        },
        {
            "author": "Commit Tag Bot",
            "id": "comment-13606487",
            "date": "2013-03-19T16:42:23+0000",
            "content": "[branch_4x commit] Mark Robert Miller\nhttp://svn.apache.org/viewvc?view=revision&revision=1458396\n\nSOLR-4297: Move CHANGES entry. "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13653933",
            "date": "2013-05-10T10:33:27+0000",
            "content": "Closed after release. "
        }
    ]
}