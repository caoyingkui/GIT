{
    "id": "LUCENE-7131",
    "title": "TestSpanCollection.testNestedNearQuery() failure",
    "details": {
        "resolution": "Unresolved",
        "affect_versions": "None",
        "components": [
            "core/search"
        ],
        "labels": "",
        "fix_versions": [],
        "priority": "Major",
        "status": "Open",
        "type": "Bug"
    },
    "description": "My Jenkins found a reproducing seed on master:\n\n\n   [junit4] Suite: org.apache.lucene.search.spans.TestSpanCollection\n   [junit4]   2> NOTE: download the large Jenkins line-docs file by running 'ant get-jenkins-line-docs' in the lucene directory.\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestSpanCollection -Dtests.method=testNestedNearQuery -Dtests.seed=F74A6883FBD420 -Dtests.slow=true -Dtests.linedocsfile=/home/jenkins/lucene-data/enwiki.random.lines.txt -Dtests.locale=be-BY -Dtests.timezone=Australia/Tasmania -Dtests.asserts=true -Dtests.file.encoding=US-ASCII\n   [junit4] FAILURE 0.05s J0 | TestSpanCollection.testNestedNearQuery <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError: Missing term field:w3\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([F74A6883FBD420:4206DBF382A97067]:0)\n   [junit4]    > \tat org.apache.lucene.search.spans.TestSpanCollection.checkCollectedTerms(TestSpanCollection.java:103)\n   [junit4]    > \tat org.apache.lucene.search.spans.TestSpanCollection.testNestedNearQuery(TestSpanCollection.java:126)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:745)\n   [junit4]   2> NOTE: test params are: codec=Asserting(Lucene60): {field=TestBloomFilteredLucenePostings(BloomFilteringPostingsFormat(Lucene50(blocksize=128)))}, docValues:{}, maxPointsInLeafNode=349, maxMBSortInHeap=4.321837275051001, sim=RandomSimilarity(queryNorm=true,coord=no): {field=DFR I(F)LZ(0.3)}, locale=be-BY, timezone=Australia/Tasmania\n   [junit4]   2> NOTE: Linux 4.1.0-custom2-amd64 amd64/Oracle Corporation 1.8.0_45 (64-bit)/cpus=16,threads=1,free=203945808,total=344457216\n   [junit4]   2> NOTE: All tests run in this JVM: [TestSortedNumericSortField, TestByteArrayDataInput, TestFlushByRamOrCountsPolicy, TestSearchWithThreads, TestDeterminizeLexicon, FuzzyTermOnShortTermsTest, TestSwappedIndexFiles, TestIndexWriterThreadsToSegments, TestCollectionUtil, TestNRTReaderWithThreads, TestIndexWriterFromReader, TestConstantScoreQuery, TestDeletionPolicy, TestIndexCommit, TestIOUtils, TestCrashCausesCorruptIndex, TestForUtil, TestSortedSetDocValues, TestNeverDelete, TestAllFilesHaveChecksumFooter, TestMutableValues, TestSizeBoundedForceMerge, TestDisjunctionMaxQuery, TestUsageTrackingFilterCachingPolicy, TestNGramPhraseQuery, TestIndexWriterDelete, TestNumericDocValuesUpdates, TestCachingTokenFilter, TestSimpleSearchEquivalence, TestNoMergePolicy, TestSpanContainQuery, TestTrackingDirectoryWrapper, TestBlendedTermQuery, TestIndexWriterMerging, Test2BPositions, TestAssertions, TestMultiPhraseEnum, TestMaxPosition, TestIntsRef, TestRamUsageEstimator, TestCodecs, TestSimilarityProvider, TestLazyProxSkipping, Test4GBStoredFields, TestNearSpansOrdered, TestStringHelper, TestMmapDirectory, LimitedFiniteStringsIteratorTest, TestSpanSearchEquivalence, TestLRUQueryCache, TestSegmentTermEnum, TestFSTs, TestSmallFloat, TestPrefixInBooleanQuery, TestPointValues, TestFileSwitchDirectory, TestMinShouldMatch2, TestTryDelete, TestDateSort, TestLucene50TermVectorsFormat, Test2BBinaryDocValues, TestParallelCompositeReader, TestNeedsScores, TestTerms, TestFlex, TestLiveFieldValues, TestField, TestSortRandom, TestSegmentTermDocs, TestLockFactory, TestPerFieldPostingsFormat2, TestOperations, TestQueryCachingPolicy, TestBooleanQuery, TestTimSorterWorstCase, TestFieldType, TestCustomSearcherSort, TestWeakIdentityMap, TestPackedTokenAttributeImpl, TestDocsAndPositions, TestComplexExplanations, TestIndexWriterOnVMError, TestNorms, TestBasics, TestBagOfPositions, TestBufferedChecksum, TestMultiTermsEnum, TestBytesStore, TestTermScorer, TestCharFilter, TestDocValuesRewriteMethod, TestInPlaceMergeSorter, TestMatchAllDocsQuery, TestWildcardRandom, TestExternalCodecs, TestSortedSetSortField, TestIndexWriterOnDiskFull, TestBooleanRewrites, TestPostingsOffsets, TestRecyclingByteBlockAllocator, Test2BBKDPoints, TestSpanBoostQuery, TestIndexWriter, TestReusableStringReader, TestSingleInstanceLockFactory, TestBooleanOr, TestDuelingCodecs, TestStressAdvance, TestTimeLimitingCollector, TestTopDocsMerge, TestLongPostings, TestMinimize, TestSnapshotDeletionPolicy, TestIndexWriterForceMerge, TestPerFieldPostingsFormat, TestTermsEnum, TestBooleanMinShouldMatch, TestTransactionRollback, TestUTF32ToUTF8, TestStressIndexing2, TestMultiPhraseQuery, TestMergeSchedulerExternal, TestTermVectorsWriter, TestOmitPositions, TestBytesRefHash, TestOmitTf, TestDocumentWriter, TestPayloads, TestDoc, TestWildcard, TestSimilarity2, TestFieldMaskingSpanQuery, TestNoDeletionPolicy, TestSimpleExplanationsOfNonMatches, TestRegexpQuery, TestTermVectorsReader, TestIntBlockPool, TestUnicodeUtil, TestAutomatonQuery, TestRegexpRandom, TestPayloadsOnVectors, TestSpanMultiTermQueryWrapper, TestSearchForDuplicates, TestCompiledAutomaton, TestPrefixQuery, TestSpanExplanationsOfNonMatches, TestSetOnce, TestPriorityQueue, TestDocCount, TestBinaryDocument, TestAttributeSource, TestBooleanScorer, TestTwoPhaseCommitTool, TestCloseableThreadLocal, TestCodecHoldsOpenFiles, TestDocBoost, TestSimpleAttributeImpl, Test2BPostingsBytes, Test2BPagedBytes, TestBytesRefAttImpl, TestBlockPostingsFormat, TestBlockPostingsFormat2, TestLucene50FieldInfoFormat, TestLucene50StoredFieldsFormat, TestLucene54DocValuesFormat, Test2BPoints, Test2BSortedDocValuesFixedSorted, Test2BSortedDocValuesOrds, TestAllFilesCheckIndexHeader, TestCodecUtil, TestDocInverterPerFieldErrorInfo, TestDocValues, TestDuelingCodecsAtNight, TestExitableDirectoryReader, TestFieldReuse, TestFilterDirectoryReader, TestIndexWriterDeleteByQuery, TestIndexWriterExceptions2, TestMergePolicyWrapper, TestMergeRateLimiter, TestReaderWrapperDVTypeCheck, TestTermVectors, TestApproximationSearchEquivalence, TestEarlyTermination, TestFieldValueQuery, TestMatchNoDocsQuery, TestMultiCollector, TestMultiset, TestQueryRescorer, TestReqExclBulkScorer, TestClassicSimilarity, TestSpanCollection]\n   [junit4] Completed [390/415 (1!)] on J0 in 0.11s, 3 tests, 1 failure <<< FAILURES!",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "id": "comment-15208376",
            "author": "Steve Rowe",
            "date": "2016-03-23T13:07:30+0000",
            "content": "The seed also reproduces for me on branch_6x and branch_6_0. "
        },
        {
            "id": "comment-15213112",
            "author": "Steve Rowe",
            "date": "2016-03-26T17:13:15+0000",
            "content": "Another reproducible failure on master, found by Policeman Jenkins http://jenkins.thetaphi.de/job/Lucene-Solr-master-Linux/16334/:\n\n\n  [junit4] Suite: org.apache.lucene.search.spans.TestSpanCollection\n  [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestSpanCollection -Dtests.method=testNestedNearQuery -Dtests.seed=36E2276040A58519 -Dtests.multiplier=3 -Dtests.slow=true -Dtests.locale=mk -Dtests.timezone=Etc/GMT-3 -Dtests.asserts=true -Dtests.file.encoding=ISO-8859-1\n  [junit4] FAILURE 0.02s J0 | TestSpanCollection.testNestedNearQuery <<<\n  [junit4]    > Throwable #1: java.lang.AssertionError: Missing term field:w3\n  [junit4]    > \tat __randomizedtesting.SeedInfo.seed([36E2276040A58519:7413B6FB41F7215E]:0)\n  [junit4]    > \tat org.apache.lucene.search.spans.TestSpanCollection.checkCollectedTerms(TestSpanCollection.java:103)\n  [junit4]    > \tat org.apache.lucene.search.spans.TestSpanCollection.testNestedNearQuery(TestSpanCollection.java:126)\n  [junit4]    > \tat java.lang.Thread.run(Thread.java:745)\n  [junit4]   2> NOTE: test params are: codec=Asserting(Lucene60): {field=Lucene50(blocksize=128)}, docValues:{}, maxPointsInLeafNode=1945, maxMBSortInHeap=6.818906485988073, sim=RandomSimilarity(queryNorm=true,coord=no): {field=DFR I(F)LZ(0.3)}, locale=mk, timezone=Etc/GMT-3\n  [junit4]   2> NOTE: Linux 4.2.0-34-generic i386/Oracle Corporation 1.8.0_72 (32-bit)/cpus=12,threads=1,free=215918352,total=528482304\n  [junit4]   2> NOTE: All tests run in this JVM: [TestMultiTermConstantScore, TestFieldType, TestPhraseQuery, TestNGramPhraseQuery, TestPriorityQueue, TestOperations, TestNumericRangeQuery64, TestFieldReuse, TestPersistentSnapshotDeletionPolicy, TestDisjunctionMaxQuery, TestConjunctionDISI, TestSortRandom, TestBKD, TestQueryBuilder, TestUnicodeUtil, TestBinaryTerms, TestClassicSimilarity, TestAutomatonQuery, TestIndexWriterDelete, TestForTooMuchCloning, TestRateLimiter, TestLucene50CompoundFormat, TestNeverDelete, TestStringHelper, TestTimeLimitingCollector, TestNewestSegment, TestReaderClosed, TestPointValues, TestIndexWriterLockRelease, TestSimpleAttributeImpl, TestAllFilesHaveChecksumFooter, TestDeletionPolicy, TestIntArrayDocIdSet, TestSloppyPhraseQuery2, TestFilterLeafReader, TestMergeRateLimiter, TestSingleInstanceLockFactory, TestFixedBitSet, TestTermsEnum, TestNeedsScores, TestIndexWriterWithThreads, TestDeterminizeLexicon, TestBooleanCoord, TestCrash, TestIndexWriterMaxDocs, TestCloseableThreadLocal, TestBlockPostingsFormat2, TestSegmentReader, TestHighCompressionMode, TestSimilarity2, TestTermScorer, TestFixedBitDocIdSet, TestMultiPhraseQuery, TestSpanNotQuery, TestThreadedForceMerge, TestBinaryDocument, TestNRTReaderCleanup, TestCustomNorms, TestQueryRescorer, TestDateSort, TestMultiFields, TestRecyclingByteBlockAllocator, TestEarlyTermination, TestPagedBytes, TestSumDocFreq, TestBytesRefArray, TestManyFields, TestVirtualMethod, TestSpanCollection]\n  [junit4] Completed [219/415 (1!)] on J0 in 0.07s, 3 tests, 1 failure <<< FAILURES!\n\n "
        }
    ]
}