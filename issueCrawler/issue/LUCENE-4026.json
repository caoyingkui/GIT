{
    "id": "LUCENE-4026",
    "title": "TestIndexWriterReader hang",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [],
        "type": "Bug",
        "fix_versions": [
            "4.0-ALPHA"
        ],
        "affect_versions": "4.0-ALPHA",
        "resolution": "Fixed",
        "status": "Closed"
    },
    "description": "hung in jenkins. seed is  D344294F98D3F637 (and the usual nightly flags, -Dtests.nightly=true, -Dtests.multiplier=3, -Dtests.linedocsfile=huge)\n\nDidn't try to reproduce yet.",
    "attachments": {
        "LUCENE-4026.patch": "https://issues.apache.org/jira/secure/attachment/12526191/LUCENE-4026.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2012-04-30T17:22:00+0000",
            "content": "\n[junit4] >>> error stream from forked JVM (verbatim) ----\n   [junit4] 2012-04-30 17:13:44\n   [junit4] Full thread dump OpenJDK 64-Bit Server VM (20.0-b12 mixed mode):\n   [junit4] \n   [junit4] \"Thread-727\" daemon prio=5 tid=0x00000008325a8000 nid=0x15822ac waiting on condition [0x00007ffffd9db000]\n   [junit4]    java.lang.Thread.State: WAITING (parking)\n   [junit4] \tat sun.misc.Unsafe.park(Native Method)\n   [junit4] \t- parking to wait for  <0x000000080f9788b0> (a org.apache.lucene.index.DocumentsWriterStallControl$Sync)\n   [junit4] \tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)\n   [junit4] \tat java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:838)\n   [junit4] \tat java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireShared(AbstractQueuedSynchronizer.java:968)\n   [junit4] \tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireShared(AbstractQueuedSynchronizer.java:1284)\n   [junit4] \tat org.apache.lucene.index.DocumentsWriterStallControl.waitIfStalled(DocumentsWriterStallControl.java:114)\n   [junit4] \tat org.apache.lucene.index.DocumentsWriterFlushControl.waitIfStalled(DocumentsWriterFlushControl.java:615)\n   [junit4] \tat org.apache.lucene.index.DocumentsWriter.preUpdate(DocumentsWriter.java:301)\n   [junit4] \tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:361)\n   [junit4] \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1276)\n   [junit4] \tat org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1034)\n   [junit4] \tat org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1015)\n   [junit4] \tat org.apache.lucene.index.TestIndexWriterReader$2.run(TestIndexWriterReader.java:824)\n   [junit4] \n   [junit4] \"LTC-main#seed=D344294F98D3F637\" prio=5 tid=0x000000080115c800 nid=0x1581e8d in Object.wait() [0x00007ffffdbdc000]\n   [junit4]    java.lang.Thread.State: WAITING (on object monitor)\n   [junit4] \tat java.lang.Object.wait(Native Method)\n   [junit4] \t- waiting on <0x0000000829990000> (a org.apache.lucene.index.TestIndexWriterReader$2)\n   [junit4] \tat java.lang.Thread.join(Thread.java:1203)\n   [junit4] \t- locked <0x0000000829990000> (a org.apache.lucene.index.TestIndexWriterReader$2)\n   [junit4] \tat java.lang.Thread.join(Thread.java:1256)\n   [junit4] \tat org.apache.lucene.index.TestIndexWriterReader.testDuringAddDelete(TestIndexWriterReader.java:856)\n   [junit4] \tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n   [junit4] \tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n   [junit4] \tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n   [junit4] \tat java.lang.reflect.Method.invoke(Method.java:616)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1913)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$1100(RandomizedRunner.java:131)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:805)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:866)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner$8.evaluate(RandomizedRunner.java:880)\n   [junit4] \tat org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:770)\n   [junit4] \tat org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:692)\n   [junit4] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:69)\n   [junit4] \tat org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:625)\n   [junit4] \tat org.apache.lucene.util.UncaughtExceptionsRule$1.evaluate(UncaughtExceptionsRule.java:75)\n   [junit4] \tat org.apache.lucene.util.LuceneTestCase$SaveThreadAndTestNameRule$1.evaluate(LuceneTestCase.java:664)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:812)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$700(RandomizedRunner.java:131)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner$3$1.run(RandomizedRunner.java:668)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner$3.evaluate(RandomizedRunner.java:687)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner$4.evaluate(RandomizedRunner.java:723)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:734)\n   [junit4] \tat org.apache.lucene.util.UncaughtExceptionsRule$1.evaluate(UncaughtExceptionsRule.java:75)\n   [junit4] \tat org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:38)\n   [junit4] \tat org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:69)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSuite(RandomizedRunner.java:604)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$400(RandomizedRunner.java:131)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner$2.run(RandomizedRunner.java:550)\n   [junit4] \n   [junit4] \"Low Memory Detector\" daemon prio=5 tid=0x000000080113c800 nid=0x157ffc5 runnable [0x0000000000000000]\n   [junit4]    java.lang.Thread.State: RUNNABLE\n   [junit4] \n   [junit4] \"C2 CompilerThread1\" daemon prio=5 tid=0x000000080113b800 nid=0x157ffc4 waiting on condition [0x0000000000000000]\n   [junit4]    java.lang.Thread.State: RUNNABLE\n   [junit4] \n   [junit4] \"C2 CompilerThread0\" daemon prio=5 tid=0x000000080113b000 nid=0x157ffc3 waiting on condition [0x0000000000000000]\n   [junit4]    java.lang.Thread.State: RUNNABLE\n   [junit4] \n   [junit4] \"Signal Dispatcher\" daemon prio=5 tid=0x000000080113a000 nid=0x157ffc2 waiting on condition [0x0000000000000000]\n   [junit4]    java.lang.Thread.State: RUNNABLE\n   [junit4] \n   [junit4] \"Finalizer\" daemon prio=5 tid=0x0000000801139800 nid=0x157ffbe in Object.wait() [0x00007ffffebed000]\n   [junit4]    java.lang.Thread.State: WAITING (on object monitor)\n   [junit4] \tat java.lang.Object.wait(Native Method)\n   [junit4] \t- waiting on <0x000000080b1899a8> (a java.lang.ref.ReferenceQueue$Lock)\n   [junit4] \tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:133)\n   [junit4] \t- locked <0x000000080b1899a8> (a java.lang.ref.ReferenceQueue$Lock)\n   [junit4] \tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:149)\n   [junit4] \tat java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:177)\n   [junit4] \n   [junit4] \"Reference Handler\" daemon prio=5 tid=0x0000000801138800 nid=0x157ffbd in Object.wait() [0x00007ffffecee000]\n   [junit4]    java.lang.Thread.State: WAITING (on object monitor)\n   [junit4] \tat java.lang.Object.wait(Native Method)\n   [junit4] \t- waiting on <0x000000080b18e380> (a java.lang.ref.Reference$Lock)\n   [junit4] \tat java.lang.Object.wait(Object.java:502)\n   [junit4] \tat java.lang.ref.Reference$ReferenceHandler.run(Reference.java:133)\n   [junit4] \t- locked <0x000000080b18e380> (a java.lang.ref.Reference$Lock)\n   [junit4] \n   [junit4] \"main\" prio=5 tid=0x0000000801138000 nid=0x157f98f in Object.wait() [0x00007fffffbfd000]\n   [junit4]    java.lang.Thread.State: WAITING (on object monitor)\n   [junit4] \tat java.lang.Object.wait(Native Method)\n   [junit4] \t- waiting on <0x000000080cefa630> (a com.carrotsearch.randomizedtesting.RandomizedRunner$2)\n   [junit4] \tat java.lang.Thread.join(Thread.java:1203)\n   [junit4] \t- locked <0x000000080cefa630> (a com.carrotsearch.randomizedtesting.RandomizedRunner$2)\n   [junit4] \tat java.lang.Thread.join(Thread.java:1256)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSuite(RandomizedRunner.java:560)\n   [junit4] \tat com.carrotsearch.randomizedtesting.RandomizedRunner.run(RandomizedRunner.java:519)\n   [junit4] \tat org.junit.runner.JUnitCore.run(JUnitCore.java:157)\n   [junit4] \tat com.carrotsearch.ant.tasks.junit4.slave.SlaveMain.execute(SlaveMain.java:129)\n   [junit4] \tat com.carrotsearch.ant.tasks.junit4.slave.SlaveMain.main(SlaveMain.java:202)\n   [junit4] \tat com.carrotsearch.ant.tasks.junit4.slave.SlaveMainSafe.main(SlaveMainSafe.java:12)\n   [junit4] \n   [junit4] \"VM Thread\" prio=5 tid=0x0000000801196800 nid=0x157fdcd runnable \n   [junit4] \n   [junit4] \"GC task thread#0 (ParallelGC)\" prio=5 tid=0x000000080118d800 nid=0x157f993 runnable \n   [junit4] \n   [junit4] \"GC task thread#1 (ParallelGC)\" prio=5 tid=0x000000080118e800 nid=0x157fa80 runnable \n   [junit4] \n   [junit4] \"GC task thread#2 (ParallelGC)\" prio=5 tid=0x000000080118f000 nid=0x157fb09 runnable \n   [junit4] \n   [junit4] \"GC task thread#3 (ParallelGC)\" prio=5 tid=0x000000080118f800 nid=0x157fbaa runnable \n   [junit4] \n   [junit4] \"GC task thread#4 (ParallelGC)\" prio=5 tid=0x0000000801190000 nid=0x157fbae runnable \n   [junit4] \n   [junit4] \"GC task thread#5 (ParallelGC)\" prio=5 tid=0x0000000801191000 nid=0x157fd94 runnable \n   [junit4] \n   [junit4] \"GC task thread#6 (ParallelGC)\" prio=5 tid=0x0000000801191800 nid=0x157fdb4 runnable \n   [junit4] \n   [junit4] \"GC task thread#7 (ParallelGC)\" prio=5 tid=0x0000000801192000 nid=0x157fdb8 runnable \n   [junit4] \n   [junit4] \"GC task thread#8 (ParallelGC)\" prio=5 tid=0x0000000801192800 nid=0x157fdb9 runnable \n   [junit4] \n   [junit4] \"GC task thread#9 (ParallelGC)\" prio=5 tid=0x0000000801193800 nid=0x157fdbc runnable \n   [junit4] \n   [junit4] \"GC task thread#10 (ParallelGC)\" prio=5 tid=0x0000000801194000 nid=0x157fdbf runnable \n   [junit4] \n   [junit4] \"GC task thread#11 (ParallelGC)\" prio=5 tid=0x0000000801194800 nid=0x157fdc0 runnable \n   [junit4] \n   [junit4] \"GC task thread#12 (ParallelGC)\" prio=5 tid=0x0000000801195000 nid=0x157fdc1 runnable \n   [junit4] \n   [junit4] \"VM Periodic Task Thread\" prio=5 tid=0x0000000801197000 nid=0x157ffc6 waiting on condition \n   [junit4] \n   [junit4] JNI global references: 1765\n   [junit4] \n   [junit4] Heap\n   [junit4]  PSYoungGen      total 160064K, used 11590K [0x0000000820580000, 0x000000082b020000, 0x000000082b020000)\n   [junit4]   eden space 151552K, 2% used [0x0000000820580000,0x0000000820888f60,0x0000000829980000)\n   [junit4]   from space 8512K, 99% used [0x0000000829980000,0x000000082a1c8b00,0x000000082a1d0000)\n   [junit4]   to   space 14656K, 0% used [0x000000082a1d0000,0x000000082a1d0000,0x000000082b020000)\n   [junit4]  PSOldGen        total 308544K, used 104691K [0x000000080b020000, 0x000000081dd70000, 0x0000000820580000)\n   [junit4]   object space 308544K, 33% used [0x000000080b020000,0x000000081165cc08,0x000000081dd70000)\n   [junit4]  PSPermGen       total 25152K, used 21954K [0x0000000805e20000, 0x00000008076b0000, 0x000000080b020000)\n   [junit4]   object space 25152K, 87% used [0x0000000805e20000,0x0000000807390908,0x00000008076b0000)\n\n ",
            "author": "Robert Muir",
            "id": "comment-13265037"
        },
        {
            "date": "2012-04-30T20:33:12+0000",
            "content": "Ugh! I will look into this hopefully soon! ",
            "author": "Simon Willnauer",
            "id": "comment-13265189"
        },
        {
            "date": "2012-05-09T18:32:37+0000",
            "content": "I think I see the problem here. I am ignoring a return value in the stall control which is subject for races. I wasn't able to reproduce this failure so it basically a blind shot. I will try reproducing this. ",
            "author": "Simon Willnauer",
            "id": "comment-13271671"
        },
        {
            "date": "2012-05-09T20:49:09+0000",
            "content": "Maybe just commit this patch since it seems like a problem. Its possible its not the problem here,\nbut it seems like a problem in any case? ",
            "author": "Robert Muir",
            "id": "comment-13271795"
        },
        {
            "date": "2012-05-11T13:47:51+0000",
            "content": "here is a new patch with a testcase that exercises this code more. I got this test to fail 1 in 20K runs with the \"bug\" and it didn't fail with the fix. Still not an evidence but better than no test, that's for sure. ",
            "author": "Simon Willnauer",
            "id": "comment-13273261"
        },
        {
            "date": "2012-05-16T07:39:43+0000",
            "content": "seems like I missed to attached the testcase ",
            "author": "Simon Willnauer",
            "id": "comment-13276555"
        }
    ]
}