{
    "id": "LUCENE-5072",
    "title": "Fix frame injection bug in javadocs generated with Java 6 (and Java 7 prior u25)",
    "details": {
        "components": [
            "general/build"
        ],
        "fix_versions": [
            "4.4",
            "6.0"
        ],
        "affect_versions": "4.3.1",
        "priority": "Major",
        "labels": "",
        "type": "Bug",
        "resolution": "Fixed",
        "status": "Closed"
    },
    "description": "The Apache Infra / Security team posted to all committers:\n\n\nHi All,\n\nOracle has announced [1], [2] a frame injection vulnerability in Javadoc generated by Java 5, Java 6 and Java 7 before update 22.\n\n[...]\n\nPlease take the necessary steps to fix any currently published Javadoc and to ensure that any future Javadoc published by your project does not contain the vulnerability. The announcement by Oracle includes a link to a tool that can be used to fix Javadoc without regeneration.\n\nThe infrastructure team is investigating options for preventing the publication of vulnerable Javadoc.\n\nThe issue is public and may be discussed freely on your project's dev list.\n\nThanks,\n\nMark (ASF Infra)\n\nI fixed all published Javadocs on http://lucene.apache.org (for all historic releases where we have public available Javadocs on the web page).\n\nThe mail also notes that we should not publish javadocs with this javadocs problem in the future. Unfortunately the release manager has to use the latest Java 7u25 version (released 2 days) ago. This would be fine for Lucene trunk (which is Java 7 only).\n\nBut when we generate Javadocs JARs for Lucene 3 and 4, we cannot use Java 7 (to build the official release) because the javadocs would contain e.g. AutoCloaseable interface unless we use a JDK 6 or 5 bootclasspath (like we do for web pages).\n\nWe also want the lucene/solr-*-javadoc.jar files to be correct, but those are built with Java 5 (3.x) or Java 6 (4.x).\n\nUnfortunately Oracle does not relaese a newer JDK 5 or JDK 6, so its impossible to do a release.\n\nBut Oracle publishes the binary and source code of a \"fix tool\", that can be run on top of a tree of HTML files, patching all broken files (and only those). You can run it theoretically on the root folder of your harddisk - I did this on the whole lucene.apache.org web site.\n\nRobert Muir and I were looking for a IVY-compatible solution (the original Oracle tool cannot be automatically downloaded by IVY, as Oracle's website sets cookies and requests license confirmations). We found the following GITHUB project by olamy/karianna:\n\nhttps://github.com/AdoptOpenJDK/JavadocUpdaterTool\n\nAs soon as they release the JAR file officially on Maven, we can download it with IVY and use it. This is a Maven Plugin, but it still contains the original source code of Oracle's tool, so we can execute it as ANT task after loading the JAR with IVY's coordinates: <java fork=\"false\" class=\"...\"/>\n\nIn the GITHUB project description they note that you need JDK7 to use the tool, but this is no longer true, the -source/-target is Java 5 now, so we can run it easily.\n\nI will add the required tasks in common-build.xml's javadoc macro so it post-processes all javadocs and patches vulnerable files. If you build javadocs with a recent JDK, it would do nothing.",
    "attachments": {
        "LUCENE-5072.patch": "https://issues.apache.org/jira/secure/attachment/12589273/LUCENE-5072.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2013-06-22T21:33:24+0000",
            "content": "As soon as they release the JAR file officially on Maven, we can download it with IVY and use it. This is a Maven Plugin, but it still contains the original source code of Oracle's tool, so we can execute it as ANT task after loading the JAR with IVY's coordinates: <java fork=\"false\" class=\"...\"/>\n\nSee LEGAL-171, where they're discussing whether Apache can distribute this code. ",
            "author": "Steve Rowe",
            "id": "comment-13691256"
        },
        {
            "date": "2013-06-22T21:38:22+0000",
            "content": "Cool, so we could maybe put the tool into our tools folder and use it from there. The original Oracle tool has a forbidden-api problem: It used default charset to process javadocs files  \n\nIf LEGAL-171 does not solve the problem, we can use the Maven plugin as it is an internal build tool (like we use svnkit or groovy for our builds) and not linked into the product. ",
            "author": "Uwe Schindler",
            "id": "comment-13691258"
        },
        {
            "date": "2013-06-22T21:47:23+0000",
            "content": "There is no need for any legal decision. We don't need to distribute anything, just invoke the tool in our build. Just like calling javac itself, which is gpl/proprietary. ",
            "author": "Robert Muir",
            "id": "comment-13691260"
        },
        {
            "date": "2013-06-22T21:54:38+0000",
            "content": "I checked the javadoc pather tool:\n\n\tAs said before it uses default encoding to patch files -> die, die, die\n\tIt only detects a \"string signature in a file\" -> replace by a <fileSet/> in ANT!\n\tIt does a simple search/replace of a string -> use ANT copy task to patch with <filterreader/>\n\n\n\nFinally, we dont need to use Oracle's code to recursively patch javadocs, We can do that with a simple fileset after the javadocs run and patch with ANT's own <copy/> task. ",
            "author": "Uwe Schindler",
            "id": "comment-13691261"
        },
        {
            "date": "2013-06-22T22:47:39+0000",
            "content": "Attached is a patch that works without Oracle's proprietary license. The patching is done completely with ANT and its own search/replace logic:\n\n\n\tUse a fileset on the vulnerable filename pattern **/index.htm*,**/toc.htm*, with restriction to all files that do not contain the \"validURL(url)\" pattern (which appears after u25)\n\treplace the vulnerable call by the javascript code from Oracle's patch\n\n\n\nAbout License: The Javscript code in this patch is also autogenerated by Oracle's own tool, so its license should not matter (because Oracle's tool prints it in every file we distribute - we just emulate what Oracle's tool does).\n\nWhat do you think? ",
            "author": "Uwe Schindler",
            "id": "comment-13691269"
        },
        {
            "date": "2013-06-22T22:51:50+0000",
            "content": "Previous patch had a bug in fileset and includes... ",
            "author": "Uwe Schindler",
            "id": "comment-13691272"
        },
        {
            "date": "2013-06-22T23:33:16+0000",
            "content": "About License: The Javscript code in this patch is also autogenerated by Oracle's own tool, so its license should not matter (because Oracle's tool prints it in every file we distribute - we just emulate what Oracle's tool does).\n\n+1, I agree with this.\n\nI patched trunk ran ant generate-maven-artifacts using Oracle 1.7.0_21 JDK on OS X - I saw lines like the following in Ant's output, so the macro is doing its job:\n\n\n[patch-javadoc] Replaced 1 occurrences in 1 files.\n\n\n\nI then unpacked all the *-javadoc.jar files under dist/, then ran the following, which printed nothing, which I judge as success:\n\n\ngrep -L 'function validURL(url) {' $(grep -l 'function loadFrames() {' $(find . -name index.htm -o -name index.html -o -name toc.htm -o -name toc.html))\n\n\n\nThen I ran ant clean documentation and the following script also printed nothing, again success:\n\n\ngrep -L 'function validURL(url) {' $(grep -l 'function loadFrames() {' $(find {lucene,solr}/build/docs -name index.html -o -name index.htm -o -name toc.htm -o -name toc.html))\n\n\n\n+1 for the patch ",
            "author": "Steve Rowe",
            "id": "comment-13691285"
        },
        {
            "date": "2013-06-22T23:34:31+0000",
            "content": "Minimal update (added expandProperties=\"false\" to replacement text). ",
            "author": "Uwe Schindler",
            "id": "comment-13691286"
        },
        {
            "date": "2013-06-22T23:37:06+0000",
            "content": "I also checked:\n\n\tI used 1.6.0_32 to build documentation\n\tAfter building I rand the official Oracle tool in check mode: java -jar JavadocUpdaterTool.jar -R -C . and it reported no vulnerability.\n\n\n\nThe Javadocs still work (swithcing on/off frames). ",
            "author": "Uwe Schindler",
            "id": "comment-13691287"
        },
        {
            "date": "2013-06-23T09:06:10+0000",
            "content": "Attached is a patch with better \"API\" to make the macro be reuseable in other projects, to encourage users to use it in their own ant builds.\n\nThe attributes on <patch-javadoc/> are similar to javadoc's encoding with same defaults for charset. It also chaks all possible case-insensitive index.htm* and toc.htm* files as specified in the original Oracle tool. ",
            "author": "Uwe Schindler",
            "id": "comment-13691398"
        },
        {
            "date": "2013-06-23T09:43:30+0000",
            "content": "For all other projects that use ANT and want to fix the javadocs directly after execution of Ant's Javadoc task: Just copy the following Ant macro into your project and invoke it directly after <javadoc/>:\n\n\n  <!--\n    Patch frame injection bugs in javadoc generated files - see CVE-2013-1571, http://www.kb.cert.org/vuls/id/225657\n    \n    Feel free to use this macro in your own Ant build file. This macro works together with the javadoc task on Ant\n    and should be invoked directly after its execution to patch broken javadocs, e.g.:\n      <patch-javadoc dir=\"...\" docencoding=\"UTF-8\"/>\n    Please make sure that the docencoding parameter uses the same charset like javadoc's docencoding. Default\n    is the platform default encoding (like the javadoc task).\n    The specified dir is the destination directory of the javadoc task.\n  -->\n  <macrodef name=\"patch-javadoc\">\n    <attribute name=\"dir\"/>\n    <attribute name=\"docencoding\" default=\"${file.encoding}\"/>\n    <sequential>\n      <replace encoding=\"@{docencoding}\" summary=\"true\" taskname=\"patch-javadoc\">\n        <fileset dir=\"@{dir}\" casesensitive=\"false\" includes=\"**/index.html,**/index.htm,**/toc.html,**/toc.htm\">\n          <!-- TODO: add encoding=\"@{docencoding}\" to contains check, when we are on ANT 1.9.0: -->\n          <not><contains text=\"function validURL(url) {\" casesensitive=\"true\" /></not>\n        </fileset>\n        <replacetoken><![CDATA[function loadFrames() {]]></replacetoken>\n        <replacevalue expandProperties=\"false\"><![CDATA[if (targetPage != \"\" && !validURL(targetPage))\n        targetPage = \"undefined\";\n    function validURL(url) {\n        var pos = url.indexOf(\".html\");\n        if (pos == -1 || pos != url.length - 5)\n            return false;\n        var allowNumber = false;\n        var allowSep = false;\n        var seenDot = false;\n        for (var i = 0; i < url.length - 5; i++) {\n            var ch = url.charAt(i);\n            if ('a' <= ch && ch <= 'z' ||\n                    'A' <= ch && ch <= 'Z' ||\n                    ch == '$' ||\n                    ch == '_') {\n                allowNumber = true;\n                allowSep = true;\n            } else if ('0' <= ch && ch <= '9'\n                    || ch == '-') {\n                if (!allowNumber)\n                     return false;\n            } else if (ch == '/' || ch == '.') {\n                if (!allowSep)\n                    return false;\n                allowNumber = false;\n                allowSep = false;\n                if (ch == '.')\n                     seenDot = true;\n                if (ch == '/' && seenDot)\n                     return false;\n            } else {\n                return false;\n            }\n        }\n        return true;\n    }\n    function loadFrames() {]]></replacevalue>\n      </replace>\n    </sequential>\n  </macrodef>\n\n ",
            "author": "Uwe Schindler",
            "id": "comment-13691419"
        },
        {
            "date": "2013-06-23T11:21:17+0000",
            "content": "I rand the official Oracle tool in check mode: java -jar JavadocUpdaterTool.jar -R -C . and it reported no vulnerability.\n\nThat's a necessary condition, but not sufficient as the tool only checks certain markers; it does not do a formal analysis of the code. It would not detect an error in the validURL function, nor in the file matching.\n\nIt would be better to compare the output of the Ant tool with the output of the Oracle tool when run against an entire Javadoc tree.\n\nIdeally this should be repeated with multiple Javadoc trees from different versions of the vulnerable Javadoc tool in different encodings. ",
            "author": "Sebb",
            "id": "comment-13691438"
        },
        {
            "date": "2013-06-23T11:30:04+0000",
            "content": "Hi Sebb,\nof course that's what i I did. The confirmation I sent here is just the \"final\" check. When using correct charset encoding (which is buggy in Oracle's tool, because it uses Oracle's default), the output is identical. ",
            "author": "Uwe Schindler",
            "id": "comment-13691439"
        },
        {
            "date": "2013-06-23T11:31:15+0000",
            "content": "I am currently also investigating how the tool handles non-official Oracle JDK Javadocs: IBM J9 and Oracle JRockit 6. ",
            "author": "Uwe Schindler",
            "id": "comment-13691440"
        },
        {
            "date": "2013-06-23T11:37:38+0000",
            "content": "Sebb: the main problem is not only correctness of our tool (implemented in ANT). The tool as provided by Oracle is buggy-as-hell\u2122, so I would never recommend it to use it in any offical build script. The intention of Oracle was to fix already published Javadocs - and it fails to do this correct if your platform's default encoding is not the one of your javadocs!\n\nAs mentioned on MJAVADOC-370 (Codehaus), I would include the \"correct\" and platform encoding independent solution into Maven (and also Ant!) core libs. Don't use Oracle's buggy, buggy, buggy tool, please - it has more bugs than it fixes! ",
            "author": "Uwe Schindler",
            "id": "comment-13691442"
        },
        {
            "date": "2013-06-23T17:58:34+0000",
            "content": "New patch (with the exact file name pattern, case insensitive as in Oracle's tool), ready to commit!\n\nI will commit this tomorrow if nobody objects. This will also fix Jenkins javadoc artifacts as mentioned on builds@ao. ",
            "author": "Uwe Schindler",
            "id": "comment-13691540"
        },
        {
            "date": "2013-06-24T12:27:17+0000",
            "content": "I filed an ANT issue about this, although it would not really help us (unless we force users to upgrade once a fixed ANT version was released): https://issues.apache.org/bugzilla/show_bug.cgi?id=55132 ",
            "author": "Uwe Schindler",
            "id": "comment-13691927"
        },
        {
            "date": "2013-07-23T18:37:02+0000",
            "content": "Bulk close resolved 4.4 issues ",
            "author": "Steve Rowe",
            "id": "comment-13716728"
        }
    ]
}