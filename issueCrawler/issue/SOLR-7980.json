{
    "id": "SOLR-7980",
    "title": "CorruptIndex exceptions in ChaosMonkeySafeLeaderTest",
    "details": {
        "components": [],
        "type": "Bug",
        "labels": "",
        "fix_versions": [],
        "affect_versions": "None",
        "status": "Open",
        "resolution": "Unresolved",
        "priority": "Major"
    },
    "description": "Found during investigation of SOLR-7836\nIf you loop the test long enough, you'll occasionally see CorruptIndex exceptions, although it won't cause the test to fail.",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2015-08-26T20:24:34+0000",
            "author": "Yonik Seeley",
            "content": "Examples:\n\n\n  2> 25342 WARN  (qtp1987916571-72) [n:127.0.0.1:32803_ c:collection1 s:shard2 r:core_node1 x:collection1] o.a.s.h.ReplicationHandler Could not read check\nsum from index file: _0_SimpleText_0.pst\n  2> org.apache.lucene.index.CorruptIndexException: codec footer mismatch (file truncated?): actual footer=808464432 vs expected footer=-1071082520 (resource=MMapIndexInput(path=\"/opt/code/lusolr_trunk2/solr/build/solr-core/test/J0/temp/solr.cloud.ChaosMonkeySafeLeaderTest_38F55D766B70D5BD-001/shard-1-001/cores/collection1/data/index/_0_SimpleText_0.pst\"))\n  2>    at org.apache.lucene.codecs.CodecUtil.validateFooter(CodecUtil.java:416)\n  2>    at org.apache.lucene.codecs.CodecUtil.retrieveChecksum(CodecUtil.java:401)\n  2>    at org.apache.solr.handler.ReplicationHandler.getFileList(ReplicationHandler.java:558)\n  2>    at org.apache.solr.handler.ReplicationHandler.handleRequestBody(ReplicationHandler.java:247)\n  2>    at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:151)\n  2>    at org.apache.solr.core.SolrCore.execute(SolrCore.java:2079)\n  2>    at org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:667)\n  2>    at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:460)\n  2>    at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:210)\n  2>    at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:179)\n  2>    at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\n  2>    at org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:106)\n  2>    at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\n  2>    at org.eclipse.jetty.servlets.UserAgentFilter.doFilter(UserAgentFilter.java:83)\n  2>    at org.eclipse.jetty.servlets.GzipFilter.doFilter(GzipFilter.java:364)\n  2>    at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1652)\n  2>    at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:585)\n  2>    at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:221)\n  2>    at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1127)\n  2>    at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:515)\n  2>    at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\n  2>    at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1061)\n  2>    at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n  2>    at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97)\n  2>    at org.eclipse.jetty.server.Server.handle(Server.java:499)\n  2>    at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:310)\n  2>    at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:257)\n  2>    at org.eclipse.jetty.io.AbstractConnection$2.run(AbstractConnection.java:540)\n  2>    at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:635)\n  2>    at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:555)\n  2>    at java.lang.Thread.run(Thread.java:745)\n\n\n\n\n2> 19962 WARN  (RecoveryThread-collection1) [n:127.0.0.1:49515_ c:collection1 s:shard1 r:core_node2 x:collection1] o.a.s.h.IndexFetcher Could not retrie\nve checksum from file.\n  2> java.lang.IllegalArgumentException: Seeking to negative position: MMapIndexInput(path=\"/opt/code/lusolr_trunk2/solr/build/solr-core/test/J0/temp/solr.cloud.ChaosMonkeySafeLeaderTest_1142D018587DF1D8-001/shard-2-001/cores/collection1/data/index/_0.fdx\")\n  2>    at org.apache.lucene.store.ByteBufferIndexInput$SingleBufferImpl.seek(ByteBufferIndexInput.java:408)\n  2>    at org.apache.lucene.codecs.CodecUtil.retrieveChecksum(CodecUtil.java:400)\n  2>    at org.apache.solr.handler.IndexFetcher.compareFile(IndexFetcher.java:876)\n  2>    at org.apache.solr.handler.IndexFetcher.downloadIndexFiles(IndexFetcher.java:839)\n  2>    at org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:437)\n  2>    at org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:265)\n  2>    at org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:382)\n  2>    at org.apache.solr.cloud.RecoveryStrategy.replicate(RecoveryStrategy.java:162)\n  2>    at org.apache.solr.cloud.RecoveryStrategy.doRecovery(RecoveryStrategy.java:437)\n  2>    at org.apache.solr.cloud.RecoveryStrategy.run(RecoveryStrategy.java:227)\n  2> Caused by: java.lang.IllegalArgumentException\n  2>    at java.nio.Buffer.position(Buffer.java:244)\n  2>    at org.apache.lucene.store.ByteBufferIndexInput$SingleBufferImpl.seek(ByteBufferIndexInput.java:405)\n  2>    ... 9 more\n  2> 19963 WARN  (RecoveryThread-collection1) [n:127.0.0.1:49515_ c:collection1 s:shard1 r:core_node2 x:collection1] o.a.s.h.IndexFetcher File _0.fdx did not match. expected length is 576 and actual length is 0\n  2> 19966 INFO  (qtp615760151-67) [n:127.0.0.1:39537_ c:collection1 s:shard1 r:core_node1 x:collection1] o.a.s.c.S.Request [collection1] webapp= path=/replication params={generation=2&qt=/replication&file=_0.fdx&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0 \n  2> 19979 INFO  (qtp615760151-71) [n:127.0.0.1:39537_ c:collection1 s:shard1 r:core_node1 x:collection1] o.a.s.c.S.Request [collection1] webapp= path=/replication params={generation=2&qt=/replication&file=_0_Lucene50_0.tip&checksum=true&wt=filestream&command=filecontent} status=0 QTime=0 \n  2> 19981 WARN  (RecoveryThread-collection1) [n:127.0.0.1:49515_ c:collection1 s:shard1 r:core_node2 x:collection1] o.a.s.h.IndexFetcher Could not retrieve checksum from file.\n  2> org.apache.lucene.index.CorruptIndexException: codec footer mismatch (file truncated?): actual footer=50675024 vs expected footer=-1071082520 (resource=MMapIndexInput(path=\"/opt/code/lusolr_trunk2/solr/build/solr-core/test/J0/temp/solr.cloud.ChaosMonkeySafeLeaderTest_1142D018587DF1D8-001/shard-2-001/cores/collection1/data/index/_0.fdt\"))\n  2>    at org.apache.lucene.codecs.CodecUtil.validateFooter(CodecUtil.java:416)\n  2>    at org.apache.lucene.codecs.CodecUtil.retrieveChecksum(CodecUtil.java:401)\n  2>    at org.apache.solr.handler.IndexFetcher.compareFile(IndexFetcher.java:876)\n  2>    at org.apache.solr.handler.IndexFetcher.downloadIndexFiles(IndexFetcher.java:839)\n  2>    at org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:437)\n  2>    at org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:265)\n  2>    at org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:382)\n  2>    at org.apache.solr.cloud.RecoveryStrategy.replicate(RecoveryStrategy.java:162)\n  2>    at org.apache.solr.cloud.RecoveryStrategy.doRecovery(RecoveryStrategy.java:437)\n  2>    at org.apache.solr.cloud.RecoveryStrategy.run(RecoveryStrategy.java:227)\n  2> 19982 WARN  (RecoveryThread-collection1) [n:127.0.0.1:49515_ c:collection1 s:shard1 r:core_node2 x:collection1] o.a.s.h.IndexFetcher File _0.fdt did not match. expected length is 27692 and actual length is 24575\n\n\n\n\n  2> 24514 WARN  (RecoveryThread-collection1) [n:127.0.0.1:60874_rq%2Fvp c:collection1 s:shard2 r:core_node3 x:collection1] o.a.s.h.IndexFetcher Could not retrieve checksum from file.\n  2> java.lang.IllegalArgumentException: Seeking to negative position: MMapIndexInput(path=\"/opt/code/lusolr_trunk2/solr/build/solr-core/test/J0/temp/solr.cloud.ChaosMonkeySafeLeaderTest_FA732538BC500952-001/shard-3-001/cores/collection1/data/index/_0.fdx\")\n  2>    at org.apache.lucene.store.ByteBufferIndexInput$SingleBufferImpl.seek(ByteBufferIndexInput.java:408)\n  2>    at org.apache.lucene.codecs.CodecUtil.retrieveChecksum(CodecUtil.java:400)\n  2>    at org.apache.solr.handler.IndexFetcher.compareFile(IndexFetcher.java:876)\n  2>    at org.apache.solr.handler.IndexFetcher.isIndexStale(IndexFetcher.java:947)\n  2>    at org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:390)\n  2>    at org.apache.solr.handler.IndexFetcher.fetchLatestIndex(IndexFetcher.java:265)\n  2>    at org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:382)\n  2>    at org.apache.solr.cloud.RecoveryStrategy.replicate(RecoveryStrategy.java:162)\n  2>    at org.apache.solr.cloud.RecoveryStrategy.doRecovery(RecoveryStrategy.java:437)\n  2>    at org.apache.solr.cloud.RecoveryStrategy.run(RecoveryStrategy.java:227)\n  2> Caused by: java.lang.IllegalArgumentException\n  2>    at java.nio.Buffer.position(Buffer.java:244)\n  2>    at org.apache.lucene.store.ByteBufferIndexInput$SingleBufferImpl.seek(ByteBufferIndexInput.java:405)\n  2>    ... 9 more\n\n ",
            "id": "comment-14715446"
        },
        {
            "date": "2015-08-27T15:41:33+0000",
            "author": "Mark Miller",
            "content": "I guess since that codec does not seem to support checksums, replication corruption can still happen in that case. I know we tried to prevent problems even in that case, but nothing as solid as the checksums.\n\nI would be concerned if you saw those test fails and the checksums where supported. ",
            "id": "comment-14716890"
        }
    ]
}