{
    "id": "LUCENE-4908",
    "title": "SortingAtomicReaderTest failure",
    "details": {
        "components": [
            "modules/other"
        ],
        "fix_versions": [
            "6.0"
        ],
        "affect_versions": "6.0",
        "priority": "Major",
        "labels": "",
        "type": "Bug",
        "resolution": "Fixed",
        "status": "Resolved"
    },
    "description": "Fails 100% for me on trunk, whether or not I give the seed below, but appears to be trunk only - the test passes on branch_4x:\n\nant test  -Dtestcase=SortingAtomicReaderTest -Dtests.seed=FDBC5417F9F1EC45 -Dtests.slow=true -Dtests.locale=ja_JP -Dtests.timezone=Africa/Juba -Dtests.file.encoding=UTF-8\n\n\ncommon.test:\n[junit4:pickseed] Seed property 'tests.seed' already defined: FDBC5417F9F1EC45\n[junit4:junit4] <JUnit4> says cze\u015b\u0107! Master seed: FDBC5417F9F1EC45\n[junit4:junit4] Executing 1 suite with 1 JVM.\n[junit4:junit4] \n[junit4:junit4] Started J0 PID(82211@smb.local).\n[junit4:junit4] Suite: org.apache.lucene.index.sorter.SortingAtomicReaderTest\n[junit4:junit4]   1> CheckReader failed\n[junit4:junit4]   1>     test: field norms.........OK [3 fields]\n[junit4:junit4]   1>     test: terms, freq, prox...ERROR: java.lang.ArrayIndexOutOfBoundsException: -1\n[junit4:junit4]   1> java.lang.ArrayIndexOutOfBoundsException: -1\n[junit4:junit4]   1> \tat org.apache.lucene.index.sorter.SortingAtomicReader$SortingDocsAndPositionsEnum.docID(SortingAtomicReader.java:562)\n[junit4:junit4]   1> \tat org.apache.lucene.search.DocIdSetIterator.slowAdvance(DocIdSetIterator.java:99)\n[junit4:junit4]   1> \tat org.apache.lucene.index.sorter.SortingAtomicReader$SortingDocsAndPositionsEnum.advance(SortingAtomicReader.java:557)\n[junit4:junit4]   1> \tat org.apache.lucene.index.CheckIndex.checkFields(CheckIndex.java:942)\n[junit4:junit4]   1> \tat org.apache.lucene.index.CheckIndex.testPostings(CheckIndex.java:1200)\n[junit4:junit4]   1> \tat org.apache.lucene.index.CheckIndex.testPostings(CheckIndex.java:1177)\n[junit4:junit4]   1> \tat org.apache.lucene.util._TestUtil.checkReader(_TestUtil.java:243)\n[junit4:junit4]   1> \tat org.apache.lucene.util._TestUtil.checkReader(_TestUtil.java:234)\n[junit4:junit4]   1> \tat org.apache.lucene.index.sorter.SortingAtomicReaderTest.beforeClassSortingAtomicReaderTest(SortingAtomicReaderTest.java:77)\n[junit4:junit4]   1> \tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n[junit4:junit4]   1> \tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n[junit4:junit4]   1> \tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n[junit4:junit4]   1> \tat java.lang.reflect.Method.invoke(Method.java:601)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1559)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$600(RandomizedRunner.java:79)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.RandomizedRunner$4.evaluate(RandomizedRunner.java:677)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:693)\n[junit4:junit4]   1> \tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:46)\n[junit4:junit4]   1> \tat org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:42)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:39)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:39)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n[junit4:junit4]   1> \tat org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:43)\n[junit4:junit4]   1> \tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n[junit4:junit4]   1> \tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:70)\n[junit4:junit4]   1> \tat org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:55)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:358)\n[junit4:junit4]   1> \tat java.lang.Thread.run(Thread.java:722)\n[junit4:junit4]   1>     test: stored fields.......OK [21 total field count; avg 1 fields per doc]\n[junit4:junit4]   1>     test: term vectors........ERROR [-1]\n[junit4:junit4]   1> java.lang.ArrayIndexOutOfBoundsException: -1\n[junit4:junit4]   1> \tat org.apache.lucene.index.sorter.SortingAtomicReader$SortingDocsAndPositionsEnum.docID(SortingAtomicReader.java:562)\n[junit4:junit4]   1> \tat org.apache.lucene.search.DocIdSetIterator.slowAdvance(DocIdSetIterator.java:99)\n[junit4:junit4]   1> \tat org.apache.lucene.index.sorter.SortingAtomicReader$SortingDocsAndPositionsEnum.advance(SortingAtomicReader.java:557)\n[junit4:junit4]   1> \tat org.apache.lucene.index.CheckIndex.testTermVectors(CheckIndex.java:1564)\n[junit4:junit4]   1> \tat org.apache.lucene.util._TestUtil.checkReader(_TestUtil.java:245)\n[junit4:junit4]   1> \tat org.apache.lucene.util._TestUtil.checkReader(_TestUtil.java:234)\n[junit4:junit4]   1> \tat org.apache.lucene.index.sorter.SortingAtomicReaderTest.beforeClassSortingAtomicReaderTest(SortingAtomicReaderTest.java:77)\n[junit4:junit4]   1> \tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n[junit4:junit4]   1> \tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n[junit4:junit4]   1> \tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n[junit4:junit4]   1> \tat java.lang.reflect.Method.invoke(Method.java:601)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1559)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.RandomizedRunner.access$600(RandomizedRunner.java:79)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.RandomizedRunner$4.evaluate(RandomizedRunner.java:677)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:693)\n[junit4:junit4]   1> \tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:46)\n[junit4:junit4]   1> \tat org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:42)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.rules.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:55)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:39)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:39)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n[junit4:junit4]   1> \tat org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:43)\n[junit4:junit4]   1> \tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:48)\n[junit4:junit4]   1> \tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:70)\n[junit4:junit4]   1> \tat org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:55)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\n[junit4:junit4]   1> \tat com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:358)\n[junit4:junit4]   1> \tat java.lang.Thread.run(Thread.java:722)\n[junit4:junit4]   1>     test: docvalues...........OK [0 total doc count; 4 docvalues fields]\n[junit4:junit4]   1> \n[junit4:junit4]   2> NOTE: test params are: codec=Lucene42: {id=PostingsFormat(name=TestBloomFilteredLucene41Postings), positions=PostingsFormat(name=Memory doPackFST= true), norm=MockVariableIntBlock(baseBlockSize=104), docs=PostingsFormat(name=TestBloomFilteredLucene41Postings), term_vectors=PostingsFormat(name=TestBloomFilteredLucene41Postings)}, docValues:{binary=DocValuesFormat(name=CheapBastard), numeric=DocValuesFormat(name=CheapBastard), sorted=DocValuesFormat(name=CheapBastard), sorted_set=DocValuesFormat(name=Lucene42)}, sim=DefaultSimilarity, locale=ja_JP, timezone=Africa/Juba\n[junit4:junit4]   2> NOTE: Mac OS X 10.8.3 x86_64/Oracle Corporation 1.7.0_13 (64-bit)/cpus=8,threads=1,free=87000136,total=117702656\n[junit4:junit4]   2> NOTE: All tests run in this JVM: [SortingAtomicReaderTest]\n[junit4:junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=SortingAtomicReaderTest -Dtests.seed=FDBC5417F9F1EC45 -Dtests.slow=true -Dtests.locale=ja_JP -Dtests.timezone=Africa/Juba -Dtests.file.encoding=UTF-8\n[junit4:junit4] ERROR   0.00s | SortingAtomicReaderTest (suite) <<<\n[junit4:junit4]    > Throwable #1: java.lang.RuntimeException: CheckReader failed\n[junit4:junit4]    > \tat __randomizedtesting.SeedInfo.seed([FDBC5417F9F1EC45]:0)\n[junit4:junit4]    > \tat org.apache.lucene.util._TestUtil.checkReader(_TestUtil.java:255)\n[junit4:junit4]    > \tat org.apache.lucene.util._TestUtil.checkReader(_TestUtil.java:234)\n[junit4:junit4]    > \tat org.apache.lucene.index.sorter.SortingAtomicReaderTest.beforeClassSortingAtomicReaderTest(SortingAtomicReaderTest.java:77)\n[junit4:junit4]    > \tat java.lang.Thread.run(Thread.java:722)\n[junit4:junit4] Completed in 1.12s, 0 tests, 1 error <<< FAILURES!\n[junit4:junit4] \n[junit4:junit4] \n[junit4:junit4] Tests with failures:\n[junit4:junit4]   - org.apache.lucene.index.sorter.SortingAtomicReaderTest (suite)\n[junit4:junit4] \n[junit4:junit4] \n[junit4:junit4] JVM J0:     0.63 ..     2.33 =     1.70s\n[junit4:junit4] Execution time total: 2.33 sec.\n[junit4:junit4] Tests summary: 1 suite, 0 tests, 1 suite-level error\n\nBUILD FAILED",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2013-04-04T21:12:49+0000",
            "content": "[trunk commit] jpountz\nhttp://svn.apache.org/viewvc?view=revision&revision=1464768\n\nLUCENE-4908: Fix SortingDocsAndPositionsEnum.docID() when the enum is not positioned yet. ",
            "author": "Commit Tag Bot",
            "id": "comment-13622781"
        },
        {
            "date": "2013-04-04T21:19:10+0000",
            "content": "That's due to the assertion I added to DocIdSetIterator.slowAdvance in LUCENE-4874. Sorry that I didn't catch this failure before committing... I committed a fix. ",
            "author": "Adrien Grand",
            "id": "comment-13622810"
        }
    ]
}