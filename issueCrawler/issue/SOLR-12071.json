{
    "id": "SOLR-12071",
    "title": "PULL replica cores initialisation fails when Cdcr enabled",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [
            "CDCR"
        ],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "7.2",
        "resolution": "Unresolved",
        "status": "Open"
    },
    "description": "CdcrUpdateLog never gets picked up for PULL type replicas and hence the core initialisation fails when a collection is CDCR enabled, obviously it can't be a leader, but followers.\n\n\n   [junit4]   2> 47345 INFO  (qtp1256767285-28) [n:127.0.0.1:50646_solr c:cdcr-cluster2 s:shard1 r:core_node4 x:cdcr-cluster2_shard1_replica_p2] o.a.s.m.SolrMetricManager Closing metric reporters for registry=solr.collection.cdcr-cluster2.shard1.leader, tag=895903268\n   [junit4]   2> 47353 INFO  (searcherExecutor-32-thread-1-processing-n:127.0.0.1:50646_solr x:cdcr-cluster2_shard1_replica_t1 s:shard1 c:cdcr-cluster2 r:core_node3) [n:127.0.0.1:50646_solr c:cdcr-cluster2 s:shard1 r:core_node3 x:cdcr-cluster2_shard1_replica_t1] o.a.s.c.SolrCore [cdcr-cluster2_shard1_replica_t1] Registered new searcher Searcher@638c50cd[cdcr-cluster2_shard1_replica_t1] main{ExitableDirectoryReader(UninvertingDirectoryReader())}\n   [junit4]   2> 47353 ERROR (qtp1256767285-28) [n:127.0.0.1:50646_solr c:cdcr-cluster2 s:shard1 r:core_node4 x:cdcr-cluster2_shard1_replica_p2] o.a.s.h.RequestHandlerBase org.apache.solr.common.SolrException: Error CREATEing SolrCore 'cdcr-cluster2_shard1_replica_p2': Unable to create core [cdcr-cluster2_shard1_replica_p2] Caused by: Solr instance is not configured with the cdcr update log.\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.create(CoreContainer.java:993)\n   [junit4]   2> \tat org.apache.solr.handler.admin.CoreAdminOperation.lambda$static$0(CoreAdminOperation.java:90)\n   [junit4]   2> \tat org.apache.solr.handler.admin.CoreAdminOperation.execute(CoreAdminOperation.java:358)\n   [junit4]   2> \tat org.apache.solr.handler.admin.CoreAdminHandler$CallInfo.call(CoreAdminHandler.java:389)\n   [junit4]   2> \tat org.apache.solr.handler.admin.CoreAdminHandler.handleRequestBody(CoreAdminHandler.java:174)\n   [junit4]   2> \tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:195)\n   [junit4]   2> \tat org.apache.solr.servlet.HttpSolrCall.handleAdmin(HttpSolrCall.java:736)\n   [junit4]   2> \tat org.apache.solr.servlet.HttpSolrCall.handleAdminRequest(HttpSolrCall.java:717)\n   [junit4]   2> \tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:498)\n   [junit4]   2> \tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:384)\n   [junit4]   2> \tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:330)\n   [junit4]   2> \tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1637)\n   [junit4]   2> \tat org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:139)\n   [junit4]   2> \tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1637)\n   [junit4]   2> \tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:533)\n   [junit4]   2> \tat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:188)\n   [junit4]   2> \tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1595)\n   [junit4]   2> \tat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:188)\n   [junit4]   2> \tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1253)\n   [junit4]   2> \tat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:168)\n   [junit4]   2> \tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:473)\n   [junit4]   2> \tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1564)\n   [junit4]   2> \tat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:166)\n   [junit4]   2> \tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1155)\n   [junit4]   2> \tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n   [junit4]   2> \tat org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:455)\n   [junit4]   2> \tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\n   [junit4]   2> \tat org.eclipse.jetty.server.Server.handle(Server.java:530)\n   [junit4]   2> \tat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:347)\n   [junit4]   2> \tat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:256)\n   [junit4]   2> \tat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:279)\n   [junit4]   2> \tat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:102)\n   [junit4]   2> \tat org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:124)\n   [junit4]   2> \tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:247)\n   [junit4]   2> \tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.produce(EatWhatYouKill.java:140)\n   [junit4]   2> \tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:131)\n   [junit4]   2> \tat org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:382)\n   [junit4]   2> \tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:708)\n   [junit4]   2> \tat org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:626)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:748)\n   [junit4]   2> Caused by: org.apache.solr.common.SolrException: Unable to create core [cdcr-cluster2_shard1_replica_p2]\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.createFromDescriptor(CoreContainer.java:1060)\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.create(CoreContainer.java:954)\n   [junit4]   2> \t... 39 more\n   [junit4]   2> Caused by: org.apache.solr.common.SolrException: Solr instance is not configured with the cdcr update log.\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.<init>(SolrCore.java:1008)\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.<init>(SolrCore.java:863)\n   [junit4]   2> \tat org.apache.solr.core.CoreContainer.createFromDescriptor(CoreContainer.java:1044)\n   [junit4]   2> \t... 40 more\n   [junit4]   2> Caused by: org.apache.solr.common.SolrException: Solr instance is not configured with the cdcr update log.\n   [junit4]   2> \tat org.apache.solr.handler.CdcrRequestHandler.inform(CdcrRequestHandler.java:259)\n   [junit4]   2> \tat org.apache.solr.core.SolrResourceLoader.inform(SolrResourceLoader.java:696)\n   [junit4]   2> \tat org.apache.solr.core.SolrCore.<init>(SolrCore.java:987)\n   [junit4]   2> \t... 42 more\n   [junit4]   2>",
    "attachments": {
        "SOLR-12071.patch": "https://issues.apache.org/jira/secure/attachment/12913679/SOLR-12071.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2018-03-11T21:03:26+0000",
            "content": "Design of fix in place:\n\n1. Skip the initialization of the CdcrRequestHandler; return with doing nothing, when Cdcr request is received by a PULL replica core.\n2. Redirect the requests to leader-node of the shards of the collection. It STILL doesn't guarantee the request will be received to the leader-core in which all the relevant components of Cdcr are initialised. It will redirect until the request is received by a leader-core.\n\nIt will redirect until the request is received by a leader-core.\nNot comfortable with an infinite loop of requests, need a better strategy to fail, probably adding an internal param to limit the requests. But when it fails, all the requests and processes which are dependent on COLLECTIONCHECKPOINT would get affected.\n\nRequesting feedback on how to handle this. ",
            "author": "Amrit Sarkar",
            "id": "comment-16394650"
        },
        {
            "date": "2018-03-15T14:40:17+0000",
            "content": "Improved the design just a bit:\n\n1. Forward the cdcr requests to leader-core url for the shard if received by PULL replica.\n2. Retry the forwarding of requests for maximum 50 times and then fail. ",
            "author": "Amrit Sarkar",
            "id": "comment-16400492"
        }
    ]
}