{
    "id": "SOLR-11961",
    "title": "group.query and sort with function getting error in solrcloud",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [
            "search",
            "SolrCloud"
        ],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "6.4,                                            6.4.2",
        "resolution": "Unresolved",
        "status": "Reopened"
    },
    "description": "while querying combination of group.query and sort function is not working\u00a0\n getting below error\u00a0\n\n\u00a0\n\nEnvironment :\u00a0\n Solr 6.4.2 and solr cloud mode with two shards and replication factor 2\u00a0\n AWS \u00a0with ubuntu\u00a0\n\nquery :/solr/qa/select?fq=((level:*.RL AND\u00a0\n im_field_destination_category:7845 AND im_field_geography:6937 AND\u00a0\n im_field_legacy_category:(7875 OR 12949 OR 7902 OR 12954) AND\u00a0\n im_field_report_research_type:7854) OR (im_field_destination_category:7845\u00a0\n AND im_field_geography:6937 AND im_field_legacy_category:(7875 OR 12949 OR\u00a0\n 7902 OR 12954) AND im_field_report_research_type:7855 AND\u00a0\n ${sku}))&group.query= im_field_deliverable_type:(12941)&group.query=\u00a0\n im_field_deliverable_type:(12941)&group=true&indent=on&q=:&sku=sm_field_sku:(manpq7416\u00a0\n OR TTPMUS0005A OR TTPXSI1015US OR TTPMUS0004B OR\u00a0\n TTPDPRUS0215)&sort=product(if(exists(query({!v=\"${sku}\"})),1,0),2)\u00a0\n desc&wt=json\u00a0\n\nif run same query in sudo node will working ,please help me on this\u00a0\n\nError:\u00a0\n\n{\u00a0\n \u00a0 \"responseHeader\":{\u00a0\n \u00a0 \u00a0 \"zkConnected\":true,\u00a0\n \u00a0 \u00a0 \"status\":500,\u00a0\n \u00a0 \u00a0 \"QTime\":8,\u00a0\n \u00a0 \u00a0 \"params\":{\u00a0\n \u00a0 \u00a0 \u00a0 \"q\":\":\",\u00a0\n \u00a0 \u00a0 \u00a0 \"indent\":\"on\",\u00a0\n \u00a0 \u00a0 \u00a0 \"fq\":\"((level:*.RL AND im_field_destination_category:7845 AND\u00a0\n im_field_geography:6937 AND im_field_legacy_category:(7875 OR 12949 OR 7902\u00a0\n OR 12954) AND im_field_report_research_type:7854) OR\u00a0\n (im_field_destination_category:7845 AND im_field_geography:6937 AND\u00a0\n im_field_legacy_category:(7875 OR 12949 OR 7902 OR 12954) AND\u00a0\n im_field_report_research_type:7855 AND ${sku}))\",\u00a0\n \u00a0 \u00a0 \u00a0 \"sort\":\"product(if(exists(query({!v=\\\"${sku}\\\"})),1,0),2) desc\",\u00a0\n \u00a0 \u00a0 \u00a0 \"group.query\":[\" im_field_deliverable_type:(12941)\",\u00a0\n \u00a0 \u00a0 \u00a0 \u00a0 \" im_field_deliverable_type:(12941)\"],\u00a0\n \u00a0 \u00a0 \u00a0 \"sku\":\"sm_field_sku:(manpq7416 OR TTPMUS0005A OR TTPXSI1015US OR\u00a0\n TTPMUS0004B OR TTPDPRUS0215)\",\u00a0\n \u00a0 \u00a0 \u00a0 \"wt\":\"json\",\u00a0\n \u00a0 \u00a0 \u00a0 \"_\":\"1518098081571\",\u00a0\n \u00a0 \u00a0 \u00a0 \"group\":\"true\"}},\u00a0\n \u00a0 \"error\":{\u00a0\n \u00a0 \u00a0 \"metadata\":[\u00a0\n \u00a0 \u00a0 \u00a0 \"error-class\",\"org.apache.solr.common.SolrException\",\u00a0\n \u00a0 \u00a0 \u00a0\u00a0\n \"root-error-class\",\"org.apache.solr.client.solrj.impl.HttpSolrClient$RemoteSolrException\"],\u00a0\n \u00a0 \u00a0 \"msg\":\"org.apache.solr.client.solrj.SolrServerException: No live\u00a0\n SolrServers available to handle this\u00a0\n request:[http://172.22.0.231:8983/solr/qa_shard1_replica2,\u00a0\n http://172.22.0.231:8983/solr/qa_shard2_replica2,\u00a0\n http://172.22.1.249:8983/solr/qa_shard1_replica3]\",\u00a0\n \u00a0 \u00a0 \"trace\":\"org.apache.solr.common.SolrException:\u00a0\n org.apache.solr.client.solrj.SolrServerException: No live SolrServers\u00a0\n available to handle this\u00a0\n request:[http://172.22.0.231:8983/solr/qa_shard1_replica2,\u00a0\n http://172.22.0.231:8983/solr/qa_shard2_replica2,\u00a0\n http://172.22.1.249:8983/solr/qa_shard1_replica3]\\n\\tat\u00a0\n org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:415)\\n\\tat\u00a0\n org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:166)\\n\\tat\u00a0\n org.apache.solr.core.SolrCore.execute(SolrCore.java:2299)\\n\\tat\u00a0\n org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:658)\\n\\tat\u00a0\n org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:464)\\n\\tat\u00a0\n org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:345)\\n\\tat\u00a0\n org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:296)\\n\\tat\u00a0\n org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1691)\\n\\tat\u00a0\n org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:582)\\n\\tat\u00a0\n org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\\n\\tat\u00a0\n org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\\n\\tat\u00a0\n org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:226)\\n\\tat\u00a0\n org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1180)\\n\\tat\u00a0\n org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:512)\\n\\tat\u00a0\n org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\\n\\tat\u00a0\n org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1112)\\n\\tat\u00a0\n org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\\n\\tat\u00a0\n org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)\\n\\tat\u00a0\n org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:119)\\n\\tat\u00a0\n org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)\\n\\tat\u00a0\n org.eclipse.jetty.server.Server.handle(Server.java:534)\\n\\tat\u00a0\n org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:320)\\n\\tat\u00a0\n org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:251)\\n\\tat\u00a0\n org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:273)\\n\\tat\u00a0\n org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:95)\\n\\tat\u00a0\n org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)\\n\\tat\u00a0\n org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.executeProduceConsume(ExecuteProduceConsume.java:303)\\n\\tat\u00a0\n org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceConsume(ExecuteProduceConsume.java:148)\\n\\tat\u00a0\n org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:136)\\n\\tat\u00a0\n org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:671)\\n\\tat\u00a0\n org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:589)\\n\\tat\u00a0\n java.lang.Thread.run(Thread.java:748)\\nCaused by:\u00a0\n org.apache.solr.client.solrj.SolrServerException: No live SolrServers\u00a0\n available to handle this\u00a0\n request:[http://172.22.0.231:8983/solr/qa_shard1_replica2,\u00a0\n http://172.22.0.231:8983/solr/qa_shard2_replica2,\u00a0\n http://172.22.1.249:8983/solr/qa_shard1_replica3]\\n\\tat\u00a0\n org.apache.solr.client.solrj.impl.LBHttpSolrClient.request(LBHttpSolrClient.java:414)\\n\\tat\u00a0\n org.apache.solr.handler.component.HttpShardHandlerFactory.makeLoadBalancedRequest(HttpShardHandlerFactory.java:302)\\n\\tat\u00a0\n org.apache.solr.handler.component.HttpShardHandler.lambda$submit$0(HttpShardHandler.java:166)\\n\\tat\u00a0\n java.util.concurrent.FutureTask.run(FutureTask.java:266)\\n\\tat\u00a0\n java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\\n\\tat\u00a0\n java.util.concurrent.FutureTask.run(FutureTask.java:266)\\n\\tat\u00a0\n com.codahale.metrics.InstrumentedExecutorService$InstrumentedRunnable.run(InstrumentedExecutorService.java:176)\\n\\tat\u00a0\n org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:229)\\n\\tat\u00a0\n java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\\n\\tat\u00a0\n java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\\n\\t...\u00a0\n 1 more\\nCaused by:\u00a0\n org.apache.solr.client.solrj.impl.HttpSolrClient$RemoteSolrException: Error\u00a0\n from server at\u00a0http://172.22.0.231:8983/solr/qa_shard1_replica2:\n java.lang.Double cannot be cast to org.apache.lucene.util.BytesRef\\n\\tat\u00a0\n org.apache.solr.client.solrj.impl.HttpSolrClient.executeMethod(HttpSolrClient.java:610)\\n\\tat\u00a0\n org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:279)\\n\\tat\u00a0\n org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:268)\\n\\tat\u00a0\n org.apache.solr.client.solrj.impl.LBHttpSolrClient.doRequest(LBHttpSolrClient.java:435)\\n\\tat\u00a0\n org.apache.solr.client.solrj.impl.LBHttpSolrClient.request(LBHttpSolrClient.java:387)\\n\\t...\u00a0\n 10 more\\n\",\u00a0\n \u00a0 \u00a0 \"code\":500}}",
    "attachments": {
        "Screen Shot 2018-02-13 at 11.41.45 AM.png": "https://issues.apache.org/jira/secure/attachment/12910334/Screen%20Shot%202018-02-13%20at%2011.41.45%20AM.png"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2018-02-09T20:40:56+0000",
            "content": "Please raise this question on the user's list at solr-user@lucene.apache.org, see: (http://lucene.apache.org/solr/community.html#mailing-lists-irc) there are a lot more people watching that list who may be able to help. \n\nIf it's determined that this really is a code issue in Solr and not a configuration/usage problem, we can raise a new JIRA or reopen this one.\n\nOffhand, the \"no live servers\" message would indicate that not all your nodes are up and running. If all your nodes are green and you still get the message then there's something bogus at least. If you could boil down your example to the essentials that would help a lot. ",
            "author": "Erick Erickson",
            "id": "comment-16358929"
        },
        {
            "date": "2018-02-13T06:44:16+0000",
            "content": "Erick Erickson\n\nFor the more reference i am attaching here screenshot of my server status. even marked this problem in\u00a0\u00a0(http://lucene.apache.org/solr/community.html#mailing-lists-irc\u00a0but no reponse from eny one ,can you guide me where we can do it code base change for this\u00a0 ",
            "author": "adeppa",
            "id": "comment-16361892"
        },
        {
            "date": "2018-02-13T12:53:50+0000",
            "content": "Erick Erickson Even i updated solr version from 6.4 to 6.6 still getting same error, All my nodes in green above screenshot\u00a0 will refer\u00a0 ",
            "author": "adeppa",
            "id": "comment-16362247"
        },
        {
            "date": "2018-02-19T16:57:58+0000",
            "content": "Well, then please nudge people on the user's list. The JIRA system is reserved for known bugs, and this does not (yet) qualify.\n\nbq: if tun same query in sudo node will working ,please help me on this\n\nThen it's highly likely this is a permissions issue where you installed Solr either as, say, root or at least as a user who has permissions to some directory and are running Solr as some user who does not have those permissions. ",
            "author": "Erick Erickson",
            "id": "comment-16369318"
        },
        {
            "date": "2018-02-24T18:52:50+0000",
            "content": "Erick Erickson\u00a0 solr user\u00a0 have a right permissions and one more thing same query running in sudo node server (without solrcloud ),\n\nFor the more reference i am adding query here group.query=\u00a0\n im_field_deliverable_type:(12941)&group=true&indent=on&q=:&sku=sm_field_sku:(manpq7416\u00a0\n OR TTPMUS0005A OR TTPXSI1015US OR TTPMUS0004B OR\u00a0\n TTPDPRUS0215)&sort=product(if(exists(query({!v=\"${sku}\"})),1,0),2)\u00a0\n desc&wt=json\u00a0\n\n\u00a0\n\nsort=product(if(exists(query({!v=\"${sku}\"})),1,0),2)\u00a0 this function working fine on sudo node server with\u00a0 group.query combination ,In solrcloud is not working showing exception \n\nSo reopening this card we can discuss if have time ,my personal mail id adeppa.t@gmail.com ",
            "author": "adeppa",
            "id": "comment-16375732"
        },
        {
            "date": "2018-02-24T18:53:57+0000",
            "content": "AS per the last comment reply here :\n\nSolr user\u00a0 have a right permissions and one more thing same query running in sudo node server (without solrcloud ), ",
            "author": "adeppa",
            "id": "comment-16375735"
        }
    ]
}