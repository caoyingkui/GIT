{
    "id": "SOLR-10936",
    "title": "ArrayIndexOutOfBoundsException: -65536 when indexing large document",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "6.6",
        "resolution": "Unresolved",
        "status": "Open"
    },
    "description": "I'm currently trying to index a large document with thousands of child documents. I see the following in solr.log. After that, the IndexWriter is closed and all subsequent updates fail.\n\n\n\n2017-06-21 19:33:37.284 ERROR (qtp959447386-21) [   x:kc] o.a.s.h.RequestHandlerBase org.apache.solr.common.SolrException: Exception writing document id 033c9919dfeb06dd6ae7166aad554652b8eadd6c6c602c6dd837d3324f715f99 to the index; possible analysis error.\n\tat org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:206)\n\tat org.apache.solr.update.processor.RunUpdateProcessor.processAdd(RunUpdateProcessorFactory.java:67)\n\tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\tat org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalAdd(DistributedUpdateProcessor.java:979)\n\tat org.apache.solr.update.processor.DistributedUpdateProcessor.versionAdd(DistributedUpdateProcessor.java:1192)\n\tat org.apache.solr.update.processor.DistributedUpdateProcessor.processAdd(DistributedUpdateProcessor.java:748)\n\tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\tat org.apache.solr.update.processor.AddSchemaFieldsUpdateProcessorFactory$AddSchemaFieldsUpdateProcessor.processAdd(AddSchemaFieldsUpdateProcessorFactory.java:336)\n\tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\tat org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:118)\n\tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\tat org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:118)\n\tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\tat org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:118)\n\tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\tat org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:118)\n\tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:55)\n\tat org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:118)\n\tat org.apache.solr.handler.loader.JavabinLoader$1.update(JavabinLoader.java:98)\n\tat org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec$1.readOuterMostDocIterator(JavaBinUpdateRequestCodec.java:180)\n\tat org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec$1.readIterator(JavaBinUpdateRequestCodec.java:136)\n\tat org.apache.solr.common.util.JavaBinCodec.readObject(JavaBinCodec.java:306)\n\tat org.apache.solr.common.util.JavaBinCodec.readVal(JavaBinCodec.java:251)\n\tat org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec$1.readNamedList(JavaBinUpdateRequestCodec.java:122)\n\tat org.apache.solr.common.util.JavaBinCodec.readObject(JavaBinCodec.java:271)\n\tat org.apache.solr.common.util.JavaBinCodec.readVal(JavaBinCodec.java:251)\n\tat org.apache.solr.common.util.JavaBinCodec.unmarshal(JavaBinCodec.java:173)\n\tat org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec.unmarshal(JavaBinUpdateRequestCodec.java:187)\n\tat org.apache.solr.handler.loader.JavabinLoader.parseAndLoadDocs(JavabinLoader.java:108)\n\tat org.apache.solr.handler.loader.JavabinLoader.load(JavabinLoader.java:55)\n\tat org.apache.solr.handler.UpdateRequestHandler$1.load(UpdateRequestHandler.java:97)\n\tat org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:68)\n\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:173)\n\tat org.apache.solr.core.SolrCore.execute(SolrCore.java:2477)\n\tat org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:723)\n\tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:529)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:361)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:305)\n\tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1691)\n\tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:582)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\n\tat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\n\tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:226)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1180)\n\tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:512)\n\tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1112)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n\tat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)\n\tat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:119)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)\n\tat org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:335)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)\n\tat org.eclipse.jetty.server.Server.handle(Server.java:534)\n\tat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:320)\n\tat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:251)\n\tat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:273)\n\tat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:95)\n\tat org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)\n\tat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.executeProduceConsume(ExecuteProduceConsume.java:303)\n\tat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceConsume(ExecuteProduceConsume.java:148)\n\tat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:136)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:671)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:589)\n\tat java.lang.Thread.run(Thread.java:748)\nCaused by: java.lang.ArrayIndexOutOfBoundsException: -65536\n\tat org.apache.lucene.index.TermsHashPerField.writeByte(TermsHashPerField.java:196)\n\tat org.apache.lucene.index.TermsHashPerField.writeVInt(TermsHashPerField.java:219)\n\tat org.apache.lucene.index.FreqProxTermsWriterPerField.writeProx(FreqProxTermsWriterPerField.java:89)\n\tat org.apache.lucene.index.FreqProxTermsWriterPerField.addTerm(FreqProxTermsWriterPerField.java:168)\n\tat org.apache.lucene.index.TermsHashPerField.add(TermsHashPerField.java:183)\n\tat org.apache.lucene.index.DefaultIndexingChain$PerField.invert(DefaultIndexingChain.java:796)\n\tat org.apache.lucene.index.DefaultIndexingChain.processField(DefaultIndexingChain.java:447)\n\tat org.apache.lucene.index.DefaultIndexingChain.processDocument(DefaultIndexingChain.java:403)\n\tat org.apache.lucene.index.DocumentsWriterPerThread.updateDocuments(DocumentsWriterPerThread.java:273)\n\tat org.apache.lucene.index.DocumentsWriter.updateDocuments(DocumentsWriter.java:433)\n\tat org.apache.lucene.index.IndexWriter.updateDocuments(IndexWriter.java:1384)\n\tat org.apache.solr.update.DirectUpdateHandler2.updateDocument(DirectUpdateHandler2.java:920)\n\tat org.apache.solr.update.DirectUpdateHandler2.updateDocOrDocValues(DirectUpdateHandler2.java:913)\n\tat org.apache.solr.update.DirectUpdateHandler2.doNormalUpdate(DirectUpdateHandler2.java:302)\n\tat org.apache.solr.update.DirectUpdateHandler2.addDoc0(DirectUpdateHandler2.java:239)\n\tat org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:194)\n\t... 64 more",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2017-06-22T10:08:08+0000",
            "content": "Thanks for your report. Looks like some signed int overflow or bitwise operation problems with buffers in TermsHashPerField.\n\nIs it reproducible? Can you try to come up with the simplest list of steps that will trigger the bug? If you cannot share your exact document content, can you perhaps attempt to create a synthetic/fake document with the same number of (fake) child docs?\n\nAlso, I see that you probably use data_driven_schema. Could you try to disable the auto-magic by removing this part from your solrconfig, and see if you are still able to reproduce? Note that you may need to construct your schema manually if you introduce new field names in your commit.\n\n  <initParams path=\"/update/**\">\n    <lst name=\"defaults\">\n      <str name=\"update.chain\">add-unknown-fields-to-the-schema</str>\n    </lst>\n  </initParams>\n\n ",
            "author": "Jan H\u00f8ydahl",
            "id": "comment-16059099"
        },
        {
            "date": "2017-07-18T15:42:18+0000",
            "content": "Jan H\u00f8ydahl thanks for getting me with this helpful advice. Since the document contains thousands of child documents with many different fields, I'm disinclined to turn off the unknown fields chain as a workaround.\n\nI dumped a copy of the SolrInputDocument as a serialized object to disk, so I can inspect it on demand. D'you have any idea what I should be looking for? ",
            "author": "Matthew Caruana Galizia",
            "id": "comment-16091729"
        },
        {
            "date": "2017-07-18T15:42:42+0000",
            "content": "I forgot to add that I can't share the document. ",
            "author": "Matthew Caruana Galizia",
            "id": "comment-16091732"
        },
        {
            "date": "2017-07-18T19:09:18+0000",
            "content": "I don't think you'll find anything wrong with your document.\n\nLooks like some overflow of a signed 16 bits integer, but I don't know that part of the code. So it would be useful if you could do as I said above, to start from an empty, clean Solr install, one node, one collection, same schema and config as your setup. Then write a small script that generates a nested document with the same number or more sub docs and fields as your problem doc. You should be able to reproduce it.\n\nOr another way could be to take your serialized SolrInputDocument and scramble its data, so that field names and content is not recognizable and then try to reproduce using that document. If it works, attach it to this jira. ",
            "author": "Jan H\u00f8ydahl",
            "id": "comment-16092020"
        },
        {
            "date": "2017-07-25T19:40:23+0000",
            "content": "Weirdly, it seems that the problem is coming from the field that stores spelling tokens. I turned on infoStream logging and saw this message just before the stack trace was printed:\n\nAn exception was thrown while processing field spell_text\n\nIn the managed schema, the relevant parts that define this field are:\n\n...\n  <fieldType name=\"text_spell\" class=\"solr.TextField\" positionIncrementGap=\"100\">\n    <analyzer>\n      <tokenizer class=\"solr.UAX29URLEmailTokenizerFactory\"/>\n      <filter class=\"solr.StopFilterFactory\" words=\"stopwords.txt\" ignoreCase=\"true\"/>\n      <filter class=\"solr.StandardFilterFactory\"/>\n      <filter class=\"solr.ICUFoldingFilterFactory\"/>\n      <filter class=\"solr.RemoveDuplicatesTokenFilterFactory\"/>\n    </analyzer>\n  </fieldType>\n...\n<dynamicField name=\"spell_*\" type=\"text_spell\" multiValued=\"true\" indexed=\"true\" stored=\"false\"/>\n...\n<copyField source=\"tika_content\" dest=\"spell_text\"/>\n...\n\nThe field tika_content contains the text extracted from the document using Tika.\n\nThe spellchecker component has the following definition:\n\n...\n        <searchComponent name=\"spellcheck\" class=\"solr.SpellCheckComponent\">\n                <str name=\"queryAnalyzerFieldType\">text_spell</str>\n                <lst name=\"spellchecker\">\n                        <str name=\"name\">text</str>\n                        <str name=\"field\">spell_text</str>\n                        <str name=\"spellcheckIndexDir\">./spell_text</str>\n                        <str name=\"accuracy\">0.7</str>\n                        <str name=\"buildOnOptimize\">true</str>\n                </lst>\n        </searchComponent>\n... ",
            "author": "Matthew Caruana Galizia",
            "id": "comment-16100628"
        },
        {
            "date": "2017-07-25T20:12:35+0000",
            "content": "Made some schema changes and now I get the following logged, instead of the previous message:\n\nAn exception was thrown while processing field text_sensitive\n\nThe definition of text_sensitive in the managed schema:\n\n<field name=\"text_sensitive\" type=\"text_general_sensitive\" termVectors=\"true\" storeOffsetsWithPositions=\"true\" indexed=\"true\" stored=\"false\"/>\n\nThe definition of the type, also in the managed schema:\n\n  <fieldType name=\"text_general_sensitive\" class=\"solr.TextField\">\n    <analyzer type=\"index\">\n      <tokenizer class=\"solr.UAX29URLEmailTokenizerFactory\"/>\n      <filter class=\"solr.ICUNormalizer2FilterFactory\" mode=\"compose\" name=\"nfc\"/>\n      <filter class=\"solr.StopFilterFactory\" words=\"stopwords.txt\" ignoreCase=\"true\"/>\n      <filter class=\"solr.ReversedWildcardFilterFactory\" maxPosQuestion=\"1\" maxFractionAsterisk=\"0.33\" maxPosAsterisk=\"2\" withOriginal=\"true\" minTrailing=\"2\"/>\n    </analyzer>\n    <analyzer type=\"query\">\n      <tokenizer class=\"solr.UAX29URLEmailTokenizerFactory\"/>\n      <filter class=\"solr.ICUNormalizer2FilterFactory\" mode=\"compose\" name=\"nfc\"/>\n      <filter class=\"solr.StopFilterFactory\" words=\"stopwords.txt\" ignoreCase=\"true\"/>\n    </analyzer>\n  </fieldType> ",
            "author": "Matthew Caruana Galizia",
            "id": "comment-16100689"
        }
    ]
}