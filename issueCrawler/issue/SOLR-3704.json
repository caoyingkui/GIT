{
    "id": "SOLR-3704",
    "title": "Date range queries fail when highlighting",
    "details": {
        "affect_versions": "3.6",
        "status": "Open",
        "fix_versions": [],
        "components": [
            "highlighter"
        ],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Unresolved"
    },
    "description": "For the following valid date range query, an invalid date format exception is thrown only when highlighting is enabled:\n\n\nq= (Creation_Date:[2002-08-01T00:00:01.999Z TO 2012-08-13T23:59:59.999Z])&hl=true&rows=10&start=0&hl.fl=Creation_Date&hl.requireFieldMatch=true&hl.snippets=1\n\n\nResponse is: Invalid Date String:'1296176143000'",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "author": "Tommaso Teofili",
            "id": "comment-13428123",
            "date": "2012-08-03T14:33:23+0000",
            "content": "Hi Konstantin,\n\ncan you please check if this also applies to Solr 4?\nI can't reproduce it with the following test (I use the 'timestamp' field of type tdate, which fieldType is your Creation_date set to?):\n\npublic class RangeQueryHighlightingTest extends SolrTestCaseJ4 {\n\n  @BeforeClass\n  public static void beforeClass() throws Exception {\n    initCore(\"solrconfig.xml\", \"schema.xml\");\n  }\n\n  @Test\n  public void testFailingRangeQueryWithHighlighting() throws Exception {\n    assertU(adoc(\"tv_text\", \"basic fast vector highlighter test\",\n        \"id\", \"1\"));\n    assertU(commit());\n    assertU(optimize());\n\n    String q = \"(timestamp:[2002-08-01T00:00:01.999Z TO 2013-08-13T23:59:59.999Z])\";\n    String hl = \"true\";\n    String rows = \"10\";\n    String start = \"0\";\n    String hlFl = \"timestamp\";\n    String hlRequireFieldMatch = \"true\";\n    String hlSnippets = \"1\";\n\n    assertQ(lrf.makeRequest(\"q\", q, \"hl\", hl, \"rows\", rows, \"start\", start, \"hl.fl\", hlFl, \"hl.requireFieldMatch\", hlRequireFieldMatch, \"hl.snippets\", hlSnippets));\n  }\n\n}\n\n "
        },
        {
            "author": "Konstantin Pentchev",
            "id": "comment-13428132",
            "date": "2012-08-03T14:47:06+0000",
            "content": "Hi Tommaso,\n\nmy field definition is:\n\n    \n<fieldType name=\"date\" class=\"solr.TrieDateField\" omitNorms=\"true\" precisionStep=\"0\" positionIncrementGap=\"0\"/>\n<field name=\"Creation_Date\" type=\"date\" multiValued=\"false\" stored=\"true\" indexed=\"true\" termVectors=\"false\" termPositions=\"false\" termOffsets=\"false\"/>\n\n\nI will try to reproduce it with 4.0 on Monday.  "
        },
        {
            "author": "Robert Muir",
            "id": "comment-13428137",
            "date": "2012-08-03T14:50:45+0000",
            "content": "\ntermVectors=\"false\"\n\nAs far as I know, fastvectorhighlighter requires term vectors. "
        },
        {
            "author": "Tommaso Teofili",
            "id": "comment-13428143",
            "date": "2012-08-03T14:55:50+0000",
            "content": "As far as I know, fastvectorhighlighter requires term vectors.\n\nyep, that's right. "
        },
        {
            "author": "Konstantin Pentchev",
            "id": "comment-13428170",
            "date": "2012-08-03T15:11:46+0000",
            "content": "yes, so the default highlighter is used and the error persists. "
        },
        {
            "author": "Mariusz",
            "id": "comment-16705773",
            "date": "2018-12-01T10:45:17+0000",
            "content": "I know it's very old issue, but still OPEN, and I can confirm it happens also in SOLR 7.5.0.\n\n\u00a0\n\nQuery, that uses highlighting, and date, and is returned as javabin, fails with error:\n\n2018-12-01 10:31:01.546 ERROR (qtp349420578-20) [ x:eaie_collection] o.a.s.h.RequestHandlerBase org.apache.solr.common.SolrException: Invalid Date String:'1513094629000'\nat org.apache.solr.util.DateMathParser.parseMath(DateMathParser.java:247)\nat org.apache.solr.util.DateMathParser.parseMath(DateMathParser.java:226)\nat org.apache.solr.schema.DatePointField.toNativeType(DatePointField.java:113)\nat org.apache.solr.schema.DatePointField.readableToIndexed(DatePointField.java:184)\nat org.apache.solr.schema.PointField.toInternalByteRef(PointField.java:193)\nat org.apache.solr.schema.FieldType$DefaultAnalyzer$1.incrementToken(FieldType.java:492)\nat org.apache.solr.highlight.TokenOrderingFilter.incrementToken(DefaultSolrHighlighter.java:809)\nat org.apache.lucene.search.highlight.OffsetLimitTokenFilter.incrementToken(OffsetLimitTokenFilter.java:42)\nat org.apache.lucene.analysis.CachingTokenFilter.fillCache(CachingTokenFilter.java:91)\nat org.apache.lucene.analysis.CachingTokenFilter.incrementToken(CachingTokenFilter.java:70)\nat org.apache.lucene.index.memory.MemoryIndex.storeTerms(MemoryIndex.java:583)\nat org.apache.lucene.index.memory.MemoryIndex.addField(MemoryIndex.java:474)\nat org.apache.lucene.index.memory.MemoryIndex.addField(MemoryIndex.java:452)\nat org.apache.lucene.index.memory.MemoryIndex.addField(MemoryIndex.java:431)\nat org.apache.lucene.search.highlight.WeightedSpanTermExtractor.getLeafContext(WeightedSpanTermExtractor.java:405)\nat org.apache.lucene.search.highlight.WeightedSpanTermExtractor.extractWeightedTerms(WeightedSpanTermExtractor.java:364)\nat org.apache.lucene.search.highlight.WeightedSpanTermExtractor.extract(WeightedSpanTermExtractor.java:141)\nat org.apache.lucene.search.highlight.WeightedSpanTermExtractor.extract(WeightedSpanTermExtractor.java:155)\nat org.apache.lucene.search.highlight.WeightedSpanTermExtractor.extract(WeightedSpanTermExtractor.java:112)\nat org.apache.lucene.search.highlight.WeightedSpanTermExtractor.getWeightedSpanTerms(WeightedSpanTermExtractor.java:513)\nat org.apache.lucene.search.highlight.QueryScorer.initExtractor(QueryScorer.java:218)\nat org.apache.lucene.search.highlight.QueryScorer.init(QueryScorer.java:186)\nat org.apache.lucene.search.highlight.Highlighter.getBestTextFragments(Highlighter.java:201)\nat org.apache.solr.highlight.DefaultSolrHighlighter.doHighlightingByHighlighter(DefaultSolrHighlighter.java:631)\nat org.apache.solr.highlight.DefaultSolrHighlighter.doHighlightingOfField(DefaultSolrHighlighter.java:480)\nat org.apache.solr.highlight.DefaultSolrHighlighter.doHighlighting(DefaultSolrHighlighter.java:442)\nat org.apache.solr.handler.component.HighlightComponent.process(HighlightComponent.java:183)\nat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:298)\nat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:199)\nat org.apache.solr.core.SolrCore.execute(SolrCore.java:2541)\nat org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:709)\nat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:515)\nat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:377)\nat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:323)\nat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1634)\nat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:533)\nat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)\nat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\nat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)\nat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1595)\nat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:255)\nat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1317)\nat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)\nat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:473)\nat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1564)\nat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)\nat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1219)\nat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)\nat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:219)\nat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\nat org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:335)\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\nat org.eclipse.jetty.server.Server.handle(Server.java:531)\nat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:352)\nat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)\nat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:281)\nat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:102)\nat org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)\nat org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)\nat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:762)\nat org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:680)\nat java.lang.Thread.run(Thread.java:748)\n\n2018-12-01 10:31:01.546 INFO (qtp349420578-20) [ x:eaie_collection] o.a.s.c.S.Request [eaie_collection] webapp=/solr path=/select params={hl=true&bf=exists(query({!v%3D'id:fe5f3306-a03a-495b-b3b2-a0419da9c518'}))^0.99+exists(query({!v%3D'id:010f9b89-4808-435b-a065-82d3f28092be'}))^0.98+exists(query({!v%3D'id:4ce655a7-8189-4ebc-9173-ecc180844a8e'}))^0.97&fl=_text_,_version_,blogAuthors,blogAuthorsNames,blogCategories,blogCreated,blogImageLabelColor,blogImageLabelText,blogIntroText,blogLeadImage,blogLeadImageAltText,blogTeaserText,blogText,blogTitle,id,jcrname,nodetype,path,type,uuid,workspace&start=0&fq=type:indexerBlog&sort=score+desc,blogCreated+desc&rows=10&version=2&hl.simple.pre=<em+class%3D\"highlight\">&hl.snippets=3&q=blog&defType=edismax&hl.simple.post=</em>&hl.fl=_text_&hl.fl=_version_&hl.fl=blogAuthors&hl.fl=blogAuthorsNames&hl.fl=blogCategories&hl.fl=blogCreated&hl.fl=blogImageLabelColor&hl.fl=blogImageLabelText&hl.fl=blogIntroText&hl.fl=blogLeadImage&hl.fl=blogLeadImageAltText&hl.fl=blogTeaserText&hl.fl=blogText&hl.fl=blogTitle&hl.fl=id&hl.fl=jcrname&hl.fl=nodetype&hl.fl=path&hl.fl=type&hl.fl=uuid&hl.fl=workspace&facet.mincount=1&wt=javabin} hits=1 status=400 QTime=7\n\n\n\n\u00a0\n\nWhen javabin parameter is removed, it works. When all hl.fl params are removed - it works as well. When date Field is removed from SOLR, it also works. Only those 3 things together cause failure. "
        }
    ]
}