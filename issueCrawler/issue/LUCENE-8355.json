{
    "id": "LUCENE-8355",
    "title": "IW#writeSomeDocValuesUpdates might open a dropped segment",
    "details": {
        "components": [
            "core/index"
        ],
        "status": "Resolved",
        "resolution": "Fixed",
        "fix_versions": [],
        "affect_versions": "7.4,                                            7.5,                                            master (8.0)",
        "labels": "",
        "priority": "Major",
        "type": "Bug"
    },
    "description": "[junit4] Suite: org.apache.lucene.index.TestIndexWriterWithThreads\n   [junit4]   2> Jun 12, 2018 9:09:00 AM com.carrotsearch.randomizedtesting.RandomizedRunner$QueueUncaughtExceptionsHandler uncaughtException\n   [junit4]   2> WARNING: Uncaught exception in thread: Thread[Thread-927,5,TGRP-TestIndexWriterWithThreads]\n   [junit4]   2> java.lang.AssertionError: org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed\n   [junit4]   2> \tat __randomizedtesting.SeedInfo.seed([F89419D754B7F340]:0)\n   [junit4]   2> \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:682)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:748)\n   [junit4]   2> Caused by: org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:663)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.getConfig(IndexWriter.java:982)\n   [junit4]   2> \tat org.apache.lucene.index.RandomIndexWriter.maybeFlushOrCommit(RandomIndexWriter.java:198)\n   [junit4]   2> \tat org.apache.lucene.index.RandomIndexWriter.updateDocument(RandomIndexWriter.java:273)\n   [junit4]   2> \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:679)\n   [junit4]   2> \t... 1 more\n   [junit4]   2> Caused by: java.io.FileNotFoundException: _a_1.fnm in dir=RAMDirectory@641490af lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@7685b98b\n   [junit4]   2> \tat org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:750)\n   [junit4]   2> \tat org.apache.lucene.store.Directory.openChecksumInput(Directory.java:121)\n   [junit4]   2> \tat org.apache.lucene.store.MockDirectoryWrapper.openChecksumInput(MockDirectoryWrapper.java:1072)\n   [junit4]   2> \tat org.apache.lucene.codecs.lucene60.Lucene60FieldInfosFormat.read(Lucene60FieldInfosFormat.java:113)\n   [junit4]   2> \tat org.apache.lucene.index.SegmentReader.initFieldInfos(SegmentReader.java:195)\n   [junit4]   2> \tat org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:97)\n   [junit4]   2> \tat org.apache.lucene.index.ReadersAndUpdates.writeFieldUpdates(ReadersAndUpdates.java:536)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.writeSomeDocValuesUpdates(IndexWriter.java:610)\n   [junit4]   2> \tat org.apache.lucene.index.FrozenBufferedUpdates.apply(FrozenBufferedUpdates.java:299)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.lambda$publishFrozenUpdates$3(IndexWriter.java:2586)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.processEvents(IndexWriter.java:5056)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1596)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.softUpdateDocument(IndexWriter.java:1653)\n   [junit4]   2> \tat org.apache.lucene.index.RandomIndexWriter.updateDocument(RandomIndexWriter.java:264)\n   [junit4]   2> \t... 2 more\n   [junit4]   2> \n   [junit4]   2> Jun 12, 2018 9:09:00 AM com.carrotsearch.randomizedtesting.RandomizedRunner$QueueUncaughtExceptionsHandler uncaughtException\n   [junit4]   2> WARNING: Uncaught exception in thread: Thread[Thread-928,5,TGRP-TestIndexWriterWithThreads]\n   [junit4]   2> java.lang.AssertionError: java.io.FileNotFoundException: _a_1.fnm in dir=RAMDirectory@641490af lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@7685b98b\n   [junit4]   2> \tat __randomizedtesting.SeedInfo.seed([F89419D754B7F340]:0)\n   [junit4]   2> \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:682)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:748)\n   [junit4]   2> Caused by: java.io.FileNotFoundException: _a_1.fnm in dir=RAMDirectory@641490af lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@7685b98b\n   [junit4]   2> \tat org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:750)\n   [junit4]   2> \tat org.apache.lucene.store.Directory.openChecksumInput(Directory.java:121)\n   [junit4]   2> \tat org.apache.lucene.store.MockDirectoryWrapper.openChecksumInput(MockDirectoryWrapper.java:1072)\n   [junit4]   2> \tat org.apache.lucene.codecs.lucene60.Lucene60FieldInfosFormat.read(Lucene60FieldInfosFormat.java:113)\n   [junit4]   2> \tat org.apache.lucene.index.SegmentReader.initFieldInfos(SegmentReader.java:195)\n   [junit4]   2> \tat org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:97)\n   [junit4]   2> \tat org.apache.lucene.index.ReadersAndUpdates.writeFieldUpdates(ReadersAndUpdates.java:536)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.writeSomeDocValuesUpdates(IndexWriter.java:610)\n   [junit4]   2> \tat org.apache.lucene.index.FrozenBufferedUpdates.apply(FrozenBufferedUpdates.java:299)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.lambda$publishFrozenUpdates$3(IndexWriter.java:2586)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.processEvents(IndexWriter.java:5056)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1596)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.softUpdateDocument(IndexWriter.java:1653)\n   [junit4]   2> \tat org.apache.lucene.index.RandomIndexWriter.updateDocument(RandomIndexWriter.java:264)\n   [junit4]   2> \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:679)\n   [junit4]   2> \t... 1 more\n   [junit4]   2> \n   [junit4]   2> Jun 12, 2018 9:09:00 AM com.carrotsearch.randomizedtesting.RandomizedRunner$QueueUncaughtExceptionsHandler uncaughtException\n   [junit4]   2> WARNING: Uncaught exception in thread: Thread[Thread-929,5,TGRP-TestIndexWriterWithThreads]\n   [junit4]   2> java.lang.AssertionError: org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed\n   [junit4]   2> \tat __randomizedtesting.SeedInfo.seed([F89419D754B7F340]:0)\n   [junit4]   2> \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:682)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:748)\n   [junit4]   2> Caused by: org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:663)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:677)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.updateDocuments(IndexWriter.java:1280)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.softUpdateDocuments(IndexWriter.java:1343)\n   [junit4]   2> \tat org.apache.lucene.index.RandomIndexWriter.updateDocument(RandomIndexWriter.java:262)\n   [junit4]   2> \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:679)\n   [junit4]   2> \t... 1 more\n   [junit4]   2> Caused by: java.io.FileNotFoundException: _a_1.fnm in dir=RAMDirectory@641490af lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@7685b98b\n   [junit4]   2> \tat org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:750)\n   [junit4]   2> \tat org.apache.lucene.store.Directory.openChecksumInput(Directory.java:121)\n   [junit4]   2> \tat org.apache.lucene.store.MockDirectoryWrapper.openChecksumInput(MockDirectoryWrapper.java:1072)\n   [junit4]   2> \tat org.apache.lucene.codecs.lucene60.Lucene60FieldInfosFormat.read(Lucene60FieldInfosFormat.java:113)\n   [junit4]   2> \tat org.apache.lucene.index.SegmentReader.initFieldInfos(SegmentReader.java:195)\n   [junit4]   2> \tat org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:97)\n   [junit4]   2> \tat org.apache.lucene.index.ReadersAndUpdates.writeFieldUpdates(ReadersAndUpdates.java:536)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.writeSomeDocValuesUpdates(IndexWriter.java:610)\n   [junit4]   2> \tat org.apache.lucene.index.FrozenBufferedUpdates.apply(FrozenBufferedUpdates.java:299)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.lambda$publishFrozenUpdates$3(IndexWriter.java:2586)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.processEvents(IndexWriter.java:5056)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1596)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.softUpdateDocument(IndexWriter.java:1653)\n   [junit4]   2> \tat org.apache.lucene.index.RandomIndexWriter.updateDocument(RandomIndexWriter.java:264)\n   [junit4]   2> \t... 2 more\n   [junit4]   2> \n   [junit4]   2> Jun 12, 2018 9:09:00 AM com.carrotsearch.randomizedtesting.RandomizedRunner$QueueUncaughtExceptionsHandler uncaughtException\n   [junit4]   2> WARNING: Uncaught exception in thread: Thread[Thread-930,5,TGRP-TestIndexWriterWithThreads]\n   [junit4]   2> java.lang.AssertionError: org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed\n   [junit4]   2> \tat __randomizedtesting.SeedInfo.seed([F89419D754B7F340]:0)\n   [junit4]   2> \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:682)\n   [junit4]   2> \tat java.lang.Thread.run(Thread.java:748)\n   [junit4]   2> Caused by: org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:663)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:677)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1590)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.softUpdateDocument(IndexWriter.java:1653)\n   [junit4]   2> \tat org.apache.lucene.index.RandomIndexWriter.updateDocument(RandomIndexWriter.java:264)\n   [junit4]   2> \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:679)\n   [junit4]   2> \t... 1 more\n   [junit4]   2> Caused by: java.io.FileNotFoundException: _a_1.fnm in dir=RAMDirectory@641490af lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@7685b98b\n   [junit4]   2> \tat org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:750)\n   [junit4]   2> \tat org.apache.lucene.store.Directory.openChecksumInput(Directory.java:121)\n   [junit4]   2> \tat org.apache.lucene.store.MockDirectoryWrapper.openChecksumInput(MockDirectoryWrapper.java:1072)\n   [junit4]   2> \tat org.apache.lucene.codecs.lucene60.Lucene60FieldInfosFormat.read(Lucene60FieldInfosFormat.java:113)\n   [junit4]   2> \tat org.apache.lucene.index.SegmentReader.initFieldInfos(SegmentReader.java:195)\n   [junit4]   2> \tat org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:97)\n   [junit4]   2> \tat org.apache.lucene.index.ReadersAndUpdates.writeFieldUpdates(ReadersAndUpdates.java:536)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.writeSomeDocValuesUpdates(IndexWriter.java:610)\n   [junit4]   2> \tat org.apache.lucene.index.FrozenBufferedUpdates.apply(FrozenBufferedUpdates.java:299)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.lambda$publishFrozenUpdates$3(IndexWriter.java:2586)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.processEvents(IndexWriter.java:5056)\n   [junit4]   2> \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1596)\n   [junit4]   2> \t... 4 more\n   [junit4]   2> \n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestIndexWriterWithThreads -Dtests.method=testUpdateSingleDocWithThreads -Dtests.seed=F89419D754B7F340 -Dtests.slow=true -Dtests.badapples=true -Dtests.locale=en-PH -Dtests.timezone=Europe/Samara -Dtests.asserts=true -Dtests.file.encoding=UTF-8\n   [junit4] ERROR   0.09s J3 | TestIndexWriterWithThreads.testUpdateSingleDocWithThreads <<<\n   [junit4]    > Throwable #1: org.apache.lucene.store.AlreadyClosedException: refusing to delete any files: this IndexWriter hit an unrecoverable exception\n   [junit4]    > \tat org.apache.lucene.index.IndexFileDeleter.ensureOpen(IndexFileDeleter.java:349)\n   [junit4]    > \tat org.apache.lucene.index.IndexFileDeleter.deleteFiles(IndexFileDeleter.java:669)\n   [junit4]    > \tat org.apache.lucene.index.IndexFileDeleter.decRef(IndexFileDeleter.java:589)\n   [junit4]    > \tat org.apache.lucene.index.FrozenBufferedUpdates.finishApply(FrozenBufferedUpdates.java:422)\n   [junit4]    > \tat org.apache.lucene.index.FrozenBufferedUpdates.lambda$apply$0(FrozenBufferedUpdates.java:292)\n   [junit4]    > \tat org.apache.lucene.index.FrozenBufferedUpdates.apply(FrozenBufferedUpdates.java:296)\n   [junit4]    > \tat org.apache.lucene.index.BufferedUpdatesStream.waitApply(BufferedUpdatesStream.java:230)\n   [junit4]    > \tat org.apache.lucene.index.BufferedUpdatesStream.waitApplyAll(BufferedUpdatesStream.java:143)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.applyAllDeletesAndUpdates(IndexWriter.java:3637)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.getReader(IndexWriter.java:508)\n   [junit4]    > \tat org.apache.lucene.index.StandardDirectoryReader.doOpenFromWriter(StandardDirectoryReader.java:288)\n   [junit4]    > \tat org.apache.lucene.index.StandardDirectoryReader.doOpenIfChanged(StandardDirectoryReader.java:263)\n   [junit4]    > \tat org.apache.lucene.index.StandardDirectoryReader.doOpenIfChanged(StandardDirectoryReader.java:253)\n   [junit4]    > \tat org.apache.lucene.index.DirectoryReader.openIfChanged(DirectoryReader.java:140)\n   [junit4]    > \tat org.apache.lucene.index.TestIndexWriterWithThreads.testUpdateSingleDocWithThreads(TestIndexWriterWithThreads.java:694)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:748)\n   [junit4]    > Caused by: java.io.FileNotFoundException: _a_1.fnm in dir=RAMDirectory@641490af lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@7685b98b\n   [junit4]    > \tat org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:750)\n   [junit4]    > \tat org.apache.lucene.store.Directory.openChecksumInput(Directory.java:121)\n   [junit4]    > \tat org.apache.lucene.store.MockDirectoryWrapper.openChecksumInput(MockDirectoryWrapper.java:1072)\n   [junit4]    > \tat org.apache.lucene.codecs.lucene60.Lucene60FieldInfosFormat.read(Lucene60FieldInfosFormat.java:113)\n   [junit4]    > \tat org.apache.lucene.index.SegmentReader.initFieldInfos(SegmentReader.java:195)\n   [junit4]    > \tat org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:97)\n   [junit4]    > \tat org.apache.lucene.index.ReadersAndUpdates.writeFieldUpdates(ReadersAndUpdates.java:536)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.writeSomeDocValuesUpdates(IndexWriter.java:610)\n   [junit4]    > \tat org.apache.lucene.index.FrozenBufferedUpdates.apply(FrozenBufferedUpdates.java:299)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.lambda$publishFrozenUpdates$3(IndexWriter.java:2586)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.processEvents(IndexWriter.java:5056)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1596)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.softUpdateDocument(IndexWriter.java:1653)\n   [junit4]    > \tat org.apache.lucene.index.RandomIndexWriter.updateDocument(RandomIndexWriter.java:264)\n   [junit4]    > \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:679)\n   [junit4]    > \t... 1 moreThrowable #2: com.carrotsearch.randomizedtesting.UncaughtExceptionError: Captured an uncaught exception in thread: Thread[id=1082, name=Thread-928, state=RUNNABLE, group=TGRP-TestIndexWriterWithThreads]\n   [junit4]    > Caused by: java.lang.AssertionError: java.io.FileNotFoundException: _a_1.fnm in dir=RAMDirectory@641490af lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@7685b98b\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([F89419D754B7F340]:0)\n   [junit4]    > \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:682)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:748)\n   [junit4]    > Caused by: java.io.FileNotFoundException: _a_1.fnm in dir=RAMDirectory@641490af lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@7685b98b\n   [junit4]    > \tat org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:750)\n   [junit4]    > \tat org.apache.lucene.store.Directory.openChecksumInput(Directory.java:121)\n   [junit4]    > \tat org.apache.lucene.store.MockDirectoryWrapper.openChecksumInput(MockDirectoryWrapper.java:1072)\n   [junit4]    > \tat org.apache.lucene.codecs.lucene60.Lucene60FieldInfosFormat.read(Lucene60FieldInfosFormat.java:113)\n   [junit4]    > \tat org.apache.lucene.index.SegmentReader.initFieldInfos(SegmentReader.java:195)\n   [junit4]    > \tat org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:97)\n   [junit4]    > \tat org.apache.lucene.index.ReadersAndUpdates.writeFieldUpdates(ReadersAndUpdates.java:536)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.writeSomeDocValuesUpdates(IndexWriter.java:610)\n   [junit4]    > \tat org.apache.lucene.index.FrozenBufferedUpdates.apply(FrozenBufferedUpdates.java:299)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.lambda$publishFrozenUpdates$3(IndexWriter.java:2586)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.processEvents(IndexWriter.java:5056)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1596)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.softUpdateDocument(IndexWriter.java:1653)\n   [junit4]    > \tat org.apache.lucene.index.RandomIndexWriter.updateDocument(RandomIndexWriter.java:264)\n   [junit4]    > \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:679)\n   [junit4]    > \t... 1 moreThrowable #3: com.carrotsearch.randomizedtesting.UncaughtExceptionError: Captured an uncaught exception in thread: Thread[id=1081, name=Thread-927, state=RUNNABLE, group=TGRP-TestIndexWriterWithThreads]\n   [junit4]    > Caused by: java.lang.AssertionError: org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([F89419D754B7F340]:0)\n   [junit4]    > \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:682)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:748)\n   [junit4]    > Caused by: org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:663)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.getConfig(IndexWriter.java:982)\n   [junit4]    > \tat org.apache.lucene.index.RandomIndexWriter.maybeFlushOrCommit(RandomIndexWriter.java:198)\n   [junit4]    > \tat org.apache.lucene.index.RandomIndexWriter.updateDocument(RandomIndexWriter.java:273)\n   [junit4]    > \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:679)\n   [junit4]    > \t... 1 more\n   [junit4]    > Caused by: java.io.FileNotFoundException: _a_1.fnm in dir=RAMDirectory@641490af lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@7685b98b\n   [junit4]    > \tat org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:750)\n   [junit4]    > \tat org.apache.lucene.store.Directory.openChecksumInput(Directory.java:121)\n   [junit4]    > \tat org.apache.lucene.store.MockDirectoryWrapper.openChecksumInput(MockDirectoryWrapper.java:1072)\n   [junit4]    > \tat org.apache.lucene.codecs.lucene60.Lucene60FieldInfosFormat.read(Lucene60FieldInfosFormat.java:113)\n   [junit4]    > \tat org.apache.lucene.index.SegmentReader.initFieldInfos(SegmentReader.java:195)\n   [junit4]    > \tat org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:97)\n   [junit4]    > \tat org.apache.lucene.index.ReadersAndUpdates.writeFieldUpdates(ReadersAndUpdates.java:536)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.writeSomeDocValuesUpdates(IndexWriter.java:610)\n   [junit4]    > \tat org.apache.lucene.index.FrozenBufferedUpdates.apply(FrozenBufferedUpdates.java:299)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.lambda$publishFrozenUpdates$3(IndexWriter.java:2586)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.processEvents(IndexWriter.java:5056)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1596)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.softUpdateDocument(IndexWriter.java:1653)\n   [junit4]    > \tat org.apache.lucene.index.RandomIndexWriter.updateDocument(RandomIndexWriter.java:264)\n   [junit4]    > \t... 2 moreThrowable #4: com.carrotsearch.randomizedtesting.UncaughtExceptionError: Captured an uncaught exception in thread: Thread[id=1084, name=Thread-930, state=RUNNABLE, group=TGRP-TestIndexWriterWithThreads]\n   [junit4]    > Caused by: java.lang.AssertionError: org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([F89419D754B7F340]:0)\n   [junit4]    > \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:682)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:748)\n   [junit4]    > Caused by: org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:663)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:677)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1590)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.softUpdateDocument(IndexWriter.java:1653)\n   [junit4]    > \tat org.apache.lucene.index.RandomIndexWriter.updateDocument(RandomIndexWriter.java:264)\n   [junit4]    > \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:679)\n   [junit4]    > \t... 1 more\n   [junit4]    > Caused by: java.io.FileNotFoundException: _a_1.fnm in dir=RAMDirectory@641490af lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@7685b98b\n   [junit4]    > \tat org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:750)\n   [junit4]    > \tat org.apache.lucene.store.Directory.openChecksumInput(Directory.java:121)\n   [junit4]    > \tat org.apache.lucene.store.MockDirectoryWrapper.openChecksumInput(MockDirectoryWrapper.java:1072)\n   [junit4]    > \tat org.apache.lucene.codecs.lucene60.Lucene60FieldInfosFormat.read(Lucene60FieldInfosFormat.java:113)\n   [junit4]    > \tat org.apache.lucene.index.SegmentReader.initFieldInfos(SegmentReader.java:195)\n   [junit4]    > \tat org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:97)\n   [junit4]    > \tat org.apache.lucene.index.ReadersAndUpdates.writeFieldUpdates(ReadersAndUpdates.java:536)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.writeSomeDocValuesUpdates(IndexWriter.java:610)\n   [junit4]    > \tat org.apache.lucene.index.FrozenBufferedUpdates.apply(FrozenBufferedUpdates.java:299)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.lambda$publishFrozenUpdates$3(IndexWriter.java:2586)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.processEvents(IndexWriter.java:5056)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1596)\n   [junit4]    > \t... 4 moreThrowable #5: com.carrotsearch.randomizedtesting.UncaughtExceptionError: Captured an uncaught exception in thread: Thread[id=1083, name=Thread-929, state=RUNNABLE, group=TGRP-TestIndexWriterWithThreads]\n   [junit4]    > Caused by: java.lang.AssertionError: org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([F89419D754B7F340]:0)\n   [junit4]    > \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:682)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:748)\n   [junit4]    > Caused by: org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:663)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:677)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.updateDocuments(IndexWriter.java:1280)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.softUpdateDocuments(IndexWriter.java:1343)\n   [junit4]    > \tat org.apache.lucene.index.RandomIndexWriter.updateDocument(RandomIndexWriter.java:262)\n   [junit4]    > \tat org.apache.lucene.index.TestIndexWriterWithThreads.lambda$testUpdateSingleDocWithThreads$2(TestIndexWriterWithThreads.java:679)\n   [junit4]    > \t... 1 more\n   [junit4]    > Caused by: java.io.FileNotFoundException: _a_1.fnm in dir=RAMDirectory@641490af lockFactory=org.apache.lucene.store.SingleInstanceLockFactory@7685b98b\n   [junit4]    > \tat org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:750)\n   [junit4]    > \tat org.apache.lucene.store.Directory.openChecksumInput(Directory.java:121)\n   [junit4]    > \tat org.apache.lucene.store.MockDirectoryWrapper.openChecksumInput(MockDirectoryWrapper.java:1072)\n   [junit4]    > \tat org.apache.lucene.codecs.lucene60.Lucene60FieldInfosFormat.read(Lucene60FieldInfosFormat.java:113)\n   [junit4]    > \tat org.apache.lucene.index.SegmentReader.initFieldInfos(SegmentReader.java:195)\n   [junit4]    > \tat org.apache.lucene.index.SegmentReader.<init>(SegmentReader.java:97)\n   [junit4]    > \tat org.apache.lucene.index.ReadersAndUpdates.writeFieldUpdates(ReadersAndUpdates.java:536)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.writeSomeDocValuesUpdates(IndexWriter.java:610)\n   [junit4]    > \tat org.apache.lucene.index.FrozenBufferedUpdates.apply(FrozenBufferedUpdates.java:299)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.lambda$publishFrozenUpdates$3(IndexWriter.java:2586)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.processEvents(IndexWriter.java:5056)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1596)\n   [junit4]    > \tat org.apache.lucene.index.IndexWriter.softUpdateDocument(IndexWriter.java:1653)\n   [junit4]    > \tat org.apache.lucene.index.RandomIndexWriter.updateDocument(RandomIndexWriter.java:264)\n   [junit4]    > \t... 2 more\n   [junit4]   2> NOTE: test params are: codec=Lucene70, sim=Asserting(org.apache.lucene.search.similarities.AssertingSimilarity@46139ed0), locale=en-PH, timezone=Europe/Samara\n   [junit4]   2> NOTE: Linux 4.4.0-1060-aws amd64/Oracle Corporation 1.8.0_171 (64-bit)/cpus=16,threads=1,free=41285248,total=336592896\n   [junit4]   2> NOTE: All tests run in this JVM: [TestSimpleExplanations, TestBasics, TestBytesRefAttImpl, TestFieldReuse, TestSameScoresWithThreads, TestEarlyTermination, TestAddIndexes, TestSpanOrQuery, TestRegexpQuery, TestMinimize, TestFlex, TestRollback, TestBooleanRewrites, TestVersion, TestScorerPerf, TestMultiMMap, TestWANDScorer, TestIndexingSequenceNumbers, TestAtomicUpdate, TestSmallFloat, TestIndexWriterCommit, TestTryDelete, TestIndexWriterMaxDocs, TestLMDirichletSimilarity, TestCharsRefBuilder, TestReqExclBulkScorer, TestIndexedDISI, TestNeedsScores, TestParallelTermEnum, TestDistributionSPL, TestIndexManyDocuments, TestToken, TestSimilarityProvider, TestSoftDeletesRetentionMergePolicy, TestMatchAllDocsQuery, TestSpans, TestCustomSearcherSort, TestMaxPosition, TestDuelingCodecsAtNight, TestReaderPool, Test2BSortedDocValuesOrds, TestSpanMultiTermQueryWrapper, TestIndexTooManyDocs, TestPolygon, TestByteSlices, TestHighCompressionMode, LimitedFiniteStringsIteratorTest, TestNativeFSLockFactory, TestDelegatingAnalyzerWrapper, TestSimilarity2, TestRamUsageEstimator, TestForUtil, TestDocumentsWriterStallControl, TestSingleInstanceLockFactory, TestForTooMuchCloning, TestSpanExplanations, TestIndexWriterMerging, TestPhrasePrefixQuery, TestNRTReaderCleanup, TestDocValuesQueries, Test2BPostings, TestFieldCacheRewriteMethod, TestFSTs, TestIndexWriterWithThreads]\n   [junit4] Completed [219/496 (1!)] on J3 in 2.00s, 13 tests, 1 error <<< FAILURES!",
    "attachments": {
        "LUCENE-8355.patch": "https://issues.apache.org/jira/secure/attachment/12927571/LUCENE-8355.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "id": "comment-16510516",
            "author": "Nhat Nguyen",
            "content": "This test fails because IW#writeSomeDocValuesUpdates tries to open a dropped segment. We obtain a queue of readers from readerPool#getReadersByRam, then process each of them under IW lock. However, one of the segments of those readers is dropped before we execute #writeFieldUpdates. This situation is possible because we only acquire IW lock on each writeFieldUpdates not entirely the method. ",
            "date": "2018-06-13T02:03:39+0000"
        },
        {
            "id": "comment-16510519",
            "author": "Nhat Nguyen",
            "content": "/cc Simon Willnauer ",
            "date": "2018-06-13T02:04:33+0000"
        },
        {
            "id": "comment-16510725",
            "author": "Simon Willnauer",
            "content": "wow this bug must have been in there for quite some time. I am impressed how you figured this out from the stacktrace of this failure. I will commit this in a bit. Awesome catch Nhat Nguyen ",
            "date": "2018-06-13T07:34:23+0000"
        },
        {
            "id": "comment-16510760",
            "author": "ASF subversion and git services",
            "content": "Commit 1e77f4d42ea7214931f38c9bebe4bfd2b27b7faa in lucene-solr's branch refs/heads/branch_7_4 from Simon Willnauer\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=1e77f4d ]\n\nLUCENE-8355: Prevent IW from opening an already dropped segment while DV updates are written\n\nThis change fixes an isse where IW asks ReadersAndUpdates to write a DV updates for a\nsegment that has been dropped concurrently. The race only occurs if ram buffers are filled\nup enough to trigger flushing DV to disk.\n\nCo-authored-by: Nhat Nguyen <nhat.nguyen@elastic.co> ",
            "date": "2018-06-13T08:10:24+0000"
        },
        {
            "id": "comment-16510761",
            "author": "ASF subversion and git services",
            "content": "Commit 96833128923b2bcded7e82e9ad9bc0b5c202c8c9 in lucene-solr's branch refs/heads/branch_7x from Simon Willnauer\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=9683312 ]\n\nLUCENE-8355: Prevent IW from opening an already dropped segment while DV updates are written\n\nThis change fixes an isse where IW asks ReadersAndUpdates to write a DV updates for a\nsegment that has been dropped concurrently. The race only occurs if ram buffers are filled\nup enough to trigger flushing DV to disk.\n\nCo-authored-by: Nhat Nguyen <nhat.nguyen@elastic.co> ",
            "date": "2018-06-13T08:10:26+0000"
        },
        {
            "id": "comment-16510762",
            "author": "ASF subversion and git services",
            "content": "Commit 61e68ec1e8cd409cb51a209f827fc64710b31f6f in lucene-solr's branch refs/heads/master from Simon Willnauer\n[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=61e68ec ]\n\nLUCENE-8355: Prevent IW from opening an already dropped segment while DV updates are written\n\nThis change fixes an isse where IW asks ReadersAndUpdates to write a DV updates for a\nsegment that has been dropped concurrently. The race only occurs if ram buffers are filled\nup enough to trigger flushing DV to disk.\n\nCo-authored-by: Nhat Nguyen <nhat.nguyen@elastic.co> ",
            "date": "2018-06-13T08:10:27+0000"
        },
        {
            "id": "comment-16510765",
            "author": "Simon Willnauer",
            "content": "fixed thanks! ",
            "date": "2018-06-13T08:12:24+0000"
        },
        {
            "id": "comment-16511009",
            "author": "Nhat Nguyen",
            "content": "Thanks Simon Willnauer ",
            "date": "2018-06-13T11:59:15+0000"
        },
        {
            "id": "comment-16512610",
            "author": "Lucene/Solr QA",
            "content": "\n\n\n  -1 overall \n\n\n\n\n\n\n\n\n\n Vote \n Subsystem \n Runtime \n Comment \n\n\n -1 \n  patch  \n   0m  8s \n  LUCENE-8355 does not apply to master. Rebase required? Wrong Branch? See https://wiki.apache.org/lucene-java/HowToContribute#Contributing_your_work for help.  \n\n\n\n\n\n\n\n\n\n Subsystem \n Report/Notes \n\n\n JIRA Issue \n LUCENE-8355 \n\n\n JIRA Patch URL \n https://issues.apache.org/jira/secure/attachment/12927571/LUCENE-8355.patch \n\n\n Console output \n https://builds.apache.org/job/PreCommit-LUCENE-Build/32/console \n\n\n Powered by \n Apache Yetus 0.7.0   http://yetus.apache.org \n\n\n\n\n\n\nThis message was automatically generated.\n ",
            "date": "2018-06-14T15:26:58+0000"
        }
    ]
}