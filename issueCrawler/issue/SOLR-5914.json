{
    "id": "SOLR-5914",
    "title": "Almost all Solr tests no longer cleanup their temp dirs on Windows",
    "details": {
        "affect_versions": "4.8",
        "status": "Closed",
        "fix_versions": [
            "4.8",
            "6.0"
        ],
        "components": [
            "Tests"
        ],
        "type": "Bug",
        "priority": "Critical",
        "labels": "",
        "resolution": "Fixed"
    },
    "description": "Recently the Windows Jenkins Build server has the problem of all-the time running out of disk space. This machine runs 2 workspaces (4.x and trunk) and has initially 8 Gigabytes of free SSD disk space.\n\nBecause of the recently all-the time failing tests, the test framework does not forcefully clean up the \"J0\" working folders after running tests. This leads to the fact, that the workspace is filled with tons of Solr Home dirs. I tried this on my local machine:\n\n\trun ant test\n\tgo to build/.../test/J0 and watch folders appearing: Almost every test no longer cleans up after shutting down, leaving a million of files there. This is approx 3 to 4 Gigabytes!!!\n\n\n\nIn Lucene the folders are correctly removed. This has happened recently, so i think we have some code like (Erick Erickson !!!):\nnew Properties().load(new FileInputStream(...)) that does not close the files. Because of this, the test's afterClass cannot clean up folders anymore. If you look in the test log, you see messages like \"!!!! WARNING: best effort to remove C:\\Users\\JenkinsSlave\\workspace\\Lucene-Solr-4.x-Windows\\solr\\build\\solr-core\\test\\J0\\.\\org.apache.solr.cloud.TestShortCircuitedRequests-1395693845226 FAILED !!!!!\" all the time.\n\nSo if anybody committed some changes that might not close files correctly, please fix! Otherwise I have to disable testing on windows - and I will no longer run solr, tests, too: My local computer also uses gigabytes of temp space after running tests!",
    "attachments": {
        "build-plugin.jpg": "https://issues.apache.org/jira/secure/attachment/12636963/build-plugin.jpg",
        "SOLR-5914 .patch": "https://issues.apache.org/jira/secure/attachment/12636987/SOLR-5914%20.patch",
        "branch4x-jenkins.png": "https://issues.apache.org/jira/secure/attachment/12636901/branch4x-jenkins.png",
        "trunk-jenkins.png": "https://issues.apache.org/jira/secure/attachment/12636900/trunk-jenkins.png"
    },
    "issue_links": {},
    "comments": [
        {
            "author": "Uwe Schindler",
            "id": "comment-13947776",
            "date": "2014-03-26T10:28:02+0000",
            "content": "Screenshots from the Windows Jenkins VM after out of disk space. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13947784",
            "date": "2014-03-26T10:32:34+0000",
            "content": "Perhaps we should change and instead of a warning throw a regular failure if something cannot be cleaned up? "
        },
        {
            "author": "Erick Erickson",
            "id": "comment-13947830",
            "date": "2014-03-26T11:46:19+0000",
            "content": "Uwe Schindler Wait, are you saying this is something I recently committed? Or just referencing one of my more stellar moments? "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13947868",
            "date": "2014-03-26T12:49:00+0000",
            "content": "No fingerpointing \n\nLet's try to make the tests better and life easier. I believe tests should clean up after they're done. When a test is successful, it should remove any directories or files it's created, simple. There is some infrastructure we could utilize for creating temp files and resources, such as:\n\nhttps://github.com/carrotsearch/randomizedtesting/blob/master/randomized-runner/src/main/java/com/carrotsearch/randomizedtesting/RandomizedTest.java#L371\n\nSpecifically, after a suite class completes (successfully), this File should be removable:\n\nhttps://github.com/carrotsearch/randomizedtesting/blob/master/randomized-runner/src/main/java/com/carrotsearch/randomizedtesting/RandomizedTest.java#L266\n "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13947892",
            "date": "2014-03-26T13:18:49+0000",
            "content": "Or just referencing one of my more stellar moments?\n\nThat one  "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13947907",
            "date": "2014-03-26T13:35:04+0000",
            "content": "Dawid Weiss added a comment - Today 10:32\nPerhaps we should change and instead of a warning throw a regular failure if something cannot be cleaned up?\n\n+1 "
        },
        {
            "author": "Yonik Seeley",
            "id": "comment-13947911",
            "date": "2014-03-26T13:40:24+0000",
            "content": "Perhaps we should change and instead of a warning throw a regular failure if something cannot be cleaned up?\n\n+1, failure to clean up on windows can often be indicative of a real bug. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13947914",
            "date": "2014-03-26T13:43:52+0000",
            "content": "I'll try to look into it. "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13947959",
            "date": "2014-03-26T14:29:29+0000",
            "content": "I think we just have to change the warning printed all the time (see issue description) to be a failure? "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13948025",
            "date": "2014-03-26T15:55:04+0000",
            "content": "Looking at a couple tests real quick, I've seen ZooKeeper files not cleaned up and tlog files not cleaned up. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13948195",
            "date": "2014-03-26T17:38:52+0000",
            "content": "Looking at a couple tests real quick, I've seen ZooKeeper files not cleaned up and tlog files not cleaned up.\n\nThat mostly looks like it's because our clean up code is a bit of a mess - I'll straighten it up. "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13948232",
            "date": "2014-03-26T18:03:49+0000",
            "content": "As a workaround I added the following post-build set on the windows Jenkins machines. This means that the test working folder are nuked when the build is done. This is not ideal, because we can no longer check what happened on windows builds, but this is the only possibility to work around this issue until the test bugs are fixed. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13948372",
            "date": "2014-03-26T19:50:20+0000",
            "content": "Here is a patch that cleans up the clean up code. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13948388",
            "date": "2014-03-26T20:06:55+0000",
            "content": "Fixes TestSolrEntityProcessorEndToEnd. "
        },
        {
            "author": "ASF subversion and git services",
            "id": "comment-13948409",
            "date": "2014-03-26T20:30:17+0000",
            "content": "Commit 1582038 from Mark Miller in branch 'dev/trunk'\n[ https://svn.apache.org/r1582038 ]\n\nSOLR-5914: Cleanup and fix Solr's test cleanup code. "
        },
        {
            "author": "ASF subversion and git services",
            "id": "comment-13948414",
            "date": "2014-03-26T20:31:57+0000",
            "content": "Commit 1582042 from Mark Miller in branch 'dev/branches/branch_4x'\n[ https://svn.apache.org/r1582042 ]\n\nSOLR-5914: Cleanup and fix Solr's test cleanup code. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13948415",
            "date": "2014-03-26T20:32:29+0000",
            "content": "That's a good start - my Windows VM likes it so far. "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13948432",
            "date": "2014-03-26T20:46:44+0000",
            "content": "Thanks Mark.\n\nIs it ok to remove the forceful cleanup after the Jenkins build? Means: We no longer create 3 Gigabytes of data per test run? "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13948441",
            "date": "2014-03-26T20:50:58+0000",
            "content": "Yeah, we should have proper cleanup, except for the spellcheck tests. Let's see how it pans out. "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13948615",
            "date": "2014-03-26T23:06:57+0000",
            "content": "Hi Mark,\n\nthanks. I started a new build. It looks better now, but its still generating > 2 GB data while running solr-core tests, so not everything is covered by the cleanup. Here is a live \"dir\" shortly before the tests succeeded:\n\n\nC:\\Users\\JenkinsSlave\\workspace\\Lucene-Solr-trunk-Windows\\solr\\build\\solr-core\\test>dir J0\n Volume in drive C is HARDDISK\n Volume Serial Number is 58F1-5382\n\n Directory of C:\\Users\\JenkinsSlave\\workspace\\Lucene-Solr-trunk-Windows\\solr\\build\\solr-core\\test\\J0\n\n2014-03-26  23:03    <DIR>          .\n2014-03-26  23:03    <DIR>          ..\n2014-03-26  22:14    <DIR>          1395872092623-0\n2014-03-26  22:51    <DIR>          alternateIdx1395874264370\n2014-03-26  23:02    <DIR>          badConfigSet\n2014-03-26  22:22    <DIR>          ChangedSchemaMergeTest\n2014-03-26  23:02    <DIR>          core-reload\n2014-03-26  22:15    <DIR>          data\n2014-03-26  23:02    <DIR>          findsConfigSets\n2014-03-26  22:14    <DIR>          managed\n2014-03-26  22:18    <DIR>          org.apache.solr.cloud.AliasIntegrationTest-1395872282539\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.AliasIntegrationTest-controljetty-1395872282776\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.AliasIntegrationTest-jetty1-1395872286276\n2014-03-26  22:18    <DIR>          org.apache.solr.cloud.AliasIntegrationTest-jetty2-1395872290964\n2014-03-26  22:18    <DIR>          org.apache.solr.cloud.AliasIntegrationTest-jetty3-1395872295741\n2014-03-26  22:36    <DIR>          org.apache.solr.cloud.AsyncMigrateRouteKeyTest-1395873396484\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.AsyncMigrateRouteKeyTest-controljetty-1395873396662\n2014-03-26  22:37    <DIR>          org.apache.solr.cloud.AsyncMigrateRouteKeyTest-jetty1-1395873399601\n2014-03-26  22:37    <DIR>          org.apache.solr.cloud.AsyncMigrateRouteKeyTest-jetty2-1395873403459\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.AsyncMigrateRouteKeyTest-jetty3-1395873407351\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.AsyncMigrateRouteKeyTest-jetty4-1395873411574\n2014-03-26  22:25    <DIR>          org.apache.solr.cloud.BasicDistributedZk2Test-1395872669978\n2014-03-26  22:25    <DIR>          org.apache.solr.cloud.BasicDistributedZk2Test-backupdir-1395872721159\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.BasicDistributedZk2Test-controljetty-1395872670179\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.BasicDistributedZk2Test-jetty1-1395872673905\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.BasicDistributedZk2Test-jetty2-1395872677749\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.BasicDistributedZk2Test-jetty3-1395872681517\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.BasicDistributedZk2Test-jetty4-1395872685545\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.BasicDistributedZk2Test-jetty5-1395872721863\n2014-03-26  22:39    <DIR>          org.apache.solr.cloud.BasicDistributedZkTest-1395873576104\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.BasicDistributedZkTest-controljetty-1395873576286\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.BasicDistributedZkTest-jetty1-1395873579528\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.BasicDistributedZkTest-jetty2-1395873583401\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.BasicDistributedZkTest-jetty3-1395873586925\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.BasicDistributedZkTest-jetty4-1395873590539\n2014-03-26  22:52    <DIR>          org.apache.solr.cloud.ChaosMonkeyNothingIsSafeTest-1395874307115\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ChaosMonkeyNothingIsSafeTest-controljetty-1395874307338\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ChaosMonkeyNothingIsSafeTest-jetty1-1395874311142\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ChaosMonkeyNothingIsSafeTest-jetty2-1395874315747\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ChaosMonkeyNothingIsSafeTest-jetty3-1395874320123\n2014-03-26  22:52    <DIR>          org.apache.solr.cloud.ChaosMonkeyNothingIsSafeTest-jetty4-1395874324288\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ChaosMonkeyNothingIsSafeTest-jetty5-1395874328202\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ChaosMonkeyNothingIsSafeTest-jetty6-1395874332189\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ChaosMonkeyNothingIsSafeTest-jetty7-1395874336606\n2014-03-26  22:53    <DIR>          org.apache.solr.cloud.CollectionsAPIAsyncDistributedZkTest-1395874432351\n2014-03-26  22:54    <DIR>          org.apache.solr.cloud.CollectionsAPIAsyncDistributedZkTest-controljetty-1395874432556\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.CollectionsAPIAsyncDistributedZkTest-jetty1-1395874436525\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.CollectionsAPIAsyncDistributedZkTest-jetty2-1395874441514\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.CollectionsAPIAsyncDistributedZkTest-jetty3-1395874446349\n2014-03-26  22:54    <DIR>          org.apache.solr.cloud.CollectionsAPIAsyncDistributedZkTest-jetty4-1395874450968\n2014-03-26  22:26    <DIR>          org.apache.solr.cloud.CollectionsAPIDistributedZkTest-1395872769742\n2014-03-26  22:28    <DIR>          org.apache.solr.cloud.CollectionsAPIDistributedZkTest-controljetty-1395872769991\n2014-03-26  22:28    <DIR>          org.apache.solr.cloud.CollectionsAPIDistributedZkTest-jetty1-1395872773183\n2014-03-26  22:28    <DIR>          org.apache.solr.cloud.CollectionsAPIDistributedZkTest-jetty2-1395872777010\n2014-03-26  22:28    <DIR>          org.apache.solr.cloud.CollectionsAPIDistributedZkTest-jetty3-1395872780620\n2014-03-26  22:28    <DIR>          org.apache.solr.cloud.CollectionsAPIDistributedZkTest-jetty4-1395872784271\n2014-03-26  22:32    <DIR>          org.apache.solr.cloud.CustomCollectionTest-1395873153259\n2014-03-26  22:33    <DIR>          org.apache.solr.cloud.CustomCollectionTest-controljetty-1395873153469\n2014-03-26  22:33    <DIR>          org.apache.solr.cloud.CustomCollectionTest-jetty1-1395873157398\n2014-03-26  22:33    <DIR>          org.apache.solr.cloud.CustomCollectionTest-jetty2-1395873162252\n2014-03-26  22:33    <DIR>          org.apache.solr.cloud.CustomCollectionTest-jetty3-1395873167251\n2014-03-26  22:33    <DIR>          org.apache.solr.cloud.CustomCollectionTest-jetty4-1395873172036\n2014-03-26  22:37    <DIR>          org.apache.solr.cloud.DeleteInactiveReplicaTest-1395873465635\n2014-03-26  22:38    <DIR>          org.apache.solr.cloud.DeleteInactiveReplicaTest-controljetty-1395873465859\n2014-03-26  22:38    <DIR>          org.apache.solr.cloud.DeleteInactiveReplicaTest-jetty1-1395873469262\n2014-03-26  22:38    <DIR>          org.apache.solr.cloud.DeleteInactiveReplicaTest-jetty2-1395873473633\n2014-03-26  22:38    <DIR>          org.apache.solr.cloud.DeleteInactiveReplicaTest-jetty3-1395873477736\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.DeleteInactiveReplicaTest-jetty4-1395873481815\n2014-03-26  22:16    <DIR>          org.apache.solr.cloud.DeleteReplicaTest-1395872184784\n2014-03-26  22:16    <DIR>          org.apache.solr.cloud.DeleteReplicaTest-controljetty-1395872185090\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.DeleteReplicaTest-jetty1-1395872190049\n2014-03-26  22:16    <DIR>          org.apache.solr.cloud.DeleteReplicaTest-jetty2-1395872195139\n2014-03-26  22:16    <DIR>          org.apache.solr.cloud.DeleteReplicaTest-jetty3-1395872200076\n2014-03-26  22:16    <DIR>          org.apache.solr.cloud.DeleteReplicaTest-jetty4-1395872204810\n2014-03-26  22:34    <DIR>          org.apache.solr.cloud.DeleteShardTest-1395873269920\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.DeleteShardTest-controljetty-1395873270159\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.DeleteShardTest-jetty1-1395873273799\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.DeleteShardTest-jetty2-1395873278330\n2014-03-26  22:54    <DIR>          org.apache.solr.cloud.DistribCursorPagingTest-1395874470943\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.DistribCursorPagingTest-controljetty-1395874471153\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.DistribCursorPagingTest-jetty1-1395874474981\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.DistribCursorPagingTest-jetty2-1395874479793\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.DistribCursorPagingTest-jetty3-1395874484627\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.DistribCursorPagingTest-jetty4-1395874489820\n2014-03-26  22:31    <DIR>          org.apache.solr.cloud.FullSolrCloudDistribCmdsTest-1395873081563\n2014-03-26  22:32    <DIR>          org.apache.solr.cloud.FullSolrCloudDistribCmdsTest-controljetty-1395873081829\n2014-03-26  22:32    <DIR>          org.apache.solr.cloud.FullSolrCloudDistribCmdsTest-jetty1-1395873085733\n2014-03-26  22:32    <DIR>          org.apache.solr.cloud.FullSolrCloudDistribCmdsTest-jetty2-1395873090044\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.FullSolrCloudDistribCmdsTest-jetty3-1395873094283\n2014-03-26  22:32    <DIR>          org.apache.solr.cloud.FullSolrCloudDistribCmdsTest-jetty4-1395873098475\n2014-03-26  22:32    <DIR>          org.apache.solr.cloud.FullSolrCloudDistribCmdsTest-jetty5-1395873102796\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.FullSolrCloudDistribCmdsTest-jetty6-1395873107325\n2014-03-26  22:55    <DIR>          org.apache.solr.cloud.MigrateRouteKeyTest-1395874516302\n2014-03-26  22:55    <DIR>          org.apache.solr.cloud.MigrateRouteKeyTest-controljetty-1395874516484\n2014-03-26  22:55    <DIR>          org.apache.solr.cloud.MigrateRouteKeyTest-jetty1-1395874519611\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.MigrateRouteKeyTest-jetty2-1395874523732\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.MigrateRouteKeyTest-jetty3-1395874527584\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.MigrateRouteKeyTest-jetty4-1395874531206\n2014-03-26  22:57    <DIR>          org.apache.solr.cloud.OverseerRolesTest-1395874575057\n2014-03-26  22:56    <DIR>          org.apache.solr.cloud.OverseerRolesTest-controljetty-1395874575320\n2014-03-26  22:56    <DIR>          org.apache.solr.cloud.OverseerRolesTest-jetty1-1395874579843\n2014-03-26  22:56    <DIR>          org.apache.solr.cloud.OverseerRolesTest-jetty2-1395874585458\n2014-03-26  22:56    <DIR>          org.apache.solr.cloud.OverseerRolesTest-jetty3-1395874591401\n2014-03-26  22:56    <DIR>          org.apache.solr.cloud.OverseerRolesTest-jetty4-1395874597692\n2014-03-26  22:56    <DIR>          org.apache.solr.cloud.OverseerRolesTest-jetty5-1395874603870\n2014-03-26  22:56    <DIR>          org.apache.solr.cloud.OverseerRolesTest-jetty6-1395874609504\n2014-03-26  22:23    <DIR>          org.apache.solr.cloud.OverseerStatusTest-1395872580782\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.OverseerStatusTest-controljetty-1395872580999\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.OverseerStatusTest-jetty1-1395872584409\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.OverseerStatusTest-jetty2-1395872588669\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.OverseerStatusTest-jetty3-1395872592777\n2014-03-26  22:23    <DIR>          org.apache.solr.cloud.OverseerStatusTest-jetty4-1395872596435\n2014-03-26  22:42    <DIR>          org.apache.solr.cloud.RecoveryZkTest-1395873762003\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.RecoveryZkTest-controljetty-1395873762283\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.RecoveryZkTest-jetty1-1395873766994\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.RecoveryZkTest-jetty2-1395873772754\n2014-03-26  22:24    <DIR>          org.apache.solr.cloud.RemoteQueryErrorTest-1395872621201\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.RemoteQueryErrorTest-controljetty-1395872621447\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.RemoteQueryErrorTest-jetty1-1395872625507\n2014-03-26  22:24    <DIR>          org.apache.solr.cloud.RemoteQueryErrorTest-jetty2-1395872630507\n2014-03-26  22:24    <DIR>          org.apache.solr.cloud.RemoteQueryErrorTest-jetty3-1395872636158\n2014-03-26  22:19    <DIR>          org.apache.solr.cloud.ShardRoutingCustomTest-1395872358405\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ShardRoutingCustomTest-controljetty-1395872358648\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ShardRoutingCustomTest-jetty1-1395872362534\n2014-03-26  22:29    <DIR>          org.apache.solr.cloud.ShardRoutingTest-1395872906293\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ShardRoutingTest-controljetty-1395872906517\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ShardRoutingTest-jetty1-1395872910026\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ShardRoutingTest-jetty2-1395872914490\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ShardRoutingTest-jetty3-1395872919050\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ShardRoutingTest-jetty4-1395872923562\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ShardRoutingTest-jetty5-1395872928627\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ShardRoutingTest-jetty6-1395872933434\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ShardRoutingTest-jetty7-1395872938064\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.ShardRoutingTest-jetty8-1395872942440\n2014-03-26  22:58    <DIR>          org.apache.solr.cloud.ShardSplitTest-1395874669896\n2014-03-26  22:59    <DIR>          org.apache.solr.cloud.ShardSplitTest-controljetty-1395874670069\n2014-03-26  22:58    <DIR>          org.apache.solr.cloud.ShardSplitTest-jetty1-1395874673104\n2014-03-26  22:59    <DIR>          org.apache.solr.cloud.ShardSplitTest-jetty2-1395874677188\n2014-03-26  22:58    <DIR>          org.apache.solr.cloud.ShardSplitTest-jetty3-1395874681049\n2014-03-26  22:59    <DIR>          org.apache.solr.cloud.ShardSplitTest-jetty4-1395874685037\n2014-03-26  22:57    <DIR>          org.apache.solr.cloud.SSLMigrationTest-1395874630695\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.SSLMigrationTest-controljetty-1395874630907\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.SSLMigrationTest-jetty1-1395874634153\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.SSLMigrationTest-jetty2-1395874638133\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.SSLMigrationTest-jetty3-1395874642015\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.SSLMigrationTest-jetty4-1395874645693\n2014-03-26  22:35    <DIR>          org.apache.solr.cloud.SyncSliceTest-1395873298880\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.SyncSliceTest-controljetty-1395873299093\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.SyncSliceTest-jetty1-1395873302366\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.SyncSliceTest-jetty2-1395873306431\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.SyncSliceTest-jetty3-1395873310382\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.SyncSliceTest-jetty4-1395873314162\n2014-03-26  23:00    <DIR>          org.apache.solr.cloud.TestDistribDocBasedVersion-1395874782399\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestDistribDocBasedVersion-controljetty-1395874782652\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestDistribDocBasedVersion-jetty1-1395874786890\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestDistribDocBasedVersion-jetty2-1395874791637\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestDistribDocBasedVersion-jetty3-1395874796422\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestDistribDocBasedVersion-jetty4-1395874800888\n2014-03-26  22:20    <DIR>          org.apache.solr.cloud.TestModifyConfFiles-1395872429293\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestModifyConfFiles-controljetty-1395872429555\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestModifyConfFiles-jetty1-1395872433940\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestModifyConfFiles-jetty2-1395872439551\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestModifyConfFiles-jetty3-1395872444054\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestModifyConfFiles-jetty4-1395872448716\n2014-03-26  22:36    <DIR>          org.apache.solr.cloud.TestRequestStatusCollectionAPI-1395873369032\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestRequestStatusCollectionAPI-controljetty-1395873369293\n2014-03-26  22:36    <DIR>          org.apache.solr.cloud.TestRequestStatusCollectionAPI-jetty1-1395873373119\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestRequestStatusCollectionAPI-jetty2-1395873377467\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestRequestStatusCollectionAPI-jetty3-1395873381763\n2014-03-26  22:36    <DIR>          org.apache.solr.cloud.TestRequestStatusCollectionAPI-jetty4-1395873385686\n2014-03-26  22:17    <DIR>          org.apache.solr.cloud.TestShortCircuitedRequests-1395872233140\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestShortCircuitedRequests-controljetty-1395872233358\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestShortCircuitedRequests-jetty1-1395872236934\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestShortCircuitedRequests-jetty2-1395872241635\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestShortCircuitedRequests-jetty3-1395872246453\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TestShortCircuitedRequests-jetty4-1395872251632\n2014-03-26  23:01    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-1395874815901\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-controljetty-1395874816084\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty1-1395874818914\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty10-1395874846280\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty11-1395874849202\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty12-1395874852320\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty13-1395874855705\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty14-1395874859035\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty15-1395874862723\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty16-1395874867046\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty17-1395874871870\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty18-1395874876210\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty19-1395874880819\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty2-1395874822466\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty20-1395874885941\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty21-1395874891003\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty22-1395874896108\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty23-1395874901734\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty24-1395874907454\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty3-1395874825873\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty4-1395874829053\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty5-1395874832242\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty6-1395874835169\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty7-1395874838032\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty8-1395874840695\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.TriLevelCompositeIdRoutingTest-jetty9-1395874843398\n2014-03-26  22:41    <DIR>          org.apache.solr.cloud.UnloadDistributedZkTest-1395873668638\n2014-03-26  01:25    <DIR>          org.apache.solr.cloud.UnloadDistributedZkTest-controljetty-1395873668829\n2014-03-26  22:42    <DIR>          org.apache.solr.cloud.UnloadDistributedZkTest-jetty1-1395873671999\n2014-03-26  22:41    <DIR>          org.apache.solr.cloud.UnloadDistributedZkTest-jetty2-1395873676015\n2014-03-26  22:41    <DIR>          org.apache.solr.cloud.UnloadDistributedZkTest-jetty3-1395873679981\n2014-03-26  22:41    <DIR>          org.apache.solr.cloud.UnloadDistributedZkTest-jetty4-1395873683716\n2014-03-26  22:51    <DIR>          org.apache.solr.core.TestArbitraryIndexDir-1395874280112\n2014-03-26  01:25    <DIR>          org.apache.solr.core.TestCoreContainer_classLoaderHierarchy\n2014-03-26  01:25    <DIR>          org.apache.solr.core.TestCoreContainer_reloadSequential\n2014-03-26  01:25    <DIR>          org.apache.solr.core.TestCoreContainer_reloadThreaded\n2014-03-26  01:25    <DIR>          org.apache.solr.core.TestCoreContainer_shareSchema\n2014-03-26  22:50    <DIR>          org.apache.solr.core.TestCoreDiscovery\n2014-03-26  23:02    <DIR>          org.apache.solr.core.TestSolrXml\n2014-03-26  22:50    <DIR>          org.apache.solr.handler.admin.CoreAdminHandlerTest-corex-1395874238332\n2014-03-26  23:02    <DIR>          org.apache.solr.handler.admin.CoreAdminRequestStatusTest\n2014-03-26  23:02    <DIR>          org.apache.solr.handler.component.DistributedExpandComponentTest-1395874957439\n2014-03-26  22:37    <DIR>          org.apache.solr.handler.component.DistributedQueryComponentCustomSortTest-1395873461156\n2014-03-26  23:02    <DIR>          org.apache.solr.handler.component.DistributedQueryComponentOptimizationTest-1395874964419\n2014-03-26  22:17    <DIR>          org.apache.solr.handler.component.DistributedQueryElevationComponentTest-1395872262687\n2014-03-26  22:46    <DIR>          org.apache.solr.handler.component.DistributedSpellCheckComponentTest-1395873972866\n2014-03-26  23:02    <DIR>          org.apache.solr.handler.component.DistributedSuggestComponentTest-1395874967878\n2014-03-26  22:48    <DIR>          org.apache.solr.handler.component.DistributedTermsComponentTest-1395874121982\n2014-03-26  22:46    <DIR>          org.apache.solr.handler.component.TermVectorComponentDistributedTest-1395873985101\n2014-03-26  22:18    <DIR>          org.apache.solr.schema.TestCloudManagedSchema-1395872325756\n2014-03-26  01:25    <DIR>          org.apache.solr.schema.TestCloudManagedSchema-controljetty-1395872325952\n2014-03-26  01:25    <DIR>          org.apache.solr.schema.TestCloudManagedSchema-jetty1-1395872329525\n2014-03-26  01:25    <DIR>          org.apache.solr.schema.TestCloudManagedSchema-jetty2-1395872334206\n2014-03-26  01:25    <DIR>          org.apache.solr.schema.TestCloudManagedSchema-jetty3-1395872338940\n2014-03-26  01:25    <DIR>          org.apache.solr.schema.TestCloudManagedSchema-jetty4-1395872344228\n2014-03-26  22:29    <DIR>          org.apache.solr.schema.TestCloudManagedSchemaAddField-1395872965843\n2014-03-26  01:25    <DIR>          org.apache.solr.schema.TestCloudManagedSchemaAddField-controljetty-1395872966121\n2014-03-26  01:25    <DIR>          org.apache.solr.schema.TestCloudManagedSchemaAddField-jetty1-1395872969983\n2014-03-26  01:25    <DIR>          org.apache.solr.schema.TestCloudManagedSchemaAddField-jetty2-1395872974755\n2014-03-26  01:25    <DIR>          org.apache.solr.schema.TestCloudManagedSchemaAddField-jetty3-1395872980253\n2014-03-26  01:25    <DIR>          org.apache.solr.schema.TestCloudManagedSchemaAddField-jetty4-1395872986370\n2014-03-26  01:25    <DIR>          org.apache.solr.schema.TestCloudManagedSchemaAddField-jetty5-1395872991156\n2014-03-26  01:25    <DIR>          org.apache.solr.schema.TestCloudManagedSchemaAddField-jetty6-1395872995862\n2014-03-26  01:25    <DIR>          org.apache.solr.schema.TestCloudManagedSchemaAddField-jetty7-1395873000361\n2014-03-26  01:25    <DIR>          org.apache.solr.schema.TestCloudManagedSchemaAddField-jetty8-1395873004604\n2014-03-26  22:45    <DIR>          org.apache.solr.TestDistributedGrouping-1395873933434\n2014-03-26  22:53    <DIR>          org.apache.solr.TestDistributedMissingSort-1395874378367\n2014-03-26  22:45    <DIR>          org.apache.solr.TestDistributedSearch-1395873900301\n2014-03-26  22:53    <DIR>          org.apache.solr.TestHighlightDedupGrouping-1395874387200\n2014-03-26  22:21    <DIR>          org.apache.solr.update.PeerSyncTest-1395872507319\n2014-03-26  22:49    <DIR>          org.apache.solr.update.SolrCmdDistributorTest-1395874180178\n2014-03-26  22:34    <DIR>          org.apache.solr.update.SolrIndexSplitterTesttestSplitByRouteKey\n2014-03-26  22:34    <DIR>          org.apache.solr.update.SolrIndexSplitterTest_testSplit1\n2014-03-26  22:34    <DIR>          org.apache.solr.update.SolrIndexSplitterTest_testSplit2\n2014-03-26  22:34    <DIR>          org.apache.solr.update.SolrIndexSplitterTest_testSplit3\n2014-03-26  22:21    <DIR>          solrHome\n2014-03-26  23:03    <DIR>          solrtest-BJQParserTest-1395875032523\n2014-03-26  22:21    <DIR>          solrtest-confdropspot-org.apache.solr.cloud.ZkCLITest-1395872486763\n2014-03-26  22:15    <DIR>          solrtest-DirectSolrSpellCheckerTest-1395872150183\n2014-03-26  22:21                16 solrtest-getfile-org.apache.solr.cloud.ZkCLITest-1395872466806\n2014-03-26  22:38    <DIR>          solrtest-LeaderElectionIntegrationTest-1395873511273\n2014-03-26  22:49    <DIR>          solrtest-QueryElevationComponentTest-1395874186376\n2014-03-26  22:49    <DIR>          solrtest-QueryElevationComponentTest-1395874186956\n2014-03-26  22:49    <DIR>          solrtest-QueryElevationComponentTest-1395874187677\n2014-03-26  22:49    <DIR>          solrtest-QueryElevationComponentTest-1395874188395\n2014-03-26  22:49    <DIR>          solrtest-QueryElevationComponentTest-1395874189158\n2014-03-26  22:49    <DIR>          solrtest-QueryElevationComponentTest-1395874189563\n2014-03-26  22:49    <DIR>          solrtest-QueryElevationComponentTest-1395874190215\n2014-03-26  22:50    <DIR>          solrtest-SolrCoreCheckLockOnStartupTest-1395874251121\n2014-03-26  22:59    <DIR>          solrtest-SolrXmlInZkTest-1395874762339\n2014-03-26  22:59    <DIR>          solrtest-SolrXmlInZkTest-1395874765727\n2014-03-26  22:59    <DIR>          solrtest-SolrXmlInZkTest-1395874769144\n2014-03-26  22:59    <DIR>          solrtest-SolrXmlInZkTest-1395874772554\n2014-03-26  22:59    <DIR>          solrtest-SolrXmlInZkTest-1395874775852\n2014-03-26  22:50    <DIR>          solrtest-SpellCheckCollatorTest-1395874233679\n2014-03-26  22:31    <DIR>          solrtest-SpellCheckComponentTest-1395873075489\n2014-03-26  22:51    <DIR>          solrtest-TestBinaryField-1395874298057\n2014-03-26  22:34    <DIR>          solrtest-TestManagedSchema-1395873255904\n2014-03-26  22:34    <DIR>          solrtest-TestManagedSchema-1395873256355\n2014-03-26  22:34    <DIR>          solrtest-TestManagedSchema-1395873256836\n2014-03-26  22:34    <DIR>          solrtest-TestManagedSchema-1395873257356\n2014-03-26  22:34    <DIR>          solrtest-TestManagedSchema-1395873257803\n2014-03-26  22:34    <DIR>          solrtest-TestManagedSchema-1395873258330\n2014-03-26  22:34    <DIR>          solrtest-TestManagedSchema-1395873258908\n2014-03-26  22:34    <DIR>          solrtest-TestManagedSchema-1395873259187\n2014-03-26  22:34    <DIR>          solrtest-TestManagedSchema-1395873259693\n2014-03-26  22:34    <DIR>          solrtest-TestManagedSchema-1395873260202\n2014-03-26  22:34    <DIR>          solrtest-TestManagedSchema-1395873260698\n2014-03-26  22:34    <DIR>          solrtest-TestManagedSchema-1395873260969\n2014-03-26  22:34    <DIR>          solrtest-TestManagedSchema-1395873261644\n2014-03-26  23:03    <DIR>          solrtest-TestManagedSchemaFieldResource-1395874989522\n2014-03-26  23:03    <DIR>          solrtest-TestManagedSchemaFieldResource-1395874992882\n2014-03-26  23:03    <DIR>          solrtest-TestManagedSchemaFieldResource-1395874995751\n2014-03-26  23:03    <DIR>          solrtest-TestManagedSchemaFieldResource-1395874998489\n2014-03-26  23:03    <DIR>          solrtest-TestManagedSchemaFieldResource-1395875001264\n2014-03-26  23:03    <DIR>          solrtest-TestManagedSchemaFieldResource-1395875004013\n2014-03-26  23:03    <DIR>          solrtest-TestManagedSchemaFieldResource-1395875006771\n2014-03-26  23:03    <DIR>          solrtest-TestManagedSchemaFieldResource-1395875009382\n2014-03-26  23:03    <DIR>          solrtest-TestManagedSchemaFieldResource-1395875011983\n2014-03-26  22:36    <DIR>          solrtest-TestSolrCoreProperties-1395873363377\n2014-03-26  22:14    <DIR>          solrtest-TestSolrXmlPersistence-1395872078098\n2014-03-26  22:44    <DIR>          solrtest-TestZkChroot-1395873858625\n2014-03-26  22:44    <DIR>          solrtest-TestZkChroot-1395873863542\n2014-03-26  22:44    <DIR>          solrtest-TestZkChroot-1395873865854\n2014-03-26  22:17    <DIR>          solrtest-WordBreakSolrSpellCheckerTest-1395872222378\n2014-03-26  22:21    <DIR>          solrtest-ZkCLITest-1395872459648\n2014-03-26  22:21    <DIR>          solrtest-ZkCLITest-1395872463281\n2014-03-26  22:21    <DIR>          solrtest-ZkCLITest-1395872466680\n2014-03-26  22:21    <DIR>          solrtest-ZkCLITest-1395872469063\n2014-03-26  22:21    <DIR>          solrtest-ZkCLITest-1395872472217\n2014-03-26  22:21    <DIR>          solrtest-ZkCLITest-1395872474359\n2014-03-26  22:21    <DIR>          solrtest-ZkCLITest-1395872476496\n2014-03-26  22:21    <DIR>          solrtest-ZkCLITest-1395872479370\n2014-03-26  22:21    <DIR>          solrtest-ZkCLITest-1395872482653\n2014-03-26  22:21    <DIR>          solrtest-ZkCLITest-1395872485943\n2014-03-26  22:21    <DIR>          solrtest-ZkCLITest-1395872489827\n2014-03-26  22:23    <DIR>          spellingIdx1395872620614\n2014-03-26  22:23    <DIR>          spellingIdx1395872620691\n2014-03-26  22:51    <DIR>          spellingIdx1395874264146\n2014-03-26  22:51    <DIR>          spellingIdx1395874264226\n2014-03-26  22:51    <DIR>          spellingIdx1395874264297\n2014-03-26  22:51    <DIR>          spellingIdx1395874264370\n2014-03-26  23:03    <DIR>          TestManagedSchema1395875022011\n2014-03-26  01:25    <DIR>          TestManagedSchemaFieldResource1395874989524\n2014-03-26  01:25    <DIR>          TestManagedSchemaFieldResource1395874992886\n2014-03-26  01:25    <DIR>          TestManagedSchemaFieldResource1395874995752\n2014-03-26  01:25    <DIR>          TestManagedSchemaFieldResource1395874998491\n2014-03-26  01:25    <DIR>          TestManagedSchemaFieldResource1395875001266\n2014-03-26  01:25    <DIR>          TestManagedSchemaFieldResource1395875004015\n2014-03-26  01:25    <DIR>          TestManagedSchemaFieldResource1395875006772\n2014-03-26  01:25    <DIR>          TestManagedSchemaFieldResource1395875009384\n2014-03-26  01:25    <DIR>          TestManagedSchemaFieldResource1395875011983\n2014-03-26  01:25    <DIR>          TestManagedSchemaFieldResource1395875014545\n2014-03-26  22:48    <DIR>          TestMultiCoreConfBootstrap-core1-1395874085663\n               1 File(s)             16 bytes\n             329 Dir(s)   2,512,564,224 bytes free\n\n\n\nAs the tests passed, the test framework was nuking that folder J0, but if tests would have failed it would have been a lot of data left over. "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13948617",
            "date": "2014-03-26T23:07:58+0000",
            "content": "After cleanup: 6,854,742,016 bytes free\n\nThis means the solr-core tests used 4.3 Gigabytes of disk space shortly before cleanup! "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13949126",
            "date": "2014-03-27T10:29:53+0000",
            "content": "I've looked at refactoring it a bit. The temporary folder and file creation in tests is very, very hairy. And time-consuming to fix. My conclusions so far:\n\n\twe should add deleteOnExit to forbidden APIs; most of its use is laziness, and potentially bugs like this one:\n\n    if (!success) {\n      try {\n        file.deleteOnExit();\n      } catch (Exception e) {\n        log.error(\"Error deleting file on exit: \" + file, e);\n      }\n    }\n\n\n\n\n\n\n\tasserting on a 'clean' temporary folder state may be impossible given how much code would have to be fixed (unless somebody can lend a hand here).\n\n\n\n\n\tglobal TEMP_DIR is evil. Use TestUtil.createTempFile and TestUtil.getTempDir (which I will rename to createTempDir).\n\n\n\nA patch will follow once I run the tests and ensure I didn't break anything. The patch removes refs to TEMP_DIR and cleans a lot of junk code. By calling TestUtil.* methods the temporary folders/ files are removed after a test class completes. Failure to remove a folder or a directory will cause a test suite failure. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13949145",
            "date": "2014-03-27T10:56:49+0000",
            "content": "I've created a branch at https://svn.apache.org/repos/asf/lucene/dev/branches/solr5914. A number of Solr tests fail on this branch (Windows):\n\nTests with failures (first 3 out of 11):\n  - org.apache.solr.handler.component.DistributedSpellCheckComponentTest (suite)\n  - org.apache.solr.spelling.IndexBasedSpellCheckerTest (suite)\n  - org.apache.solr.spelling.SpellCheckCollatorTest (suite)\n\n\n\nI have to switch to other things, it's taken me quite longer than I expected. If somebody wants to take over and try to fix those tests, go ahead. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13949297",
            "date": "2014-03-27T13:32:02+0000",
            "content": "You can't fix them easily - that's why I created the annotation for them to not fail on cleanup.  "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13949300",
            "date": "2014-03-27T13:34:51+0000",
            "content": "(At  least the spellcheck ones - I don't know what others are in that list) "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13949305",
            "date": "2014-03-27T13:41:38+0000",
            "content": "They won't pass on the branch \u2013 the criterion of being able to release temp. resources is now strict. It'd have to be a (disabled by default) test group so that these tests are not run at all. "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13949328",
            "date": "2014-03-27T13:51:23+0000",
            "content": "I think the most important thing in the new branch is this:\n\nA patch will follow once I run the tests and ensure I didn't break anything. The patch removes refs to TEMP_DIR and cleans a lot of junk code. By calling TestUtil.* methods the temporary folders/ files are removed after a test class completes. Failure to remove a folder or a directory will cause a test suite failure.\n\nThis gets my big +1. This makes Mark's manual cleanup code obsolete, because once you create a temp folder with the TestUtil method, this is nuked on test shutdown. But as Mark said, if those tests are not easy to fix, we have to think about a workaround.\n\nDawid: You said, 11 tests are failing, does this mean in your branch the number of left over files reduced dramatically? "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13949333",
            "date": "2014-03-27T13:54:00+0000",
            "content": "Yep. I think so. Try it. "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13949342",
            "date": "2014-03-27T13:59:05+0000",
            "content": "we should add deleteOnExit to forbidden APIs\n\n+1. I think we should disallow it globally. I was thinking first about \"test\" group only, but it also makes no sense to have it in our main code! "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13949378",
            "date": "2014-03-27T14:24:46+0000",
            "content": "It looks better now, but its still generating > 2 GB data while running solr-core tests, so not everything is covered by the cleanup\n\nYeah, so it looks like we are just trying to clean up the dataDir sub folder - instead we need to clean up the whole TEMP_DIR - some more things to fix to make that possible it looks. "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13949385",
            "date": "2014-03-27T14:28:47+0000",
            "content": "Yeah, so it looks like we are just trying to clean up the dataDir sub folder - instead we need to clean up the whole TEMP_DIR - some more things to fix to make that possible it looks.\n\nI think the branch created by Dawid covers this. Nuking the TEMP_DIR global evilness is a good step forward. Because TestUtil.createTemp* is already there to take care of cleanup. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13949403",
            "date": "2014-03-27T14:44:00+0000",
            "content": "Yeah, I'm fine with David's work as a longer term step - sounds like he calling it quits for now though, and I'm not ready to turn off all the spellcheck tests, so I'm working on a shorter term solution as a first step. "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13949441",
            "date": "2014-03-27T15:24:53+0000",
            "content": "I would not think thats needed. In his branch only 11 tests were initially not working. If you fix those we are done. The switch in his branch away from TEMP_DIR already fixed 99% of the stuff! "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13949451",
            "date": "2014-03-27T15:32:02+0000",
            "content": "In his branch only 11 tests were initially not working. If you fix those we are done.\n\nBe my guest on tackling that without just ignoring the tests \n\nNothing I'm doing conflicts with Davids work, and I know I can finish it and finish it shortly.\n\nThings like the spellchecker tests have problems root in apis rooted in years of history. I've got almost no time for this, and so I'd like to get the Solr clean up code in order, which will address this as a major issue in the short term and then we can focus on doing the right thing at the test framework level as a whole as follow up. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13949592",
            "date": "2014-03-27T17:00:00+0000",
            "content": "> sounds like he calling it quits for now though, \n\nNo, no man \u2013 I just had to do some real work and called in for a break. I also don't mean it has to be you in particular to fix those tests; like Uwe said, there are just a bunch of them (perhaps more, if we take a different seed \u2013 didn't check) so it's probably a realistic goal to fix these and merge back. If you look at the diff from trunk there were many horrible, horrible temp snippets I nuked. Perhaps I also introduced some regressions, another look from a different person would be definitely good.\n\nI'll get back to it when I can, obviously. "
        },
        {
            "author": "ASF subversion and git services",
            "id": "comment-13949641",
            "date": "2014-03-27T17:23:41+0000",
            "content": "Commit 1582413 from Mark Miller in branch 'dev/trunk'\n[ https://svn.apache.org/r1582413 ]\n\nSOLR-5914: Solr tests should use dataDir for tmp files. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13949655",
            "date": "2014-03-27T17:30:56+0000",
            "content": "\n-    File tmpdir = File.createTempFile(\"test\", \"tmp\", TEMP_DIR);\n+    File tmpdir = File.createTempFile(\"test\", \"tmp\", dataDir);\n\n\n\nMark, it'll make every single file conflict with what I've done on the branch... Seems like we're doubling efforts here. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13949672",
            "date": "2014-03-27T17:36:54+0000",
            "content": "I'm moving the reference to TEMP_DIR to one spot - so all those changes of your should just become unnecessary. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13949684",
            "date": "2014-03-27T17:42:39+0000",
            "content": "Seems like we're doubling efforts here.\n\nI'm not sure - I do know that it took me about 5 min to make that change, so it sounds like you spent most of your time on something else. I know your solution attempts to deal with TEMP_DIR and requires looking at 11 tests, some of which won't clean up properly anytime soon. My cleanup of Solr code to do what it was supposed to do to begin with already works with all tests.\n\nI look at what you are doing as a larger fix that is needed for the Lucene/Solr test framework as a whole. I'm happy to help with that later. I'm simply making the Solr cleanup code consistent with itself. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13949687",
            "date": "2014-03-27T17:44:42+0000",
            "content": "I think my patch has benefits over the previous code. It's more structured (uses test class names for temp dirs instead of arbitrary strings, in many cases copy-pasted incorrectly), it's not using timestamps (which is awkward), it relies on a single point of creating temporary folders and files (which we can use for enforcing stuff), each of which is tracked separately (so that you will know what code allocated a particular folder which caused problems).\n\nI honestly think the notion of \"dataDir\" in Solr's base test class is flawed \u2013 it just creates another sub-temp folder that becomes a dump for other temporary files, etc. Besides there's a lot of duplication too, for instance:\n\n+    dfsCluster = HdfsTestUtil.setupClass(new File(dataDir,\n         HdfsCollectionsAPIDistributedZkTest.class.getName() + \"_\"\n             + System.currentTimeMillis()).getAbsolutePath());\n\n\n\njust became a single call to:\n\n    dfsCluster = HdfsTestUtil.setupClass();\n\n\nbecause the temp file is created bases on the current context. How are these changes unnecessary compared to what you've done? "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13949691",
            "date": "2014-03-27T17:46:57+0000",
            "content": "> I'm not sure - I do know that it took me about 5 min to make that change,\n\nYeah... it took me over three hours to review and change those snippets which were using TEMP_DIR and now your commit will make me go through this again. Not fun. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13949697",
            "date": "2014-03-27T17:48:59+0000",
            "content": "Also: I can easily make those 11 tests still leave their leftover files behind (without causing a failure). I just deliberately chose not to because I thought we'd polish the patch before reintegrating.\n\nPerhaps it's still doable by reverting your commit (later on when the patch is ready) and then applying the changes made to the branch. Don't know if SVN can handle this well. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13949700",
            "date": "2014-03-27T17:50:15+0000",
            "content": "We can just merge up the branch - it's pretty easy. "
        },
        {
            "author": "ASF subversion and git services",
            "id": "comment-13949701",
            "date": "2014-03-27T17:50:26+0000",
            "content": "Commit 1582427 from Mark Miller in branch 'dev/branches/branch_4x'\n[ https://svn.apache.org/r1582427 ]\n\nSOLR-5914: Solr tests should use dataDir for tmp files. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13949711",
            "date": "2014-03-27T17:58:25+0000",
            "content": "I've got a meeting or two - give me a bit of time. Don't worry, this won't be any extra work for you. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13949736",
            "date": "2014-03-27T18:16:51+0000",
            "content": "I don't. But I don't see how you intend to keep your changes together with mine (and I preferred my version, to be honest . "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13949780",
            "date": "2014-03-27T18:48:45+0000",
            "content": "(and I preferred my version, to be honest) .\n\nYour version is wrong IMO  You attempted to address the use of TEMP_DIR at each place - but the Solr tests should not even be using TEMP_DIR like this - they should use dataDir as the cleanup code expects and as the sys prop solr.test.leavedatadir expects to work properly.\n\nAll Solr test files should already be created under a tmp directory specified in SolrTestCaseJ4 - they just started leaking out at some point.\n\nYou should only be dealing with this TEMP_DIR thing in one spot in Solr code. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13949864",
            "date": "2014-03-27T20:11:24+0000",
            "content": "You see it depends on what you consider \"wrong\". \n\nIs 'dataDir' embedded in some form of hierarchy (i.e., does it require a parent structure of folders)? I don't think so (based on the fact that most tests pass with flying colors \u2013 they don't \"depend\" on dataDir). The \"cleanup code\" present in Solr is in my opinion an unnecessary duplication and the notion of \"dataDir\" can lead to problems. I removed everything related to creating temporary folders and files and moved it to a single place. One clear evidence how broken it was is how many sections of the code tried to either create timestamp-based temporary folders or delete-recreate folders with a fixed name. This just sucked. If a test needs a temporary folder (initially empty) or a temporary file then it should ask for one.\n\nHaving one \"dataDir\" that one suite can inherit from another sounds \"wrong\" to me, especially if you allow certain suites to leave some of the files in those directories...\n\nSo I still argue that my commit was a better cleanup than yours. I don't work so much on Solr code though, so I won't authoritatively commit it back to the trunk without consensus. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13949893",
            "date": "2014-03-27T20:35:39+0000",
            "content": "So I still argue that my commit was a better cleanup than yours. \n\nI don't agree  Mine fixes the issue and doesn't do contentious things like remove the dataDir or the system property that controls cleaning it up. Your also is not finished - you state above that your stopping your work and that you sunk more than 3 hours into it.\n\nMy changes fix things to work as currently designed and took me less than 30 minutes.\n\nThe difference that you have fallen in love with is simply called TestUtil.createTmpDir vs using dataDir - I can't find it in myself to argue about that, but it seems totally unrelated anyway.\n\nYou have a path that you have spent hours on and still needs work and wants to do contentious things. I have a path that took me less than 30 min and is done.\n\nGreat, now I don't have to worry about lots of data not getting cleaned up, we can look at your slower path \n\nMerging up your branch won't take me any time at all, and we can properly discuss how this might be handled going forward. I won't make you go and make 3 hours of changes again  "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13949932",
            "date": "2014-03-27T21:13:31+0000",
            "content": "\nOne clear evidence how broken it was is how many sections of the code tried to either create timestamp-based temporary folders or delete-recreate folders with a fixed name. This just sucked. If a test needs a temporary folder (initially empty) or a temporary file then it should ask for one. \n\n\n\nYour conflating things - fixing this issue and improvements are two different things. I fixed the issue - according to the current rules. It sounds like you want to talk about changing the rules and adding improvements. Fine - but this is a burning issue - we leave gigs around on win on every run  \n\nWhat you have done is just not even competition for what I have done.\n\nIt's something to talk about and work on as a normal issue.\n\nThe only valid complaint I can see you might have is some work on merging was dump on you - which I've said I'll happily do. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13949971",
            "date": "2014-03-27T21:39:40+0000",
            "content": "\nOne clear evidence how broken it was is how many sections of the code tried to either create timestamp-based temporary folders or delete-recreate folders with a fixed name. This just sucked.\n\n\nIt wasn't even necessary - it was either a wrong or outdated idea - same with the attempts to delete and then mkdir or deleteOnExit. That's all stuff waiting for improvement. But that is just sugar - and I'll take sugar man  Load it on.\n\nI do have issues with how your branch does not deal with the borked dataDir concept, I don't like that it requires that special util method call everywhere. I really think what you have done actually simply compliments the fix, I would just do a few things a little differently. I'll show you how I would merge it up. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13950011",
            "date": "2014-03-27T22:07:29+0000",
            "content": "You see it depends on what you consider \"wrong\".\n\nLet's also come to agreement here. SolrjTestCase4j has a temporary directory that it tries to clean after the test and that you can set a special system property to prevent cleaning. This is obviously where Solr tests should be creating their temporary files - SolrjTestCase4j is the root of all Solr tests (or is intended to be). So clearly, this working haphazardly is wrong.\n\nI've been part of that happening - LuceneTestCase#TEMP_DIR was just too tempting - I remember it's allure and using it. It got to the point where a ton of stuff was no longer under the cleaned up tmp dir and we got into this situation. It was not always like this - we had much, much less leakage.\n\nSo I have fixed that. I didn't fix that the dataDir is conflated hopelessly between two worlds, I didn't fix any sugar api's or code, and I didn't address any other systemic issue. I just fixed what has clearly been borked and was supposed to work for eons now. If you set the right solr sys prop, you dont less any tmp files. When the test is over, it cleans up. That is back to working.\n\nIf we can agree on that, perhaps we can start on the path of improvement. I just started integrating into your branch. Let's see what I come up with and push forward together from there. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13950013",
            "date": "2014-03-27T22:11:59+0000",
            "content": "Oh yeah, I also fixed some other stuff that was confusing and silly - like trying to delete global test resources in tearDown and not just afterClass and other such garbage. "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13950130",
            "date": "2014-03-27T23:32:02+0000",
            "content": "Hi,\n\nthe last Jenkins run was successful. solr-core only had the well known SpellChecker tests leaving folders in the worker dir.\n\nWe had one failure in solrj (http://jenkins.thetaphi.de/job/Lucene-Solr-trunk-Windows/3901/)\n\n\n   [junit4] Suite: org.apache.solr.common.util.ContentStreamTest\n   [junit4]   2> Creating dataDir: C:\\Users\\JenkinsSlave\\workspace\\Lucene-Solr-trunk-Windows\\solr\\build\\solr-solrj\\test\\J0\\.\\solrtest-ContentStreamTest-1395962448800\n   [junit4]   2> 68449 T207 oas.SolrTestCaseJ4.buildSSLConfig Randomized ssl (true) and clientAuth (false)\n   [junit4]   2> 68452 T207 oas.SolrTestCaseJ4.setUp ###Starting testURLStream\n   [junit4]   2> 68453 T207 oasc.SolrResourceLoader.locateSolrHome JNDI not configured for solr (NoInitialContextEx)\n   [junit4]   2> 68453 T207 oasc.SolrResourceLoader.locateSolrHome solr home defaulted to 'solr/' (could not find system property or JNDI)\n   [junit4]   2> 68453 T207 oasc.SolrResourceLoader.<init> new SolrResourceLoader for deduced Solr Home: 'solr/'\n   [junit4]   2> 68554 T207 oas.SolrTestCaseJ4.tearDown ###Ending testURLStream\n   [junit4]   2> 68565 T207 oas.SolrTestCaseJ4.setUp ###Starting testFileStream\n   [junit4]   2> 68566 T207 oasc.SolrResourceLoader.locateSolrHome JNDI not configured for solr (NoInitialContextEx)\n   [junit4]   2> 68566 T207 oasc.SolrResourceLoader.locateSolrHome solr home defaulted to 'solr/' (could not find system property or JNDI)\n   [junit4]   2> 68567 T207 oasc.SolrResourceLoader.<init> new SolrResourceLoader for deduced Solr Home: 'solr/'\n   [junit4]   2> 68615 T207 oas.SolrTestCaseJ4.tearDown ###Ending testFileStream\n   [junit4]   2> 68622 T207 oas.SolrTestCaseJ4.setUp ###Starting testStringStream\n   [junit4]   2> 68623 T207 oas.SolrTestCaseJ4.tearDown ###Ending testStringStream\n   [junit4]   2> 68624 T207 oas.SolrTestCaseJ4.deleteCore ###deleteCore\n   [junit4]   2> !!!! WARNING: best effort to remove C:\\Users\\JenkinsSlave\\workspace\\Lucene-Solr-trunk-Windows\\solr\\build\\solr-solrj\\test\\J0\\.\\solrtest-ContentStreamTest-1395962448800\\README FAILED !!!!!\n   [junit4]   2> NOTE: test params are: codec=FastCompressingStoredFields(storedFieldsFormat=CompressingStoredFieldsFormat(compressionMode=FAST, chunkSize=271), termVectorsFormat=CompressingTermVectorsFormat(compressionMode=FAST, chunkSize=271)), sim=DefaultSimilarity, locale=en_IE, timezone=America/Vancouver\n   [junit4]   2> NOTE: Windows 7 6.1 x86/Oracle Corporation 1.7.0_51 (32-bit)/cpus=2,threads=1,free=17354576,total=84934656\n   [junit4]   2> NOTE: All tests run in this JVM: [TestXMLEscaping, JettyWebappTest, CloudSolrServerTest, LargeVolumeJettyTest, TestHash, SolrExampleStreamingTest, IteratorChainTest, TestFastInputStream, ContentStreamTest]\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=ContentStreamTest -Dtests.seed=32A8B44CEE4187EC -Dtests.slow=true -Dtests.locale=en_IE -Dtests.timezone=America/Vancouver -Dtests.file.encoding=UTF-8\n   [junit4] ERROR   0.00s | ContentStreamTest (suite) <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError: !!!! WARNING: best effort to remove C:\\Users\\JenkinsSlave\\workspace\\Lucene-Solr-trunk-Windows\\solr\\build\\solr-solrj\\test\\J0\\.\\solrtest-ContentStreamTest-1395962448800 FAILED !!!!!\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([32A8B44CEE4187EC]:0)\n   [junit4]    > \tat org.apache.solr.SolrTestCaseJ4.afterClass(SolrTestCaseJ4.java:217)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:744)\n   [junit4] Completed in 0.41s, 3 tests, 1 failure <<< FAILURES!\n\n\n\nI would also change the message to no longer say \"!!! WARNING !!!\" -> we should only print this with the annotation, otheriwse it should be a standard assertion Error without \"WARNING\" included. The current message is a bit confusing.\n\nOtherwise: Thanks Mark, that was fast!\n\nDawid: I agree with you that we should fix the whole stuff globally on the suite level. We should:\n\n\tremove the TEMP_DIR constant completely!\n\tforbid the File#deleteOnExit stuff\n\n\n\nUwe "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13950139",
            "date": "2014-03-27T23:37:58+0000",
            "content": "Thanks - I'll address the solrj test.\n\nI'll also commit my merge up to the branch soon - we can revert it if there is too much disagreement, but its the only easy way to show the work.\n\nThere will still be some things to tidy up, but I think the merge up has worked out pretty nicely myself. "
        },
        {
            "author": "ASF subversion and git services",
            "id": "comment-13950161",
            "date": "2014-03-27T23:49:04+0000",
            "content": "Commit 1582549 from Uwe Schindler in branch 'dev/trunk'\n[ https://svn.apache.org/r1582549 ]\n\nSOLR-5914: Fix missing close on Reader "
        },
        {
            "author": "ASF subversion and git services",
            "id": "comment-13950163",
            "date": "2014-03-27T23:50:09+0000",
            "content": "Commit 1582550 from Uwe Schindler in branch 'dev/branches/branch_4x'\n[ https://svn.apache.org/r1582550 ]\n\nMerged revision(s) 1582549 from lucene/dev/trunk:\nSOLR-5914: Fix missing close on Reader "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13950166",
            "date": "2014-03-27T23:50:39+0000",
            "content": "I fixed the ContentStreamTest suite (the Reader was not closed in one of the tests). "
        },
        {
            "author": "ASF subversion and git services",
            "id": "comment-13950227",
            "date": "2014-03-28T00:57:02+0000",
            "content": "Commit 1582571 from Mark Miller in branch 'dev/branches/solr5914'\n[ https://svn.apache.org/r1582571 ]\n\nSOLR-5914: Merge branch up to trunk, make all tests pass, make some other improvements and small changes. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13950230",
            "date": "2014-03-28T01:04:49+0000",
            "content": "I would also change the message to no longer say \"!!! WARNING !!!\" -> we should only print this with the annotation, otheriwse it should be a standard assertion Error without \"WARNING\" included. The current message is a bit confusing.\n\nI have not addressed that yet - I've just put a couple TODO's around the area - prob the largest thing left to cleanup. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13950244",
            "date": "2014-03-28T01:21:34+0000",
            "content": "Okay - good stuff I think.\n\nIf you guys have ideas for further improvements or spot issues, I'm happy to turn your thoughts into code. Or just jump right in. "
        },
        {
            "author": "ASF subversion and git services",
            "id": "comment-13950245",
            "date": "2014-03-28T01:21:47+0000",
            "content": "Commit 1582575 from Mark Miller in branch 'dev/branches/solr5914'\n[ https://svn.apache.org/r1582575 ]\n\nSOLR-5914: Fix map-reduce contrib tests use of solrhome. "
        },
        {
            "author": "ASF subversion and git services",
            "id": "comment-13950257",
            "date": "2014-03-28T01:33:45+0000",
            "content": "Commit 1582577 from Mark Miller in branch 'dev/branches/solr5914'\n[ https://svn.apache.org/r1582577 ]\n\nSOLR-5914: Fix morphlines contrib tests use of solrhome. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13950465",
            "date": "2014-03-28T07:51:50+0000",
            "content": "Hey. I don't know if I'll be able to go back to  this today, most likely not. I'll try to merge the changes Mark made to the trunk. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13950467",
            "date": "2014-03-28T07:52:34+0000",
            "content": "Uh, damn, I just noticed you already merged, Mark. Thanks. I'll review when I can. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13950470",
            "date": "2014-03-28T07:59:26+0000",
            "content": "Just a quick follow-up \u2013 is there any other reason for dataDir to exist other than to simplify cleanup? Also, what's the rationale for that property that prevents cleaning it up? The utilities in TestUtil have logic that doesn't prevent temporary directories when the test ended in a failure. Would this make that property effectively useless (because I think it's for debugging failed runs)? "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13950651",
            "date": "2014-03-28T12:53:27+0000",
            "content": "is there any other reason for dataDir to exist other than to simplify cleanup?\n\nYes - we want to be able to keep around all the files for debugging and development by request of the dev whether it fails or not - and it would be good if all those files for a test where under one root dir named after the test.\n\nI don't think that's fully happening yet though - I think the children dirs of the root test dir will still be removed - I've still got to look at that. "
        },
        {
            "author": "ASF subversion and git services",
            "id": "comment-13951034",
            "date": "2014-03-28T16:55:25+0000",
            "content": "Commit 1582826 from Mark Miller in branch 'dev/branches/solr5914'\n[ https://svn.apache.org/r1582826 ]\n\nSOLR-5914: Need to use ensureClosed boolean everywhere in SolrTestCaseJ4. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13954447",
            "date": "2014-03-29T21:19:59+0000",
            "content": "I looked at the current state of the branch, Mark, and I strongly disagree with having this in TestUtil:\n\n  public static File createTempDir(String name, File tmpDir, boolean ensureCleanedUp)\n\n\n\nIt's creating a gateway for bad code to proliferate. A temporary folder WILL be removed after a suite is done, there should be no way to \"opt out\" from this check. I understand sometimes it's useful to keep temp. files and it should be possible, but NOT AT THE CODE LEVEL (it should be a result of an explicit action of the developer).\n\nMy suggestion is to change SolrTestCaseJ4 and instead of putting the logic to keep temporary folders in there I'd rather:\n\n\n\tdeclare a global sys property that would prevent removing temporary folders (placed in TestUtil; but we can keep solr.test.leavetmpdir as an alias). In fact there already is a similar property for the runner itself:\n\n# Don't remove temporary files under slave directories, even if\n# the test passes.\nant -Dtests.leaveTemporary=true\n\n\nso we could just adopt it here too.\n\n\n\n\n\tmake an annotation called DirtyHarry (suggestions welcome) to mark suites which are known offenders of the default behavior. Classes annotated with DirtyHarry wouldn't fail if they leave undeletable garbage behind (but would print a warning).\n\n\n\nI also don't quite understand why you insist on things like this:\n\n rootTmpDir = TestUtil.createTempDir(\"solrtest-\" + cname, null, ensureClosed);\n initCoreDataDir = TestUtil.createTempDir(\"solrtest-\" + cname, rootTmpDir, ensureClosed);\n\n\n\nWhy 'solrtest-*' prefix? Isn't class name enough? And why create a temporary folder under a temporary folder (if we know rootTmpDir will always be empty, even on a run when previous runs left their temporary folders a new, empty folder uniquely suffixed will be created.\n\nAs for this:\n\n          // TODO: tmp files should already get cleaned up by the test framework, but\n          // we still do it here as well, so that we clean up as much as we can, even\n          // when a test is the SuppressTempDirCleanUp annotation\n\n\nit isn't true. The rule to clean up temporary files is fired almost at the very end of processing, after all the after class rules have already been executed. The reason for this is that you don't want to clean up any temporary files for failed tests/ suites and you know this only after everything else has been executed.\n\nLet me know what you think, I'll make the above changes and make them ready for your review. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13954456",
            "date": "2014-03-29T21:34:13+0000",
            "content": "Just looking at the diff file:\n\n+    solrHomeDirectory = createTempDir();\n+    FileUtils.deleteDirectory(solrHomeDirectory); // Ensure that a failed test didn't leave something lying around. \n\n\nThis is not possible. A new temporary folder will always be empty (it is uniquely suffixed if a previous folder with the same prefix exists), no need to clean it.\n\nYou reverted timestamp-based folder creation. I don't see the point of this. Why bother (again, parent will be empty anyway).\n\n-      File home = TestUtil.createTempDir(getClass().getName());\n+      File home = new File(dataDir, \n+                           getClass().getName() + \"-\" + \n+                           System.currentTimeMillis()); \n\n\n\nSame here:\n\n+    File indexDir = createTempDir();\n+    if (indexDir.exists())  {\n+      FileUtils.deleteDirectory(indexDir);\n+    }\n+    indexDir.mkdirs(); \n\n "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13954720",
            "date": "2014-03-30T15:42:19+0000",
            "content": "I looked at the current state of the branch, Mark, and I strongly disagree with having this in TestUtil: boolean ensureCleanedUp\n\nI don't really care about that - I left the tension between your clean up method and Solr's because yours is not good enough for our needs yet and Solr's is not making you happy. Like I said, that's the stuff that is left to clean up. I had to put that in now, because the spellcheck tests need to run and pass.\n\nMy suggestion is \n\nThat sounds fine to me - I would prefer first class test framework support for this rather than having it just be a Solr thing. \n\nI also don't quite understand why you insist on things like this:\n\nI don't insist - I think that was just already there. Though come to think of it, yes, I'd prefer test was in the folder name rather than just the classname.\n\nit isn't true. \n\nMy comment wasn't meant to indicate order of deletion. What it meant is that since we prevent the folder from being cleaned up via TestUtil, I still left that recursive delete so that any files that can be deleted still are.\n\nLike I said, this is the piece that is left to cleanup - and it's what I thought you intended from the beginning. This is what I meant when I said Dawid was working on first class test framework support and I was just doing the fix that made sense in the current world.\n\nAnyway, we always seem to have been on the same page but it seems you want to insist that we are not. Strange to me, but we will get there. No hurry anymore at least. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13954725",
            "date": "2014-03-30T15:48:45+0000",
            "content": "This is not possible. \n\nI didn't put that there that I know of - I removed most clean up attempts I saw, but I guess that missed that one. Must have just come in with the merge.\n\nYou reverted timestamp-based folder creation. \n\nI removed most of them but may have missed one or two.\n\nI was not 100% thorough on either of those since they don't hurt anything either - were I noticed, I removed them. You'll notice 99% of them are still gone, so they are obviously an oversight.\n\nThere was a lot of TestUtil calls to change, we can vet them before merging back in. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13954731",
            "date": "2014-03-30T16:03:39+0000",
            "content": "Just to make things simpler, take what I'm looking for and insist on from my comments and look at the branch as a work in progress.\n\nI'll reiterate what I'm looking for:\n\n1. We want a root temp directory for a Solr test. All tmp files created by that test are under this directory. Directory should be named after test class. Personally, I'd also prefer Solr and Test where in the name, but thats pretty low priority compared to the rest. I like tmp folders to be very self identifiable.\n\n2. As a dev, I want to be able to simply pass a sys prop to get that temp folder and all it's contents to stick around. Then I can easily explore the temporary indexes and what not that a test creates.\n\n3. I'd prefer we didn't have TestUtil calls all over the test code. If you want a temp folder, as you said, you should just have to ask for it - not pass any params. And getting a tmp dir for a test should be easily discoverable rather than a random Util class. Also, there should be no need to import.\n\nThose are my main sticking points. The rest is malleable. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13954735",
            "date": "2014-03-30T16:18:30+0000",
            "content": "To be explicit about the main work to do on that branch:\n\nWe are still using both delete methods - TestUtil's build in support and Solr's - why? It makes no sense to have both. But we have them because TestUtil is not good enough and we don't plan on staying with Solr. To make them both work the same, I have hacked TestUtil to work in concert with Sol's stuff. So, obviously, we have to resolve this on the branch.\n\nMy preference would be to get first class support for what I want outside of SolrTestCaseJ4 and remove all that cleanup code entirely.\n\nI suppose my backup would be to continue using what we have in Solr and stop using your TestUtil - but that would defeat a lot of the progress forward.\n "
        },
        {
            "author": "ASF subversion and git services",
            "id": "comment-13954759",
            "date": "2014-03-30T17:37:32+0000",
            "content": "Commit 1583163 from Mark Miller in branch 'dev/branches/solr5914'\n[ https://svn.apache.org/r1583163 ]\n\nSOLR-5914: Polish up createTempDir calls. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13955025",
            "date": "2014-03-31T08:25:00+0000",
            "content": "> Anyway, we always seem to have been on the same page but it seems you want to insist that we are not.\n\nWe are, I never meant to give you an impression that we're not. Discussion leads progress forward. \n\nI'll try to address your points above, give me some time though, I think all are addressable. I need a spare minute out of work to handle this. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13959936",
            "date": "2014-04-04T13:16:43+0000",
            "content": "I've committed some cleanups to the branch but I have some more on disk, unfinished. Don't bother looking at the branch yet, pls. "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13960183",
            "date": "2014-04-04T17:45:29+0000",
            "content": "I will close this issue because Mark addressed it already with his round of fixes and the temporary-resource refactoring has grown into a bigger deal. "
        },
        {
            "author": "Uwe Schindler",
            "id": "comment-13982509",
            "date": "2014-04-27T23:25:33+0000",
            "content": "Close issue after release of 4.8.0 "
        }
    ]
}