{
    "id": "SOLR-12442",
    "title": "Improve error message when a policy is violated while creating a collection",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [
            "AutoScaling"
        ],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "None",
        "resolution": "Unresolved",
        "status": "Open"
    },
    "description": "On master when I have this policy setup\n\ncurl -X POST -H 'Content-type:application/json' --data-binary '{\n\"set-cluster-policy\": [\n{\"cores\": \"<4\",\"node\": \"#ANY\"}\n]\n}' http://localhost:8983/solr/admin/autoscaling\n\nNow if I\u00a0try to create a collection where the policy will get violated , I'll get the following message in as a response\u00a0\n\n\u00a0\n\n{\n  \"responseHeader\":{\n    \"status\":500,\n    \"QTime\":13},\n  \"Operation create caused exception:\":\"org.apache.solr.common.SolrException:org.apache.solr.common.SolrException: Error getting replica locations\",\n  \"exception\":{\n    \"msg\":\"Error getting replica locations\",\n    \"rspCode\":500},\n  \"error\":{\n    \"metadata\":[\n      \"error-class\",\"org.apache.solr.common.SolrException\",\n      \"root-error-class\",\"org.apache.solr.common.SolrException\"],\n    \"msg\":\"Error getting replica locations\",\n    \"trace\":\"org.apache.solr.common.SolrException: Error getting replica locations\\n\\tat org.apache.solr.client.solrj.SolrResponse.getException(SolrResponse.java:53)\\n\\tat org.apache.solr.handler.admin.CollectionsHandler.invokeAction(CollectionsHandler.java:269)\\n\\tat org.apache.solr.handler.admin.CollectionsHandler.handleRequestBody(CollectionsHandler.java:241)\\n\\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:199)\\n\\tat org.apache.solr.servlet.HttpSolrCall.handleAdmin(HttpSolrCall.java:734)\\n\\tat org.apache.solr.servlet.HttpSolrCall.handleAdminRequest(HttpSolrCall.java:715)\\n\\tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:496)\\n\\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:378)\\n\\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:324)\\n\\tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1634)\\n\\tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:533)\\n\\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)\\n\\tat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\\n\\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\\n\\tat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)\\n\\tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1595)\\n\\tat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:255)\\n\\tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1253)\\n\\tat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)\\n\\tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:473)\\n\\tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1564)\\n\\tat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)\\n\\tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1155)\\n\\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)\\n\\tat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:219)\\n\\tat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)\\n\\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\\n\\tat org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:335)\\n\\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\\n\\tat org.eclipse.jetty.server.Server.handle(Server.java:531)\\n\\tat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:352)\\n\\tat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)\\n\\tat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:281)\\n\\tat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:102)\\n\\tat org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)\\n\\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)\\n\\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)\\n\\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)\\n\\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)\\n\\tat org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)\\n\\tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:760)\\n\\tat org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:678)\\n\\tat java.lang.Thread.run(Thread.java:745)\\n\",\n    \"code\":500}}\n\nWhich doesn't tell the user much about the error.\n\nHere's what's available in the logs\n\nINFO\u00a0 - 2018-06-04 04:00:42.591; [ \u00a0 ] org.apache.solr.cloud.api.collections.CreateCollectionCmd; There exists a configset by the same name as the collection we're trying to create: test_policy.AUTOCREATED, re-using it.\n\nINFO\u00a0 - 2018-06-04 04:00:42.594; [ \u00a0 ] org.apache.solr.client.solrj.cloud.autoscaling.PolicyHelper; returnSession, curr-time 54065039 sessionWrapper.createTime 54007929806801, this.sessionWrapper.createTime 54007929806801\n\nERROR - 2018-06-04 04:00:42.594; [ \u00a0 ] org.apache.solr.cloud.api.collections.OverseerCollectionMessageHandler; Collection: test_policy operation: create failed:org.apache.solr.common.SolrException: Error getting replica locations\n\nat org.apache.solr.cloud.api.collections.Assign.getPositionsUsingPolicy(Assign.java:405)\n\nat org.apache.solr.cloud.api.collections.Assign.identifyNodes(Assign.java:301)\n\nat org.apache.solr.cloud.api.collections.CreateCollectionCmd.buildReplicaPositions(CreateCollectionCmd.java:339)\n\nat org.apache.solr.cloud.api.collections.CreateCollectionCmd.call(CreateCollectionCmd.java:123)\n\nat org.apache.solr.cloud.api.collections.OverseerCollectionMessageHandler.processMessage(OverseerCollectionMessageHandler.java:257)\n\nat org.apache.solr.cloud.OverseerTaskProcessor$Runner.run(OverseerTaskProcessor.java:469)\n\nat org.apache.solr.common.util.ExecutorUtil$MDCAwareThreadPoolExecutor.lambda$execute$0(ExecutorUtil.java:209)\n\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\nat java.lang.Thread.run(Thread.java:745)\n\nCaused by: org.apache.solr.common.SolrException: No node can satisfy the rules [{\n\n\u00a0 \u00a0 \"cores\":\"<4\",\n\n\u00a0 \u00a0 \"node\":\"#ANY\"}]\n\nat org.apache.solr.client.solrj.cloud.autoscaling.PolicyHelper.getReplicaLocations(PolicyHelper.java:164)\n\nat org.apache.solr.cloud.api.collections.Assign.getPositionsUsingPolicy(Assign.java:393)\n\n... 9 more\n\n\n\nINFO\u00a0 - 2018-06-04 04:00:42.598; [ \u00a0 ] org.apache.solr.servlet.HttpSolrCall; [admin] webapp=null path=/admin/collections params={replicationFactor=2&name=test_policy&action=create&numShards=2} status=500 QTime=13\n\nERROR - 2018-06-04 04:00:42.599; [ \u00a0 ] org.apache.solr.servlet.HttpSolrCall; null:org.apache.solr.common.SolrException: Error getting replica locations\n\nat org.apache.solr.client.solrj.SolrResponse.getException(SolrResponse.java:53)\n\nat org.apache.solr.handler.admin.CollectionsHandler.invokeAction(CollectionsHandler.java:269)\n\nat org.apache.solr.handler.admin.CollectionsHandler.handleRequestBody(CollectionsHandler.java:241)\n\nat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:199)\n\nat org.apache.solr.servlet.HttpSolrCall.handleAdmin(HttpSolrCall.java:734)\n\nat org.apache.solr.servlet.HttpSolrCall.handleAdminRequest(HttpSolrCall.java:715)\n\nat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:496)\n\nat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:378)\n\nat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:324)\n\nat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1634)\n\nat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:533)\n\nat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:146)\n\nat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\n\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\n\nat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:257)\n\nat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1595)\n\nat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:255)\n\nat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1253)\n\nat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:203)\n\nat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:473)\n\nat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1564)\n\nat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:201)\n\nat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1155)\n\nat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:144)\n\nat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:219)\n\nat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)\n\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\n\nat org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:335)\n\nat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\n\nat org.eclipse.jetty.server.Server.handle(Server.java:531)\n\nat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:352)\n\nat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:260)\n\nat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:281)\n\nat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:102)\n\nat org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)\n\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)\n\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)\n\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)\n\nat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)\n\nat org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)\n\nat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:760)\n\nat org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:678)\n\nat java.lang.Thread.run(Thread.java:745)",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2018-06-04T04:53:03+0000",
            "content": "Looks like the full error from the overseer is either not propagated to the client or the client isn't checking the underlying caused by ",
            "author": "Varun Thacker",
            "id": "comment-16499739"
        }
    ]
}