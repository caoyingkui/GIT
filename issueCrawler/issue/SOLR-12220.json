{
    "id": "SOLR-12220",
    "title": "TestReplicationHandle.doTestStressReplication() fails on Windows because an index directory can't be deleted",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "None",
        "resolution": "Unresolved",
        "status": "Open"
    },
    "description": "Several recent Jenkins failures, e.g. https://jenkins.thetaphi.de/job/Lucene-Solr-7.x-Windows/533/:\n\n\n   [junit4]   2> 1820871 ERROR (qtp574829981-16047) [    x:collection1] o.a.s.c.CachingDirectoryFactory Error removing directory C:\\Users\\jenkins\\workspace\\Lucene-Solr-7.x-Windows\\solr\\build\\solr-core\\test\\J0\\temp\\solr.handler.TestReplicationHandler_A86A8FEB7F34064-001\\solr-instance-028\\collection1\\data\\index.20180408092515440 before \ncore close:java.io.IOException: Unable to delete file: C:\\Users\\jenkins\\workspace\\Lucene-Solr-7.x-Windows\\solr\\build\\solr-core\\test\\J0\\temp\\solr.handler.TestReplicationHandler_A86A8FEB7F34064-001\\solr-instance-028\\collection1\\data\\index.20180408092515440\\_0_Lucene50_0.tim\n   [junit4]   2>        at org.apache.commons.io.FileUtils.forceDelete(FileUtils.java:2381)\n   [junit4]   2>        at org.apache.commons.io.FileUtils.cleanDirectory(FileUtils.java:1679)\n   [junit4]   2>        at org.apache.commons.io.FileUtils.deleteDirectory(FileUtils.java:1575)\n   [junit4]   2>        at org.apache.solr.core.StandardDirectoryFactory.removeDirectory(StandardDirectoryFactory.java:108)\n   [junit4]   2>        at org.apache.solr.core.CachingDirectoryFactory.closeCacheValue(CachingDirectoryFactory.java:274)\n   [junit4]   2>        at org.apache.solr.core.CachingDirectoryFactory.release(CachingDirectoryFactory.java:437)\n   [junit4]   2>        at org.apache.solr.search.SolrIndexSearcher.close(SolrIndexSearcher.java:496)\n   [junit4]   2>        at org.apache.solr.core.SolrCore$2.close(SolrCore.java:2402)\n   [junit4]   2>        at org.apache.solr.util.RefCounted.decref(RefCounted.java:56)\n   [junit4]   2>        at org.apache.solr.request.SolrQueryRequestBase.close(SolrQueryRequestBase.java:154)\n   [junit4]   2>        at org.apache.solr.servlet.HttpSolrCall.destroy(HttpSolrCall.java:566)\n   [junit4]   2>        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:411)\n   [junit4]   2>        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:339)\n   [junit4]   2>        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1637)\n   [junit4]   2>        at org.apache.solr.client.solrj.embedded.JettySolrRunner$DebugFilter.doFilter(JettySolrRunner.java:139)\n   [junit4]   2>        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1637)\n   [junit4]   2>        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:533)\n   [junit4]   2>        at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:188)\n   [junit4]   2>        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1595)\n   [junit4]   2>        at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:188)\n   [junit4]   2>        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1253)\n   [junit4]   2>        at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:168)\n   [junit4]   2>        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:473)\n   [junit4]   2>        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1564)\n   [junit4]   2>        at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:166)\n   [junit4]   2>        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1155)\n   [junit4]   2>        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n   [junit4]   2>        at org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:527)\n   [junit4]   2>        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\n   [junit4]   2>        at org.eclipse.jetty.server.Server.handle(Server.java:530)\n   [junit4]   2>        at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:347)\n   [junit4]   2>        at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:256)\n   [junit4]   2>        at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:279)\n   [junit4]   2>        at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:102)\n   [junit4]   2>        at org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:124)\n   [junit4]   2>        at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:247)\n   [junit4]   2>        at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.produce(EatWhatYouKill.java:140)\n   [junit4]   2>        at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:131)\n   [junit4]   2>        at org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:382)\n   [junit4]   2>        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:708)\n   [junit4]   2>        at org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:626)\n   [junit4]   2>        at java.base/java.lang.Thread.run(Thread.java:844)\n[...]\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestReplicationHandler -Dtests.method=doTestStressReplication -Dtests.seed=A86A8FEB7F34064 -Dtests.slow=true -Dtests.locale=kab-DZ -Dtests.timezone=Asia/Jayapura -Dtests.asserts=true -Dtests.file.encoding=US-ASCII\n   [junit4]   2> 1820933 INFO  (OldIndexDirectoryCleanupThreadForCore-collection1) [    ] o.a.s.c.DirectoryFactory Deleted old index directory: C:\\Users\\jenkins\\workspace\\Lucene-Solr-7.x-Windows\\solr\\build\\solr-core\\test\\J0\\temp\\solr.handler.TestReplicationHandler_A86A8FEB7F34064-001\\solr-instance-028\\.\\collection1\\data\\index.20180408092515440\n   [junit4] FAILURE 1.06s J0 | TestReplicationHandler.doTestStressReplication <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError: found:2[index.20180408092515440, index.20180408092515667, index.properties, replication.properties, snapshot_metadata]\n   [junit4]    >        at __randomizedtesting.SeedInfo.seed([A86A8FEB7F34064:D12DA838B2DB29D7]:0)\n   [junit4]    >        at org.apache.solr.handler.TestReplicationHandler.checkForSingleIndex(TestReplicationHandler.java:966)\n   [junit4]    >        at org.apache.solr.handler.TestReplicationHandler.checkForSingleIndex(TestReplicationHandler.java:937)\n   [junit4]    >        at org.apache.solr.handler.TestReplicationHandler.doTestStressReplication(TestReplicationHandler.java:913)\n   [junit4]    >        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n   [junit4]    >        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n   [junit4]    >        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n   [junit4]    >        at java.base/java.lang.reflect.Method.invoke(Method.java:564)\n   [junit4]    >        at java.base/java.lang.Thread.run(Thread.java:844)\n\n\n\nI'll attach the full log for this ^^ failure.\n\nOther recent failures with this pattern: https://jenkins.thetaphi.de/job/Lucene-Solr-7.x-Windows/532/, https://jenkins.thetaphi.de/job/Lucene-Solr-7.x-Windows/535/, https://jenkins.thetaphi.de/job/Lucene-Solr-7.x-Windows/536/, https://jenkins.thetaphi.de/job/Lucene-Solr-7.x-Windows/538/, https://jenkins.thetaphi.de/job/Lucene-Solr-7.x-Windows/541/, https://jenkins.thetaphi.de/job/Lucene-Solr-master-Windows/7255/, https://jenkins.thetaphi.de/job/Lucene-Solr-master-Windows/7256/,\nhttps://jenkins.thetaphi.de/job/Lucene-Solr-master-Windows/7259/, https://jenkins.thetaphi.de/job/Lucene-Solr-master-Windows/7263/,\nhttps://jenkins.thetaphi.de/job/Lucene-Solr-master-Windows/7266/, https://jenkins.thetaphi.de/job/Lucene-Solr-master-Windows/7267/",
    "attachments": {
        "thetaphi.Lucene.Solr.7.x.Windows.533.log.txt.gz": "https://issues.apache.org/jira/secure/attachment/12918854/thetaphi.Lucene.Solr.7.x.Windows.533.log.txt.gz"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2018-04-13T02:01:24+0000",
            "content": "Maybe we could ignore the non-deleteable directory on Windows? ",
            "author": "Steve Rowe",
            "id": "comment-16436679"
        },
        {
            "date": "2018-04-13T06:56:06+0000",
            "content": "The fact a folder cannot be deleted is typically a signal of a deeper problem though? Like here:\n\nUnable to delete file: C:\\Users\\jenkins\\workspace\\Lucene-Solr-7.x-Windows\\solr\\build\\solr-core\\test\\J0\\temp\\solr.handler.TestReplicationHandler_A86A8FEB7F34064-001\\solr-instance-028\\collection1\\data\\index.20180408092515440_0_Lucene50_0.tim\n\nLooks like those files are still locked by this or another process (locked as in: open handles). Could be external to the test (Windows search, defender, something else) too. I once toyed with the idea of tracking file handle opening so that stack traces from unclosed channels/ files would be shown, but never had the time to do it. ",
            "author": "Dawid Weiss",
            "id": "comment-16436923"
        }
    ]
}