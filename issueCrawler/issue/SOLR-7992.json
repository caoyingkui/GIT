{
    "id": "SOLR-7992",
    "title": "QueryElevationComponentTest failures",
    "details": {
        "components": [],
        "type": "Bug",
        "labels": "",
        "fix_versions": [],
        "affect_versions": "None",
        "status": "Open",
        "resolution": "Unresolved",
        "priority": "Major"
    },
    "description": "My Jenkins found a failure http://jenkins.sarowe.net/job/Lucene-Solr-tests-5.x-Java8/1619/, reproduces for me on OS X:\n\n\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=QueryElevationComponentTest -Dtests.method=testMarkExcludes -Dtests.seed=99E233B631387D8 -Dtests.slow=true -Dtests.linedocsfile=/home/jenkins/lucene-data/enwiki.random.lines.txt -Dtests.locale=da -Dtests.timezone=America/North_Dakota/New_Salem -Dtests.asserts=true -Dtests.file.encoding=ISO-8859-1\n   [junit4] ERROR   1.12s J2  | QueryElevationComponentTest.testMarkExcludes <<<\n   [junit4]    > Throwable #1: java.lang.RuntimeException: Exception during query\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([99E233B631387D8:9CA79ACAFAFDA645]:0)\n   [junit4]    > \tat org.apache.solr.SolrTestCaseJ4.assertQ(SolrTestCaseJ4.java:765)\n   [junit4]    > \tat org.apache.solr.handler.component.QueryElevationComponentTest.testMarkExcludes(QueryElevationComponentTest.java:463)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:745)\n   [junit4]    > Caused by: java.lang.RuntimeException: REQUEST FAILED: xpath=//result/doc[2]/str[@name='id'][.='1']\n   [junit4]    > \txml response was: <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n   [junit4]    > <response>\n   [junit4]    > <lst name=\"responseHeader\">\n   [junit4]    >   <int name=\"status\">0</int>\n   [junit4]    >   <int name=\"QTime\">3</int>\n   [junit4]    >   <lst name=\"params\">\n   [junit4]    >     <str name=\"q\">XXXX XXXX</str>\n   [junit4]    >     <str name=\"qt\">/elevate</str>\n   [junit4]    >     <str name=\"indent\">true</str>\n   [junit4]    >     <str name=\"fl\">id, score, [excluded]</str>\n   [junit4]    >     <str name=\"markExcludes\">true</str>\n   [junit4]    >     <str name=\"wt\">xml</str>\n   [junit4]    >   </lst>\n   [junit4]    > </lst>\n   [junit4]    > <result name=\"response\" numFound=\"4\" start=\"0\" maxScore=\"2.3953636\">\n   [junit4]    >   <doc>\n   [junit4]    >     <str name=\"id\">5</str>\n   [junit4]    >     <float name=\"score\">0.0</float>\n   [junit4]    >     <bool name=\"[excluded]\">false</bool></doc>\n   [junit4]    >   <doc>\n   [junit4]    >     <str name=\"id\">4</str>\n   [junit4]    >     <float name=\"score\">2.3953636</float>\n   [junit4]    >     <bool name=\"[excluded]\">false</bool></doc>\n   [junit4]    >   <doc>\n   [junit4]    >     <str name=\"id\">1</str>\n   [junit4]    >     <float name=\"score\">2.3953636</float>\n   [junit4]    >     <bool name=\"[excluded]\">false</bool></doc>\n   [junit4]    >   <doc>\n   [junit4]    >     <str name=\"id\">6</str>\n   [junit4]    >     <float name=\"score\">2.3953636</float>\n   [junit4]    >     <bool name=\"[excluded]\">true</bool></doc>\n   [junit4]    > </result>\n   [junit4]    > </response>\n   [junit4]    > \trequest was:q=XXXX+XXXX&qt=/elevate&indent=true&fl=id,+score,+[excluded]&markExcludes=true&wt=xml\n   [junit4]    > \tat org.apache.solr.SolrTestCaseJ4.assertQ(SolrTestCaseJ4.java:758)\n   [junit4]    > \t... 40 more\n[...]\n   [junit4]   2> NOTE: leaving temporary files on disk at: /var/lib/jenkins/jobs/Lucene-Solr-tests-5.x-Java8/workspace/solr/build/solr-core/test/J2/temp/solr.handler.component.QueryElevationComponentTest_99E233B631387D8-001\n   [junit4]   2> NOTE: test params are: codec=Asserting(Lucene53), sim=RandomSimilarityProvider(queryNorm=false,coord=yes): {}, locale=da, timezone=America/North_Dakota/New_Salem\n   [junit4]   2> NOTE: Linux 4.1.0-custom2-amd64 amd64/Oracle Corporation 1.8.0_45 (64-bit)/cpus=16,threads=1,free=352090400,total=531103744\n   [junit4]   2> NOTE: All tests run in this JVM: [TestFoldingMultitermQuery, DirectUpdateHandlerTest, UUIDFieldTest, TestMinMaxOnMultiValuedField, TestCustomSort, CSVRequestHandlerTest, DateMathParserTest, AddBlockUpdateTest, StandardRequestHandlerTest, TestLMDirichletSimilarityFactory, TestFileDictionaryLookup, HLLSerializationTest, TestGroupingSearch, TestFieldTypeResource, TestElisionMultitermQuery, DistributedQueryComponentOptimizationTest, AnalysisAfterCoreReloadTest, TestScoreJoinQPScore, TestSolr4Spatial, TermVectorComponentTest, TestCollectionAPI, TestJettySolrRunner, BasicDistributedZk2Test, ShardRoutingTest, TermVectorComponentDistributedTest, SpellCheckComponentTest, QueryElevationComponentTest]\n   [junit4] Completed [269/536] on J2 in 6.50s, 9 tests, 1 error <<< FAILURES!\n\n\n\nProbably a test bug: looks like the test is depending on ordering of docs that have the same score.",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2017-07-07T00:44:39+0000",
            "author": "Steve Rowe",
            "content": "Reproducing master failures from my Jenkins:\n\n\n  [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=QueryElevationComponentTest -Dtests.method=testMarkExcludes -Dtests.seed=6B2454FA8EF2F84 -Dtests.slow=true -Dtests.locale=ar-SY -Dtests.timezone=America/Recife -Dtests.asserts=true -Dtests.file.encoding=US-ASCII\n   [junit4] ERROR   0.40s | QueryElevationComponentTest.testMarkExcludes <<<\n   [junit4]    > Throwable #1: java.lang.RuntimeException: Exception during query\n   [junit4]    >        at __randomizedtesting.SeedInfo.seed([6B2454FA8EF2F84:938BFCBE31010E19]:0)\n   [junit4]    >        at org.apache.solr.SolrTestCaseJ4.assertQ(SolrTestCaseJ4.java:878)\n   [junit4]    >        at org.apache.solr.handler.component.QueryElevationComponentTest.testMarkExcludes(QueryElevationComponentTest.java:466)\n   [junit4]    >        at java.lang.Thread.run(Thread.java:745)\n   [junit4]    > Caused by: java.lang.RuntimeException: REQUEST FAILED: xpath=//result/doc[2]/str[@name='id'][.='1']\n   [junit4]    >        xml response was: <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n   [junit4]    > <response>\n   [junit4]    > <lst name=\"responseHeader\">\n   [junit4]    >   <int name=\"status\">0</int>\n   [junit4]    >   <int name=\"QTime\">3</int>\n   [junit4]    >   <lst name=\"params\">\n   [junit4]    >     <str name=\"q\">XXXX XXXX</str>\n   [junit4]    >     <str name=\"qt\">/elevate</str>\n   [junit4]    >     <str name=\"indent\">true</str>\n   [junit4]    >     <str name=\"fl\">id, score, [excluded]</str>\n   [junit4]    >     <str name=\"markExcludes\">true</str>\n   [junit4]    >     <str name=\"wt\">xml</str>\n   [junit4]    >   </lst>\n   [junit4]    > </lst>\n   [junit4]    > <result name=\"response\" numFound=\"4\" start=\"0\" maxScore=\"3.149114\">\n   [junit4]    >   <doc>\n   [junit4]    >     <str name=\"id\">5</str>\n   [junit4]    >     <float name=\"score\">0.0</float>\n   [junit4]    >     <bool name=\"[excluded]\">false</bool></doc>\n   [junit4]    >   <doc>\n   [junit4]    >     <str name=\"id\">6</str>\n   [junit4]    >     <float name=\"score\">3.149114</float>\n   [junit4]    >     <bool name=\"[excluded]\">true</bool></doc>\n   [junit4]    >   <doc>\n   [junit4]    >     <str name=\"id\">1</str>\n   [junit4]    >     <float name=\"score\">3.149114</float>\n   [junit4]    >     <bool name=\"[excluded]\">false</bool></doc>\n   [junit4]    >   <doc>\n   [junit4]    >     <str name=\"id\">4</str>\n   [junit4]    >     <float name=\"score\">3.149114</float>\n   [junit4]    >     <bool name=\"[excluded]\">false</bool></doc>\n   [junit4]    > </result>\n   [junit4]    > </response>\n   [junit4]    >        request was:q=XXXX XXXX&qt=/elevate&indent=true&fl=id, score, [excluded]&markExcludes=true&wt=xml\n   [junit4]    >        at org.apache.solr.SolrTestCaseJ4.assertQ(SolrTestCaseJ4.java:871)\n\n\n\n\n  [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=QueryElevationComponentTest -Dtests.method=testMarker -Dtests.seed=6B2454FA8EF2F84 -Dtests.slow=true -Dtests.locale=ar-SY -Dtests.timezone=America/Recife -Dtests.asserts=true -Dtests.file.encoding=US-ASCII\n   [junit4] ERROR   0.27s | QueryElevationComponentTest.testMarker <<<\n   [junit4]    > Throwable #1: java.lang.RuntimeException: Exception during query\n   [junit4]    >        at __randomizedtesting.SeedInfo.seed([6B2454FA8EF2F84:C42C1892C7F88355]:0)\n   [junit4]    >        at org.apache.solr.SolrTestCaseJ4.assertQ(SolrTestCaseJ4.java:878)\n   [junit4]    >        at org.apache.solr.handler.component.QueryElevationComponentTest.testMarker(QueryElevationComponentTest.java:417)\n   [junit4]    >        at java.lang.Thread.run(Thread.java:745)\n   [junit4]    > Caused by: java.lang.RuntimeException: REQUEST FAILED: xpath=//result/doc[2]/str[@name='id'][.='4']\n   [junit4]    >        xml response was: <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n   [junit4]    > <response>\n   [junit4]    > <lst name=\"responseHeader\"><int name=\"status\">0</int><int name=\"QTime\">1</int><lst name=\"params\"><str name=\"q\">XXXX</str><str name=\"qt\">/elevate</str><str name=\"fl\">id, score, [elevated]</str><str name=\"wt\">xml</str></lst></lst><result name=\"response\" numFound=\"3\" start=\"0\" maxScore=\"1.0557057\"><doc><str name=\"id\">1</str><float name=\"score\">1.0557057</float><bool name=\"[elevated]\">true</bool></doc><doc><str name=\"id\">6</str><float name=\"score\">1.0557057</float><bool name=\"[elevated]\">false</bool></doc><doc><str name=\"id\">4</str><float name=\"score\">1.0557057</float><bool name=\"[elevated]\">false</bool></doc></result>\n   [junit4]    > </response>\n   [junit4]    >        request was:q=XXXX&qt=/elevate&fl=id, score, [elevated]&wt=xml\n   [junit4]    >        at org.apache.solr.SolrTestCaseJ4.assertQ(SolrTestCaseJ4.java:871)\n{noformat\n[...]\n   [junit4]   2> NOTE: test params are: codec=Asserting(Lucene70): {range_facet_l_dv=Lucene50(blocksize=128), multiDefault=PostingsFormat(name=MockRandom), intDefault=PostingsFormat(name=Memory), title=PostingsFormat(name=Memory), title_lettertok=Lucene50(blocksize=128), str_s=PostingsFormat(name=Direct), range_facet_l=PostingsFormat(name=MockRandom), id_i=PostingsFormat(name=Direct), title_stemmed=PostingsFormat(name=Memory), str_s1=PostingsFormat(name=MockRandom), id_i1=PostingsFormat(name=Memory), id=Lucene50(blocksize=128), text=PostingsFormat(name=Direct), range_facet_i_dv=PostingsFormat(name=MockRandom), timestamp=PostingsFormat(name=MockRandom)}, docValues:{range_facet_l_dv=DocValuesFormat(name=Asserting), multiDefault=DocValuesFormat(name=Lucene70), intDefault=DocValuesFormat(name=Memory), id_i1=DocValuesFormat(name=Memory), range_facet_i_dv=DocValuesFormat(name=Lucene70), id=DocValuesFormat(name=Asserting), text=DocValuesFormat(name=Lucene70), intDvoDefault=DocValuesFormat(name=Asserting), str_s=DocValuesFormat(name=Lucene70), timestamp=DocValuesFormat(name=Lucene70), range_facet_l=DocValuesFormat(name=Lucene70)}, maxPointsInLeafNode=1757, maxMBSortInHeap=5.0381035766118085, sim=RandomSimilarity(queryNorm=false): {}, locale=ar-SY, timezone=America/Recife\n   [junit4]   2> NOTE: Linux 4.1.0-custom2-amd64 amd64/Oracle Corporation 1.8.0_77 (64-bit)/cpus=16,threads=1,free=352245928,total=391118848\n\n ",
            "id": "comment-16077420"
        },
        {
            "date": "2017-08-11T20:37:14+0000",
            "author": "Steve Rowe",
            "content": "Still getting this reproducing failure on Jenkins occasionally, e.g. from https://builds.apache.org/job/Lucene-Solr-NightlyTests-master/1372:\n\n\nChecking out Revision fc7e2137431309b599419042eeb50b74c9b9e8e3 (refs/remotes/origin/master)\n[...]\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=QueryElevationComponentTest -Dtests.method=testMarkExcludes -Dtests.seed=C56F3F141A4CDA52 -Dtests.multiplier=2 -Dtests.nightly=true -Dtests.slow=true -Dtests.linedocsfile=/home/jenkins/jenkins-slave/workspace/Lucene-Solr-NightlyTests-master/test-data/enwiki.random.lines.txt -Dtests.locale=es-MX -Dtests.timezone=VST -Dtests.asserts=true -Dtests.file.encoding=UTF-8\n   [junit4] ERROR   0.66s J0 | QueryElevationComponentTest.testMarkExcludes <<<\n   [junit4]    > Throwable #1: java.lang.RuntimeException: Exception during query\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([C56F3F141A4CDA52:505686E583A2FBCF]:0)\n   [junit4]    > \tat org.apache.solr.SolrTestCaseJ4.assertQ(SolrTestCaseJ4.java:886)\n   [junit4]    > \tat org.apache.solr.handler.component.QueryElevationComponentTest.testMarkExcludes(QueryElevationComponentTest.java:466)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:748)\n   [junit4]    > Caused by: java.lang.RuntimeException: REQUEST FAILED: xpath=//result/doc[2]/str[@name='id'][.='1']\n   [junit4]    > \txml response was: <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n   [junit4]    > <response>\n   [junit4]    > <lst name=\"responseHeader\">\n   [junit4]    >   <int name=\"status\">0</int>\n   [junit4]    >   <int name=\"QTime\">2</int>\n   [junit4]    >   <lst name=\"params\">\n   [junit4]    >     <str name=\"q\">XXXX XXXX</str>\n   [junit4]    >     <str name=\"qt\">/elevate</str>\n   [junit4]    >     <str name=\"indent\">true</str>\n   [junit4]    >     <str name=\"fl\">id, score, [excluded]</str>\n   [junit4]    >     <str name=\"markExcludes\">true</str>\n   [junit4]    >     <str name=\"wt\">xml</str>\n   [junit4]    >   </lst>\n   [junit4]    > </lst>\n   [junit4]    > <result name=\"response\" numFound=\"4\" start=\"0\" maxScore=\"3.149114\">\n   [junit4]    >   <doc>\n   [junit4]    >     <str name=\"id\">5</str>\n   [junit4]    >     <float name=\"score\">0.0</float>\n   [junit4]    >     <bool name=\"[excluded]\">false</bool></doc>\n   [junit4]    >   <doc>\n   [junit4]    >     <str name=\"id\">4</str>\n   [junit4]    >     <float name=\"score\">3.149114</float>\n   [junit4]    >     <bool name=\"[excluded]\">false</bool></doc>\n   [junit4]    >   <doc>\n   [junit4]    >     <str name=\"id\">6</str>\n   [junit4]    >     <float name=\"score\">3.149114</float>\n   [junit4]    >     <bool name=\"[excluded]\">true</bool></doc>\n   [junit4]    >   <doc>\n   [junit4]    >     <str name=\"id\">1</str>\n   [junit4]    >     <float name=\"score\">3.149114</float>\n   [junit4]    >     <bool name=\"[excluded]\">false</bool></doc>\n   [junit4]    > </result>\n   [junit4]    > </response>\n   [junit4]    > \trequest was:q=XXXX+XXXX&qt=/elevate&indent=true&fl=id,+score,+[excluded]&markExcludes=true&wt=xml\n   [junit4]    > \tat org.apache.solr.SolrTestCaseJ4.assertQ(SolrTestCaseJ4.java:879)\n[...]\n   [junit4]   2> NOTE: test params are: codec=Lucene70, sim=RandomSimilarity(queryNorm=true): {}, locale=es-MX, timezone=VST\n   [junit4]   2> NOTE: Linux 3.13.0-88-generic amd64/Oracle Corporation 1.8.0_144 (64-bit)/cpus=4,threads=1,free=183197240,total=436207616\n\n ",
            "id": "comment-16124003"
        }
    ]
}