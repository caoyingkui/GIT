{
    "id": "SOLR-3258",
    "title": "Ping query caused exception..Invalid version (expected 2, but 60) or the data in not in 'javabin' format",
    "details": {
        "affect_versions": "None",
        "status": "Closed",
        "fix_versions": [
            "4.0-ALPHA"
        ],
        "components": [],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Not A Problem"
    },
    "description": "In a test set-up with nodes=2, shards=3 and cores=6 we often see this exception in the logs. Once every few ping requests this is thrown, other request return a proper OK.\n\nPing request handler:\n\n\n<requestHandler name=\"/admin/ping\" class=\"solr.PingRequestHandler\">\n    <lst name=\"invariants\">\n      <str name=\"qt\">select</str>\n      <str name=\"q\">*:*</str>\n      <int name=\"rows\">0</int>\n    </lst>\n    <lst name=\"defaults\">\n      <str name=\"wt\">json</str>\n      <str name=\"echoParams\">all</str>\n      <bool name=\"omitHeader\">true</bool>\n    </lst>\n  </requestHandler>\n\n\n\nException:\n\n\n2012-03-20 13:16:06,405 INFO [solr.core.SolrCore] - [http-80-18] - : [core_a] webapp=/solr path=/admin/ping params={} status=500 QTime=7 \n2012-03-20 13:16:06,406 ERROR [solr.servlet.SolrDispatchFilter] - [http-80-18] - : null:org.apache.solr.common.SolrException: Ping query caused exception: org.apache.solr.client.solrj.SolrServerException: java.lang.RuntimeException: Invalid version (expected 2, but 60) or the data in not in 'javabin' format\n        at org.apache.solr.handler.PingRequestHandler.handleRequestBody(PingRequestHandler.java:77)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1540)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:435)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:256)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:293)\n        at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:859)\n        at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:602)\n        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489)\n        at java.lang.Thread.run(Thread.java:662)\nCaused by: org.apache.solr.common.SolrException: org.apache.solr.client.solrj.SolrServerException: java.lang.RuntimeException: Invalid version (expected 2, but 60) or the data in not in 'javabin' format\n        at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:298)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1540)\n        at org.apache.solr.handler.PingRequestHandler.handleRequestBody(PingRequestHandler.java:68)\n        ... 16 more\nCaused by: org.apache.solr.client.solrj.SolrServerException: java.lang.RuntimeException: Invalid version (expected 2, but 60) or the data in not in 'javabin' format\n        at org.apache.solr.client.solrj.impl.LBHttpSolrServer.request(LBHttpSolrServer.java:278)\n        at org.apache.solr.handler.component.HttpShardHandler$1.call(HttpShardHandler.java:158)\n        at org.apache.solr.handler.component.HttpShardHandler$1.call(HttpShardHandler.java:123)\n        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:138)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)\n        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:138)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n        ... 1 more\nCaused by: java.lang.RuntimeException: Invalid version (expected 2, but 60) or the data in not in 'javabin' format\n        at org.apache.solr.common.util.JavaBinCodec.unmarshal(JavaBinCodec.java:109)\n        at org.apache.solr.client.solrj.impl.BinaryResponseParser.processResponse(BinaryResponseParser.java:41)\n        at org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:468)\n        at org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:251)\n        at org.apache.solr.client.solrj.impl.LBHttpSolrServer.request(LBHttpSolrServer.java:251)\n        ... 10 more",
    "attachments": {
        "zkdump.txt": "https://issues.apache.org/jira/secure/attachment/12519079/zkdump.txt",
        "debugging.patch": "https://issues.apache.org/jira/secure/attachment/12519077/debugging.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "author": "Dawid Weiss",
            "id": "comment-13233400",
            "date": "2012-03-20T13:29:23+0000",
            "content": "I once tried to debug it but couldn't reproduce. It does happen from time to time on my build machine though.\n\n'60' is ASCII for '<' so I guess it's something weird emitted. Can you apply the attached patch and try to cause this, Markus? "
        },
        {
            "author": "Markus Jelsma",
            "id": "comment-13233405",
            "date": "2012-03-20T13:47:25+0000",
            "content": "I've redeployed with your patch. This is very peculiar indeed! The stack trace shows a ping failing and at the bottom some that work well. I've also noticed the /select handler not being there so i've did a manual request on /select?q=: and i sometimes get the same error. Some work, some don't.\n\nDoes this help a bit?\n\n\n2012-03-20 13:45:30,352 INFO [solr.core.SolrCore] - [http-80-17] - : [] webapp=/solr path=/admin/ping params={} status=500 QTime=7 \n2012-03-20 13:45:30,352 ERROR [solr.servlet.SolrDispatchFilter] - [http-80-17] - : null:org.apache.solr.common.SolrException: Ping query caused exception: org.apache.solr.client.solrj.SolrServerException: java.lang.RuntimeException: Invalid version (expected 2, but 60) or the data in not in 'javabin' format, input: <html><head><title>Apache Tomcat/6.0.35 - Error report</title><style><!--H1 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:22px;} H2 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:16px;} H3 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:14px;} BODY {font-family:Tahoma,Arial,sans-serif;color:black;background-color:white;} B {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;} P {font-family:Tahoma,Arial,sans-serif;background:white;color:black;font-size:12px;}A {color : black;}A.name {color : black;}HR {color : #525D76;}--></style> </head><body><h1>HTTP Status 404 - /solr/select</h1><HR size=\"1\" noshade=\"noshade\"><p><b>type</b> Status report</p><p><b>message</b> <u>/solr/select</u></p><p><b>description</b> <u>The requested resource (/solr/select) is not available.</u></p><HR size=\"1\" noshade=\"noshade\"><h3>Apache Tomcat/6.0.35</h3></body></html>\n        at org.apache.solr.handler.PingRequestHandler.handleRequestBody(PingRequestHandler.java:77)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1540)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:435)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:256)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:293)\n        at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:859)\n        at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:602)\n        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489)\n        at java.lang.Thread.run(Thread.java:662)\nCaused by: org.apache.solr.common.SolrException: org.apache.solr.client.solrj.SolrServerException: java.lang.RuntimeException: Invalid version (expected 2, but 60) or the data in not in 'javabin' format, input: <html><head><title>Apache Tomcat/6.0.35 - Error report</title><style><!--H1 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:22px;} H2 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:16px;} H3 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:14px;} BODY {font-family:Tahoma,Arial,sans-serif;color:black;background-color:white;} B {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;} P {font-family:Tahoma,Arial,sans-serif;background:white;color:black;font-size:12px;}A {color : black;}A.name {color : black;}HR {color : #525D76;}--></style> </head><body><h1>HTTP Status 404 - /solr/select</h1><HR size=\"1\" noshade=\"noshade\"><p><b>type</b> Status report</p><p><b>message</b> <u>/solr/select</u></p><p><b>description</b> <u>The requested resource (/solr/select) is not available.</u></p><HR size=\"1\" noshade=\"noshade\"><h3>Apache Tomcat/6.0.35</h3></body></html>\n        at org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:298)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:129)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1540)\n        at org.apache.solr.handler.PingRequestHandler.handleRequestBody(PingRequestHandler.java:68)\n        ... 16 more\nCaused by: org.apache.solr.client.solrj.SolrServerException: java.lang.RuntimeException: Invalid version (expected 2, but 60) or the data in not in 'javabin' format, input: <html><head><title>Apache Tomcat/6.0.35 - Error report</title><style><!--H1 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:22px;} H2 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:16px;} H3 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:14px;} BODY {font-family:Tahoma,Arial,sans-serif;color:black;background-color:white;} B {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;} P {font-family:Tahoma,Arial,sans-serif;background:white;color:black;font-size:12px;}A {color : black;}A.name {color : black;}HR {color : #525D76;}--></style> </head><body><h1>HTTP Status 404 - /solr/select</h1><HR size=\"1\" noshade=\"noshade\"><p><b>type</b> Status report</p><p><b>message</b> <u>/solr/select</u></p><p><b>description</b> <u>The requested resource (/solr/select) is not available.</u></p><HR size=\"1\" noshade=\"noshade\"><h3>Apache Tomcat/6.0.35</h3></body></html>\n        at org.apache.solr.client.solrj.impl.LBHttpSolrServer.request(LBHttpSolrServer.java:278)\n        at org.apache.solr.handler.component.HttpShardHandler$1.call(HttpShardHandler.java:158)\n        at org.apache.solr.handler.component.HttpShardHandler$1.call(HttpShardHandler.java:123)\n        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:138)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)\n        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:138)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n        ... 1 more\nCaused by: java.lang.RuntimeException: Invalid version (expected 2, but 60) or the data in not in 'javabin' format, input: <html><head><title>Apache Tomcat/6.0.35 - Error report</title><style><!--H1 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:22px;} H2 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:16px;} H3 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:14px;} BODY {font-family:Tahoma,Arial,sans-serif;color:black;background-color:white;} B {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;} P {font-family:Tahoma,Arial,sans-serif;background:white;color:black;font-size:12px;}A {color : black;}A.name {color : black;}HR {color : #525D76;}--></style> </head><body><h1>HTTP Status 404 - /solr/select</h1><HR size=\"1\" noshade=\"noshade\"><p><b>type</b> Status report</p><p><b>message</b> <u>/solr/select</u></p><p><b>description</b> <u>The requested resource (/solr/select) is not available.</u></p><HR size=\"1\" noshade=\"noshade\"><h3>Apache Tomcat/6.0.35</h3></body></html>\n        at org.apache.solr.common.util.JavaBinCodec.unmarshal(JavaBinCodec.java:109)\n        at org.apache.solr.client.solrj.impl.BinaryResponseParser.processResponse(BinaryResponseParser.java:41)\n        at org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:468)\n        at org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:251)\n        at org.apache.solr.client.solrj.impl.LBHttpSolrServer.request(LBHttpSolrServer.java:251)\n        ... 10 more\n\n2012-03-20 13:45:30,585 INFO [solr.core.SolrCore] - [http-80-3] - : [] webapp=/solr path=/select params={omitHeader=true&fl=id,score&shard.url=nl2.index.openindex.io:80/solr/|nl1.index.openindex.io:80/solr/openindex_a/&NOW=1332251130581&start=0&q=*:*&distrib=false&isShard=true&wt=javabin&fsv=true&rows=0&version=2} hits=0 status=0 QTime=0 \n2012-03-20 13:45:30,586 INFO [solr.core.SolrCore] - [http-80-17] - : [] webapp=/solr path=/admin/ping params={} status=0 QTime=5 \n2012-03-20 13:45:30,587 INFO [solr.core.SolrCore] - [http-80-17] - : [] webapp=/solr path=/admin/ping params={} status=0 QTime=6\n\n "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13233408",
            "date": "2012-03-20T13:52:14+0000",
            "content": "And here comes the moment where my knowledge of Solr ends  I'd say there is definitely a bug in improper handling of HTTP response status (and this should be fixed), unless there is a filter somewhere that emits this HTML and fakes HTTP 200... But as for the cause of why this happens in general \u2013 no idea. "
        },
        {
            "author": "Markus Jelsma",
            "id": "comment-13233412",
            "date": "2012-03-20T14:00:50+0000",
            "content": "Nasty!\n\nWith this issue indexing fails, although some documents seem to be added. Custom request handlers still work but the default /select handler gives the trouble, which is used by our ping handler. Manual requests to /select?distrib=false do work without trouble.\n\nI also know that this happens with an empty index.\n\nI'd love to provide more details but i haven't. For now the issue is here but it just might disappear as suddenly as it appeared. "
        },
        {
            "author": "Markus Jelsma",
            "id": "comment-13233420",
            "date": "2012-03-20T14:07:52+0000",
            "content": "I suspected Solr's distributed capabilities because of the error occuring with distrib=true. So i stopped Zookeeper, removed the data directory and restarted Zookeeper and the Solr nodes. I attached a zookeeper dump i took just moments before removing the data directory.\n "
        },
        {
            "author": "Yonik Seeley",
            "id": "comment-13233426",
            "date": "2012-03-20T14:11:47+0000",
            "content": "I suspected Solr's distributed capabilities because of the error occuring with distrib=true.\n\nI was going to ask... do you mean for the ping query to be distributed? "
        },
        {
            "author": "Markus Jelsma",
            "id": "comment-13233436",
            "date": "2012-03-20T14:27:14+0000",
            "content": "It seems it is. The ping query is just a /select?q=:&rows=0 but it yields different results with distrib=false specified. "
        },
        {
            "author": "Markus Jelsma",
            "id": "comment-13233451",
            "date": "2012-03-20T14:43:08+0000",
            "content": "It seems i found the problem. The solr.xml file on one of the nodes received a typo. Instead shard=\"shard1\" i had shard_a=\"shard1\". It's pretty hard to reproduce but after removing the ZK data directories you can start the nodes with one core having a bad shard parameter. Originally only one node had a corrupt solr.xml file but i could only reproduce by corrupting the file on both nodes and starting Solr.\n "
        },
        {
            "author": "Hoss Man",
            "id": "comment-13291337",
            "date": "2012-06-07T21:42:45+0000",
            "content": "If i'm understanding correctly, it sounds like the root issue was invalid configuration on one server, and the error message was due to that javabin response codec trying to parse an plain text error response page from that server.\n\nSo it doesn't seem like there is any bug to fix here? "
        },
        {
            "author": "Dawid Weiss",
            "id": "comment-13291346",
            "date": "2012-06-07T21:48:49+0000",
            "content": "I don't know if it's invalid configuration or something else but the error message could be less cryptic  I mean \u2013 some kind of sanity check during header parsing would be nice (if possible). "
        },
        {
            "author": "Hoss Man",
            "id": "comment-13292123",
            "date": "2012-06-09T00:33:15+0000",
            "content": "some kind of sanity check during header parsing would be nice (if possible).\n\nyeha ... but that's kind of orthoginal to the initial bug report (that ping wasn't working in distrib mode)\n\nI opened SOLR-3530 to look into improving things, but there may be diminishing returns here. "
        }
    ]
}