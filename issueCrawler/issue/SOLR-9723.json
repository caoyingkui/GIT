{
    "id": "SOLR-9723",
    "title": "\"Error writing document\" on document add caused by NegativeArraySizeException",
    "details": {
        "components": [
            "update"
        ],
        "type": "Bug",
        "labels": "",
        "fix_versions": [],
        "affect_versions": "6.2.1",
        "status": "Open",
        "resolution": "Unresolved",
        "priority": "Major"
    },
    "description": "I'm adding documents to SOLR 6.2.1 via /solr/corename/update in a tight loop on multiple threads. After some time, SOLR starts throwing intermittent errors. They don't reproduce. Here's one:\n\n2016-11-02 02:29:10.997 ERROR (qtp1389647288-10719) [   x:fscan] o.a.s.h.RequestHandlerBase org.apache.solr.common.SolrException: Exception writing document id 72513253_HS-RNA-Valenzuela-2.xls to the index; possible analysis error.\n    \tat org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:178)\n    \tat org.apache.solr.update.processor.RunUpdateProcessor.processAdd(RunUpdateProcessorFactory.java:67)\n    \tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:48)\n    \tat org.apache.solr.update.processor.AddSchemaFieldsUpdateProcessorFactory$AddSchemaFieldsUpdateProcessor.processAdd(AddSchemaFieldsUpdateProcessorFactory.java:335)\n    \tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:48)\n    \tat org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:117)\n    \tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:48)\n    \tat org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:117)\n    \tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:48)\n    \tat org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:117)\n    \tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:48)\n    \tat org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:117)\n    \tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:48)\n    \tat org.apache.solr.update.processor.FieldNameMutatingUpdateProcessorFactory$1.processAdd(FieldNameMutatingUpdateProcessorFactory.java:74)\n    \tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:48)\n    \tat org.apache.solr.update.processor.FieldMutatingUpdateProcessor.processAdd(FieldMutatingUpdateProcessor.java:117)\n    \tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:48)\n    \tat org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalAdd(DistributedUpdateProcessor.java:939)\n    \tat org.apache.solr.update.processor.DistributedUpdateProcessor.versionAdd(DistributedUpdateProcessor.java:1094)\n    \tat org.apache.solr.update.processor.DistributedUpdateProcessor.processAdd(DistributedUpdateProcessor.java:720)\n    \tat org.apache.solr.update.processor.LogUpdateProcessorFactory$LogUpdateProcessor.processAdd(LogUpdateProcessorFactory.java:103)\n    \tat org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:48)\n    \tat org.apache.solr.update.processor.AbstractDefaultValueUpdateProcessorFactory$DefaultValueUpdateProcessor.processAdd(AbstractDefaultValueUpdateProcessorFactory.java:91)\n    \tat org.apache.solr.handler.loader.XMLLoader.processUpdate(XMLLoader.java:250)\n    \tat org.apache.solr.handler.loader.XMLLoader.load(XMLLoader.java:177)\n    \tat org.apache.solr.handler.UpdateRequestHandler$1.load(UpdateRequestHandler.java:97)\n    \tat org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:68)\n    \tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:154)\n    \tat org.apache.solr.core.SolrCore.execute(SolrCore.java:2089)\n    \tat org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:652)\n    \tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:459)\n    \tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:257)\n    \tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:208)\n    \tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1668)\n    \tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:581)\n    \tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\n    \tat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\n    \tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:226)\n    \tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1160)\n    \tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:511)\n    \tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\n    \tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1092)\n    \tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n    \tat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)\n    \tat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:119)\n    \tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)\n    \tat org.eclipse.jetty.server.Server.handle(Server.java:518)\n    \tat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:308)\n    \tat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:244)\n    \tat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:273)\n    \tat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:95)\n    \tat org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)\n    \tat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceAndRun(ExecuteProduceConsume.java:246)\n    \tat org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:156)\n    \tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:654)\n    \tat org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:572)\n    \tat java.lang.Thread.run(Thread.java:745)\n    Caused by: java.lang.NegativeArraySizeException\n    \tat org.apache.solr.common.util.JavaBinCodec.writeStr(JavaBinCodec.java:649)\n    \tat org.apache.solr.common.util.JavaBinCodec.writePrimitive(JavaBinCodec.java:742)\n    \tat org.apache.solr.common.util.JavaBinCodec.writeKnownType(JavaBinCodec.java:289)\n    \tat org.apache.solr.common.util.JavaBinCodec.writeVal(JavaBinCodec.java:194)\n    \tat org.apache.solr.common.util.JavaBinCodec.writeSolrInputDocument(JavaBinCodec.java:489)\n    \tat org.apache.solr.update.TransactionLog.write(TransactionLog.java:361)\n    \tat org.apache.solr.update.UpdateLog.add(UpdateLog.java:429)\n    \tat org.apache.solr.update.UpdateLog.add(UpdateLog.java:415)\n    \tat org.apache.solr.update.DirectUpdateHandler2.doNormalUpdate(DirectUpdateHandler2.java:299)\n    \tat org.apache.solr.update.DirectUpdateHandler2.addDoc0(DirectUpdateHandler2.java:211)\n    \tat org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:166)\n    \t... 56 more\n\nThe disk is not running out of space, I've checked.",
    "attachments": {},
    "issue_links": {},
    "comments": []
}