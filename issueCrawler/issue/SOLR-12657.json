{
    "id": "SOLR-12657",
    "title": "Facet streaming expression doesn't support min / max correctly for date fields.",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [
            "streaming expressions"
        ],
        "type": "Bug",
        "fix_versions": [
            "7.4.1"
        ],
        "affect_versions": "7.4",
        "resolution": "Unresolved",
        "status": "Open"
    },
    "description": "Using this streaming expression to compute a min / max timestamp for each movie_id in my ratings collection (movielens),\n\n\nfacet(ratings,\n q=\"movie_id:[* TO *]\",\n buckets=\"movie_id\",\n bucketSizeLimit=1254,\n bucketSorts=\"movie_id asc\", count(*),\n min(rating_timestamp),\n max(rating_timestamp)\n)\n\n\n\n\nI get the following errors:\n\n\n2018-08-10T17:48:58,293 - INFO [qtp726950788-385:solr.core.SolrCore@2544] - \\{collection=c:ratings, core=x:ratings_shard1_replica_n1, node_name=n:192.168.1.6:8983_solr, replica=r:core_node2, shard=s:shard1} - [ratings_shard1_replica_n1] webapp=/solr path=/stream params=\\{expr=facet(ratings,%0a++++++++++++++q%3D\"movie_id:[*+TO+*]\",%0a++++++++++++++buckets%3D\"movie_id\",%0a++++++++++++++bucketSizeLimit%3D1254,%0a++++++++++++++bucketSorts%3D\"movie_id+asc\",+count(*),%0a++++++++++++++min(rating_timestamp),%0a++++++++++++++max(rating_timestamp)%0a)&_=1533923249300} status=0 QTime=0\n2018-08-10T17:48:58,313 - INFO [qtp726950788-17:solr.core.SolrCore@2544] - \\{collection=c:ratings, core=x:ratings_shard1_replica_n1, node_name=n:192.168.1.6:8983_solr, replica=r:core_node2, shard=s:shard1} - [ratings_shard1_replica_n1] webapp=/solr path=/select params=\\{q=movie_id:[*+TO+*]&json.facet={\"movie_id\":{\"type\":\"terms\",\"field\":\"movie_id\",\"limit\":1254,\"sort\":{\"index\":\"asc\"},\"facet\":\\{\"facet_0\":\"min(rating_timestamp)\",\"facet_1\":\"max(rating_timestamp)\"}}}&_stateVer_=ratings:4&bucketSizeLimit=1254&rows=0&wt=javabin&version=2} hits=100000 status=0 QTime=17\n2018-08-10T17:48:58,316 - ERROR [qtp726950788-385:solr.common.SolrException@148] - \\{collection=c:ratings, core=x:ratings_shard1_replica_n1, node_name=n:192.168.1.6:8983_solr, replica=r:core_node2, shard=s:shard1} - java.io.IOException: java.lang.ClassCastException: java.util.Date cannot be cast to java.lang.Number\n at org.apache.solr.client.solrj.io.stream.FacetStream.open(FacetStream.java:346)\n at org.apache.solr.client.solrj.io.stream.ExceptionStream.open(ExceptionStream.java:54)\n at org.apache.solr.handler.StreamHandler$TimerStream.open(StreamHandler.java:397)\n at org.apache.solr.client.solrj.io.stream.TupleStream.writeMap(TupleStream.java:83)\n at org.apache.solr.response.JSONWriter.writeMap(JSONResponseWriter.java:539)\n at org.apache.solr.response.TextResponseWriter.writeVal(TextResponseWriter.java:181)\n at org.apache.solr.response.JSONWriter.writeNamedListAsMapWithDups(JSONResponseWriter.java:209)\n at org.apache.solr.response.JSONWriter.writeNamedList(JSONResponseWriter.java:325)\n at org.apache.solr.response.JSONWriter.writeResponse(JSONResponseWriter.java:120)\n at org.apache.solr.response.JSONResponseWriter.write(JSONResponseWriter.java:71)\n at org.apache.solr.response.QueryResponseWriterUtil.writeQueryResponse(QueryResponseWriterUtil.java:65)\n at org.apache.solr.servlet.HttpSolrCall.writeResponse(HttpSolrCall.java:787)\n at org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:524)\n at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:377)\n at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:323)\n at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1668)\n at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:581)\n at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\n at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\n at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:226)\n at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1160)\n at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:511)\n at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:185)\n at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1092)\n at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)\n at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:119)\n at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)\n at org.eclipse.jetty.server.Server.handle(Server.java:518)\n at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:308)\n at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:244)\n at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:273)\n at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:95)\n at org.eclipse.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)\n at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.produceAndRun(ExecuteProduceConsume.java:246)\n at org.eclipse.jetty.util.thread.strategy.ExecuteProduceConsume.run(ExecuteProduceConsume.java:156)\n at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:654)\n at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:572)\n at java.lang.Thread.run(Thread.java:748)\nCaused by: java.lang.ClassCastException: java.util.Date cannot be cast to java.lang.Number\n at org.apache.solr.client.solrj.io.stream.FacetStream.fillTuples(FacetStream.java:502)\n at org.apache.solr.client.solrj.io.stream.FacetStream.getTuples(FacetStream.java:459)\n at org.apache.solr.client.solrj.io.stream.FacetStream.open(FacetStream.java:342)\n ... 38 more\n\n\n\n\n\u00a0\n\nHowever, the JSON facet API definitely supports this:\u00a0\n\n\ncurl http://localhost:8983/solr/ratings/query -d 'rows=0&q=movie_id:[* TO *]&json.facet={\n\n\u00a0 movie_id:{\n\n\u00a0 \u00a0 type:terms,\n\n\u00a0 \u00a0 field:\"movie_id\",\n\n\u00a0 \u00a0 limit:100,\n\n\u00a0 \u00a0 sort:\\{count:desc},\n\n\u00a0 \u00a0 facet: {\n\n\u00a0 \u00a0 \u00a0 min_ts: \"min(rating_timestamp)\"\n\n\u00a0 \u00a0 \u00a0 max_ts: \"max(rating_timestamp)\"\n\n\u00a0 \u00a0 }\n\n\u00a0 }\n\n}'\n\n\n\n\nGives the expected results:\n\n\n\"facets\":{\n\n\u00a0 \u00a0 \"count\":100000,\n\n\u00a0 \u00a0 \"movie_id\":{\n\n\u00a0 \u00a0 \u00a0 \"buckets\":[{\n\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"val\":\"50\",\n\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"count\":583,\n\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"min_ts\":\"1997-09-20T04:29:10Z\",\n\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"max_ts\":\"1998-04-22T16:53:14Z\"},\n\n\u00a0 \u00a0 \u00a0 \u00a0 {\n\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"val\":\"258\",\n\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"count\":509,\n\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"min_ts\":\"1997-09-20T20:12:17Z\",\n\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"max_ts\":\"1998-04-22T22:09:38Z\"},\n\n\u00a0 \u00a0 \u00a0 \u00a0 ...",
    "attachments": {},
    "issue_links": {},
    "comments": []
}