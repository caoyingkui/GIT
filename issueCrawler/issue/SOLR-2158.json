{
    "id": "SOLR-2158",
    "title": "TestDistributedSearch.testDistribSearch fails often",
    "details": {
        "affect_versions": "3.1,                                            4.0-ALPHA",
        "status": "Closed",
        "fix_versions": [
            "3.1",
            "4.0-ALPHA"
        ],
        "components": [
            "Build"
        ],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Fixed"
    },
    "description": "TestDistributedSearch.testDistribSearch fails often in hudson, with some threads throwing uncaught exceptions.",
    "attachments": {
        "TEST-org.apache.solr.TestDistributedSearch.txt": "https://issues.apache.org/jira/secure/attachment/12465281/TEST-org.apache.solr.TestDistributedSearch.txt"
    },
    "issue_links": {},
    "comments": [
        {
            "author": "Yonik Seeley",
            "id": "comment-12966694",
            "date": "2010-12-03T22:10:22+0000",
            "content": "Attaching a log file from the hudson machine.\n\nThis looks like it fails due to NoHttpResponseException, but it's not clear why that would happen.\nFrom the request it's executing, it looks like the test is in TestDistributedSearch:95\nand has already successfully made other distributed queries (hence all of the embedded jetty servers have returned responses before). "
        },
        {
            "author": "Yonik Seeley",
            "id": "comment-12966718",
            "date": "2010-12-03T23:00:12+0000",
            "content": "Moving Robert's stack trace from the description to the comments.\n\n\n    [junit] Testsuite: org.apache.solr.TestDistributedSearch\n    [junit] Testcase: testDistribSearch(org.apache.solr.TestDistributedSearch):\tFAILED\n    [junit] Some threads threw uncaught exceptions!\n    [junit] junit.framework.AssertionFailedError: Some threads threw uncaught exceptions!\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:795)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:768)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase.tearDown(LuceneTestCase.java:416)\n    [junit] \tat org.apache.solr.SolrTestCaseJ4.tearDown(SolrTestCaseJ4.java:76)\n    [junit] \tat org.apache.solr.BaseDistributedSearchTestCase.tearDown(BaseDistributedSearchTestCase.java:144)\n    [junit] \n    [junit] \n    [junit] Tests run: 1, Failures: 1, Errors: 0, Time elapsed: 382.297 sec\n    [junit] \n    [junit] ------------- Standard Error -----------------\n    [junit] 2010. 10. 15 ?? 2:08:04 org.apache.solr.common.SolrException log\n    [junit] ??: org.apache.solr.common.SolrException: org.apache.solr.client.solrj.SolrServerException: No live SolrServers available to handle this request\n    [junit] \tat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:318)\n    [junit] \tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:131)\n    [junit] \tat org.apache.solr.core.SolrCore.execute(SolrCore.java:1325)\n    [junit] \tat org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:337)\n    [junit] \tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:240)\n    [junit] \tat org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1157)\n    [junit] \tat org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:388)\n    [junit] \tat org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182)\n    [junit] \tat org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:765)\n    [junit] \tat org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)\n    [junit] \tat org.mortbay.jetty.Server.handle(Server.java:326)\n    [junit] \tat org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542)\n    [junit] \tat org.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:923)\n    [junit] \tat org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:547)\n    [junit] \tat org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:212)\n    [junit] \tat org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404)\n    [junit] \tat org.mortbay.io.nio.SelectChannelEndPoint.run(SelectChannelEndPoint.java:409)\n    [junit] \tat org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)\n    [junit] Caused by: org.apache.solr.client.solrj.SolrServerException: No live SolrServers available to handle this request\n    [junit] \tat org.apache.solr.client.solrj.impl.LBHttpSolrServer.request(LBHttpSolrServer.java:297)\n    [junit] \tat org.apache.solr.handler.component.HttpCommComponent$1.call(SearchHandler.java:513)\n    [junit] \tat org.apache.solr.handler.component.HttpCommComponent$1.call(SearchHandler.java:478)\n    [junit] \tat java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)\n    [junit] \tat java.util.concurrent.FutureTask.run(FutureTask.java:166)\n    [junit] \tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)\n    [junit] \tat java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)\n    [junit] \tat java.util.concurrent.FutureTask.run(FutureTask.java:166)\n    [junit] \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\n    [junit] \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\n    [junit] \tat java.lang.Thread.run(Thread.java:636)\n    [junit] Caused by: org.apache.solr.client.solrj.SolrServerException: java.net.ConnectException: Operation timed out\n    [junit] \tat org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:483)\n    [junit] \tat org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:244)\n    [junit] \tat org.apache.solr.client.solrj.impl.LBHttpSolrServer.request(LBHttpSolrServer.java:274)\n    [junit] \t... 10 more\n    [junit] Caused by: java.net.ConnectException: Operation timed out\n    [junit] \tat java.net.PlainSocketImpl.socketConnect(Native Method)\n    [junit] \tat java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:310)\n    [junit] \tat java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:176)\n    [junit] \tat java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:163)\n    [junit] \tat java.net.SocksSocketImpl.connect(SocksSocketImpl.java:384)\n    [junit] \tat java.net.Socket.connect(Socket.java:546)\n    [junit] \tat java.net.Socket.connect(Socket.java:495)\n    [junit] \tat java.net.Socket.<init>(Socket.java:392)\n    [junit] \tat java.net.Socket.<init>(Socket.java:266)\n    [junit] \tat org.apache.commons.httpclient.protocol.DefaultProtocolSocketFactory.createSocket(DefaultProtocolSocketFactory.java:80)\n    [junit] \tat org.apache.commons.httpclient.protocol.DefaultProtocolSocketFactory.createSocket(DefaultProtocolSocketFactory.java:122)\n    [junit] \tat org.apache.commons.httpclient.HttpConnection.open(HttpConnection.java:707)\n    [junit] \tat org.apache.commons.httpclient.MultiThreadedHttpConnectionManager$HttpConnectionAdapter.open(MultiThreadedHttpConnectionManager.java:1361)\n    [junit] \tat org.apache.commons.httpclient.HttpMethodDirector.executeWithRetry(HttpMethodDirector.java:387)\n    [junit] \tat org.apache.commons.httpclient.HttpMethodDirector.executeMethod(HttpMethodDirector.java:171)\n    [junit] \tat org.apache.commons.httpclient.HttpClient.executeMethod(HttpClient.java:397)\n    [junit] \tat org.apache.commons.httpclient.HttpClient.executeMethod(HttpClient.java:323)\n    [junit] \tat org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:427)\n    [junit] \t... 12 more\n    [junit] \n    [junit] The following exceptions were thrown by threads:\n    [junit] *** Thread: Thread-85 ***\n    [junit] java.lang.RuntimeException: org.apache.solr.client.solrj.SolrServerException: Error executing query\n    [junit] \tat org.apache.solr.BaseDistributedSearchTestCase$5.run(BaseDistributedSearchTestCase.java:324)\n    [junit] Caused by: org.apache.solr.client.solrj.SolrServerException: Error executing query\n    [junit] \tat org.apache.solr.client.solrj.request.QueryRequest.process(QueryRequest.java:95)\n    [junit] \tat org.apache.solr.client.solrj.SolrServer.query(SolrServer.java:119)\n    [junit] \tat org.apache.solr.BaseDistributedSearchTestCase$5.run(BaseDistributedSearchTestCase.java:319)\n    [junit] Caused by: org.apache.solr.common.SolrException: org.apache.solr.client.solrj.SolrServerException\n: No live SolrServers available to handle this request  org.apache.solr.common.SolrException: \norg.apache.solr.client.solrj.SolrServerException: No live SolrServers available to handle this request \tat \norg.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:318) \tat \norg.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:131) \tat \norg.apache.solr.core.SolrCore.execute(SolrCore.java:1325) \tat \norg.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:337) \tat \norg.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:240) \tat \norg.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1157) \tat \norg.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:388) \tat \norg.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182) \tat \norg.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:765) \tat \norg.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152) \tat \norg.mortbay.jetty.Server.handle(Server.java:326) \tat \norg.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542) \tat \norg.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:923) \tat \norg.mortbay.jetty.HttpParser.parseNext(HttpParser.java:547) \tat \norg.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:212) \tat \norg.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404) \tat \norg.mortbay.io.nio.SelectChannelEndPoint.run(SelectChannelEndPoint.java:409) \tat \norg.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582) Caused by: \norg.apache.solr.client.solrj.SolrServerException: No live SolrServers available to handle this request \tat \norg.apache.solr.client.solrj.impl.LBHttpSolrServer.request(LBHttpSolrServer.java:297) \tat \norg.apache.solr.handler.component.HttpCommComponent$1.call(SearchHandler.java:513) \tat \norg.apache.solr.handler.component.HttpCommComponent$1.call(SearchHandler.java:478) \tat java.util.concurrent\n\n    [junit] \n\n    [junit] org.apache.solr.client.solrj.SolrServerException: No live SolrServers available to handle this request  \norg.apache.solr.common.SolrException: org.apache.solr.client.solrj.SolrServerException: No live SolrServers \navailable to handle this request \tat \norg.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:318) \tat \norg.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:131) \tat \norg.apache.solr.core.SolrCore.execute(SolrCore.java:1325) \tat \norg.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:337) \tat \norg.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:240) \tat \norg.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1157) \tat \norg.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:388) \tat \norg.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182) \tat \norg.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:765) \tat \norg.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152) \tat \norg.mortbay.jetty.Server.handle(Server.java:326) \tat \norg.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542) \tat \norg.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:923) \tat \norg.mortbay.jetty.HttpParser.parseNext(HttpParser.java:547) \tat \norg.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:212) \tat \norg.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404) \tat \norg.mortbay.io.nio.SelectChannelEndPoint.run(SelectChannelEndPoint.java:409) \tat \norg.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582) Caused by: \norg.apache.solr.client.solrj.SolrServerException: No live SolrServers available to handle this request \tat \norg.apache.solr.client.solrj.impl.LBHttpSolrServer.request(LBHttpSolrServer.java:297) \tat \norg.apache.solr.handler.component.HttpCommComponent$1.call(SearchHandler.java:513) \tat \norg.apache.solr.handler.component.HttpCommComponent$1.call(SearchHandler.java:478) \tat java.util.concurrent\n\n    [junit] \n\n    [junit] request: http://localhost:33955/solr/select?q={!func}a_si&shards=localhost:33955/solr|localhost:33332/solr&wt=javabin&version=2\n    [junit] \tat org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:435)\n    [junit] \tat org.apache.solr.client.solrj.impl.CommonsHttpSolrServer.request(CommonsHttpSolrServer.java:244)\n    [junit] \tat org.apache.solr.client.solrj.request.QueryRequest.process(QueryRequest.java:89)\n    [junit] \t... 2 more\n    [junit] ------------- ---------------- ---------------\n    [junit] TEST org.apache.solr.TestDistributedSearch FAILED\n\n "
        },
        {
            "author": "Yonik Seeley",
            "id": "comment-12966971",
            "date": "2010-12-05T15:34:16+0000",
            "content": "OK, so we upgraded jetty... but the \"failed to respond\" exception still happens.\nJust to try and narrow things down, I put a long sleep inside solr request handling and then tried a distributed search... it worked fine. So\nit doesn't appear to be something getting hung up in Solr.\n\n\n\ta jetty bug\n\tan embedded jetty bug\n\ta HttpClient bug\n\ta bug in the way solr uses HttpClient\n\n\n\nAnother data point: with my load testing tool, I can run millions of requests against Jetty/Solr (and I just did again). It doesn't use HttpClient though, and it uses GET instead of POST.\n\nSome things to try:\n\n\tModify the load tool to use POST and verify things still work\n\tPut a long pause in TestDistributedSearch after the solr servers are brought up, and then try load testing against those servers w/ an external tool.\n\tif this fails, we know it's an issue with how we embed Jetty\n\tMake a load testing tool that uses SolrJ exactly the way that distributed search uses it, and try it on a normal Solr server\n\tif this fails, ti could be an HttpClient bug, or a jetty bug tickled by HttpClient specifically\n\tif this fails, make a small self-contained load tool that uses only HttpClient to remove the possibility of SolrJ bugs\n\n "
        },
        {
            "author": "Yonik Seeley",
            "id": "comment-12969548",
            "date": "2010-12-08T23:12:54+0000",
            "content": "Put a long pause in TestDistributedSearch after the solr servers are brought up, and then try load testing against those servers w/ an external tool.\n\nOK, I tried this.\nI was unable to get a failure with normal searches from my external tool hitting all of the embedded searchers in parallel.\nI was able to get one failure when I switched to making distributed requests (i.e. the solr servers would themselves them make requests to other servers).\nI tried duplicating this with normal solr servers (i.e. from the \"example\" directory) but was unable to reproduce an error. I also tried switching the jetty connnectors to use NIO, but was still unable to reproduce an error.\n\nAnyway, I've switched trunk's jetty connector to a straight non-NIO connector for tests (the same as what a solr is configured for by default). We'll see if it makes any difference or not. "
        },
        {
            "author": "Yonik Seeley",
            "id": "comment-12970830",
            "date": "2010-12-13T14:55:16+0000",
            "content": "TestDistributedSearch hasn't failed since... looks like it had something to do with the jetty connector (in embedded mode, or when there were multiple in a JVM, or in conjunction w/ httpclient...) "
        },
        {
            "author": "Robert Muir",
            "id": "comment-12970839",
            "date": "2010-12-13T15:10:22+0000",
            "content": "I agree, no fails for 75 builds each of trunk and 3x... thanks for tracking this one down! "
        },
        {
            "author": "Simon Willnauer",
            "id": "comment-12970849",
            "date": "2010-12-13T15:28:18+0000",
            "content": "I agree, no fails for 75 builds each of trunk and 3x... thanks for tracking this one down!\n+1 thanks yonik "
        },
        {
            "author": "Grant Ingersoll",
            "id": "comment-13013267",
            "date": "2011-03-30T15:46:02+0000",
            "content": "Bulk close for 3.1.0 release "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13143506",
            "date": "2011-11-03T20:22:27+0000",
            "content": "I've seen this more than once:\n\n  [junit] Testsuite: org.apache.solr.TestDistributedSearch\n    [junit] Testcase: testDistribSearch(org.apache.solr.TestDistributedSearch):\tFAILED\n    [junit] .response.numFound:58!=67\n    [junit] junit.framework.AssertionFailedError: .response.numFound:58!=67\n    [junit] \tat org.apache.solr.BaseDistributedSearchTestCase.compareResponses(BaseDistributedSearchTestCase.java:584)\n    [junit] \tat org.apache.solr.BaseDistributedSearchTestCase.query(BaseDistributedSearchTestCase.java:337)\n    [junit] \tat org.apache.solr.TestDistributedSearch.doTest(TestDistributedSearch.java:109)\n    [junit] \tat org.apache.solr.BaseDistributedSearchTestCase.testDistribSearch(BaseDistributedSearchTestCase.java:599)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase$2$1.evaluate(LuceneTestCase.java:615)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:149)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:51)\n    [junit] Testcase: testDistribSearch(org.apache.solr.TestDistributedSearch):\tCaused an ERROR\n    [junit] java.lang.AssertionError: Some threads threw uncaught exceptions!\n    [junit] java.lang.RuntimeException: java.lang.AssertionError: Some threads threw uncaught exceptions!\n    [junit] \tat org.apache.lucene.util.LuceneTestCase.tearDown(LuceneTestCase.java:744)\n    [junit] \tat org.apache.solr.SolrTestCaseJ4.tearDown(SolrTestCaseJ4.java:86)\n    [junit] \tat org.apache.solr.BaseDistributedSearchTestCase.tearDown(BaseDistributedSearchTestCase.java:173)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:149)\n    [junit] \tat org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:51)\n    [junit] Caused by: java.lang.AssertionError: Some threads threw uncaught exceptions!\n    [junit] \tat org.apache.lucene.util.LuceneTestCase.checkUncaughtExceptionsAfter(LuceneTestCase.java:772)\n    [junit] \tat org.apache.lucene.util.LuceneTestCase.tearDown(LuceneTestCase.java:716)\n    [junit] Tests run: 1, Failures: 1, Errors: 1, Time elapsed: 157.228 sec\n    [junit] ------------- Standard Error -----------------\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestDistributedSearch -Dtestmethod=testDistribSearch -Dtests.seed=-51a71405e31cb62:-11d5dbadc4630d55:-701e7bb491d0926f\n    [junit] The following exceptions were thrown by threads:\n    [junit] *** Thread: Thread-418 ***\n    [junit] junit.framework.AssertionFailedError: .response.numFound:59!=67\n    [junit] \tat junit.framework.Assert.fail(Assert.java:47)\n    [junit] \tat org.apache.solr.BaseDistributedSearchTestCase.compareResponses(BaseDistributedSearchTestCase.java:584)\n    [junit] \tat org.apache.solr.BaseDistributedSearchTestCase$5.run(BaseDistributedSearchTestCase.java:352)\n    [junit] NOTE: reproduce with: ant test -Dtestcase=TestDistributedSearch -Dtestmethod=testDistribSearch -Dtests.seed=-51a71405e31cb62:-11d5dbadc4630d55:-701e7bb491d0926f\n\n "
        },
        {
            "author": "Yonik Seeley",
            "id": "comment-13143521",
            "date": "2011-11-03T20:54:19+0000",
            "content": "There must be another exceptions somewhere when this happens? "
        }
    ]
}