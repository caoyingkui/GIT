{
    "id": "SOLR-6608",
    "title": "Atomic update with CloudSolrServer gives 'missing required field:'",
    "details": {
        "components": [
            "SolrCloud",
            "update"
        ],
        "type": "Bug",
        "labels": "",
        "fix_versions": [],
        "affect_versions": "None",
        "status": "Resolved",
        "resolution": "Invalid",
        "priority": "Major"
    },
    "description": "Dear support,\n\nMy version of Solr is 4.8.0. I am trying to update a single field of a document which is already present inside my collection. This is the part of code involved:\n\nCloudSolrServer server = new CloudSolrServer(args[0]);\nserver.setDefaultCollection(args[1]);\n[...]\nSolrInputDocument updateSolrDoc = new SolrInputDocument();\nString id = [...]\nupdateSolrDoc.addField(\"id\", id);\nList<String> phoneNumbers = [...]\nupdateSolrDoc.setField(\"phoneNumbers\", Collections.singletonMap(\"set\", phoneNumbers));\n[...]\nbuffer.add(updateSolrDoc);\n[...]\nserver.add(buffer);\nserver.commit();\n\nWhen I try to run it, I receive the following exception:\n\n2014-10-08 15:57:40.587 - ERROR org.apache.solr.common.SolrException  org.apache.solr.common.SolrException: [doc=1021938980] missing required field: cityId\n        at org.apache.solr.update.DocumentBuilder.toDocument(DocumentBuilder.java:189)\n        at org.apache.solr.update.AddUpdateCommand.getLuceneDocument(AddUpdateCommand.java:77)\n        at org.apache.solr.update.DirectUpdateHandler2.addDoc0(DirectUpdateHandler2.java:234)\n        at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:160)\n        at org.apache.solr.update.processor.RunUpdateProcessor.processAdd(RunUpdateProcessorFactory.java:69)\n        at org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:51)\n        at org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalAdd(DistributedUpdateProcessor.java:704)\n        at org.apache.solr.update.processor.DistributedUpdateProcessor.versionAdd(DistributedUpdateProcessor.java:858)\n        at org.apache.solr.update.processor.DistributedUpdateProcessor.processAdd(DistributedUpdateProcessor.java:557)\n        at org.apache.solr.handler.loader.JavabinLoader$1.update(JavabinLoader.java:96)\n        at org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec$1.readOuterMostDocIterator(JavaBinUpdateRequestCodec.java:166)\n        at org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec$1.readIterator(JavaBinUpdateRequestCodec.java:136)\n        at org.apache.solr.common.util.JavaBinCodec.readVal(JavaBinCodec.java:225)\n        at org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec$1.readNamedList(JavaBinUpdateRequestCodec.java:121)\n        at org.apache.solr.common.util.JavaBinCodec.readVal(JavaBinCodec.java:190)\n        at org.apache.solr.common.util.JavaBinCodec.unmarshal(JavaBinCodec.java:116)\n        at org.apache.solr.client.solrj.request.JavaBinUpdateRequestCodec.unmarshal(JavaBinUpdateRequestCodec.java:173)\n        at org.apache.solr.handler.loader.JavabinLoader.parseAndLoadDocs(JavabinLoader.java:106)\n        at org.apache.solr.handler.loader.JavabinLoader.load(JavabinLoader.java:58)\n        at org.apache.solr.handler.UpdateRequestHandler$1.load(UpdateRequestHandler.java:92)\n        at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:74)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1952)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:774)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:418)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:207)\n        at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:103)\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:293)\n        at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:861)\n        at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:606)\n        at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489)\n        at java.lang.Thread.run(Thread.java:744)\n\n\nThis, instead, is the part of the schema.xml involved:\n\n   <field name=\"id\" type=\"string\" indexed=\"true\" stored=\"true\" required=\"true\" />\n[...]\n   <field name=\"cityId\" type=\"string\" indexed=\"true\" stored=\"true\" required=\"true\" />\n[...]\n   <field name=\"phoneNumbers\" type=\"string\" indexed=\"true\" stored=\"true\" required=\"false\" multiValued=\"true\" sortMissingLast=\"true\" />\n[...]\n<uniqueKey>id</uniqueKey>\n\nI have also another collection with a similar schema and I am using a similar code to perform atomic updates without issues, i.e. I don't need to specify all the fields marked as 'required' in order to update a single field. Unfortunately with this second collection I get this weird issue.\n\nHow can I successfully update a single field without having to pass all the fields marked as 'required'? Can you please tell me if there is something wrong in the code that I am using?\n\nThank you very much for your support.\n\nKind Regards",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2014-10-09T23:06:15+0000",
            "author": "Hoss Man",
            "content": "please post questions to the solr-user@lucene mailing list for discussion & advice before opening a bug (the user list gets a lot more eyeballs and has a lot more people available to provide help ... we try to only open bugs once we've confirmed something is definitely not functioning as designed/documented)\n\nmy best guess is that you modified your schema to make \"cityId\" a required field after indexing some documents \u2013 so you have docs in your index which do not have a value for that field, and attempting to modify those documents now gives you an error because it can not do so in a way that will satisfied the required=\"true\" condition\n\nimpossible to know for sure since you didn't show us what the document you are trying to update currently looks like when you execute a query.\n\nAs noted: please start a thread on the mailing list with more details like this to get advice/help. ",
            "id": "comment-14165950"
        },
        {
            "date": "2014-10-10T13:58:47+0000",
            "author": "Guido",
            "content": "Dear Hoss Man,\n\nThank you very much for you response. I will surely open a thread on the mailing list.\n\nAbout this issue, I never modified the schema after that I have started to index my documents and the document on which I am experiencing issues has all the required fields properly filled, considering also the \"cityId\".\n\nAnyway, thank you for your help and support. As said, I will open a thread on the mailing list as specified.\n\nBest Regards,\n\nGuido ",
            "id": "comment-14166883"
        }
    ]
}