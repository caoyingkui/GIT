{
    "id": "LUCENE-7728",
    "title": "TestGrouping.testRandom() failures",
    "details": {
        "labels": "",
        "priority": "Major",
        "resolution": "Fixed",
        "affect_versions": "None",
        "status": "Closed",
        "type": "Bug",
        "components": [],
        "fix_versions": [
            "7.3"
        ]
    },
    "description": "My Jenkins found a reproducing branch_6x seed:\n\n\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestGrouping -Dtests.method=testRandom -Dtests.seed=6F0B519BBDC786B3 -Dtests.slow=true -Dtests.locale=en-CA -Dtests.timezone=Europe/Zagreb -Dtests.asserts=true -Dtests.file.encoding=US-ASCII\n   [junit4] FAILURE 2.50s J0 | TestGrouping.testRandom <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError: expected:<10> but was:<29>\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([6F0B519BBDC786B3:1D4774940CA730C0]:0)\n   [junit4]    > \tat org.apache.lucene.search.grouping.TestGrouping.assertEquals(TestGrouping.java:1288)\n   [junit4]    > \tat org.apache.lucene.search.grouping.TestGrouping.testRandom(TestGrouping.java:1130)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:745)\n   [junit4]   2> NOTE: test params are: codec=Asserting(Lucene62): {groupend=Lucene50(blocksize=128), sort1=PostingsFormat(name=Memory doPackFST= true), sort2=Lucene50(blocksize=128), content=PostingsFormat(name=Memory doPackFST= false), group=PostingsFormat(name=Memory doPackFST= true)}, docValues:{groupend=DocValuesFormat(name=Direct), author=DocValuesFormat(name=Memory), sort1=DocValuesFormat(name=Memory), id=DocValuesFormat(name=Memory), sort2=DocValuesFormat(name=Direct), content=DocValuesFormat(name=Lucene54), group=DocValuesFormat(name=Memory)}, maxPointsInLeafNode=454, maxMBSortInHeap=6.048552291438714, sim=RandomSimilarity(queryNorm=false,coord=no): {content=DFI(Saturated)}, locale=en-CA, timezone=Europe/Zagreb\n   [junit4]   2> NOTE: Linux 4.1.0-custom2-amd64 amd64/Oracle Corporation 1.8.0_77 (64-bit)/cpus=16,threads=1,free=485264792,total=514850816\n\n\n\ngit bisect says the first bad commit is this one: http://git-wip-us.apache.org/repos/asf/lucene-solr/commit/6d952076, but that just removed BooleanSimilarity from the RandomSimilarity's candidates list, which in this case likely has the side effect of picking a different similarity with this seed.  So the problem is almost certainly older than this.\n\nPoliceman Jenkins reported a master seed four weeks ago https://jenkins.thetaphi.de/job/Lucene-Solr-master-Linux/18890/ for a failure that's still reproducing for me on Linux w/ Java8:\n\n\n  [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestGrouping -Dtests.method=testRandom -Dtests.seed=381A6A2BB3B21736 -Dtests.multiplier=3 -Dtests.slow=true -Dtests.locale=nyn -Dtests.timezone=Antarctica/McMurdo -Dtests.asserts=true -Dtests.file.encoding=US-ASCII\n  [junit4] FAILURE 8.72s J0 | TestGrouping.testRandom <<<\n  [junit4]    > Throwable #1: java.lang.AssertionError: expected:<2526> but was:<1818>\n  [junit4]    > \tat __randomizedtesting.SeedInfo.seed([381A6A2BB3B21736:4A564F2402D2A145]:0)\n  [junit4]    > \tat org.apache.lucene.search.grouping.TestGrouping.assertEquals(TestGrouping.java:1299)\n  [junit4]    > \tat org.apache.lucene.search.grouping.TestGrouping.testRandom(TestGrouping.java:1141)\n  [junit4]    > \tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n  [junit4]    > \tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n  [junit4]    > \tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n  [junit4]    > \tat java.base/java.lang.reflect.Method.invoke(Method.java:543)\n  [junit4]    > \tat java.base/java.lang.Thread.run(Thread.java:844)\n  [junit4]   2> NOTE: test params are: codec=Asserting(Lucene70): {groupend=PostingsFormat(name=Direct), sort1=PostingsFormat(name=LuceneVarGapFixedInterval), sort2=PostingsFormat(name=Direct), content=PostingsFormat(name=LuceneVarGapDocFreqInterval), group=PostingsFormat(name=LuceneVarGapFixedInterval)}, docValues:{groupend=DocValuesFormat(name=Lucene70), author=DocValuesFormat(name=Memory), sort1=DocValuesFormat(name=Memory), id=DocValuesFormat(name=Memory), sort2=DocValuesFormat(name=Lucene70), content=DocValuesFormat(name=Direct), group=DocValuesFormat(name=Memory)}, maxPointsInLeafNode=1292, maxMBSortInHeap=6.668104559353747, sim=RandomSimilarity(queryNorm=true): {content=DFI(Standardized)}, locale=nyn, timezone=Antarctica/McMurdo\n  [junit4]   2> NOTE: Linux 4.4.0-53-generic i386/Oracle Corporation 9-ea (32-bit)/cpus=12,threads=1,free=23290544,total=79691776\n\n\n\ngit bisect points to the exact same first bad commit for this seed too (see above).",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "id": "comment-15896521",
            "date": "2017-03-05T19:54:13+0000",
            "content": "Another reproducing branch_6x failure from Policeman Jenkins https://jenkins.thetaphi.de/job/Lucene-Solr-6.x-MacOSX/737/:\n\n\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestGrouping -Dtests.method=testRandom -Dtests.seed=7D05E3F750606D -Dtests.slow=true -Dtests.locale=ar-EG -Dtests.timezone=America/Asuncion -Dtests.asserts=true -Dtests.file.encoding=US-ASCII\n   [junit4] FAILURE 3.08s J0 | TestGrouping.testRandom <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError: expected:<394> but was:<235>\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([7D05E3F750606D:723120EC4630D61E]:0)\n   [junit4]    > \tat org.apache.lucene.search.grouping.TestGrouping.assertEquals(TestGrouping.java:1288)\n   [junit4]    > \tat org.apache.lucene.search.grouping.TestGrouping.testRandom(TestGrouping.java:1130)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:745)\n   [junit4]   2> NOTE: test params are: codec=FastCompressingStoredFields(storedFieldsFormat=CompressingStoredFieldsFormat(compressionMode=FAST, chunkSize=11351, maxDocsPerChunk=2, blockSize=208), termVectorsFormat=CompressingTermVectorsFormat(compressionMode=FAST, chunkSize=11351, blockSize=208)), sim=RandomSimilarity(queryNorm=true,coord=yes): {content=DFI(Saturated)}, locale=ar-EG, timezone=America/Asuncion\n   [junit4]   2> NOTE: Mac OS X 10.11.6 x86_64/Oracle Corporation 1.8.0_121 (64-bit)/cpus=3,threads=1,free=37784112,total=54788096\n\n ",
            "author": "Steve Rowe"
        },
        {
            "id": "comment-15957297",
            "date": "2017-04-05T17:36:48+0000",
            "content": "Another reprodcing master failure: https://elasticsearch-ci.elastic.co/job/apache+lucene-solr+master/9262/console\n\n\n   [junit4] Suite: org.apache.lucene.search.grouping.TestGrouping\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestGrouping -Dtests.method=testRandom -Dtests.seed=42883A34582024BB -Dtests.slow=true -Dtests.locale=sr-Latn-BA -Dtests.timezone=America/Miquelon -Dtests.asserts=true -Dtests.file.encoding=ISO-8859-1\n   [junit4] FAILURE 6.98s J0 | TestGrouping.testRandom <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError: expected:<477> but was:<468>\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([42883A34582024BB:30C41F3BE94092C8]:0)\n   [junit4]    > \tat org.apache.lucene.search.grouping.TestGrouping.assertEquals(TestGrouping.java:1299)\n   [junit4]    > \tat org.apache.lucene.search.grouping.TestGrouping.testRandom(TestGrouping.java:1141)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:745)\n   [junit4]   2> NOTE: test params are: codec=Asserting(Lucene70): {groupend=FST50, sort1=BlockTreeOrds(blocksize=128), sort2=FST50, content=PostingsFormat(name=Direct), group=BlockTreeOrds(blocksize=128)}, docValues:{author=DocValuesFormat(name=Lucene70), sort1=DocValuesFormat(name=Lucene70), id=DocValuesFormat(name=Lucene70), sort2=DocValuesFormat(name=Direct), group=DocValuesFormat(name=Lucene70)}, maxPointsInLeafNode=1782, maxMBSortInHeap=5.88541198629704, sim=RandomSimilarity(queryNorm=true): {content=DFI(Standardized)}, locale=sr-Latn-BA, timezone=America/Miquelon\n   [junit4]   2> NOTE: Linux 4.4.35-33.55.amzn1.x86_64 amd64/Oracle Corporation 1.8.0_121 (64-bit)/cpus=4,threads=1,free=320921624,total=331350016\n   [junit4]   2> NOTE: All tests run in this JVM: [TestGrouping]\n\n ",
            "author": "Adrien Grand"
        },
        {
            "id": "comment-16077409",
            "date": "2017-07-07T00:32:01+0000",
            "content": "Another reproducing master failure from my Jenkins (not sure of commit sha, since job history has expired, but the email notification arrived on July 1st):\n\n\n  [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestGrouping -Dtests.method=testRandom -Dtests.seed=E6967AF0433A23C7 -Dtests.slow=true -Dtests.locale=en-ZA -Dtests.timezone=America/Argentina/La_Rioja -Dtests.asserts=true -Dtests.file.encoding=US-ASCII\n  [junit4] FAILURE 5.85s J0 | TestGrouping.testRandom <<<\n  [junit4]    > Throwable #1: arrays first differed at element [0]; expected:<0.0> but was:<9.4267284E-4>\n  [junit4]    > \tat __randomizedtesting.SeedInfo.seed([E6967AF0433A23C7:94DA5FFFF25A95B4]:0)\n  [junit4]    > \tat org.apache.lucene.search.grouping.TestGrouping.assertEquals(TestGrouping.java:1290)\n  [junit4]    > \tat org.apache.lucene.search.grouping.TestGrouping.testRandom(TestGrouping.java:1124)\n  [junit4]    > \tat java.lang.Thread.run(Thread.java:745)\n  [junit4]   2> NOTE: test params are: codec=Asserting(Lucene70): {groupend=PostingsFormat(name=LuceneFixedGap), sort1=FST50, sort2=PostingsFormat(name=LuceneFixedGap), content=Lucene50(blocksize=128), group=FST50}, docValues:{author=DocValuesFormat(name=Direct), sort1=DocValuesFormat(name=Direct), id=DocValuesFormat(name=Direct), sort2=DocValuesFormat(name=Memory), group=DocValuesFormat(name=Direct)}, maxPointsInLeafNode=613, maxMBSortInHeap=6.679295579171384, sim=RandomSimilarity(queryNorm=false): {content=DFI(Saturated)}, locale=en-ZA, timezone=America/Argentina/La_Rioja\n  [junit4]   2> NOTE: Linux 4.1.0-custom2-amd64 amd64/Oracle Corporation 1.8.0_77 (64-bit)/cpus=16,threads=1,free=381684000,total=514850816\n\n ",
            "author": "Steve Rowe"
        },
        {
            "id": "comment-16339624",
            "date": "2018-01-25T18:40:54+0000",
            "content": "Another reproducing master failure from https://jenkins.thetaphi.de/job/Lucene-Solr-master-Solaris/1646/:\n\n\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestGrouping -Dtests.method=testRandom -Dtests.seed=622967980126CBB3 -Dtests.slow=true -Dtests.locale=vi -Dtests.timezone=Pacific/Palau -Dtests.asserts=true -Dtests.file.encoding=UTF-8\n   [junit4] FAILURE 1.87s J0 | TestGrouping.testRandom <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError: expected:<9> but was:<13>\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([622967980126CBB3:10654297B0467DC0]:0)\n   [junit4]    > \tat org.apache.lucene.search.grouping.TestGrouping.assertEquals(TestGrouping.java:1286)\n   [junit4]    > \tat org.apache.lucene.search.grouping.TestGrouping.testRandom(TestGrouping.java:1128)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:748)\n   [junit4]   2> NOTE: test params are: codec=Asserting(Lucene70): {groupend=PostingsFormat(name=Memory), sort1=PostingsFormat(name=LuceneVarGapFixedInterval), sort2=PostingsFormat(name=Memory), content=PostingsFormat(name=Memory), group=PostingsFormat(name=LuceneVarGapFixedInterval)}, docValues:{author=DocValuesFormat(name=Memory), sort1=DocValuesFormat(name=Memory), id=DocValuesFormat(name=Memory), sort2=DocValuesFormat(name=Lucene70), group=DocValuesFormat(name=Memory)}, maxPointsInLeafNode=1338, maxMBSortInHeap=7.121235768654987, sim=Asserting(org.apache.lucene.search.similarities.AssertingSimilarity@1c4c429b), locale=vi, timezone=Pacific/Palau\n   [junit4]   2> NOTE: SunOS 5.11 amd64/Oracle Corporation 1.8.0_152 (64-bit)/cpus=3,threads=1,free=68613264,total=123731968\n\n ",
            "author": "Steve Rowe"
        },
        {
            "id": "comment-16400259",
            "date": "2018-03-15T11:24:08+0000",
            "content": "I think I tracked down the last of these with commit\u00a0446d38474eedb270d5143a7ac11bc54376b93e36 ",
            "author": "Alan Woodward"
        }
    ]
}