{
    "id": "SOLR-6251",
    "title": "incorrect 'missing required field' during update - document definitely has it",
    "details": {
        "affect_versions": "4.8",
        "status": "Resolved",
        "fix_versions": [],
        "components": [
            "SolrCloud"
        ],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Not A Problem"
    },
    "description": "Document added on solr1. We can see the distribute take place from solr1 to solr2 and returning a success. Subsequent searches returning document, clearly showing the field as being there. Later on, an update is done to add to an element of the document - and the update fails. The update was sent to solr2 instance. \n\nSchema marks the 'timestamp' field as required, so the initial insert should not work if the field isn't present.\n\nSymptom is intermittent - we're seeing this randomly, with no warning or triggering that we can see, but in all cases, it's getting the error in response to an update when the instance tries to distribute the change to the other node. \n\nSearches that were run AFTER the update also show the field as being present in the document. \n\nWill add full trace of operations in the comments shortly. pcap captures of ALL traffic for the two nodes on 8983 is available if requested.",
    "attachments": {
        "schema.xml": "https://issues.apache.org/jira/secure/attachment/12655935/schema.xml"
    },
    "issue_links": {},
    "comments": [
        {
            "author": "Nathan Neulinger",
            "id": "comment-14062793",
            "date": "2014-07-15T22:48:03+0000",
            "content": "\n16.24 = POD SRV\n16.204 = SOLR 1\n16.207 = SOLR 2\n\n16.24 \u21d2 16.204 \nCAP 1\n11344 14:29:49.299883\n\nPOST /solr/d-_v22/update/json?commit=true HTTP/1.1\nhost: d01-solr.srv.hivepoint.com\nAccept-Encoding: gzip,deflate\nContent-Type: application/json; charset=UTF-8\nrequest_id: null 8677c2fb-8b92-4220-bb73-1e4c610d95be 2057\nUser-Agent: HivePoint (Factory JSON client:null:2056)\nX-Forwarded-For: 10.220.16.229\nX-Forwarded-Port: 80\nX-Forwarded-Proto: http\nContent-Length: 1555\nConnection: keep-alive\n\n{ \"add\": { \"commitWithin\" : 5000, \"doc\" : {\"hive\":\"vdates\",\"at\":\"2014-07-10T21:28:41Z\",\"timestamp\":1405027721000,\"type\":\"MESSAGE\",\"channel\":[\"dev\"],\"from\":\"preet@sevogle.com\",\"to\":[\"adam@sevogle.com\",\"vidya@sevogle.com\",\"dev@sevogle.com\",\"sqa@hive.sevogle.com\"],\"subject\":\"Re: Deployments - B and then C\",\"body\":\"eve.....SNIP.......stem. \",\"id\":\"4b2c4d09-31e2-4fe2-b767-3868efbdcda1\",\"message_id\":\"2014-07-10-77a6614c-66e4-4ddb-8566-dff4bfb743d1\"} } }\n\n\n16.204 \u21d2 16.207\nCAP 1\n\n\nPOST /solr/d-_v22_shard1_replica2/update?update.distrib=TOLEADER&distrib.from=http%3A%2F%2F10.220.16.204%3A8983%2Fsolr%2Fd-_v22_shard1_replica1%2F&wt=javabin&version=2 HTTP/1.1\nUser-Agent: Solr[org.apache.solr.client.solrj.impl.HttpSolrServer] 1.0\nContent-Type: application/javabin\nTransfer-Encoding: chunked\nHost: 10.220.16.207:8983\nConnection: Keep-Alive\n\n64c\n...&params...update.distrib(TOLEADER.,distrib.from?.http://10.220.16.204:8983/solr/d-_v22_shard1_replica1/.&delByQ..'docsMap.....?....$hive&vdates.\"at42014-07-10T21:28:41Z.)timestampx.......$type'MESSAGE.'channel.#dev.$from1preet@sevogle.com.\"to.0adam@sevogle.com1vidya@sevogle.com/dev@sevogle.com4sqa@hive.sevogle.com.'subject>Re: Deployments - B and then C.$body?#eve.....SNIP.......tem. .\"id?.4b2c4d09-31e2-4fe2-b767-3868efbdcda1.*message_id?.2014-07-10-77a6614c-66e4-4ddb-8566-dff4bfb743d1\n..\"ow..\"cwX...\n0\n\n\n\n16.207 \u21d2 16.204 \nCAP 1\n11368 14:29:49.495301\nHTTP/1.1 200 OK\nContent-Type: application/octet-stream\nContent-Length: 40\n\n....responseHeader..&status......%QTimeK\n\n\n\n16.24 \u21d2 16.204 \nCAP 1\n11371 14:29:49.496308\n\nINDEX COMPLETE\n\nHTTP/1.1 200 OK\nContent-Type: text/plain;charset=UTF-8\nTransfer-Encoding: chunked\n\n2C\n{\"responseHeader\":{\"status\":0,\"QTime\":195}}\n\n0\n\n\n16.24 \u21d2 16.207 \nCAP 2\n9218 14:29:57.065156\n9232 14:29\u201d57.099274\n\nSearch (two different search results to two servers?) that show the timestamp is set.\n\nPOST /solr/d-_v22/select?indent=on&wt=json HTTP/1.1\nhost: d01-solr.srv.hivepoint.com\nAccept-Encoding: gzip,deflate\nContent-Type: application/x-www-form-urlencoded; charset=UTF-8\nrequest_id: null 957d1ca5-7200-4058-9c70-16a17fc64c19 2069\nUser-Agent: HivePoint (Factory JSON client:null:2068)\nX-Forwarded-For: 10.220.16.229\nX-Forwarded-Port: 80\nX-Forwarded-Proto: http\nContent-Length: 244\nConnection: keep-alive\n\nq=%2B%28*%29&fq=%2Bhive%3Avdates+AND+%2Bchannel%3A%28adam+bethany+dev+notifications+preet+share%29+AND+at%3A%5B2014-07-10T21%3A27%3A56Z+TO+*%5D&start=0&rows=300&sort=at+desc%2C+id+desc&fl=id,hive,timestamp,type,message_id,file_instance_id,scoreHTTP/1.1 200 OK\nContent-Type: text/plain;charset=UTF-8\nTransfer-Encoding: chunked\n\n2BB\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":3,\n    \"params\":{\n      \"fl\":\"id,hive,timestamp,type,message_id,file_instance_id,score\",\n      \"sort\":\"at desc, id desc\",\n      \"indent\":\"on\",\n      \"start\":\"0\",\n      \"q\":\"+(*)\",\n      \"wt\":\"json\",\n      \"fq\":\"+hive:vdates AND +channel:(adam bethany dev notifications preet share) AND at:[2014-07-10T21:27:56Z TO *]\",\n      \"rows\":\"300\"}},\n  \"response\":{\"numFound\":1,\"start\":0,\"maxScore\":1.0,\"docs\":[\n      {\n        \"hive\":\"vdates\",\n        \"timestamp\":1405027721000,\n        \"type\":\"MESSAGE\",\n        \"id\":\"4b2c4d09-31e2-4fe2-b767-3868efbdcda1\",\n        \"message_id\":\"2014-07-10-77a6614c-66e4-4ddb-8566-dff4bfb743d1\",\n        \"score\":1.0}]\n  }}\n\n0\n\n\n\n\n16.24 \u21d2 16.207 \nCAP 2\n9415 14:30:00.310995\n\nUpdate Channel\n\nPOST /solr/d-_v22/update?commit=true HTTP/1.1\nhost: d01-solr.srv.hivepoint.com\nAccept-Encoding: gzip,deflate\nContent-Type: application/json; charset=UTF-8\nrequest_id: null 92fa6c11-78d8-44cc-a143-9ff3e4c132f4 2115\nUser-Agent: HivePoint (Factory JSON client:null:2114)\nX-Forwarded-For: 10.220.16.229\nX-Forwarded-Port: 80\nX-Forwarded-Proto: http\nContent-Length: 102\nConnection: keep-alive\n\n[{\"id\":\"4b2c4d09-31e2-4fe2-b767-3868efbdcda1\",\"channel\": {\"add\": \"preet\"},\"channel\": {\"add\": \"adam\"}}]HTTP/1.1 400 Bad Request\nContent-Type: text/plain;charset=UTF-8\nTransfer-Encoding: chunked\n\n96\n{\"responseHeader\":{\"status\":400,\"QTime\":1},\"error\":{\"msg\":\"[doc=4b2c4d09-31e2-4fe2-b767-3868efbdcda1] missing required field: timestamp\",\"code\":400}}\n\n0\n\n\nCAP 2\n9602 14:30:08.082758\n\nSubsequent search, after update\n\nPOST /solr/d-_v22/select?indent=on&wt=json HTTP/1.1\nhost: d01-solr.srv.hivepoint.com\nAccept-Encoding: gzip,deflate\nContent-Type: application/x-www-form-urlencoded; charset=UTF-8\nrequest_id: null 196bee69-e79c-455e-b0cb-6ad6ecdab4e0 1813\nUser-Agent: HivePoint (Factory JSON client:null:1811)\nX-Forwarded-For: 10.220.16.230\nX-Forwarded-Port: 80\nX-Forwarded-Proto: http\nContent-Length: 261\nConnection: keep-alive\n\nq=%2B%28*+-%28%28foo%29%29%29&fq=%2Bhive%3Avdates+AND+%2Bchannel%3A%28adam+bethany+dev+notifications+preet+share%29+AND+at%3A%5B2014-07-10T21%3A28%3A07Z+TO+*%5D&start=0&rows=300&sort=at+desc%2C+id+desc&fl=id,hive,timestamp,type,message_id,file_instance_id,scoreHTTP/1.1 200 OK\nContent-Type: text/plain;charset=UTF-8\nTransfer-Encoding: chunked\n\n2C4\n{\n  \"responseHeader\":{\n    \"status\":0,\n    \"QTime\":3,\n    \"params\":{\n      \"fl\":\"id,hive,timestamp,type,message_id,file_instance_id,score\",\n      \"sort\":\"at desc, id desc\",\n      \"indent\":\"on\",\n      \"start\":\"0\",\n      \"q\":\"+(* -((foo)))\",\n      \"wt\":\"json\",\n      \"fq\":\"+hive:vdates AND +channel:(adam bethany dev notifications preet share) AND at:[2014-07-10T21:28:07Z TO *]\",\n      \"rows\":\"300\"}},\n  \"response\":{\"numFound\":1,\"start\":0,\"maxScore\":1.0,\"docs\":[\n      {\n        \"hive\":\"vdates\",\n        \"timestamp\":1405027721000,\n        \"type\":\"MESSAGE\",\n        \"id\":\"4b2c4d09-31e2-4fe2-b767-3868efbdcda1\",\n        \"message_id\":\"2014-07-10-77a6614c-66e4-4ddb-8566-dff4bfb743d1\",\n        \"score\":1.0}]\n  }}\n\n0\n\n "
        },
        {
            "author": "Nathan Neulinger",
            "id": "comment-14062796",
            "date": "2014-07-15T22:49:56+0000",
            "content": "\nthis is the occurrence of the error on the server the update ran on\n\n2014-07-10 21:30:00,313 ERROR qtp1599863753-30801 [org.apache.solr.core.SolrCore           ]  - org.apache.solr.common.SolrException: [doc=4b2c4d09-31e2-4fe2-b767-3868efbdcda1] missing required field: timestamp\n        at org.apache.solr.update.DocumentBuilder.toDocument(DocumentBuilder.java:189)\n        at org.apache.solr.update.AddUpdateCommand.getLuceneDocument(AddUpdateCommand.java:77)\n        at org.apache.solr.update.DirectUpdateHandler2.addDoc0(DirectUpdateHandler2.java:234)\n        at org.apache.solr.update.DirectUpdateHandler2.addDoc(DirectUpdateHandler2.java:160)\n        at org.apache.solr.update.processor.RunUpdateProcessor.processAdd(RunUpdateProcessorFactory.java:69)\n        at org.apache.solr.update.processor.UpdateRequestProcessor.processAdd(UpdateRequestProcessor.java:51)\n        at org.apache.solr.update.processor.DistributedUpdateProcessor.doLocalAdd(DistributedUpdateProcessor.java:704)\n        at org.apache.solr.update.processor.DistributedUpdateProcessor.versionAdd(DistributedUpdateProcessor.java:858)\n        at org.apache.solr.update.processor.DistributedUpdateProcessor.processAdd(DistributedUpdateProcessor.java:557)\n        at org.apache.solr.update.processor.LogUpdateProcessor.processAdd(LogUpdateProcessorFactory.java:100)\n        at org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.handleAdds(JsonLoader.java:393)\n        at org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.processUpdate(JsonLoader.java:118)\n        at org.apache.solr.handler.loader.JsonLoader$SingleThreadedJsonLoader.load(JsonLoader.java:102)\n        at org.apache.solr.handler.loader.JsonLoader.load(JsonLoader.java:66)\n        at org.apache.solr.handler.UpdateRequestHandler$1.load(UpdateRequestHandler.java:92)\n        at org.apache.solr.handler.ContentStreamHandlerBase.handleRequestBody(ContentStreamHandlerBase.java:74)\n        at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)\n        at org.apache.solr.core.SolrCore.execute(SolrCore.java:1952)\n        at org.apache.solr.servlet.SolrDispatchFilter.execute(SolrDispatchFilter.java:774)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:418)\n        at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:207)\n        at org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1419)\n        at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:455)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:137)\n        at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:557)\n        at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:231)\n        at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1075)\n        at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:384)\n        at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:193)\n        at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1009)\n        at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:135)\n        at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:255)\n        at org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:154)\n        at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:116)\n        at org.eclipse.jetty.server.Server.handle(Server.java:368)\n        at org.eclipse.jetty.server.AbstractHttpConnection.handleRequest(AbstractHttpConnection.java:489)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handleRequest(BlockingHttpConnection.java:53)\n        at org.eclipse.jetty.server.AbstractHttpConnection.content(AbstractHttpConnection.java:953)\n        at org.eclipse.jetty.server.AbstractHttpConnection$RequestHandler.content(AbstractHttpConnection.java:1014)\n        at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:861)\n        at org.eclipse.jetty.http.HttpParser.parseAvailable(HttpParser.java:240)\n        at org.eclipse.jetty.server.BlockingHttpConnection.handle(BlockingHttpConnection.java:72)\n        at org.eclipse.jetty.server.bio.SocketConnector$ConnectorEndPoint.run(SocketConnector.java:264)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:608)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:543)\n        at java.lang.Thread.run(Thread.java:745)\n "
        },
        {
            "author": "Nathan Neulinger",
            "id": "comment-14062800",
            "date": "2014-07-15T22:51:31+0000",
            "content": "and here's an update in that same debug log from shortly before the error (the distribute from the insert of the document on solr1):\n\n\n2014-07-10 21:29:49,313 INFO  qtp1599863753-30844 [solr.update.processor.LogUpdateProcessor]  - [d-_v22_shard1_replica2] webapp=/solr path=/update params={distrib.from=http://10.220.16.204:8983/solr/d-_v22_shard1_replica1/&update.distrib=TOLEADER&wt=javabin&version=2} {add=[4b2c4d09-31e2-4fe2-b767-3868efbdcda1 (1473278419196182528)]} 0 11\n2014-07-10 21:29:49,416 INFO  qtp1599863753-30844 [org.apache.solr.update.UpdateHandler    ]  - start commit{,optimize=false,openSearcher=true,waitSearcher=true,expungeDeletes=false,softCommit=false,prepareCommit=false}\n\n "
        },
        {
            "author": "Hoss Man",
            "id": "comment-14062802",
            "date": "2014-07-15T22:56:32+0000",
            "content": "Please ask questions about things like this on the solr-user@lucene list prior to filing a bug.\n\nYou have not provided details about your schema, but based on the details you have provided, it appears that your timestamp field is not \"stored\", therefore you are probably hitting a documented limitation of using partial updates...\n\nhttps://cwiki.apache.org/confluence/display/solr/Updating+Parts+of+Documents\n\nAll original source fields must be stored for field modifiers to work correctly, which is the Solr default.\n "
        },
        {
            "author": "Nathan Neulinger",
            "id": "comment-14062806",
            "date": "2014-07-15T22:57:36+0000",
            "content": "We are open to diagnostic suggestions on this, but are at a loss since this appears to be very intermittent and non-reproducible other than by waiting.\n\nLooking at solrconfig.xml compared to what is currently in 4.8.0 example - there are a variety of differences, mostly look like due to this config originally being based on 4.4 solrconfig.xml example.  "
        },
        {
            "author": "Hoss Man",
            "id": "comment-14062807",
            "date": "2014-07-15T22:57:56+0000",
            "content": "resolving as not a problem - refered user to solr-user@lucene mailing list.\n\ncan reopen if more details indicate an actual bug. "
        },
        {
            "author": "Nathan Neulinger",
            "id": "comment-14062906",
            "date": "2014-07-16T00:07:19+0000",
            "content": "schema attached "
        },
        {
            "author": "Nathan Neulinger",
            "id": "comment-14062907",
            "date": "2014-07-16T00:08:09+0000",
            "content": "Leaving closed, but adding more information in case Hoss Man will comment additionally.\n\n'timestamp' is: stored=true indexed=false\n\nThat seems to meet all of the requirements stated for partial updates unless 'indexed=true' is also required and not documented.  "
        },
        {
            "author": "Nathan Neulinger",
            "id": "comment-14062909",
            "date": "2014-07-16T00:09:10+0000",
            "content": "Additionally - since this works 99.9% of the time - I would surely think that a blatant problem as that would have been more visible. The incremental updates work normally without issue, and just randomly fail.  "
        },
        {
            "author": "Nathan Neulinger",
            "id": "comment-14064477",
            "date": "2014-07-17T01:53:04+0000",
            "content": "FYI. We finally tracked down the problem.... at least 99.9% sure at this point, and it was staring me in the face the whole time - just never noticed:\n\n\n[{\"id\":\"4b2c4d09-31e2-4fe2-b767-3868efbdcda1\",\"channel\": {\"add\": \"preet\"},\"channel\": {\"add\": \"adam\"}}]\n\n\n\nLook at the JSON... It's trying to add two channels... Should have been:\n\n\n[{\"id\":\"4b2c4d09-31e2-4fe2-b767-3868efbdcda1\",\"channel\": {\"add\": \"preet\"}},\n {\"id\":\"4b2c4d09-31e2-4fe2-b767-3868efbdcda1\",\"channel\": {\"add\": \"adam\"}}]\n\n\n\nI half wonder how it chose to interpret that particular chunk of json, but either way, I think the origin of our issue is resolved. "
        }
    ]
}