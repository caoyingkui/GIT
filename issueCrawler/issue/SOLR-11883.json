{
    "id": "SOLR-11883",
    "title": "NPE on missing nested query in QueryValueSource",
    "details": {
        "labels": "",
        "priority": "Major",
        "components": [],
        "type": "Bug",
        "fix_versions": [],
        "affect_versions": "None",
        "resolution": "Unresolved",
        "status": "Open"
    },
    "description": "When the nested query or query de-referencing is used but the query isn't specified Solr throws NPE.\n\nFor following request, \n\nhttp://localhost:8983/solr/blockjoin70001-1492010056/select?q=*&boost=query($qq)&defType=edismax\n\n\n\nSolr returned 500 with stack trace\n\n\njava.lang.NullPointerException\n\tat org.apache.lucene.queries.function.valuesource.QueryValueSource.hashCode(QueryValueSource.java:63)\n\tat java.util.Arrays.hashCode(Arrays.java:4146)\n\tat java.util.Objects.hash(Objects.java:128)\n\tat org.apache.lucene.queries.function.ValueSource$WrappedDoubleValuesSource.hashCode(ValueSource.java:275)\n\tat java.util.Arrays.hashCode(Arrays.java:4146)\n\tat java.util.Objects.hash(Objects.java:128)\n\tat org.apache.lucene.queries.function.FunctionScoreQuery$MultiplicativeBoostValuesSource.hashCode(FunctionScoreQuery.java:269)\n\tat java.util.Arrays.hashCode(Arrays.java:4146)\n\tat java.util.Objects.hash(Objects.java:128)\n\tat org.apache.lucene.queries.function.FunctionScoreQuery.hashCode(FunctionScoreQuery.java:130)\n\tat org.apache.solr.search.QueryResultKey.<init>(QueryResultKey.java:46)\n\tat org.apache.solr.search.SolrIndexSearcher.getDocListC(SolrIndexSearcher.java:1326)\n\tat org.apache.solr.search.SolrIndexSearcher.search(SolrIndexSearcher.java:583)\n\tat org.apache.solr.handler.component.QueryComponent.doProcessUngroupedSearch(QueryComponent.java:1435)\n\tat org.apache.solr.handler.component.QueryComponent.process(QueryComponent.java:375)\n\tat org.apache.solr.handler.component.SearchHandler.handleRequestBody(SearchHandler.java:295)\n\tat org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:177)\n\tat org.apache.solr.core.SolrCore.execute(SolrCore.java:2503)\n\tat org.apache.solr.servlet.HttpSolrCall.execute(HttpSolrCall.java:711)\n\tat org.apache.solr.servlet.HttpSolrCall.call(HttpSolrCall.java:517)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:380)\n\tat org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:326)\n\tat org.eclipse.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1629)\n\tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:533)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\n\tat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:548)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:190)\n\tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1595)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:188)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1253)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:168)\n\tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:473)\n\tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1564)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:166)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1155)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n\tat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:219)\n\tat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:126)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\n\tat org.eclipse.jetty.rewrite.handler.RewriteHandler.handle(RewriteHandler.java:335)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:132)\n\tat org.eclipse.jetty.server.Server.handle(Server.java:530)\n\tat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:347)\n\tat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:256)\n\tat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:279)\n\tat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:102)\n\tat org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:124)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:247)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.produce(EatWhatYouKill.java:140)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:131)\n\tat org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:382)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:708)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:626)\n\tat java.lang.Thread.run(Thread.java:745)\n\n\n\nSince this is occurring because of missing parameter, Solr should return Bad Request",
    "attachments": {
        "SOLR-11883.patch": "https://issues.apache.org/jira/secure/attachment/12907154/SOLR-11883.patch"
    },
    "issue_links": {},
    "comments": [
        {
            "date": "2018-01-22T17:32:23+0000",
            "content": "For the same request,\nresponse with 400 status code\n\n{\n    \"responseHeader\": {\n        \"status\": 400,\n        \"QTime\": 1,\n        \"params\": {\n            \"q\": \"*\",\n            \"defType\": \"edismax\",\n            \"boost\": \"query($qq)\"\n        }\n    },\n    \"error\": {\n        \"metadata\": [\n            \"error-class\",\n            \"org.apache.solr.common.SolrException\",\n            \"root-error-class\",\n            \"org.apache.solr.search.SyntaxError\"\n        ],\n        \"msg\": \"org.apache.solr.search.SyntaxError: Missing param qq while parsing function 'query($qq)'\",\n        \"code\": 400\n    }\n}\n\n ",
            "author": "Munendra S N",
            "id": "comment-16334592"
        },
        {
            "date": "2018-01-22T17:36:06+0000",
            "content": "Handle both cases like\n\n\nquery($qq) and query({!edismax v=$qq})\n\n ",
            "author": "Munendra S N",
            "id": "comment-16334598"
        }
    ]
}