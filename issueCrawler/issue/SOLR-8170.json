{
    "id": "SOLR-8170",
    "title": "TestFiltering.testRandomFiltering() failures",
    "details": {
        "components": [],
        "type": "Bug",
        "labels": "",
        "fix_versions": [
            "6.0"
        ],
        "affect_versions": "None",
        "status": "Resolved",
        "resolution": "Fixed",
        "priority": "Major"
    },
    "description": "My Jenkins found a couple 100% reproducible failures recently on trunk:\n\n\n   [junit4]   2> 6537 ERROR (TEST-TestFiltering.testRandomFiltering-seed#[7BCB61B11BC4B74E]) [    ] o.a.s.SolrTestCaseJ4 query failed JSON validation. error=mismatch: '1'!='2' @ facet_counts/facet_queries/facetQuery\n   [junit4]   2>  expected =/facet_counts/facet_queries/facetQuery/==1\n   [junit4]   2>  response = {\n   [junit4]   2>   \"responseHeader\":{\n   [junit4]   2>     \"status\":0,\n   [junit4]   2>     \"QTime\":0},\n   [junit4]   2>   \"response\":{\"numFound\":1,\"start\":0,\"docs\":[\n   [junit4]   2>       {\n   [junit4]   2>         \"id\":\"8\",\n   [junit4]   2>         \"val_i\":8,\n   [junit4]   2>         \"val_s\":\"00008\"}]\n   [junit4]   2>   },\n   [junit4]   2>   \"facet_counts\":{\n   [junit4]   2>     \"facet_queries\":{\n   [junit4]   2>       \"*:*\":1,\n   [junit4]   2>       \"multiSelect\":1,\n   [junit4]   2>       \"facetQuery\":2},\n   [junit4]   2>     \"facet_fields\":{},\n   [junit4]   2>     \"facet_dates\":{},\n   [junit4]   2>     \"facet_ranges\":{},\n   [junit4]   2>     \"facet_intervals\":{},\n   [junit4]   2>     \"facet_heatmaps\":{}}}\n   [junit4]   2> \n   [junit4]   2>  request = facet.query=*:*&facet.query={!key%3DmultiSelect+ex%3Dt}*:*&facet.query={!key%3DfacetQuery+cache%3Dfalse+cost%3D144}+-val_i:0+-val_i:1+-val_i:2+-val_i:7&q=val_s:[00008+TO+00009}&facet=true&wt=xml\n   [junit4]   2> 6538 ERROR (TEST-TestFiltering.testRandomFiltering-seed#[7BCB61B11BC4B74E]) [    ] o.a.s.SolrTestCaseJ4 java.lang.RuntimeException: mismatch: '1'!='2' @ facet_counts/facet_queries/facetQuery\n   [junit4]   2>        at org.apache.solr.SolrTestCaseJ4.assertJQ(SolrTestCaseJ4.java:854)\n   [junit4]   2>        at org.apache.solr.SolrTestCaseJ4.assertJQ(SolrTestCaseJ4.java:801)\n   [junit4]   2>        at org.apache.solr.search.TestFiltering.testRandomFiltering(TestFiltering.java:408)\n[...] \n   [junit4]   2> 6538 ERROR (TEST-TestFiltering.testRandomFiltering-seed#[7BCB61B11BC4B74E]) [    ] o.a.s.SolrTestCaseJ4 FAILURE: indexSize=9 iiter=1 qiter=54 request=[q, val_s:[00008 TO 00009}, facet, true, facet.query, *:*, facet.query, {!key=multiSelect ex=t}*:*, facet.query, {!key=facetQuery cache=false cost=144} -val_i:0 -val_i:1 -val_i:2 -val_i:7]\n[...]\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestFiltering -Dtests.method=testRandomFiltering -Dtests.seed=7BCB61B11BC4B74E -Dtests.slow=true -Dtests.linedocsfile=/home/jenkins/lucene-data/enwiki.random.lines.txt -Dtests.locale=zh -Dtests.timezone=Pacific/Kiritimati -Dtests.asserts=true -Dtests.file.encoding=ISO-8859-1\n   [junit4] FAILURE 1.36s J8  | TestFiltering.testRandomFiltering <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError: FAILURE: indexSize=9 iiter=1 qiter=54 request=[q, val_s:[00008 TO 00009}, facet, true, facet.query, *:*, facet.query, {!key=multiSelect ex=t}*:*, facet.query, {!key=facetQuery cache=false cost=144} -val_i:0 -val_i:1 -val_i:2 -val_i:7]\n   [junit4]    > \tat __randomizedtesting.SeedInfo.seed([7BCB61B11BC4B74E:64A8C274FEE3F747]:0)\n   [junit4]    > \tat org.apache.solr.search.TestFiltering.testRandomFiltering(TestFiltering.java:419)\n   [junit4]    > \tat java.lang.Thread.run(Thread.java:745)\n[...]\n   [junit4]   2> NOTE: leaving temporary files on disk at: /home/sarowe/svn/lucene/dev/trunk/solr/build/solr-core/test/J0/temp/solr.search.TestFiltering_7BCB61B11BC4B74E-002\n   [junit4]   2> NOTE: test params are: codec=Asserting(Lucene53): {val_i=FST50, val_s=Lucene50(blocksize=128), id=FST50}, docValues:{}, sim=ClassicSimilarity, locale=zh, timezone=Pacific/Kiritimati\n   [junit4]   2> NOTE: Linux 4.1.0-custom2-amd64 amd64/Oracle Corporation 1.8.0_45 (64-bit)/cpus=16,threads=1,free=240471544,total=348127232\n   [junit4]   2> NOTE: All tests run in this JVM: [TestFiltering]\n\n\n\n\n   [junit4]   2> 3327 ERROR (TEST-TestFiltering.testRandomFiltering-seed#[5176E993981660E9]) [    ] o.a.s.SolrTestCaseJ4 query failed JSON validation. error=mismatch: '0'!='1' @ facet_counts/facet_queries/facetQuery\n   [junit4]   2>  expected =/facet_counts/facet_queries/facetQuery/==0\n   [junit4]   2>  response = {\n   [junit4]   2>   \"responseHeader\":{\n   [junit4]   2>     \"status\":0,\n   [junit4]   2>     \"QTime\":0},\n   [junit4]   2>   \"response\":{\"numFound\":1,\"start\":0,\"docs\":[\n   [junit4]   2>       {\n   [junit4]   2>         \"id\":\"0\",\n   [junit4]   2>         \"val_i\":0,\n   [junit4]   2>         \"val_s\":\"00000\"}]\n   [junit4]   2>   },\n   [junit4]   2>   \"facet_counts\":{\n   [junit4]   2>     \"facet_queries\":{\n   [junit4]   2>       \"*:*\":1,\n   [junit4]   2>       \"multiSelect\":1,\n   [junit4]   2>       \"facetQuery\":1},\n   [junit4]   2>     \"facet_fields\":{},\n   [junit4]   2>     \"facet_dates\":{},\n   [junit4]   2>     \"facet_ranges\":{},\n   [junit4]   2>     \"facet_intervals\":{},\n   [junit4]   2>     \"facet_heatmaps\":{}}}\n   [junit4]   2> \n   [junit4]   2>  request = facet.query=*:*&facet.query={!key%3DmultiSelect+ex%3Dt}*:*&facet.query={!key%3DfacetQuery}-_query_:\"{!frange+v%3Dval_i+l%3D0+u%3D1}\"&q={!+tag%3Dt}val_s:[00000+TO+00001}&facet=true&wt=xml\n   [junit4]   2> 3328 ERROR (TEST-TestFiltering.testRandomFiltering-seed#[5176E993981660E9]) [    ] o.a.s.SolrTestCaseJ4 java.lang.RuntimeException: mismatch: '0'!='1' @ facet_counts/facet_queries/facetQuery\n   [junit4]   2>        at org.apache.solr.SolrTestCaseJ4.assertJQ(SolrTestCaseJ4.java:854)\n   [junit4]   2>        at org.apache.solr.SolrTestCaseJ4.assertJQ(SolrTestCaseJ4.java:801)\n   [junit4]   2>        at org.apache.solr.search.TestFiltering.testRandomFiltering(TestFiltering.java:408)\n[...]\n   [junit4]   2> 3328 ERROR (TEST-TestFiltering.testRandomFiltering-seed#[5176E993981660E9]) [    ] o.a.s.SolrTestCaseJ4 FAILURE: indexSize=1 iiter=4 qiter=164 request=[q, {! tag=t}val_s:[00000 TO 00001}, facet, true, facet.query, *:*, facet.query, {!key=multiSelect ex=t}*:*, facet.query, {!key=facetQuery}-_query_:\"{!frange v=val_i l=0 u=1}\"]\n[...]\n   [junit4]   2> NOTE: reproduce with: ant test  -Dtestcase=TestFiltering -Dtests.method=testRandomFiltering -Dtests.seed=5176E993981660E9 -Dtests.slow=true -Dtests.linedocsfile=/home/jenkins/lucene-data/enwiki.random.lines.txt -Dtests.locale=zh -Dtests.timezone=Pacific/Kiritimati -Dtests.asserts=true -Dtests.file.encoding=ISO-8859-1\n   [junit4] FAILURE 1.81s | TestFiltering.testRandomFiltering <<<\n   [junit4]    > Throwable #1: java.lang.AssertionError: FAILURE: indexSize=1 iiter=4 qiter=164 request=[q, {! tag=t}val_s:[00000 TO 00001}, facet, true, facet.query, *:*, facet.query, {!key=multiSelect ex=t}*:*, facet.query, {!key=facetQuery}-_query_:\"{!frange v=val_i l=0 u=1}\"]\n   [junit4]    >        at __randomizedtesting.SeedInfo.seed([5176E993981660E9:4E154A567D3120E0]:0)\n   [junit4]    >        at org.apache.solr.search.TestFiltering.testRandomFiltering(TestFiltering.java:419)\n   [junit4]    >        at java.lang.Thread.run(Thread.java:745)\n[...]\n   [junit4]   2> NOTE: leaving temporary files on disk at: /home/sarowe/svn/lucene/dev/trunk/solr/build/solr-core/test/J0/temp/solr.search.TestFiltering_5176E993981660E9-001\n   [junit4]   2> NOTE: test params are: codec=Asserting(Lucene53), sim=RandomSimilarityProvider(queryNorm=true,coord=crazy): {}, locale=zh, timezone=Pacific/Kiritimati\n   [junit4]   2> NOTE: Linux 4.1.0-custom2-amd64 amd64/Oracle Corporation 1.8.0_45 (64-bit)/cpus=16,threads=1,free=292000448,total=382730240\n   [junit4]   2> NOTE: All tests run in this JVM: [TestFiltering]\n   [junit4] Completed [1/1] in 3.93s, 1 test, 1 failure <<< FAILURES!",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "date": "2015-10-19T20:20:23+0000",
            "author": "Yonik Seeley",
            "content": "Any clues as to when this problem started?  Is it trunk only?\nI'll start looking into it since I messed with term range queries in trunk in SOLR-8037 ",
            "id": "comment-14963983"
        },
        {
            "date": "2015-10-19T20:26:00+0000",
            "author": "Steve Rowe",
            "content": "Any clues as to when this problem started?\n\nThe 5176E993981660E9 seed (one of the two failures in the description) was found by my Jenkins on Sept. 20th.  I can't find any currently reproducing seeds for this test any earlier than that on my, ASF or Policeman Jenkins.\n\nbq\u0010. Is it trunk only?\n\nI tried the two failing seeds with Java8 on branch_5x on my Jenkins box and neither reproduced. ",
            "id": "comment-14963991"
        },
        {
            "date": "2015-10-19T20:49:18+0000",
            "author": "Yonik Seeley",
            "content": "Hmmm, so one thing I notice is that both failures look like they involve pure negative queries... so maybe it wasn't my changes.  I'll keep digging.\n\nedit: scratch that... looks like the base doc set for faceting for the second fail you posted is of size 2, which is incorrect.  This definitely points back to this bug being my fault... ",
            "id": "comment-14964028"
        },
        {
            "date": "2015-10-20T01:12:57+0000",
            "author": "ASF subversion and git services",
            "content": "Commit 1709499 from Yonik Seeley in branch 'dev/trunk'\n[ https://svn.apache.org/r1709499 ]\n\nSOLR-8170: fix DocSetBuilder not removing doc 0 if it was deleted ",
            "id": "comment-14964348"
        },
        {
            "date": "2015-10-20T01:15:05+0000",
            "author": "Yonik Seeley",
            "content": "Found, fixed, committed.\nClassic boundary bug... if document #0 was deleted, it wasn't removed from the produced DocSet. ",
            "id": "comment-14964352"
        }
    ]
}