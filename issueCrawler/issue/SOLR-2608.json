{
    "id": "SOLR-2608",
    "title": "TestReplicationHandler is flakey",
    "details": {
        "affect_versions": "None",
        "status": "Resolved",
        "fix_versions": [],
        "components": [],
        "type": "Bug",
        "priority": "Major",
        "labels": "",
        "resolution": "Fixed"
    },
    "description": "I've been running some while(1) tests on trunk, and TestReplicationHandler is very flakey it fails about every 10th run.\nProbably not a bug, but the test not waiting correctly\n\n\n    [junit] Testsuite: org.apache.solr.handler.TestReplicationHandler\n    [junit] Testcase: org.apache.solr.handler.TestReplicationHandler:   FAILED\n    [junit] ERROR: SolrIndexSearcher opens=48 closes=47\n    [junit] junit.framework.AssertionFailedError: ERROR: SolrIndexSearcher opens=48 closes=47\n    [junit]     at org.apache.solr.SolrTestCaseJ4.endTrackingSearchers(SolrTestCaseJ4.java:131)\n    [junit]     at org.apache.solr.SolrTestCaseJ4.afterClassSolrTestCase(SolrTestCaseJ4.java:74)\n    [junit] \n    [junit] \n    [junit] Tests run: 8, Failures: 1, Errors: 0, Time elapsed: 40.772 sec\n    [junit] \n    [junit] ------------- Standard Error -----------------\n    [junit] 19-Jun-2011 21:26:44 org.apache.solr.handler.SnapPuller fetchLatestIndex\n    [junit] SEVERE: Master at: http://localhost:51817/solr/replication is not available. Index fetch failed. Exception: Connection refused\n    [junit] 19-Jun-2011 21:26:49 org.apache.solr.common.SolrException log\n    [junit] SEVERE: java.util.concurrent.RejectedExecutionException\n    [junit]     at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:1768)\n    [junit]     at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:767)\n    [junit]     at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:658)\n    [junit]     at java.util.concurrent.AbstractExecutorService.submit(AbstractExecutorService.java:92)\n    [junit]     at java.util.concurrent.Executors$DelegatedExecutorService.submit(Executors.java:603)\n    [junit]     at org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:1149)\n    [junit]     at org.apache.solr.update.DirectUpdateHandler2.commit(DirectUpdateHandler2.java:346)\n    [junit]     at org.apache.solr.handler.SnapPuller.doCommit(SnapPuller.java:483)\n    [junit]     at org.apache.solr.handler.SnapPuller.fetchLatestIndex(SnapPuller.java:332)\n    [junit]     at org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:267)\n    [junit]     at org.apache.solr.handler.SnapPuller$1.run(SnapPuller.java:166)\n    [junit]     at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)\n    [junit]     at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)\n    [junit]     at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)\n    [junit]     at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)\n    [junit]     at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:180)\n    [junit]     at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:204)\n    [junit]     at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n    [junit]     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n    [junit]     at java.lang.Thread.run(Thread.java:662)\n    [junit] \n    [junit] 19-Jun-2011 21:26:51 org.apache.solr.update.SolrIndexWriter finalize\n    [junit] SEVERE: SolrIndexWriter was not closed prior to finalize(), indicates a bug -- POSSIBLE RESOURCE LEAK!!!\n    [junit] 19-Jun-2011 21:26:51 org.apache.solr.common.util.ConcurrentLRUCache finalize\n    [junit] SEVERE: ConcurrentLRUCache was not destroyed prior to finalize(), indicates a bug -- POSSIBLE RESOURCE LEAK!!!\n    [junit] 19-Jun-2011 21:27:13 org.apache.solr.handler.SnapPuller fetchLatestIndex\n    [junit] SEVERE: Master at: http://localhost:46559/solr/replication is not available. Index fetch failed. Exception: Connection refused\n    [junit] 19-Jun-2011 21:27:14 org.apache.solr.handler.SnapPuller fetchLatestIndex\n    [junit] SEVERE: Master at: http://localhost:46559/solr/replication is not available. Index fetch failed. Exception: Connection refused\n    [junit] 19-Jun-2011 21:27:14 org.apache.solr.SolrTestCaseJ4 endTrackingSearchers\n    [junit] SEVERE: ERROR: SolrIndexSearcher opens=48 closes=47\n    [junit] ------------- ---------------- ---------------\n    [junit] TEST org.apache.solr.handler.TestReplicationHandler FAILED",
    "attachments": {},
    "issue_links": {},
    "comments": [
        {
            "author": "Sami Siren",
            "id": "comment-13219909",
            "date": "2012-03-01T08:32:58+0000",
            "content": "I am also seeing this test fail quite often. The stacktrace is now different:\n\n\n23987 T1101 oasc.SolrException.log SEVERE SnapPull failed :org.apache.solr.common.SolrException\n\t\tat org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:1388)\n\t\tat org.apache.solr.handler.SnapPuller.doCommit(SnapPuller.java:505)\n\t\tat org.apache.solr.handler.SnapPuller.fetchLatestIndex(SnapPuller.java:348)\n\t\tat org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:298)\n\t\tat org.apache.solr.handler.SnapPuller$1.run(SnapPuller.java:163)\n\t\tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)\n\t\tat java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)\n\t\tat java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)\n\t\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)\n\t\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:180)\n\t\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:204)\n\t\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\t\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\t\tat java.lang.Thread.run(Thread.java:662)\n\tCaused by: java.util.concurrent.RejectedExecutionException\n\t\tat java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:1768)\n\t\tat java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:767)\n\t\tat java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:658)\n\t\tat java.util.concurrent.AbstractExecutorService.submit(AbstractExecutorService.java:92)\n\t\tat java.util.concurrent.Executors$DelegatedExecutorService.submit(Executors.java:603)\n\t\tat org.apache.solr.core.SolrCore.getSearcher(SolrCore.java:1356)\n\t\t... 13 more\n\t\n25051 T3 oasu.ConcurrentLRUCache.finalize SEVERE ConcurrentLRUCache was not destroyed prior to finalize(), indicates a bug -- POSSIBLE RESOURCE LEAK!!!\n40748 T1120 oasc.SolrException.log SEVERE SnapPull failed :org.apache.solr.common.SolrException: Unable to download _7_1.del completely. Downloaded 0!=92\n\t\tat org.apache.solr.handler.SnapPuller$FileFetcher.cleanup(SnapPuller.java:1081)\n\t\tat org.apache.solr.handler.SnapPuller$FileFetcher.fetchFile(SnapPuller.java:961)\n\t\tat org.apache.solr.handler.SnapPuller.downloadIndexFiles(SnapPuller.java:587)\n\t\tat org.apache.solr.handler.SnapPuller.fetchLatestIndex(SnapPuller.java:322)\n\t\tat org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:298)\n\t\tat org.apache.solr.handler.ReplicationHandler$1.run(ReplicationHandler.java:179)\n\n "
        },
        {
            "author": "Hoss Man",
            "id": "comment-13454243",
            "date": "2012-09-12T18:54:31+0000",
            "content": "I can't comment on the specific exceptions mentioned above, but havin recently looked at TestReplicationHandler because of SOLR-3809 i noticed a few things i thought i'd comment on here...\n\nat some point it was annotated as @Slow - i believe the crux of the problem with why it can be very slow for some people is that the majority of the functionality being tested seems to rely on the slave polling the master for replication, and the \"rQuery\" method used through out the test will retry queries over and over (up to 30 seconds) until they pass.\n\nWhile we should definitley have some test that the polling works, a lot of the functionality not-polling specific could probably be tested more reliably using \"on demand\" snappulling commands to the slave. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13530095",
            "date": "2012-12-12T16:50:11+0000",
            "content": "There are many issues this test has been exposing - it should be getting fairly hardened on 5x these days though. "
        },
        {
            "author": "Mark Miller",
            "id": "comment-13531860",
            "date": "2012-12-14T00:41:51+0000",
            "content": "Someone can reopen if they still have problems with this test today. "
        }
    ]
}